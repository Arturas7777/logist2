{% extends "admin/change_form.html" %}
{% load static i18n admin_urls %}

{% block extrastyle %}
    {{ block.super }}
    <script src="{% static 'js/htmx.min.js' %}"></script>
    <style>
        .invoice-builder { max-width: 1200px; margin: 0 auto; }
        
        .step-container { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        
        .step-header { 
            font-size: 18px; 
            font-weight: bold; 
            color: #495057; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .step-number { 
            background: #007bff; 
            color: white; 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
        }
        
        .step-content { display: flex; gap: 20px; align-items: flex-start; }
        
        .entity-selector { flex: 1; }
        
        .entity-type-select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            margin-bottom: 10px; 
        }
        
        .entity-search { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        
        .entity-results { 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #ced4da; 
            border-top: none; 
            border-radius: 0 0 4px 4px; 
            background: white; 
            display: none; 
        }
        
        .entity-result { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid #f1f3f4; 
            transition: background-color 0.2s; 
        }
        
        .entity-result:hover { background-color: #f8f9fa; }
        
        .entity-result.selected { background-color: #e3f2fd; }
        
        .entity-name { font-weight: bold; color: #212529; }
        .entity-type { color: #6c757d; font-size: 12px; }
        
        .selected-entity { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            border-radius: 4px; 
            padding: 10px; 
            margin-top: 10px; 
            display: none; 
        }
        
        .selected-entity.show { display: block; }
        
        .cars-section { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        
        .cars-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .car-card { 
            background: white; 
            border: 1px solid #dee2e6; 
            border-radius: 6px; 
            padding: 15px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .car-card:hover { 
            border-color: #007bff; 
            box-shadow: 0 2px 8px rgba(0,123,255,0.15); 
        }
        
        .car-card.selected { 
            border-color: #28a745; 
            background-color: #f8fff9; 
        }
        
        .car-vin { 
            font-family: monospace; 
            font-weight: bold; 
            color: #495057; 
            margin-bottom: 5px; 
        }
        
        .car-details { 
            color: #6c757d; 
            font-size: 13px; 
            margin-bottom: 8px; 
        }
        
        .car-costs { 
            color: #28a745; 
            font-weight: bold; 
            font-size: 14px; 
        }
        
        .invoice-summary { 
            background: #e7f3ff; 
            border: 1px solid #b3d9ff; 
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 20px; 
        }
        
        .summary-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            padding: 8px 0; 
            border-bottom: 1px solid #d1ecf1; 
        }
        
        .summary-label { font-weight: bold; color: #495057; }
        .summary-value { color: #28a745; font-weight: bold; }
        
        .form-actions { 
            margin-top: 30px; 
            text-align: center; 
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            cursor: pointer; 
            margin: 0 10px; 
            transition: all 0.2s; 
        }
        
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        
        .btn-primary:hover { background: #0056b3; }
        
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-success:hover { background: #1e7e34; }
        
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        
        .btn-secondary:hover { background: #545b62; }
        
        .hidden { display: none !important; }
        
        .error-message { 
            color: #dc3545; 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            border-radius: 4px; 
            padding: 10px; 
            margin: 10px 0; 
        }
        
        .success-message { 
            color: #155724; 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            border-radius: 4px; 
            padding: 10px; 
            margin: 10px 0; 
        }
    </style>
{% endblock %}

{% block content %}
    {% if original %}
        <!-- Редактирование существующего инвойса - показываем кастомный шаблон -->
        {% include 'admin/invoice_edit.html' %}
    {% else %}
        <!-- Создание нового инвойса - показываем кастомный интерфейс -->
        <div class="invoice-builder">
            <h1 style="text-align: center; margin-bottom: 30px; color: #495057;">
                Создание нового инвойса
            </h1>
        
        <form id="invoice_form" method="post" action="">
            {% csrf_token %}
            
            <!-- Скрытые поля Django -->
            {{ adminform.form.non_field_errors }}
            {{ adminform.form.number }}
            {{ adminform.form.from_entity_type }}
            {{ adminform.form.from_entity_id }}
            {{ adminform.form.to_entity_type }}
            {{ adminform.form.to_entity_id }}
            {{ adminform.form.service_type }}
            {{ adminform.form.cars }}
            {{ adminform.form.paid }}
            {{ adminform.form.is_outgoing }}
            {{ adminform.form.issue_date }}
            {{ adminform.form.total_amount }}
            
            <!-- Скрываем стандартные поля Django через JavaScript -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Скрываем все стандартные поля Django
                    setTimeout(function() {
                        const fieldsToHide = [
                            'id_number', 'id_from_entity_type', 'id_from_entity_id', 
                            'id_to_entity_type', 'id_to_entity_id', 'id_cars', 
                            'id_paid', 'id_is_outgoing', 'id_issue_date', 'id_total_amount',
                            'id_client', 'id_warehouse'
                        ];
                        
                        fieldsToHide.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) {
                                const formRow = field.closest('.form-row');
                                if (formRow) {
                                    formRow.style.display = 'none';
                                }
                                field.style.display = 'none';
                            }
                        });
                        
                        // Скрываем все .form-row элементы
                        const formRows = document.querySelectorAll('.form-row');
                        formRows.forEach(row => {
                            row.style.display = 'none';
                        });
                        
                        // Скрываем все fieldset элементы
                        const fieldsets = document.querySelectorAll('fieldset');
                        fieldsets.forEach(fieldset => {
                            fieldset.style.display = 'none';
                        });
                        
                        // Скрываем виджет добавления автомобилей (плюсик)
                        const addCarWidget = document.querySelector('.add-another');
                        if (addCarWidget) {
                            addCarWidget.style.display = 'none';
                        }
                        
                        // Скрываем все элементы с классом add-another
                        const addAnotherElements = document.querySelectorAll('.add-another');
                        addAnotherElements.forEach(el => {
                            el.style.display = 'none';
                        });
                        
                        // Скрываем все элементы с классом related-widget-wrapper
                        const relatedWidgets = document.querySelectorAll('.related-widget-wrapper');
                        relatedWidgets.forEach(widget => {
                            widget.style.display = 'none';
                        });
                        
                        // Убираем атрибут required с полей, которые мы скрываем
                        const requiredFields = ['id_number', 'id_from_entity_type', 'id_from_entity_id', 'id_to_entity_type', 'id_to_entity_id', 'id_cars', 'id_total_amount'];
                        requiredFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) {
                                field.removeAttribute('required');
                                field.removeAttribute('aria-required');
                            }
                        });
                        
                        console.log('Стандартные поля Django скрыты');
                    }, 100);
                });
            </script>
            
            <!-- Шаг 1: Выбор отправителя -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <span>Выберите отправителя</span>
                </div>
                <div class="step-content">
                    <div class="entity-selector">
                        <select id="from_entity_type" class="entity-type-select">
                            <option value="">Выберите тип отправителя</option>
                            <option value="CLIENT">Клиент</option>
                            <option value="WAREHOUSE">Склад</option>
                            <option value="LINE">Линия</option>
                            <option value="CARRIER">Перевозчик</option>
                            <option value="COMPANY">Компания</option>
                        </select>
                        <input type="text" id="from_entity_search" class="entity-search" placeholder="Начните вводить название отправителя..." disabled>
                        <div id="from_entity_results" class="entity-results"></div>
                        <div id="from_entity_selected" class="selected-entity">
                            <strong>Выбранный отправитель:</strong>
                            <span id="from_entity_display"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Шаг 2: Выбор получателя -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <span>Выберите получателя</span>
                </div>
                <div class="step-content">
                    <div class="entity-selector">
                        <select id="to_entity_type" class="entity-type-select">
                            <option value="">Выберите тип получателя</option>
                            <option value="CLIENT">Клиент</option>
                            <option value="WAREHOUSE">Склад</option>
                            <option value="LINE">Линия</option>
                            <option value="CARRIER">Перевозчик</option>
                            <option value="COMPANY">Компания</option>
                        </select>
                        <input type="text" id="to_entity_search" class="entity-search" placeholder="Начните вводить название получателя..." disabled>
                        <div id="to_entity_results" class="entity-results"></div>
                        <div id="to_entity_selected" class="selected-entity">
                            <strong>Выбранный получатель:</strong>
                            <span id="to_entity_display"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Шаг 3: Выбор типа услуг -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <span>Выберите тип услуг</span>
                </div>
                <div class="step-content">
                    <div class="entity-selector">
                        <select id="service_type" class="entity-type-select">
                            <option value="">Выберите тип услуг</option>
                            <option value="WAREHOUSE_SERVICES">Услуги склада (хранение)</option>
                            <option value="LINE_SERVICES">Услуги линий (перевозка)</option>
                            <option value="CARRIER_SERVICES">Услуги перевозчиков</option>
                            <option value="TRANSPORT_SERVICES">Транспортные услуги</option>
                            <option value="OTHER_SERVICES">Прочие услуги</option>
                        </select>
                        <div class="service-description" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 14px; color: #6c757d;">
                            <strong>Описание типов услуг:</strong><br>
                            • <strong>Услуги склада</strong> - только стоимость хранения автомобилей<br>
                            • <strong>Услуги линий</strong> - стоимость перевозки (ocean freight) + THS сбор<br>
                            • <strong>Услуги перевозчиков</strong> - доставка до склада + перевозка по Казахстану<br>
                            • <strong>Транспортные услуги</strong> - доставка до склада + перевозка по Казахстану<br>
                            • <strong>Прочие услуги</strong> - полная стоимость всех услуг
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Шаг 4: Выбор автомобилей -->
            <div class="step-container" id="cars_step" style="display: none;">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <span>Выберите автомобили для инвойса</span>
                </div>
                <div class="cars-section">
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="car_search" class="entity-search" placeholder="Поиск по VIN, марке или году...">
                    </div>
                    <div id="available_cars" class="cars-grid">
                        <div style="text-align: center; color: #6c757d; padding: 40px;">
                            Сначала выберите отправителя и получателя
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Сводка инвойса -->
            <div class="invoice-summary" id="invoice_summary" style="display: none;">
                <h3 style="margin-top: 0; color: #495057;">Сводка инвойса</h3>
                <div class="summary-row">
                    <span class="summary-label">Количество автомобилей:</span>
                    <span class="summary-value" id="cars_count">0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Общая стоимость:</span>
                    <span class="summary-value" id="total_cost">0.00 €</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Дата создания:</span>
                    <span class="summary-value" id="creation_date"></span>
                </div>
            </div>
            
            <!-- Сообщения об ошибках/успехе -->
            <div id="error_message" class="error-message" style="display: none;"></div>
            <div id="success_message" class="success-message" style="display: none;"></div>
            
            <!-- Действия -->
            <div class="form-actions">
                <button type="button" id="save_draft" class="btn btn-secondary">Сохранить черновик</button>
                <button type="submit" id="create_invoice" class="btn btn-success" disabled>Создать инвойс</button>
            </div>
        </form>
        </div>
    {% endif %}
{% endblock %}

{% block extrajs %}
    {{ block.super }}
    <script src="{% static 'js/logist2_invoice_admin.js' %}"></script>
{% endblock %}