{% extends "admin/base_site.html" %}
{% load static %}
{% load admin_extras %}

{% block title %}–î–∞—à–±–æ—Ä–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—É–º–º - {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .comparison-dashboard {
            margin: 20px;
        }
        .dashboard-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007cba;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007cba;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .discrepancies-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #007cba;
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        .discrepancy-row {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .discrepancy-row:nth-child(even) {
            background: #f8f9fa;
        }
        .status-match { color: #28a745; }
        .status-mismatch { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .filter-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background: #005a87;
        }
        .comparison-section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
    </style>
{% endblock %}

{% block content %}
<div class="comparison-dashboard">
    <div class="dashboard-header">
        <h1>üîç –î–∞—à–±–æ—Ä–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—É–º–º</h1>
        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö —Å—É–º–º —Å –∏–Ω–≤–æ–π—Å–∞–º–∏ —Å–∫–ª–∞–¥–∞</p>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="filter-form">
        <form method="get">
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">–î–∞—Ç–∞ –æ—Ç:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="end_date">–î–∞—Ç–∞ –¥–æ:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                </div>
            </div>
        </form>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ report.summary.cars_count }}</div>
            <div class="stat-label">–ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ report.summary.cars_total|floatformat:2 }}‚Ç¨</div>
            <div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ report.summary.invoices_total|floatformat:2 }}‚Ç¨</div>
            <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-value {% if report.summary.cars_vs_invoices_difference > 0 %}status-warning{% elif report.summary.cars_vs_invoices_difference < 0 %}status-mismatch{% else %}status-match{% endif %}">
                {{ report.summary.cars_vs_invoices_difference|floatformat:2 }}‚Ç¨
            </div>
            <div class="stat-label">–†–∞–∑–Ω–∏—Ü–∞ (–∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –∏–Ω–≤–æ–π—Å—ã)</div>
        </div>
    </div>

    <!-- –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è -->
    {% if discrepancies %}
    <div class="comparison-section">
        <div class="section-title">üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è</div>
        <div class="discrepancies-table">
            <div class="table-header">
                –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ —Å—É–º–º–∞—Ö
            </div>
            {% for discrepancy in discrepancies %}
            <div class="discrepancy-row">
                <strong>{{ discrepancy.type|title }}:</strong> {{ discrepancy.entity }}
                <br>
                <span class="status-mismatch">{{ discrepancy.comparison.message }}</span>
                <br>
                <small>
                    {% if discrepancy.type == 'client_comparison' %}
                        –ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π: {{ discrepancy.comparison.cars_count }} | 
                        –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ discrepancy.comparison.cars_total_cost|floatformat:2 }}‚Ç¨ | 
                        –ò–Ω–≤–æ–π—Å—ã: {{ discrepancy.comparison.warehouse_invoices_total|floatformat:2 }}‚Ç¨
                    {% elif discrepancy.type == 'warehouse_comparison' %}
                        –ò–Ω–≤–æ–π—Å–æ–≤: {{ discrepancy.comparison.invoices_count }} | 
                        –°—É–º–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤: {{ discrepancy.comparison.invoices_total|floatformat:2 }}‚Ç¨ | 
                        –ü–ª–∞—Ç–µ–∂–µ–π: {{ discrepancy.comparison.payments_total|floatformat:2 }}‚Ç¨
                    {% endif %}
                </small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
    {% if client_comparisons %}
    <div class="comparison-section">
        <div class="section-title">üë• –°—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</div>
        <div class="discrepancies-table">
            <div class="table-header">
                –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
            </div>
            {% for comparison in client_comparisons %}
            <div class="discrepancy-row">
                <strong>{{ comparison.client_name }}</strong>
                <span class="{% if comparison.status == 'match' %}status-match{% else %}status-warning{% endif %}">
                    ({{ comparison.status }})
                </span>
                <br>
                {{ comparison.message }}
                <br>
                <small>
                    –ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π: {{ comparison.cars_count }} | 
                    –°—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: {{ comparison.cars_total_cost|floatformat:2 }}‚Ç¨ | 
                    –°—É–º–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤ —Å–∫–ª–∞–¥–∞: {{ comparison.warehouse_invoices_total|floatformat:2 }}‚Ç¨ |
                    –†–∞–∑–Ω–∏—Ü–∞: {{ comparison.difference|floatformat:2 }}‚Ç¨
                </small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ —Å–∫–ª–∞–¥–∞–º -->
    {% if warehouse_comparisons %}
    <div class="comparison-section">
        <div class="section-title">üè¢ –°—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ —Å–∫–ª–∞–¥–∞–º</div>
        <div class="discrepancies-table">
            <div class="table-header">
                –ê–Ω–∞–ª–∏–∑ –ø–æ —Å–∫–ª–∞–¥–∞–º
            </div>
            {% for comparison in warehouse_comparisons %}
            <div class="discrepancy-row">
                <strong>{{ comparison.warehouse_name }}</strong>
                <span class="{% if comparison.status == 'match' %}status-match{% else %}status-warning{% endif %}">
                    ({{ comparison.status }})
                </span>
                <br>
                {{ comparison.message }}
                <br>
                <small>
                    –ò–Ω–≤–æ–π—Å–æ–≤: {{ comparison.invoices_count }} | 
                    –°—É–º–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤: {{ comparison.invoices_total|floatformat:2 }}‚Ç¨ | 
                    –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π: {{ comparison.payments_total|floatformat:2 }}‚Ç¨ |
                    –†–∞–∑–Ω–∏—Ü–∞: {{ comparison.difference|floatformat:2 }}‚Ç¨
                </small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="comparison-section">
        <div class="section-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
        <div class="stats-grid">
            <div class="stat-card">
                <a href="{% url 'admin:core_car_changelist' %}" class="btn" style="text-decoration: none; display: inline-block;">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏
                </a>
            </div>
            <div class="stat-card">
                <a href="{% url 'admin:core_invoice_changelist' %}" class="btn" style="text-decoration: none; display: inline-block;">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞–º–∏
                </a>
            </div>
            <div class="stat-card">
                <a href="{% url 'admin:core_payment_changelist' %}" class="btn" style="text-decoration: none; display: inline-block;">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏
                </a>
            </div>
            <div class="stat-card">
                <a href="{% url 'company_dashboard' %}" class="btn" style="text-decoration: none; display: inline-block;">
                    –î–∞—à–±–æ—Ä–¥ –∫–æ–º–ø–∞–Ω–∏–∏
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setTimeout(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}

