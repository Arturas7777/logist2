{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}Dashboard — Caromoto Lithuania{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
    /* ── Reset & Base ── */
    #content {
        background: #f4f2ff;
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    #content-main { padding: 0; }

    .db {
        max-width: 1480px;
        margin: 0 auto;
        padding: 28px 32px;
    }

    /* ── Header ── */
    .db-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 28px;
    }
    .db-header h1 {
        font-size: 1.65em;
        font-weight: 800;
        color: #1a1a2e;
        margin: 0;
        letter-spacing: -0.03em;
    }
    .db-header .db-subtitle {
        color: #7c7c9a;
        font-size: .92em;
        margin-top: 4px;
        font-weight: 400;
    }
    .db-header-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .db-date-badge {
        background: #fff;
        padding: 10px 18px;
        border-radius: 12px;
        font-size: .88em;
        font-weight: 600;
        color: #4a4a68;
        box-shadow: 0 1px 4px rgba(108,92,231,.08);
        border: 1px solid rgba(108,92,231,.08);
    }

    /* ── Quick Actions ── */
    .db-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 28px;
    }
    .db-action {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 9px 18px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        font-size: .84em;
        transition: all .2s ease;
        border: none;
        cursor: pointer;
    }
    .db-action.primary {
        background: #6c5ce7;
        color: #fff;
    }
    .db-action.primary:hover {
        background: #5a4bd1;
        box-shadow: 0 4px 14px rgba(108,92,231,.3);
        transform: translateY(-1px);
        color: #fff;
    }
    .db-action.outline {
        background: #fff;
        color: #6c5ce7;
        border: 1.5px solid #e0dcf8;
    }
    .db-action.outline:hover {
        background: #f4f2ff;
        border-color: #6c5ce7;
        color: #6c5ce7;
    }
    .db-action.ghost {
        background: transparent;
        color: #7c7c9a;
    }
    .db-action.ghost:hover {
        background: #fff;
        color: #6c5ce7;
    }

    /* ── Section Titles ── */
    .db-section {
        font-size: .78em;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        color: #a29bcc;
        margin: 32px 0 14px;
    }

    /* ── KPI Cards ── */
    .kpi-row {
        display: grid;
        gap: 16px;
        margin-bottom: 8px;
    }
    .kpi-row.five  { grid-template-columns: repeat(5, 1fr); }
    .kpi-row.four  { grid-template-columns: repeat(4, 1fr); }
    .kpi-row.three { grid-template-columns: repeat(3, 1fr); }
    .kpi-row.six   { grid-template-columns: repeat(6, 1fr); }

    .kpi {
        background: #fff;
        padding: 20px 22px;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(108,92,231,.06), 0 6px 16px rgba(108,92,231,.04);
        border: 1px solid rgba(108,92,231,.05);
        position: relative;
        transition: all .25s ease;
        overflow: hidden;
    }
    .kpi:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(108,92,231,.1), 0 12px 28px rgba(108,92,231,.07);
    }
    .kpi-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 14px;
    }
    .kpi-icon svg {
        width: 22px;
        height: 22px;
        stroke-width: 1.8;
    }
    .kpi-icon i {
        font-size: 22px;
        line-height: 1;
    }
    .kpi-label {
        font-size: .76em;
        text-transform: uppercase;
        letter-spacing: .6px;
        color: #9898b0;
        font-weight: 600;
        margin-bottom: 6px;
    }
    .kpi-value {
        font-size: 1.8em;
        font-weight: 800;
        line-height: 1.15;
        color: #1a1a2e;
        letter-spacing: -0.02em;
    }
    .kpi-sub {
        font-size: .8em;
        color: #b0b0c8;
        margin-top: 6px;
        font-weight: 500;
    }

    /* Icon backgrounds */
    .kpi-icon.blue      { background: #eef2ff; color: #6366f1; }
    .kpi-icon.red       { background: #fef2f2; color: #ef4444; }
    .kpi-icon.green     { background: #f0fdf4; color: #22c55e; }
    .kpi-icon.purple    { background: #f5f3ff; color: #8b5cf6; }
    .kpi-icon.amber     { background: #fffbeb; color: #f59e0b; }
    .kpi-icon.cyan      { background: #ecfeff; color: #06b6d4; }
    .kpi-icon.indigo    { background: #eef2ff; color: #4f46e5; }
    .kpi-icon.rose      { background: #fff1f2; color: #f43f5e; }

    /* Colored accent strip at top of card */
    .kpi::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        border-radius: 16px 16px 0 0;
        background: #e2e0f0;
    }
    .kpi.accent-blue::before    { background: linear-gradient(90deg, #6366f1, #818cf8); }
    .kpi.accent-red::before     { background: linear-gradient(90deg, #ef4444, #f87171); }
    .kpi.accent-green::before   { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .kpi.accent-purple::before  { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
    .kpi.accent-amber::before   { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .kpi.accent-cyan::before    { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
    .kpi.accent-rose::before    { background: linear-gradient(90deg, #f43f5e, #fb7185); }
    .kpi.accent-indigo::before  { background: linear-gradient(90deg, #4f46e5, #6366f1); }

    /* Value colors */
    .v-green  { color: #16a34a !important; }
    .v-red    { color: #dc2626 !important; }
    .v-blue   { color: #4f46e5 !important; }
    .v-purple { color: #7c3aed !important; }
    .v-amber  { color: #d97706 !important; }
    .v-cyan   { color: #0891b2 !important; }

    /* ── Charts ── */
    .charts-bar-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
        margin-bottom: 18px;
    }
    .charts-donut-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
        margin-bottom: 28px;
    }
    .chart-card {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(108,92,231,.06), 0 6px 16px rgba(108,92,231,.04);
        border: 1px solid rgba(108,92,231,.05);
    }
    .chart-card h3 {
        margin: 0 0 16px;
        font-size: .92em;
        font-weight: 700;
        color: #1a1a2e;
    }
    .chart-wrap {
        position: relative;
        height: 300px;
    }
    .chart-wrap-bar {
        position: relative;
        height: 280px;
    }
    .chart-center-label {
        position: absolute;
        top: 42%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none;
    }
    .chart-center-label .ccl-num {
        font-size: 1.8em;
        font-weight: 800;
        color: #1a1a2e;
        line-height: 1.1;
    }
    .chart-center-label .ccl-text {
        font-size: .78em;
        color: #9898b0;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: .5px;
    }

    /* ── Tables ── */
    .tables-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
        margin-bottom: 28px;
    }
    .tbl-card {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(108,92,231,.06), 0 6px 16px rgba(108,92,231,.04);
        border: 1px solid rgba(108,92,231,.05);
        overflow: hidden;
    }
    .tbl-card h3 {
        margin: 0 0 16px;
        font-size: .92em;
        font-weight: 700;
        color: #1a1a2e;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tbl-card h3 .tbl-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: .85em;
    }

    .tbl-scroll {
        max-height: 440px;
        overflow-y: auto;
    }
    .tbl-scroll::-webkit-scrollbar { width: 4px; }
    .tbl-scroll::-webkit-scrollbar-track { background: transparent; }
    .tbl-scroll::-webkit-scrollbar-thumb { background: #ddd8f3; border-radius: 4px; }
    .tbl-scroll::-webkit-scrollbar-thumb:hover { background: #b5aee0; }

    .dt {
        width: 100%;
        border-collapse: collapse;
        font-size: .84em;
    }
    .dt th, .dt td {
        padding: 11px 14px;
        text-align: left;
        white-space: nowrap;
    }
    .dt th {
        background: #f8f7fc;
        font-weight: 700;
        color: #9898b0;
        font-size: .78em;
        text-transform: uppercase;
        letter-spacing: .5px;
        border-bottom: 2px solid #eeecf6;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    .dt td {
        color: #4a4a68;
        border-bottom: 1px solid #f3f1fa;
    }
    .dt tbody tr {
        transition: background .15s;
    }
    .dt tbody tr:hover td {
        background: #faf9ff;
    }
    .dt .amount-in  { color: #16a34a; font-weight: 700; }
    .dt .amount-out { color: #dc2626; font-weight: 700; }
    .dt a {
        color: #6c5ce7;
        text-decoration: none;
        font-weight: 600;
    }
    .dt a:hover {
        color: #4f3cc9;
        text-decoration: underline;
    }

    /* ── Status Badges ── */
    .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: .73em;
        font-weight: 700;
        letter-spacing: .3px;
    }
    .badge-DRAFT          { background: #f3f1fa; color: #7c7c9a; }
    .badge-ISSUED         { background: #eef2ff; color: #4f46e5; }
    .badge-PARTIALLY_PAID { background: #fffbeb; color: #b45309; }
    .badge-PAID           { background: #f0fdf4; color: #15803d; }
    .badge-OVERDUE        { background: #fef2f2; color: #b91c1c; }
    .badge-CANCELLED      { background: #f3f1fa; color: #7c7c9a; }
    .badge-PENDING        { background: #fffbeb; color: #b45309; }
    .badge-COMPLETED      { background: #f0fdf4; color: #15803d; }
    .badge-FAILED         { background: #fef2f2; color: #b91c1c; }

    /* ── Summary Row ── */
    .summary-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }
    .summary-card {
        background: linear-gradient(135deg, #6c5ce7 0%, #a78bfa 100%);
        color: #fff;
        padding: 22px 24px;
        border-radius: 16px;
        box-shadow: 0 4px 18px rgba(108,92,231,.25);
    }
    .summary-card.green {
        background: linear-gradient(135deg, #16a34a 0%, #4ade80 100%);
        box-shadow: 0 4px 18px rgba(22,163,74,.2);
    }
    .summary-card.amber {
        background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%);
        box-shadow: 0 4px 18px rgba(217,119,6,.2);
    }
    .summary-card .sc-label {
        font-size: .78em;
        text-transform: uppercase;
        letter-spacing: .8px;
        opacity: .85;
        font-weight: 600;
        margin-bottom: 6px;
    }
    .summary-card .sc-value {
        font-size: 1.9em;
        font-weight: 800;
        letter-spacing: -0.02em;
    }
    .summary-card .sc-sub {
        font-size: .82em;
        margin-top: 4px;
        opacity: .75;
    }

    /* ── Responsive ── */
    @media (max-width: 1100px) {
        .charts-donut-row { grid-template-columns: 1fr; }
        .tables-grid { grid-template-columns: 1fr; }
        .kpi-row.five  { grid-template-columns: repeat(3, 1fr); }
        .kpi-row.six   { grid-template-columns: repeat(3, 1fr); }
        .summary-row   { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
        .db { padding: 16px; }
        .db-header { flex-direction: column; gap: 12px; }
        .kpi-row.five,
        .kpi-row.four,
        .kpi-row.three,
        .kpi-row.six { grid-template-columns: repeat(2, 1fr); }
        .db-actions { flex-direction: column; }
        .summary-row { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="db">

    <!-- ════════════════ HEADER ════════════════ -->
    <div class="db-header">
        <div>
            <h1>Dashboard</h1>
            <div class="db-subtitle">Caromoto Lithuania — оперативная сводка</div>
        </div>
        <div class="db-header-right">
            <div class="db-date-badge">
                <i class="bx bx-calendar" style="vertical-align:middle;margin-right:6px;font-size:1.2em;color:#6c5ce7"></i>{% now "d.m.Y, H:i" %}
            </div>
        </div>
    </div>

    <!-- ════════════════ QUICK ACTIONS ════════════════ -->
    <div class="db-actions">
        <a href="{% url 'admin:core_newinvoice_add' %}" class="db-action primary">＋ Инвойс</a>
        <a href="{% url 'admin:core_transaction_add' %}" class="db-action primary">＋ Транзакция</a>
        <a href="{% url 'admin:core_newinvoice_changelist' %}" class="db-action outline">Все инвойсы</a>
        <a href="{% url 'admin:core_transaction_changelist' %}" class="db-action outline">Все транзакции</a>
        <a href="{% url 'comparison_dashboard' %}" class="db-action outline">Сравнение сумм</a>
        {% if company %}
        <a href="{% url 'admin:core_company_change' company.pk %}" class="db-action ghost">Компания →</a>
        {% endif %}
    </div>

    <!-- ════════════════ TOP SUMMARY ════════════════ -->
    <div class="summary-row">
        <div class="summary-card">
            <div class="sc-label">Баланс компании</div>
            <div class="sc-value">{{ company_balance|floatformat:2 }} €</div>
            <div class="sc-sub">Актуальный баланс</div>
        </div>
        <div class="summary-card green">
            <div class="sc-label">Прибыль за месяц</div>
            <div class="sc-value">{{ monthly_profit|floatformat:2 }} €</div>
            <div class="sc-sub">Доход {{ monthly_revenue|floatformat:0 }} € − Расход {{ monthly_expenses|floatformat:0 }} €</div>
        </div>
        <div class="summary-card amber">
            <div class="sc-label">К получению</div>
            <div class="sc-value">{{ outstanding_invoices.total|floatformat:2 }} €</div>
            <div class="sc-sub">{{ outstanding_invoices.count }} активных инвойсов</div>
        </div>
    </div>

    <!-- ════════════════ OPERATIONAL KPIs ════════════════ -->
    <div class="db-section">Операционные показатели</div>
    <div class="kpi-row five">
        <div class="kpi accent-blue">
            <div class="kpi-icon blue"><i class="bx bxs-ship"></i></div>
            <div class="kpi-label">В пути</div>
            <div class="kpi-value v-blue">{{ cars_by_status.FLOATING }}</div>
            <div class="kpi-sub">Конт: {{ containers_by_status.FLOATING }}</div>
        </div>
        <div class="kpi accent-red">
            <div class="kpi-icon red"><i class="bx bxs-flag-alt"></i></div>
            <div class="kpi-label">В порту</div>
            <div class="kpi-value v-red">{{ cars_by_status.IN_PORT }}</div>
            <div class="kpi-sub">Конт: {{ containers_by_status.IN_PORT }}</div>
        </div>
        <div class="kpi accent-green">
            <div class="kpi-icon green"><i class="bx bxs-package"></i></div>
            <div class="kpi-label">Разгружены</div>
            <div class="kpi-value v-green">{{ cars_by_status.UNLOADED }}</div>
            <div class="kpi-sub">Конт: {{ containers_by_status.UNLOADED }}</div>
        </div>
        <div class="kpi accent-purple">
            <div class="kpi-icon purple"><i class="bx bxs-check-circle"></i></div>
            <div class="kpi-label">Переданы</div>
            <div class="kpi-value v-purple">{{ cars_by_status.TRANSFERRED }}</div>
            <div class="kpi-sub">Конт: {{ containers_by_status.TRANSFERRED }}</div>
        </div>
        <div class="kpi accent-amber">
            <div class="kpi-icon amber"><i class="bx bxs-buildings"></i></div>
            <div class="kpi-label">На хранении</div>
            <div class="kpi-value">{{ cars_on_storage.count }}</div>
            <div class="kpi-sub">{{ cars_on_storage.total_storage_cost|floatformat:2 }} €</div>
        </div>
    </div>

    <div class="kpi-row five" style="margin-bottom:28px">
        <div class="kpi accent-cyan">
            <div class="kpi-icon cyan"><i class="bx bxs-truck"></i></div>
            <div class="kpi-label">Активные тралы</div>
            <div class="kpi-value v-cyan">{{ active_auto_transports }}</div>
        </div>
        <div class="kpi accent-indigo">
            <div class="kpi-icon indigo"><i class="bx bxs-car"></i></div>
            <div class="kpi-label">Всего авто</div>
            <div class="kpi-value">{{ cars_by_status.total }}</div>
        </div>
        <div class="kpi accent-indigo">
            <div class="kpi-icon indigo"><i class="bx bxs-cube"></i></div>
            <div class="kpi-label">Всего контейнеров</div>
            <div class="kpi-value">{{ containers_by_status.total }}</div>
        </div>
        <div class="kpi" style="visibility:hidden;box-shadow:none;border:none"></div>
        <div class="kpi" style="visibility:hidden;box-shadow:none;border:none"></div>
    </div>

    <!-- ════════════════ FINANCIAL KPIs ════════════════ -->
    <div class="db-section">Финансовые показатели</div>
    <div class="kpi-row six" style="margin-bottom:28px">
        <div class="kpi accent-indigo">
            <div class="kpi-icon indigo"><i class="bx bxs-wallet"></i></div>
            <div class="kpi-label">Баланс</div>
            <div class="kpi-value {% if company_balance >= 0 %}v-green{% else %}v-red{% endif %}">
                {{ company_balance|floatformat:2 }} €
            </div>
        </div>
        <div class="kpi accent-green">
            <div class="kpi-icon green"><i class="bx bx-trending-up"></i></div>
            <div class="kpi-label">Доходы (мес.)</div>
            <div class="kpi-value v-green">+{{ monthly_revenue|floatformat:2 }} €</div>
        </div>
        <div class="kpi accent-red">
            <div class="kpi-icon red"><i class="bx bx-trending-down"></i></div>
            <div class="kpi-label">Расходы (мес.)</div>
            <div class="kpi-value v-red">−{{ monthly_expenses|floatformat:2 }} €</div>
        </div>
        <div class="kpi accent-cyan">
            <div class="kpi-icon cyan"><i class="bx bxs-bar-chart-alt-2"></i></div>
            <div class="kpi-label">Прибыль (мес.)</div>
            <div class="kpi-value {% if monthly_profit >= 0 %}v-green{% else %}v-red{% endif %}">
                {{ monthly_profit|floatformat:2 }} €
            </div>
        </div>
        <div class="kpi accent-amber">
            <div class="kpi-icon amber"><i class="bx bxs-receipt"></i></div>
            <div class="kpi-label">К получению</div>
            <div class="kpi-value v-amber">{{ outstanding_invoices.total|floatformat:2 }} €</div>
            <div class="kpi-sub">{{ outstanding_invoices.count }} инвойсов</div>
        </div>
        <div class="kpi accent-rose">
            <div class="kpi-icon rose"><i class="bx bxs-error-circle"></i></div>
            <div class="kpi-label">Просроченные</div>
            <div class="kpi-value {% if overdue_invoices_count > 0 %}v-red{% else %}v-green{% endif %}">
                {{ overdue_invoices_count }}
            </div>
        </div>
    </div>

    <!-- ════════════════ BANK ACCOUNTS ════════════════ -->
    {% if bank_accounts %}
    <div class="db-section"><i class="bx bxs-bank" style="font-size:1.1em;vertical-align:middle;margin-right:4px"></i> Банковские счета</div>
    <div class="kpi-row {% if bank_accounts|length <= 3 %}three{% elif bank_accounts|length == 4 %}four{% else %}five{% endif %}" style="margin-bottom:28px">
        {% for acc in bank_accounts %}
        <div class="kpi accent-indigo">
            <div class="kpi-icon indigo"><i class="bx bxs-bank"></i></div>
            <div class="kpi-label">{{ acc.connection__name }} — {{ acc.currency }}</div>
            <div class="kpi-value {% if acc.balance >= 0 %}v-green{% else %}v-red{% endif %}">
                {{ acc.balance|floatformat:2 }} {{ acc.currency }}
            </div>
            <div class="kpi-sub">
                {{ acc.name }}
                {% if acc.connection__last_synced_at %}
                · обновлено {{ acc.connection__last_synced_at|timesince }} назад
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ════════════════ CHARTS ════════════════ -->
    <div class="db-section">Аналитика</div>
    <div class="charts-bar-row">
        <div class="chart-card">
            <h3><i class="bx bx-bar-chart" style="vertical-align:middle;margin-right:8px;font-size:1.3em;color:#6c5ce7"></i>Доходы и расходы (6 мес.)</h3>
            <div class="chart-wrap-bar"><canvas id="revenueExpensesChart"></canvas></div>
        </div>
    </div>
    <div class="charts-donut-row">
        <div class="chart-card">
            <h3><i class="bx bxs-car" style="vertical-align:middle;margin-right:8px;font-size:1.3em;color:#6c5ce7"></i>Авто по статусам</h3>
            <div class="chart-wrap">
                <canvas id="carsChart"></canvas>
                <div class="chart-center-label">
                    <div class="ccl-num">{{ cars_by_status.total }}</div>
                    <div class="ccl-text">всего</div>
                </div>
            </div>
        </div>
        <div class="chart-card">
            <h3><i class="bx bxs-file" style="vertical-align:middle;margin-right:8px;font-size:1.3em;color:#6c5ce7"></i>Инвойсы по статусам</h3>
            <div class="chart-wrap">
                <canvas id="invoicesChart"></canvas>
                <div class="chart-center-label">
                    <div class="ccl-num" id="invoices-total">0</div>
                    <div class="ccl-text">всего</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ════════════════ P&L ПО КАТЕГОРИЯМ ════════════════ -->
    {% if expenses_by_category or income_by_category %}
    <div class="db-section"><i class="bx bxs-pie-chart-alt-2" style="font-size:1.1em;vertical-align:middle;margin-right:4px"></i> P&L по категориям (текущий месяц)</div>
    <div class="charts-donut-row">
        <!-- Doughnut: структура расходов -->
        <div class="chart-card">
            <h3><i class="bx bx-trending-down" style="vertical-align:middle;margin-right:8px;font-size:1.3em;color:#ef4444"></i>Структура расходов</h3>
            {% if expenses_by_category %}
            <div class="chart-wrap">
                <canvas id="expensesCategoryChart"></canvas>
            </div>
            {% else %}
            <div style="display:flex;align-items:center;justify-content:center;height:200px;color:#b0b0c8;font-size:.9em">Нет расходов за этот месяц</div>
            {% endif %}
        </div>
        <!-- Таблица: расходы по категориям -->
        <div class="chart-card" style="display:flex;flex-direction:column;">
            <h3><i class="bx bxs-spreadsheet" style="vertical-align:middle;margin-right:8px;font-size:1.3em;color:#6c5ce7"></i>Детализация расходов</h3>
            {% if expenses_by_category %}
            <div class="tbl-scroll" style="flex:1">
                <table class="dt">
                    <thead>
                        <tr><th>Категория</th><th style="text-align:right">Сумма</th><th style="text-align:right">%</th></tr>
                    </thead>
                    <tbody>
                    {% for item in expenses_by_category %}
                        <tr>
                            <td>{{ item.category_name }}</td>
                            <td class="amount-out" style="text-align:right">{{ item.amount|floatformat:2 }} €</td>
                            <td style="text-align:right;color:#9898b0;font-weight:600">{{ item.percent }}%</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="display:flex;align-items:center;justify-content:center;flex:1;color:#b0b0c8;font-size:.9em">Нет данных</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ════════════════ TABLES ════════════════ -->
    <div class="db-section">Последние операции</div>
    <div class="tables-grid">
        <!-- Transactions -->
        <div class="tbl-card">
            <h3>
                <span class="tbl-icon" style="background:#eef2ff;color:#4f46e5"><i class="bx bxs-credit-card"></i></span>
                Транзакции
            </h3>
            <div class="tbl-scroll">
                <table class="dt">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Номер</th>
                            <th>Тип</th>
                            <th>Сумма</th>
                            <th>Откуда</th>
                            <th>Куда</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for t in recent_transactions %}
                        <tr>
                            <td>{{ t.date|date:"d.m.Y" }}</td>
                            <td>{{ t.number }}</td>
                            <td>{{ t.get_type_display }}</td>
                            <td class="amount-in">{{ t.amount|floatformat:2 }} €</td>
                            <td>{{ t.sender_name }}</td>
                            <td>{{ t.recipient_name }}</td>
                            <td><span class="badge badge-{{ t.status }}">{{ t.get_status_display }}</span></td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="7" style="text-align:center;color:#b0b0c8;padding:28px">Нет транзакций</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Invoices -->
        <div class="tbl-card">
            <h3>
                <span class="tbl-icon" style="background:#f0fdf4;color:#16a34a"><i class="bx bxs-file-doc"></i></span>
                Инвойсы
            </h3>
            <div class="tbl-scroll">
                <table class="dt">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Номер</th>
                            <th>Получатель</th>
                            <th>Сумма</th>
                            <th>Оплачено</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for inv in recent_invoices %}
                        <tr>
                            <td>{{ inv.date|date:"d.m.Y" }}</td>
                            <td><a href="{% url 'admin:core_newinvoice_change' inv.pk %}">{{ inv.number }}</a></td>
                            <td>{{ inv.recipient_name }}</td>
                            <td>{{ inv.total|floatformat:2 }} €</td>
                            <td>{{ inv.paid_amount|floatformat:2 }} €</td>
                            <td><span class="badge badge-{{ inv.status }}">{{ inv.get_status_display }}</span></td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="6" style="text-align:center;color:#b0b0c8;padding:28px">Нет инвойсов</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ════════════════ BANK TRANSACTIONS TABLE ════════════════ -->
    {% if recent_bank_transactions %}
    <div class="db-section"><i class="bx bxs-bank" style="font-size:1.1em;vertical-align:middle;margin-right:4px"></i> Банковские операции</div>
    <div class="tables-grid" style="grid-template-columns:1fr">
        <div class="tbl-card">
            <h3>
                <span class="tbl-icon" style="background:#eef2ff;color:#4f46e5"><i class="bx bxs-bank"></i></span>
                Последние операции из банков
            </h3>
            <div class="tbl-scroll">
                <table class="dt">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Банк</th>
                            <th>Тип</th>
                            <th>Сумма</th>
                            <th>Валюта</th>
                            <th>Контрагент</th>
                            <th>Описание</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for bt in recent_bank_transactions %}
                        <tr>
                            <td>{{ bt.created_at|date:"d.m.Y" }}</td>
                            <td>{{ bt.connection.name }}</td>
                            <td>{{ bt.get_transaction_type_display }}</td>
                            <td class="{% if bt.amount >= 0 %}amount-in{% else %}amount-out{% endif %}">
                                {% if bt.amount >= 0 %}+{% endif %}{{ bt.amount|floatformat:2 }}
                            </td>
                            <td>{{ bt.currency }}</td>
                            <td>{{ bt.counterparty_name|default:"—" }}</td>
                            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">{{ bt.description|truncatechars:50 }}</td>
                            <td><span class="badge badge-{{ bt.state|upper }}">{{ bt.state }}</span></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Chart.js 4.x CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

{{ revenue_expenses_chart_json|json_script:"rev-exp-data" }}
{{ cars_by_status_json|json_script:"cars-data" }}
{{ invoices_by_status_json|json_script:"invoices-data" }}
{{ expenses_by_category_json|json_script:"expenses-cat-data" }}

<script>
(function() {
    'use strict';

    function parseJSON(id) {
        var el = document.getElementById(id);
        if (!el) return {};
        try { return JSON.parse(el.textContent); }
        catch(e) { console.error('Dashboard JSON parse error for #' + id, e); return {}; }
    }

    /* ── Palette ── */
    var STATUS_COLORS = {
        FLOATING: '#6366f1', IN_PORT: '#ef4444', UNLOADED: '#22c55e', TRANSFERRED: '#a78bfa'
    };
    var INV_COLORS = {
        DRAFT: '#cbd5e1', ISSUED: '#6366f1', PARTIALLY_PAID: '#f59e0b',
        PAID: '#22c55e', OVERDUE: '#ef4444', CANCELLED: '#94a3b8'
    };
    var INV_LABELS = {
        DRAFT: 'Черновик', ISSUED: 'Выставлен', PARTIALLY_PAID: 'Част. оплачен',
        PAID: 'Оплачен', OVERDUE: 'Просрочен', CANCELLED: 'Отменён'
    };
    var CAR_LABELS = {
        FLOATING: 'В пути', IN_PORT: 'В порту', UNLOADED: 'Разгружен', TRANSFERRED: 'Передан'
    };

    /* ── Helpers ── */
    function filterNonZero(dataObj, colorMap, labelMap) {
        var keys = [], labels = [], data = [], colors = [];
        Object.keys(dataObj).forEach(function(k) {
            if (dataObj[k] > 0) {
                keys.push(k);
                labels.push(labelMap[k] || k);
                data.push(dataObj[k]);
                colors.push(colorMap[k] || '#ccc');
            }
        });
        return { keys: keys, labels: labels, data: data, colors: colors };
    }

    function percentTooltip(context) {
        var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
        var val = context.parsed;
        var pct = total > 0 ? ((val / total) * 100).toFixed(1) : '0';
        return context.label + ': ' + val + ' (' + pct + '%)';
    }

    var DONUT_OPTIONS = {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '62%',
        layout: { padding: { top: 4, bottom: 4 } },
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#7c7c9a',
                    usePointStyle: true,
                    pointStyle: 'circle',
                    padding: 16,
                    font: { size: 12, weight: '600' }
                }
            },
            tooltip: {
                backgroundColor: '#1a1a2e',
                titleColor: '#fff',
                bodyColor: '#e0e0f0',
                titleFont: { size: 13, weight: '700' },
                bodyFont: { size: 12 },
                padding: 12,
                cornerRadius: 10,
                callbacks: { label: percentTooltip }
            }
        }
    };

    /* ── Wait for Chart.js to load ── */
    function initCharts() {
        if (typeof Chart === 'undefined') {
            console.error('Dashboard: Chart.js not loaded');
            return;
        }

        Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, sans-serif";

        /* ── Revenue / Expenses bar chart ── */
        var reData = parseJSON('rev-exp-data');
        var barCanvas = document.getElementById('revenueExpensesChart');
        if (reData.labels && reData.labels.length && barCanvas) {
            new Chart(barCanvas, {
                type: 'bar',
                data: {
                    labels: reData.labels,
                    datasets: [
                        {
                            label: 'Доходы',
                            data: reData.revenue,
                            backgroundColor: 'rgba(108,92,231,.75)',
                            hoverBackgroundColor: '#6c5ce7',
                            borderRadius: 8,
                            borderSkipped: false
                        },
                        {
                            label: 'Расходы',
                            data: reData.expenses,
                            backgroundColor: 'rgba(239,68,68,.65)',
                            hoverBackgroundColor: '#ef4444',
                            borderRadius: 8,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#7c7c9a',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { weight: '600', size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a2e',
                            titleColor: '#fff',
                            bodyColor: '#e0e0f0',
                            padding: 12,
                            cornerRadius: 10,
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString() + ' €';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            border: { display: false },
                            ticks: {
                                color: '#b0b0c8',
                                font: { size: 11 },
                                callback: function(v) { return v.toLocaleString() + ' €'; }
                            },
                            grid: { color: '#f3f1fa' }
                        },
                        x: {
                            border: { display: false },
                            ticks: { color: '#b0b0c8', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        /* ── Cars doughnut ── */
        var carsRaw = parseJSON('cars-data');
        var carsCanvas = document.getElementById('carsChart');
        var carsFiltered = filterNonZero(carsRaw, STATUS_COLORS, CAR_LABELS);

        if (carsFiltered.data.length > 0 && carsCanvas) {
            new Chart(carsCanvas, {
                type: 'doughnut',
                data: {
                    labels: carsFiltered.labels,
                    datasets: [{
                        data: carsFiltered.data,
                        backgroundColor: carsFiltered.colors,
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverOffset: 8,
                        hoverBorderWidth: 0
                    }]
                },
                options: DONUT_OPTIONS
            });
        } else if (carsCanvas) {
            carsCanvas.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#b0b0c8;font-size:.9em">Нет данных</div>';
        }

        /* ── Invoices doughnut ── */
        var invRaw = parseJSON('invoices-data');
        var invCanvas = document.getElementById('invoicesChart');
        var invFiltered = filterNonZero(invRaw, INV_COLORS, INV_LABELS);

        /* Set center total */
        var invTotalEl = document.getElementById('invoices-total');
        if (invTotalEl) {
            var invTotal = invFiltered.data.reduce(function(a, b) { return a + b; }, 0);
            invTotalEl.textContent = invTotal;
        }

        if (invFiltered.data.length > 0 && invCanvas) {
            new Chart(invCanvas, {
                type: 'doughnut',
                data: {
                    labels: invFiltered.labels,
                    datasets: [{
                        data: invFiltered.data,
                        backgroundColor: invFiltered.colors,
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverOffset: 8,
                        hoverBorderWidth: 0
                    }]
                },
                options: DONUT_OPTIONS
            });
        } else if (invCanvas) {
            invCanvas.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#b0b0c8;font-size:.9em">Нет данных</div>';
        }

        /* ── Expenses by category doughnut ── */
        var expCatRaw = parseJSON('expenses-cat-data');
        var expCatCanvas = document.getElementById('expensesCategoryChart');
        if (expCatRaw && expCatRaw.length > 0 && expCatCanvas) {
            var EXP_CAT_PALETTE = [
                '#6366f1', '#ef4444', '#f59e0b', '#22c55e', '#06b6d4',
                '#8b5cf6', '#f43f5e', '#14b8a6', '#e879f9', '#fb923c'
            ];
            var catLabels = expCatRaw.map(function(r) { return r.category_name; });
            var catData = expCatRaw.map(function(r) { return r.amount; });
            var catColors = expCatRaw.map(function(_, i) { return EXP_CAT_PALETTE[i % EXP_CAT_PALETTE.length]; });
            var catTotal = catData.reduce(function(a, b) { return a + b; }, 0);

            new Chart(expCatCanvas, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catData,
                        backgroundColor: catColors,
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverOffset: 8,
                        hoverBorderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#7c7c9a',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 14,
                                font: { size: 11, weight: '600' }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a2e',
                            titleColor: '#fff',
                            bodyColor: '#e0e0f0',
                            padding: 12,
                            cornerRadius: 10,
                            callbacks: {
                                label: function(ctx) {
                                    var val = ctx.parsed;
                                    var pct = catTotal > 0 ? ((val / catTotal) * 100).toFixed(1) : '0';
                                    return ctx.label + ': ' + val.toLocaleString() + ' € (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    /* Run when DOM ready */
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initCharts, 100);
        });
    } else {
        setTimeout(initCharts, 100);
    }
})();
</script>
{% endblock %}
