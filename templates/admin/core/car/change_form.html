{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /* ===== Modals ‚Äî Caromoto Design System ===== */
    .cm-modal-overlay {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,.4);
      backdrop-filter: blur(4px);
    }
    .cm-modal {
      background: var(--cm-card, #fff);
      margin: 5% auto;
      padding: 0;
      border: none;
      width: 90%;
      max-width: 560px;
      border-radius: var(--cm-radius, 14px);
      max-height: 80vh;
      overflow: hidden;
      box-shadow: var(--cm-shadow-md, 0 4px 16px rgba(0,0,0,.08));
    }
    .cm-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      background: #fafafc;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .cm-modal-header h2 {
      font-size: .95rem;
      font-weight: 700;
      color: var(--cm-text, #1a1a2e);
      margin: 0;
    }
    .cm-modal-close {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: var(--cm-text-muted, #9ca3af);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      transition: color .15s;
    }
    .cm-modal-close:hover { color: var(--cm-text, #1a1a2e); }
    .cm-modal-body {
      padding: 20px 24px;
      overflow-y: auto;
      max-height: 55vh;
    }
    .cm-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid rgba(0,0,0,.06);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Service items inside modals */
    .cm-service-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--cm-border, #ebebf0);
      transition: background .15s;
    }
    .cm-service-item:last-child { border-bottom: none; }
    .cm-service-item:hover { background: var(--cm-bg, #f5f6fa); }
    .cm-service-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      accent-color: var(--cm-purple, #6c5ce7);
      cursor: pointer;
    }
    .cm-service-name {
      flex: 1;
      font-size: .88rem;
      font-weight: 500;
      color: var(--cm-text, #1a1a2e);
    }
    .cm-service-price {
      font-weight: 700;
      font-size: .88rem;
      color: var(--cm-green, #10b981);
    }

    /* Modal select */
    .cm-modal-select {
      width: 100%;
      padding: 9px 14px;
      border: 1px solid var(--cm-border, #ebebf0);
      border-radius: var(--cm-radius-xs, 8px);
      font-size: .88rem;
      background: var(--cm-white, #fff);
      color: var(--cm-text, #1a1a2e);
      font-family: var(--cm-font, 'Inter', sans-serif);
      cursor: pointer;
    }
    .cm-modal-select:focus {
      border-color: var(--cm-purple, #6c5ce7);
      box-shadow: 0 0 0 3px var(--cm-purple-bg, #f0edff);
      outline: none;
    }

    /* Primary button in modals */
    .cm-btn-primary {
      background: var(--cm-purple, #6c5ce7);
      color: var(--cm-white, #fff);
      border: none;
      padding: 9px 20px;
      border-radius: var(--cm-radius-xs, 8px);
      font-size: .85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--cm-font, 'Inter', sans-serif);
      transition: all .2s;
    }
    .cm-btn-primary:hover {
      background: var(--cm-purple-dark, #5a4bd1);
      box-shadow: var(--cm-shadow-md, 0 4px 16px rgba(0,0,0,.08));
    }

    /* Add service button (round +) */
    .add-service-btn {
      background: var(--cm-purple, #6c5ce7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      margin-left: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }
    .add-service-btn:hover {
      background: var(--cm-purple-dark, #5a4bd1);
      transform: scale(1.1);
    }
  </style>
{% endblock %}

{% block content_title %}{% endblock %}

{% block content %}
<div class="cm-page-header">
  <h1>{% if original %}{{ original.vin }}{% else %}–ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å{% endif %}</h1>
  <a href="{% url 'admin:core_car_changelist' %}" class="cm-back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="cm-form-grid" {% if original %}style="--cm-status-color: {{ original.get_status_color }};"{% endif %}>
  <div class="cm-form-main">
    {{ block.super }}
  </div>

  <div class="cm-form-sidebar-col">
    {% if original %}
    {# ‚îÄ‚îÄ Status Card ‚îÄ‚îÄ #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-body" style="text-align: center;">
        <div class="cm-status-badge-lg" style="background-color: {{ original.get_status_color }};">
          {{ original.get_status_display }}
        </div>
        {% if original.container %}
        <div style="margin-top: 14px;">
          <a href="{% url 'admin:core_container_change' original.container.pk %}"
             class="cm-status-badge-lg" style="background-color: {{ original.container.get_status_color }}; font-size: .82rem;">
            üì¶ {{ original.container.number }}
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    {# ‚îÄ‚îÄ Info Card ‚îÄ‚îÄ #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-header">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
      </div>
      <div class="cm-sidebar-card-body">
        {% if original.client %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–ö–ª–∏–µ–Ω—Ç</span>
          <span class="cm-sidebar-info-value">
            <a href="{% url 'admin:core_client_change' original.client.pk %}">{{ original.client }}</a>
          </span>
        </div>
        {% endif %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–ú–∞—Ä–∫–∞</span>
          <span class="cm-sidebar-info-value">{{ original.brand|default:"‚Äî" }}</span>
        </div>
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–ì–æ–¥</span>
          <span class="cm-sidebar-info-value">{{ original.year|default:"‚Äî" }}</span>
        </div>
        {% if original.line %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–õ–∏–Ω–∏—è</span>
          <span class="cm-sidebar-info-value">{{ original.line }}</span>
        </div>
        {% endif %}
        {% if original.warehouse %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–°–∫–ª–∞–¥</span>
          <span class="cm-sidebar-info-value">{{ original.warehouse }}</span>
        </div>
        {% endif %}
        {% if original.carrier %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</span>
          <span class="cm-sidebar-info-value">{{ original.carrier }}</span>
        </div>
        {% endif %}
      </div>
    </div>

    {# ‚îÄ‚îÄ Finances Card ‚îÄ‚îÄ #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-header">
        <h3>–§–∏–Ω–∞–Ω—Å—ã</h3>
      </div>
      <div class="cm-sidebar-card-body">
        <div class="cm-sidebar-highlight">
          <div class="cm-hl-label">–ò—Ç–æ–≥–æ</div>
          <div class="cm-hl-value">{{ original.total_price|floatformat:2 }} ‚Ç¨</div>
        </div>
        {% if original.storage_cost %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–•—Ä–∞–Ω–µ–Ω–∏–µ</span>
          <span class="cm-sidebar-info-value">{{ original.storage_cost|floatformat:2 }} ‚Ç¨</span>
        </div>
        {% endif %}
        {% if original.days %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏</span>
          <span class="cm-sidebar-info-value">{{ original.days }}</span>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Actions Card ‚îÄ‚îÄ #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-header">
        <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
      </div>
      <div class="cm-sidebar-card-body">
        <div class="cm-sidebar-actions">
          <button type="button" class="cm-btn cm-btn-save" onclick="cmSubmitForm('car_form', '_save')">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          {% if original %}
          <button type="button" class="cm-btn cm-btn-outline-action" onclick="cmSubmitForm('car_form', '_continue')">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
          {% else %}
          <button type="button" class="cm-btn cm-btn-outline-action" onclick="cmSubmitForm('car_form', '_addanother')">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë
          </button>
          {% endif %}
          <a href="{% url 'admin:core_car_changelist' %}" class="cm-btn cm-btn-outline-action">
            –û—Ç–º–µ–Ω–∞
          </a>
          {% if original and has_delete_permission %}
          <div class="cm-sidebar-divider"></div>
          <a href="{% url 'admin:core_car_delete' original.pk %}" class="cm-btn cm-btn-delete">
            –£–¥–∞–ª–∏—Ç—å
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# ‚îÄ‚îÄ –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ ‚îÄ‚îÄ #}
{% if original %}
<div id="warehouseServicesModal" class="cm-modal-overlay">
  <div class="cm-modal">
    <div class="cm-modal-header">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞</h2>
      <button class="cm-modal-close" onclick="closeModal('warehouseServicesModal')">&times;</button>
    </div>
    <div class="cm-modal-body">
      <div style="margin-bottom: 16px;">
        <label style="font-size:.78rem;font-weight:600;color:var(--cm-text-secondary);margin-bottom:6px;display:block;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</label>
        <select id="warehouseSelect" onchange="loadWarehouseServices()" class="cm-modal-select">
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ ‚Äî</option>
        </select>
      </div>
      <div id="warehouseServicesList"></div>
    </div>
    <div class="cm-modal-footer">
      <button class="cm-btn-primary" onclick="addSelectedServices('warehouse')">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>
</div>

<div id="lineServicesModal" class="cm-modal-overlay">
  <div class="cm-modal">
    <div class="cm-modal-header">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏</h2>
      <button class="cm-modal-close" onclick="closeModal('lineServicesModal')">&times;</button>
    </div>
    <div class="cm-modal-body">
      <div id="lineServicesList"></div>
    </div>
    <div class="cm-modal-footer">
      <button class="cm-btn-primary" onclick="addSelectedServices('line')">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>
</div>

<div id="carrierServicesModal" class="cm-modal-overlay">
  <div class="cm-modal">
    <div class="cm-modal-header">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞</h2>
      <button class="cm-modal-close" onclick="closeModal('carrierServicesModal')">&times;</button>
    </div>
    <div class="cm-modal-body">
      <div id="carrierServicesList"></div>
    </div>
    <div class="cm-modal-footer">
      <button class="cm-btn-primary" onclick="addSelectedServices('carrier')">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>
</div>

<div id="companyServicesModal" class="cm-modal-overlay">
  <div class="cm-modal">
    <div class="cm-modal-header">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏</h2>
      <button class="cm-modal-close" onclick="closeModal('companyServicesModal')">&times;</button>
    </div>
    <div class="cm-modal-body">
      <div style="margin-bottom: 16px;">
        <label style="font-size:.78rem;font-weight:600;color:var(--cm-text-secondary);margin-bottom:6px;display:block;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é</label>
        <select id="companySelect" onchange="loadCompanyServices()" class="cm-modal-select">
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é ‚Äî</option>
        </select>
      </div>
      <div id="companyServicesList"></div>
    </div>
    <div class="cm-modal-footer">
      <button class="cm-btn-primary" onclick="addSelectedServices('company')">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>
</div>
{% endif %}

<script>
  /* ‚îÄ‚îÄ Form submission from sidebar ‚îÄ‚îÄ */
  function cmSubmitForm(formId, action) {
    var form = document.getElementById(formId);
    if (!form) return;
    // Create a hidden submit button inside the form and click it
    var btn = document.createElement('input');
    btn.type = 'submit';
    btn.name = action;
    btn.value = '1';
    btn.style.display = 'none';
    form.appendChild(btn);
    btn.click();
  }

  {% if original %}
  /* ‚îÄ‚îÄ Modal functions ‚îÄ‚îÄ */
  function openModal(modalId, serviceType) {
    var modal = document.getElementById(modalId);
    modal.style.display = "block";
    
    if (serviceType === 'warehouse') {
      loadWarehouses();
    } else if (serviceType === 'company') {
      loadCompanies();
    } else {
      loadAvailableServices(serviceType);
    }
  }
  
  function loadWarehouses() {
    fetch('/api/warehouses/')
      .then(response => response.json())
      .then(data => {
        var warehouseSelect = document.getElementById('warehouseSelect');
        warehouseSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ ‚Äî</option>';
        
        if (data.warehouses && data.warehouses.length > 0) {
          data.warehouses.forEach(function(warehouse) {
            var option = document.createElement('option');
            option.value = warehouse.id;
            option.textContent = warehouse.name;
            warehouseSelect.appendChild(option);
          });
        }
      })
      .catch(function(error) { console.error('Error loading warehouses:', error); });
  }
  
  function loadWarehouseServices() {
    var warehouseId = document.getElementById('warehouseSelect').value;
    if (!warehouseId) {
      document.getElementById('warehouseServicesList').innerHTML = '';
      return;
    }
    
    var carId = {{ original.id }};
    var url = '/api/car/' + carId + '/get_available_services/?type=warehouse&warehouse_id=' + warehouseId;
    
    fetch(url)
      .then(function(response) { return response.json(); })
      .then(function(data) {
        renderServiceList('warehouseServicesList', data.services);
      })
      .catch(function(error) {
        console.error('Error loading services:', error);
        document.getElementById('warehouseServicesList').innerHTML = '<p style="color:var(--cm-text-muted);font-size:.85rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥</p>';
      });
  }

  function loadCompanies() {
    fetch('/api/companies/')
      .then(function(response) { return response.json(); })
      .then(function(data) {
        var companySelect = document.getElementById('companySelect');
        companySelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é ‚Äî</option>';
        
        if (data.companies && data.companies.length > 0) {
          data.companies.forEach(function(company) {
            var option = document.createElement('option');
            option.value = company.id;
            option.textContent = company.name;
            companySelect.appendChild(option);
          });
        }
      })
      .catch(function(error) { console.error('Error loading companies:', error); });
  }

  function loadCompanyServices() {
    var companyId = document.getElementById('companySelect').value;
    if (!companyId) {
      document.getElementById('companyServicesList').innerHTML = '';
      return;
    }
    
    var carId = {{ original.id }};
    var url = '/api/car/' + carId + '/get_available_services/?type=company&company_id=' + companyId;
    
    fetch(url)
      .then(function(response) { return response.json(); })
      .then(function(data) {
        renderServiceList('companyServicesList', data.services);
      })
      .catch(function(error) {
        console.error('Error loading services:', error);
        document.getElementById('companyServicesList').innerHTML = '<p style="color:var(--cm-text-muted);font-size:.85rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥</p>';
      });
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  function loadAvailableServices(serviceType) {
    var carId = {{ original.id }};
    var listId = serviceType + 'ServicesList';
    var url = '/api/car/' + carId + '/get_available_services/?type=' + serviceType;
    
    fetch(url)
      .then(function(response) {
        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
        return response.json();
      })
      .then(function(data) {
        renderServiceList(listId, data.services);
      })
      .catch(function(error) {
        console.error('Error loading services:', error);
        document.getElementById(listId).innerHTML = '<p style="color:var(--cm-text-muted);font-size:.85rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥</p>';
      });
  }

  function renderServiceList(containerId, services) {
    var listElement = document.getElementById(containerId);
    listElement.innerHTML = '';
    
    if (services && services.length > 0) {
      services.forEach(function(service) {
        var serviceItem = document.createElement('div');
        serviceItem.className = 'cm-service-item';
        serviceItem.innerHTML =
          '<input type="checkbox" value="' + service.id + '" id="service_' + service.id + '">' +
          '<label for="service_' + service.id + '" class="cm-service-name">' + service.name + '</label>' +
          '<span class="cm-service-price">$' + service.price + '</span>';
        listElement.appendChild(serviceItem);
      });
    } else {
      listElement.innerHTML = '<p style="color:var(--cm-text-muted);font-size:.85rem;text-align:center;padding:20px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</p>';
    }
  }

  function addSelectedServices(serviceType) {
    var carId = {{ original.id }};
    var checkboxes = document.querySelectorAll('#' + serviceType + 'ServicesList input[type="checkbox"]:checked');
    var serviceIds = Array.from(checkboxes).map(function(cb) { return cb.value; });
    
    if (serviceIds.length === 0) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É');
      return;
    }

    fetch('/api/car/' + carId + '/add_services/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        service_type: serviceType,
        service_ids: serviceIds
      })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success && data.added_count > 0) {
        alert('–£—Å–ª—É–≥–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã! (' + data.added_count + ')');
        closeModal(serviceType + 'ServicesModal');
        location.reload();
      } else if (data.already_exists) {
        alert(data.message || '–≠—Ç–∏ —É—Å–ª—É–≥–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ –¥–∞–Ω–Ω–æ–º—É –∞–≤—Ç–æ–º–æ–±–∏–ª—é.');
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥: ' + (data.message || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    })
    .catch(function(error) {
      console.error('Error adding services:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥: ' + error.message);
    });
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    var modals = document.querySelectorAll('.cm-modal-overlay');
    modals.forEach(function(modal) {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
  }
  {% endif %}
</script>
{% endblock %}
