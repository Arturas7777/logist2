{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrastyle %}
  {{ block.super }}
{% endblock %}

{% block topbar_title %}
  <span>{% if original %}{{ original.number }}{% else %}Новый контейнер{% endif %}</span>
{% endblock %}

{% block content_title %}{% endblock %}

{% block content %}

<div class="cm-form-grid" {% if original %}style="--cm-status-color: {{ original.get_status_color }};"{% endif %}>
  <div class="cm-form-main">
    {% if original %}
    <img src="{% static 'icons/container.png' %}" id="cm-container-photo-el" class="cm-car-photo" alt="Container">
    {% endif %}
    {{ block.super }}
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    var img = document.getElementById('cm-container-photo-el');
    if (!img) return;
    var fieldset = document.querySelector('.cm-form-main fieldset.module');
    if (!fieldset) return;
    var heading = fieldset.querySelector('.fieldset-heading');
    if (heading) {
      heading.after(img);
    } else {
      fieldset.prepend(img);
    }
  });
  </script>

  <div class="cm-form-sidebar-col">
    {% if original %}
    {# ── Status Card ── #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-body" style="text-align: center;">
        <div class="cm-status-badge-lg" style="background-color: {{ original.get_status_color }};">
          {{ original.get_status_display }}
        </div>
        {% if original.notes %}
        <p style="margin: 12px 0 0; color: var(--cm-text-secondary); font-size: .85rem;">
          {{ original.notes }}
        </p>
        {% endif %}
      </div>
    </div>

    {# ── Photos & Google Drive Card ── #}
    {% if original.pk %}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-header">
        <h3>Фотографии</h3>
      </div>
      <div class="cm-sidebar-card-body">
        {% with photos_count=original.photos.count %}
        <div style="text-align: center; margin-bottom: 14px;">
          <span class="cm-photos-badge {% if photos_count > 0 %}has-photos{% else %}no-photos{% endif %}">
            Фотографий: <strong>{{ photos_count }}</strong>
          </span>
        </div>
        {% endwith %}

        <button type="button" id="sync-gdrive-btn" class="cm-gdrive-btn">
          Загрузить фото с Google Drive
        </button>
        <div id="sync-status" style="margin-top: 8px; text-align: center;"></div>

        {% if original.google_drive_folder_url %}
        <div style="margin-top: 10px; text-align: center;">
          <a href="{{ original.google_drive_folder_url }}" target="_blank"
             style="color: var(--cm-purple); text-decoration: none; font-size: .82rem; font-weight: 600;">
            Открыть Google Drive →
          </a>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# ── Info Card ── #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-header">
        <h3>Информация</h3>
      </div>
      <div class="cm-sidebar-card-body">
        {% if original.line %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">Линия</span>
          <span class="cm-sidebar-info-value">{{ original.line }}</span>
        </div>
        {% endif %}
        {% if original.warehouse %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">Склад</span>
          <span class="cm-sidebar-info-value">{{ original.warehouse }}</span>
        </div>
        {% endif %}
        {% if original.ths %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">THS</span>
          <span class="cm-sidebar-info-value">{{ original.ths|floatformat:2 }} €</span>
        </div>
        {% endif %}
        {% if original.ths_payer %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">THS плательщик</span>
          <span class="cm-sidebar-info-value">{{ original.get_ths_payer_display }}</span>
        </div>
        {% endif %}
        {% if original.eta %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">ETA</span>
          <span class="cm-sidebar-info-value">{{ original.eta|date:"d.m.Y" }}</span>
        </div>
        {% endif %}
        {% if original.unload_date %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">Дата разгрузки</span>
          <span class="cm-sidebar-info-value">{{ original.unload_date|date:"d.m.Y" }}</span>
        </div>
        {% endif %}
        <div class="cm-sidebar-info-row">
          <span class="cm-sidebar-info-label">Авто в контейнере</span>
          <span class="cm-sidebar-info-value">{{ original.container_cars.count }}</span>
        </div>
      </div>
    </div>
    {% endif %}

    {# ── Actions Card ── #}
    <div class="cm-sidebar-card">
      <div class="cm-sidebar-card-header">
        <h3>Действия</h3>
      </div>
      <div class="cm-sidebar-card-body">
        <div class="cm-sidebar-actions">
          <button type="button" class="cm-btn cm-btn-save" onclick="cmSubmitForm('container_form', '_save')">
            Сохранить
          </button>
          {% if original %}
          <button type="button" class="cm-btn cm-btn-outline-action" onclick="cmSubmitForm('container_form', '_continue')">
            Сохранить и продолжить
          </button>
          {% else %}
          <button type="button" class="cm-btn cm-btn-outline-action" onclick="cmSubmitForm('container_form', '_addanother')">
            Сохранить и добавить ещё
          </button>
          {% endif %}
          <a href="{% url 'admin:core_container_changelist' %}" class="cm-btn cm-btn-outline-action">
            Отмена
          </a>
          {% if original and has_delete_permission %}
          <div class="cm-sidebar-divider"></div>
          <a href="{% url 'admin:core_container_delete' original.pk %}" class="cm-btn cm-btn-delete">
            Удалить
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ── Form submission from sidebar ── */
  function cmSubmitForm(formId, action) {
    var form = document.getElementById(formId);
    if (!form) return;
    var btn = document.createElement('input');
    btn.type = 'submit';
    btn.name = action;
    btn.value = '1';
    btn.style.display = 'none';
    form.appendChild(btn);
    btn.click();
  }

  {% if original and original.pk %}
  /* ── Google Drive sync ── */
  document.getElementById('sync-gdrive-btn').addEventListener('click', function() {
    var btn = this;
    var status = document.getElementById('sync-status');

    btn.disabled = true;
    btn.textContent = 'Синхронизация...';
    status.textContent = '';

    fetch('{% url "core:sync_container_photos_gdrive" original.pk %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        status.innerHTML = '<span style="color: var(--cm-green); background: var(--cm-green-bg); padding: 5px 12px; border-radius: 6px; font-weight:600; font-size:.82rem;">✓ ' + data.message + '</span>';
        setTimeout(function() { location.reload(); }, 2000);
      } else {
        status.innerHTML = '<span style="color: var(--cm-red); background: var(--cm-red-bg); padding: 5px 12px; border-radius: 6px; font-weight:600; font-size:.82rem;">✗ ' + data.error + '</span>';
        btn.disabled = false;
        btn.textContent = 'Загрузить фото с Google Drive';
      }
    })
    .catch(function(error) {
      status.innerHTML = '<span style="color: var(--cm-red); background: var(--cm-red-bg); padding: 5px 12px; border-radius: 6px; font-weight:600; font-size:.82rem;">✗ Ошибка: ' + error + '</span>';
      btn.disabled = false;
      btn.textContent = 'Загрузить фото с Google Drive';
    });
  });
  {% endif %}
</script>
{% endblock %}

{% block after_related_objects %}
  {{ block.super }}
  {# Photo gallery — separate block under all inlines #}
  {% if original.pk %}
  {% include "admin/core/container/photos_gallery.html" with photos_json=photos_json %}
  {% endif %}
{% endblock %}
