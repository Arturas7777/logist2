{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrastyle %}
  {{ block.super }}
  {# dashboard_admin.css loaded globally via base_site.html #}
  <style>
    /* –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Google Drive */
    #sync-gdrive-btn {
      background: linear-gradient(135deg, #4285f4 0%, #2962ff 100%);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
    }
    
    #sync-gdrive-btn:hover {
      background: linear-gradient(135deg, #2962ff 0%, #1565c0 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
    }
    
    #sync-gdrive-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    /* –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
    #sync-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ç–æ */
    .photos-info {
      display: inline-block;
      margin-left: 15px;
      padding: 8px 15px;
      background: #f0f7ff;
      border-radius: 20px;
      font-size: 14px;
      color: #1565c0;
    }
    
    .photos-info.has-photos {
      background: #e8f5e9;
      color: #2e7d32;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container-details" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
    <p style="margin: 0 0 15px 0;">
      <span class="status-highlight"
            style="background-color: {{ original.get_status_color }}; color: white; padding: 8px 16px; border-radius: 5px; font-weight: 600;">
        {{ original.get_status_display }}
      </span>
      {% if original.notes %}
        <span style="margin-left: 20px; color: #666;">
          {{ original.notes }}
        </span>
      {% endif %}
    </p>
    
    {% if original.pk %}
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button type="button" id="sync-gdrive-btn">
        üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive
      </button>
      <span id="sync-status"></span>
      
      {% with photos_count=original.photos.count %}
      <span class="photos-info {% if photos_count > 0 %}has-photos{% endif %}">
        üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: <strong>{{ photos_count }}</strong>
      </span>
      {% endwith %}
      
      {% if original.google_drive_folder_url %}
      <a href="{{ original.google_drive_folder_url }}" target="_blank" 
         style="color: #4285f4; text-decoration: none; font-size: 14px;">
        üîó –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É Google Drive
      </a>
      {% endif %}
    </div>
    
    <script>
    document.getElementById('sync-gdrive-btn').addEventListener('click', function() {
      const btn = this;
      const status = document.getElementById('sync-status');
      
      btn.disabled = true;
      btn.innerHTML = '‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
      status.textContent = '';
      
      fetch('{% url "core:sync_container_photos_gdrive" original.pk %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          status.innerHTML = '<span style="color: #2e7d32; background: #e8f5e9; padding: 5px 10px; border-radius: 4px;">‚úì ' + data.message + '</span>';
          setTimeout(() => location.reload(), 2000);
        } else {
          status.innerHTML = '<span style="color: #c62828; background: #ffebee; padding: 5px 10px; border-radius: 4px;">‚úó ' + data.error + '</span>';
          btn.disabled = false;
          btn.innerHTML = 'üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive';
        }
      })
      .catch(error => {
        status.innerHTML = '<span style="color: #c62828; background: #ffebee; padding: 5px 10px; border-radius: 4px;">‚úó –û—à–∏–±–∫–∞: ' + error + '</span>';
        btn.disabled = false;
        btn.innerHTML = 'üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive';
      });
    });
    </script>
    {% endif %}
  </div>
  
  {{ block.super }}
{% endblock %}

{% block after_related_objects %}
  {{ block.super }}
  {# –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π - –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –ø–æ–¥ –≤—Å–µ–º–∏ inline #}
  {% if original.pk %}
  {% include "admin/core/container/photos_gallery.html" with photos_json=photos_json %}
  {% endif %}
{% endblock %}
