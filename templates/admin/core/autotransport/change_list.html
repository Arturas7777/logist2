{% extends "admin/change_list.html" %}

{% block extrahead %}
{{ block.super }}
<style>
    .at-load-group {
        white-space: nowrap;
    }
    .at-load-btn:hover {
        opacity: 0.85;
    }
    /* –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ */
    .at-load-group.success {
        opacity: 0.5;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
{{ block.super }}

{% csrf_token %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∂–µ–Ω"
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('.at-load-btn');
        if (!btn) return;

        e.preventDefault();
        var atId = btn.dataset.atId;
        var url = btn.dataset.url;
        var group = btn.closest('.at-load-group');
        var dateInput = group.querySelector('.at-load-date');
        var dateValue = dateInput ? dateInput.value : '';

        if (!confirm('–ü–æ–º–µ—Ç–∏—Ç—å –∞–≤—Ç–æ–≤–æ–∑ –∫–∞–∫ "–ó–∞–≥—Ä—É–∂–µ–Ω"' + 
                     (dateValue ? ' (–¥–∞—Ç–∞: ' + dateValue + ')' : ' (–¥–∞—Ç–∞: —Å–µ–≥–æ–¥–Ω—è)') + '?')) {
            return;
        }

        btn.disabled = true;
        btn.textContent = '‚è≥...';

        var formData = new FormData();
        formData.append('transfer_date', dateValue);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
            }
        })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            if (data.success) {
                group.classList.add('success');
                btn.textContent = '‚úì –ó–∞–≥—Ä—É–∂–µ–Ω';
                btn.style.background = 'var(--cm-green, #10b981)';
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
                setTimeout(function() { location.reload(); }, 1000);
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞');
                btn.disabled = false;
                btn.textContent = 'üöõ –ó–∞–≥—Ä—É–∂–µ–Ω';
            }
        })
        .catch(function(err) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'üöõ –ó–∞–≥—Ä—É–∂–µ–Ω';
        });
    });
});
</script>
{% endblock %}
