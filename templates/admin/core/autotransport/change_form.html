{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<link href="{% static 'css/autotransport.css' %}?v=4" rel="stylesheet">
<style>
    .select2-selection__choice a {
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block content_title %}{% endblock %}

{% block content %}
<div class="cm-page-header">
    <h1>{% if add %}–ù–æ–≤—ã–π –∞–≤—Ç–æ–≤–æ–∑{% else %}–ê–≤—Ç–æ–≤–æ–∑ {{ original.number }}{% endif %}</h1>
    <a href="{% url 'admin:core_autotransport_changelist' %}" class="cm-back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<form method="post" id="{{ opts.model_name }}_form" enctype="multipart/form-data" novalidate>
{% csrf_token %}
{% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
{% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}

<div class="autotransport-grid">
    <div class="main-content">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–µ -->
        <div class="card">
            <div class="card-header">
                <span class="icon">üöö</span>
                <h2>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</h2>
                {% if original %}
                <span class="status-badge status-{{ original.status|lower }}">{{ original.get_status_display }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="form-row-2">
                    <div class="form-group">
                        <label>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ *</label>
                        {{ adminform.form.carrier }}
                    </div>
                    <div class="form-group">
                        <label>EORI –∫–æ–¥</label>
                        {{ adminform.form.eori_code }}
                        <div class="form-hint">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –≤–æ–¥–∏—Ç–µ–ª—å -->
        <div class="card">
            <div class="card-header">
                <span class="icon">üöõ</span>
                <h2>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –≤–æ–¥–∏—Ç–µ–ª—å</h2>
            </div>
            <div class="card-body">
                <div class="form-row-2" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>–ê–≤—Ç–æ–≤–æ–∑</label>
                        {{ adminform.form.truck }}
                        <div class="form-hint">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</div>
                    </div>
                    <div class="form-group">
                        <label>–í–æ–¥–∏—Ç–µ–ª—å</label>
                        {{ adminform.form.driver }}
                        <div class="form-hint">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</div>
                    </div>
                </div>

                <div class="form-row-2" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</label>
                        {{ adminform.form.truck_number_manual }}
                    </div>
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</label>
                        {{ adminform.form.trailer_number_manual }}
                    </div>
                </div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label>–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</label>
                        {{ adminform.form.driver_name_manual }}
                    </div>
                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è</label>
                        {{ adminform.form.driver_phone }}
                        <div class="form-hint">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–∞—Ä—à—Ä—É—Ç -->
        <div class="card">
            <div class="card-header">
                <span class="icon">üõ£Ô∏è</span>
                <h2>–ú–∞—Ä—à—Ä—É—Ç</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>–ì—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</label>
                    {{ adminform.form.border_crossing }}
                    <div class="form-hint">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å - —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∂–µ—Ç —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã</div>
                </div>
            </div>
        </div>

        <!-- –î–∞—Ç—ã -->
        <div class="card">
            <div class="card-header">
                <span class="icon">üìÖ</span>
                <h2>–î–∞—Ç—ã</h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</label>
                        {{ adminform.form.loading_date }}
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
                        {{ adminform.form.departure_date }}
                    </div>
                </div>
                <div class="form-row-2">
                    <div class="form-group">
                        <label>–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</label>
                        {{ adminform.form.estimated_delivery_date }}
                    </div>
                    <div class="form-group">
                        <label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</label>
                        {{ adminform.form.actual_delivery_date }}
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ -->
        <div class="card">
            <div class="card-header">
                <span class="icon">üöó</span>
                <h2>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –∞–≤—Ç–æ–≤–æ–∑–µ</h2>
                {% if original %}
                <span class="cars-count-badge">{{ original.cars_count }} –∞–≤—Ç–æ</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="cars-hint">
                    üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å VIN –∏–ª–∏ –º–∞—Ä–∫—É - –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã!
                </div>
                <select name="cars" id="cars_select" multiple="multiple" style="width: 100%;">
                    {% for car in cars %}
                    <option value="{{ car.pk }}" data-status="{{ car.status }}" {% if original and car.pk in selected_car_ids %}selected{% endif %}>{{ car.brand }} {{ car.year }} ({{ car.vin }}) {% if car.client %}- {{ car.client.name }}{% endif %}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
        <div class="card">
            <div class="card-header">
                <span class="icon">üìù</span>
                <h2>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    {{ adminform.form.notes }}
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        {% if original %}
        <div class="card">
            <div class="card-body">
                <div class="autotransport-number-display">
                    <div class="label">–ù–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞</div>
                    <div class="number">{{ original.number }}</div>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="label">–ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π</div>
                        <div class="value">{{ original.cars_count }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <div class="label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
                            <div class="value">{{ original.get_clients|length }}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">–ò–Ω–≤–æ–π—Å–æ–≤</div>
                            <div class="value">{{ original.invoices.count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if original.invoices.exists %}
        <div class="card">
            <div class="card-header">
                <span class="icon">üìÑ</span>
                <h2>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã</h2>
            </div>
            <div class="card-body">
                {% for invoice in original.invoices.all %}
                <div class="invoice-link-item">
                    <div>
                        <div class="invoice-number">{{ invoice.number }}</div>
                        <div class="invoice-client">{{ invoice.recipient_client.name }}</div>
                    </div>
                    <div class="invoice-amount">{{ invoice.total|floatformat:2 }} ‚Ç¨</div>
                    <a href="{% url 'admin:core_newinvoice_change' invoice.pk %}" class="invoice-link-btn">‚Üí</a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="card">
            <div class="card-body">
                <div class="autotransport-number-display">
                    <div class="label">–ù–æ–≤—ã–π –∞–≤—Ç–æ–≤–æ–∑</div>
                    <div class="number" style="font-size:18px;">–ù–æ–º–µ—Ä –ø—Ä–∏—Å–≤–æ–∏—Ç—Å—è<br>–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
                </div>
                <p style="text-align:center;color:var(--gray-600);font-size:14px;margin:0;">–ü–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã</p>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <span class="icon">‚öôÔ∏è</span>
                <h2>–°—Ç–∞—Ç—É—Å</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    {{ adminform.form.status }}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="icon">‚ö°</span>
                <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
            </div>
            <div class="card-body">
                <div class="actions-buttons">
                    <button type="submit" name="_save" value="1" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    {% if original %}
                    <button type="submit" name="_continue" value="1" class="btn btn-outline">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    {% else %}
                    <button type="submit" name="_addanother" value="1" class="btn btn-outline">‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë</button>
                    {% endif %}
                    <a href="{% url 'admin:core_autotransport_changelist' %}" class="btn btn-outline">‚úï –û—Ç–º–µ–Ω–∞</a>
                    {% if original %}
                    <div class="actions-divider"></div>
                    <a href="{% url 'admin:core_autotransport_delete' original.pk %}" class="btn btn-danger btn-sm">üóë –£–¥–∞–ª–∏—Ç—å</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

</form>

<script>
// –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: Select2 CDN —Ç—Ä–µ–±—É–µ—Ç window.jQuery
// Django admin –∏—Å–ø–æ–ª—å–∑—É–µ—Ç django.jQuery - —Å–æ–∑–¥–∞–µ–º –º–æ—Å—Ç
window.jQuery = window.django && window.django.jQuery ? window.django.jQuery : window.jQuery;
window.$ = window.jQuery;
console.log('‚úÖ jQuery –º–æ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤–µ—Ä—Å–∏—è:', window.jQuery ? window.jQuery.fn.jquery : '–ù–ï–¢');
</script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// –ò—Å–ø–æ–ª—å–∑—É–µ–º django.jQuery –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π jQuery
(function($) {
    if (!$) {
        console.error('jQuery not found!');
        return;
    }
    
    $(document).ready(function() {
        console.log('üöõ AutoTransport JS –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

        // ============================================
        // 1. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï EORI –ö–û–î–ê –ò–ó –ü–ï–†–ï–í–û–ó–ß–ò–ö–ê
        // ============================================
        const carrierSelect = $('#id_carrier');
        const eoriInput = $('#id_eori_code');

        if (carrierSelect.length && eoriInput.length) {
            carrierSelect.on('change', function() {
                const carrierId = $(this).val();
                if (!carrierId) {
                    eoriInput.val('');
                    return;
                }

                $.ajax({
                    url: '/core/api/carrier/' + carrierId + '/info/',
                    method: 'GET',
                    success: function(data) {
                        if (data.eori_code) {
                            eoriInput.val(data.eori_code);
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π
                        updateTrucksList(data.trucks);
                        updateDriversList(data.drivers);
                    },
                    error: function(xhr, status, error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞:', error);
                    }
                });
            });
        }

        // ============================================
        // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ê–í–¢–û–í–û–ó–û–í
        // ============================================
        function updateTrucksList(trucks) {
            const truckSelect = $('#id_truck');
            if (!truckSelect.length) return;

            const currentValue = truckSelect.val();
            truckSelect.empty();
            truckSelect.append('<option value="">---------</option>');

            trucks.forEach(function(truck) {
                const option = $('<option></option>')
                    .val(truck.id)
                    .text(truck.text);
                truckSelect.append(option);
            });

            if (currentValue) {
                truckSelect.val(currentValue);
            }
        }

        // ============================================
        // 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –í–û–î–ò–¢–ï–õ–ï–ô
        // ============================================
        function updateDriversList(drivers) {
            const driverSelect = $('#id_driver');
            if (!driverSelect.length) return;

            const currentValue = driverSelect.val();
            driverSelect.empty();
            driverSelect.append('<option value="">---------</option>');

            drivers.forEach(function(driver) {
                const option = $('<option></option>')
                    .val(driver.id)
                    .text(driver.text);
                driverSelect.append(option);
            });

            if (currentValue) {
                driverSelect.val(currentValue);
            }
        }

        // ============================================
        // 4. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ï–õ–ï–§–û–ù–ê –í–û–î–ò–¢–ï–õ–Ø
        // ============================================
        const driverSelect = $('#id_driver');
        const driverPhoneInput = $('#id_driver_phone');

        if (driverSelect.length && driverPhoneInput.length) {
            driverSelect.on('change', function() {
                const driverId = $(this).val();
                if (!driverId) {
                    return;
                }

                $.ajax({
                    url: '/core/api/driver/' + driverId + '/phone/',
                    method: 'GET',
                    success: function(data) {
                        if (data.phone) {
                            driverPhoneInput.val(data.phone);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è:', error);
                    }
                });
            });
        }

        // ============================================
        // 5. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SELECT2 –î–õ–Ø –ê–í–¢–û–ú–û–ë–ò–õ–ï–ô (–ë–ï–ó AJAX, –ö–ê–ö –í –ò–ù–í–û–ô–°–ê–•)
        // ============================================
        var carAdminBaseUrl = '/admin/core/car/';
        
        $('#cars_select').select2({
            placeholder: '–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ –º–∞—Ä–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞...',
            allowClear: true,
            templateResult: function(state) {
                if (!state.id) return state.text;
                var status = $(state.element).data('status');
                var statusLabels = {
                    'FLOATING': 'üö¢ –í –ø—É—Ç–∏',
                    'IN_PORT': '‚öì –í –ø–æ—Ä—Ç—É',
                    'UNLOADED': '‚úÖ –†–∞–∑–≥—Ä—É–∂–µ–Ω',
                    'TRANSFERRED': 'üì¶ –ü–µ—Ä–µ–¥–∞–Ω'
                };
                var statusLabel = statusLabels[status] || '';
                return $('<span>' + state.text + (statusLabel ? ' <small style="opacity:0.7;">' + statusLabel + '</small>' : '') + '</span>');
            },
            templateSelection: function(state) {
                if (!state.id) return state.text;
                var status = $(state.element).data('status');
                var link = carAdminBaseUrl + state.id + '/change/';
                return $('<a href="' + link + '" target="_blank" data-status="' + status + '" ' +
                    'onclick="event.stopPropagation();" ' +
                    'style="color:inherit;text-decoration:none;cursor:pointer;">' + state.text + '</a>');
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º data-status –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ç–µ–≥–∞–º
        function applyStatusColors() {
            $('.select2-selection__choice').each(function() {
                var $choice = $(this);
                var $el = $choice.find('[data-status]');
                if ($el.length) {
                    $choice.attr('data-status', $el.data('status'));
                }
            });
        }
        
        $('#cars_select').on('select2:select select2:unselect', function() {
            setTimeout(applyStatusColors, 10);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
        setTimeout(applyStatusColors, 100);

        console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ AutoTransport –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
    });

})(django.jQuery || jQuery || $);
</script>
{% endblock %}
