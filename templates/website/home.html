{% extends "website/base.html" %}
{% load i18n %}

{% block title %}{% trans "Caromoto Lithuania - –î–æ—Å—Ç–∞–≤–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ –°–®–ê" %}{% endblock %}

{% block content %}
<!-- Hero —Å–µ–∫—Ü–∏—è -->
<section class="hero-section text-white py-4">
    <div class="container position-relative" style="z-index: 1;">
        <div class="row align-items-center">
            <div class="col-lg-6 mb-3 mb-lg-0">
                <div class="mb-3">
                    <span class="badge px-3 py-2" style="background: var(--accent-red); font-size: 0.9rem; font-weight: 600;">
                        üöó {% trans "–ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–°–¢–ò–ö–ê" %}
                    </span>
                </div>
                <h1 class="display-4 fw-bold mb-3" style="line-height: 1.2;">
                    {% trans "–î–æ—Å—Ç–∞–≤–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π" %}<br>
                    <span style="color: var(--accent-red);">{% trans "–∏–∑ –°–®–ê" %}</span>
                </h1>
                <p class="lead mb-3" style="font-size: 1.1rem; opacity: 0.9;">
                    {% trans "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –∏ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ." %}<br>
                    {% trans "–ë–æ–ª–µ–µ 10 –ª–µ—Ç –æ–ø—ã—Ç–∞ –Ω–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ä—ã–Ω–∫–µ." %}
                </p>
                <div class="d-flex gap-3 flex-wrap">
                    <a href="{% url 'website:services' %}" class="btn btn-lg px-4 py-3" style="background: var(--accent-red); border: none; font-weight: 600; letter-spacing: 0.5px;">
                        <i class="bi bi-box-seam"></i> {% trans "–ù–ê–®–ò –£–°–õ–£–ì–ò" %}
                    </a>
                    <a href="{% url 'website:contact' %}" class="btn btn-outline-light btn-lg px-4 py-3" style="font-weight: 600; letter-spacing: 0.5px;">
                        <i class="bi bi-envelope"></i> {% trans "–°–í–Ø–ó–ê–¢–¨–°–Ø" %}
                    </a>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="tracking-card bg-white text-dark rounded shadow-lg p-4">
                    <h4 class="mb-3">
                        <i class="bi bi-search text-primary"></i> {% trans "–û—Ç—Å–ª–µ–¥–∏—Ç—å –≥—Ä—É–∑" %}
                    </h4>
                    <form id="tracking-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="tracking_number" class="form-label">{% trans "VIN –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏–ª–∏ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞" %}</label>
                            <input type="text" class="form-control form-control-lg" id="tracking_number" 
                                   placeholder="{% trans '–ù–∞–ø—Ä–∏–º–µ—Ä: 1HGCM82633A123456' %}" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-search"></i> {% trans "–û—Ç—Å–ª–µ–¥–∏—Ç—å" %}
                        </button>
                    </form>
                    <div id="tracking-result" class="mt-3"></div>
                    <div id="photos-section" class="mt-3" style="display: none;">
                        <button id="show-photos-btn" class="btn btn-success w-100" style="display: none;">
                            <i class="bi bi-camera"></i> {% trans "–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
<section class="py-4 bg-light workflow-section">
    <div class="container">
        <h2 class="text-center mb-3">{% trans "–ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç –Ω–∞—Å" %}</h2>
        <div class="row g-3">
            <div class="col-md-3 col-sm-6">
                <div class="feature-card text-center p-4 h-100 bg-white rounded shadow-sm card-caromoto">
                    <div class="icon-box mb-3">
                        <i class="bi bi-shield-check text-caromoto-red" style="font-size: 3rem;"></i>
                    </div>
                    <h5>{% trans "–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å" %}</h5>
                    <p class="text-muted mb-0">{% trans "–ü–æ–ª–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏" %}</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="feature-card text-center p-4 h-100 bg-white rounded shadow-sm card-caromoto">
                    <div class="icon-box mb-3">
                        <i class="bi bi-clock-history text-caromoto-green" style="font-size: 3rem;"></i>
                    </div>
                    <h5>{% trans "–°–∫–æ—Ä–æ—Å—Ç—å" %}</h5>
                    <p class="text-muted mb-0">{% trans "–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ 30-45 –¥–Ω–µ–π" %}</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="feature-card text-center p-4 h-100 bg-white rounded shadow-sm card-caromoto">
                    <div class="icon-box mb-3">
                        <i class="bi bi-currency-dollar text-caromoto-yellow" style="font-size: 3rem;"></i>
                    </div>
                    <h5>{% trans "–í—ã–≥–æ–¥–Ω—ã–µ —Ü–µ–Ω—ã" %}</h5>
                    <p class="text-muted mb-0">{% trans "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ" %}</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="feature-card text-center p-4 h-100 bg-white rounded shadow-sm card-caromoto">
                    <div class="icon-box mb-3">
                        <i class="bi bi-headset text-caromoto-red" style="font-size: 3rem;"></i>
                    </div>
                    <h5>{% trans "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7" %}</h5>
                    <p class="text-muted mb-0">{% trans "–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏" %}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç -->
<section class="py-4">
    <div class="container">
        <h2 class="text-center mb-3">{% trans "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" %}</h2>
        <div class="row g-3">
            <div class="col-md-3">
                <div class="step-card text-center">
                    <div class="step-number bg-primary text-white rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                         style="width: 50px; height: 50px;">
                        <span class="fs-5 fw-bold">1</span>
                    </div>
                    <h6 class="mb-2">{% trans "–ó–∞—è–≤–∫–∞" %}</h6>
                    <p class="text-muted small mb-0">{% trans "–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ —Å–∞–π—Ç–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º" %}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step-card text-center">
                    <div class="step-number bg-primary text-white rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                         style="width: 50px; height: 50px;">
                        <span class="fs-5 fw-bold">2</span>
                    </div>
                    <h6 class="mb-2">{% trans "–†–∞—Å—á–µ—Ç" %}</h6>
                    <p class="text-muted small mb-0">{% trans "–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏" %}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step-card text-center">
                    <div class="step-number bg-primary text-white rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                         style="width: 50px; height: 50px;">
                        <span class="fs-5 fw-bold">3</span>
                    </div>
                    <h6 class="mb-2">{% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}</h6>
                    <p class="text-muted small mb-0">{% trans "–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏" %}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step-card text-center">
                    <div class="step-number bg-primary text-white rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                         style="width: 50px; height: 50px;">
                        <span class="fs-5 fw-bold">4</span>
                    </div>
                    <h6 class="mb-2">{% trans "–ü–æ–ª—É—á–µ–Ω–∏–µ" %}</h6>
                    <p class="text-muted small mb-0">{% trans "–ü–æ–ª—É—á–∏—Ç–µ –≤–∞—à –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å–æ –≤—Å–µ–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏" %}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- –ù–æ–≤–æ—Å—Ç–∏ -->
{% if latest_news %}
<section class="py-4 bg-light">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">{% trans "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏" %}</h2>
            <a href="{% url 'website:news_list' %}" class="btn btn-outline-primary">
                {% trans "–í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏" %} <i class="bi bi-arrow-right"></i>
            </a>
        </div>
        <div class="row g-4">
            {% for post in latest_news %}
            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    {% if post.image %}
                    <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-primary d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="bi bi-newspaper text-white" style="font-size: 4rem;"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ post.title }}</h5>
                        <p class="card-text text-muted">{{ post.excerpt|truncatewords:20 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> {{ post.published_at|date:"d.m.Y" }}
                            </small>
                            <a href="{% url 'website:news_detail' post.slug %}" class="btn btn-sm btn-primary">
                                {% trans "–ß–∏—Ç–∞—Ç—å" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA —Å–µ–∫—Ü–∏—è -->
<section class="py-4 text-white cta-section">
    <div class="container text-center">
        <h2 class="mb-3 fw-bold">–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?</h2>
        <p class="lead mb-3">–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∏ —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
        <a href="{% url 'website:contact' %}" class="btn btn-lg px-5 py-3" style="background: var(--accent-red); border: none; font-weight: 600; letter-spacing: 0.5px;">
            <i class="bi bi-envelope"></i> –°–í–Ø–ó–ê–¢–¨–°–Ø –° –ù–ê–ú–ò
        </a>
    </div>
</section>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
<div class="modal fade" id="photosModal" tabindex="-1" aria-labelledby="photosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photosModalLabel">
                    <i class="bi bi-camera"></i> –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="photos-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...</p>
                </div>
                <div id="photos-content" style="display: none;">
                    <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è —Ç–∏–ø–æ–≤ —Ñ–æ—Ç–æ -->
                    <ul class="nav nav-tabs mb-3" id="photosTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-photos-tab" data-bs-toggle="tab" data-bs-target="#all-photos" type="button" role="tab">
                                <i class="bi bi-images"></i> –í—Å–µ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" id="in-container-tab-li" style="display: none;">
                            <button class="nav-link" id="in-container-tab" data-bs-toggle="tab" data-bs-target="#in-container-photos" type="button" role="tab">
                                <i class="bi bi-box-seam"></i> –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" id="unloading-tab-li" style="display: none;">
                            <button class="nav-link" id="unloading-tab" data-bs-toggle="tab" data-bs-target="#unloading-photos" type="button" role="tab">
                                <i class="bi bi-truck"></i> –í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ
                            </button>
                        </li>
                    </ul>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllPhotos">
                                <label class="form-check-label" for="selectAllPhotos">
                                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="downloadSelectedBtn" class="btn btn-success" disabled>
                                <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                            </button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="photosTabContent">
                        <div class="tab-pane fade show active" id="all-photos" role="tabpanel">
                            <div id="photos-grid-all" class="row g-3"></div>
                        </div>
                        <div class="tab-pane fade" id="in-container-photos" role="tabpanel">
                            <div id="photos-grid-in-container" class="row g-3"></div>
                        </div>
                        <div class="tab-pane fade" id="unloading-photos" role="tabpanel">
                            <div id="photos-grid-unloading" class="row g-3"></div>
                        </div>
                    </div>
                </div>
                <div id="photos-error" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const trackingForm = document.getElementById('tracking-form');
    const trackingResult = document.getElementById('tracking-result');
    const photosSection = document.getElementById('photos-section');
    const showPhotosBtn = document.getElementById('show-photos-btn');
    const photosModal = new bootstrap.Modal(document.getElementById('photosModal'));
    
    let currentContainerNumber = null;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    trackingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const trackingNumber = document.getElementById('tracking_number').value.trim();
        
        if (!trackingNumber) {
            showResult('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è', 'danger');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        showResult('<div class="spinner-border spinner-border-sm me-2"></div>–ü–æ–∏—Å–∫...', 'info');
        
        fetch('{% url "website:track_shipment" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                tracking_number: trackingNumber,
                email: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.type) {
                let resultHtml = '<div class="alert alert-success"><h6><i class="bi bi-check-circle"></i> –ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω!</h6>';
                
                if (data.type === 'car') {
                    const car = data.data;
                    resultHtml += `<p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${car.vin}</p>`;
                    resultHtml += `<p><strong>–ú–∞—Ä–∫–∞:</strong> ${car.brand || 'N/A'}</p>`;
                    resultHtml += `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${car.status_display || car.status}</p>`;
                    
                    // –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    if (car.container_unload_date) {
                        const unloadDate = new Date(car.container_unload_date);
                        resultHtml += `<p><strong>–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏:</strong> ${unloadDate.toLocaleDateString('ru-RU')}</p>`;
                    }
                    
                    // –ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞ (—Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å, –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)
                    if (car.warehouse_address) {
                        resultHtml += `<p><strong>–°–∫–ª–∞–¥:</strong> ${car.warehouse_address}</p>`;
                    }
                    
                    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (car.container_number) {
                        resultHtml += `<p><strong>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:</strong> ${car.container_number}</p>`;
                    }
                    
                    // –ï—Å–ª–∏ —É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    if (car.container_number && car.container_photos_count > 0) {
                        currentContainerNumber = car.container_number;
                        photosSection.style.display = 'block';
                        showPhotosBtn.style.display = 'block';
                    } else {
                        photosSection.style.display = 'none';
                    }
                } else if (data.type === 'container') {
                    const container = data.data;
                    resultHtml += `<p><strong>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:</strong> ${container.number}</p>`;
                    resultHtml += `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${container.status_display || container.status}</p>`;
                    
                    // –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏
                    if (container.unload_date) {
                        const unloadDate = new Date(container.unload_date);
                        resultHtml += `<p><strong>–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏:</strong> ${unloadDate.toLocaleDateString('ru-RU')}</p>`;
                    }
                    
                    if (container.line_name) {
                        resultHtml += `<p><strong>–õ–∏–Ω–∏—è:</strong> ${container.line_name}</p>`;
                    }
                    
                    // –ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞ (—Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å, –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)
                    if (container.warehouse_address) {
                        resultHtml += `<p><strong>–°–∫–ª–∞–¥:</strong> ${container.warehouse_address}</p>`;
                    }
                    
                    if (container.cars_count) {
                        resultHtml += `<p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π:</strong> ${container.cars_count}</p>`;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    currentContainerNumber = container.number;
                    photosSection.style.display = 'block';
                    showPhotosBtn.style.display = 'block';
                }
                
                resultHtml += '</div>';
                showResult(resultHtml, 'success');
            } else if (data.error) {
                showResult(`<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`, 'warning');
                photosSection.style.display = 'none';
            } else {
                showResult('<div class="alert alert-danger"><i class="bi bi-x-circle"></i> –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞</div>', 'danger');
                photosSection.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showResult('<div class="alert alert-danger"><i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥—Ä—É–∑–∞</div>', 'danger');
            photosSection.style.display = 'none';
        });
    });
    
    showPhotosBtn.addEventListener('click', function() {
        if (currentContainerNumber) {
            loadContainerPhotos(currentContainerNumber);
            photosModal.show();
        }
    });
    
    function showResult(message, type) {
        trackingResult.innerHTML = message;
    }
    
    function loadContainerPhotos(containerNumber) {
        const photosLoading = document.getElementById('photos-loading');
        const photosContent = document.getElementById('photos-content');
        const photosError = document.getElementById('photos-error');
        
        // Grids –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
        const photosGridAll = document.getElementById('photos-grid-all');
        const photosGridInContainer = document.getElementById('photos-grid-in-container');
        const photosGridUnloading = document.getElementById('photos-grid-unloading');
        
        // –í–∫–ª–∞–¥–∫–∏
        const inContainerTabLi = document.getElementById('in-container-tab-li');
        const unloadingTabLi = document.getElementById('unloading-tab-li');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        photosLoading.style.display = 'block';
        photosContent.style.display = 'none';
        photosError.style.display = 'none';
        
        fetch(`/api/container-photos/${containerNumber}/`)
        .then(response => response.json())
        .then(data => {
            photosLoading.style.display = 'none';
            
            if (data.success && data.photos.length > 0) {
                // –û—á–∏—â–∞–µ–º –≤—Å–µ grid'—ã
                photosGridAll.innerHTML = '';
                photosGridInContainer.innerHTML = '';
                photosGridUnloading.innerHTML = '';
                
                // –°—á—ë—Ç—á–∏–∫–∏
                let inContainerCount = 0;
                let unloadingCount = 0;
                
                data.photos.forEach(photo => {
                    const photoCard = createPhotoCard(photo);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ "–í—Å–µ"
                    photosGridAll.appendChild(photoCard.cloneNode(true));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≤–∫–ª–∞–¥–∫—É
                    if (photo.photo_type_code === 'IN_CONTAINER') {
                        photosGridInContainer.appendChild(photoCard.cloneNode(true));
                        inContainerCount++;
                    } else if (photo.photo_type_code === 'UNLOADING') {
                        photosGridUnloading.appendChild(photoCard.cloneNode(true));
                        unloadingCount++;
                    } else {
                        // GENERAL - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        photosGridUnloading.appendChild(photoCard.cloneNode(true));
                        unloadingCount++;
                    }
                });
                
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ñ–æ—Ç–æ
                inContainerTabLi.style.display = inContainerCount > 0 ? 'block' : 'none';
                unloadingTabLi.style.display = unloadingCount > 0 ? 'block' : 'none';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–í—Å–µ"
                document.getElementById('all-photos-tab').click();
                
                photosContent.style.display = 'block';
                setupPhotoSelection();
                setupPhotoZoom();
            } else {
                photosError.innerHTML = '<i class="bi bi-exclamation-triangle"></i> –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                photosError.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            photosLoading.style.display = 'none';
            photosError.style.display = 'block';
        });
    }
    
    function createPhotoCard(photo) {
        const photoCard = document.createElement('div');
        photoCard.className = 'col-md-4 col-sm-6';
        photoCard.innerHTML = `
            <div class="card h-100">
                <div class="card-img-top-container" style="height: 200px; overflow: hidden; cursor: pointer; position: relative;">
                    <img src="${photo.thumbnail_url}" class="card-img-top photo-preview" style="width: 100%; height: 100%; object-fit: cover;" alt="${photo.description}" data-full-url="${photo.url}" loading="lazy">
                    <div class="photo-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); transition: all 0.3s; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-zoom-in" style="color: white; font-size: 2rem; opacity: 0; transition: opacity 0.3s;"></i>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="form-check">
                        <input class="form-check-input photo-checkbox" type="checkbox" value="${photo.id}" id="photo_${photo.id}_${Math.random().toString(36).substr(2, 9)}">
                        <label class="form-check-label">
                            <small class="text-muted">${photo.photo_type}</small>
                        </label>
                    </div>
                    <small class="text-muted d-block">${photo.uploaded_at}</small>
                </div>
            </div>
        `;
        return photoCard;
    }
    
    function setupPhotoSelection() {
        const selectAllCheckbox = document.getElementById('selectAllPhotos');
        const downloadBtn = document.getElementById('downloadSelectedBtn');
        const photosContent = document.getElementById('photos-content');
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        const newSelectAll = selectAllCheckbox.cloneNode(true);
        selectAllCheckbox.parentNode.replaceChild(newSelectAll, selectAllCheckbox);
        
        const newDownloadBtn = downloadBtn.cloneNode(true);
        downloadBtn.parentNode.replaceChild(newDownloadBtn, downloadBtn);
        
        // –ü–æ–ª—É—á–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        function getActiveTabCheckboxes() {
            const activePane = document.querySelector('#photosTabContent .tab-pane.active');
            return activePane ? Array.from(activePane.querySelectorAll('.photo-checkbox')) : [];
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ)
        function getSelectedPhotoIds() {
            const checkboxes = getActiveTabCheckboxes();
            const ids = new Set();
            checkboxes.forEach(cb => {
                if (cb.checked) ids.add(cb.value);
            });
            return Array.from(ids);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        function updateDownloadButton() {
            const count = getSelectedPhotoIds().length;
            newDownloadBtn.disabled = count === 0;
            newDownloadBtn.innerHTML = `<i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ${count > 0 ? ' (' + count + ')' : ''}`;
        }
        
        // "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        newSelectAll.addEventListener('change', function() {
            const checkboxes = getActiveTabCheckboxes();
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateDownloadButton();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ —á–µ–∫–±–æ–∫—Å—ã (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
        photosContent.addEventListener('change', function(e) {
            if (e.target.classList.contains('photo-checkbox')) {
                updateDownloadButton();
                
                const checkboxes = getActiveTabCheckboxes();
                const checkedCount = checkboxes.filter(cb => cb.checked).length;
                const totalCount = checkboxes.length;
                
                newSelectAll.checked = checkedCount === totalCount && totalCount > 0;
                newSelectAll.indeterminate = checkedCount > 0 && checkedCount < totalCount;
            }
        });
        
        // –°–±—Ä–æ—Å –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('#photosTabs button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function() {
                newSelectAll.checked = false;
                newSelectAll.indeterminate = false;
                updateDownloadButton();
            });
        });
        
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
        newDownloadBtn.addEventListener('click', function() {
            const photoIds = getSelectedPhotoIds();
            if (photoIds.length > 0) {
                downloadPhotosArchive(photoIds);
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateDownloadButton();
    }
    
    function downloadPhotosArchive(photoIds) {
        fetch('/api/download-photos-archive/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                photo_ids: photoIds
            })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞');
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `container_photos_${currentContainerNumber}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞');
        });
    }
    
    let currentPhotoIndex = 0;
    let currentTabPhotosUrls = [];
    
    function setupPhotoZoom() {
        // –ü–æ–ª—É—á–∞–µ–º URL —Ñ–æ—Ç–æ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        function getActiveTabPhotos() {
            const activePane = document.querySelector('#photosTabContent .tab-pane.active');
            if (!activePane) return [];
            
            const images = activePane.querySelectorAll('.photo-preview');
            return Array.from(images).map(img => img.getAttribute('data-full-url'));
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ñ–æ—Ç–æ –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
        function getPhotoIndexInActiveTab(container) {
            const activePane = document.querySelector('#photosTabContent .tab-pane.active');
            if (!activePane) return 0;
            
            const containers = Array.from(activePane.querySelectorAll('.card-img-top-container'));
            return containers.indexOf(container);
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
        const allContainers = document.querySelectorAll('.card-img-top-container');
        
        allContainers.forEach((container) => {
            const overlay = container.querySelector('.photo-overlay');
            const icon = overlay.querySelector('i');
            
            container.addEventListener('mouseenter', function() {
                overlay.style.background = 'rgba(0,0,0,0.5)';
                icon.style.opacity = '1';
            });
            
            container.addEventListener('mouseleave', function() {
                overlay.style.background = 'rgba(0,0,0,0)';
                icon.style.opacity = '0';
            });
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ç–æ –ø–æ –∫–ª–∏–∫—É
            container.addEventListener('click', function() {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
                currentTabPhotosUrls = getActiveTabPhotos();
                currentPhotoIndex = getPhotoIndexInActiveTab(container);
                
                if (currentPhotoIndex >= 0 && currentTabPhotosUrls.length > 0) {
                    openPhotoViewer(currentTabPhotosUrls[currentPhotoIndex]);
                }
            });
        });
    }
    
    function openPhotoViewer(imageUrl) {
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        const viewer = document.createElement('div');
        viewer.id = 'photo-viewer';
        viewer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        viewer.innerHTML = `
            <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                <div id="image-container" style="width: 90%; height: 90%; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: grab;">
                    <img id="viewer-image" src="${imageUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">
                </div>
                
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                ${currentPhotoIndex > 0 ? `
                <button id="prev-photo" class="nav-btn" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.35); border: none; color: rgba(0,0,0,0.7); padding: 12px 16px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; z-index: 10000; transition: opacity 0.3s ease, background 0.2s ease;">
                    <i class="bi bi-chevron-left"></i>
                </button>
                ` : ''}
                
                ${currentPhotoIndex < currentTabPhotosUrls.length - 1 ? `
                <button id="next-photo" class="nav-btn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.35); border: none; color: rgba(0,0,0,0.7); padding: 12px 16px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; z-index: 10000; transition: opacity 0.3s ease, background 0.2s ease;">
                    <i class="bi bi-chevron-right"></i>
                </button>
                ` : ''}
                
                <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
                <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px; color: white; z-index: 10000;">
                    <span>${currentPhotoIndex + 1} / ${currentTabPhotosUrls.length}</span>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10000;">
                    <button id="zoom-in" style="background: rgba(255,255,255,0.9); border: none; color: black; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button id="zoom-out" style="background: rgba(255,255,255,0.9); border: none; color: black; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button id="zoom-reset" style="background: rgba(255,255,255,0.9); border: none; color: black; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="bi bi-arrows-angle-contract"></i>
                    </button>
                    <button id="download-single" style="background: var(--accent-green); border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="bi bi-download"></i>
                    </button>
                    <button id="close-viewer" style="background: var(--accent-red); border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(viewer);
        document.body.style.overflow = 'hidden';
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑—É–º–∞ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX, startY;
        
        const img = document.getElementById('viewer-image');
        const container = document.getElementById('image-container');
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateTransform(withTransition = false) {
            if (withTransition) {
                img.style.transition = 'transform 0.3s ease';
            } else {
                img.style.transition = 'none';
            }
            img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            container.style.cursor = scale > 1 ? 'grab' : 'default';
            
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∑—É–º–µ
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.style.opacity = scale > 1 ? '0' : '1';
                btn.style.pointerEvents = scale > 1 ? 'none' : 'auto';
            });
        }
        
        // –ó—É–º –∫–Ω–æ–ø–∫–∞–º–∏ (—Å –ø–ª–∞–≤–Ω–æ—Å—Ç—å—é)
        document.getElementById('zoom-in')?.addEventListener('click', function(e) {
            e.stopPropagation();
            scale = Math.min(scale + 0.5, 5);
            updateTransform(true);
        });
        
        document.getElementById('zoom-out')?.addEventListener('click', function(e) {
            e.stopPropagation();
            scale = Math.max(scale - 0.5, 1);
            if (scale === 1) {
                translateX = 0;
                translateY = 0;
            }
            updateTransform(true);
        });
        
        document.getElementById('zoom-reset')?.addEventListener('click', function(e) {
            e.stopPropagation();
            scale = 1;
            translateX = 0;
            translateY = 0;
            updateTransform(true);
        });
        
        // –ó—É–º –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏ (—Å –ø–ª–∞–≤–Ω–æ—Å—Ç—å—é)
        container.addEventListener('wheel', function(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.min(Math.max(scale + delta, 1), 5);
            if (scale === 1) {
                translateX = 0;
                translateY = 0;
            }
            updateTransform(true);
        });
        
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –∑—É–º–µ
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º document –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è mousemove –∏ mouseup
        // —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –º—ã—à–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        
        container.addEventListener('mousedown', function(e) {
            if (scale > 1) {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                isDragging = true;
                container.style.cursor = 'grabbing';
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
            }
        });
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –≤—Å—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–µ
        function handleMouseMove(e) {
            if (isDragging) {
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform(false);
            }
        }
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –º—ã—à–∏ –Ω–∞ –≤—Å—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–µ
        function handleMouseUp() {
            if (isDragging) {
                isDragging = false;
                if (scale > 1) {
                    container.style.cursor = 'grab';
                }
            }
        }
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        viewer._dragHandlers = { move: handleMouseMove, up: handleMouseUp };
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ñ–æ—Ç–æ
        document.getElementById('prev-photo')?.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updateViewerImage();
            }
        });
        
        document.getElementById('next-photo')?.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentPhotoIndex < currentTabPhotosUrls.length - 1) {
                currentPhotoIndex++;
                updateViewerImage();
            }
        });
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        function handlePhotoNavigation(e) {
            if (e.key === 'ArrowLeft' && currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updateViewerImage();
            } else if (e.key === 'ArrowRight' && currentPhotoIndex < currentTabPhotosUrls.length - 1) {
                currentPhotoIndex++;
                updateViewerImage();
            }
        }
        document.addEventListener('keydown', handlePhotoNavigation);
        
        function updateViewerImage() {
            scale = 1;
            translateX = 0;
            translateY = 0;
            closePhotoViewer();
            openPhotoViewer(currentTabPhotosUrls[currentPhotoIndex]);
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
        document.getElementById('close-viewer').addEventListener('click', function(e) {
            e.stopPropagation();
            closePhotoViewer();
        });
        
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ
        document.getElementById('download-single').addEventListener('click', function(e) {
            e.stopPropagation();
            const link = document.createElement('a');
            link.href = currentTabPhotosUrls[currentPhotoIndex];
            link.download = currentTabPhotosUrls[currentPhotoIndex].split('/').pop();
            link.click();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
        document.addEventListener('keydown', handleEscKey);
    }
    
    function handleEscKey(e) {
        if (e.key === 'Escape') {
            closePhotoViewer();
        }
    }
    
    function closePhotoViewer() {
        const viewer = document.getElementById('photo-viewer');
        if (viewer) {
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            if (viewer._dragHandlers) {
                document.removeEventListener('mousemove', viewer._dragHandlers.move);
                document.removeEventListener('mouseup', viewer._dragHandlers.up);
            }
            viewer.remove();
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleEscKey);
        }
    }
});
</script>
{% endblock %}

