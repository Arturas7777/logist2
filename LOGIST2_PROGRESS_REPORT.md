# Отчёт о проделанной работе по проекту Logist2

**Дата последнего обновления:** 17 января 2026 г.

---

## Общее описание задач из промта

Основная задача - доработка системы управления контейнерами и ТС:
1. Расширение типов ТС с 2 до 11
2. Пропорциональное распределение THS по типам ТС
3. Возможность указать плательщика THS (линия или склад)
4. Синхронизация данных между контейнером и карточками ТС

---

## ВЫПОЛНЕННАЯ РАБОТА

### 1. Расширение типов транспортных средств

**Статус:** Завершено

**Файл:** `core/models.py` - модель `Car`

Было 2 типа (CAR, MOTO), стало 11:
- SEDAN (Легковой), CROSSOVER (Кроссовер), SUV (Джип), PICKUP (Пикап)
- NEW_CAR (Новая машина), MOTO (Мотоцикл), BIG_MOTO (Большой мотоцикл)
- ATV (Квадроцикл/Багги), BOAT (Лодка), RV (Автодом), CONSTRUCTION (Стр. техника)

**Миграция:** `0089_expand_vehicle_types_and_ths_system.py`
- Расширен `max_length` поля с 10 до 20
- Записи с `CAR` конвертированы в `SEDAN`

---

### 2. Система коэффициентов THS по типам ТС (обновлено 16.01.2026)

**Статус:** Завершено

**Модель `LineTHSCoefficient`** в `core/models.py` (ранее LineTHSPercent):
- Связана с линией через ForeignKey
- Хранит коэффициент (вес) для каждого типа ТС
- unique_together: line + vehicle_type
- По умолчанию коэффициент = 1.0

**Миграция:** `0093_rename_ths_percent_to_coefficient.py`
- Переименована модель LineTHSPercent → LineTHSCoefficient
- Переименовано поле percent → coefficient
- Данные конвертированы: коэффициент = процент / 25

**Админка:** `LineTHSCoefficientInline` в `LineAdmin`

**Логика распределения THS:**
- Сумма THS контейнера распределяется пропорционально коэффициентам
- Формула: THS_авто = общий_THS × (коэффициент_авто / сумма_всех_коэффициентов)
- Результат округляется вверх до 5 EUR

**Рекомендуемые коэффициенты:**
| Тип ТС | Коэффициент |
|--------|-------------|
| Легковой | 1.0 |
| Кроссовер | 1.2 |
| Джип/Пикап | 1.5 |
| Мотоцикл | 0.3 |
| Большой мотоцикл | 0.5 |
| Лодка | 2.0 |
| Автодом (RV) | 3.0 |
| Стр. техника | 2.5 |

---

### 3. Поле "Оплата THS через" в контейнере

**Статус:** Завершено

**Поле `ths_payer`** в модели `Container`:
- LINE = услуга THS как service_type='LINE'
- WAREHOUSE = услуга THS как service_type='WAREHOUSE'

**Миграция:** `0090_update_ths_payer_labels.py`

---

### 4. Округление THS до 5 EUR

**Статус:** Завершено

Функция `round_up_to_5()` в `core/signals.py`
Пример: 73.12 EUR -> 75 EUR

---

### 5. Функция создания THS услуг

**Статус:** Завершено

Функция `create_ths_services_for_container()` в `core/signals.py`:
- Рассчитывает пропорциональный THS
- Удаляет старые THS-услуги
- Создаёт новые с правильным service_type
- Применяет округление

Вызывается из `ContainerAdmin.save_model()` и `save_formset()`

---

### 6. Упрощение системы цен (16.01.2026)

**Статус:** Завершено

**Изменения:**
- Удалено поле `current_price` из модели `Car`
- Оставлено только поле `total_price` (переименовано в "Цена")
- Цена динамически пересчитывается до статуса "Передан"
- После передачи цена фиксируется

**Миграция:** `0092_remove_current_price.py`

---

### 7. Динамический расчёт услуги "Хранение" (16.01.2026)

**Статус:** Завершено

**Проблема:** Услуга "Хранение" добавлялась с фиксированной ценой 5 EUR, даже когда платных дней ещё не было.

**Решение:**
- Удалено поле `rate` из модели `Warehouse`
- Ставка за день теперь берётся из услуги "Хранение" в списке услуг склада (`WarehouseService.default_price`)
- Цена услуги "Хранение" = платные_дни × ставка_за_день
- Если платных дней нет - цена = 0

**Миграция:** `0091_remove_warehouse_rate.py`

**Изменённые методы в `Car`:**
- `update_days_and_storage()` - обновляет дни и вызывает пересчёт цены хранения
- `_get_storage_daily_rate()` - получает ставку из услуги "Хранение"
- `_update_storage_service_price()` - обновляет цену в CarService

---

### 8. Улучшение сводки по услугам (16.01.2026)

**Статус:** Завершено

**Изменения в `services_summary_display`:**
- THS отображается отдельно (вне зависимости от плательщика)
- Услуги склада показываются с детализацией (каждая услуга отдельно)
- Показываются бесплатные и платные дни
- Отображается наценка Caromoto Lithuania

---

### 9. Пересоздание THS при смене склада (16.01.2026)

**Статус:** Завершено

**Проблема:** При изменении склада в контейнере с `ths_payer='WAREHOUSE'` услуга THS не обновлялась.

**Решение:** Добавлено `'warehouse'` в список отслеживаемых полей в `ContainerAdmin.save_model()`

---

### 10. Кнопка "Пересчитать THS" в карточке линии (16.01.2026)

**Статус:** Завершено

**Функционал:**
- В карточке линии появилась кнопка "↻ Пересчитать THS"
- При нажатии пересчитываются THS-услуги для всех машин этой линии со статусом "Разгружен" или "В пути"
- После пересчёта THS обновляются итоговые цены машин

**Файлы:**
- `templates/admin/line_change.html` - шаблон с кнопкой
- `core/admin.py` - метод `recalculate_ths_view()` в `LineAdmin`

**Использование:**
1. Изменить коэффициенты THS в карточке линии
2. Сохранить линию
3. Нажать кнопку "Пересчитать THS"
4. Дождаться сообщения "Пересчитано: X контейнеров, Y машин"

---

### 11. Исправление кэширования при расчёте цены (16.01.2026)

**Статус:** Завершено

**Проблема:** После пересчёта THS-услуг цена машины не обновлялась из-за кэша `_prefetched_objects_cache`.

**Решение:** В методе `calculate_total_price()` добавлен сброс кэша перед расчётом:
```python
if hasattr(self, '_prefetched_objects_cache'):
    self._prefetched_objects_cache.pop('car_services', None)
```

---

### 12. Система скрытой наценки (17.01.2026)

**Статус:** Завершено

**Цель:** Возможность скрыто распределить наценку (прибыль) по услугам, чтобы она не отображалась отдельной строкой в инвойсе.

**Новое поле `markup_amount`** в модели `CarService`:
- Скрытая наценка для каждой услуги
- Добавляется к цене услуги в инвойсе
- Не видна клиенту как отдельная строка

**Новое поле `default_markup`** в моделях услуг:
- `WarehouseService.default_markup` - наценка по умолчанию для услуг склада
- `LineService.default_markup` - наценка по умолчанию для услуг линии
- `CarrierService.default_markup` - наценка по умолчанию для услуг перевозчика
- При создании CarService наценка копируется из default_markup

**Миграции:**
- `0094_add_hide_markup_in_field.py`
- `0095_add_markup_distribution.py`
- `0096_add_default_markup_to_services.py`

**Интерфейс в карточке авто:**
- Рядом с каждой услугой появилось жёлтое поле для ввода наценки
- Наценка редактируется напрямую в блоках услуг (склад, линия, перевозчик)
- Сводка показывает общую сумму наценки

**Логика цен:**
- `final_price` = базовая цена услуги (без наценки) — для внутреннего учёта
- `invoice_price` = базовая цена + наценка — для инвойса клиенту
- `total_price` авто = сумма всех услуг + сумма всех наценок

**Особенности для услуги "Хранение":**
- Наценка умножается на количество платных дней (как и цена)
- При `default_markup=1` и 7 платных дней → наценка = 7 EUR

**Сводка по услугам (services_summary_display):**
- Услуги линий показываются с детализацией (включая THS даже если оплата через склад)
- Услуги склада показываются с детализацией (без THS)
- Перевозчик отдельно
- Скрытая наценка отдельным блоком

**Инвойс:**
- Наценка НЕ отображается отдельной строкой
- Наценка добавляется к ценам услуг (только для Company)

---

## РЕШЁННЫЕ ПРОБЛЕМЫ

| # | Проблема | Причина | Решение |
|---|----------|---------|---------|
| 1 | THS не рассчитывался по процентам | Старый код в сигнале перезаписывал логику | Отключена секция "УСЛУГИ ЛИНИИ" в create_car_services_on_car_save |
| 2 | THS записывался как LINE вместо WAREHOUSE | Старая логика игнорировала ths_payer | Логика перенесена в create_ths_services_for_container() |
| 3 | THS не создавался при новом контейнере | Функция вызывалась только при change=True | Добавлен вызов в save_formset() после сохранения ТС |
| 4 | Все услуги линии добавлялись при сохранении ТС | Сигнал update_cars_on_line_service_change | Отключена автоматическая логика добавления |
| 5 | Цена на 5 EUR больше при 0 платных дней | Услуга "Хранение" создавалась с фиксированной ценой | Цена рассчитывается динамически: дни × ставка |
| 6 | Фильтр `icontains` не находил "Хранение" | Проблемы с кодировкой в PostgreSQL | Используется точное совпадение `name='Хранение'` |
| 7 | Цена в списке авто отличалась от карточки | Prefetch кэш не обновлялся | Расчёт напрямую из БД в `total_price_display` |
| 8 | THS не обновлялся при смене склада | Поле warehouse не отслеживалось | Добавлено в список ths_related_changed |
| 9 | Проценты THS неинтуитивны | Трудно понять пропорции | Заменены на коэффициенты (1.0 = стандарт) |
| 10 | Нет способа пересчитать THS для существующих ТС | Пересчёт только при изменении контейнера | Кнопка "Пересчитать THS" в карточке линии |
| 11 | Цена не обновлялась после пересчёта THS | Кэш car_services не сбрасывался | Сброс кэша в calculate_total_price() |
| 12 | Кнопка пересчёта отправляла основную форму | Form внутри form | Заменена на ссылку (тег `<a>`) |
| 13 | Наценка видна клиенту в инвойсе | Отдельная строка "Наценка Caromoto" | Наценка распределяется по услугам скрыто |
| 14 | Нельзя редактировать наценку по услугам | Только общее поле proft | Жёлтые поля наценки в каждой услуге |
| 15 | Услуги линий не учитывались в сводке | custom_price=None считалось как 0 | Используется final_price с проверкой `is not None` |
| 16 | THS через склад не показывался в услугах линий | Фильтр по service_type='LINE' | THS учитывается по имени, независимо от service_type |
| 17 | +5 EUR при 0 платных дней | custom_price=0 → False → default_price=5 | Проверка `custom_price is not None` |

---

## НЕВЫПОЛНЕННАЯ РАБОТА (согласно промту)

1. **Обратная синхронизация статуса** - не проверено
2. **Учёт прибыли** - требует уточнения
3. **Обязательность полей при статусе "Разгружен"** - не проверено

---

## ИЗМЕНЁННЫЕ ФАЙЛЫ

### Модели (`core/models.py`)
- Типы ТС расширены до 11
- Модель `LineTHSCoefficient` для коэффициентов THS (ранее LineTHSPercent)
- Поле `ths_payer` в `Container`
- Удалено поле `rate` из `Warehouse`
- Удалено поле `current_price` из `Car`
- Методы расчёта хранения: `update_days_and_storage()`, `_get_storage_daily_rate()`, `_update_storage_service_price()`
- Сброс кэша в `calculate_total_price()`
- **Новое:** `CarService.markup_amount` - скрытая наценка для услуги
- **Новое:** `CarService.final_price` - цена без наценки (с проверкой `is not None`)
- **Новое:** `CarService.invoice_price` - цена с наценкой для инвойса
- **Новое:** `WarehouseService.default_markup`, `LineService.default_markup`, `CarrierService.default_markup`
- **Новое:** `calculate_total_price()` учитывает markup_amount

### Админка (`core/admin.py`)
- `LineTHSCoefficientInline` в LineAdmin (с полем coefficient вместо percent)
- `LineAdmin.recalculate_ths_view()` - кнопка пересчёта THS
- `LineAdmin.get_urls()` - кастомный URL для пересчёта
- `ContainerAdmin.save_model()` - вызов THS при изменении line/ths/ths_payer/warehouse
- `ContainerAdmin.save_formset()` - вызов THS после сохранения ТС
- `WarehouseAdmin` - удалено поле rate
- `CarAdmin.services_summary_display()` - улучшенная сводка
- `CarAdmin.total_price_display()` - динамический расчёт цены
- **Новое:** Жёлтые поля для ввода наценки рядом с каждой услугой
- **Новое:** `save_model()` сохраняет markup_amount для услуг
- **Новое:** Сводка показывает услуги линий с детализацией (включая THS через склад)
- **Новое:** Сводка показывает общую сумму скрытой наценки

### Сигналы (`core/signals.py`)
- `calculate_ths_for_container()` - расчёт THS по коэффициентам
- `create_ths_services_for_container()` - создание услуг THS
- `round_up_to_5()` - округление до 5 EUR
- Изменён фильтр "Хранение" на точное совпадение
- **Новое:** Копирование `default_markup` при создании CarService
- **Новое:** Умножение наценки на дни для услуги "Хранение"

### Биллинг (`core/models_billing.py`)
- **Новое:** Наценка НЕ создаётся отдельной строкой в инвойсе
- **Новое:** `invoice_price` используется для цены услуги (с наценкой)

### Вьюхи (`core/views.py`)
- **Новое:** `add_services()` копирует `default_price` и `default_markup` при добавлении услуги

### Шаблоны
- `templates/admin/line_change.html` - кнопка "Пересчитать THS"

### Миграции
- `0089_expand_vehicle_types_and_ths_system.py`
- `0090_update_ths_payer_labels.py`
- `0091_remove_warehouse_rate.py`
- `0092_remove_current_price.py`
- `0093_rename_ths_percent_to_coefficient.py` - переход на коэффициенты
- `0094_add_hide_markup_in_field.py` - поле для скрытия наценки
- `0095_add_markup_distribution.py` - поле markup_amount в CarService
- `0096_add_default_markup_to_services.py` - поле default_markup в услугах

---

## ПРИМЕЧАНИЯ

1. Коэффициенты THS по умолчанию = 1.0 (настраиваются в карточке линии)
2. Для пересчёта существующих машин - используйте кнопку "Пересчитать THS" в карточке линии
3. Ставка хранения берётся из услуги "Хранение" в списке услуг склада
4. При добавлении нового склада нужно создать услугу "Хранение" с нужной ставкой за день
5. Тестовые контейнеры можно удалить после проверки

---

## ИСТОРИЯ ИЗМЕНЕНИЙ

| Дата | Описание |
|------|----------|
| 14.01.2026 | Первоначальная реализация THS системы |
| 16.01.2026 (день) | Упрощение цен, динамический расчёт хранения, исправление отображения |
| 16.01.2026 (вечер) | Замена процентов на коэффициенты, кнопка "Пересчитать THS", исправление кэша |
| 17.01.2026 | Система скрытой наценки: markup_amount, default_markup, распределение по услугам |
