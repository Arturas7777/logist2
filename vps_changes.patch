diff --git a/.gitignore b/.gitignore
index a7115d9..56ac554 100644
--- a/.gitignore
+++ b/.gitignore
@@ -22,7 +22,7 @@ staticfiles/
 static_root/
 
 # Media files (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
-# media/
+media/
 
 # Env
 .env
@@ -65,3 +65,4 @@ htmlcov/
 node_modules/
 npm-debug.log
 yarn-error.log
+container_photos/
diff --git a/AI_PROJECT_CONTEXT.md b/AI_PROJECT_CONTEXT.md
index 4addb0d..17e1c0e 100644
--- a/AI_PROJECT_CONTEXT.md
+++ b/AI_PROJECT_CONTEXT.md
@@ -1,883 +1,953 @@
-# –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê LOGIST2 –î–õ–Ø AI
-
-## –û –ü–†–û–ï–ö–¢–ï
-
-**–ù–∞–∑–≤–∞–Ω–∏–µ:** Logist2 (Caromoto Lithuania)
-**–¢–∏–ø:** Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
-**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –¢–°, –∫–ª–∏–µ–Ω—Ç–∞–º–∏, —Å–∫–ª–∞–¥–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏
-
-### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
-- **Backend:** Django 5.1.7 + Python 3.10-3.12
-- **Database:** PostgreSQL (—Ç–µ—Å—Ç—ã ‚Äî SQLite —á–µ—Ä–µ–∑ `settings_test.py`)
-- **API:** Django REST Framework
-- **Frontend:** Django templates + Bootstrap 5 + HTMX + –∫–∞—Å—Ç–æ–º–Ω—ã–π JS
-- **WebSockets:** Channels + Daphne (Redis –≤ `settings_base.py`, InMemory –≤ `settings.py`)
-- **Web Server:** Nginx + Gunicorn, —Å—Ç–∞—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ WhiteNoise
-- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç:** Django templates + REST API
-
-### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
-- **CRM —Å–∏—Å—Ç–µ–º–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –±–∞–ª–∞–Ω—Å–∞–º–∏
-- **–õ–æ–≥–∏—Å—Ç–∏–∫–∞** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –¢–°, —Å–∫–ª–∞–¥—ã, –ª–∏–Ω–∏–∏, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏
-- **–ë–∏–ª–ª–∏–Ω–≥** - –∏–Ω–≤–æ–π—Å—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã
-- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–æ–≤, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
-- **Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-- **–°–∏—Å—Ç–µ–º–∞ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π** - —É—Å–ª—É–≥–∏ Company (Caromoto Lithuania) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø
-- **AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç** - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ + RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –∫–æ–¥—É/–¥–æ–∫–∞–º
-
-## VPS –°–ï–†–í–ï–†
-
-**IP:** 176.118.198.78
-**SSH:** `root@176.118.198.78`
-**–î–æ–º–µ–Ω:** https://caromoto-lt.com
-
-> ‚ö†Ô∏è **–ü–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `CREDENTIALS.md` (–Ω–µ –≤ git)
-
-### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
-```
-–ü—Ä–æ–µ–∫—Ç: /var/www/www-root/data/www/logist2
-Virtualenv: /var/www/www-root/data/www/logist2/.venv
-Media: /var/www/www-root/data/www/logist2/media
-Static: /var/www/www-root/data/www/logist2/staticfiles
-```
-
-### –°–µ—Ä–≤–∏—Å—ã
-```bash
-# Gunicorn (Django application)
-systemctl restart gunicorn
-systemctl status gunicorn
-
-# Daphne (WebSockets)
-systemctl restart daphne
-systemctl status daphne
-
-# Nginx
-systemctl reload nginx
-nginx -t
-```
-
-### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
-```
-–§–∞–π–ª: /etc/nginx/vhosts/www-root/176.118.198.78.conf
-
-location /media/ {
-    alias /var/www/www-root/data/www/logist2/media/;
-}
-
-location /static/ {
-    alias /var/www/www-root/data/www/logist2/staticfiles/;
-}
-```
-
-## –î–ï–ü–õ–û–ô
-
-### –°–ø–æ—Å–æ–± 1: PowerShell —Å–∫—Ä–∏–ø—Ç (—Å Windows)
-```powershell
-.\deploy.ps1
-```
-
-### –°–ø–æ—Å–æ–± 2: Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
-```bash
-ssh root@176.118.198.78
-cd /var/www/www-root/data/www/logist2
-git pull origin master
-source .venv/bin/activate
-python manage.py migrate
-python manage.py collectstatic --noinput
-systemctl restart gunicorn
-systemctl restart daphne
-```
-
-### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç deploy.ps1:
-1. –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SCP: `core/*`, `logist2/*`, `templates/*`
-2. –ó–∞–ø—É—Å–∫–∞–µ—Ç collectstatic
-3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç gunicorn –∏ daphne
-
-### ‚ö†Ô∏è –í–ê–ñ–ù–û: –ß—Ç–æ –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ:
-- `.env` —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–∞—Ä–æ–ª–∏ –ë–î) ‚Äî **–±–µ–∑–æ–ø–∞—Å–µ–Ω**
-- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω–∞**
-- Media —Ñ–∞–π–ª—ã (—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏) ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω—ã**
-- Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω–∞**
-
-## –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê
-
-```
-logist2/
-‚îú‚îÄ‚îÄ core/                           # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
-‚îÇ   ‚îú‚îÄ‚îÄ models.py                   # –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Container, Car, Client, etc)
-‚îÇ   ‚îú‚îÄ‚îÄ models_website.py           # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
-‚îÇ   ‚îú‚îÄ‚îÄ models_billing.py           # –ë–∏–ª–ª–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–∞
-‚îÇ   ‚îú‚îÄ‚îÄ admin.py                    # Django Admin –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
-‚îÇ   ‚îú‚îÄ‚îÄ admin_website.py            # Admin –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
-‚îÇ   ‚îú‚îÄ‚îÄ views.py                    # Views –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
-‚îÇ   ‚îú‚îÄ‚îÄ views_website.py            # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
-‚îÇ   ‚îú‚îÄ‚îÄ google_drive_sync.py        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive
-‚îÇ   ‚îú‚îÄ‚îÄ management/commands/        # Management –∫–æ–º–∞–Ω–¥—ã
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ add_performance_indexes.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apply_optimizations.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check_photo_environment.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cleanup_broken_photos.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_default_company.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fix_photo_names.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fix_ths_line_services.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate_thumbnails.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init_new_balance_system.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate_services.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recalculate_car_services.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recalculate_storage.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ regenerate_thumbnails.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reset_billing.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_client_balances.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_google_drive_photos.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_photos_gdrive.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rebuild_ai_index.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rebuild_ai_index_if_stale.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_invoice_markup.py
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_unload_date_inheritance.py
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update_container_statuses.py
-‚îÇ   ‚îú‚îÄ‚îÄ services/                   # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_chat_service.py      # AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î)
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_ai_agent.py       # AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ai_rag.py               # RAG –∏–Ω–¥–µ–∫—Å –∏ –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–∫–æ–¥—É
-‚îÇ   ‚îú‚îÄ‚îÄ static/                     # –°—Ç–∞—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
-‚îÇ   ‚îî‚îÄ‚îÄ templates/                  # –®–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏
-‚îú‚îÄ‚îÄ templates/                      # –û–±—â–∏–µ —à–∞–±–ª–æ–Ω—ã
-‚îÇ   ‚îú‚îÄ‚îÄ admin/                      # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–¥–º–∏–Ω —à–∞–±–ª–æ–Ω—ã
-‚îÇ   ‚îî‚îÄ‚îÄ website/                    # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç
-‚îú‚îÄ‚îÄ media/                          # –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
-‚îÇ   ‚îú‚îÄ‚îÄ container_photos/           # –§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ thumbnails/             # –ú–∏–Ω–∏–∞—Ç—é—Ä—ã
-‚îÇ   ‚îú‚îÄ‚îÄ container_archives/         # ZIP –∞—Ä—Ö–∏–≤—ã
-‚îÇ   ‚îî‚îÄ‚îÄ car_photos/                 # –§–æ—Ç–æ –¢–°
-‚îú‚îÄ‚îÄ logist2/                        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
-‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (InMemory Channels)
-‚îÇ   ‚îú‚îÄ‚îÄ settings_base.py            # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Redis Channels)
-‚îÇ   ‚îú‚îÄ‚îÄ settings_dev.py             # Dev-–ø—Ä–æ—Ñ–∏–ª—å
-‚îÇ   ‚îú‚îÄ‚îÄ settings_prod.py            # Prod-–ø—Ä–æ—Ñ–∏–ª—å
-‚îÇ   ‚îú‚îÄ‚îÄ settings_test.py            # Test-–ø—Ä–æ—Ñ–∏–ª—å (SQLite)
-‚îÇ   ‚îú‚îÄ‚îÄ urls.py                     # URL routing
-‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py / asgi.py           # WSGI/ASGI
-‚îú‚îÄ‚îÄ requirements.txt                # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
-‚îî‚îÄ‚îÄ requirements_website.txt        # –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-```
-
-## –ö–õ–Æ–ß–ï–í–´–ï –ú–û–î–ï–õ–ò
-
-### Container (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä)
-- `number` - –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
-- `status` - —Å—Ç–∞—Ç—É—Å (FLOATING, IN_PORT, UNLOADED, TRANSFERRED)
-- `line`, `warehouse`, `client` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏
-- `ths`, `ths_payer` - —Å—É–º–º–∞ THS –∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ (LINE/WAREHOUSE)
-- `planned_unload_date`, `unload_date`, `eta`, `unloaded_status_at` - –∫–ª—é—á–µ–≤—ã–µ –¥–∞—Ç—ã
-- `customs_procedure`, `sklad`, `dekl`, `proft` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ/legacy –ø–æ–ª—è
-- `google_drive_folder_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –≤ Google Drive
-- `container_cars` - —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¢–°
-
-### Car (–¢–°)
-- `vin` - VIN –Ω–æ–º–µ—Ä (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
-- `container` - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ —Å 20.10.2025)
-- `client` - –∫–ª–∏–µ–Ω—Ç-–≤–ª–∞–¥–µ–ª–µ—Ü
-- `warehouse`, `line`, `carrier` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏
-- `vehicle_type` - —Ç–∏–ø –¢–° (11 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
-- `status`, `unload_date`, `transfer_date` - —Å—Ç–∞—Ç—É—Å—ã –∏ –¥–∞—Ç—ã
-- `days`, `storage_cost` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç)
-- `car_services` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤/–ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
-
-### CarService (–£—Å–ª—É–≥–∞ –¢–°)
-- `car` - —Å–≤—è–∑—å —Å –¢–°
-- `service_type` - —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (WAREHOUSE, LINE, CARRIER, COMPANY)
-- `service_id` - ID —É—Å–ª—É–≥–∏ (WarehouseService, LineService, CarrierService, CompanyService)
-- `custom_price` - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π)
-- `markup_amount` - —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–æ–π—Å–µ)
-- `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥
-- **–ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç –õ–Æ–ë–´–• —Å–∫–ª–∞–¥–æ–≤ –∫ –¢–° (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)**
-
-### CompanyService (–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏)
-- `company` - —Å–≤—è–∑—å —Å Company (Caromoto Lithuania –∏ –¥—Ä.)
-- `name`, `description` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
-- `default_price`, `default_markup` - —Ü–µ–Ω–∞ –∏ –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-- `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
-- `add_by_default` - –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ —É—Å–ª—É–≥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ–≤—ã–º –¢–° –∫–æ–º–ø–∞–Ω–∏–∏
-
-**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**
-- `LineService` –∏ `CarrierService` —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —Ñ–ª–∞–≥ `add_by_default`
-
-### ContainerPhoto (–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-- `container` - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
-- `photo` - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
-- `thumbnail` - –º–∏–Ω–∏–∞—Ç—é—Ä–∞ (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
-- `is_public` - –¥–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É
-
-### AI-–ø–æ–º–æ—â–Ω–∏–∫ (—á–∞—Ç)
-- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –ë–î –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
-- –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ
-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—ã/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
-- –í–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ
-- –í –∞–¥–º–∏–Ω–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
-- –í AIChat —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `context_snapshot` (page context)
-- RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã–º —Ñ–∞–π–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞
-
-### NewInvoice (–ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å) - –û–°–ù–û–í–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ë–ò–õ–õ–ò–ù–ì–ê
-- `number` - –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
-- `issuer_*` - –∫—Ç–æ –≤—ã—Å—Ç–∞–≤–∏–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å Company, Warehouse, Line, Carrier)
-- `recipient_*` - –∫–æ–º—É –≤—ã—Å—Ç–∞–≤–ª–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å Client, Company, Warehouse, Line, Carrier)
-- `cars` - ManyToMany —Å–≤—è–∑—å —Å –¢–°
-- `items` - –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —É—Å–ª—É–≥ –¢–°)
-- **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¢–° –∏–Ω–≤–æ–π—Å –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª
-
-### InvoiceItem (–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞)
-- `invoice` - —Å–≤—è–∑—å —Å –∏–Ω–≤–æ–π—Å–æ–º
-- `car` - —Å–≤—è–∑—å —Å –¢–° (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-- `description` - –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
-- `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
-- `unit_price` - —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
-- `total_price` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è (quantity √ó unit_price)
-
-**–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –æ—Ç Caromoto Lithuania –∫–ª–∏–µ–Ω—Ç—É:**
-1. –•—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è Company): `{car.days} –¥–Ω–µ–π √ó —Å—Ç–∞–≤–∫–∞ –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"` + —Å—Ç–∞—Ç—É—Å `[–ü–µ—Ä–µ–¥–∞–Ω]` –∏–ª–∏ `[–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ]`
-2. –í—Å–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ (–æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤, –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)
-3. –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π
-4. –í—Å–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
-5. –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ü–µ–Ω—ã —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ `markup_amount` (–æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è)
-
-## API ENDPOINTS
-
-### –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –¢–°:
-- `GET /api/warehouses/` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
-- `GET /api/car/<car_id>/get_available_services/?type=warehouse&warehouse_id=<id>` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
-- `GET /api/companies/` - —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
-- `GET /api/car/<car_id>/get_available_services/?type=company&company_id=<id>` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏
-- `POST /api/car/<car_id>/add_services/` - –¥–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫ –¢–°
-- `GET /core/api/search-counterparties/` - –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
-- `GET /core/api/search-cars/` - –ø–æ–∏—Å–∫ –¢–° –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
-
-### –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞:
-- `POST /api/track/` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –ø–æ VIN –∏–ª–∏ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-- `GET /api/container-photos/<container_number>/` - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-- `POST /api/download-photos-archive/` - —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
-- `POST /api/ai-chat/` - AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î, –±–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `page_context` –∏ `X-Admin-Chat`)
-
-### –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é:
-- `/?track=<–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ
-
-## GOOGLE DRIVE –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
-
-### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ Google Drive:
-```
-–ì–ª–∞–≤–Ω–∞—è –ø–∞–ø–∫–∞: https://drive.google.com/drive/u/1/folders/1PkrfxocilDZjDaT3R1SQ9DflyWBBFNpW
-
-‚îú‚îÄ‚îÄ AUTO I≈† KONTO (–í–´–ì–†–£–ñ–ï–ù–ù–´–ï)
-‚îÇ   ‚îî‚îÄ‚îÄ [–º–µ—Å—è—Ü]/[–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞]/[—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏]
-‚îÇ
-‚îî‚îÄ‚îÄ KONTO VIDUS (–í –ö–û–ù–¢–ï–ô–ù–ï–†–ï)
-    ‚îî‚îÄ‚îÄ [–º–µ—Å—è—Ü]/[–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞]/[—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏]
-```
-
-### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞:
-1. –í –∞–¥–º–∏–Ω–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–∞–ø–∫—É Google Drive
-2. –ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É "üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive"
-3. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–≤ —Ñ–æ–Ω–µ)
-4. –ú–∏–Ω–∏–∞—Ç—é—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
-5. –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è
-
-## –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´
-
-### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
-```bash
-# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
-ssh root@176.118.198.78
-
-# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ–µ–∫—Ç
-cd /var/www/www-root/data/www/logist2
-source .venv/bin/activate
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
-python manage.py check_photo_environment
-
-# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä
-python manage.py regenerate_thumbnails
-python manage.py regenerate_thumbnails --force
-
-# –£–¥–∞–ª–µ–Ω–∏–µ –±–∏—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
-python manage.py cleanup_broken_photos
-python manage.py cleanup_broken_photos --delete
-
-# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è –∫–æ–º–∞–Ω–¥–∞)
-python manage.py sync_google_drive_photos
-
-# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —Å Google Drive (–ù–û–í–ê–Ø - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
-python manage.py sync_photos_gdrive --no-photos     # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ
-python manage.py sync_photos_gdrive --recent        # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (14 –¥–Ω–µ–π)
-python manage.py sync_photos_gdrive --container ECMU5566195  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
-python manage.py sync_photos_gdrive --verbose       # –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
-
-# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–í–ê–ñ–ù–û!)
-./fix_media_permissions.sh
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
-journalctl -u gunicorn -f
-journalctl -u daphne -f
-
-# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Python
-find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
-```
-
-### –õ–æ–∫–∞–ª—å–Ω–æ:
-```powershell
-# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
-.\START_ME.bat
-
-# –î–µ–ø–ª–æ–π –Ω–∞ VPS
-.\deploy.ps1
-
-# –ú–∏–≥—Ä–∞—Ü–∏–∏
-python manage.py makemigrations
-python manage.py migrate
-```
-
-## EMAIL –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê–ú (–î–µ–∫–∞–±—Ä—å 2025)
-
-### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
-- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã –≤ –ø–æ–ª–µ "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å"
-- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-- –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º, —á—å–∏ –¢–° –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-- –í –ø–∏—Å—å–º–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¢–° –∫–ª–∏–µ–Ω—Ç–∞ (VIN, –º–∞—Ä–∫–∞, –≥–æ–¥)
-- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—á–µ—Ä–µ–∑ NotificationLog)
-
-### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—è—Ö:
-
-**Client (core/models.py):**
-- `email` ‚Äî Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-- `notification_enabled` ‚Äî –§–ª–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
-
-**Container (core/models.py):**
-- `planned_unload_date` ‚Äî "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å" (–ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
-
-**NotificationLog (core/models_website.py):**
-- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-- –¢–∏–ø—ã: PLANNED (–ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞), UNLOADED (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞)
-- –•—Ä–∞–Ω–∏—Ç: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–ª–∏–µ–Ω—Ç, email, —Å–ø–∏—Å–æ–∫ –¢–°, —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏, –æ—à–∏–±–∫–∏
-
-### –§–∞–π–ª—ã:
-
-```
-core/services/email_service.py     # –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-core/signals.py                    # –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
-templates/email/planned_notification.html   # –®–∞–±–ª–æ–Ω –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-templates/email/unload_notification.html    # –®–∞–±–ª–æ–Ω —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-```
-
-### SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ .env) ‚Äî —á–µ—Ä–µ–∑ Brevo:
-```
-EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
-EMAIL_HOST=smtp-relay.brevo.com
-EMAIL_PORT=587
-EMAIL_USE_TLS=True
-# –ü–∞—Ä–æ–ª–∏ –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md
-```
-
-### –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∏—Å—å–º–∞—Ö (settings_base.py):
-```
-COMPANY_NAME = 'Caromoto Lithuania'
-COMPANY_PHONE = '+37068830450'
-COMPANY_EMAIL = 'lithuania@caromoto.com'
-COMPANY_WEBSITE = 'https://caromoto-lt.com'
-```
-
-### Brevo (–±—ã–≤—à–∏–π Sendinblue):
-- **–ê–∫–∫–∞—É–Ω—Ç:** Caromoto Lithuania
-- **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ:** 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å
-- **–î–æ–º–µ–Ω:** caromoto-lt.com ‚úÖ **Authenticated**
-- **DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Hostika.LT** (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–º–µ–Ω–∞):
-  - TXT: `brevo-code:6113c7d9b16365464c534b6bff2e13b6`
-  - CNAME: `brevo1._domainkey` ‚Üí `b1.caromoto-lt-com.dkim.brevo.com`
-  - CNAME: `brevo2._domainkey` ‚Üí `b2.caromoto-lt-com.dkim.brevo.com`
-  - TXT: `_dmarc` ‚Üí `v=DMARC1; p=none; rua=mailto:rua@dmarc.brevo.com`
-- **–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** https://app.brevo.com
-- **–¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:** SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–ª–∞—Ç–Ω–æ, ~0.05-0.08‚Ç¨/SMS)
-
-### –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
-- **üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
-- **üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
-
-### –°—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–µ–∫–∞–±—Ä—å 2025):
-- ‚úÖ –ü–µ—Ä–µ—à–ª–∏ –Ω–∞ Brevo (–±—ã–≤—à–∏–π Sendinblue) –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
-- ‚úÖ SMTP –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ smtp-relay.brevo.com
-- ‚úÖ DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Hostika.LT (DKIM, DMARC, Brevo code)
-- ‚úÖ –î–æ–º–µ–Ω caromoto-lt.com –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –≤ Brevo
-- ‚úÖ Gmail –∏ –¥—Ä—É–≥–∏–µ –ø–æ—á—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
-
-### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É email:
-1. –ê–¥–º–∏–Ω–∫–∞ ‚Üí –ö–ª–∏–µ–Ω—Ç—ã ‚Üí –≤—ã–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
-2. –í —Ä–∞–∑–¥–µ–ª–µ "–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" —É–∫–∞–∑–∞—Ç—å Email –∏ –≤–∫–ª—é—á–∏—Ç—å "–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
-
----
-
-## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï
-
-### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
-‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è CRM —Å–∏—Å—Ç–µ–º–∞
-‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–°
-‚úÖ –ë–∏–ª–ª–∏–Ω–≥ –∏ –±–∞–ª–∞–Ω—Å—ã
-‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª
-‚úÖ Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π)
-‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä
-‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º (—á–µ—Ä–µ–∑ Brevo SMTP)
-
-### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
-‚ö†Ô∏è SSH connection timeout –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
-‚ö†Ô∏è –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –µ—Å–ª–∏ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
-‚ö†Ô∏è –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Google Drive - –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å 1-2 –º–∏–Ω—É—Ç—ã
-‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤—Ä—É—á–Ω—É—é (—á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –æ—Ç root) –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `./fix_media_permissions.sh`
-
-### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—è–Ω–≤–∞—Ä—å 2026):
-
-**31.01.2026 - –°—Ç–æ–ª–±–µ—Ü "–ù–∞—Ü–µ–Ω–∫–∞" –≤ —Å–ø–∏—Å–∫–µ –¢–°:**
-1. **–í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ù–ê–¶–ï–ù–û–ö:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü "–ù" (–ù–∞—Ü–µ–Ω–∫–∞) –≤ —Å–ø–∏—Å–∫–µ –¢–°
-   - ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
-   - ‚úÖ –û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫ –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π (–¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¢–°)
-   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–∞—Ü–µ–Ω–∫–µ
-   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
-
-2. **–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:** ‚ö°
-   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Django `annotate()` + `Sum()` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
-   - –û–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1 (–≥–¥–µ N - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–°)
-   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 10-40 —Ä–∞–∑: 50-120ms –¥–ª—è 50-500 –¢–° (–≤–º–µ—Å—Ç–æ 500-5000ms)
-   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –¢–° –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –¥–∞–∂–µ —Å —Å–æ—Ç–Ω—è–º–∏ –∑–∞–ø–∏—Å–µ–π
-
-**–§–∞–π–ª—ã:**
-- `core/admin.py` ‚Äî –º–µ—Ç–æ–¥—ã `markup_display()`, `get_queryset()`, `changelist_view()`
-- `templates/admin/core/car/change_list.html` ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ–±—â–µ–π —Å—É–º–º—ã
-
-**21.01.2026 - –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:**
-
-1. **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° GOOGLE DRIVE:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
-   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Google Drive –ø–æ –Ω–æ–º–µ—Ä—É
-   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–ø–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
-   - ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º: IN_CONTAINER (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ) –∏ UNLOADING (–≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ)
-   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É Google Drive
-   - ‚úÖ Management –∫–æ–º–∞–Ω–¥–∞ `sync_photos_gdrive` —Å —Ä–µ–∂–∏–º–∞–º–∏: --no-photos, --recent, --container
-   - ‚úÖ Cron –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
-
-2. **–ì–ê–õ–ï–†–ï–Ø –í –ê–î–ú–ò–ù–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê:**
-   - ‚úÖ –°–≤—ë—Ä–Ω—É—Ç–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≥–∞–ª–µ—Ä–µ—è (–±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
-   - ‚úÖ AJAX –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
-   - ‚úÖ –í–∫–ª–∞–¥–∫–∏ "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ" –∏ "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
-   - ‚úÖ Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä
-   - ‚úÖ Lightbox —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
-
-3. **–ì–ê–õ–ï–†–ï–Ø –ù–ê –ö–õ–ò–ï–ù–¢–°–ö–û–ú –°–ê–ô–¢–ï:**
-   - ‚úÖ –í–∫–ª–∞–¥–∫–∏ "–í—Å–µ", "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ", "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
-   - ‚úÖ –í—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
-   - ‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" (–∑–µ–ª—ë–Ω–∞—è)
-   - ‚úÖ Lightbox —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
-   - ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (drag –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏)
-
-4. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–ò–°–ö–ê:**
-   - ‚úÖ –£–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `current_price` –∏–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
-   - ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VIN –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
-   - ‚úÖ –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é VIN
-
-5. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï URL –§–û–¢–û–ì–†–ê–§–ò–ô –ù–ê VPS:**
-   - ‚úÖ –§–æ—Ç–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏)
-   - ‚úÖ –ü—Ä–∏—á–∏–Ω–∞: API –≤–æ–∑–≤—Ä–∞—â–∞–ª URL –±–µ–∑ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞
-   - ‚úÖ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –≤ `views.py` –∏ `views_website.py`
-   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`)
-
-6. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï HOVER-–≠–§–§–ï–ö–¢–ê –ö–ù–û–ü–û–ö:**
-   - ‚úÖ –£–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
-   - ‚úÖ –ó–∞–º–µ–Ω—ë–Ω `transition: all` –Ω–∞ `transition: opacity` (—É–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É)
-   - ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π hover-—ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–æ—Å—Ç–æ–π `opacity: 0.85`
-   - ‚úÖ –§–∞–π–ª: `core/static/website/css/style.css`
-
-7. **–£–õ–£–ß–®–ï–ù–ò–ï LIGHTBOX –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í:**
-   - ‚úÖ –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å—Ç–∞–ª–∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ (35% –≤–º–µ—Å—Ç–æ 90%)
-   - ‚úÖ –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑—É–º–µ > 1, –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∑—É–º–∞
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω pinch-to-zoom (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏)
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º –ø—Ä–∏ –∑—É–º–µ
-   - ‚úÖ –§–∞–π–ª: `templates/website/home.html`
-
-**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
-- `core/google_drive_sync.py` - –∞–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–∞–ø–æ–∫, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º
-- `core/management/commands/sync_photos_gdrive.py` - –Ω–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã
-- `core/views.py` - API endpoint –¥–ª—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
-- `core/views_website.py` - —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫, API –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ñ–æ—Ç–æ
-- `core/serializers_website.py` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ current_price
-- `templates/admin/core/container/change_form.html` - –∫–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
-- `templates/admin/core/container/photos_gallery.html` - AJAX –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
-- `templates/website/home.html` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ –∏ lightbox
-- `sync_photos_cron.sh` - cron —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
-- `core/static/website/css/style.css` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω hover-—ç—Ñ—Ñ–µ–∫—Ç –∫–Ω–æ–ø–æ–∫ (—É–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ)
-
-**23.01.2026 - AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ:**
-1. **AI-–ß–ê–¢:** –ø–æ–¥–∫–ª—é—á—ë–Ω —á–∞—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ
-2. **–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–î:** VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ
-3. **–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –§–ò–ù–ê–ù–°–û–í:** –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—É/–±–∞–ª–∞–Ω—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
-4. **–ì–ê–õ–ï–†–ï–Ø –§–û–¢–û:** —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ `/?track=<–Ω–æ–º–µ—Ä>&photos=1` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ
-
-**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
-- `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI
-- `core/views_website.py` ‚Äî endpoint AI –∏ –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ç–æ/–≥–∞–ª–µ—Ä–µ–∏
-- `core/static/website/js/ai-chat.js` ‚Äî CSRF –∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
-- `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
-- `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞
-- `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
-- `env.example`, `env.local.example` ‚Äî –ø—Ä–∏–º–µ—Ä—ã AI –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
-
----
-
-### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–µ–∫–∞–±—Ä—å 2025):
-
-**13.12.2025 - Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º:**
-
-1. **–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –†–ê–ó–ì–†–£–ó–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
-   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-   - ‚úÖ –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-   - ‚úÖ –í –ø–∏—Å—å–º–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¢–° –∫–ª–∏–µ–Ω—Ç–∞ (VIN, –º–∞—Ä–∫–∞, –≥–æ–¥)
-   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ NotificationLog
-   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
-   - ‚úÖ –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
-
-2. **–ù–û–í–´–ï –ú–û–î–ï–õ–ò –ò –ü–û–õ–Ø:**
-   - `Client.email` ‚Äî email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-   - `Client.notification_enabled` ‚Äî —Ñ–ª–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-   - `Container.planned_unload_date` ‚Äî "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å"
-   - `NotificationLog` ‚Äî –∂—É—Ä–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-
-3. **SMTP –ù–ê–°–¢–†–û–ô–ö–ê (—á–µ—Ä–µ–∑ Brevo):**
-   - ~~–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä~~ ‚Üí –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ **Brevo** (–±—ã–≤—à–∏–π Sendinblue)
-   - –ü—Ä–∏—á–∏–Ω–∞: Gmail –æ—Ç–∫–ª–æ–Ω—è–ª –ø–∏—Å—å–º–∞ –±–µ–∑ PTR –∑–∞–ø–∏—Å–∏
-   - Brevo –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É (95-99%)
-   - –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å
-   - DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è DKIM/DMARC –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ISPmanager
-   - ‚è≥ –û–∂–∏–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–∞ –≤ Brevo
-
-**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
-- `core/models.py` ‚Äî –Ω–æ–≤—ã–µ –ø–æ–ª—è Client –∏ Container
-- `core/models_website.py` ‚Äî –º–æ–¥–µ–ª—å NotificationLog
-- `core/services/email_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
-- `core/signals.py` ‚Äî —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
-- `core/admin.py` ‚Äî –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π
-- `core/admin_website.py` ‚Äî –∞–¥–º–∏–Ω–∫–∞ NotificationLog
-- `logist2/settings_base.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ email
-- `templates/email/planned_notification.html` ‚Äî —à–∞–±–ª–æ–Ω (–Ω–æ–≤—ã–π)
-- `templates/email/unload_notification.html` ‚Äî —à–∞–±–ª–æ–Ω (–Ω–æ–≤—ã–π)
-
----
-
-### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ–∫—Ç—è–±—Ä—å 2025):
-
-**21.10.2025 - –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:**
-
-1. **–ù–ê–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ê–¢–´ –†–ê–ó–ì–†–£–ó–ö–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
-   - ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê:** –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤—Å–µ–º–∏ –¢–°
-   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ —Å–∏–≥–Ω–∞–ª `post_save` –¥–ª—è Container - —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –õ–Æ–ë–û–ú —Å–ø–æ—Å–æ–±–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
-   - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ —É–ª—É—á—à–µ–Ω –∫–æ–¥ –≤ `ContainerAdmin.save_model()` –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
-   - –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `if not car.unload_date:` - —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –í–°–ï –¢–° –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
-   - –£–ª—É—á—à–µ–Ω—ã –º–µ—Ç–æ–¥—ã `Container.sync_cars_after_warehouse_change()` –∏ `sync_cars_after_edit()`
-   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `Car.save()` - –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-   - –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `ContainerAdmin.save_formset()` - –Ω–æ–≤—ã–µ –¢–° –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—é—Ç –¥–∞—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `test_unload_date_inheritance` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
-   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ü—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—Å–µ –¢–° –≤ –Ω—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —ç—Ç—É –¥–∞—Ç—É
-
-2. **–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:** ‚ö°
-   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `bulk_update()` –≤–º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° –≤ —Ü–∏–∫–ª–µ (–æ–¥–Ω–∏–º SQL –∑–∞–ø—Ä–æ—Å–æ–º)
-   - –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
-   - –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¢–° (–≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ)
-   - –î–æ–±–∞–≤–ª–µ–Ω `select_related('warehouse')` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
-   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å 20+ –¢–° —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 10-20 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ
-
-3. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–¶–ï–ù–ö–ò –í –ò–ù–í–û–ô–°–ê–•:**
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –≤ `NewInvoiceAdmin.save_model()`
-   - ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏
-   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `test_invoice_markup` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ü–µ–Ω–∫–∏
-   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –∏–Ω–≤–æ–π—Å—ã
-
-4. **–£–õ–£–ß–®–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê –ê–î–ú–ò–ù–ö–ò:**
-   - ‚úÖ –£–¥–∞–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫" –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–° (–Ω–µ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ "–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è" –≤ –º–µ–Ω—é Actions –¥–ª—è –¢–°
-     - –ú–∞—Å—Å–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "–ü–µ—Ä–µ–¥–∞–Ω" —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
-     - –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¢–°
-   - ‚úÖ –£–¥–∞–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–°
-
-5. **–¢–ï–°–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´:**
-   - `python manage.py test_unload_date_inheritance` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-   - `python manage.py test_invoice_markup` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∏–Ω–≤–æ–π—Å—ã
-
-**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
-- `core/admin.py` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ "–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è"
-- `core/models.py` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-- `core/signals.py` - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-- `core/admin_billing.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ Caromoto Lithuania
-- `core/models_billing.py` - —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏
-
-**20.10.2025 - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î, —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–≤–æ–π—Å–æ–≤:**
-
-1. **–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–î:**
-   - ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è production –ë–î –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä —á–µ—Ä–µ–∑ `pg_dump`/`pg_restore`
-   - ‚úÖ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
-
-2. **–£–°–õ–£–ì–ò –°–ö–õ–ê–î–û–í:**
-   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –∫ –æ–¥–Ω–æ–º—É –¢–°
-   - –ò–∑–º–µ–Ω–µ–Ω `get_warehouse_services()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
-   - –î–æ–±–∞–≤–ª–µ–Ω API endpoint `/api/warehouses/` –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞
-   - –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥–∏–µ - –∂–µ–ª—Ç—ã–π)
-   - –í—Å–µ —É—Å–ª—É–≥–∏ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –≤ –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
-
-3. **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–°–ß–ï–¢ –ò–ù–í–û–ô–°–û–í:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
-   - ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª** `update_related_on_car_save` - —É–±—Ä–∞–Ω `return` –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ NewInvoice
-   - ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¢–°:
-     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
-     - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏
-     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
-     - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
-   - ‚úÖ **–ù–∞—Ü–µ–Ω–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è** –≤ –∏–Ω–≤–æ–π—Å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
-   - ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π
-   - ‚úÖ **–°—Ç–∞—Ç—É—Å –≤ –æ–ø–∏—Å–∞–Ω–∏–∏:** `[–ü–µ—Ä–µ–¥–∞–Ω –î–ê–¢–ê]` –∏–ª–∏ `[–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –î–ê–¢–ê]`
-   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
-
-4. **–î–†–£–ì–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:**
-   - ‚úÖ **–ü–û–õ–ï CONTAINER:** –°–¥–µ–ª–∞–Ω–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –≤ –º–æ–¥–µ–ª–∏ Car (–º–∏–≥—Ä–∞—Ü–∏—è 0080)
-   - ‚úÖ **–§–û–ù–û–í–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º —Ñ–æ–Ω–æ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∞–π—Ç–∞
-     - –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ `core/static/website/images/`
-     - –î–æ–±–∞–≤–ª–µ–Ω—ã `hero-background.jpg` –∏ `caromoto_logo.png`
-
-**–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive
-- –£–ª—É—á—à–µ–Ω–∞ –∞–¥–º–∏–Ω–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
-- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä –Ω–∞ VPS (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞)
-- –î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `fix_media_permissions.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤
-- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å Google Drive (—Å—É—Ñ—Ñ–∏–∫—Å—ã)
-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `fix_photo_names` –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
-
-## üî¥ –ê–ö–¢–ò–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (20.10.2025)
-
-### ‚ö†Ô∏è –ù–ï–†–ï–®–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä –≤ Django –∞–¥–º–∏–Ω–∫–µ –Ω–∞ VPS
-
-**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
-- –§–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Nginx
-- –í Python –∫–æ–¥–µ Django –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL —Å `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
-- –í –º–µ—Ç–æ–¥–µ `image_preview` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `_safe_media_url` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—É—Ç–µ–π
-- **–ù–û –≤ HTML –∞–¥–º–∏–Ω–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏** (`/container_photos/...` –±–µ–∑ `/media/`)
-
-**–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–æ–±–æ–≤–∞–Ω–æ:**
-1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Ñ–∞–π–ª–æ–≤ (`chown www-data:www-data`)
-2. ‚úÖ –£–±—Ä–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π `CustomFileSystemStorage` –∏–∑ `settings.py`
-3. ‚úÖ –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `MEDIA_URL`/`MEDIA_ROOT`
-4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_safe_media_url()` –≤ `ContainerPhotoAdmin`
-5. ‚úÖ –£–±—Ä–∞–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è URL –≤ –º–µ—Ç–æ–¥–µ `save()` –º–æ–¥–µ–ª–∏ `ContainerPhoto`
-6. ‚úÖ –£–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç `MediaFileInput` widget
-7. ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã: `regenerate_thumbnails`, `fix_photo_names`, `cleanup_broken_photos`
-
-**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞:**
-```python
-# Python –∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ü–†–ê–í–ò–õ–¨–ù–´–ï URL:
-obj.thumbnail.url -> '/media/container_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg'
-image_preview(obj) -> '<img src="/media/container_photos/..." />'
-
-# –ù–û –≤ HTML –±—Ä–∞—É–∑–µ—Ä–∞:
-<img src="/container_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg" />
-```
-
-**–í—ã–≤–æ–¥:**
-- –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ Python –∫–æ–¥–µ Django (–æ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL)
-- –ü—Ä–æ–±–ª–µ–º–∞ –≥–¥–µ-—Ç–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç-—Å–∞–π–¥–∞
-- –í–æ–∑–º–æ–∂–Ω–æ: JavaScript, –∫–∞—Å—Ç–æ–º–Ω—ã–µ admin templates, –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è middleware
-- –¢—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
-
-**–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π:**
-- `logist2/settings.py` - —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π storage
-- `core/admin_website.py` - –¥–æ–±–∞–≤–ª–µ–Ω `_safe_media_url()`, —É–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π import
-- `core/models_website.py` - —É–±—Ä–∞–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è URL –≤ `save()`
-
-**–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤:**
-- `core/signals.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `update_related_on_car_save`, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ NewInvoice
-- `core/models_billing.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Ü–µ–Ω–∫–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏, –∞–≤—Ç–æ–ø–µ—Ä–µ—Å—á–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è
-- `core/models.py` - `get_warehouse_services()` –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
-
-## –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
-
-### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
-```
-DB_NAME=logist2_db
-DB_USER=arturas
-DB_HOST=localhost
-DB_PORT=5432
-# –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md
-```
-
-### Django Superuser (–∞–¥–º–∏–Ω–∫–∞)
-```
-Username: arturas
-URL: https://caromoto-lt.com/admin/
-# –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md
-```
-
-### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
-```
-Nginx: www-data –∏–ª–∏ www-root
-Gunicorn: www-root
-```
-
-### AI —á–∞—Ç (–≤ `.env`)
-```
-AI_CHAT_ENABLED=True
-AI_API_KEY=...
-AI_API_BASE_URL=https://api.openai.com/v1
-AI_MODEL=gpt-4o-mini
-AI_MAX_TOKENS=400
-AI_TEMPERATURE=0.2
-AI_REQUEST_TIMEOUT=40
-AI_EMBEDDINGS_MODEL=text-embedding-3-small
-AI_RAG_INDEX_PATH=./data/ai_rag_index.json
-AI_RAG_TOP_K=6
-AI_RAG_MAX_AGE_HOURS=72
-HTTP_PROXY=
-HTTPS_PROXY=
-NO_PROXY=localhost,127.0.0.1
-```
-
-### –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
-```bash
-# Media —Ñ–∞–π–ª—ã
-chown -R www-root:www-root media/
-chmod -R 755 media/
-
-# –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
-chmod -R 775 media/container_photos/
-chmod -R 775 media/container_archives/
-```
-
-## ‚ö†Ô∏è POWERSHELL –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø (–í–ê–ñ–ù–û!)
-
-–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ Shell tool –Ω–∞ Windows –ø–æ–º–Ω–∏:
-
-### –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ PowerShell:
-- `&&` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `;` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
-- `cd path && command` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `Set-Location` –∏–ª–∏ –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏
-- –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ `"...'...'..."` ‚Äî –ø—Ä–æ–±–ª–µ–º—ã —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
-- –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ SSH ‚Äî –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –ª–æ–º–∞–µ—Ç—Å—è
-- –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ heredoc `<< EOF` ‚Äî –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
-- `$variable` –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî PowerShell –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ —Å–≤–æ—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
-
-### –ü–†–ê–í–ò–õ–¨–ù–´–ï –ü–û–î–•–û–î–´:
-
-**–î–ª—è SSH –∫–æ–º–∞–Ω–¥:**
-```powershell
-# –ü–õ–û–•–û:
-ssh root@server "cd /path && python script.py"
-
-# –•–û–†–û–®–û (–ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã):
-ssh root@server "systemctl restart gunicorn"
-ssh root@server "python manage.py migrate"
-
-# –•–û–†–û–®–û (—Å –ø—É—Ç—ë–º):
-ssh root@server "cd /var/www/www-root/data/www/logist2; source .venv/bin/activate; python manage.py migrate"
-```
-
-**–î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:**
-```powershell
-# –ü–õ–û–•–û:
-cd c:\project && python manage.py runserver
-
-# –•–û–†–û–®–û:
-c:\project\.venv\Scripts\python.exe c:\project\manage.py runserver
-```
-
-**–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
-- –ò—Å–ø–æ–ª—å–∑—É–π `deploy.ps1` —Å–∫—Ä–∏–ø—Ç
-- –ò–ª–∏ –≤—ã–ø–æ–ª–Ω—è–π –∫–æ–º–∞–Ω–¥—ã –ø–æ –æ–¥–Ω–æ–π
-- –ò–∑–±–µ–≥–∞–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö ‚Äî –ª—É—á—à–µ —Å–æ–∑–¥–∞–π —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
-
-### SSH + Python shell:
-```powershell
-# –ü–õ–û–•–û (–∫–∞–≤—ã—á–∫–∏):
-ssh root@server "python -c 'from models import X; print(X.objects.all())'"
-
-# –•–û–†–û–®–û (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):
-ssh root@server "cd /path; source .venv/bin/activate; python manage.py showmigrations"
-```
-
----
-
-## –ü–ê–ú–Ø–¢–ö–ê –î–õ–Ø AI
-
-1. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—Å–∏—Ç
-2. **–°—Ä–∞–∑—É –¥–µ–ø–ª–æ–π** - –∏–∑–º–µ–Ω–∏ –∫–æ–¥ –∏ –∑–∞–¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ git push
-3. **SSH –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω** - –µ—Å–ª–∏ timeout, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É
-4. **–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è** - Caromoto Lithuania (–≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –Ω–µ–π)
-5. **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π gunicorn –∏ daphne
-6. **–û—á–∏—â–∞–π __pycache__** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ
-7. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î** - –∏—Å–ø–æ–ª—å–∑—É–π pg_dump/pg_restore –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å production
-8. **–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç –ª—é–±—ã—Ö —Å–∫–ª–∞–¥–æ–≤ —á–µ—Ä–µ–∑ CarService (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)
-9. **–ò–Ω–≤–æ–π—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Car —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ NewInvoice
-10. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤** - –µ—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ –Ω–µ—Ç `return` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
-11. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ planned_unload_date –∏–ª–∏ unload_date –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-12. **SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)
-13. **Brevo –¥–ª—è email** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è smtp-relay.brevo.com –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å)
-14. **SMS —á–µ—Ä–µ–∑ Brevo** - –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º (–ø–ª–∞—Ç–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–µ phone –≤ Client)
-
-## –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´
-
-### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (Linux/Bash):
-```bash
-# –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
-cd /var/www/www-root/data/www/logist2 && git pull && source .venv/bin/activate && python manage.py migrate && python manage.py collectstatic --noinput && find . -type d -name __pycache__ -delete && systemctl restart gunicorn && systemctl restart daphne
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
-systemctl is-active gunicorn daphne nginx
-
-# –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ
-journalctl -u gunicorn -n 50 --no-pager
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
-python manage.py check_photo_environment
-python manage.py regenerate_thumbnails
-
-# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π)
-./fix_media_permissions.sh
-
-# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
-cd /var/www/www-root/data/www/logist2
-PGPASSWORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_backup_$(date +%Y%m%d).dump
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ email (—á–µ—Ä–µ–∑ Brevo)
-journalctl -u gunicorn --since '10 minutes ago' --no-pager | grep -i email
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ SMTP –Ω–∞—Å—Ç—Ä–æ–µ–∫
-grep EMAIL /var/www/www-root/data/www/logist2/.env
-
-# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –≤ –ø–∞–Ω–µ–ª–∏ Brevo: https://app.brevo.com
-```
-
-### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (PowerShell):
-```powershell
-# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä
-# –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –¥–∞–º–ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
-ssh root@176.118.198.78 "cd /var/www/www-root/data/www/logist2 && PGPASSWORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_sync_backup.dump"
-
-# –®–∞–≥ 2: –°–∫–∞—á–∞—Ç—å –¥–∞–º–ø
-scp root@176.118.198.78:/var/www/www-root/data/www/logist2/logist2_sync_backup.dump .
-
-# –®–∞–≥ 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
-$env:PGPASSWORD='YOUR_DB_PASSWORD'; pg_restore -U arturas -h localhost -d logist2_db --clean --if-exists logist2_sync_backup.dump
-
-# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
-.\.venv\Scripts\activate.ps1
-py manage.py shell -c "from core.models import Car, Client, Container; print(f'Cars: {Car.objects.count()}'); print(f'Clients: {Client.objects.count()}'); print(f'Containers: {Container.objects.count()}')"
-```
-
-## –†–ï–ü–û–ó–ò–¢–û–†–ò–ô
-
-**GitHub:** https://github.com/Arturas7777/logist2.git
-**Branch:** master
-
----
-
-**–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º.**
-
+# –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê LOGIST2 –î–õ–Ø AI
+
+## –û –ü–†–û–ï–ö–¢–ï
+
+**–ù–∞–∑–≤–∞–Ω–∏–µ:** Logist2 (Caromoto Lithuania)
+**–¢–∏–ø:** Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
+**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –¢–°, –∫–ª–∏–µ–Ω—Ç–∞–º–∏, —Å–∫–ª–∞–¥–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏
+
+### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
+- **Backend:** Django 5.1.7 + Python 3.10-3.12
+- **Database:** PostgreSQL (—Ç–µ—Å—Ç—ã ‚Äî SQLite —á–µ—Ä–µ–∑ `settings_test.py`)
+- **API:** Django REST Framework
+- **Frontend:** Django templates + Bootstrap 5 + HTMX + –∫–∞—Å—Ç–æ–º–Ω—ã–π JS
+- **WebSockets:** Channels + Daphne (Redis –≤ `settings_base.py`, InMemory –≤ `settings.py`)
+- **Web Server:** Nginx + Gunicorn, —Å—Ç–∞—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ WhiteNoise
+- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç:** Django templates + REST API
+
+### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
+- **CRM —Å–∏—Å—Ç–µ–º–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –±–∞–ª–∞–Ω—Å–∞–º–∏
+- **–õ–æ–≥–∏—Å—Ç–∏–∫–∞** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –¢–°, —Å–∫–ª–∞–¥—ã, –ª–∏–Ω–∏–∏, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏
+- **–ë–∏–ª–ª–∏–Ω–≥** - –∏–Ω–≤–æ–π—Å—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã
+- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–æ–≤, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
+- **Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+- **–°–∏—Å—Ç–µ–º–∞ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π** - —É—Å–ª—É–≥–∏ Company (Caromoto Lithuania) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø
+- **AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç** - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ + RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –∫–æ–¥—É/–¥–æ–∫–∞–º
+
+## VPS –°–ï–†–í–ï–†
+
+**IP:** 176.118.198.78
+**SSH:** `root@176.118.198.78`
+**–î–æ–º–µ–Ω:** https://caromoto-lt.com
+
+> ‚ö†Ô∏è **–ü–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `CREDENTIALS.md` (–Ω–µ –≤ git)
+
+### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
+```
+–ü—Ä–æ–µ–∫—Ç: /var/www/www-root/data/www/logist2
+Virtualenv: /var/www/www-root/data/www/logist2/.venv
+Media: /var/www/www-root/data/www/logist2/media
+Static: /var/www/www-root/data/www/logist2/staticfiles
+```
+
+### –°–µ—Ä–≤–∏—Å—ã
+```bash
+# Gunicorn (Django application)
+systemctl restart gunicorn
+systemctl status gunicorn
+
+# Daphne (WebSockets)
+systemctl restart daphne
+systemctl status daphne
+
+# Nginx
+systemctl reload nginx
+nginx -t
+```
+
+### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
+```
+–§–∞–π–ª: /etc/nginx/vhosts/www-root/176.118.198.78.conf
+
+location /media/ {
+    alias /var/www/www-root/data/www/logist2/media/;
+}
+
+location /static/ {
+    alias /var/www/www-root/data/www/logist2/staticfiles/;
+}
+```
+
+## –î–ï–ü–õ–û–ô
+
+### –°–ø–æ—Å–æ–± 1: PowerShell —Å–∫—Ä–∏–ø—Ç (—Å Windows)
+```powershell
+.\deploy.ps1
+```
+
+### –°–ø–æ—Å–æ–± 2: Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
+```bash
+ssh root@176.118.198.78
+cd /var/www/www-root/data/www/logist2
+git pull origin master
+source .venv/bin/activate
+python manage.py migrate
+python manage.py collectstatic --noinput
+systemctl restart gunicorn
+systemctl restart daphne
+```
+
+### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç deploy.ps1:
+1. –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SCP: `core/*`, `logist2/*`, `templates/*`
+2. –ó–∞–ø—É—Å–∫–∞–µ—Ç collectstatic
+3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç gunicorn –∏ daphne
+
+### ‚ö†Ô∏è –í–ê–ñ–ù–û: –ß—Ç–æ –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ:
+- `.env` —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–∞—Ä–æ–ª–∏ –ë–î) ‚Äî **–±–µ–∑–æ–ø–∞—Å–µ–Ω**
+- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω–∞**
+- Media —Ñ–∞–π–ª—ã (—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏) ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω—ã**
+- Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω–∞**
+
+## –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê
+
+```
+logist2/
+‚îú‚îÄ‚îÄ core/                           # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
+‚îÇ   ‚îú‚îÄ‚îÄ models.py                   # –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Container, Car, Client, etc)
+‚îÇ   ‚îú‚îÄ‚îÄ models_website.py           # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
+‚îÇ   ‚îú‚îÄ‚îÄ models_billing.py           # –ë–∏–ª–ª–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–∞
+‚îÇ   ‚îú‚îÄ‚îÄ admin.py                    # Django Admin –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
+‚îÇ   ‚îú‚îÄ‚îÄ admin_website.py            # Admin –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
+‚îÇ   ‚îú‚îÄ‚îÄ views.py                    # Views –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
+‚îÇ   ‚îú‚îÄ‚îÄ views_website.py            # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
+‚îÇ   ‚îú‚îÄ‚îÄ google_drive_sync.py        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive
+‚îÇ   ‚îú‚îÄ‚îÄ management/commands/        # Management –∫–æ–º–∞–Ω–¥—ã
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ add_performance_indexes.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apply_optimizations.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check_photo_environment.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cleanup_broken_photos.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_default_company.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fix_photo_names.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fix_ths_line_services.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate_thumbnails.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init_new_balance_system.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate_services.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recalculate_car_services.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recalculate_storage.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ regenerate_thumbnails.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reset_billing.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_client_balances.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_google_drive_photos.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_photos_gdrive.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rebuild_ai_index.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rebuild_ai_index_if_stale.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_invoice_markup.py
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_unload_date_inheritance.py
+‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update_container_statuses.py
+‚îÇ   ‚îú‚îÄ‚îÄ services/                   # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_chat_service.py      # AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î)
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_ai_agent.py       # AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
+‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ai_rag.py               # RAG –∏–Ω–¥–µ–∫—Å –∏ –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–∫–æ–¥—É
+‚îÇ   ‚îú‚îÄ‚îÄ static/                     # –°—Ç–∞—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
+‚îÇ   ‚îî‚îÄ‚îÄ templates/                  # –®–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏
+‚îú‚îÄ‚îÄ templates/                      # –û–±—â–∏–µ —à–∞–±–ª–æ–Ω—ã
+‚îÇ   ‚îú‚îÄ‚îÄ admin/                      # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–¥–º–∏–Ω —à–∞–±–ª–æ–Ω—ã
+‚îÇ   ‚îî‚îÄ‚îÄ website/                    # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç
+‚îú‚îÄ‚îÄ media/                          # –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
+‚îÇ   ‚îú‚îÄ‚îÄ container_photos/           # –§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ thumbnails/             # –ú–∏–Ω–∏–∞—Ç—é—Ä—ã
+‚îÇ   ‚îú‚îÄ‚îÄ container_archives/         # ZIP –∞—Ä—Ö–∏–≤—ã
+‚îÇ   ‚îî‚îÄ‚îÄ car_photos/                 # –§–æ—Ç–æ –¢–°
+‚îú‚îÄ‚îÄ logist2/                        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
+‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (InMemory Channels)
+‚îÇ   ‚îú‚îÄ‚îÄ settings_base.py            # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Redis Channels)
+‚îÇ   ‚îú‚îÄ‚îÄ settings_dev.py             # Dev-–ø—Ä–æ—Ñ–∏–ª—å
+‚îÇ   ‚îú‚îÄ‚îÄ settings_prod.py            # Prod-–ø—Ä–æ—Ñ–∏–ª—å
+‚îÇ   ‚îú‚îÄ‚îÄ settings_test.py            # Test-–ø—Ä–æ—Ñ–∏–ª—å (SQLite)
+‚îÇ   ‚îú‚îÄ‚îÄ urls.py                     # URL routing
+‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py / asgi.py           # WSGI/ASGI
+‚îú‚îÄ‚îÄ requirements.txt                # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
+‚îî‚îÄ‚îÄ requirements_website.txt        # –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
+```
+
+## –ö–õ–Æ–ß–ï–í–´–ï –ú–û–î–ï–õ–ò
+
+### Container (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä)
+- `number` - –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
+- `status` - —Å—Ç–∞—Ç—É—Å (FLOATING, IN_PORT, UNLOADED, TRANSFERRED)
+- `line`, `warehouse`, `client` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏
+- `ths`, `ths_payer` - —Å—É–º–º–∞ THS –∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ (LINE/WAREHOUSE)
+- `planned_unload_date`, `unload_date`, `eta`, `unloaded_status_at` - –∫–ª—é—á–µ–≤—ã–µ –¥–∞—Ç—ã
+- `customs_procedure`, `sklad`, `dekl`, `proft` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ/legacy –ø–æ–ª—è
+- `google_drive_folder_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –≤ Google Drive
+- `container_cars` - —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¢–°
+
+### Car (–¢–°)
+- `vin` - VIN –Ω–æ–º–µ—Ä (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
+- `container` - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ —Å 20.10.2025)
+- `client` - –∫–ª–∏–µ–Ω—Ç-–≤–ª–∞–¥–µ–ª–µ—Ü
+- `warehouse`, `line`, `carrier` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏
+- `vehicle_type` - —Ç–∏–ø –¢–° (11 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
+- `status`, `unload_date`, `transfer_date` - —Å—Ç–∞—Ç—É—Å—ã –∏ –¥–∞—Ç—ã
+- `days`, `storage_cost` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç)
+- `car_services` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤/–ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
+
+### CarService (–£—Å–ª—É–≥–∞ –¢–°)
+- `car` - —Å–≤—è–∑—å —Å –¢–°
+- `service_type` - —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (WAREHOUSE, LINE, CARRIER, COMPANY)
+- `service_id` - ID —É—Å–ª—É–≥–∏ (WarehouseService, LineService, CarrierService, CompanyService)
+- `custom_price` - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π)
+- `markup_amount` - —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–æ–π—Å–µ)
+- `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥
+- **–ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç –õ–Æ–ë–´–• —Å–∫–ª–∞–¥–æ–≤ –∫ –¢–° (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)**
+
+### CompanyService (–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏)
+- `company` - —Å–≤—è–∑—å —Å Company (Caromoto Lithuania –∏ –¥—Ä.)
+- `name`, `description` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
+- `default_price`, `default_markup` - —Ü–µ–Ω–∞ –∏ –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+- `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
+- `add_by_default` - –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ —É—Å–ª—É–≥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ–≤—ã–º –¢–° –∫–æ–º–ø–∞–Ω–∏–∏
+
+**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**
+- `LineService` –∏ `CarrierService` —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —Ñ–ª–∞–≥ `add_by_default`
+
+### ContainerPhoto (–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+- `container` - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
+- `photo` - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
+- `thumbnail` - –º–∏–Ω–∏–∞—Ç—é—Ä–∞ (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
+- `is_public` - –¥–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É
+
+### AutoTransport (–ê–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É)
+- `number` - –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: AT-YYYYMMDD-NNNN)
+- `carrier` - –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫
+- `eori_code` - EORI –∫–æ–¥ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)
+- `truck`, `driver` - —Å–≤—è–∑–∏ —Å CarrierTruck –∏ CarrierDriver
+- `truck_number_manual`, `trailer_number_manual`, `driver_name_manual` - —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
+- `driver_phone` - —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è
+- `border_crossing` - –≥—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
+- `cars` - ManyToMany —Å–≤—è–∑—å —Å –¢–°
+- `status` - DRAFT, FORMED, LOADED, IN_TRANSIT, DELIVERED, CANCELLED
+- **–ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω"** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
+
+### CarrierTruck (–ê–≤—Ç–æ–≤–æ–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞)
+- `carrier` - —Å–≤—è–∑—å —Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–º
+- `truck_number`, `trailer_number` - –Ω–æ–º–µ—Ä–∞ —Ç—è–≥–∞—á–∞ –∏ –ø—Ä–∏—Ü–µ–ø–∞
+- `full_number` (property) - –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä "XXXXX / YYYYY"
+- `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
+
+### CarrierDriver (–í–æ–¥–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞)
+- `carrier` - —Å–≤—è–∑—å —Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–º
+- `first_name`, `last_name` - –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è
+- `phone` - —Ç–µ–ª–µ—Ñ–æ–Ω
+- `full_name` (property) - "–ò–º—è –§–∞–º–∏–ª–∏—è"
+- `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
+
+### AI-–ø–æ–º–æ—â–Ω–∏–∫ (—á–∞—Ç)
+- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –ë–î –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
+- –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ
+- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—ã/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
+- –í–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ
+- –í –∞–¥–º–∏–Ω–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
+- –í AIChat —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `context_snapshot` (page context)
+- RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã–º —Ñ–∞–π–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞
+
+### NewInvoice (–ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å) - –û–°–ù–û–í–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ë–ò–õ–õ–ò–ù–ì–ê
+- `number` - –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
+- `issuer_*` - –∫—Ç–æ –≤—ã—Å—Ç–∞–≤–∏–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å Company, Warehouse, Line, Carrier)
+- `recipient_*` - –∫–æ–º—É –≤—ã—Å—Ç–∞–≤–ª–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å Client, Company, Warehouse, Line, Carrier)
+- `cars` - ManyToMany —Å–≤—è–∑—å —Å –¢–°
+- `items` - –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —É—Å–ª—É–≥ –¢–°)
+- **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¢–° –∏–Ω–≤–æ–π—Å –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª
+
+### InvoiceItem (–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞)
+- `invoice` - —Å–≤—è–∑—å —Å –∏–Ω–≤–æ–π—Å–æ–º
+- `car` - —Å–≤—è–∑—å —Å –¢–° (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
+- `description` - –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
+- `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
+- `unit_price` - —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
+- `total_price` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è (quantity √ó unit_price)
+
+**–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –æ—Ç Caromoto Lithuania –∫–ª–∏–µ–Ω—Ç—É:**
+1. –•—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è Company): `{car.days} –¥–Ω–µ–π √ó —Å—Ç–∞–≤–∫–∞ –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"` + —Å—Ç–∞—Ç—É—Å `[–ü–µ—Ä–µ–¥–∞–Ω]` –∏–ª–∏ `[–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ]`
+2. –í—Å–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ (–æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤, –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)
+3. –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π
+4. –í—Å–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
+5. –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ü–µ–Ω—ã —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ `markup_amount` (–æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è)
+
+## API ENDPOINTS
+
+### –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –¢–°:
+- `GET /api/warehouses/` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
+- `GET /api/car/<car_id>/get_available_services/?type=warehouse&warehouse_id=<id>` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
+- `GET /api/companies/` - —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
+- `GET /api/car/<car_id>/get_available_services/?type=company&company_id=<id>` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏
+- `POST /api/car/<car_id>/add_services/` - –¥–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫ –¢–°
+- `GET /core/api/search-counterparties/` - –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
+- `GET /core/api/search-cars/` - –ø–æ–∏—Å–∫ –¢–° –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
+
+### –î–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤:
+- `GET /core/api/autotransport/carrier-info/<carrier_id>/` - EORI –∫–æ–¥, –∞–≤—Ç–æ–≤–æ–∑—ã, –≤–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+- `GET /core/api/autotransport/driver-phone/<driver_id>/` - —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è
+- `GET /core/api/autotransport/border-crossings/` - —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–Ω–∏—Ü –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
+- `POST /core/api/autotransport/create-truck/` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞
+- `POST /core/api/autotransport/create-driver/` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
+
+### –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞:
+- `POST /api/track/` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –ø–æ VIN –∏–ª–∏ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+- `GET /api/container-photos/<container_number>/` - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+- `POST /api/download-photos-archive/` - —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
+- `POST /api/ai-chat/` - AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î, –±–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `page_context` –∏ `X-Admin-Chat`)
+
+### –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é:
+- `/?track=<–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ
+
+## GOOGLE DRIVE –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
+
+### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ Google Drive:
+```
+–ì–ª–∞–≤–Ω–∞—è –ø–∞–ø–∫–∞: https://drive.google.com/drive/u/1/folders/1PkrfxocilDZjDaT3R1SQ9DflyWBBFNpW
+
+‚îú‚îÄ‚îÄ AUTO I≈† KONTO (–í–´–ì–†–£–ñ–ï–ù–ù–´–ï)
+‚îÇ   ‚îî‚îÄ‚îÄ [–º–µ—Å—è—Ü]/[–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞]/[—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏]
+‚îÇ
+‚îî‚îÄ‚îÄ KONTO VIDUS (–í –ö–û–ù–¢–ï–ô–ù–ï–†–ï)
+    ‚îî‚îÄ‚îÄ [–º–µ—Å—è—Ü]/[–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞]/[—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏]
+```
+
+### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞:
+1. –í –∞–¥–º–∏–Ω–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–∞–ø–∫—É Google Drive
+2. –ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É "üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive"
+3. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–≤ —Ñ–æ–Ω–µ)
+4. –ú–∏–Ω–∏–∞—Ç—é—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
+5. –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è
+
+## –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´
+
+### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
+```bash
+# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
+ssh root@176.118.198.78
+
+# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ–µ–∫—Ç
+cd /var/www/www-root/data/www/logist2
+source .venv/bin/activate
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
+python manage.py check_photo_environment
+
+# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä
+python manage.py regenerate_thumbnails
+python manage.py regenerate_thumbnails --force
+
+# –£–¥–∞–ª–µ–Ω–∏–µ –±–∏—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
+python manage.py cleanup_broken_photos
+python manage.py cleanup_broken_photos --delete
+
+# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è –∫–æ–º–∞–Ω–¥–∞)
+python manage.py sync_google_drive_photos
+
+# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —Å Google Drive (–ù–û–í–ê–Ø - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
+python manage.py sync_photos_gdrive --no-photos     # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ
+python manage.py sync_photos_gdrive --recent        # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (14 –¥–Ω–µ–π)
+python manage.py sync_photos_gdrive --container ECMU5566195  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
+python manage.py sync_photos_gdrive --verbose       # –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
+
+# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–í–ê–ñ–ù–û!)
+./fix_media_permissions.sh
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
+journalctl -u gunicorn -f
+journalctl -u daphne -f
+
+# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Python
+find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
+```
+
+### –õ–æ–∫–∞–ª—å–Ω–æ:
+```powershell
+# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
+.\START_ME.bat
+
+# –î–µ–ø–ª–æ–π –Ω–∞ VPS
+.\deploy.ps1
+
+# –ú–∏–≥—Ä–∞—Ü–∏–∏
+python manage.py makemigrations
+python manage.py migrate
+```
+
+## EMAIL –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê–ú (–î–µ–∫–∞–±—Ä—å 2025)
+
+### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
+- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã –≤ –ø–æ–ª–µ "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å"
+- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+- –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º, —á—å–∏ –¢–° –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+- –í –ø–∏—Å—å–º–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¢–° –∫–ª–∏–µ–Ω—Ç–∞ (VIN, –º–∞—Ä–∫–∞, –≥–æ–¥)
+- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—á–µ—Ä–µ–∑ NotificationLog)
+
+### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—è—Ö:
+
+**Client (core/models.py):**
+- `email` ‚Äî Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+- `notification_enabled` ‚Äî –§–ª–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
+
+**Container (core/models.py):**
+- `planned_unload_date` ‚Äî "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å" (–ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
+
+**NotificationLog (core/models_website.py):**
+- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+- –¢–∏–ø—ã: PLANNED (–ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞), UNLOADED (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞)
+- –•—Ä–∞–Ω–∏—Ç: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–ª–∏–µ–Ω—Ç, email, —Å–ø–∏—Å–æ–∫ –¢–°, —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏, –æ—à–∏–±–∫–∏
+
+### –§–∞–π–ª—ã:
+
+```
+core/services/email_service.py     # –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+core/signals.py                    # –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
+templates/email/planned_notification.html   # –®–∞–±–ª–æ–Ω –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+templates/email/unload_notification.html    # –®–∞–±–ª–æ–Ω —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+```
+
+### SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ .env) ‚Äî —á–µ—Ä–µ–∑ Brevo:
+```
+EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
+EMAIL_HOST=smtp-relay.brevo.com
+EMAIL_PORT=587
+EMAIL_USE_TLS=True
+# –ü–∞—Ä–æ–ª–∏ –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md
+```
+
+### –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∏—Å—å–º–∞—Ö (settings_base.py):
+```
+COMPANY_NAME = 'Caromoto Lithuania'
+COMPANY_PHONE = '+37068830450'
+COMPANY_EMAIL = 'lithuania@caromoto.com'
+COMPANY_WEBSITE = 'https://caromoto-lt.com'
+```
+
+### Brevo (–±—ã–≤—à–∏–π Sendinblue):
+- **–ê–∫–∫–∞—É–Ω—Ç:** Caromoto Lithuania
+- **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ:** 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å
+- **–î–æ–º–µ–Ω:** caromoto-lt.com ‚úÖ **Authenticated**
+- **DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Hostika.LT** (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–º–µ–Ω–∞):
+  - TXT: `brevo-code:6113c7d9b16365464c534b6bff2e13b6`
+  - CNAME: `brevo1._domainkey` ‚Üí `b1.caromoto-lt-com.dkim.brevo.com`
+  - CNAME: `brevo2._domainkey` ‚Üí `b2.caromoto-lt-com.dkim.brevo.com`
+  - TXT: `_dmarc` ‚Üí `v=DMARC1; p=none; rua=mailto:rua@dmarc.brevo.com`
+- **–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** https://app.brevo.com
+- **–¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:** SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–ª–∞—Ç–Ω–æ, ~0.05-0.08‚Ç¨/SMS)
+
+### –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
+- **üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
+- **üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
+
+### –°—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–µ–∫–∞–±—Ä—å 2025):
+- ‚úÖ –ü–µ—Ä–µ—à–ª–∏ –Ω–∞ Brevo (–±—ã–≤—à–∏–π Sendinblue) –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
+- ‚úÖ SMTP –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ smtp-relay.brevo.com
+- ‚úÖ DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Hostika.LT (DKIM, DMARC, Brevo code)
+- ‚úÖ –î–æ–º–µ–Ω caromoto-lt.com –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –≤ Brevo
+- ‚úÖ Gmail –∏ –¥—Ä—É–≥–∏–µ –ø–æ—á—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
+
+### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É email:
+1. –ê–¥–º–∏–Ω–∫–∞ ‚Üí –ö–ª–∏–µ–Ω—Ç—ã ‚Üí –≤—ã–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
+2. –í —Ä–∞–∑–¥–µ–ª–µ "–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" —É–∫–∞–∑–∞—Ç—å Email –∏ –≤–∫–ª—é—á–∏—Ç—å "–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
+
+---
+
+## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï
+
+### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
+‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è CRM —Å–∏—Å—Ç–µ–º–∞
+‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–°
+‚úÖ –ë–∏–ª–ª–∏–Ω–≥ –∏ –±–∞–ª–∞–Ω—Å—ã
+‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª
+‚úÖ Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π)
+‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä
+‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º (—á–µ—Ä–µ–∑ Brevo SMTP)
+
+### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
+‚ö†Ô∏è SSH connection timeout –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
+‚ö†Ô∏è –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –µ—Å–ª–∏ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
+‚ö†Ô∏è –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Google Drive - –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å 1-2 –º–∏–Ω—É—Ç—ã
+‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤—Ä—É—á–Ω—É—é (—á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –æ—Ç root) –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `./fix_media_permissions.sh`
+
+### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ñ–µ–≤—Ä–∞–ª—å 2026):
+
+**04.02.2026 - –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É:**
+1. **–ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ - –ê–í–¢–û–í–û–ó–´:** ‚≠ê
+   - ‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¢–° –∫–ª–∏–µ–Ω—Ç–∞–º
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ "—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏" –∞–≤—Ç–æ–≤–æ–∑–∞
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –∞–≤—Ç–æ–≤–æ–∑–∞
+   - ‚úÖ –í—ã–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å –ø–æ–∏—Å–∫–æ–º –ø–æ VIN/–º–∞—Ä–∫–µ (–∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–∞—Ö)
+   - ‚úÖ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ EORI –∫–æ–¥–∞, —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+   - ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø—Ä—è–º–æ –∏–∑ —Ñ–æ—Ä–º—ã
+
+**–ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏:**
+- `CarrierTruck` - –∞–≤—Ç–æ–≤–æ–∑—ã –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (–Ω–æ–º–µ—Ä–∞ —Ç—è–≥–∞—á–∞ –∏ –ø—Ä–∏—Ü–µ–ø–∞)
+- `CarrierDriver` - –≤–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω)
+- `AutoTransport` - –∞–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É (—Å–≤—è–∑—å —Å –¢–°, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–º, –¥–∞—Ç–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏)
+
+**–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Carrier:**
+- `eori_code` - EORI –∫–æ–¥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+- –°–≤—è–∑–∏: `trucks`, `drivers`, `auto_transports`
+
+**API endpoints:**
+- `GET /core/api/autotransport/carrier-info/<carrier_id>/`
+- `GET /core/api/autotransport/driver-phone/<driver_id>/`
+- `GET /core/api/autotransport/border-crossings/`
+- `POST /core/api/autotransport/create-truck/`
+- `POST /core/api/autotransport/create-driver/`
+
+**–§–∞–π–ª—ã:**
+- `core/models.py` - –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏
+- `core/models_billing.py` - —Å–≤—è–∑—å NewInvoice —Å AutoTransport
+- `core/admin.py` - AutoTransportAdmin
+- `core/views_autotransport.py` - API endpoints
+- `core/signals.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤
+- `templates/admin/core/autotransport/change_form.html` - –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω
+- `core/static/css/autotransport.css` - —Å—Ç–∏–ª–∏
+
+---
+
+### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—è–Ω–≤–∞—Ä—å 2026):
+
+**31.01.2026 - –°—Ç–æ–ª–±–µ—Ü "–ù–∞—Ü–µ–Ω–∫–∞" –≤ —Å–ø–∏—Å–∫–µ –¢–°:**
+1. **–í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ù–ê–¶–ï–ù–û–ö:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü "–ù" (–ù–∞—Ü–µ–Ω–∫–∞) –≤ —Å–ø–∏—Å–∫–µ –¢–°
+   - ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
+   - ‚úÖ –û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫ –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π (–¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¢–°)
+   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–∞—Ü–µ–Ω–∫–µ
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
+
+2. **–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:** ‚ö°
+   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Django `annotate()` + `Sum()` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
+   - –û–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1 (–≥–¥–µ N - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–°)
+   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 10-40 —Ä–∞–∑: 50-120ms –¥–ª—è 50-500 –¢–° (–≤–º–µ—Å—Ç–æ 500-5000ms)
+   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –¢–° –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –¥–∞–∂–µ —Å —Å–æ—Ç–Ω—è–º–∏ –∑–∞–ø–∏—Å–µ–π
+
+**–§–∞–π–ª—ã:**
+- `core/admin.py` ‚Äî –º–µ—Ç–æ–¥—ã `markup_display()`, `get_queryset()`, `changelist_view()`
+- `templates/admin/core/car/change_list.html` ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ–±—â–µ–π —Å—É–º–º—ã
+
+**21.01.2026 - –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:**
+
+1. **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° GOOGLE DRIVE:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Google Drive –ø–æ –Ω–æ–º–µ—Ä—É
+   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–ø–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
+   - ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º: IN_CONTAINER (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ) –∏ UNLOADING (–≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ)
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É Google Drive
+   - ‚úÖ Management –∫–æ–º–∞–Ω–¥–∞ `sync_photos_gdrive` —Å —Ä–µ–∂–∏–º–∞–º–∏: --no-photos, --recent, --container
+   - ‚úÖ Cron –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
+
+2. **–ì–ê–õ–ï–†–ï–Ø –í –ê–î–ú–ò–ù–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê:**
+   - ‚úÖ –°–≤—ë—Ä–Ω—É—Ç–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≥–∞–ª–µ—Ä–µ—è (–±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
+   - ‚úÖ AJAX –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
+   - ‚úÖ –í–∫–ª–∞–¥–∫–∏ "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ" –∏ "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
+   - ‚úÖ Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä
+   - ‚úÖ Lightbox —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
+
+3. **–ì–ê–õ–ï–†–ï–Ø –ù–ê –ö–õ–ò–ï–ù–¢–°–ö–û–ú –°–ê–ô–¢–ï:**
+   - ‚úÖ –í–∫–ª–∞–¥–∫–∏ "–í—Å–µ", "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ", "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
+   - ‚úÖ –í—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
+   - ‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" (–∑–µ–ª—ë–Ω–∞—è)
+   - ‚úÖ Lightbox —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
+   - ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (drag –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏)
+
+4. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–ò–°–ö–ê:**
+   - ‚úÖ –£–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `current_price` –∏–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
+   - ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VIN –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
+   - ‚úÖ –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é VIN
+
+5. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï URL –§–û–¢–û–ì–†–ê–§–ò–ô –ù–ê VPS:**
+   - ‚úÖ –§–æ—Ç–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏)
+   - ‚úÖ –ü—Ä–∏—á–∏–Ω–∞: API –≤–æ–∑–≤—Ä–∞—â–∞–ª URL –±–µ–∑ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞
+   - ‚úÖ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –≤ `views.py` –∏ `views_website.py`
+   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`)
+
+6. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï HOVER-–≠–§–§–ï–ö–¢–ê –ö–ù–û–ü–û–ö:**
+   - ‚úÖ –£–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
+   - ‚úÖ –ó–∞–º–µ–Ω—ë–Ω `transition: all` –Ω–∞ `transition: opacity` (—É–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É)
+   - ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π hover-—ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–æ—Å—Ç–æ–π `opacity: 0.85`
+   - ‚úÖ –§–∞–π–ª: `core/static/website/css/style.css`
+
+7. **–£–õ–£–ß–®–ï–ù–ò–ï LIGHTBOX –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í:**
+   - ‚úÖ –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å—Ç–∞–ª–∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ (35% –≤–º–µ—Å—Ç–æ 90%)
+   - ‚úÖ –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑—É–º–µ > 1, –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∑—É–º–∞
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω pinch-to-zoom (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏)
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º –ø—Ä–∏ –∑—É–º–µ
+   - ‚úÖ –§–∞–π–ª: `templates/website/home.html`
+
+**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
+- `core/google_drive_sync.py` - –∞–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–∞–ø–æ–∫, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º
+- `core/management/commands/sync_photos_gdrive.py` - –Ω–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã
+- `core/views.py` - API endpoint –¥–ª—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
+- `core/views_website.py` - —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫, API –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ñ–æ—Ç–æ
+- `core/serializers_website.py` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ current_price
+- `templates/admin/core/container/change_form.html` - –∫–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
+- `templates/admin/core/container/photos_gallery.html` - AJAX –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
+- `templates/website/home.html` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ –∏ lightbox
+- `sync_photos_cron.sh` - cron —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
+- `core/static/website/css/style.css` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω hover-—ç—Ñ—Ñ–µ–∫—Ç –∫–Ω–æ–ø–æ–∫ (—É–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ)
+
+**23.01.2026 - AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ:**
+1. **AI-–ß–ê–¢:** –ø–æ–¥–∫–ª—é—á—ë–Ω —á–∞—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ
+2. **–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–î:** VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ
+3. **–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –§–ò–ù–ê–ù–°–û–í:** –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—É/–±–∞–ª–∞–Ω—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
+4. **–ì–ê–õ–ï–†–ï–Ø –§–û–¢–û:** —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ `/?track=<–Ω–æ–º–µ—Ä>&photos=1` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ
+
+**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
+- `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI
+- `core/views_website.py` ‚Äî endpoint AI –∏ –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ç–æ/–≥–∞–ª–µ—Ä–µ–∏
+- `core/static/website/js/ai-chat.js` ‚Äî CSRF –∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
+- `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
+- `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞
+- `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
+- `env.example`, `env.local.example` ‚Äî –ø—Ä–∏–º–µ—Ä—ã AI –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
+
+---
+
+### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–µ–∫–∞–±—Ä—å 2025):
+
+**13.12.2025 - Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º:**
+
+1. **–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –†–ê–ó–ì–†–£–ó–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+   - ‚úÖ –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+   - ‚úÖ –í –ø–∏—Å—å–º–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¢–° –∫–ª–∏–µ–Ω—Ç–∞ (VIN, –º–∞—Ä–∫–∞, –≥–æ–¥)
+   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ NotificationLog
+   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
+   - ‚úÖ –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
+
+2. **–ù–û–í–´–ï –ú–û–î–ï–õ–ò –ò –ü–û–õ–Ø:**
+   - `Client.email` ‚Äî email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+   - `Client.notification_enabled` ‚Äî —Ñ–ª–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+   - `Container.planned_unload_date` ‚Äî "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å"
+   - `NotificationLog` ‚Äî –∂—É—Ä–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+
+3. **SMTP –ù–ê–°–¢–†–û–ô–ö–ê (—á–µ—Ä–µ–∑ Brevo):**
+   - ~~–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä~~ ‚Üí –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ **Brevo** (–±—ã–≤—à–∏–π Sendinblue)
+   - –ü—Ä–∏—á–∏–Ω–∞: Gmail –æ—Ç–∫–ª–æ–Ω—è–ª –ø–∏—Å—å–º–∞ –±–µ–∑ PTR –∑–∞–ø–∏—Å–∏
+   - Brevo –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É (95-99%)
+   - –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å
+   - DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è DKIM/DMARC –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ISPmanager
+   - ‚è≥ –û–∂–∏–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–∞ –≤ Brevo
+
+**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
+- `core/models.py` ‚Äî –Ω–æ–≤—ã–µ –ø–æ–ª—è Client –∏ Container
+- `core/models_website.py` ‚Äî –º–æ–¥–µ–ª—å NotificationLog
+- `core/services/email_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
+- `core/signals.py` ‚Äî —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
+- `core/admin.py` ‚Äî –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π
+- `core/admin_website.py` ‚Äî –∞–¥–º–∏–Ω–∫–∞ NotificationLog
+- `logist2/settings_base.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ email
+- `templates/email/planned_notification.html` ‚Äî —à–∞–±–ª–æ–Ω (–Ω–æ–≤—ã–π)
+- `templates/email/unload_notification.html` ‚Äî —à–∞–±–ª–æ–Ω (–Ω–æ–≤—ã–π)
+
+---
+
+### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ–∫—Ç—è–±—Ä—å 2025):
+
+**21.10.2025 - –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:**
+
+1. **–ù–ê–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ê–¢–´ –†–ê–ó–ì–†–£–ó–ö–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
+   - ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê:** –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤—Å–µ–º–∏ –¢–°
+   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ —Å–∏–≥–Ω–∞–ª `post_save` –¥–ª—è Container - —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –õ–Æ–ë–û–ú —Å–ø–æ—Å–æ–±–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
+   - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ —É–ª—É—á—à–µ–Ω –∫–æ–¥ –≤ `ContainerAdmin.save_model()` –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
+   - –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `if not car.unload_date:` - —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –í–°–ï –¢–° –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
+   - –£–ª—É—á—à–µ–Ω—ã –º–µ—Ç–æ–¥—ã `Container.sync_cars_after_warehouse_change()` –∏ `sync_cars_after_edit()`
+   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `Car.save()` - –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+   - –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `ContainerAdmin.save_formset()` - –Ω–æ–≤—ã–µ –¢–° –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—é—Ç –¥–∞—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `test_unload_date_inheritance` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
+   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ü—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—Å–µ –¢–° –≤ –Ω—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —ç—Ç—É –¥–∞—Ç—É
+
+2. **–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:** ‚ö°
+   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `bulk_update()` –≤–º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° –≤ —Ü–∏–∫–ª–µ (–æ–¥–Ω–∏–º SQL –∑–∞–ø—Ä–æ—Å–æ–º)
+   - –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
+   - –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¢–° (–≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ)
+   - –î–æ–±–∞–≤–ª–µ–Ω `select_related('warehouse')` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
+   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å 20+ –¢–° —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 10-20 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ
+
+3. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–¶–ï–ù–ö–ò –í –ò–ù–í–û–ô–°–ê–•:**
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –≤ `NewInvoiceAdmin.save_model()`
+   - ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏
+   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `test_invoice_markup` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ü–µ–Ω–∫–∏
+   - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –∏–Ω–≤–æ–π—Å—ã
+
+4. **–£–õ–£–ß–®–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê –ê–î–ú–ò–ù–ö–ò:**
+   - ‚úÖ –£–¥–∞–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫" –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–° (–Ω–µ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ "–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è" –≤ –º–µ–Ω—é Actions –¥–ª—è –¢–°
+     - –ú–∞—Å—Å–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "–ü–µ—Ä–µ–¥–∞–Ω" —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
+     - –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¢–°
+   - ‚úÖ –£–¥–∞–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–°
+
+5. **–¢–ï–°–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´:**
+   - `python manage.py test_unload_date_inheritance` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+   - `python manage.py test_invoice_markup` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∏–Ω–≤–æ–π—Å—ã
+
+**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
+- `core/admin.py` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ "–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è"
+- `core/models.py` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+- `core/signals.py` - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+- `core/admin_billing.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ Caromoto Lithuania
+- `core/models_billing.py` - —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏
+
+**20.10.2025 - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î, —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–≤–æ–π—Å–æ–≤:**
+
+1. **–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–î:**
+   - ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è production –ë–î –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä —á–µ—Ä–µ–∑ `pg_dump`/`pg_restore`
+   - ‚úÖ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
+
+2. **–£–°–õ–£–ì–ò –°–ö–õ–ê–î–û–í:**
+   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –∫ –æ–¥–Ω–æ–º—É –¢–°
+   - –ò–∑–º–µ–Ω–µ–Ω `get_warehouse_services()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
+   - –î–æ–±–∞–≤–ª–µ–Ω API endpoint `/api/warehouses/` –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞
+   - –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥–∏–µ - –∂–µ–ª—Ç—ã–π)
+   - –í—Å–µ —É—Å–ª—É–≥–∏ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –≤ –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
+
+3. **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–°–ß–ï–¢ –ò–ù–í–û–ô–°–û–í:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
+   - ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª** `update_related_on_car_save` - —É–±—Ä–∞–Ω `return` –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ NewInvoice
+   - ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¢–°:
+     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
+     - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏
+     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
+     - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
+   - ‚úÖ **–ù–∞—Ü–µ–Ω–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è** –≤ –∏–Ω–≤–æ–π—Å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
+   - ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π
+   - ‚úÖ **–°—Ç–∞—Ç—É—Å –≤ –æ–ø–∏—Å–∞–Ω–∏–∏:** `[–ü–µ—Ä–µ–¥–∞–Ω –î–ê–¢–ê]` –∏–ª–∏ `[–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –î–ê–¢–ê]`
+   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
+
+4. **–î–†–£–ì–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:**
+   - ‚úÖ **–ü–û–õ–ï CONTAINER:** –°–¥–µ–ª–∞–Ω–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –≤ –º–æ–¥–µ–ª–∏ Car (–º–∏–≥—Ä–∞—Ü–∏—è 0080)
+   - ‚úÖ **–§–û–ù–û–í–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º —Ñ–æ–Ω–æ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∞–π—Ç–∞
+     - –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ `core/static/website/images/`
+     - –î–æ–±–∞–≤–ª–µ–Ω—ã `hero-background.jpg` –∏ `caromoto_logo.png`
+
+**–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
+- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive
+- –£–ª—É—á—à–µ–Ω–∞ –∞–¥–º–∏–Ω–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
+- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä –Ω–∞ VPS (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞)
+- –î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `fix_media_permissions.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤
+- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å Google Drive (—Å—É—Ñ—Ñ–∏–∫—Å—ã)
+- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `fix_photo_names` –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
+
+## üî¥ –ê–ö–¢–ò–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (20.10.2025)
+
+### ‚ö†Ô∏è –ù–ï–†–ï–®–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä –≤ Django –∞–¥–º–∏–Ω–∫–µ –Ω–∞ VPS
+
+**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
+- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
+- –§–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Nginx
+- –í Python –∫–æ–¥–µ Django –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL —Å `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
+- –í –º–µ—Ç–æ–¥–µ `image_preview` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `_safe_media_url` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—É—Ç–µ–π
+- **–ù–û –≤ HTML –∞–¥–º–∏–Ω–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏** (`/container_photos/...` –±–µ–∑ `/media/`)
+
+**–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–æ–±–æ–≤–∞–Ω–æ:**
+1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Ñ–∞–π–ª–æ–≤ (`chown www-data:www-data`)
+2. ‚úÖ –£–±—Ä–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π `CustomFileSystemStorage` –∏–∑ `settings.py`
+3. ‚úÖ –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `MEDIA_URL`/`MEDIA_ROOT`
+4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_safe_media_url()` –≤ `ContainerPhotoAdmin`
+5. ‚úÖ –£–±—Ä–∞–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è URL –≤ –º–µ—Ç–æ–¥–µ `save()` –º–æ–¥–µ–ª–∏ `ContainerPhoto`
+6. ‚úÖ –£–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç `MediaFileInput` widget
+7. ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã: `regenerate_thumbnails`, `fix_photo_names`, `cleanup_broken_photos`
+
+**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞:**
+```python
+# Python –∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ü–†–ê–í–ò–õ–¨–ù–´–ï URL:
+obj.thumbnail.url -> '/media/container_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg'
+image_preview(obj) -> '<img src="/media/container_photos/..." />'
+
+# –ù–û –≤ HTML –±—Ä–∞—É–∑–µ—Ä–∞:
+<img src="/container_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg" />
+```
+
+**–í—ã–≤–æ–¥:**
+- –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ Python –∫–æ–¥–µ Django (–æ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL)
+- –ü—Ä–æ–±–ª–µ–º–∞ –≥–¥–µ-—Ç–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç-—Å–∞–π–¥–∞
+- –í–æ–∑–º–æ–∂–Ω–æ: JavaScript, –∫–∞—Å—Ç–æ–º–Ω—ã–µ admin templates, –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è middleware
+- –¢—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
+
+**–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π:**
+- `logist2/settings.py` - —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π storage
+- `core/admin_website.py` - –¥–æ–±–∞–≤–ª–µ–Ω `_safe_media_url()`, —É–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π import
+- `core/models_website.py` - —É–±—Ä–∞–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è URL –≤ `save()`
+
+**–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤:**
+- `core/signals.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `update_related_on_car_save`, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ NewInvoice
+- `core/models_billing.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Ü–µ–Ω–∫–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏, –∞–≤—Ç–æ–ø–µ—Ä–µ—Å—á–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è
+- `core/models.py` - `get_warehouse_services()` –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
+
+## –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
+
+### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
+```
+DB_NAME=logist2_db
+DB_USER=arturas
+DB_HOST=localhost
+DB_PORT=5432
+# –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md
+```
+
+### Django Superuser (–∞–¥–º–∏–Ω–∫–∞)
+```
+Username: arturas
+URL: https://caromoto-lt.com/admin/
+# –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md
+```
+
+### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
+```
+Nginx: www-data –∏–ª–∏ www-root
+Gunicorn: www-root
+```
+
+### AI —á–∞—Ç (–≤ `.env`)
+```
+AI_CHAT_ENABLED=True
+AI_API_KEY=...
+AI_API_BASE_URL=https://api.openai.com/v1
+AI_MODEL=gpt-4o-mini
+AI_MAX_TOKENS=400
+AI_TEMPERATURE=0.2
+AI_REQUEST_TIMEOUT=40
+AI_EMBEDDINGS_MODEL=text-embedding-3-small
+AI_RAG_INDEX_PATH=./data/ai_rag_index.json
+AI_RAG_TOP_K=6
+AI_RAG_MAX_AGE_HOURS=72
+HTTP_PROXY=
+HTTPS_PROXY=
+NO_PROXY=localhost,127.0.0.1
+```
+
+### –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
+```bash
+# Media —Ñ–∞–π–ª—ã
+chown -R www-root:www-root media/
+chmod -R 755 media/
+
+# –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
+chmod -R 775 media/container_photos/
+chmod -R 775 media/container_archives/
+```
+
+## ‚ö†Ô∏è POWERSHELL –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø (–í–ê–ñ–ù–û!)
+
+–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ Shell tool –Ω–∞ Windows –ø–æ–º–Ω–∏:
+
+### –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ PowerShell:
+- `&&` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `;` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
+- `cd path && command` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `Set-Location` –∏–ª–∏ –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏
+- –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ `"...'...'..."` ‚Äî –ø—Ä–æ–±–ª–µ–º—ã —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
+- –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ SSH ‚Äî –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –ª–æ–º–∞–µ—Ç—Å—è
+- –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ heredoc `<< EOF` ‚Äî –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
+- `$variable` –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî PowerShell –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ —Å–≤–æ—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
+
+### –ü–†–ê–í–ò–õ–¨–ù–´–ï –ü–û–î–•–û–î–´:
+
+**–î–ª—è SSH –∫–æ–º–∞–Ω–¥:**
+```powershell
+# –ü–õ–û–•–û:
+ssh root@server "cd /path && python script.py"
+
+# –•–û–†–û–®–û (–ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã):
+ssh root@server "systemctl restart gunicorn"
+ssh root@server "python manage.py migrate"
+
+# –•–û–†–û–®–û (—Å –ø—É—Ç—ë–º):
+ssh root@server "cd /var/www/www-root/data/www/logist2; source .venv/bin/activate; python manage.py migrate"
+```
+
+**–î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:**
+```powershell
+# –ü–õ–û–•–û:
+cd c:\project && python manage.py runserver
+
+# –•–û–†–û–®–û:
+c:\project\.venv\Scripts\python.exe c:\project\manage.py runserver
+```
+
+**–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
+- –ò—Å–ø–æ–ª—å–∑—É–π `deploy.ps1` —Å–∫—Ä–∏–ø—Ç
+- –ò–ª–∏ –≤—ã–ø–æ–ª–Ω—è–π –∫–æ–º–∞–Ω–¥—ã –ø–æ –æ–¥–Ω–æ–π
+- –ò–∑–±–µ–≥–∞–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö ‚Äî –ª—É—á—à–µ —Å–æ–∑–¥–∞–π —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
+
+### SSH + Python shell:
+```powershell
+# –ü–õ–û–•–û (–∫–∞–≤—ã—á–∫–∏):
+ssh root@server "python -c 'from models import X; print(X.objects.all())'"
+
+# –•–û–†–û–®–û (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):
+ssh root@server "cd /path; source .venv/bin/activate; python manage.py showmigrations"
+```
+
+---
+
+## –ü–ê–ú–Ø–¢–ö–ê –î–õ–Ø AI
+
+1. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—Å–∏—Ç
+2. **–°—Ä–∞–∑—É –¥–µ–ø–ª–æ–π** - –∏–∑–º–µ–Ω–∏ –∫–æ–¥ –∏ –∑–∞–¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ git push
+3. **SSH –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω** - –µ—Å–ª–∏ timeout, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É
+4. **–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è** - Caromoto Lithuania (–≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –Ω–µ–π)
+5. **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π gunicorn –∏ daphne
+6. **–û—á–∏—â–∞–π __pycache__** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ
+7. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î** - –∏—Å–ø–æ–ª—å–∑—É–π pg_dump/pg_restore –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å production
+8. **–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç –ª—é–±—ã—Ö —Å–∫–ª–∞–¥–æ–≤ —á–µ—Ä–µ–∑ CarService (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)
+9. **–ò–Ω–≤–æ–π—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Car —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ NewInvoice
+10. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤** - –µ—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ –Ω–µ—Ç `return` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
+11. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ planned_unload_date –∏–ª–∏ unload_date –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+12. **SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)
+13. **Brevo –¥–ª—è email** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è smtp-relay.brevo.com –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å)
+14. **SMS —á–µ—Ä–µ–∑ Brevo** - –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º (–ø–ª–∞—Ç–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–µ phone –≤ Client)
+
+## –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´
+
+### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (Linux/Bash):
+```bash
+# –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
+cd /var/www/www-root/data/www/logist2 && git pull && source .venv/bin/activate && python manage.py migrate && python manage.py collectstatic --noinput && find . -type d -name __pycache__ -delete && systemctl restart gunicorn && systemctl restart daphne
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
+systemctl is-active gunicorn daphne nginx
+
+# –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ
+journalctl -u gunicorn -n 50 --no-pager
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
+python manage.py check_photo_environment
+python manage.py regenerate_thumbnails
+
+# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π)
+./fix_media_permissions.sh
+
+# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
+cd /var/www/www-root/data/www/logist2
+PGPASSWORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_backup_$(date +%Y%m%d).dump
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ email (—á–µ—Ä–µ–∑ Brevo)
+journalctl -u gunicorn --since '10 minutes ago' --no-pager | grep -i email
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ SMTP –Ω–∞—Å—Ç—Ä–æ–µ–∫
+grep EMAIL /var/www/www-root/data/www/logist2/.env
+
+# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –≤ –ø–∞–Ω–µ–ª–∏ Brevo: https://app.brevo.com
+```
+
+### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (PowerShell):
+```powershell
+# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä
+# –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –¥–∞–º–ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
+ssh root@176.118.198.78 "cd /var/www/www-root/data/www/logist2 && PGPASSWORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_sync_backup.dump"
+
+# –®–∞–≥ 2: –°–∫–∞—á–∞—Ç—å –¥–∞–º–ø
+scp root@176.118.198.78:/var/www/www-root/data/www/logist2/logist2_sync_backup.dump .
+
+# –®–∞–≥ 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
+$env:PGPASSWORD='YOUR_DB_PASSWORD'; pg_restore -U arturas -h localhost -d logist2_db --clean --if-exists logist2_sync_backup.dump
+
+# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
+.\.venv\Scripts\activate.ps1
+py manage.py shell -c "from core.models import Car, Client, Container; print(f'Cars: {Car.objects.count()}'); print(f'Clients: {Client.objects.count()}'); print(f'Containers: {Container.objects.count()}')"
+```
+
+## –†–ï–ü–û–ó–ò–¢–û–†–ò–ô
+
+**GitHub:** https://github.com/Arturas7777/logist2.git
+**Branch:** master
+
+---
+
+**–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º.**
+
diff --git a/LOGIST2_PROGRESS_REPORT.md b/LOGIST2_PROGRESS_REPORT.md
index c553cb9..0af4672 100644
--- a/LOGIST2_PROGRESS_REPORT.md
+++ b/LOGIST2_PROGRESS_REPORT.md
@@ -1,653 +1,746 @@
-# –û—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø–æ –ø—Ä–æ–µ–∫—Ç—É Logist2
-
-**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 31 —è–Ω–≤–∞—Ä—è 2026 –≥.
-
----
-
-## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –ø—Ä–æ–º—Ç–∞
-
-–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –¥–æ—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–°:
-1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¢–° —Å 2 –¥–æ 11
-2. –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ THS –ø–æ —Ç–∏–ø–∞–º –¢–°
-3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞—Ç—å –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ THS (–ª–∏–Ω–∏—è –∏–ª–∏ —Å–∫–ª–∞–¥)
-4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –¢–°
-
----
-
-## –í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –†–ê–ë–û–¢–ê
-
-### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§–∞–π–ª:** `core/models.py` - –º–æ–¥–µ–ª—å `Car`
-
-–ë—ã–ª–æ 2 —Ç–∏–ø–∞ (CAR, MOTO), —Å—Ç–∞–ª–æ 11:
-- SEDAN (–õ–µ–≥–∫–æ–≤–æ–π), CROSSOVER (–ö—Ä–æ—Å—Å–æ–≤–µ—Ä), SUV (–î–∂–∏–ø), PICKUP (–ü–∏–∫–∞–ø)
-- NEW_CAR (–ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å), MOTO (–ú–æ—Ç–æ—Ü–∏–∫–ª), BIG_MOTO (–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª)
-- ATV (–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏), BOAT (–õ–æ–¥–∫–∞), RV (–ê–≤—Ç–æ–¥–æ–º), CONSTRUCTION (–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞)
-
-**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0089_expand_vehicle_types_and_ths_system.py`
-- –†–∞—Å—à–∏—Ä–µ–Ω `max_length` –ø–æ–ª—è —Å 10 –¥–æ 20
-- –ó–∞–ø–∏—Å–∏ —Å `CAR` –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ `SEDAN`
-
----
-
-### 2. –°–∏—Å—Ç–µ–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –ø–æ —Ç–∏–ø–∞–º –¢–° (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ú–æ–¥–µ–ª—å `LineTHSCoefficient`** –≤ `core/models.py` (—Ä–∞–Ω–µ–µ LineTHSPercent):
-- –°–≤—è–∑–∞–Ω–∞ —Å –ª–∏–Ω–∏–µ–π —á–µ—Ä–µ–∑ ForeignKey
-- –•—Ä–∞–Ω–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–°
-- unique_together: line + vehicle_type
-- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = 1.0
-
-**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0093_rename_ths_percent_to_coefficient.py`
-- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å LineTHSPercent ‚Üí LineTHSCoefficient
-- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –ø–æ–ª–µ percent ‚Üí coefficient
-- –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25
-
-**–ê–¥–º–∏–Ω–∫–∞:** `LineTHSCoefficientInline` –≤ `LineAdmin`
-
-**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS:**
-- –°—É–º–º–∞ THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º
-- –§–æ—Ä–º—É–ª–∞: THS_–¢–° = –æ–±—â–∏–π_THS √ó (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç_–¢–° / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)
-- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –≤–≤–µ—Ä—Ö –¥–æ 5 EUR
-
-**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:**
-| –¢–∏–ø –¢–° | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç |
-|--------|-------------|
-| –õ–µ–≥–∫–æ–≤–æ–π | 1.0 |
-| –ö—Ä–æ—Å—Å–æ–≤–µ—Ä | 1.2 |
-| –î–∂–∏–ø/–ü–∏–∫–∞–ø | 1.5 |
-| –ú–æ—Ç–æ—Ü–∏–∫–ª | 0.3 |
-| –ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª | 0.5 |
-| –õ–æ–¥–∫–∞ | 2.0 |
-| –ê–≤—Ç–æ–¥–æ–º (RV) | 3.0 |
-| –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ | 2.5 |
-
----
-
-### 3. –ü–æ–ª–µ "–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑" –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ü–æ–ª–µ `ths_payer`** –≤ –º–æ–¥–µ–ª–∏ `Container`:
-- LINE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='LINE'
-- WAREHOUSE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='WAREHOUSE'
-
-**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0090_update_ths_payer_labels.py`
-
----
-
-### 4. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ THS –¥–æ 5 EUR
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `round_up_to_5()` –≤–Ω—É—Ç—Ä–∏ `calculate_ths_for_container()` –≤ `core/signals.py`
-–ü—Ä–∏–º–µ—Ä: 73.12 EUR -> 75 EUR
-
----
-
-### 5. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è THS —É—Å–ª—É–≥
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-–§—É–Ω–∫—Ü–∏—è `create_ths_services_for_container()` –≤ `core/signals.py`:
-- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π THS
-- –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏
-- –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º service_type
-- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
-
-–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `ContainerAdmin.save_model()` –∏ `save_formset()`
-
----
-
-### 6. –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ü–µ–Ω (16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
-- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `current_price` –∏–∑ –º–æ–¥–µ–ª–∏ `Car`
-- –û—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ `total_price` (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ "–¶–µ–Ω–∞")
-- –¶–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ —Å—Ç–∞—Ç—É—Å–∞ "–ü–µ—Ä–µ–¥–∞–Ω"
-- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ —Ü–µ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è
-
-**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0092_remove_current_price.py`
-
----
-
-### 7. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" (16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å–ª—É–≥–∞ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π 5 EUR, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –µ—â—ë –Ω–µ –±—ã–ª–æ.
-
-**–†–µ—à–µ–Ω–∏–µ:**
-- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `rate` –∏–∑ –º–æ–¥–µ–ª–∏ `Warehouse`
-- –°—Ç–∞–≤–∫–∞ –∑–∞ –¥–µ–Ω—å —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ (`WarehouseService.default_price`)
-- –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å
-- –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç - —Ü–µ–Ω–∞ = 0
-
-**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0091_remove_warehouse_rate.py`
-
-**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ `Car`:**
-- `update_days_and_storage()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–Ω–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Å—á—ë—Ç —Ü–µ–Ω—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è
-- `_get_storage_daily_rate()` - –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
-- `_update_storage_service_price()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –≤ CarService
-
----
-
-### 8. –£–ª—É—á—à–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –ø–æ —É—Å–ª—É–≥–∞–º (16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `services_summary_display`:**
-- THS –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞)
-- –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–∫–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
-- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
-- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania
-
----
-
-### 9. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ THS –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ (16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å `ths_payer='WAREHOUSE'` —É—Å–ª—É–≥–∞ THS –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å.
-
-**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ `'warehouse'` –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª–µ–π –≤ `ContainerAdmin.save_model()`
-
----
-
-### 10. –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ (16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –í –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "‚Üª –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
-- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è THS-—É—Å–ª—É–≥–∏ –¥–ª—è –≤—Å–µ—Ö –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–†–∞–∑–≥—Ä—É–∂–µ–Ω" –∏–ª–∏ "–í –ø—É—Ç–∏"
-- –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–µ —Ü–µ–Ω—ã –¢–°
-
-**–§–∞–π–ª—ã:**
-- `templates/admin/line_change.html` - —à–∞–±–ª–æ–Ω —Å –∫–Ω–æ–ø–∫–æ–π
-- `core/admin.py` - –º–µ—Ç–æ–¥ `recalculate_ths_view()` –≤ `LineAdmin`
-
-**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
-1. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏
-2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–Ω–∏—é
-3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
-4. –î–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è "–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: X –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, Y –¢–°"
-
----
-
-### 11. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã (16.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS-—É—Å–ª—É–≥ —Ü–µ–Ω–∞ –¢–° –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –∏–∑-–∑–∞ –∫—ç—à–∞ `_prefetched_objects_cache`.
-
-**–†–µ—à–µ–Ω–∏–µ:** –í –º–µ—Ç–æ–¥–µ `calculate_total_price()` –¥–æ–±–∞–≤–ª–µ–Ω —Å–±—Ä–æ—Å –∫—ç—à–∞ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á—ë—Ç–æ–º:
-```python
-if hasattr(self, '_prefetched_objects_cache'):
-    self._prefetched_objects_cache.pop('car_services', None)
-```
-
----
-
-### 12. –°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ (17.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–¶–µ–ª—å:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫—Ä—ã—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–ø—Ä–∏–±—ã–ª—å) –ø–æ —É—Å–ª—É–≥–∞–º, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ.
-
-**–ù–æ–≤–æ–µ –ø–æ–ª–µ `markup_amount`** –≤ –º–æ–¥–µ–ª–∏ `CarService`:
-- –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏
-- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ
-- –ù–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
-
-**–ù–æ–≤–æ–µ –ø–æ–ª–µ `default_markup`** –≤ –º–æ–¥–µ–ª—è—Ö —É—Å–ª—É–≥:
-- `WarehouseService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞
-- `LineService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏
-- `CarrierService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
-- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ default_markup
-
-**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
-- `0094_add_hide_markup_in_field.py`
-- `0095_add_markup_distribution.py`
-- `0096_add_default_markup_to_services.py`
-
-**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¢–°:**
-- –†—è–¥–æ–º —Å –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–æ–π –ø–æ—è–≤–∏–ª–æ—Å—å –∂—ë–ª—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞—Ü–µ–Ω–∫–∏
-- –ù–∞—Ü–µ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –±–ª–æ–∫–∞—Ö —É—Å–ª—É–≥ (—Å–∫–ª–∞–¥, –ª–∏–Ω–∏—è, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
-- –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–∫–∏
-
-**–õ–æ–≥–∏–∫–∞ —Ü–µ–Ω:**
-- `final_price` = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏) ‚Äî –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞
-- `invoice_price` = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ + –Ω–∞—Ü–µ–Ω–∫–∞ ‚Äî –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É
-- `total_price` –¢–° = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö –Ω–∞—Ü–µ–Ω–æ–∫
-
-**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ":**
-- –ù–∞—Ü–µ–Ω–∫–∞ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π (–∫–∞–∫ –∏ —Ü–µ–Ω–∞)
-- –ü—Ä–∏ `default_markup=1` –∏ 7 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π ‚Üí –Ω–∞—Ü–µ–Ω–∫–∞ = 7 EUR
-
-**–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º (services_summary_display):**
-- –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤–∫–ª—é—á–∞—è THS –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥)
-- –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–±–µ–∑ THS)
-- –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –æ—Ç–¥–µ–ª—å–Ω–æ
-- –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º
-
-**–ò–Ω–≤–æ–π—Å:**
-- –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
-- –ù–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è Company)
-
----
-
-### 13. –û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 24.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –ï—Å–ª–∏ –≤—Å–µ –¢–° –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å `TRANSFERRED`, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ `TRANSFERRED`
-- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `Car.save()` –∏ –≤ –¥–µ–π—Å—Ç–≤–∏—è—Ö –∞–¥–º–∏–Ω–∫–∏
-
-**–§–∞–π–ª—ã:**
-- `core/models.py` ‚Äî `Container.check_and_update_status_from_cars()`, –≤—ã–∑–æ–≤ –∏–∑ `Car.save()`
-- `core/admin.py` ‚Äî –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö
-
-## –†–ï–®–Å–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´
-
-| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
-|---|----------|---------|---------|
-| 1 | THS –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º | –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ —Å–∏–≥–Ω–∞–ª–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª –ª–æ–≥–∏–∫—É | –û—Ç–∫–ª—é—á–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–£–°–õ–£–ì–ò –õ–ò–ù–ò–ò" –≤ create_car_services_on_car_save |
-| 2 | THS –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è –∫–∞–∫ LINE –≤–º–µ—Å—Ç–æ WAREHOUSE | –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ ths_payer | –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ create_ths_services_for_container() |
-| 3 | THS –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ change=True | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ save_formset() –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° |
-| 4 | –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–ª–∏—Å—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¢–° | –°–∏–≥–Ω–∞–ª update_cars_on_line_service_change | –û—Ç–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è |
-| 5 | –¶–µ–Ω–∞ –Ω–∞ 5 EUR –±–æ–ª—å—à–µ –ø—Ä–∏ 0 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π | –£—Å–ª—É–≥–∞ "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π | –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: –¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞ |
-| 6 | –§–∏–ª—å—Ç—Ä `icontains` –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª "–•—Ä–∞–Ω–µ–Ω–∏–µ" | –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –≤ PostgreSQL | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ `name='–•—Ä–∞–Ω–µ–Ω–∏–µ'` |
-| 7 | –¶–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –¢–° –æ—Ç–ª–∏—á–∞–ª–∞—Å—å –æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ | Prefetch –∫—ç—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è | –†–∞—Å—á—ë—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î –≤ `total_price_display` |
-| 8 | THS –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ | –ü–æ–ª–µ warehouse –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª–æ—Å—å | –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ ths_related_changed |
-| 9 | –ü—Ä–æ—Ü–µ–Ω—Ç—ã THS –Ω–µ–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã | –¢—Ä—É–¥–Ω–æ –ø–æ–Ω—è—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ | –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç) |
-| 10 | –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° | –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ |
-| 11 | –¶–µ–Ω–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS | –ö—ç—à car_services –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è | –°–±—Ä–æ—Å –∫—ç—à–∞ –≤ calculate_total_price() |
-| 12 | –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É | Form –≤–Ω—É—Ç—Ä–∏ form | –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Å—Å—ã–ª–∫—É (—Ç–µ–≥ `<a>`) |
-| 13 | –ù–∞—Ü–µ–Ω–∫–∞ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –≤ –∏–Ω–≤–æ–π—Å–µ | –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ "–ù–∞—Ü–µ–Ω–∫–∞ Caromoto" | –ù–∞—Ü–µ–Ω–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —É—Å–ª—É–≥–∞–º —Å–∫—Ä—ã—Ç–æ |
-| 14 | –ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –ø–æ —É—Å–ª—É–≥–∞–º | –¢–æ–ª—å–∫–æ –æ–±—â–µ–µ –ø–æ–ª–µ proft | –ñ—ë–ª—Ç—ã–µ –ø–æ–ª—è –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ |
-| 15 | –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –≤ —Å–≤–æ–¥–∫–µ | custom_price=None —Å—á–∏—Ç–∞–ª–æ—Å—å –∫–∞–∫ 0 | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è final_price —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None` |
-| 16 | THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –≤ —É—Å–ª—É–≥–∞—Ö –ª–∏–Ω–∏–π | –§–∏–ª—å—Ç—Ä –ø–æ service_type='LINE' | THS —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç service_type |
-| 17 | +5 EUR –ø—Ä–∏ 0 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π | custom_price=0 ‚Üí False ‚Üí default_price=5 | –ü—Ä–æ–≤–µ—Ä–∫–∞ `custom_price is not None` |
-| 18 | –í —É—Å–ª—É–≥–∞—Ö –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –Ω–µ—Ç —Ñ–ª–∞–≥–∞ "–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" | –ù–µ –±—ã–ª–æ –ø–æ–ª—è add_by_default | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –∏ –∏–Ω–ª–∞–π–Ω—ã –¥–ª—è LineService/CarrierService |
-| 19 | –£—Å–ª—É–≥–∞ —Å add_by_default –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¢–° | –°–∏–≥–Ω–∞–ª—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ CarService –¥–ª—è –≤—Å–µ—Ö –¢–° | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–≤—è–∑–µ–π, –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö |
-
----
-
-## –ù–ï–í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –†–ê–ë–û–¢–ê (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ–º—Ç—É)
-
-- –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
-- –û—Ç–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ (–æ—Ç—á—ë—Ç—ã/—Å–≤–æ–¥–∫–∏) –Ω–µ –≤—ã–¥–µ–ª–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å.
-
----
-
-## –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´
-
-### –ú–æ–¥–µ–ª–∏ (`core/models.py`)
-- –¢–∏–ø—ã –¢–° —Ä–∞—Å—à–∏—Ä–µ–Ω—ã –¥–æ 11
-- –ú–æ–¥–µ–ª—å `LineTHSCoefficient` –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS (—Ä–∞–Ω–µ–µ LineTHSPercent)
-- –ü–æ–ª–µ `ths_payer` –≤ `Container`
-- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `rate` –∏–∑ `Warehouse`
-- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `current_price` –∏–∑ `Car`
-- –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á—ë—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è: `update_days_and_storage()`, `_get_storage_daily_rate()`, `_update_storage_service_price()`
-- –°–±—Ä–æ—Å –∫—ç—à–∞ –≤ `calculate_total_price()`
-- **–ù–æ–≤–æ–µ:** `CarService.markup_amount` - —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è —É—Å–ª—É–≥–∏
-- **–ù–æ–≤–æ–µ:** `CarService.final_price` - —Ü–µ–Ω–∞ –±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None`)
-- **–ù–æ–≤–æ–µ:** `CarService.invoice_price` - —Ü–µ–Ω–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞
-- **–ù–æ–≤–æ–µ:** `WarehouseService.default_markup`, `LineService.default_markup`, `CarrierService.default_markup`
-- **–ù–æ–≤–æ–µ:** `calculate_total_price()` —É—á–∏—Ç—ã–≤–∞–µ—Ç markup_amount
-- **–ù–æ–≤–æ–µ:** `Container.check_and_update_status_from_cars()` + –≤—ã–∑–æ–≤ –∏–∑ `Car.save()`
-- **–ù–æ–≤–æ–µ:** `CompanyService` + —Ç–∏–ø `COMPANY` –≤ `CarService`
-- **–ù–æ–≤–æ–µ:** `LineService.add_by_default`, `CarrierService.add_by_default`
-- **–ù–æ–≤–æ–µ:** `Car.get_company_services()` –∏ —É—á—ë—Ç `company_total` –≤ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã
-
-### –ê–¥–º–∏–Ω–∫–∞ (`core/admin.py`)
-- `LineTHSCoefficientInline` –≤ LineAdmin (—Å –ø–æ–ª–µ–º coefficient –≤–º–µ—Å—Ç–æ percent)
-- `LineAdmin.recalculate_ths_view()` - –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS
-- `LineAdmin.get_urls()` - –∫–∞—Å—Ç–æ–º–Ω—ã–π URL –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞
-- `ContainerAdmin.save_model()` - –≤—ã–∑–æ–≤ THS –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ line/ths/ths_payer/warehouse
-- `ContainerAdmin.save_formset()` - –≤—ã–∑–æ–≤ THS –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–°
-- `WarehouseAdmin` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ rate
-- `CarAdmin.services_summary_display()` - —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞
-- `CarAdmin.total_price_display()` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã
-- **–ù–æ–≤–æ–µ:** –ñ—ë–ª—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞—Ü–µ–Ω–∫–∏ —Ä—è–¥–æ–º —Å –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–æ–π
-- **–ù–æ–≤–æ–µ:** `save_model()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç markup_amount –¥–ª—è —É—Å–ª—É–≥
-- **–ù–æ–≤–æ–µ:** –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤–∫–ª—é—á–∞—è THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥)
-- **–ù–æ–≤–æ–µ:** –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏
-- **–ù–æ–≤–æ–µ:** –ò–Ω–ª–∞–π–Ω `CompanyServiceInline` –≤ `CompanyAdmin`
-- **–ù–æ–≤–æ–µ:** –ë–ª–æ–∫ "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¢–°
-- **–ù–æ–≤–æ–µ:** –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ —É –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
-
-### –°–∏–≥–Ω–∞–ª—ã (`core/signals.py`)
-- `calculate_ths_for_container()` - —Ä–∞—Å—á—ë—Ç THS –ø–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º
-- `create_ths_services_for_container()` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥ THS
-- `round_up_to_5()` - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 5 EUR
-- –ò–∑–º–µ–Ω—ë–Ω —Ñ–∏–ª—å—Ç—Ä "–•—Ä–∞–Ω–µ–Ω–∏–µ" –Ω–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
-- **–ù–æ–≤–æ–µ:** –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `default_markup` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService
-- **–ù–æ–≤–æ–µ:** –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ –Ω–∞ –¥–Ω–∏ –¥–ª—è —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
-- **–ù–æ–≤–æ–µ:** –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–° (Caromoto Lithuania)
-- **–ù–æ–≤–æ–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—Å–ª—É–≥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º)
-
-### –ë–∏–ª–ª–∏–Ω–≥ (`core/models_billing.py`)
-- **–ù–æ–≤–æ–µ:** –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ
-- **–ù–æ–≤–æ–µ:** `invoice_price` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ü–µ–Ω—ã —É—Å–ª—É–≥–∏ (—Å –Ω–∞—Ü–µ–Ω–∫–æ–π)
-
-### –í—å—é—Ö–∏ (`core/views.py`)
-- **–ù–æ–≤–æ–µ:** `add_services()` –∫–æ–ø–∏—Ä—É–µ—Ç `default_price` –∏ `default_markup` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏
-- **–ù–æ–≤–æ–µ:** `get_companies()` –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `company` –≤ get_available_services/add_services
-
-### –®–∞–±–ª–æ–Ω—ã
-- `templates/admin/line_change.html` - –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
-- `templates/admin/core/car/change_form.html` - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏"
-
-### –ú–∏–≥—Ä–∞—Ü–∏–∏
-- `0089_expand_vehicle_types_and_ths_system.py`
-- `0090_update_ths_payer_labels.py`
-- `0091_remove_warehouse_rate.py`
-- `0092_remove_current_price.py`
-- `0093_rename_ths_percent_to_coefficient.py` - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
-- `0094_add_hide_markup_in_field.py` - –ø–æ–ª–µ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –Ω–∞—Ü–µ–Ω–∫–∏
-- `0095_add_markup_distribution.py` - –ø–æ–ª–µ markup_amount –≤ CarService
-- `0096_add_default_markup_to_services.py` - –ø–æ–ª–µ default_markup –≤ —É—Å–ª—É–≥–∞—Ö
-- `0099_add_default_flags_line_carrier_services.py`
-- `0100_add_company_service.py`
-- `0101_alter_carservice_service_type_and_more.py`
-
----
-
-## –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø
-
-1. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 1.0 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏)
-2. –î–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏
-3. –°—Ç–∞–≤–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞
-4. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Å –Ω—É–∂–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π –∑–∞ –¥–µ–Ω—å
-5. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
-
----
-
-### 14. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (21.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive
-
-**–§–∞–π–ª:** `core/google_drive_sync.py`
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Google Drive –ø–æ –Ω–æ–º–µ—Ä—É
-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–ø–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä "ECMU5566195 CAROMOTO D")
-- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º:
-  - `IN_CONTAINER` - —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–∞–ø–∫–∞ "KONTO VIDUS")
-  - `UNLOADING` - —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–ø–∞–ø–∫–∞ "AUTO I≈† KONTO")
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É Google Drive
-
-**Management –∫–æ–º–∞–Ω–¥–∞:** `sync_photos_gdrive`
-```bash
-python manage.py sync_photos_gdrive --no-photos  # –¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º)
-python manage.py sync_photos_gdrive --recent     # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
-python manage.py sync_photos_gdrive --container ECMU5566195  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
-```
-
-**Cron –∑–∞–¥–∞—á–∏ (sync_photos_cron.sh):**
-- –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ
-- –†–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 3:00 - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–∞–≤–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-
-#### –ì–∞–ª–µ—Ä–µ—è –≤ –∞–¥–º–∏–Ω–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-
-**–§–∞–π–ª—ã:**
-- `templates/admin/core/container/change_form.html`
-- `templates/admin/core/container/photos_gallery.html`
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –ì–∞–ª–µ—Ä–µ—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤—ë—Ä–Ω—É—Ç–∞ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
-- –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
-- –í–∫–ª–∞–¥–∫–∏ "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ" –∏ "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
-- Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä
-- Lightbox –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã—Ö —Ñ–æ—Ç–æ
-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
-
-**API endpoint:** `GET /core/container/<id>/photos-json/`
-
-#### –ì–∞–ª–µ—Ä–µ—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ
-
-**–§–∞–π–ª:** `templates/website/home.html`
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –í–∫–ª–∞–¥–∫–∏ "–í—Å–µ", "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ", "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
-- –í—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
-- –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" (–∑–µ–ª—ë–Ω–∞—è)
-- Lightbox —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
-- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ (drag —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏)
-
-**API endpoint:** `GET /api/container-photos/<container_number>/`
-- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `photo_type_code` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
-
----
-
-### 15. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ (21.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§–∞–π–ª:** `core/views_website.py` - —Ñ—É–Ω–∫—Ü–∏—è `track_shipment`
-
-**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
-- –£–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `current_price` –∏–∑ `ClientCarSerializer`
-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VIN (—É–±–∏—Ä–∞—é—Ç—Å—è –ø—Ä–æ–±–µ–ª—ã, —Ç–∏—Ä–µ)
-- –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é VIN
-- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
-
----
-
-### 16. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (21.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ VPS —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏), —Ö–æ—Ç—è —Ñ–∞–π–ª—ã –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
-
-**–ü—Ä–∏—á–∏–Ω–∞:** API endpoints –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ URL –±–µ–∑ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `/container_photos/...` –≤–º–µ—Å—Ç–æ `/media/container_photos/...`).
-
-**–†–µ—à–µ–Ω–∏–µ:**
-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ `core/views.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_container_photos_json`)
-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ `core/views_website.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_container_photos`)
-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`)
-
-**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
-```python
-# Ensure URLs have /media/ prefix
-photo_url = photo.photo.url
-if photo_url and not photo_url.startswith('/media/') and not photo_url.startswith('http'):
-    photo_url = '/media/' + photo_url.lstrip('/')
-```
-
----
-
-### 17. –£–ª—É—á—à–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ (21.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–µ–µ –º–∏–≥–∞–Ω–∏–µ –∏–∑-–∑–∞ `transform: translateY(-2px)` –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö `box-shadow`.
-
-**–†–µ—à–µ–Ω–∏–µ:**
-- –£–±—Ä–∞–Ω `transform: translateY` (–ø—Ä–∏–ø–æ–¥–Ω–∏–º–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏)
-- –£–±—Ä–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–π `box-shadow`
-- –ò–∑–º–µ–Ω—ë–Ω `transition: all` –Ω–∞ `transition: opacity` (—É–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –≤—Å–µ—Ö —Å–≤–æ–π—Å—Ç–≤)
-- –§–∏–Ω–∞–ª—å–Ω—ã–π hover-—ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–æ—Å—Ç–æ–µ `opacity: 0.85`
-
-**–§–∞–π–ª:** `core/static/website/css/style.css`
-
-**–î–æ:**
-```css
-.btn {
-    transition: all 0.3s ease;
-}
-.btn:hover {
-    transform: translateY(-2px);
-    box-shadow: 0 8px 20px rgba(0,0,0,.2);
-}
-```
-
-**–ü–æ—Å–ª–µ:**
-```css
-.btn {
-    transition: opacity 0.2s ease;
-}
-.btn:hover {
-    opacity: 0.85;
-}
-```
-
----
-
----
-
-### 21. –°—Ç–æ–ª–±–µ—Ü "–ù–∞—Ü–µ–Ω–∫–∞" (–ù) –≤ —Å–ø–∏—Å–∫–µ –¢–° (31.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –í —Å–ø–∏—Å–∫–µ –¢–° (`/admin/core/car/`) –¥–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü **"–ù"** (–ù–∞—Ü–µ–Ω–∫–∞)
-- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±—â—É—é —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
-- –ü–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π –≤—ã–≤–æ–¥–∏—Ç—Å—è **–æ–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫** –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¢–°
-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—Ç–æ–ª–±—Ü—É –Ω–∞—Ü–µ–Ω–∫–∏
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
-
-**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Django `annotate()` + `Sum()` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
-- **–û–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å** –≤–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ (–≥–¥–µ N - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–°)
-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 50-120ms –¥–ª—è 50-500 –¢–° (–≤–º–µ—Å—Ç–æ 500-5000ms –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
-- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ **10-40 —Ä–∞–∑** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¢–°
-
-**–§–∞–π–ª—ã:**
-- `core/admin.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã `markup_display()`, `get_queryset()`, `changelist_view()`
-- `templates/admin/core/car/change_list.html` - –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã
-
-**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
-```python
-# –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
-queryset.annotate(_total_markup=Sum('car_services__markup_amount'))
-
-# –†–∞—Å—á—ë—Ç –æ–±—â–µ–π —Å—É–º–º—ã –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¢–°
-total_markup_sum = queryset.aggregate(
-    total=Sum('car_services__markup_amount')
-)['total']
-```
-
-**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
-- ‚úÖ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Ü–µ–Ω–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –¢–°
-- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –æ–±—â–µ–π —Å—É–º–º—ã –Ω–∞—Ü–µ–Ω–æ–∫
-- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
-- ‚úÖ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)
-
----
-
-## –ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô
-
-| –î–∞—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
-|------|----------|
-| 14.01.2026 | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è THS —Å–∏—Å—Ç–µ–º—ã |
-| 16.01.2026 (–¥–µ–Ω—å) | –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ü–µ–Ω, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |
-| 16.01.2026 (–≤–µ—á–µ—Ä) | –ó–∞–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS", –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ |
-| 17.01.2026 | –°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏: markup_amount, default_markup, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª—É–≥–∞–º |
-| 21.01.2026 | –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º, –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ |
-| 21.01.2026 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ /media/ –ø—Ä–µ—Ñ–∏–∫—Å–∞) |
-| 21.01.2026 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–Ω–æ–ø–æ–∫ (—É–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ–π opacity) |
-| 21.01.2026 | –£–ª—É—á—à–µ–Ω–∏–µ Lightbox –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∑—É–º–µ, touch-–∂–µ—Å—Ç—ã |
-| 23.01.2026 | AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î, —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é |
-| 24.01.2026 | –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: –æ–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ TRANSFERRED |
-| 24.01.2026 | –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π, add_by_default –¥–ª—è –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏—è |
-| 24.01.2026 | –ê–¥–º–∏–Ω-–∞–≥–µ–Ω—Ç, RAG –∏–Ω–¥–µ–∫—Å, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω–∫–∏, –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è |
-| 31.01.2026 | –°—Ç–æ–ª–±–µ—Ü "–ù–∞—Ü–µ–Ω–∫–∞" (–ù) –≤ —Å–ø–∏—Å–∫–µ –¢–° —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ annotate + Sum |
-
----
-
-### 18. AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ (23.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –ü–æ–¥–∫–ª—é—á—ë–Ω AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–∑ –ë–î (VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã, —Ñ–æ—Ç–æ)
-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç–∞/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
-- –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∏ –≤—ã–¥–∞—á–∞ —Å—Ç–∞—Ç—É—Å–∞, –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞—Ç –∏ —Ñ–æ—Ç–æ
-- –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
-- –í –∞–¥–º–∏–Ω–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω —á–∞—Ç-–≤–∏–¥–µ—Ç
-
-**–§–∞–π–ª—ã:**
-- `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø–æ–∏—Å–∫ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ñ–æ—Ç–æ
-- `core/views_website.py` ‚Äî AI —á–∞—Ç, –±–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ñ–æ—Ç–æ, —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é
-- `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `.env`
-- `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
-- `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞
-- `core/static/website/js/ai-chat.js` ‚Äî CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏, fallback-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
-- `templates/website/home.html` ‚Äî –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ç–æ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º `track`/`photos`
-- `env.example`, `env.local.example` ‚Äî –ø—Ä–∏–º–µ—Ä AI –Ω–∞—Å—Ç—Ä–æ–µ–∫
-
-**–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é:**
-- `/?track=ECMU5566195&photos=1` ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-
----
-
-### 19. –°–∏—Å—Ç–µ–º–∞ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π –∏ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ª—É–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (24.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
-- –î–æ–±–∞–≤–ª–µ–Ω—ã **—É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π** (`CompanyService`) –∏ —Ç–∏–ø `COMPANY` –¥–ª—è `CarService`
-- –ö–æ–º–ø–∞–Ω–∏—è —Å—Ç–∞–ª–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥ (–≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –∫ –¢–°)
-- –î–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–π –∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `add_by_default`
-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥: —É—Å–ª—É–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–æ–ª—å—à–µ **–Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¢–°**
-- –í –∫–∞—Ä—Ç–æ—á–∫–µ –¢–° –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏" —Å –º–æ–¥–∞–ª—å–Ω—ã–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ —É –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ —É—Å–ª—É–≥ –Ω–µ—Ç)
-
-**–§–∞–π–ª—ã:**
-- `core/models.py` ‚Äî –º–æ–¥–µ–ª—å CompanyService, —Ç–∏–ø `COMPANY`, —Ä–∞—Å—á—ë—Ç totals
-- `core/admin.py` ‚Äî –∏–Ω–ª–∞–π–Ω—ã –∏ UI –¥–ª—è CompanyService, –ø—Ä–∞–≤–∫–∏ add_by_default
-- `core/signals.py` ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ add_by_default —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–°
-- `core/views.py` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `company` –≤ get_available_services/add_services
-- `templates/admin/core/car/change_form.html` ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏
-- `logist2/urls.py` ‚Äî endpoint `GET /api/companies/`
-
-**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
-- `0099_add_default_flags_line_carrier_services.py`
-- `0100_add_company_service.py`
-- `0101_alter_carservice_service_type_and_more.py`
-
----
-
-### 20. AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–¥–º–∏–Ω–∫–µ + RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç (24.01.2026)
-
-**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
-
-**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
-- –û—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ë–î –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
-- –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–¥–º–∏–Ω–∫–∏ –≤ JS (`window.__adminPageContext`)
-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–¢–°/–∏–Ω–≤–æ–π—Å–∞ + UI-–ø–æ–¥—Å–∫–∞–∑–∫–∏ "—á—Ç–æ –Ω–∞–∂–∞—Ç—å"
-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –≤–∏–¥–∂–µ—Ç–µ (–≥–æ—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)
-- RAG –∏–Ω–¥–µ–∫—Å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–∫–æ–¥—É + –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É
-- –õ–æ–≥–∏: `used_fallback`, `fallback_reason`, `admin_context` (–≤ DEBUG)
-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏ –¥–ª—è API (session.trust_env = False)
-
-**–§–∞–π–ª—ã:**
-- `core/services/admin_ai_agent.py` ‚Äî –ª–æ–≥–∏–∫–∞ –∞–¥–º–∏–Ω-–∞–≥–µ–Ω—Ç–∞, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç –ë–î
-- `core/services/ai_rag.py` ‚Äî RAG –∏–Ω–¥–µ–∫—Å, —á–∞–Ω–∫–∏, –ø–æ–∏—Å–∫, —Å–Ω–∏–ø–ø–µ—Ç—ã
-- `core/management/commands/rebuild_ai_index.py` ‚Äî –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞
-- `core/management/commands/rebuild_ai_index_if_stale.py` ‚Äî –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏–∏
-- `templates/admin/base_site.html` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–¥–º–∏–Ω–∫–∏
-- `core/static/website/js/ai-chat.js` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏, quick actions
-- `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫
-- `core/views_website.py` ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ admin/client, –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-- `core/models_website.py` + –º–∏–≥—Ä–∞—Ü–∏—è `0102_add_aichat_context_snapshot.py`
-- `logist2/settings_base.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AI_RAG_*
-- `env.example`, `env.local.example` ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è AI/RAG
-
-**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç —Ñ–æ—Ç–æ –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ VIN
-- –ó–∞—â–∏—Ç–∞ –æ—Ç ProxyError –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ API
+# –û—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø–æ –ø—Ä–æ–µ–∫—Ç—É Logist2
+
+**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 4 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥.
+
+---
+
+## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –ø—Ä–æ–º—Ç–∞
+
+–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –¥–æ—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–°:
+1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¢–° —Å 2 –¥–æ 11
+2. –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ THS –ø–æ —Ç–∏–ø–∞–º –¢–°
+3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞—Ç—å –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ THS (–ª–∏–Ω–∏—è –∏–ª–∏ —Å–∫–ª–∞–¥)
+4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –¢–°
+
+---
+
+## –í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –†–ê–ë–û–¢–ê
+
+### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§–∞–π–ª:** `core/models.py` - –º–æ–¥–µ–ª—å `Car`
+
+–ë—ã–ª–æ 2 —Ç–∏–ø–∞ (CAR, MOTO), —Å—Ç–∞–ª–æ 11:
+- SEDAN (–õ–µ–≥–∫–æ–≤–æ–π), CROSSOVER (–ö—Ä–æ—Å—Å–æ–≤–µ—Ä), SUV (–î–∂–∏–ø), PICKUP (–ü–∏–∫–∞–ø)
+- NEW_CAR (–ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å), MOTO (–ú–æ—Ç–æ—Ü–∏–∫–ª), BIG_MOTO (–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª)
+- ATV (–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏), BOAT (–õ–æ–¥–∫–∞), RV (–ê–≤—Ç–æ–¥–æ–º), CONSTRUCTION (–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞)
+
+**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0089_expand_vehicle_types_and_ths_system.py`
+- –†–∞—Å—à–∏—Ä–µ–Ω `max_length` –ø–æ–ª—è —Å 10 –¥–æ 20
+- –ó–∞–ø–∏—Å–∏ —Å `CAR` –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ `SEDAN`
+
+---
+
+### 2. –°–∏—Å—Ç–µ–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –ø–æ —Ç–∏–ø–∞–º –¢–° (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ú–æ–¥–µ–ª—å `LineTHSCoefficient`** –≤ `core/models.py` (—Ä–∞–Ω–µ–µ LineTHSPercent):
+- –°–≤—è–∑–∞–Ω–∞ —Å –ª–∏–Ω–∏–µ–π —á–µ—Ä–µ–∑ ForeignKey
+- –•—Ä–∞–Ω–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–°
+- unique_together: line + vehicle_type
+- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = 1.0
+
+**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0093_rename_ths_percent_to_coefficient.py`
+- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å LineTHSPercent ‚Üí LineTHSCoefficient
+- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –ø–æ–ª–µ percent ‚Üí coefficient
+- –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25
+
+**–ê–¥–º–∏–Ω–∫–∞:** `LineTHSCoefficientInline` –≤ `LineAdmin`
+
+**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS:**
+- –°—É–º–º–∞ THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º
+- –§–æ—Ä–º—É–ª–∞: THS_–¢–° = –æ–±—â–∏–π_THS √ó (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç_–¢–° / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)
+- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –≤–≤–µ—Ä—Ö –¥–æ 5 EUR
+
+**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:**
+| –¢–∏–ø –¢–° | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç |
+|--------|-------------|
+| –õ–µ–≥–∫–æ–≤–æ–π | 1.0 |
+| –ö—Ä–æ—Å—Å–æ–≤–µ—Ä | 1.2 |
+| –î–∂–∏–ø/–ü–∏–∫–∞–ø | 1.5 |
+| –ú–æ—Ç–æ—Ü–∏–∫–ª | 0.3 |
+| –ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª | 0.5 |
+| –õ–æ–¥–∫–∞ | 2.0 |
+| –ê–≤—Ç–æ–¥–æ–º (RV) | 3.0 |
+| –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ | 2.5 |
+
+---
+
+### 3. –ü–æ–ª–µ "–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑" –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ü–æ–ª–µ `ths_payer`** –≤ –º–æ–¥–µ–ª–∏ `Container`:
+- LINE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='LINE'
+- WAREHOUSE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='WAREHOUSE'
+
+**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0090_update_ths_payer_labels.py`
+
+---
+
+### 4. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ THS –¥–æ 5 EUR
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `round_up_to_5()` –≤–Ω—É—Ç—Ä–∏ `calculate_ths_for_container()` –≤ `core/signals.py`
+–ü—Ä–∏–º–µ—Ä: 73.12 EUR -> 75 EUR
+
+---
+
+### 5. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è THS —É—Å–ª—É–≥
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+–§—É–Ω–∫—Ü–∏—è `create_ths_services_for_container()` –≤ `core/signals.py`:
+- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π THS
+- –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏
+- –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º service_type
+- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
+
+–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `ContainerAdmin.save_model()` –∏ `save_formset()`
+
+---
+
+### 6. –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ü–µ–Ω (16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
+- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `current_price` –∏–∑ –º–æ–¥–µ–ª–∏ `Car`
+- –û—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ `total_price` (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ "–¶–µ–Ω–∞")
+- –¶–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ —Å—Ç–∞—Ç—É—Å–∞ "–ü–µ—Ä–µ–¥–∞–Ω"
+- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ —Ü–µ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è
+
+**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0092_remove_current_price.py`
+
+---
+
+### 7. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" (16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å–ª—É–≥–∞ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π 5 EUR, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –µ—â—ë –Ω–µ –±—ã–ª–æ.
+
+**–†–µ—à–µ–Ω–∏–µ:**
+- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `rate` –∏–∑ –º–æ–¥–µ–ª–∏ `Warehouse`
+- –°—Ç–∞–≤–∫–∞ –∑–∞ –¥–µ–Ω—å —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ (`WarehouseService.default_price`)
+- –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å
+- –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç - —Ü–µ–Ω–∞ = 0
+
+**–ú–∏–≥—Ä–∞—Ü–∏—è:** `0091_remove_warehouse_rate.py`
+
+**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ `Car`:**
+- `update_days_and_storage()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–Ω–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Å—á—ë—Ç —Ü–µ–Ω—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è
+- `_get_storage_daily_rate()` - –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
+- `_update_storage_service_price()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –≤ CarService
+
+---
+
+### 8. –£–ª—É—á—à–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –ø–æ —É—Å–ª—É–≥–∞–º (16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `services_summary_display`:**
+- THS –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞)
+- –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–∫–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
+- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
+- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania
+
+---
+
+### 9. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ THS –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ (16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å `ths_payer='WAREHOUSE'` —É—Å–ª—É–≥–∞ THS –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å.
+
+**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ `'warehouse'` –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª–µ–π –≤ `ContainerAdmin.save_model()`
+
+---
+
+### 10. –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ (16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –í –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "‚Üª –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
+- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è THS-—É—Å–ª—É–≥–∏ –¥–ª—è –≤—Å–µ—Ö –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–†–∞–∑–≥—Ä—É–∂–µ–Ω" –∏–ª–∏ "–í –ø—É—Ç–∏"
+- –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–µ —Ü–µ–Ω—ã –¢–°
+
+**–§–∞–π–ª—ã:**
+- `templates/admin/line_change.html` - —à–∞–±–ª–æ–Ω —Å –∫–Ω–æ–ø–∫–æ–π
+- `core/admin.py` - –º–µ—Ç–æ–¥ `recalculate_ths_view()` –≤ `LineAdmin`
+
+**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
+1. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏
+2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–Ω–∏—é
+3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
+4. –î–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è "–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: X –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, Y –¢–°"
+
+---
+
+### 11. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã (16.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS-—É—Å–ª—É–≥ —Ü–µ–Ω–∞ –¢–° –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –∏–∑-–∑–∞ –∫—ç—à–∞ `_prefetched_objects_cache`.
+
+**–†–µ—à–µ–Ω–∏–µ:** –í –º–µ—Ç–æ–¥–µ `calculate_total_price()` –¥–æ–±–∞–≤–ª–µ–Ω —Å–±—Ä–æ—Å –∫—ç—à–∞ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á—ë—Ç–æ–º:
+```python
+if hasattr(self, '_prefetched_objects_cache'):
+    self._prefetched_objects_cache.pop('car_services', None)
+```
+
+---
+
+### 12. –°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ (17.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–¶–µ–ª—å:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫—Ä—ã—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–ø—Ä–∏–±—ã–ª—å) –ø–æ —É—Å–ª—É–≥–∞–º, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ.
+
+**–ù–æ–≤–æ–µ –ø–æ–ª–µ `markup_amount`** –≤ –º–æ–¥–µ–ª–∏ `CarService`:
+- –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏
+- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ
+- –ù–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
+
+**–ù–æ–≤–æ–µ –ø–æ–ª–µ `default_markup`** –≤ –º–æ–¥–µ–ª—è—Ö —É—Å–ª—É–≥:
+- `WarehouseService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞
+- `LineService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏
+- `CarrierService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ default_markup
+
+**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
+- `0094_add_hide_markup_in_field.py`
+- `0095_add_markup_distribution.py`
+- `0096_add_default_markup_to_services.py`
+
+**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¢–°:**
+- –†—è–¥–æ–º —Å –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–æ–π –ø–æ—è–≤–∏–ª–æ—Å—å –∂—ë–ª—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞—Ü–µ–Ω–∫–∏
+- –ù–∞—Ü–µ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –±–ª–æ–∫–∞—Ö —É—Å–ª—É–≥ (—Å–∫–ª–∞–¥, –ª–∏–Ω–∏—è, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
+- –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–∫–∏
+
+**–õ–æ–≥–∏–∫–∞ —Ü–µ–Ω:**
+- `final_price` = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏) ‚Äî –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞
+- `invoice_price` = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ + –Ω–∞—Ü–µ–Ω–∫–∞ ‚Äî –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É
+- `total_price` –¢–° = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö –Ω–∞—Ü–µ–Ω–æ–∫
+
+**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ":**
+- –ù–∞—Ü–µ–Ω–∫–∞ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π (–∫–∞–∫ –∏ —Ü–µ–Ω–∞)
+- –ü—Ä–∏ `default_markup=1` –∏ 7 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π ‚Üí –Ω–∞—Ü–µ–Ω–∫–∞ = 7 EUR
+
+**–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º (services_summary_display):**
+- –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤–∫–ª—é—á–∞—è THS –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥)
+- –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–±–µ–∑ THS)
+- –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –æ—Ç–¥–µ–ª—å–Ω–æ
+- –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º
+
+**–ò–Ω–≤–æ–π—Å:**
+- –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
+- –ù–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è Company)
+
+---
+
+### 13. –û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 24.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –ï—Å–ª–∏ –≤—Å–µ –¢–° –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å `TRANSFERRED`, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ `TRANSFERRED`
+- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `Car.save()` –∏ –≤ –¥–µ–π—Å—Ç–≤–∏—è—Ö –∞–¥–º–∏–Ω–∫–∏
+
+**–§–∞–π–ª—ã:**
+- `core/models.py` ‚Äî `Container.check_and_update_status_from_cars()`, –≤—ã–∑–æ–≤ –∏–∑ `Car.save()`
+- `core/admin.py` ‚Äî –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö
+
+## –†–ï–®–Å–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´
+
+| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
+|---|----------|---------|---------|
+| 1 | THS –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º | –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ —Å–∏–≥–Ω–∞–ª–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª –ª–æ–≥–∏–∫—É | –û—Ç–∫–ª—é—á–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–£–°–õ–£–ì–ò –õ–ò–ù–ò–ò" –≤ create_car_services_on_car_save |
+| 2 | THS –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è –∫–∞–∫ LINE –≤–º–µ—Å—Ç–æ WAREHOUSE | –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ ths_payer | –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ create_ths_services_for_container() |
+| 3 | THS –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ change=True | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ save_formset() –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° |
+| 4 | –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–ª–∏—Å—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¢–° | –°–∏–≥–Ω–∞–ª update_cars_on_line_service_change | –û—Ç–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è |
+| 5 | –¶–µ–Ω–∞ –Ω–∞ 5 EUR –±–æ–ª—å—à–µ –ø—Ä–∏ 0 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π | –£—Å–ª—É–≥–∞ "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π | –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: –¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞ |
+| 6 | –§–∏–ª—å—Ç—Ä `icontains` –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª "–•—Ä–∞–Ω–µ–Ω–∏–µ" | –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –≤ PostgreSQL | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ `name='–•—Ä–∞–Ω–µ–Ω–∏–µ'` |
+| 7 | –¶–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –¢–° –æ—Ç–ª–∏—á–∞–ª–∞—Å—å –æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ | Prefetch –∫—ç—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è | –†–∞—Å—á—ë—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î –≤ `total_price_display` |
+| 8 | THS –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ | –ü–æ–ª–µ warehouse –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª–æ—Å—å | –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ ths_related_changed |
+| 9 | –ü—Ä–æ—Ü–µ–Ω—Ç—ã THS –Ω–µ–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã | –¢—Ä—É–¥–Ω–æ –ø–æ–Ω—è—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ | –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç) |
+| 10 | –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° | –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ |
+| 11 | –¶–µ–Ω–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS | –ö—ç—à car_services –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è | –°–±—Ä–æ—Å –∫—ç—à–∞ –≤ calculate_total_price() |
+| 12 | –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É | Form –≤–Ω—É—Ç—Ä–∏ form | –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Å—Å—ã–ª–∫—É (—Ç–µ–≥ `<a>`) |
+| 13 | –ù–∞—Ü–µ–Ω–∫–∞ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –≤ –∏–Ω–≤–æ–π—Å–µ | –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ "–ù–∞—Ü–µ–Ω–∫–∞ Caromoto" | –ù–∞—Ü–µ–Ω–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —É—Å–ª—É–≥–∞–º —Å–∫—Ä—ã—Ç–æ |
+| 14 | –ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –ø–æ —É—Å–ª—É–≥–∞–º | –¢–æ–ª—å–∫–æ –æ–±—â–µ–µ –ø–æ–ª–µ proft | –ñ—ë–ª—Ç—ã–µ –ø–æ–ª—è –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ |
+| 15 | –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –≤ —Å–≤–æ–¥–∫–µ | custom_price=None —Å—á–∏—Ç–∞–ª–æ—Å—å –∫–∞–∫ 0 | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è final_price —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None` |
+| 16 | THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –≤ —É—Å–ª—É–≥–∞—Ö –ª–∏–Ω–∏–π | –§–∏–ª—å—Ç—Ä –ø–æ service_type='LINE' | THS —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç service_type |
+| 17 | +5 EUR –ø—Ä–∏ 0 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π | custom_price=0 ‚Üí False ‚Üí default_price=5 | –ü—Ä–æ–≤–µ—Ä–∫–∞ `custom_price is not None` |
+| 18 | –í —É—Å–ª—É–≥–∞—Ö –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –Ω–µ—Ç —Ñ–ª–∞–≥–∞ "–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" | –ù–µ –±—ã–ª–æ –ø–æ–ª—è add_by_default | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –∏ –∏–Ω–ª–∞–π–Ω—ã –¥–ª—è LineService/CarrierService |
+| 19 | –£—Å–ª—É–≥–∞ —Å add_by_default –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¢–° | –°–∏–≥–Ω–∞–ª—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ CarService –¥–ª—è –≤—Å–µ—Ö –¢–° | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–≤—è–∑–µ–π, –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö |
+
+---
+
+## –ù–ï–í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –†–ê–ë–û–¢–ê (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ–º—Ç—É)
+
+- –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
+- –û—Ç–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ (–æ—Ç—á—ë—Ç—ã/—Å–≤–æ–¥–∫–∏) –Ω–µ –≤—ã–¥–µ–ª–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å.
+
+---
+
+## –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´
+
+### –ú–æ–¥–µ–ª–∏ (`core/models.py`)
+- –¢–∏–ø—ã –¢–° —Ä–∞—Å—à–∏—Ä–µ–Ω—ã –¥–æ 11
+- –ú–æ–¥–µ–ª—å `LineTHSCoefficient` –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS (—Ä–∞–Ω–µ–µ LineTHSPercent)
+- –ü–æ–ª–µ `ths_payer` –≤ `Container`
+- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `rate` –∏–∑ `Warehouse`
+- –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `current_price` –∏–∑ `Car`
+- –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á—ë—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è: `update_days_and_storage()`, `_get_storage_daily_rate()`, `_update_storage_service_price()`
+- –°–±—Ä–æ—Å –∫—ç—à–∞ –≤ `calculate_total_price()`
+- **–ù–æ–≤–æ–µ:** `CarService.markup_amount` - —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è —É—Å–ª—É–≥–∏
+- **–ù–æ–≤–æ–µ:** `CarService.final_price` - —Ü–µ–Ω–∞ –±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None`)
+- **–ù–æ–≤–æ–µ:** `CarService.invoice_price` - —Ü–µ–Ω–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞
+- **–ù–æ–≤–æ–µ:** `WarehouseService.default_markup`, `LineService.default_markup`, `CarrierService.default_markup`
+- **–ù–æ–≤–æ–µ:** `calculate_total_price()` —É—á–∏—Ç—ã–≤–∞–µ—Ç markup_amount
+- **–ù–æ–≤–æ–µ:** `Container.check_and_update_status_from_cars()` + –≤—ã–∑–æ–≤ –∏–∑ `Car.save()`
+- **–ù–æ–≤–æ–µ:** `CompanyService` + —Ç–∏–ø `COMPANY` –≤ `CarService`
+- **–ù–æ–≤–æ–µ:** `LineService.add_by_default`, `CarrierService.add_by_default`
+- **–ù–æ–≤–æ–µ:** `Car.get_company_services()` –∏ —É—á—ë—Ç `company_total` –≤ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã
+
+### –ê–¥–º–∏–Ω–∫–∞ (`core/admin.py`)
+- `LineTHSCoefficientInline` –≤ LineAdmin (—Å –ø–æ–ª–µ–º coefficient –≤–º–µ—Å—Ç–æ percent)
+- `LineAdmin.recalculate_ths_view()` - –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS
+- `LineAdmin.get_urls()` - –∫–∞—Å—Ç–æ–º–Ω—ã–π URL –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞
+- `ContainerAdmin.save_model()` - –≤—ã–∑–æ–≤ THS –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ line/ths/ths_payer/warehouse
+- `ContainerAdmin.save_formset()` - –≤—ã–∑–æ–≤ THS –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–°
+- `WarehouseAdmin` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ rate
+- `CarAdmin.services_summary_display()` - —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞
+- `CarAdmin.total_price_display()` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã
+- **–ù–æ–≤–æ–µ:** –ñ—ë–ª—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞—Ü–µ–Ω–∫–∏ —Ä—è–¥–æ–º —Å –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–æ–π
+- **–ù–æ–≤–æ–µ:** `save_model()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç markup_amount –¥–ª—è —É—Å–ª—É–≥
+- **–ù–æ–≤–æ–µ:** –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤–∫–ª—é—á–∞—è THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥)
+- **–ù–æ–≤–æ–µ:** –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏
+- **–ù–æ–≤–æ–µ:** –ò–Ω–ª–∞–π–Ω `CompanyServiceInline` –≤ `CompanyAdmin`
+- **–ù–æ–≤–æ–µ:** –ë–ª–æ–∫ "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¢–°
+- **–ù–æ–≤–æ–µ:** –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ —É –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
+
+### –°–∏–≥–Ω–∞–ª—ã (`core/signals.py`)
+- `calculate_ths_for_container()` - —Ä–∞—Å—á—ë—Ç THS –ø–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º
+- `create_ths_services_for_container()` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥ THS
+- `round_up_to_5()` - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 5 EUR
+- –ò–∑–º–µ–Ω—ë–Ω —Ñ–∏–ª—å—Ç—Ä "–•—Ä–∞–Ω–µ–Ω–∏–µ" –Ω–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
+- **–ù–æ–≤–æ–µ:** –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `default_markup` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService
+- **–ù–æ–≤–æ–µ:** –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ –Ω–∞ –¥–Ω–∏ –¥–ª—è —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
+- **–ù–æ–≤–æ–µ:** –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–° (Caromoto Lithuania)
+- **–ù–æ–≤–æ–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—Å–ª—É–≥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º)
+
+### –ë–∏–ª–ª–∏–Ω–≥ (`core/models_billing.py`)
+- **–ù–æ–≤–æ–µ:** –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ
+- **–ù–æ–≤–æ–µ:** `invoice_price` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ü–µ–Ω—ã —É—Å–ª—É–≥–∏ (—Å –Ω–∞—Ü–µ–Ω–∫–æ–π)
+
+### –í—å—é—Ö–∏ (`core/views.py`)
+- **–ù–æ–≤–æ–µ:** `add_services()` –∫–æ–ø–∏—Ä—É–µ—Ç `default_price` –∏ `default_markup` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏
+- **–ù–æ–≤–æ–µ:** `get_companies()` –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `company` –≤ get_available_services/add_services
+
+### –®–∞–±–ª–æ–Ω—ã
+- `templates/admin/line_change.html` - –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
+- `templates/admin/core/car/change_form.html` - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏"
+
+### –ú–∏–≥—Ä–∞—Ü–∏–∏
+- `0089_expand_vehicle_types_and_ths_system.py`
+- `0090_update_ths_payer_labels.py`
+- `0091_remove_warehouse_rate.py`
+- `0092_remove_current_price.py`
+- `0093_rename_ths_percent_to_coefficient.py` - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
+- `0094_add_hide_markup_in_field.py` - –ø–æ–ª–µ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –Ω–∞—Ü–µ–Ω–∫–∏
+- `0095_add_markup_distribution.py` - –ø–æ–ª–µ markup_amount –≤ CarService
+- `0096_add_default_markup_to_services.py` - –ø–æ–ª–µ default_markup –≤ —É—Å–ª—É–≥–∞—Ö
+- `0099_add_default_flags_line_carrier_services.py`
+- `0100_add_company_service.py`
+- `0101_alter_carservice_service_type_and_more.py`
+
+---
+
+## –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø
+
+1. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 1.0 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏)
+2. –î–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏
+3. –°—Ç–∞–≤–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞
+4. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Å –Ω—É–∂–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π –∑–∞ –¥–µ–Ω—å
+5. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
+
+---
+
+### 14. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (21.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive
+
+**–§–∞–π–ª:** `core/google_drive_sync.py`
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Google Drive –ø–æ –Ω–æ–º–µ—Ä—É
+- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–ø–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä "ECMU5566195 CAROMOTO D")
+- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º:
+  - `IN_CONTAINER` - —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–∞–ø–∫–∞ "KONTO VIDUS")
+  - `UNLOADING` - —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–ø–∞–ø–∫–∞ "AUTO I≈† KONTO")
+- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É Google Drive
+
+**Management –∫–æ–º–∞–Ω–¥–∞:** `sync_photos_gdrive`
+```bash
+python manage.py sync_photos_gdrive --no-photos  # –¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º)
+python manage.py sync_photos_gdrive --recent     # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
+python manage.py sync_photos_gdrive --container ECMU5566195  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
+```
+
+**Cron –∑–∞–¥–∞—á–∏ (sync_photos_cron.sh):**
+- –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ
+- –†–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 3:00 - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–∞–≤–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+
+#### –ì–∞–ª–µ—Ä–µ—è –≤ –∞–¥–º–∏–Ω–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+
+**–§–∞–π–ª—ã:**
+- `templates/admin/core/container/change_form.html`
+- `templates/admin/core/container/photos_gallery.html`
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –ì–∞–ª–µ—Ä–µ—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤—ë—Ä–Ω—É—Ç–∞ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
+- –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
+- –í–∫–ª–∞–¥–∫–∏ "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ" –∏ "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
+- Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä
+- Lightbox –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã—Ö —Ñ–æ—Ç–æ
+- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
+
+**API endpoint:** `GET /core/container/<id>/photos-json/`
+
+#### –ì–∞–ª–µ—Ä–µ—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ
+
+**–§–∞–π–ª:** `templates/website/home.html`
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –í–∫–ª–∞–¥–∫–∏ "–í—Å–µ", "–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ", "–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ"
+- –í—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
+- –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" (–∑–µ–ª—ë–Ω–∞—è)
+- Lightbox —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
+- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ (drag —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏)
+
+**API endpoint:** `GET /api/container-photos/<container_number>/`
+- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `photo_type_code` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
+
+---
+
+### 15. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ (21.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§–∞–π–ª:** `core/views_website.py` - —Ñ—É–Ω–∫—Ü–∏—è `track_shipment`
+
+**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
+- –£–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `current_price` –∏–∑ `ClientCarSerializer`
+- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VIN (—É–±–∏—Ä–∞—é—Ç—Å—è –ø—Ä–æ–±–µ–ª—ã, —Ç–∏—Ä–µ)
+- –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é VIN
+- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
+
+---
+
+### 16. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (21.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ VPS —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏), —Ö–æ—Ç—è —Ñ–∞–π–ª—ã –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
+
+**–ü—Ä–∏—á–∏–Ω–∞:** API endpoints –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ URL –±–µ–∑ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `/container_photos/...` –≤–º–µ—Å—Ç–æ `/media/container_photos/...`).
+
+**–†–µ—à–µ–Ω–∏–µ:**
+- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ `core/views.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_container_photos_json`)
+- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ `core/views_website.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_container_photos`)
+- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`)
+
+**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
+```python
+# Ensure URLs have /media/ prefix
+photo_url = photo.photo.url
+if photo_url and not photo_url.startswith('/media/') and not photo_url.startswith('http'):
+    photo_url = '/media/' + photo_url.lstrip('/')
+```
+
+---
+
+### 17. –£–ª—É—á—à–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ (21.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–µ–µ –º–∏–≥–∞–Ω–∏–µ –∏–∑-–∑–∞ `transform: translateY(-2px)` –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö `box-shadow`.
+
+**–†–µ—à–µ–Ω–∏–µ:**
+- –£–±—Ä–∞–Ω `transform: translateY` (–ø—Ä–∏–ø–æ–¥–Ω–∏–º–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏)
+- –£–±—Ä–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–π `box-shadow`
+- –ò–∑–º–µ–Ω—ë–Ω `transition: all` –Ω–∞ `transition: opacity` (—É–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –≤—Å–µ—Ö —Å–≤–æ–π—Å—Ç–≤)
+- –§–∏–Ω–∞–ª—å–Ω—ã–π hover-—ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–æ—Å—Ç–æ–µ `opacity: 0.85`
+
+**–§–∞–π–ª:** `core/static/website/css/style.css`
+
+**–î–æ:**
+```css
+.btn {
+    transition: all 0.3s ease;
+}
+.btn:hover {
+    transform: translateY(-2px);
+    box-shadow: 0 8px 20px rgba(0,0,0,.2);
+}
+```
+
+**–ü–æ—Å–ª–µ:**
+```css
+.btn {
+    transition: opacity 0.2s ease;
+}
+.btn:hover {
+    opacity: 0.85;
+}
+```
+
+---
+
+---
+
+### 21. –°—Ç–æ–ª–±–µ—Ü "–ù–∞—Ü–µ–Ω–∫–∞" (–ù) –≤ —Å–ø–∏—Å–∫–µ –¢–° (31.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –í —Å–ø–∏—Å–∫–µ –¢–° (`/admin/core/car/`) –¥–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü **"–ù"** (–ù–∞—Ü–µ–Ω–∫–∞)
+- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±—â—É—é —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
+- –ü–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π –≤—ã–≤–æ–¥–∏—Ç—Å—è **–æ–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫** –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¢–°
+- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—Ç–æ–ª–±—Ü—É –Ω–∞—Ü–µ–Ω–∫–∏
+- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
+
+**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
+- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Django `annotate()` + `Sum()` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
+- **–û–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å** –≤–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ (–≥–¥–µ N - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–°)
+- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 50-120ms –¥–ª—è 50-500 –¢–° (–≤–º–µ—Å—Ç–æ 500-5000ms –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
+- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ **10-40 —Ä–∞–∑** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¢–°
+
+**–§–∞–π–ª—ã:**
+- `core/admin.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã `markup_display()`, `get_queryset()`, `changelist_view()`
+- `templates/admin/core/car/change_list.html` - –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã
+
+**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
+```python
+# –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
+queryset.annotate(_total_markup=Sum('car_services__markup_amount'))
+
+# –†–∞—Å—á—ë—Ç –æ–±—â–µ–π —Å—É–º–º—ã –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¢–°
+total_markup_sum = queryset.aggregate(
+    total=Sum('car_services__markup_amount')
+)['total']
+```
+
+**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
+- ‚úÖ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Ü–µ–Ω–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –¢–°
+- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –æ–±—â–µ–π —Å—É–º–º—ã –Ω–∞—Ü–µ–Ω–æ–∫
+- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
+- ‚úÖ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)
+
+---
+
+### 22. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É (04.02.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–¶–µ–ª—å:** –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¢–° –∫–ª–∏–µ–Ω—Ç–∞–º —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –∏–Ω–≤–æ–π—Å–æ–≤.
+
+**–ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏:**
+
+1. **CarrierTruck** - –∞–≤—Ç–æ–≤–æ–∑—ã –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+   - `carrier` - —Å–≤—è–∑—å —Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–º
+   - `truck_number`, `trailer_number` - –Ω–æ–º–µ—Ä–∞ —Ç—è–≥–∞—á–∞ –∏ –ø—Ä–∏—Ü–µ–ø–∞
+   - `full_number` (property) - –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ "XXXXX / YYYYY"
+   - `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
+
+2. **CarrierDriver** - –≤–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+   - `carrier` - —Å–≤—è–∑—å —Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–º
+   - `first_name`, `last_name` - –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è
+   - `phone` - —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è
+   - `full_name` (property) - –ø–æ–ª–Ω–æ–µ –∏–º—è "–ò–º—è –§–∞–º–∏–ª–∏—è"
+   - `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
+
+3. **AutoTransport** - –∞–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
+   - `number` - –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: AT-YYYYMMDD-NNNN)
+   - `carrier` - –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫
+   - `eori_code` - EORI –∫–æ–¥ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞)
+   - `truck`, `driver` - —Å—Å—ã–ª–∫–∏ –Ω–∞ CarrierTruck –∏ CarrierDriver
+   - `truck_number_manual`, `trailer_number_manual`, `driver_name_manual` - —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –µ—Å–ª–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ
+   - `driver_phone` - —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)
+   - `border_crossing` - –≥—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
+   - `cars` - ManyToMany —Å–≤—è–∑—å —Å –¢–°
+   - `loading_date`, `departure_date`, `estimated_delivery_date`, `actual_delivery_date` - –¥–∞—Ç—ã
+   - `status` - DRAFT, FORMED, LOADED, IN_TRANSIT, DELIVERED, CANCELLED
+   - `created_by` - –∫—Ç–æ —Å–æ–∑–¥–∞–ª
+
+**–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Carrier:**
+- `eori_code` - EORI –∫–æ–¥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+- –°–≤—è–∑–∏: `trucks` (CarrierTruck), `drivers` (CarrierDriver), `auto_transports` (AutoTransport)
+
+**–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ NewInvoice:**
+- `auto_transport` - ForeignKey –∫ AutoTransport (—Å–≤—è–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å —Å –∞–≤—Ç–æ–≤–æ–∑–æ–º)
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+
+1. **–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞:**
+   - –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è EORI –∫–æ–¥
+   - –ü–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è —Å–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+   - –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–æ–¥–∏—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω
+
+2. **–í—ã–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:**
+   - Select2 —Å –ø–æ–∏—Å–∫–æ–º –ø–æ VIN/–º–∞—Ä–∫–µ (–∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–∞—Ö)
+   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å
+   - –¶–≤–µ—Ç–Ω—ã–µ —Ç–µ–≥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É –¢–°
+   - –ò–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
+
+3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤:**
+   - –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã
+   - –û—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω–≤–æ–π—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, —á—å–∏ –¢–° –≤ –∞–≤—Ç–æ–≤–æ–∑–µ
+   - –ï—Å–ª–∏ –≤—Å–µ –¢–° –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ - —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–Ω–≤–æ–π—Å
+   - –ò–Ω–≤–æ–π—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –∞–≤—Ç–æ–≤–æ–∑–∞
+
+4. **–°–∏–≥–Ω–∞–ª—ã:**
+   - `autotransport_post_save` - —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
+   - `autotransport_cars_changed_handler` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¢–°
+
+**API endpoints:**
+- `GET /core/api/autotransport/carrier-info/<carrier_id>/` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–µ (EORI, –∞–≤—Ç–æ–≤–æ–∑—ã, –≤–æ–¥–∏—Ç–µ–ª–∏)
+- `GET /core/api/autotransport/driver-phone/<driver_id>/` - —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è
+- `GET /core/api/autotransport/border-crossings/` - —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–Ω–∏—Ü –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
+- `POST /core/api/autotransport/create-truck/` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞
+- `POST /core/api/autotransport/create-driver/` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
+
+**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
+- –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (templates/admin/core/autotransport/change_form.html)
+- –ö—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏
+- Sidebar —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–≤—Ç–æ–≤–æ–∑–µ –∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–∞—Ö
+- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—ã–±–æ—Ä–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–∞—Ö
+
+**–§–∞–π–ª—ã:**
+- `core/models.py` - –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ CarrierTruck, CarrierDriver, AutoTransport, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ Carrier
+- `core/models_billing.py` - –ø–æ–ª–µ auto_transport –≤ NewInvoice
+- `core/admin.py` - AutoTransportAdmin —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º
+- `core/views_autotransport.py` - API endpoints (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
+- `core/signals.py` - —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–æ–≤
+- `templates/admin/core/autotransport/change_form.html` - –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω
+- `core/static/css/autotransport.css` - —Å—Ç–∏–ª–∏
+- `core/urls.py` - —Ä–æ—É—Ç–∏–Ω–≥ API endpoints
+
+**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
+- `0103_carrier_eori_code_autotransport_and_more.py`
+
+---
+
+## –ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô
+
+| –î–∞—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
+|------|----------|
+| 14.01.2026 | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è THS —Å–∏—Å—Ç–µ–º—ã |
+| 16.01.2026 (–¥–µ–Ω—å) | –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ü–µ–Ω, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |
+| 16.01.2026 (–≤–µ—á–µ—Ä) | –ó–∞–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS", –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ |
+| 17.01.2026 | –°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏: markup_amount, default_markup, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª—É–≥–∞–º |
+| 21.01.2026 | –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º, –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ |
+| 21.01.2026 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ /media/ –ø—Ä–µ—Ñ–∏–∫—Å–∞) |
+| 21.01.2026 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–Ω–æ–ø–æ–∫ (—É–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ–π opacity) |
+| 21.01.2026 | –£–ª—É—á—à–µ–Ω–∏–µ Lightbox –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∑—É–º–µ, touch-–∂–µ—Å—Ç—ã |
+| 23.01.2026 | AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î, —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é |
+| 24.01.2026 | –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: –æ–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ TRANSFERRED |
+| 24.01.2026 | –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π, add_by_default –¥–ª—è –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏—è |
+| 24.01.2026 | –ê–¥–º–∏–Ω-–∞–≥–µ–Ω—Ç, RAG –∏–Ω–¥–µ–∫—Å, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω–∫–∏, –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è |
+| 31.01.2026 | –°—Ç–æ–ª–±–µ—Ü "–ù–∞—Ü–µ–Ω–∫–∞" (–ù) –≤ —Å–ø–∏—Å–∫–µ –¢–° —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ annotate + Sum |
+| 04.02.2026 | –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É: —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–≤–æ–∑–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ |
+
+---
+
+### 18. AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ (23.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –ü–æ–¥–∫–ª—é—á—ë–Ω AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–∑ –ë–î (VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã, —Ñ–æ—Ç–æ)
+- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç–∞/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
+- –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∏ –≤—ã–¥–∞—á–∞ —Å—Ç–∞—Ç—É—Å–∞, –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞—Ç –∏ —Ñ–æ—Ç–æ
+- –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
+- –í –∞–¥–º–∏–Ω–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω —á–∞—Ç-–≤–∏–¥–µ—Ç
+
+**–§–∞–π–ª—ã:**
+- `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø–æ–∏—Å–∫ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ñ–æ—Ç–æ
+- `core/views_website.py` ‚Äî AI —á–∞—Ç, –±–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ñ–æ—Ç–æ, —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é
+- `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `.env`
+- `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
+- `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞
+- `core/static/website/js/ai-chat.js` ‚Äî CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏, fallback-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
+- `templates/website/home.html` ‚Äî –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ç–æ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º `track`/`photos`
+- `env.example`, `env.local.example` ‚Äî –ø—Ä–∏–º–µ—Ä AI –Ω–∞—Å—Ç—Ä–æ–µ–∫
+
+**–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é:**
+- `/?track=ECMU5566195&photos=1` ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+
+---
+
+### 19. –°–∏—Å—Ç–µ–º–∞ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π –∏ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ª—É–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (24.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
+- –î–æ–±–∞–≤–ª–µ–Ω—ã **—É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π** (`CompanyService`) –∏ —Ç–∏–ø `COMPANY` –¥–ª—è `CarService`
+- –ö–æ–º–ø–∞–Ω–∏—è —Å—Ç–∞–ª–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥ (–≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –∫ –¢–°)
+- –î–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–π –∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `add_by_default`
+- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥: —É—Å–ª—É–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–æ–ª—å—à–µ **–Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¢–°**
+- –í –∫–∞—Ä—Ç–æ—á–∫–µ –¢–° –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏" —Å –º–æ–¥–∞–ª—å–Ω—ã–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
+- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ —É –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ —É—Å–ª—É–≥ –Ω–µ—Ç)
+
+**–§–∞–π–ª—ã:**
+- `core/models.py` ‚Äî –º–æ–¥–µ–ª—å CompanyService, —Ç–∏–ø `COMPANY`, —Ä–∞—Å—á—ë—Ç totals
+- `core/admin.py` ‚Äî –∏–Ω–ª–∞–π–Ω—ã –∏ UI –¥–ª—è CompanyService, –ø—Ä–∞–≤–∫–∏ add_by_default
+- `core/signals.py` ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ add_by_default —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–°
+- `core/views.py` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `company` –≤ get_available_services/add_services
+- `templates/admin/core/car/change_form.html` ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏
+- `logist2/urls.py` ‚Äî endpoint `GET /api/companies/`
+
+**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
+- `0099_add_default_flags_line_carrier_services.py`
+- `0100_add_company_service.py`
+- `0101_alter_carservice_service_type_and_more.py`
+
+---
+
+### 20. AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–¥–º–∏–Ω–∫–µ + RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç (24.01.2026)
+
+**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
+
+**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
+- –û—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ë–î –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
+- –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–¥–º–∏–Ω–∫–∏ –≤ JS (`window.__adminPageContext`)
+- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–¢–°/–∏–Ω–≤–æ–π—Å–∞ + UI-–ø–æ–¥—Å–∫–∞–∑–∫–∏ "—á—Ç–æ –Ω–∞–∂–∞—Ç—å"
+- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –≤–∏–¥–∂–µ—Ç–µ (–≥–æ—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)
+- RAG –∏–Ω–¥–µ–∫—Å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–∫–æ–¥—É + –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É
+- –õ–æ–≥–∏: `used_fallback`, `fallback_reason`, `admin_context` (–≤ DEBUG)
+- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏ –¥–ª—è API (session.trust_env = False)
+
+**–§–∞–π–ª—ã:**
+- `core/services/admin_ai_agent.py` ‚Äî –ª–æ–≥–∏–∫–∞ –∞–¥–º–∏–Ω-–∞–≥–µ–Ω—Ç–∞, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç –ë–î
+- `core/services/ai_rag.py` ‚Äî RAG –∏–Ω–¥–µ–∫—Å, —á–∞–Ω–∫–∏, –ø–æ–∏—Å–∫, —Å–Ω–∏–ø–ø–µ—Ç—ã
+- `core/management/commands/rebuild_ai_index.py` ‚Äî –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞
+- `core/management/commands/rebuild_ai_index_if_stale.py` ‚Äî –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏–∏
+- `templates/admin/base_site.html` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–¥–º–∏–Ω–∫–∏
+- `core/static/website/js/ai-chat.js` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏, quick actions
+- `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫
+- `core/views_website.py` ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ admin/client, –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+- `core/models_website.py` + –º–∏–≥—Ä–∞—Ü–∏—è `0102_add_aichat_context_snapshot.py`
+- `logist2/settings_base.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AI_RAG_*
+- `env.example`, `env.local.example` ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è AI/RAG
+
+**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
+- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç —Ñ–æ—Ç–æ –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ VIN
+- –ó–∞—â–∏—Ç–∞ –æ—Ç ProxyError –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ API
 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ `logger is not defined` –≤ `ai_chat`
\ No newline at end of file
diff --git a/PROMT_LOGIST2.md b/PROMT_LOGIST2.md
index 3f48d69..78c43b5 100644
--- a/PROMT_LOGIST2.md
+++ b/PROMT_LOGIST2.md
@@ -1,856 +1,942 @@
-# –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê LOGIST2
-
-**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 31 —è–Ω–≤–∞—Ä—è 2026  
-**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏
-
----
-
-## üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
-
-**–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:** Logist2 (Caromoto Lithuania)  
-**–¢–∏–ø:** Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏  
-**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ä—Å–∫–∏–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –¢–°, —Å–∫–ª–∞–¥–∞–º–∏, –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏
-
-### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
-
-| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
-|-----------|------------|
-| Backend | Django 5.1.7, Python 3.10-3.12 |
-| API | Django REST Framework |
-| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | PostgreSQL (—Ç–µ—Å—Ç—ã ‚Äî SQLite –≤ `settings_test.py`) |
-| Web-—Å–µ—Ä–≤–µ—Ä | Nginx + Gunicorn, —Å—Ç–∞—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ WhiteNoise |
-| WebSockets | Django Channels + Daphne (Redis –≤ `settings_base.py`, InMemory –≤ `settings.py`) |
-| –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | HTMX + –∫–∞—Å—Ç–æ–º–Ω—ã–π JS |
-| UI —Å–∞–π—Ç–∞ | Bootstrap 5 |
-| Email | Brevo (SMTP) |
-| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | Google Drive API |
-
-### –°–µ—Ä–≤–µ—Ä
-
-- **IP:** 176.118.198.78
-- **–î–æ–º–µ–Ω:** https://caromoto-lt.com
-- **–ü—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:** `/var/www/www-root/data/www/logist2`
-
----
-
-## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ò–ï–†–ê–†–•–ò–Ø –î–ê–ù–ù–´–•
-
-### –ì–ª–∞–≤–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è
-
-```
-–ö–û–ù–¢–ï–ô–ù–ï–† (Container) ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, "—Ä–æ–¥–∏—Ç–µ–ª—å"
-    ‚îÇ
-    ‚îú‚îÄ‚îÄ –ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è (Line)
-    ‚îú‚îÄ‚îÄ –°–∫–ª–∞–¥ (Warehouse)
-    ‚îú‚îÄ‚îÄ THS (—Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –ª–∏–Ω–∏—è–º –∑–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
-    ‚îÇ
-    ‚îî‚îÄ‚îÄ –ê–í–¢–û–ú–û–ë–ò–õ–ò (Car) ‚Äî "–¥–µ—Ç–∏", –Ω–∞—Å–ª–µ–¥—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-            ‚îÇ
-            ‚îú‚îÄ‚îÄ –ö–ª–∏–µ–Ω—Ç (Client) ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –¢–°
-            ‚îú‚îÄ‚îÄ –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ (Carrier) ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –¢–° –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-            ‚îÇ
-            ‚îî‚îÄ‚îÄ –£–°–õ–£–ì–ò (CarService) ‚Äî —Å–≤—è–∑—å –¢–° —Å —É—Å–ª—É–≥–∞–º–∏
-                    ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (LINE) ‚Äî –≤–∫–ª—é—á–∞—è THS
-                    ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (WAREHOUSE) ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Ä–∞–∑–≥—Ä—É–∑–∫–∞ –∏ –¥—Ä.
-                    ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (CARRIER)
-                    ‚îî‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ (COMPANY)
-```
-
-### –ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
-
-**–í–ê–ñ–ù–û:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –¢–° –≤–Ω—É—Ç—Ä–∏:
-
-| –ü–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤ –¢–° | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
-|-----------------|------------------|------------|
-| `status` | ‚úÖ –î–∞ | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¢–° |
-| `warehouse` | ‚úÖ –î–∞ | –°–∫–ª–∞–¥ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° |
-| `unload_date` | ‚úÖ –î–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) | –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è |
-| `line` | ‚úÖ –î–∞ | –õ–∏–Ω–∏—è –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° |
-| `ths` | ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è | THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ —Ç–∏–ø–∞–º –¢–° |
-
-**–û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –ö–æ–≥–¥–∞ –í–°–ï –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω" ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–æ–∂–µ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω".
-
----
-
-## üì¶ –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–•
-
-### Container (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä)
-
-```python
-# –§–∞–π–ª: core/models.py
-
-Container:
-    number              # –ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
-    status              # FLOATING (–í –ø—É—Ç–∏), IN_PORT (–í –ø–æ—Ä—Ç—É), UNLOADED (–†–∞–∑–≥—Ä—É–∂–µ–Ω), TRANSFERRED (–ü–µ—Ä–µ–¥–∞–Ω)
-    line                # FK ‚Üí Line (–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è)
-    warehouse           # FK ‚Üí Warehouse (–°–∫–ª–∞–¥ —Ä–∞–∑–≥—Ä—É–∑–∫–∏)
-    client              # FK ‚Üí Client (–∫–ª–∏–µ–Ω—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-    customs_procedure   # –¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (TRANSIT/IMPORT/REEXPORT/EXPORT)
-    
-    # THS —Å–∏—Å—Ç–µ–º–∞
-    ths                 # Decimal ‚Äî –æ–±—â–∞—è —Å—É–º–º–∞ THS –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
-    ths_payer           # LINE –∏–ª–∏ WAREHOUSE ‚Äî –∫–æ–º—É –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS
-    sklad               # –û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-    dekl                # –î–µ–∫–ª–∞—Ä–∞—Ü–∏—è (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-    proft               # –ù–∞—Ü–µ–Ω–∫–∞ (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-    
-    # –î–∞—Ç—ã
-    eta                 # –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è
-    planned_unload_date # "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å" ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email –∫–ª–∏–µ–Ω—Ç–∞–º
-    unload_date         # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email
-    unloaded_status_at  # –ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å "–†–∞–∑–≥—Ä—É–∂–µ–Ω"
-    
-    # –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (legacy —Ä–∞—Å—á—ë—Ç)
-    free_days           # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
-    days                # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
-    rate                # –°—Ç–∞–≤–∫–∞ (legacy)
-    storage_cost        # –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (legacy)
-    notes               # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
-    
-    # Google Drive
-    google_drive_folder_url  # –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-```
-
-**–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–†–∞–∑–≥—Ä—É–∂–µ–Ω" –ø–æ–ª—è `warehouse` –∏ `unload_date` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.
-
-### Car (–ê–≤—Ç–æ–º–æ–±–∏–ª—å/–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ)
-
-```python
-# –§–∞–π–ª: core/models.py
-
-Car:
-    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
-    vin                 # VIN –Ω–æ–º–µ—Ä (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π, 17 —Å–∏–º–≤–æ–ª–æ–≤)
-    brand               # –ú–∞—Ä–∫–∞ (Toyota, BMW –∏ —Ç.–¥.)
-    year                # –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
-    
-    # –¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ù–û–ì–û –°–†–ï–î–°–¢–í–ê (11 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
-    vehicle_type:
-        SEDAN           # –õ–µ–≥–∫–æ–≤–æ–π (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS: 1.0)
-        CROSSOVER       # –ö—Ä–æ—Å—Å–æ–≤–µ—Ä (1.2)
-        SUV             # –î–∂–∏–ø (1.5)
-        PICKUP          # –ü–∏–∫–∞–ø (1.5)
-        NEW_CAR         # –ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å (1.0)
-        MOTO            # –ú–æ—Ç–æ—Ü–∏–∫–ª (0.3)
-        BIG_MOTO        # –ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª (0.5)
-        ATV             # –ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏ (0.5)
-        BOAT            # –õ–æ–¥–∫–∞ (2.0)
-        RV              # –ê–≤—Ç–æ–¥–æ–º (3.0)
-        CONSTRUCTION    # –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ (2.5)
-    
-    # –°–≤—è–∑–∏
-    container           # FK ‚Üí Container (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL –¥–ª—è –¢–° –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-    client              # FK ‚Üí Client (–≤–ª–∞–¥–µ–ª–µ—Ü)
-    warehouse           # FK ‚Üí Warehouse (—Å–∫–ª–∞–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
-    line                # FK ‚Üí Line (–º–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è)
-    carrier             # FK ‚Üí Carrier (–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
-    
-    # –°—Ç–∞—Ç—É—Å –∏ –¥–∞—Ç—ã
-    status              # –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-    unload_date         # –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
-    transfer_date       # –î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–ª–∏–µ–Ω—Ç—É
-    
-    # –•—Ä–∞–Ω–µ–Ω–∏–µ
-    free_days           # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–∏–∑ —Å–∫–ª–∞–¥–∞)
-    days                # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
-    storage_cost        # –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞)
-    
-    # –¶–µ–Ω–∞
-    total_price         # –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + –Ω–∞—Ü–µ–Ω–∫–∏
-    proft               # –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania (legacy –ø–æ–ª–µ)
-    hide_markup_in      # FK ‚Üí CarService (–≤ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Å–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É)
-    
-    # –î–æ–∫—É–º–µ–Ω—Ç—ã
-    has_title           # –ï—Å—Ç—å –ª–∏ Title
-    title_notes         # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ Title
-
-    # –î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã (legacy –ø–æ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Å—Ç–∞—Ä—ã—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö/–æ—Ç—á–µ—Ç–∞—Ö)
-    unload_fee, delivery_fee, loading_fee, docs_fee, transfer_fee
-    transit_declaration, export_declaration, extra_costs, complex_fee
-    price, auction_fee, transport_usa, ocean_freight, transport_kz
-    broker_fee, additional_expenses, rate
-```
-
-### CarService (–°–≤—è–∑—å –¢–° —Å —É—Å–ª—É–≥–∞–º–∏)
-
-```python
-# –§–∞–π–ª: core/models.py
-
-CarService:
-    car                 # FK ‚Üí Car
-    service_type        # LINE, WAREHOUSE, CARRIER –∏–ª–∏ COMPANY
-    service_id          # ID —É—Å–ª—É–≥–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ (LineService/WarehouseService/CarrierService/CompanyService)
-    custom_price        # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π)
-    markup_amount       # –°–ö–†–´–¢–ê–Ø –ù–ê–¶–ï–ù–ö–ê (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ –≤ –∏–Ω–≤–æ–π—Å–µ, –Ω–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ)
-    quantity            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–æ–±—ã—á–Ω–æ 1)
-    notes               # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
-    
-    # –°–≤–æ–π—Å—Ç–≤–∞ (property)
-    final_price         # = custom_price √ó quantity (–ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏, –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞)
-    invoice_price       # = (custom_price + markup_amount) √ó quantity (–¥–ª—è –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É)
-```
-
-### –£—Å–ª—É–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
-
-```python
-# –§–∞–π–ª: core/models.py
-
-LineService:            # –£—Å–ª—É–≥–∏ –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π
-    line                # FK ‚Üí Line
-    name                # "THS MAERSK 3 –ê–í–¢–û", "–î–æ–∫—É–º–µ–Ω—Ç—ã" –∏ —Ç.–¥.
-    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
-    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏
-
-WarehouseService:       # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤
-    warehouse           # FK ‚Üí Warehouse
-    name                # "–•—Ä–∞–Ω–µ–Ω–∏–µ", "–†–∞–∑–≥—Ä—É–∑–∫–∞", "–î–æ–∫—É–º–µ–Ω—Ç—ã" –∏ —Ç.–¥.
-    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è "–•—Ä–∞–Ω–µ–Ω–∏–µ" ‚Äî —Å—Ç–∞–≤–∫–∞ –∑–∞ –î–ï–ù–¨)
-    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è "–•—Ä–∞–Ω–µ–Ω–∏–µ" ‚Äî –Ω–∞—Ü–µ–Ω–∫–∞ –∑–∞ –î–ï–ù–¨)
-    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
-    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ
-
-CarrierService:         # –£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
-    carrier             # FK ‚Üí Carrier
-    name                # "–î–æ—Å—Ç–∞–≤–∫–∞", "–ü–æ–≥—Ä—É–∑–∫–∞" –∏ —Ç.–¥.
-    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
-    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
-
-CompanyService:         # –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π
-    company             # FK ‚Üí Company (Caromoto Lithuania –∏ –¥—Ä.)
-    name                # "–î–æ–∫—É–º–µ–Ω—Ç—ã", "–ö–æ–º–∏—Å—Å–∏—è" –∏ —Ç.–¥.
-    description         # –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
-    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
-    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –∫–æ–º–ø–∞–Ω–∏–∏
-```
-
-### LineTHSCoefficient (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS)
-
-```python
-# –§–∞–π–ª: core/models.py
-
-LineTHSCoefficient:
-    line                # FK ‚Üí Line
-    vehicle_type        # –¢–∏–ø –¢–° (SEDAN, MOTO –∏ —Ç.–¥.)
-    coefficient         # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS
-    
-    # –ü—Ä–∏–º–µ—Ä: –õ–∏–Ω–∏—è MAERSK
-    # SEDAN: 1.0, SUV: 1.5, MOTO: 0.3, BOAT: 2.0
-```
-
----
-
-## üí∞ –°–ò–°–¢–ï–ú–ê THS (TERMINAL HANDLING SURCHARGE)
-
-### –ß—Ç–æ —Ç–∞–∫–æ–µ THS
-
-THS ‚Äî —ç—Ç–æ —Å–±–æ—Ä –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –ø–æ—Ä—Ç—É. –°—É–º–º–∞ THS —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¢–° –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö "–≤–µ—Å—É" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É).
-
-### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS
-
-```
-1. –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—É–º–º—É THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø–æ–ª—É—á–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –µ–≥–æ —Ç–∏–ø–∞ –∏–∑ LineTHSCoefficient
-3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª—é: THS_–¢–° = –æ–±—â–∏–π_THS √ó (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)
-4. –û–∫—Ä—É–≥–ª–∏—Ç—å –í–í–ï–†–• –¥–æ 5 EUR (73.12 ‚Üí 75 EUR)
-```
-
-### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞
-
-```
-–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR
-3 –¢–°: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(1.5) + –º–æ—Ç–æ(0.3) = —Å—É–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 2.8
-
-- –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/2.8) = 178.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 180 EUR
-- –î–∂–∏–ø: 500 √ó (1.5/2.8) = 267.86 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 270 EUR  
-- –ú–æ—Ç–æ: 500 √ó (0.3/2.8) = 53.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 55 EUR
-```
-
-### –ü–æ–ª–µ ths_payer
-
-–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –æ—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°:
-
-| –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ |
-|----------|----------|---------------------|
-| `LINE` | –û–ø–ª–∞—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ | CarService —Å service_type='LINE' |
-| `WAREHOUSE` | –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ | CarService —Å service_type='WAREHOUSE' |
-
-**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WAREHOUSE:** –ò–Ω–æ–≥–¥–∞ —Å–∫–ª–∞–¥ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç THS –ª–∏–Ω–∏–∏ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏, –∞ –ø–æ—Ç–æ–º –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á—ë—Ç –Ω–∞–º. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ THS –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞.
-
-### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
-
-```python
-# –§–∞–π–ª: core/signals.py
-
-calculate_ths_for_container(container)
-    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º
-    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {car_id: ths_amount}
-
-create_ths_services_for_container(container)
-    # –°–æ–∑–¥–∞—ë—Ç CarService –∑–∞–ø–∏—Å–∏ —Å THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-    # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
-    # –¢–∏–ø —É—Å–ª—É–≥–∏ (LINE/WAREHOUSE) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–ª–µ–º ths_payer
-
-round_up_to_5(value)
-    # –û–∫—Ä—É–≥–ª—è–µ—Ç –≤–≤–µ—Ä—Ö —Å —à–∞–≥–æ–º 5 EUR
-    # –ü—Ä–∏–º–µ—Ä: 73.12 ‚Üí 75
-```
-
-### –ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è THS
-
-1. **–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** ‚Äî –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è: `line`, `ths`, `ths_payer`, `warehouse`
-2. **–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"** –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏
-
----
-
-## üè≠ –°–ò–°–¢–ï–ú–ê –£–°–õ–£–ì –°–ö–õ–ê–î–û–í
-
-### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
-
-–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –Ω–∞ —Å–∫–ª–∞–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —É—Å–ª—É–≥–∏ —Å —Ñ–ª–∞–≥–æ–º `add_by_default=True`.
-
-**–î–ª—è –ª–∏–Ω–∏–π, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –∏ –∫–æ–º–ø–∞–Ω–∏–π:**
-- –õ–æ–≥–∏–∫–∞ `add_by_default` —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–∫–ª–∞–¥–∞–º
-- –£—Å–ª—É–≥–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–°**, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¢–° –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è
-
-**–¢–∏–ø–∏—á–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞:**
-- **–•—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî —Ü–µ–Ω–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å
-- **–†–∞–∑–≥—Ä—É–∑–∫–∞** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞
-- **–î–æ–∫—É–º–µ–Ω—Ç—ã** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞
-- **–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞
-
-### –£—Å–ª—É–≥–∞ "–•—Ä–∞–Ω–µ–Ω–∏–µ" ‚Äî –æ—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞
-
-```python
-# –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏:
-
-storage_price = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å
-storage_markup = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å
-
-# –ì–¥–µ:
-# - –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ = (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –¥–∞—Ç–∞_–ø–µ—Ä–µ–¥–∞—á–∏) - –¥–∞—Ç–∞_—Ä–∞–∑–≥—Ä—É–∑–∫–∏ - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏
-# - —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ WarehouseService.default_price –¥–ª—è —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
-# - –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ WarehouseService.default_markup
-```
-
-**–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç (–¢–° –µ—â—ë –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏) ‚Äî —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" = 0.
-
-### –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
-
-- –£–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–∫–ª–∞–¥–∞ (`Warehouse.free_days`)
-- –ù–∞—Å–ª–µ–¥—É—é—Ç—Å—è –≤ –¢–° –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞
-- –í–ª–∏—è—é—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
-
----
-
-## üíµ –°–ò–°–¢–ï–ú–ê –ù–ê–¶–ï–ù–ö–ò (MARKUP)
-
-### –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞
-
-–ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania ‚Äî —ç—Ç–æ –ø—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —É—Å–ª—É–≥–∞–º.
-
-### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
-
-```python
-CarService.markup_amount  # –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏
-
-# –¶–µ–Ω—ã:
-final_price = custom_price √ó quantity              # –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞
-invoice_price = (custom_price + markup_amount) √ó quantity  # –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞
-```
-
-### –ü—Ä–∏–º–µ—Ä
-
-```
-–£—Å–ª—É–≥–∞ "–†–∞–∑–≥—Ä—É–∑–∫–∞":
-- custom_price = 50 EUR
-- markup_amount = 10 EUR
-- –í –∏–Ω–≤–æ–π—Å–µ –∫–ª–∏–µ–Ω—Ç—É: 60 EUR (–∫–ª–∏–µ–Ω—Ç –Ω–µ –≤–∏–¥–∏—Ç, —á—Ç–æ 10 EUR ‚Äî —ç—Ç–æ –Ω–∞—Ü–µ–Ω–∫–∞)
-```
-
-### –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-
-–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ `default_markup` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —É—Å–ª—É–≥–∏ (LineService, WarehouseService, CarrierService).
-
----
-
-## üìß EMAIL-–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
-
-### –¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
-
-| –°–æ–±—ã—Ç–∏–µ | –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –ö–æ–º—É |
-|---------|-----------------|------|
-| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `planned_unload_date` | "–ü–ª–∞–Ω–∏—Ä—É–µ–º —Ä–∞–∑–≥—Ä—É–∑–∫—É" | –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ |
-| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `unload_date` | "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≥—Ä—É–∂–µ–Ω" | –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ |
-
-### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
-
-```python
-Client:
-    email               # –û—Å–Ω–æ–≤–Ω–æ–π email
-    email2, email3, email4  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ email
-    notification_enabled    # –ü–æ–ª—É—á–∞—Ç—å –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
-```
-
-### Email-—Å–µ—Ä–≤–∏—Å
-
-```python
-# –§–∞–π–ª: core/services/email_service.py
-
-ContainerNotificationService:
-    send_planned_to_all_clients(container)  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ
-    send_unload_to_all_clients(container)   # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ
-    was_planned_notification_sent(container)  # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
-    was_unload_notification_sent(container)   # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
-```
-
-### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
-
-–í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –º–æ–¥–µ–ª–∏ `NotificationLog`. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.
-
----
-
-## üìÑ –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í
-
-### –ú–æ–¥–µ–ª—å NewInvoice
-
-```python
-# –§–∞–π–ª: core/models_billing.py
-
-NewInvoice:
-    number              # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: INV-202601-0001)
-    date                # –î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è
-    due_date            # –°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é +14 –¥–Ω–µ–π)
-    
-    # –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–û–î–ò–ù –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö)
-    issuer_company      # FK ‚Üí Company (Caromoto Lithuania)
-    issuer_warehouse    # FK ‚Üí Warehouse
-    issuer_line         # FK ‚Üí Line
-    issuer_carrier      # FK ‚Üí Carrier
-    
-    # –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–û–î–ò–ù –∏–∑ –ø—è—Ç–∏)
-    recipient_client    # FK ‚Üí Client
-    recipient_warehouse # FK ‚Üí Warehouse
-    recipient_line      # FK ‚Üí Line
-    recipient_carrier   # FK ‚Üí Carrier
-    recipient_company   # FK ‚Üí Company
-    
-    # –§–∏–Ω–∞–Ω—Å—ã
-    subtotal            # –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
-    discount            # –°–∫–∏–¥–∫–∞
-    tax                 # –ù–∞–ª–æ–≥
-    total               # –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ
-    paid_amount         # –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ
-    
-    # –°–≤—è–∑—å —Å –¢–°
-    cars                # ManyToMany ‚Üí Car (–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¢–°)
-    
-    status              # DRAFT, ISSUED, PARTIALLY_PAID, PAID, OVERDUE, CANCELLED
-```
-
-### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
-
-–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¢–° –≤ –∏–Ω–≤–æ–π—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥ (CarService).
-
-**–õ–æ–≥–∏–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è:**
-
-| –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å | –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è |
-|-------------|------------------------|
-| Company (Caromoto Lithuania) | –í–°–ï —É—Å–ª—É–≥–∏ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ + —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º) |
-| Warehouse | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ |
-| Line | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–π –ª–∏–Ω–∏–∏ |
-| Carrier | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ |
-
-### –ú–µ—Ç–æ–¥ regenerate_items_from_cars()
-
-```python
-# –§–∞–π–ª: core/models_billing.py ‚Üí NewInvoice
-
-regenerate_items_from_cars():
-    # 1. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞
-    # 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–°:
-    #    - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ (update_days_and_storage)
-    #    - –°–æ–∑–¥–∞—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ CarService
-    # 3. –î–ª—è Company: –¥–æ–±–∞–≤–ª—è–µ—Ç markup_amount –∫ —Ü–µ–Ω–∞–º (—Å–∫—Ä—ã—Ç–æ)
-    # 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–∏
-```
-
-### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –∏–Ω–≤–æ–π—Å–æ–≤
-
-–ò–Ω–≤–æ–π—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏:
-- –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –¢–° (CarService)
-- –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¢–° (–¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å—Ç–∞—Ç—É—Å)
-
-–≠—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã –≤ `core/signals.py`.
-
----
-
-## üì∏ –§–û–¢–û–ì–†–ê–§–ò–ò –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
-
-### Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
-
-```python
-# –§–∞–π–ª: core/google_drive_sync.py
-
-GoogleDriveSync:
-    sync_container_by_number(container_number)  # –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É
-    download_folder_photos(folder_url, container)  # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ
-```
-
-### –¢–∏–ø—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
-
-| –¢–∏–ø | –ö–æ–¥ | –ü–∞–ø–∫–∞ –Ω–∞ Google Drive |
-|-----|-----|----------------------|
-| –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | `IN_CONTAINER` | "KONTO VIDUS" |
-| –í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ | `UNLOADING` | "AUTO I≈† KONTO" |
-
-### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
-
-–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏:
-- –£—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ "–†–∞–∑–≥—Ä—É–∂–µ–Ω"
-- –£—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-
-### Management –∫–æ–º–∞–Ω–¥–∞
-
-```bash
-python manage.py sync_photos_gdrive --no-photos     # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ
-python manage.py sync_photos_gdrive --recent        # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
-python manage.py sync_photos_gdrive --container ECMU5566195  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
-```
-
----
-
-## ü§ñ AI-–ü–û–ú–û–©–ù–ò–ö
-
-### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
-- –ß–∞—Ç-–≤–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ
-- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –ë–î: VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ
-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—ã/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
-- –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
-- –í –∞–¥–º–∏–Ω–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
-- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `page_context` + –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Admin-Chat`
-- RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã–º —Ñ–∞–π–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞
-- –í AIChat —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `context_snapshot` (page context)
-
-### –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é
-- `/?track=<–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ
-
-### Endpoint
-- `POST /api/ai-chat/` ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `message`, `session_id`, `page_context`
-
-### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`
-```
-AI_CHAT_ENABLED=True
-AI_API_KEY=...
-AI_API_BASE_URL=https://api.openai.com/v1
-AI_MODEL=gpt-4o-mini
-AI_MAX_TOKENS=400
-AI_TEMPERATURE=0.2
-AI_REQUEST_TIMEOUT=40
-AI_EMBEDDINGS_MODEL=text-embedding-3-small
-AI_RAG_INDEX_PATH=./data/ai_rag_index.json
-AI_RAG_TOP_K=6
-AI_RAG_MAX_AGE_HOURS=72
-HTTP_PROXY=
-HTTPS_PROXY=
-NO_PROXY=localhost,127.0.0.1
-```
-
-### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
-- `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI, —Å–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤—ã–∑–æ–≤ API
-- `core/services/admin_ai_agent.py` ‚Äî –∞–¥–º–∏–Ω-–∞–≥–µ–Ω—Ç, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, UI-–ø–æ–¥—Å–∫–∞–∑–∫–∏
-- `core/services/ai_rag.py` ‚Äî RAG –∏–Ω–¥–µ–∫—Å, –ø–æ–∏—Å–∫, —Å–Ω–∏–ø–ø–µ—Ç—ã
-- `core/views_website.py` ‚Äî endpoint –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (—Ñ–∏–Ω–∞–Ω—Å—ã/—Ñ–æ—Ç–æ/—Å—Å—ã–ª–∫–∏)
-- `core/static/website/js/ai-chat.js` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç, CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
-- `templates/admin/base_site.html` + `core/static/admin/css/ai-chat.css` ‚Äî –≤–∏–¥–∂–µ—Ç –≤ –∞–¥–º–∏–Ω–∫–µ
-- `core/management/commands/rebuild_ai_index.py`
-- `core/management/commands/rebuild_ai_index_if_stale.py`
-
-## üîß –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í
-
-### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
-
-```
-logist2/
-‚îú‚îÄ‚îÄ core/                           # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
-‚îÇ   ‚îú‚îÄ‚îÄ models.py                   # –ì–ª–∞–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Container, Car, CarService –∏ –¥—Ä.)
-‚îÇ   ‚îú‚îÄ‚îÄ models_billing.py           # –ò–Ω–≤–æ–π—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (NewInvoice, InvoiceItem)
-‚îÇ   ‚îú‚îÄ‚îÄ models_website.py           # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
-‚îÇ   ‚îÇ
-‚îÇ   ‚îú‚îÄ‚îÄ admin.py                    # Django Admin (ContainerAdmin, CarAdmin, LineAdmin)
-‚îÇ   ‚îú‚îÄ‚îÄ admin_billing.py            # Admin –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
-‚îÇ   ‚îú‚îÄ‚îÄ admin_website.py            # Admin –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
-‚îÇ   ‚îÇ
-‚îÇ   ‚îú‚îÄ‚îÄ signals.py                  # –°–∏–≥–Ω–∞–ª—ã (–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, THS, email)
-‚îÇ   ‚îú‚îÄ‚îÄ views.py                    # Views –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
-‚îÇ   ‚îú‚îÄ‚îÄ views_website.py            # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
-‚îÇ   ‚îÇ
-‚îÇ   ‚îú‚îÄ‚îÄ google_drive_sync.py        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive
-‚îÇ   ‚îÇ
-‚îÇ   ‚îú‚îÄ‚îÄ services/
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email_service.py        # Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_chat_service.py      # AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î)
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_ai_agent.py       # AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_rag.py               # RAG –∏–Ω–¥–µ–∫—Å –∏ –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–∫–æ–¥—É
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing_service.py      # –ë–∏–ª–ª–∏–Ω–≥
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ balance_manager.py      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏
-‚îÇ   ‚îÇ
-‚îÇ   ‚îú‚îÄ‚îÄ management/commands/        # Management –∫–æ–º–∞–Ω–¥—ã
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rebuild_ai_index.py
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rebuild_ai_index_if_stale.py
-‚îÇ   ‚îî‚îÄ‚îÄ migrations/                 # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (88+ —Ñ–∞–π–ª–æ–≤)
-‚îÇ
-‚îú‚îÄ‚îÄ templates/
-‚îÇ   ‚îú‚îÄ‚îÄ admin/                      # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ line_change.html        # –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_site.html          # –í—Å—Ç–∞–≤–∫–∞ AI-–≤–∏–¥–∂–µ—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ core/container/         # –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-‚îÇ   ‚îú‚îÄ‚îÄ email/                      # –®–∞–±–ª–æ–Ω—ã email
-‚îÇ   ‚îî‚îÄ‚îÄ website/                    # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç
-‚îÇ
-‚îú‚îÄ‚îÄ logist2/
-‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (InMemory Channels)
-‚îÇ   ‚îú‚îÄ‚îÄ settings_base.py            # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Redis Channels)
-‚îÇ   ‚îú‚îÄ‚îÄ settings_dev.py             # Dev-–ø—Ä–æ—Ñ–∏–ª—å
-‚îÇ   ‚îú‚îÄ‚îÄ settings_prod.py            # Prod-–ø—Ä–æ—Ñ–∏–ª—å
-‚îÇ   ‚îú‚îÄ‚îÄ settings_test.py            # Test-–ø—Ä–æ—Ñ–∏–ª—å (SQLite)
-‚îÇ   ‚îú‚îÄ‚îÄ urls.py                     # URL routing
-‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py / asgi.py           # WSGI/ASGI
-‚îÇ
-‚îú‚îÄ‚îÄ requirements.txt                # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
-‚îî‚îÄ‚îÄ requirements_website.txt        # –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-```
-
----
-
-## üîÑ –ö–õ–Æ–ß–ï–í–´–ï –°–ò–ì–ù–ê–õ–´
-
-### –§–∞–π–ª: core/signals.py
-
-```python
-# –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Container
-save_old_container_values()          # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
-update_related_on_container_save()   # –û–±–Ω–æ–≤–ª—è–µ—Ç –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-send_container_notifications_on_save()  # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
-auto_sync_photos_on_container_change()  # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ —Å Google Drive
-
-# –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Car
-save_old_contractors()               # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã
-update_related_on_car_save()         # –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–≤–æ–π—Å—ã
-create_car_services_on_car_save()    # –°–æ–∑–¥–∞—ë—Ç —É—Å–ª—É–≥–∏ (—Å–∫–ª–∞–¥, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
-
-# –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ CarService
-recalculate_invoices_on_car_service_save()   # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã
-recalculate_invoices_on_car_service_delete() # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã
-
-# –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞—Ö
-update_cars_on_warehouse_service_change()  # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService
-update_cars_on_carrier_service_change()    # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService
-update_cars_on_company_service_change()    # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService (Company)
-delete_car_services_on_company_service_delete() # –£–¥–∞–ª—è–µ—Ç Company CarService
-```
-
----
-
-## ‚öôÔ∏è –ê–î–ú–ò–ù–ö–ê (DJANGO ADMIN)
-
-### ContainerAdmin
-
-**–ò–Ω–ª–∞–π–Ω—ã:**
-- `CarInline` ‚Äî —Å–ø–∏—Å–æ–∫ –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-- `ContainerPhotoInline` ‚Äî —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
-
-**Actions:**
-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–í –ø—É—Ç–∏, –í –ø–æ—Ä—Ç—É, –†–∞–∑–≥—Ä—É–∂–µ–Ω, –ü–µ—Ä–µ–¥–∞–Ω)
-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —Å Google Drive
-- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
-
-**save_model() ‚Äî –∫–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
-1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è `warehouse` ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∫–ª–∞–¥ –≤–æ –≤—Å–µ –¢–°
-2. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è `status` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¢–° (bulk_update)
-3. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å `unload_date` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –≤–æ –≤—Å–µ—Ö –¢–° (bulk_update)
-4. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å `line/ths/ths_payer/warehouse` ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS
-
-### CarAdmin
-
-**–°–ø–∏—Å–æ–∫ –¢–° (list_display):**
-- –°—Ç–æ–ª–±—Ü—ã: VIN, –º–∞—Ä–∫–∞, —Ç–∏–ø –¢–°, –≥–æ–¥, –∫–ª–∏–µ–Ω—Ç, —Å—Ç–∞—Ç—É—Å, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å–∫–ª–∞–¥, –ª–∏–Ω–∏—è, –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏, –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ü–µ–Ω–∞, **–Ω–∞—Ü–µ–Ω–∫–∞ (–ù)**, Title
-- **–°—Ç–æ–ª–±–µ—Ü "–ù" (31.01.2026):** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±—â—É—é —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–°
-- **–û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫:** –≤—ã–≤–æ–¥–∏—Ç—Å—è –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¢–°
-- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `annotate()` + `Sum()` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (–æ–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1)
-
-**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª—É–≥ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏
-- –°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º (services_summary_display)
-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã
-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–∞—Ü–µ–Ω–∫–µ
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –æ–±—â–µ–π —Å—É–º–º—ã –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
-
-### LineAdmin
-
-**–ò–Ω–ª–∞–π–Ω—ã:**
-- `LineServiceInline` ‚Äî —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏
-- `LineTHSCoefficientInline` ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS
-
-**–ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS":**
-- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —ç—Ç–æ–π –ª–∏–Ω–∏–∏
-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
-
----
-
-## üìä –°–¢–ê–¢–£–°–´
-
-### –°—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–¢–°
-
-| –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
-|-----|----------|----------|
-| `FLOATING` | –í –ø—É—Ç–∏ | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –º–æ—Ä–µ |
-| `IN_PORT` | –í –ø–æ—Ä—Ç—É | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–±—ã–ª, –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–≥—Ä—É–∑–∫–∏ |
-| `UNLOADED` | –†–∞–∑–≥—Ä—É–∂–µ–Ω | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≥—Ä—É–∂–µ–Ω, –¢–° –Ω–∞ —Å–∫–ª–∞–¥–µ |
-| `TRANSFERRED` | –ü–µ—Ä–µ–¥–∞–Ω | –¢–° –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç—É |
-
-### –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–∞
-
-| –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ |
-|-----|----------|
-| `DRAFT` | –ß–µ—Ä–Ω–æ–≤–∏–∫ |
-| `ISSUED` | –í—ã—Å—Ç–∞–≤–ª–µ–Ω |
-| `PARTIALLY_PAID` | –ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω |
-| `PAID` | –û–ø–ª–∞—á–µ–Ω |
-| `OVERDUE` | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω |
-| `CANCELLED` | –û—Ç–º–µ–Ω–µ–Ω |
-
----
-
-## üõ†Ô∏è –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´
-
-### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
-
-```bash
-# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
-ssh root@176.118.198.78
-cd /var/www/www-root/data/www/logist2
-source .venv/bin/activate
-
-# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
-systemctl restart gunicorn
-systemctl restart daphne
-
-# –ú–∏–≥—Ä–∞—Ü–∏–∏
-python manage.py migrate
-
-# –°—Ç–∞—Ç–∏–∫–∞
-python manage.py collectstatic --noinput
-
-# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ
-python manage.py sync_photos_gdrive --no-photos
-
-# –ü—Ä–∞–≤–∞ –Ω–∞ media —Ñ–∞–π–ª—ã
-./fix_media_permissions.sh
-```
-
-### –õ–æ–∫–∞–ª—å–Ω–æ (PowerShell)
-
-```powershell
-# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
-.\START_ME.bat
-
-# –î–µ–ø–ª–æ–π
-.\deploy.ps1
-
-# –ú–∏–≥—Ä–∞—Ü–∏–∏
-python manage.py makemigrations
-python manage.py migrate
-```
-
----
-
-## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–Æ–ê–ù–°–´
-
-### 1. –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
-
-–ü—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ù–ï –ù–£–ñ–ù–û –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ü–µ–Ω—ã/—É—Å–ª—É–≥–∏ –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Å–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
-
-### 2. PowerShell –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
-
-- –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç `&&` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `;`
-- –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ SSH –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å—Å—è
-- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `deploy.ps1`
-
-### 3. –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
-
-- –õ–æ–∫–∞–ª—å–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `settings.py` (InMemory Channels).
-- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≤—è–∑–∫–∞ `settings_base.py` + `settings_prod.py` (Redis Channels, ASGI –≤–∫–ª—é—á–µ–Ω).
-
-### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Django
-
-–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –¢–° –Ω—É–∂–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å prefetch –∫—ç—à:
-```python
-if hasattr(self, '_prefetched_objects_cache'):
-    self._prefetched_objects_cache.pop('car_services', None)
-```
-
-### 5. Email —á–µ—Ä–µ–∑ Brevo
-
-- –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å
-- SMTP: smtp-relay.brevo.com
-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
-
-### 6. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-
-–ï—Å–ª–∏ –¥–ª—è —Ç–∏–ø–∞ –¢–° –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ `LineTHSCoefficient`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 1.0.
-
----
-
-## üìù –¢–ò–ü–ò–ß–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
-
-### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-
-1. –£–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-2. –í—ã–±—Ä–∞—Ç—å –ª–∏–Ω–∏—é ‚Üí —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS
-3. –£–∫–∞–∑–∞—Ç—å —Å—É–º–º—É THS –∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (LINE/WAREHOUSE)
-4. –í—ã–±—Ä–∞—Ç—å —Å–∫–ª–∞–¥ ‚Üí —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
-5. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω ‚Üí –∫–∞–∂–¥–æ–º—É –¢–° —Å–æ–∑–¥–∞–¥—É—Ç—Å—è —É—Å–ª—É–≥–∏
-6. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ –≤—Å–µ–º –¢–°
-
-### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
-
-1. –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-2. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí –¥–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å–µ–º –¢–°
-3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—é—Ç—Å—è –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è
-4. –û–±–Ω–æ–≤—è—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
-5. –ö–ª–∏–µ–Ω—Ç–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
-
-### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS
-
-1. –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ª–∏–Ω–∏–∏
-2. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∏–Ω–ª–∞–π–Ω–µ `LineTHSCoefficientInline`
-3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–Ω–∏—é
-4. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
-5. THS –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏
-
-### –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É
-
-1. –°–æ–∑–¥–∞—Ç—å NewInvoice
-2. –í—ã–±—Ä–∞—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è: Caromoto Lithuania (Company)
-3. –í—ã–±—Ä–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –ö–ª–∏–µ–Ω—Ç
-4. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ ManyToMany
-5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ CarService
-6. –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥
-
----
-
-## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´
-
-- `AI_PROJECT_CONTEXT.md` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI —Å –¥–µ—Ç–∞–ª—è–º–∏ –¥–µ–ø–ª–æ—è
-- `LOGIST2_PROGRESS_REPORT.md` ‚Äî –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ
-- `CREDENTIALS.md` ‚Äî –ø–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã (–Ω–µ –≤ git)
-
----
-
-**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**
+# –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê LOGIST2
+
+**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 4 —Ñ–µ–≤—Ä–∞–ª—è 2026  
+**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏
+
+---
+
+## üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
+
+**–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:** Logist2 (Caromoto Lithuania)  
+**–¢–∏–ø:** Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏  
+**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ä—Å–∫–∏–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –¢–°, —Å–∫–ª–∞–¥–∞–º–∏, –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏
+
+### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
+
+| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
+|-----------|------------|
+| Backend | Django 5.1.7, Python 3.10-3.12 |
+| API | Django REST Framework |
+| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | PostgreSQL (—Ç–µ—Å—Ç—ã ‚Äî SQLite –≤ `settings_test.py`) |
+| Web-—Å–µ—Ä–≤–µ—Ä | Nginx + Gunicorn, —Å—Ç–∞—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ WhiteNoise |
+| WebSockets | Django Channels + Daphne (Redis –≤ `settings_base.py`, InMemory –≤ `settings.py`) |
+| –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | HTMX + –∫–∞—Å—Ç–æ–º–Ω—ã–π JS |
+| UI —Å–∞–π—Ç–∞ | Bootstrap 5 |
+| Email | Brevo (SMTP) |
+| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | Google Drive API |
+
+### –°–µ—Ä–≤–µ—Ä
+
+- **IP:** 176.118.198.78
+- **–î–æ–º–µ–Ω:** https://caromoto-lt.com
+- **–ü—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:** `/var/www/www-root/data/www/logist2`
+
+---
+
+## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ò–ï–†–ê–†–•–ò–Ø –î–ê–ù–ù–´–•
+
+### –ì–ª–∞–≤–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è
+
+```
+–ö–û–ù–¢–ï–ô–ù–ï–† (Container) ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, "—Ä–æ–¥–∏—Ç–µ–ª—å"
+    ‚îÇ
+    ‚îú‚îÄ‚îÄ –ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è (Line)
+    ‚îú‚îÄ‚îÄ –°–∫–ª–∞–¥ (Warehouse)
+    ‚îú‚îÄ‚îÄ THS (—Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –ª–∏–Ω–∏—è–º –∑–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
+    ‚îÇ
+    ‚îî‚îÄ‚îÄ –ê–í–¢–û–ú–û–ë–ò–õ–ò (Car) ‚Äî "–¥–µ—Ç–∏", –Ω–∞—Å–ª–µ–¥—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+            ‚îÇ
+            ‚îú‚îÄ‚îÄ –ö–ª–∏–µ–Ω—Ç (Client) ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –¢–°
+            ‚îú‚îÄ‚îÄ –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ (Carrier) ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –¢–° –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+            ‚îÇ
+            ‚îî‚îÄ‚îÄ –£–°–õ–£–ì–ò (CarService) ‚Äî —Å–≤—è–∑—å –¢–° —Å —É—Å–ª—É–≥–∞–º–∏
+                    ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (LINE) ‚Äî –≤–∫–ª—é—á–∞—è THS
+                    ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (WAREHOUSE) ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Ä–∞–∑–≥—Ä—É–∑–∫–∞ –∏ –¥—Ä.
+                    ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (CARRIER)
+                    ‚îî‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ (COMPANY)
+```
+
+### –ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
+
+**–í–ê–ñ–ù–û:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –¢–° –≤–Ω—É—Ç—Ä–∏:
+
+| –ü–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤ –¢–° | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
+|-----------------|------------------|------------|
+| `status` | ‚úÖ –î–∞ | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¢–° |
+| `warehouse` | ‚úÖ –î–∞ | –°–∫–ª–∞–¥ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° |
+| `unload_date` | ‚úÖ –î–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) | –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è |
+| `line` | ‚úÖ –î–∞ | –õ–∏–Ω–∏—è –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° |
+| `ths` | ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è | THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ —Ç–∏–ø–∞–º –¢–° |
+
+**–û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –ö–æ–≥–¥–∞ –í–°–ï –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω" ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–æ–∂–µ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω".
+
+---
+
+## üì¶ –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–•
+
+### Container (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä)
+
+```python
+# –§–∞–π–ª: core/models.py
+
+Container:
+    number              # –ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
+    status              # FLOATING (–í –ø—É—Ç–∏), IN_PORT (–í –ø–æ—Ä—Ç—É), UNLOADED (–†–∞–∑–≥—Ä—É–∂–µ–Ω), TRANSFERRED (–ü–µ—Ä–µ–¥–∞–Ω)
+    line                # FK ‚Üí Line (–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è)
+    warehouse           # FK ‚Üí Warehouse (–°–∫–ª–∞–¥ —Ä–∞–∑–≥—Ä—É–∑–∫–∏)
+    client              # FK ‚Üí Client (–∫–ª–∏–µ–Ω—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+    customs_procedure   # –¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (TRANSIT/IMPORT/REEXPORT/EXPORT)
+    
+    # THS —Å–∏—Å—Ç–µ–º–∞
+    ths                 # Decimal ‚Äî –æ–±—â–∞—è —Å—É–º–º–∞ THS –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
+    ths_payer           # LINE –∏–ª–∏ WAREHOUSE ‚Äî –∫–æ–º—É –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS
+    sklad               # –û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+    dekl                # –î–µ–∫–ª–∞—Ä–∞—Ü–∏—è (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+    proft               # –ù–∞—Ü–µ–Ω–∫–∞ (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+    
+    # –î–∞—Ç—ã
+    eta                 # –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è
+    planned_unload_date # "–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å" ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email –∫–ª–∏–µ–Ω—Ç–∞–º
+    unload_date         # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email
+    unloaded_status_at  # –ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å "–†–∞–∑–≥—Ä—É–∂–µ–Ω"
+    
+    # –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (legacy —Ä–∞—Å—á—ë—Ç)
+    free_days           # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
+    days                # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
+    rate                # –°—Ç–∞–≤–∫–∞ (legacy)
+    storage_cost        # –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (legacy)
+    notes               # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
+    
+    # Google Drive
+    google_drive_folder_url  # –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+```
+
+**–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–†–∞–∑–≥—Ä—É–∂–µ–Ω" –ø–æ–ª—è `warehouse` –∏ `unload_date` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.
+
+### Car (–ê–≤—Ç–æ–º–æ–±–∏–ª—å/–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ)
+
+```python
+# –§–∞–π–ª: core/models.py
+
+Car:
+    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
+    vin                 # VIN –Ω–æ–º–µ—Ä (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π, 17 —Å–∏–º–≤–æ–ª–æ–≤)
+    brand               # –ú–∞—Ä–∫–∞ (Toyota, BMW –∏ —Ç.–¥.)
+    year                # –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
+    
+    # –¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ù–û–ì–û –°–†–ï–î–°–¢–í–ê (11 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
+    vehicle_type:
+        SEDAN           # –õ–µ–≥–∫–æ–≤–æ–π (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS: 1.0)
+        CROSSOVER       # –ö—Ä–æ—Å—Å–æ–≤–µ—Ä (1.2)
+        SUV             # –î–∂–∏–ø (1.5)
+        PICKUP          # –ü–∏–∫–∞–ø (1.5)
+        NEW_CAR         # –ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å (1.0)
+        MOTO            # –ú–æ—Ç–æ—Ü–∏–∫–ª (0.3)
+        BIG_MOTO        # –ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª (0.5)
+        ATV             # –ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏ (0.5)
+        BOAT            # –õ–æ–¥–∫–∞ (2.0)
+        RV              # –ê–≤—Ç–æ–¥–æ–º (3.0)
+        CONSTRUCTION    # –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ (2.5)
+    
+    # –°–≤—è–∑–∏
+    container           # FK ‚Üí Container (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL –¥–ª—è –¢–° –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+    client              # FK ‚Üí Client (–≤–ª–∞–¥–µ–ª–µ—Ü)
+    warehouse           # FK ‚Üí Warehouse (—Å–∫–ª–∞–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
+    line                # FK ‚Üí Line (–º–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è)
+    carrier             # FK ‚Üí Carrier (–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
+    
+    # –°—Ç–∞—Ç—É—Å –∏ –¥–∞—Ç—ã
+    status              # –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+    unload_date         # –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
+    transfer_date       # –î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–ª–∏–µ–Ω—Ç—É
+    
+    # –•—Ä–∞–Ω–µ–Ω–∏–µ
+    free_days           # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–∏–∑ —Å–∫–ª–∞–¥–∞)
+    days                # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
+    storage_cost        # –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞)
+    
+    # –¶–µ–Ω–∞
+    total_price         # –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + –Ω–∞—Ü–µ–Ω–∫–∏
+    proft               # –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania (legacy –ø–æ–ª–µ)
+    hide_markup_in      # FK ‚Üí CarService (–≤ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Å–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É)
+    
+    # –î–æ–∫—É–º–µ–Ω—Ç—ã
+    has_title           # –ï—Å—Ç—å –ª–∏ Title
+    title_notes         # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ Title
+
+    # –î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã (legacy –ø–æ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Å—Ç–∞—Ä—ã—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö/–æ—Ç—á–µ—Ç–∞—Ö)
+    unload_fee, delivery_fee, loading_fee, docs_fee, transfer_fee
+    transit_declaration, export_declaration, extra_costs, complex_fee
+    price, auction_fee, transport_usa, ocean_freight, transport_kz
+    broker_fee, additional_expenses, rate
+```
+
+### CarService (–°–≤—è–∑—å –¢–° —Å —É—Å–ª—É–≥–∞–º–∏)
+
+```python
+# –§–∞–π–ª: core/models.py
+
+CarService:
+    car                 # FK ‚Üí Car
+    service_type        # LINE, WAREHOUSE, CARRIER –∏–ª–∏ COMPANY
+    service_id          # ID —É—Å–ª—É–≥–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ (LineService/WarehouseService/CarrierService/CompanyService)
+    custom_price        # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π)
+    markup_amount       # –°–ö–†–´–¢–ê–Ø –ù–ê–¶–ï–ù–ö–ê (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ –≤ –∏–Ω–≤–æ–π—Å–µ, –Ω–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ)
+    quantity            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–æ–±—ã—á–Ω–æ 1)
+    notes               # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
+    
+    # –°–≤–æ–π—Å—Ç–≤–∞ (property)
+    final_price         # = custom_price √ó quantity (–ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏, –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞)
+    invoice_price       # = (custom_price + markup_amount) √ó quantity (–¥–ª—è –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É)
+```
+
+### –£—Å–ª—É–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
+
+```python
+# –§–∞–π–ª: core/models.py
+
+LineService:            # –£—Å–ª—É–≥–∏ –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π
+    line                # FK ‚Üí Line
+    name                # "THS MAERSK 3 –ê–í–¢–û", "–î–æ–∫—É–º–µ–Ω—Ç—ã" –∏ —Ç.–¥.
+    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
+    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏
+
+WarehouseService:       # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤
+    warehouse           # FK ‚Üí Warehouse
+    name                # "–•—Ä–∞–Ω–µ–Ω–∏–µ", "–†–∞–∑–≥—Ä—É–∑–∫–∞", "–î–æ–∫—É–º–µ–Ω—Ç—ã" –∏ —Ç.–¥.
+    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è "–•—Ä–∞–Ω–µ–Ω–∏–µ" ‚Äî —Å—Ç–∞–≤–∫–∞ –∑–∞ –î–ï–ù–¨)
+    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è "–•—Ä–∞–Ω–µ–Ω–∏–µ" ‚Äî –Ω–∞—Ü–µ–Ω–∫–∞ –∑–∞ –î–ï–ù–¨)
+    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
+    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ
+
+CarrierService:         # –£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤
+    carrier             # FK ‚Üí Carrier
+    name                # "–î–æ—Å—Ç–∞–≤–∫–∞", "–ü–æ–≥—Ä—É–∑–∫–∞" –∏ —Ç.–¥.
+    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
+    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+
+CompanyService:         # –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π
+    company             # FK ‚Üí Company (Caromoto Lithuania –∏ –¥—Ä.)
+    name                # "–î–æ–∫—É–º–µ–Ω—Ç—ã", "–ö–æ–º–∏—Å—Å–∏—è" –∏ —Ç.–¥.
+    description         # –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
+    default_price       # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+    default_markup      # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+    is_active           # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞
+    add_by_default      # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –∫–æ–º–ø–∞–Ω–∏–∏
+
+AutoTransport:          # –ê–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É ‚≠ê –ù–û–í–û–ï
+    number              # –ù–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: AT-YYYYMMDD-NNNN)
+    carrier             # FK ‚Üí Carrier (–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
+    eori_code           # EORI –∫–æ–¥ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞)
+    truck               # FK ‚Üí CarrierTruck (–∞–≤—Ç–æ–≤–æ–∑)
+    driver              # FK ‚Üí CarrierDriver (–≤–æ–¥–∏—Ç–µ–ª—å)
+    truck_number_manual # –†—É—á–Ω–æ–π –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç—è–≥–∞—á–∞ (–µ—Å–ª–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ)
+    trailer_number_manual # –†—É—á–Ω–æ–π –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ –ø—Ä–∏—Ü–µ–ø–∞
+    driver_name_manual  # –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –≤–æ–¥–∏—Ç–µ–ª—è
+    driver_phone        # –¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)
+    border_crossing     # –ì—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è (choices)
+    cars                # ManyToMany ‚Üí Car (–∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –∞–≤—Ç–æ–≤–æ–∑–µ)
+    loading_date        # –î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏
+    departure_date      # –î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
+    estimated_delivery_date # –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
+    actual_delivery_date    # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
+    status              # DRAFT, FORMED, LOADED, IN_TRANSIT, DELIVERED, CANCELLED
+    notes               # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
+    created_by          # FK ‚Üí User (–∫—Ç–æ —Å–æ–∑–¥–∞–ª)
+    created_at, updated_at # –î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
+    
+    # –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω" (FORMED):
+    # - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, —á—å–∏ –¢–° –≤ –∞–≤—Ç–æ–≤–æ–∑–µ
+    # - –ï—Å–ª–∏ –≤—Å–µ –¢–° –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ - —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–Ω–≤–æ–π—Å
+    # - –ò–Ω–≤–æ–π—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –∞–≤—Ç–æ–≤–æ–∑–∞
+
+CarrierTruck:           # –ê–≤—Ç–æ–≤–æ–∑—ã –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ ‚≠ê –ù–û–í–û–ï
+    carrier             # FK ‚Üí Carrier
+    truck_number        # –ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞
+    trailer_number      # –ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞
+    is_active           # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (default: True)
+    created_at, updated_at # –î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
+    
+    # Property: full_number - –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä "XXXXX / YYYYY"
+
+CarrierDriver:          # –í–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ ‚≠ê –ù–û–í–û–ï
+    carrier             # FK ‚Üí Carrier
+    first_name          # –ò–º—è
+    last_name           # –§–∞–º–∏–ª–∏—è
+    phone               # –¢–µ–ª–µ—Ñ–æ–Ω
+    is_active           # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (default: True)
+    created_at, updated_at # –î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
+    
+    # Property: full_name - –ø–æ–ª–Ω–æ–µ –∏–º—è "–ò–º—è –§–∞–º–∏–ª–∏—è"
+
+# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Carrier:
+Carrier:
+    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
+    eori_code           # ‚≠ê –ù–û–í–û–ï: EORI –∫–æ–¥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+    # –°–≤—è–∑–∏:
+    # - trucks (CarrierTruck)
+    # - drivers (CarrierDriver)
+    # - auto_transports (AutoTransport)
+
+# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ NewInvoice:
+NewInvoice:
+    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
+    auto_transport      # ‚≠ê –ù–û–í–û–ï: FK ‚Üí AutoTransport (—Å–≤—è–∑—å —Å –∞–≤—Ç–æ–≤–æ–∑–æ–º)
+```
+
+### LineTHSCoefficient (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS)
+
+```python
+# –§–∞–π–ª: core/models.py
+
+LineTHSCoefficient:
+    line                # FK ‚Üí Line
+    vehicle_type        # –¢–∏–ø –¢–° (SEDAN, MOTO –∏ —Ç.–¥.)
+    coefficient         # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS
+    
+    # –ü—Ä–∏–º–µ—Ä: –õ–∏–Ω–∏—è MAERSK
+    # SEDAN: 1.0, SUV: 1.5, MOTO: 0.3, BOAT: 2.0
+```
+
+---
+
+## üí∞ –°–ò–°–¢–ï–ú–ê THS (TERMINAL HANDLING SURCHARGE)
+
+### –ß—Ç–æ —Ç–∞–∫–æ–µ THS
+
+THS ‚Äî —ç—Ç–æ —Å–±–æ—Ä –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –ø–æ—Ä—Ç—É. –°—É–º–º–∞ THS —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¢–° –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö "–≤–µ—Å—É" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É).
+
+### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS
+
+```
+1. –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—É–º–º—É THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø–æ–ª—É—á–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –µ–≥–æ —Ç–∏–ø–∞ –∏–∑ LineTHSCoefficient
+3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª—é: THS_–¢–° = –æ–±—â–∏–π_THS √ó (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤)
+4. –û–∫—Ä—É–≥–ª–∏—Ç—å –í–í–ï–†–• –¥–æ 5 EUR (73.12 ‚Üí 75 EUR)
+```
+
+### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞
+
+```
+–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR
+3 –¢–°: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(1.5) + –º–æ—Ç–æ(0.3) = —Å—É–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 2.8
+
+- –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/2.8) = 178.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 180 EUR
+- –î–∂–∏–ø: 500 √ó (1.5/2.8) = 267.86 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 270 EUR  
+- –ú–æ—Ç–æ: 500 √ó (0.3/2.8) = 53.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 55 EUR
+```
+
+### –ü–æ–ª–µ ths_payer
+
+–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –æ—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°:
+
+| –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ |
+|----------|----------|---------------------|
+| `LINE` | –û–ø–ª–∞—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ | CarService —Å service_type='LINE' |
+| `WAREHOUSE` | –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ | CarService —Å service_type='WAREHOUSE' |
+
+**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WAREHOUSE:** –ò–Ω–æ–≥–¥–∞ —Å–∫–ª–∞–¥ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç THS –ª–∏–Ω–∏–∏ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏, –∞ –ø–æ—Ç–æ–º –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á—ë—Ç –Ω–∞–º. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ THS –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞.
+
+### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
+
+```python
+# –§–∞–π–ª: core/signals.py
+
+calculate_ths_for_container(container)
+    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º
+    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {car_id: ths_amount}
+
+create_ths_services_for_container(container)
+    # –°–æ–∑–¥–∞—ë—Ç CarService –∑–∞–ø–∏—Å–∏ —Å THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+    # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
+    # –¢–∏–ø —É—Å–ª—É–≥–∏ (LINE/WAREHOUSE) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–ª–µ–º ths_payer
+
+round_up_to_5(value)
+    # –û–∫—Ä—É–≥–ª—è–µ—Ç –≤–≤–µ—Ä—Ö —Å —à–∞–≥–æ–º 5 EUR
+    # –ü—Ä–∏–º–µ—Ä: 73.12 ‚Üí 75
+```
+
+### –ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è THS
+
+1. **–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** ‚Äî –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è: `line`, `ths`, `ths_payer`, `warehouse`
+2. **–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"** –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏
+
+---
+
+## üè≠ –°–ò–°–¢–ï–ú–ê –£–°–õ–£–ì –°–ö–õ–ê–î–û–í
+
+### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
+
+–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –Ω–∞ —Å–∫–ª–∞–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —É—Å–ª—É–≥–∏ —Å —Ñ–ª–∞–≥–æ–º `add_by_default=True`.
+
+**–î–ª—è –ª–∏–Ω–∏–π, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –∏ –∫–æ–º–ø–∞–Ω–∏–π:**
+- –õ–æ–≥–∏–∫–∞ `add_by_default` —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–∫–ª–∞–¥–∞–º
+- –£—Å–ª—É–≥–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–°**, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¢–° –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è
+
+**–¢–∏–ø–∏—á–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞:**
+- **–•—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî —Ü–µ–Ω–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å
+- **–†–∞–∑–≥—Ä—É–∑–∫–∞** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞
+- **–î–æ–∫—É–º–µ–Ω—Ç—ã** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞
+- **–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞
+
+### –£—Å–ª—É–≥–∞ "–•—Ä–∞–Ω–µ–Ω–∏–µ" ‚Äî –æ—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞
+
+```python
+# –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏:
+
+storage_price = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å
+storage_markup = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å
+
+# –ì–¥–µ:
+# - –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ = (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –¥–∞—Ç–∞_–ø–µ—Ä–µ–¥–∞—á–∏) - –¥–∞—Ç–∞_—Ä–∞–∑–≥—Ä—É–∑–∫–∏ - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏
+# - —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ WarehouseService.default_price –¥–ª—è —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
+# - –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ WarehouseService.default_markup
+```
+
+**–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç (–¢–° –µ—â—ë –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏) ‚Äî —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" = 0.
+
+### –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
+
+- –£–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–∫–ª–∞–¥–∞ (`Warehouse.free_days`)
+- –ù–∞—Å–ª–µ–¥—É—é—Ç—Å—è –≤ –¢–° –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞
+- –í–ª–∏—è—é—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
+
+---
+
+## üíµ –°–ò–°–¢–ï–ú–ê –ù–ê–¶–ï–ù–ö–ò (MARKUP)
+
+### –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞
+
+–ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania ‚Äî —ç—Ç–æ –ø—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —É—Å–ª—É–≥–∞–º.
+
+### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
+
+```python
+CarService.markup_amount  # –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏
+
+# –¶–µ–Ω—ã:
+final_price = custom_price √ó quantity              # –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞
+invoice_price = (custom_price + markup_amount) √ó quantity  # –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞
+```
+
+### –ü—Ä–∏–º–µ—Ä
+
+```
+–£—Å–ª—É–≥–∞ "–†–∞–∑–≥—Ä—É–∑–∫–∞":
+- custom_price = 50 EUR
+- markup_amount = 10 EUR
+- –í –∏–Ω–≤–æ–π—Å–µ –∫–ª–∏–µ–Ω—Ç—É: 60 EUR (–∫–ª–∏–µ–Ω—Ç –Ω–µ –≤–∏–¥–∏—Ç, —á—Ç–æ 10 EUR ‚Äî —ç—Ç–æ –Ω–∞—Ü–µ–Ω–∫–∞)
+```
+
+### –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+
+–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ `default_markup` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —É—Å–ª—É–≥–∏ (LineService, WarehouseService, CarrierService).
+
+---
+
+## üìß EMAIL-–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
+
+### –¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
+
+| –°–æ–±—ã—Ç–∏–µ | –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –ö–æ–º—É |
+|---------|-----------------|------|
+| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `planned_unload_date` | "–ü–ª–∞–Ω–∏—Ä—É–µ–º —Ä–∞–∑–≥—Ä—É–∑–∫—É" | –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ |
+| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `unload_date` | "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≥—Ä—É–∂–µ–Ω" | –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ |
+
+### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
+
+```python
+Client:
+    email               # –û—Å–Ω–æ–≤–Ω–æ–π email
+    email2, email3, email4  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ email
+    notification_enabled    # –ü–æ–ª—É—á–∞—Ç—å –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
+```
+
+### Email-—Å–µ—Ä–≤–∏—Å
+
+```python
+# –§–∞–π–ª: core/services/email_service.py
+
+ContainerNotificationService:
+    send_planned_to_all_clients(container)  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ
+    send_unload_to_all_clients(container)   # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ
+    was_planned_notification_sent(container)  # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
+    was_unload_notification_sent(container)   # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
+```
+
+### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
+
+–í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –º–æ–¥–µ–ª–∏ `NotificationLog`. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.
+
+---
+
+## üìÑ –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í
+
+### –ú–æ–¥–µ–ª—å NewInvoice
+
+```python
+# –§–∞–π–ª: core/models_billing.py
+
+NewInvoice:
+    number              # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: INV-202601-0001)
+    date                # –î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è
+    due_date            # –°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é +14 –¥–Ω–µ–π)
+    
+    # –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–û–î–ò–ù –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö)
+    issuer_company      # FK ‚Üí Company (Caromoto Lithuania)
+    issuer_warehouse    # FK ‚Üí Warehouse
+    issuer_line         # FK ‚Üí Line
+    issuer_carrier      # FK ‚Üí Carrier
+    
+    # –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–û–î–ò–ù –∏–∑ –ø—è—Ç–∏)
+    recipient_client    # FK ‚Üí Client
+    recipient_warehouse # FK ‚Üí Warehouse
+    recipient_line      # FK ‚Üí Line
+    recipient_carrier   # FK ‚Üí Carrier
+    recipient_company   # FK ‚Üí Company
+    
+    # –§–∏–Ω–∞–Ω—Å—ã
+    subtotal            # –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
+    discount            # –°–∫–∏–¥–∫–∞
+    tax                 # –ù–∞–ª–æ–≥
+    total               # –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ
+    paid_amount         # –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ
+    
+    # –°–≤—è–∑—å —Å –¢–°
+    cars                # ManyToMany ‚Üí Car (–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¢–°)
+    
+    status              # DRAFT, ISSUED, PARTIALLY_PAID, PAID, OVERDUE, CANCELLED
+```
+
+### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
+
+–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¢–° –≤ –∏–Ω–≤–æ–π—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥ (CarService).
+
+**–õ–æ–≥–∏–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è:**
+
+| –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å | –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è |
+|-------------|------------------------|
+| Company (Caromoto Lithuania) | –í–°–ï —É—Å–ª—É–≥–∏ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ + —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º) |
+| Warehouse | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ |
+| Line | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–π –ª–∏–Ω–∏–∏ |
+| Carrier | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ |
+
+### –ú–µ—Ç–æ–¥ regenerate_items_from_cars()
+
+```python
+# –§–∞–π–ª: core/models_billing.py ‚Üí NewInvoice
+
+regenerate_items_from_cars():
+    # 1. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞
+    # 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–°:
+    #    - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ (update_days_and_storage)
+    #    - –°–æ–∑–¥–∞—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ CarService
+    # 3. –î–ª—è Company: –¥–æ–±–∞–≤–ª—è–µ—Ç markup_amount –∫ —Ü–µ–Ω–∞–º (—Å–∫—Ä—ã—Ç–æ)
+    # 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–∏
+```
+
+### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –∏–Ω–≤–æ–π—Å–æ–≤
+
+–ò–Ω–≤–æ–π—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏:
+- –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –¢–° (CarService)
+- –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¢–° (–¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å—Ç–∞—Ç—É—Å)
+
+–≠—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã –≤ `core/signals.py`.
+
+---
+
+## üì∏ –§–û–¢–û–ì–†–ê–§–ò–ò –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
+
+### Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
+
+```python
+# –§–∞–π–ª: core/google_drive_sync.py
+
+GoogleDriveSync:
+    sync_container_by_number(container_number)  # –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É
+    download_folder_photos(folder_url, container)  # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ
+```
+
+### –¢–∏–ø—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
+
+| –¢–∏–ø | –ö–æ–¥ | –ü–∞–ø–∫–∞ –Ω–∞ Google Drive |
+|-----|-----|----------------------|
+| –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | `IN_CONTAINER` | "KONTO VIDUS" |
+| –í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ | `UNLOADING` | "AUTO I≈† KONTO" |
+
+### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
+
+–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏:
+- –£—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ "–†–∞–∑–≥—Ä—É–∂–µ–Ω"
+- –£—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+
+### Management –∫–æ–º–∞–Ω–¥–∞
+
+```bash
+python manage.py sync_photos_gdrive --no-photos     # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ
+python manage.py sync_photos_gdrive --recent        # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
+python manage.py sync_photos_gdrive --container ECMU5566195  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
+```
+
+---
+
+## ü§ñ AI-–ü–û–ú–û–©–ù–ò–ö
+
+### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
+- –ß–∞—Ç-–≤–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ
+- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –ë–î: VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ
+- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—ã/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
+- –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
+- –í –∞–¥–º–∏–Ω–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
+- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `page_context` + –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Admin-Chat`
+- RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã–º —Ñ–∞–π–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞
+- –í AIChat —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `context_snapshot` (page context)
+
+### –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é
+- `/?track=<–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ
+
+### Endpoint
+- `POST /api/ai-chat/` ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `message`, `session_id`, `page_context`
+
+### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`
+```
+AI_CHAT_ENABLED=True
+AI_API_KEY=...
+AI_API_BASE_URL=https://api.openai.com/v1
+AI_MODEL=gpt-4o-mini
+AI_MAX_TOKENS=400
+AI_TEMPERATURE=0.2
+AI_REQUEST_TIMEOUT=40
+AI_EMBEDDINGS_MODEL=text-embedding-3-small
+AI_RAG_INDEX_PATH=./data/ai_rag_index.json
+AI_RAG_TOP_K=6
+AI_RAG_MAX_AGE_HOURS=72
+HTTP_PROXY=
+HTTPS_PROXY=
+NO_PROXY=localhost,127.0.0.1
+```
+
+### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
+- `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI, —Å–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤—ã–∑–æ–≤ API
+- `core/services/admin_ai_agent.py` ‚Äî –∞–¥–º–∏–Ω-–∞–≥–µ–Ω—Ç, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, UI-–ø–æ–¥—Å–∫–∞–∑–∫–∏
+- `core/services/ai_rag.py` ‚Äî RAG –∏–Ω–¥–µ–∫—Å, –ø–æ–∏—Å–∫, —Å–Ω–∏–ø–ø–µ—Ç—ã
+- `core/views_website.py` ‚Äî endpoint –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (—Ñ–∏–Ω–∞–Ω—Å—ã/—Ñ–æ—Ç–æ/—Å—Å—ã–ª–∫–∏)
+- `core/static/website/js/ai-chat.js` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç, CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
+- `templates/admin/base_site.html` + `core/static/admin/css/ai-chat.css` ‚Äî –≤–∏–¥–∂–µ—Ç –≤ –∞–¥–º–∏–Ω–∫–µ
+- `core/management/commands/rebuild_ai_index.py`
+- `core/management/commands/rebuild_ai_index_if_stale.py`
+
+## üîß –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í
+
+### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
+
+```
+logist2/
+‚îú‚îÄ‚îÄ core/                           # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
+‚îÇ   ‚îú‚îÄ‚îÄ models.py                   # –ì–ª–∞–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Container, Car, CarService –∏ –¥—Ä.)
+‚îÇ   ‚îú‚îÄ‚îÄ models_billing.py           # –ò–Ω–≤–æ–π—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (NewInvoice, InvoiceItem)
+‚îÇ   ‚îú‚îÄ‚îÄ models_website.py           # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
+‚îÇ   ‚îÇ
+‚îÇ   ‚îú‚îÄ‚îÄ admin.py                    # Django Admin (ContainerAdmin, CarAdmin, LineAdmin)
+‚îÇ   ‚îú‚îÄ‚îÄ admin_billing.py            # Admin –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
+‚îÇ   ‚îú‚îÄ‚îÄ admin_website.py            # Admin –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
+‚îÇ   ‚îÇ
+‚îÇ   ‚îú‚îÄ‚îÄ signals.py                  # –°–∏–≥–Ω–∞–ª—ã (–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, THS, email)
+‚îÇ   ‚îú‚îÄ‚îÄ views.py                    # Views –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
+‚îÇ   ‚îú‚îÄ‚îÄ views_website.py            # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
+‚îÇ   ‚îÇ
+‚îÇ   ‚îú‚îÄ‚îÄ google_drive_sync.py        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive
+‚îÇ   ‚îÇ
+‚îÇ   ‚îú‚îÄ‚îÄ services/
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email_service.py        # Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_chat_service.py      # AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î)
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_ai_agent.py       # AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_rag.py               # RAG –∏–Ω–¥–µ–∫—Å –∏ –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–∫–æ–¥—É
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing_service.py      # –ë–∏–ª–ª–∏–Ω–≥
+‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ balance_manager.py      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏
+‚îÇ   ‚îÇ
+‚îÇ   ‚îú‚îÄ‚îÄ management/commands/        # Management –∫–æ–º–∞–Ω–¥—ã
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rebuild_ai_index.py
+‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rebuild_ai_index_if_stale.py
+‚îÇ   ‚îî‚îÄ‚îÄ migrations/                 # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (88+ —Ñ–∞–π–ª–æ–≤)
+‚îÇ
+‚îú‚îÄ‚îÄ templates/
+‚îÇ   ‚îú‚îÄ‚îÄ admin/                      # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ line_change.html        # –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
+‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_site.html          # –í—Å—Ç–∞–≤–∫–∞ AI-–≤–∏–¥–∂–µ—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
+‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ core/container/         # –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+‚îÇ   ‚îú‚îÄ‚îÄ email/                      # –®–∞–±–ª–æ–Ω—ã email
+‚îÇ   ‚îî‚îÄ‚îÄ website/                    # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç
+‚îÇ
+‚îú‚îÄ‚îÄ logist2/
+‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (InMemory Channels)
+‚îÇ   ‚îú‚îÄ‚îÄ settings_base.py            # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Redis Channels)
+‚îÇ   ‚îú‚îÄ‚îÄ settings_dev.py             # Dev-–ø—Ä–æ—Ñ–∏–ª—å
+‚îÇ   ‚îú‚îÄ‚îÄ settings_prod.py            # Prod-–ø—Ä–æ—Ñ–∏–ª—å
+‚îÇ   ‚îú‚îÄ‚îÄ settings_test.py            # Test-–ø—Ä–æ—Ñ–∏–ª—å (SQLite)
+‚îÇ   ‚îú‚îÄ‚îÄ urls.py                     # URL routing
+‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py / asgi.py           # WSGI/ASGI
+‚îÇ
+‚îú‚îÄ‚îÄ requirements.txt                # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
+‚îî‚îÄ‚îÄ requirements_website.txt        # –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
+```
+
+---
+
+## üîÑ –ö–õ–Æ–ß–ï–í–´–ï –°–ò–ì–ù–ê–õ–´
+
+### –§–∞–π–ª: core/signals.py
+
+```python
+# –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Container
+save_old_container_values()          # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
+update_related_on_container_save()   # –û–±–Ω–æ–≤–ª—è–µ—Ç –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+send_container_notifications_on_save()  # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
+auto_sync_photos_on_container_change()  # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ —Å Google Drive
+
+# –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Car
+save_old_contractors()               # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã
+update_related_on_car_save()         # –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–≤–æ–π—Å—ã
+create_car_services_on_car_save()    # –°–æ–∑–¥–∞—ë—Ç —É—Å–ª—É–≥–∏ (—Å–∫–ª–∞–¥, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫)
+
+# –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ CarService
+recalculate_invoices_on_car_service_save()   # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã
+recalculate_invoices_on_car_service_delete() # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã
+
+# –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞—Ö
+update_cars_on_warehouse_service_change()  # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService
+update_cars_on_carrier_service_change()    # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService
+update_cars_on_company_service_change()    # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService (Company)
+delete_car_services_on_company_service_delete() # –£–¥–∞–ª—è–µ—Ç Company CarService
+```
+
+---
+
+## ‚öôÔ∏è –ê–î–ú–ò–ù–ö–ê (DJANGO ADMIN)
+
+### ContainerAdmin
+
+**–ò–Ω–ª–∞–π–Ω—ã:**
+- `CarInline` ‚Äî —Å–ø–∏—Å–æ–∫ –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+- `ContainerPhotoInline` ‚Äî —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
+
+**Actions:**
+- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–í –ø—É—Ç–∏, –í –ø–æ—Ä—Ç—É, –†–∞–∑–≥—Ä—É–∂–µ–Ω, –ü–µ—Ä–µ–¥–∞–Ω)
+- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —Å Google Drive
+- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
+
+**save_model() ‚Äî –∫–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
+1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è `warehouse` ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∫–ª–∞–¥ –≤–æ –≤—Å–µ –¢–°
+2. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è `status` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¢–° (bulk_update)
+3. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å `unload_date` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –≤–æ –≤—Å–µ—Ö –¢–° (bulk_update)
+4. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å `line/ths/ths_payer/warehouse` ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS
+
+### CarAdmin
+
+**–°–ø–∏—Å–æ–∫ –¢–° (list_display):**
+- –°—Ç–æ–ª–±—Ü—ã: VIN, –º–∞—Ä–∫–∞, —Ç–∏–ø –¢–°, –≥–æ–¥, –∫–ª–∏–µ–Ω—Ç, —Å—Ç–∞—Ç—É—Å, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å–∫–ª–∞–¥, –ª–∏–Ω–∏—è, –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏, –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ü–µ–Ω–∞, **–Ω–∞—Ü–µ–Ω–∫–∞ (–ù)**, Title
+- **–°—Ç–æ–ª–±–µ—Ü "–ù" (31.01.2026):** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±—â—É—é —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–°
+- **–û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫:** –≤—ã–≤–æ–¥–∏—Ç—Å—è –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¢–°
+- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `annotate()` + `Sum()` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (–æ–¥–∏–Ω SQL –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1)
+
+**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
+- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª—É–≥ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏
+- –°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º (services_summary_display)
+- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã
+- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–∞—Ü–µ–Ω–∫–µ
+- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –æ–±—â–µ–π —Å—É–º–º—ã –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
+
+### LineAdmin
+
+**–ò–Ω–ª–∞–π–Ω—ã:**
+- `LineServiceInline` ‚Äî —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏
+- `LineTHSCoefficientInline` ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS
+
+**–ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS":**
+- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —ç—Ç–æ–π –ª–∏–Ω–∏–∏
+- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
+
+---
+
+## üìä –°–¢–ê–¢–£–°–´
+
+### –°—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–¢–°
+
+| –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
+|-----|----------|----------|
+| `FLOATING` | –í –ø—É—Ç–∏ | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –º–æ—Ä–µ |
+| `IN_PORT` | –í –ø–æ—Ä—Ç—É | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–±—ã–ª, –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–≥—Ä—É–∑–∫–∏ |
+| `UNLOADED` | –†–∞–∑–≥—Ä—É–∂–µ–Ω | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≥—Ä—É–∂–µ–Ω, –¢–° –Ω–∞ —Å–∫–ª–∞–¥–µ |
+| `TRANSFERRED` | –ü–µ—Ä–µ–¥–∞–Ω | –¢–° –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç—É |
+
+### –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–∞
+
+| –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ |
+|-----|----------|
+| `DRAFT` | –ß–µ—Ä–Ω–æ–≤–∏–∫ |
+| `ISSUED` | –í—ã—Å—Ç–∞–≤–ª–µ–Ω |
+| `PARTIALLY_PAID` | –ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω |
+| `PAID` | –û–ø–ª–∞—á–µ–Ω |
+| `OVERDUE` | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω |
+| `CANCELLED` | –û—Ç–º–µ–Ω–µ–Ω |
+
+---
+
+## üõ†Ô∏è –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´
+
+### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
+
+```bash
+# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
+ssh root@176.118.198.78
+cd /var/www/www-root/data/www/logist2
+source .venv/bin/activate
+
+# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
+systemctl restart gunicorn
+systemctl restart daphne
+
+# –ú–∏–≥—Ä–∞—Ü–∏–∏
+python manage.py migrate
+
+# –°—Ç–∞—Ç–∏–∫–∞
+python manage.py collectstatic --noinput
+
+# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ
+python manage.py sync_photos_gdrive --no-photos
+
+# –ü—Ä–∞–≤–∞ –Ω–∞ media —Ñ–∞–π–ª—ã
+./fix_media_permissions.sh
+```
+
+### –õ–æ–∫–∞–ª—å–Ω–æ (PowerShell)
+
+```powershell
+# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
+.\START_ME.bat
+
+# –î–µ–ø–ª–æ–π
+.\deploy.ps1
+
+# –ú–∏–≥—Ä–∞—Ü–∏–∏
+python manage.py makemigrations
+python manage.py migrate
+```
+
+---
+
+## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–Æ–ê–ù–°–´
+
+### 1. –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
+
+–ü—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ù–ï –ù–£–ñ–ù–û –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ü–µ–Ω—ã/—É—Å–ª—É–≥–∏ –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Å–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
+
+### 2. PowerShell –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
+
+- –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç `&&` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `;`
+- –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ SSH –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å—Å—è
+- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `deploy.ps1`
+
+### 3. –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
+
+- –õ–æ–∫–∞–ª—å–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `settings.py` (InMemory Channels).
+- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≤—è–∑–∫–∞ `settings_base.py` + `settings_prod.py` (Redis Channels, ASGI –≤–∫–ª—é—á–µ–Ω).
+
+### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Django
+
+–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –¢–° –Ω—É–∂–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å prefetch –∫—ç—à:
+```python
+if hasattr(self, '_prefetched_objects_cache'):
+    self._prefetched_objects_cache.pop('car_services', None)
+```
+
+### 5. Email —á–µ—Ä–µ–∑ Brevo
+
+- –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å
+- SMTP: smtp-relay.brevo.com
+- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
+
+### 6. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+
+–ï—Å–ª–∏ –¥–ª—è —Ç–∏–ø–∞ –¢–° –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ `LineTHSCoefficient`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 1.0.
+
+---
+
+## üìù –¢–ò–ü–ò–ß–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
+
+### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+
+1. –£–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+2. –í—ã–±—Ä–∞—Ç—å –ª–∏–Ω–∏—é ‚Üí —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS
+3. –£–∫–∞–∑–∞—Ç—å —Å—É–º–º—É THS –∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (LINE/WAREHOUSE)
+4. –í—ã–±—Ä–∞—Ç—å —Å–∫–ª–∞–¥ ‚Üí —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
+5. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω ‚Üí –∫–∞–∂–¥–æ–º—É –¢–° —Å–æ–∑–¥–∞–¥—É—Ç—Å—è —É—Å–ª—É–≥–∏
+6. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ –≤—Å–µ–º –¢–°
+
+### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏
+
+1. –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+2. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí –¥–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å–µ–º –¢–°
+3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—é—Ç—Å—è –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è
+4. –û–±–Ω–æ–≤—è—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
+5. –ö–ª–∏–µ–Ω—Ç–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
+
+### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS
+
+1. –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ª–∏–Ω–∏–∏
+2. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∏–Ω–ª–∞–π–Ω–µ `LineTHSCoefficientInline`
+3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–Ω–∏—é
+4. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS"
+5. THS –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏
+
+### –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É
+
+1. –°–æ–∑–¥–∞—Ç—å NewInvoice
+2. –í—ã–±—Ä–∞—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è: Caromoto Lithuania (Company)
+3. –í—ã–±—Ä–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –ö–ª–∏–µ–Ω—Ç
+4. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ ManyToMany
+5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ CarService
+6. –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥
+
+### –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–≤–æ–∑–∞ ‚≠ê –ù–û–í–û–ï
+
+1. –°–æ–∑–¥–∞—Ç—å AutoTransport
+2. –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è EORI –∫–æ–¥, —Å–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π
+3. –í—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ–≤–æ–∑ –∏ –≤–æ–¥–∏—Ç–µ–ª—è ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è
+4. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —á–µ—Ä–µ–∑ Select2 —Å –ø–æ–∏—Å–∫–æ–º –ø–æ VIN/–º–∞—Ä–∫–µ
+5. –í—ã–±—Ä–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è, —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—ã
+6. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω" (FORMED)
+7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, —á—å–∏ –¢–° –≤ –∞–≤—Ç–æ–≤–æ–∑–µ
+8. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –∞–≤—Ç–æ–≤–æ–∑–∞ ‚Üí –∏–Ω–≤–æ–π—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è
+
+**API endpoints –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤:**
+- `GET /core/api/autotransport/carrier-info/<carrier_id>/` - EORI –∫–æ–¥, –∞–≤—Ç–æ–≤–æ–∑—ã, –≤–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+- `GET /core/api/autotransport/driver-phone/<driver_id>/` - —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è
+- `GET /core/api/autotransport/border-crossings/` - —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–Ω–∏—Ü –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
+- `POST /core/api/autotransport/create-truck/` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞
+- `POST /core/api/autotransport/create-driver/` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
+
+**–§–∞–π–ª—ã:**
+- `core/models.py` - –º–æ–¥–µ–ª–∏ AutoTransport, CarrierTruck, CarrierDriver
+- `core/models_billing.py` - —Å–≤—è–∑—å NewInvoice —Å AutoTransport
+- `core/admin.py` - AutoTransportAdmin
+- `core/views_autotransport.py` - API endpoints
+- `core/signals.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤
+- `templates/admin/core/autotransport/change_form.html` - –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω
+- `core/static/css/autotransport.css` - —Å—Ç–∏–ª–∏
+
+---
+
+## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´
+
+- `AI_PROJECT_CONTEXT.md` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI —Å –¥–µ—Ç–∞–ª—è–º–∏ –¥–µ–ø–ª–æ—è
+- `LOGIST2_PROGRESS_REPORT.md` ‚Äî –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ
+- `CREDENTIALS.md` ‚Äî –ø–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã (–Ω–µ –≤ git)
+
+---
+
+**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**
diff --git a/core/admin.py b/core/admin.py
index 8ba312e..ea32b09 100644
--- a/core/admin.py
+++ b/core/admin.py
@@ -1,3318 +1,3546 @@
-from django.contrib import admin
-
-# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
-from .admin_website import (
-    ClientUserAdmin, AIChatAdmin, NewsPostAdmin, ContactMessageAdmin, TrackingRequestAdmin
-)
-from .models_website import ContainerPhoto
-from django.utils import timezone
-from django.urls import reverse
-from django.utils.html import format_html
-from django.utils.safestring import mark_safe
-from django.http import HttpResponseRedirect
-from django.shortcuts import render
-from django.core.exceptions import ValidationError
-from django.db import models
-from django import forms
-from decimal import Decimal
-from .models import Client, Warehouse, Car, Container, Line, Company, Carrier, LineService, CarrierService, WarehouseService, CompanyService, CarService, DeletedCarService
-from .forms import LineForm, CarrierForm, WarehouseForm
-from .admin_filters import MultiStatusFilter, MultiWarehouseFilter, ClientAutocompleteFilter
-
-
-# Inline —Ñ–æ—Ä–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
-
-class WarehouseServiceInline(admin.TabularInline):
-    model = WarehouseService
-    extra = 1
-    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
-    verbose_name = "–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞"
-    verbose_name_plural = "–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞"
-    
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
-        return formset
-
-
-class LineServiceInline(admin.TabularInline):
-    model = LineService
-    extra = 1
-    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
-    verbose_name = "–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏"
-    verbose_name_plural = "–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏"
-
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
-        return formset
-
-
-class LineTHSCoefficientInline(admin.TabularInline):
-    """Inline –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–°
-    
-    –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç "–≤–µ—Å" —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS:
-    - 1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–ª–µ–≥–∫–æ–≤–æ–π)
-    - 2.0 = –¥–≤–æ–π–Ω–æ–π (–¥–∂–∏–ø, RV)
-    - 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞ (–º–æ—Ç–æ—Ü–∏–∫–ª)
-    """
-    from .models import LineTHSCoefficient
-    model = LineTHSCoefficient
-    extra = 0
-    fields = ('vehicle_type', 'coefficient')
-    verbose_name = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°"
-    verbose_name_plural = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°"
-    
-    def get_extra(self, request, obj=None, **kwargs):
-        """–ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ 11 —Ç–∏–ø–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è"""
-        if obj and obj.ths_coefficients.exists():
-            return 0
-        return 11  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –¢–°
-
-
-class CarrierServiceInline(admin.TabularInline):
-    model = CarrierService
-    extra = 1
-    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
-    verbose_name = "–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-    verbose_name_plural = "–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
-        return formset
-
-
-class CompanyServiceInline(admin.TabularInline):
-    model = CompanyService
-    extra = 1
-    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
-    verbose_name = "–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏"
-    verbose_name_plural = "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏"
-    
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
-        return formset
-
-
-# –§–æ—Ä–º–∞ –¥–ª—è CarServiceInline
-class CarServiceInlineForm(forms.ModelForm):
-    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
-    warehouse_service = forms.ModelChoiceField(
-        queryset=WarehouseService.objects.select_related('warehouse').filter(is_active=True),
-        required=False,
-        label="–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞",
-        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É —Å–∫–ª–∞–¥–∞"
-    )
-    line_service = forms.ModelChoiceField(
-        queryset=LineService.objects.select_related('line').filter(is_active=True),
-        required=False,
-        label="–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏",
-        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏"
-    )
-    carrier_service = forms.ModelChoiceField(
-        queryset=CarrierService.objects.select_related('carrier').filter(is_active=True),
-        required=False,
-        label="–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞",
-        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-    )
-    company_service = forms.ModelChoiceField(
-        queryset=CompanyService.objects.select_related('company').filter(is_active=True),
-        required=False,
-        label="–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏",
-        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∫–æ–º–ø–∞–Ω–∏–∏"
-    )
-    
-    class Meta:
-        model = CarService
-        fields = '__all__'
-    
-    def __init__(self, *args, **kwargs):
-        super().__init__(*args, **kwargs)
-        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
-        if self.instance and self.instance.pk:
-            if self.instance.service_type == 'WAREHOUSE':
-                try:
-                    self.fields['warehouse_service'].initial = self.instance.service_id
-                except:
-                    pass
-            elif self.instance.service_type == 'LINE':
-                try:
-                    self.fields['line_service'].initial = self.instance.service_id
-                except:
-                    pass
-            elif self.instance.service_type == 'CARRIER':
-                try:
-                    self.fields['carrier_service'].initial = self.instance.service_id
-                except:
-                    pass
-            elif self.instance.service_type == 'COMPANY':
-                try:
-                    self.fields['company_service'].initial = self.instance.service_id
-                except:
-                    pass
-    
-    def save(self, commit=True):
-        instance = super().save(commit=False)
-        
-        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
-        if instance.service_type == 'WAREHOUSE' and self.cleaned_data.get('warehouse_service'):
-            instance.service_id = self.cleaned_data['warehouse_service'].id
-        elif instance.service_type == 'LINE' and self.cleaned_data.get('line_service'):
-            instance.service_id = self.cleaned_data['line_service'].id
-        elif instance.service_type == 'CARRIER' and self.cleaned_data.get('carrier_service'):
-            instance.service_id = self.cleaned_data['carrier_service'].id
-        elif instance.service_type == 'COMPANY' and self.cleaned_data.get('company_service'):
-            instance.service_id = self.cleaned_data['company_service'].id
-        
-        if commit:
-            instance.save()
-        return instance
-
-
-# Inline –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Å–ª—É–≥–∞–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
-class CarServiceInline(admin.TabularInline):
-    model = CarService
-    form = CarServiceInlineForm
-    extra = 1
-    can_delete = True
-    fields = ('service_type', 'warehouse_service', 'line_service', 'carrier_service', 'service_display', 'warehouse_display', 'custom_price', 'markup_amount', 'quantity', 'final_price_display', 'invoice_price_display', 'notes')
-    readonly_fields = ('service_display', 'warehouse_display', 'final_price_display', 'invoice_price_display')
-    verbose_name = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —É—Å–ª—É–≥–∞"
-    verbose_name_plural = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (–æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤/–∫–æ–º–ø–∞–Ω–∏–π)"
-    
-    def service_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"""
-        if obj and obj.pk:
-            return obj.get_service_name()
-        return "-"
-    service_display.short_description = "–£—Å–ª—É–≥–∞"
-    
-    def warehouse_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–∫–ª–∞–¥/–∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥–∏"""
-        if not obj or not obj.pk:
-            return "-"
-        
-        if obj.service_type == 'WAREHOUSE':
-            try:
-                service = WarehouseService.objects.select_related('warehouse').get(id=obj.service_id)
-                return service.warehouse.name
-            except WarehouseService.DoesNotExist:
-                return "–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"
-        elif obj.service_type == 'LINE':
-            try:
-                service = LineService.objects.select_related('line').get(id=obj.service_id)
-                return service.line.name
-            except LineService.DoesNotExist:
-                return "–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
-        elif obj.service_type == 'CARRIER':
-            try:
-                service = CarrierService.objects.select_related('carrier').get(id=obj.service_id)
-                return service.carrier.name
-            except CarrierService.DoesNotExist:
-                return "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"
-        return "-"
-    warehouse_display.short_description = "–ö–æ–º–ø–∞–Ω–∏—è/–°–∫–ª–∞–¥"
-    
-    def final_price_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É (–±–µ–∑ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)"""
-        if obj and obj.pk:
-            return f"{obj.final_price:.2f}"
-        return "0.00"
-    final_price_display.short_description = "–ò—Ç–æ–≥–æ"
-    
-    def invoice_price_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ü–µ–Ω—É –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ (—Å —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)"""
-        if obj and obj.pk:
-            return f"{obj.invoice_price:.2f}"
-        return "0.00"
-    invoice_price_display.short_description = "–í –∏–Ω–≤–æ–π—Å–µ"
-    
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏—è
-        formset.form.base_fields['service_type'].help_text = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞'
-        formset.form.base_fields['custom_price'].help_text = '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'
-        formset.form.base_fields['quantity'].help_text = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥'
-        return formset
-
-
-import json
-import logging
-from django.db.models import Q
-from django.contrib.admin import SimpleListFilter
-
-logger = logging.getLogger('django')
-
-CONTAINER_STATUS_COLORS = {
-    '–í –ø—É—Ç–∏': '#2772a8',  # –¢–µ–º–Ω–µ–µ —Å–∏–Ω–µ–≥–æ
-    '–í –ø–æ—Ä—Ç—É': '#8B0000',  # –¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
-    '–†–∞–∑–≥—Ä—É–∂–µ–Ω': '#239f58',  # –¢–µ–º–Ω–µ–µ –∑–µ–ª—ë–Ω–æ–≥–æ
-    '–ü–µ—Ä–µ–¥–∞–Ω': '#78458c',  # –¢–µ–º–Ω–µ–µ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ
-}
-
-class CarInline(admin.TabularInline):
-    model = Car
-    extra = 1
-    can_delete = True
-    show_change_link = True  # –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
-    fields = ('year', 'brand', 'vehicle_type', 'vin', 'client', 'total_price', 'has_title')  # –¥–æ–±–∞–≤–∏–ª–∏ vehicle_type
-    readonly_fields = ('total_price',)
-
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        for field in formset.form.base_fields.values():
-            field.help_text = ''
-        return formset
-
-
-class ContainerPhotoInline(admin.TabularInline):
-    """
-    Inline –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
-    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å Google Drive.
-    """
-    model = ContainerPhoto
-    extra = 0  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è - —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
-    can_delete = True
-    max_num = 100  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
-    fields = ('thumbnail_preview', 'photo', 'photo_type', 'is_public')
-    readonly_fields = ('thumbnail_preview',)
-    verbose_name = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è"
-    verbose_name_plural = "üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
-    
-    def thumbnail_preview(self, obj):
-        """–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"""
-        if obj.thumbnail:
-            return format_html(
-                '<a href="{}" target="_blank"><img src="{}" style="max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;" /></a>',
-                obj.photo.url if obj.photo else '#',
-                obj.thumbnail.url
-            )
-        elif obj.photo:
-            return format_html(
-                '<a href="{}" target="_blank"><img src="{}" style="max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;" /></a>',
-                obj.photo.url,
-                obj.photo.url
-            )
-        return '-'
-    thumbnail_preview.short_description = '–ü—Ä–µ–≤—å—é'
-    
-    def get_queryset(self, request):
-        """–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è"""
-        return super().get_queryset(request).only('id', 'container', 'photo', 'thumbnail', 'photo_type', 'is_public')
-
-
-# CarServiceInline —É–¥–∞–ª–µ–Ω
-
-class ContainerAdmin(admin.ModelAdmin):
-    change_form_template = 'admin/core/container/change_form.html'
-    list_display = ('number', 'colored_status', 'eta', 'planned_unload_date', 'unload_date', 'line', 'warehouse', 'photos_count_display')
-    list_display_links = ('number',)  # –î–µ–ª–∞–µ–º –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
-    list_filter = (MultiStatusFilter, ClientAutocompleteFilter, MultiWarehouseFilter)
-    search_fields = ('number',)
-    ordering = ['-unload_date', '-id']  # –°–Ω–∞—á–∞–ª–∞ –ø–æ –¥–∞—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É), –ø–æ—Ç–æ–º –ø–æ ID
-    inlines = [CarInline, ContainerPhotoInline]  # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–¥ —Å–ø–∏—Å–∫–æ–º –º–∞—à–∏–Ω
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
-            'classes': ('collapse',),
-            'fields': (
-                ('number', 'status', 'line', 'warehouse'),
-                ('ths', 'ths_payer'),
-                ('eta', 'planned_unload_date', 'unload_date'),
-                'google_drive_folder_url',
-            )
-        }),
-    )
-    readonly_fields = ('days', 'storage_cost')
-    actions = ['set_status_floating', 'set_status_in_port', 'set_status_unloaded', 'set_status_transferred', 'check_container_status', 'bulk_update_container_statuses', 'sync_photos_from_gdrive', 'resend_planned_notifications', 'resend_unload_notifications']
-
-    class Media:
-        css = {'all': ('css/logist2_custom_admin.css',)}
-        js = ('js/htmx.min.js',)
-
-    def get_queryset(self, request):
-        qs = super().get_queryset(request)
-        return qs.select_related('line', 'client', 'warehouse').prefetch_related('container_cars')
-
-    def save_model(self, request, obj, form, change):
-        import time
-        start_time = time.time()
-        logger.info(f"[TIMING] Container save_model started for {obj.number}")
-        
-        # –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∏ —É –Ω–µ–≥–æ –µ—â–µ –Ω–µ—Ç pk, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
-        if not change and not obj.pk:
-            super().save_model(request, obj, form, change)
-        elif change:
-            # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
-            super().save_model(request, obj, form, change)
-        
-        logger.info(f"[TIMING] Container saved in {time.time() - start_time:.2f}s")
-
-        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Å–∫–ª–∞–¥ ‚Äî —Ä–∞–∑–Ω–µ—Å—ë–º –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥ –≤–æ –≤—Å–µ –∞–≤—Ç–æ
-        if change and form and 'warehouse' in getattr(form, 'changed_data', []):
-            try:
-                logger.info(f"Warehouse changed for container {obj.id}, syncing cars...")
-                obj.sync_cars_after_warehouse_change()
-                logger.info(f"Successfully synced warehouse for {obj.container_cars.count()} cars")
-            except Exception as e:
-                logger.error(f"Failed to sync cars after warehouse change for container {obj.id}: {e}")
-
-        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Å—Ç–∞—Ç—É—Å ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-        if change and form and 'status' in getattr(form, 'changed_data', []):
-            try:
-                logger.info(f"Status changed for container {obj.id} to {obj.status}, bulk updating all cars...")
-                updated_count = obj.container_cars.update(status=obj.status)
-                logger.info(f"‚úÖ Updated status to '{obj.status}' for {updated_count} cars in container {obj.number}")
-            except Exception as e:
-                logger.error(f"Failed to update car statuses for container {obj.id}: {e}")
-
-        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-        if change and form and 'unload_date' in getattr(form, 'changed_data', []):
-            try:
-                from django.db.models.signals import post_save, post_delete
-                from core.signals import update_related_on_car_save, create_car_services_on_car_save, recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete
-                
-                logger.info(f"Unload date changed for container {obj.id} to {obj.unload_date}, bulk updating all cars...")
-                
-                # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑ –ë–î, —á—Ç–æ–±—ã –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
-                obj.refresh_from_db()
-                
-                # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
-                post_save.disconnect(update_related_on_car_save, sender=Car)
-                post_save.disconnect(create_car_services_on_car_save, sender=Car)
-                post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService)
-                post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService)
-                
-                cars_to_update = []
-                affected_invoices = set()
-                
-                for car in obj.container_cars.select_related('warehouse').all():
-                    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
-                    car.unload_date = obj.unload_date
-                    car.update_days_and_storage()
-                    car.calculate_total_price()
-                    cars_to_update.append(car)
-                    
-                    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
-                    for invoice in car.newinvoice_set.all():
-                        affected_invoices.add(invoice)
-                
-                # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
-                if cars_to_update:
-                    Car.objects.bulk_update(
-                        cars_to_update,
-                        ['unload_date', 'days', 'storage_cost', 'total_price'],
-                        batch_size=50
-                    )
-                    logger.info(f"‚úÖ Bulk updated {len(cars_to_update)} cars in container {obj.number}")
-                
-                # –í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ
-                post_save.connect(update_related_on_car_save, sender=Car)
-                post_save.connect(create_car_services_on_car_save, sender=Car)
-                post_save.connect(recalculate_car_price_on_service_save, sender=CarService)
-                post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService)
-                
-                # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–Ω–≤–æ–π—Å—ã –æ–¥–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º
-                if affected_invoices:
-                    logger.info(f"Updating {len(affected_invoices)} affected invoices...")
-                    for invoice in affected_invoices:
-                        try:
-                            if hasattr(invoice, 'regenerate_items_from_cars'):
-                                # NewInvoice
-                                invoice.regenerate_items_from_cars()
-                            else:
-                                # InvoiceOLD
-                                invoice.update_total_amount()
-                        except Exception as e:
-                            logger.error(f"Error updating invoice {invoice.id}: {e}")
-                    logger.info(f"‚úÖ Updated {len(affected_invoices)} invoices")
-                
-            except Exception as e:
-                logger.error(f"Failed to update cars after unload_date change for container {obj.id}: {e}")
-                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∏–≥–Ω–∞–ª—ã –≤–∫–ª—é—á–µ–Ω—ã –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
-                try:
-                    from django.db.models.signals import post_save, post_delete
-                    from core.signals import update_related_on_car_save, create_car_services_on_car_save, recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete
-                    post_save.connect(update_related_on_car_save, sender=Car)
-                    post_save.connect(create_car_services_on_car_save, sender=Car)
-                    post_save.connect(recalculate_car_price_on_service_save, sender=CarService)
-                    post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService)
-                except:
-                    pass
-
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å THS: –ª–∏–Ω–∏—è, —Å—É–º–º–∞ THS, –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ THS, —Å–∫–ª–∞–¥
-        # –°–∫–ª–∞–¥ –≤–∫–ª—é—á—ë–Ω –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ ths_payer='WAREHOUSE' THS –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞
-        changed_data = getattr(form, 'changed_data', []) if form else []
-        ths_related_changed = any(field in changed_data for field in ['line', 'ths', 'ths_payer', 'warehouse'])
-
-        # –î–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - —Å–æ–∑–¥–∞—ë–º THS –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã line –∏ ths
-        # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è THS –∏–ª–∏ —Å–∫–ª–∞–¥
-        should_create_ths = (not change and obj.line and obj.ths) or (change and ths_related_changed)
-
-        # –µ—Å–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å THS –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ THS –ø–æ–ª—è ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —É—Å–ª—É–≥–∏ THS
-        if should_create_ths:
-            line_start = time.time()
-            try:
-                from django.db.models.signals import post_save, post_delete
-                from core.signals import update_related_on_car_save, create_car_services_on_car_save, create_ths_services_for_container, recalculate_invoices_on_car_service_save, recalculate_invoices_on_car_service_delete
-                from core.models import recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete, LineService, WarehouseService
-                from core.models_billing import NewInvoice
-                
-                logger.info(f"[TIMING] THS-related change started for container {obj.id}, line: {obj.line}, ths: {obj.ths}, ths_payer: {obj.ths_payer}")
-                
-                # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å–∏–≥–Ω–∞–ª—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏ –∏ –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
-                post_save.disconnect(update_related_on_car_save, sender=Car)
-                post_save.disconnect(create_car_services_on_car_save, sender=Car)
-                post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService)
-                post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService)
-                post_save.disconnect(recalculate_invoices_on_car_service_save, sender=CarService)
-                post_delete.disconnect(recalculate_invoices_on_car_service_delete, sender=CarService)
-                
-                try:
-                    # 1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º –ª–∏–Ω–∏—é —É –≤—Å–µ—Ö –∞–≤—Ç–æ
-                    if 'line' in changed_data:
-                        car_ids = list(obj.container_cars.values_list('id', flat=True))
-                        updated_count = obj.container_cars.update(line=obj.line)
-                        logger.info(f"[TIMING] Line updated for {updated_count} cars")
-                    
-                    # 2. –°–æ–∑–¥–∞—ë–º —É—Å–ª—É–≥–∏ THS —Å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
-                    if obj.line and obj.ths:
-                        created_count = create_ths_services_for_container(obj)
-                        logger.info(f"[TIMING] Created {created_count} THS services with proportional distribution")
-                    else:
-                        # –ï—Å–ª–∏ –ª–∏–Ω–∏–∏ –Ω–µ—Ç –∏–ª–∏ THS = 0, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É—Å–ª—É–≥–∏ THS
-                        car_ids = list(obj.container_cars.values_list('id', flat=True))
-                        # –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥–∏ THS –æ—Ç –ª–∏–Ω–∏–π
-                        deleted_line = CarService.objects.filter(
-                            car_id__in=car_ids,
-                            service_type='LINE'
-                        ).filter(
-                            service_id__in=LineService.objects.filter(name__icontains='THS').values_list('id', flat=True)
-                        ).delete()
-                        # –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥–∏ THS –æ—Ç —Å–∫–ª–∞–¥–æ–≤
-                        deleted_wh = CarService.objects.filter(
-                            car_id__in=car_ids,
-                            service_type='WAREHOUSE'
-                        ).filter(
-                            service_id__in=WarehouseService.objects.filter(name__icontains='THS').values_list('id', flat=True)
-                        ).delete()
-                        logger.info(f"[TIMING] Deleted {deleted_line[0]} line THS services and {deleted_wh[0]} warehouse THS services")
-                    
-                    # 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∞–≤—Ç–æ (BULK)
-                    cars_to_update = []
-                    affected_invoices = set()
-                    for car in obj.container_cars.select_related('warehouse').all():
-                        car.update_days_and_storage()
-                        car.calculate_total_price()
-                        cars_to_update.append(car)
-                        # –°–æ–±–∏—Ä–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
-                        for invoice in NewInvoice.objects.filter(cars=car, status__in=['DRAFT', 'ISSUED', 'PARTIALLY_PAID', 'OVERDUE']):
-                            affected_invoices.add(invoice)
-                    
-                    if cars_to_update:
-                        Car.objects.bulk_update(
-                            cars_to_update,
-                            ['days', 'storage_cost', 'total_price'],
-                            batch_size=50
-                        )
-                        logger.info(f"[TIMING] Recalculated prices for {len(cars_to_update)} cars")
-                    
-                    # 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
-                    if affected_invoices:
-                        logger.info(f"[TIMING] Updating {len(affected_invoices)} affected invoices...")
-                        for invoice in affected_invoices:
-                            try:
-                                invoice.regenerate_items_from_cars()
-                            except Exception as e:
-                                logger.error(f"Error updating invoice {invoice.number}: {e}")
-                        logger.info(f"[TIMING] Invoices updated")
-                    
-                    logger.info(f"[TIMING] THS-related change completed in {time.time() - line_start:.2f}s")
-                    
-                finally:
-                    # –í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ
-                    post_save.connect(update_related_on_car_save, sender=Car)
-                    post_save.connect(create_car_services_on_car_save, sender=Car)
-                    post_save.connect(recalculate_car_price_on_service_save, sender=CarService)
-                    post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService)
-                    post_save.connect(recalculate_invoices_on_car_service_save, sender=CarService)
-                    post_delete.connect(recalculate_invoices_on_car_service_delete, sender=CarService)
-                    
-            except Exception as e:
-                logger.error(f"Failed to update cars after line change for container {obj.id}: {e}", exc_info=True)
-
-    def save_formset(self, request, form, formset, change):
-        import time
-        formset_start = time.time()
-        logger.info(f"[TIMING] save_formset started for {formset.model.__name__}")
-        
-        instances = formset.save(commit=False)
-        logger.info(f"[TIMING] formset.save(commit=False) took {time.time() - formset_start:.2f}s")
-        
-        parent = form.instance  # –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
-
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
-        if not parent.pk:
-            logger.error("Parent container doesn't have a primary key - saving parent first")
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –æ–±—ä–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞
-            parent.save()
-            logger.info(f"Saved parent container {parent.pk}")
-
-        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∏ –Ω–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
-        if not instances and not formset.deleted_objects:
-            logger.info(f"[TIMING] No changes in formset, skipping. Total: {time.time() - formset_start:.2f}s")
-            formset.save_m2m()
-            return
-
-        logger.info(f"[TIMING] Processing {len(instances)} changed instances")
-
-        for obj in instances:
-            if isinstance(obj, Car):
-                # –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
-                if not obj.container_id:
-                    obj.container = parent
-
-                # —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ –∫–∞–∫ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-                obj.status = parent.status
-
-                # —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç/–ª–∏–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
-                if not obj.warehouse_id and parent.warehouse_id:
-                    obj.warehouse = parent.warehouse
-                if not obj.client_id and parent.client_id:
-                    obj.client = parent.client
-                if not obj.line_id and parent.line_id:
-                    obj.line = parent.line
-                
-                # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
-                if parent.unload_date:
-                    obj.unload_date = parent.unload_date
-                    logger.debug(f"Car {obj.vin}: inherited unload_date={obj.unload_date} from container {parent.number}")
-
-                creating = obj.pk is None
-                if creating and obj.warehouse_id:
-                    # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (rate/free_days –∏ –ø—Ä.) –î–û –ø–µ—Ä–≤–æ–≥–æ save()
-                    obj.set_initial_warehouse_values()
-
-                # –ø–µ—Ä–µ—Å—á—ë—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
-                obj.update_days_and_storage()
-                
-                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç - —Å–∏–≥–Ω–∞–ª post_save –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç calculate_total_price
-                obj.save()
-                
-                logger.debug(f"Saved Car {obj.vin} (creating={creating}, has_title={obj.has_title})")
-                
-                # –î–ª—è –Ω–æ–≤—ã—Ö –º–∞—à–∏–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—ë–º —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
-                if creating and obj.warehouse_id:
-                    from core.models import WarehouseService, CarService
-                    from decimal import Decimal
-                    
-                    warehouse_services = WarehouseService.objects.filter(
-                        warehouse=obj.warehouse,
-                        is_active=True,
-                        add_by_default=True
-                    )
-                    
-                    for service in warehouse_services:
-                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —É—Å–ª—É–≥–∏
-                        if not CarService.objects.filter(car=obj, service_type='WAREHOUSE', service_id=service.id).exists():
-                            # –î–ª—è "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∏ –Ω–∞—Ü–µ–Ω–∫—É √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
-                            if service.name == '–•—Ä–∞–Ω–µ–Ω–∏–µ':
-                                days = Decimal(str(obj.days or 0))
-                                custom_price = days * Decimal(str(service.default_price or 0))
-                                default_markup = days * Decimal(str(service.default_markup or 0))
-                            else:
-                                custom_price = service.default_price
-                                default_markup = service.default_markup or Decimal('0')
-                            
-                            CarService.objects.create(
-                                car=obj,
-                                service_type='WAREHOUSE',
-                                service_id=service.id,
-                                custom_price=custom_price,
-                                markup_amount=default_markup
-                            )
-                            logger.info(f"üè≠ [FORMSET] –°–æ–∑–¥–∞–Ω–∞ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞ '{service.name}' –¥–ª—è {obj.vin} (—Ü–µ–Ω–∞: {custom_price}, –Ω–∞—Ü–µ–Ω–∫–∞: {default_markup})")
-            else:
-                obj.save()
-
-        # –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
-        deleted_cars = [o for o in formset.deleted_objects if isinstance(o, Car)]
-        logger.info(f"[FORMSET] deleted_objects count: {len(formset.deleted_objects)}, deleted_cars: {len(deleted_cars)}")
-        
-        for o in formset.deleted_objects:
-            try:
-                # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService
-                if isinstance(o, Car):
-                    o.car_services.all().delete()
-                o.delete()
-                logger.info(f"[FORMSET] Deleted object: {o}")
-            except Exception as e:
-                logger.error(f"Error deleting object {o}: {e}")
-
-        formset.save_m2m()
-
-        # –ü–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¢–° (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ) - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS
-        # –£—Å–ª–æ–≤–∏–µ: –µ—Å—Ç—å line, –µ—Å—Ç—å ths, –∏ (–µ—Å—Ç—å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã)
-        cars_changed = bool(instances) or bool(deleted_cars)
-        logger.info(f"[FORMSET] instances count: {len(instances)}, cars_changed: {cars_changed}")
-        logger.info(f"[FORMSET] parent.line: {parent.line}, parent.ths: {parent.ths}")
-        
-        # –í–°–ï–ì–î–ê –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS –µ—Å–ª–∏ –µ—Å—Ç—å line –∏ ths (–¥–∞–∂–µ –±–µ–∑ —è–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
-        if parent.line and parent.ths:
-            try:
-                from core.signals import create_ths_services_for_container
-                from django.db import transaction
-                
-                # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ –ë–î
-                parent.refresh_from_db()
-                
-                logger.info(f"[FORMSET] Starting THS recalculation for container {parent.number}")
-                
-                # –ò—Å–ø–æ–ª—å–∑—É–µ–º savepoint –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
-                with transaction.atomic():
-                    # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS –¥–ª—è –í–°–ï–• –º–∞—à–∏–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-                    cars_in_container = list(parent.container_cars.all())
-                    logger.info(f"[FORMSET] Found {len(cars_in_container)} cars in container")
-                    
-                    if cars_in_container:
-                        created = create_ths_services_for_container(parent)
-                        logger.info(f"[FORMSET] Created/updated {created} THS services for container {parent.number}")
-                        
-                        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –í–°–ï–• –º–∞—à–∏–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è THS
-                        for car in cars_in_container:
-                            car.refresh_from_db()  # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–∑ –ë–î
-                            car.calculate_total_price()
-                            car.save(update_fields=['total_price', 'storage_cost', 'days'])
-                            logger.info(f"[FORMSET] Recalculated price for car {car.vin}: {car.total_price}")
-                        logger.info(f"[FORMSET] Recalculated prices for all {len(cars_in_container)} cars")
-                    else:
-                        logger.info(f"[FORMSET] No cars left in container {parent.number}")
-            except Exception as e:
-                logger.error(f"Failed to create THS services in formset for container {parent.id}: {e}", exc_info=True)
-
-
-    def get_form(self, request, obj=None, **kwargs):
-        form = super().get_form(request, obj, **kwargs)
-        for field in form.base_fields.values():
-            field.help_text = ''
-        return form
-
-    def colored_status(self, obj):
-        color = obj.get_status_color()
-        return format_html(
-            '<span style="background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;">{}</span>',
-            color,
-            obj.get_status_display()
-        )
-    colored_status.short_description = '–°—Ç–∞—Ç—É—Å'
-    
-    def photos_count_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"""
-        count = obj.photos.count()
-        if count > 0:
-            return format_html(
-                '<span style="background-color: #4285f4; color: white; padding: 2px 8px; border-radius: 10px;">üì∑ {}</span>',
-                count
-            )
-        return '-'
-    photos_count_display.short_description = '–§–æ—Ç–æ'
-
-    def set_status_floating(self, request, queryset):
-        updated = queryset.update(status='FLOATING')
-        for obj in queryset:
-            obj.update_days_and_storage()
-            obj.sync_cars()
-            obj.save(update_fields=['days', 'storage_cost'])
-            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-            obj.container_cars.update(status='FLOATING')
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø—É—Ç–∏' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
-    set_status_floating.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø—É—Ç–∏"
-
-    def set_status_in_port(self, request, queryset):
-        updated = queryset.update(status='IN_PORT')
-        for obj in queryset:
-            obj.update_days_and_storage()
-            obj.sync_cars()
-            obj.save(update_fields=['days', 'storage_cost'])
-            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-            obj.container_cars.update(status='IN_PORT')
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
-    set_status_in_port.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É"
-
-    def set_status_unloaded(self, request, queryset):
-        updated = 0
-        for obj in queryset:
-            if obj.warehouse and obj.unload_date:
-                obj.status = 'UNLOADED'
-                obj.update_days_and_storage()
-                obj.sync_cars()
-                obj.save(update_fields=['status', 'days', 'storage_cost'])
-                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-                obj.container_cars.update(status='UNLOADED')
-                updated += 1
-            else:
-                self.message_user(request, f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {obj.number} –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'.", level='warning')
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
-    set_status_unloaded.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –†–∞–∑–≥—Ä—É–∂–µ–Ω"
-
-    def set_status_transferred(self, request, queryset):
-        updated = queryset.update(status='TRANSFERRED')
-        for obj in queryset:
-            obj.update_days_and_storage()
-            obj.sync_cars()
-            obj.save(update_fields=['days', 'storage_cost'])
-            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
-            obj.container_cars.update(status='TRANSFERRED')
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
-    set_status_transferred.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω"
-
-    def check_container_status(self, request, queryset):
-        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
-        updated_count = 0
-        for obj in queryset:
-            try:
-                old_status = obj.status
-                obj.check_and_update_status_from_cars()
-                if obj.status != old_status:
-                    updated_count += 1
-            except Exception as e:
-                logger.error(f"Failed to check status for container {obj.number}: {e}")
-        
-        if updated_count > 0:
-            self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è {updated_count} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.")
-        else:
-            self.message_user(request, "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.")
-    check_container_status.short_description = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
-
-    def bulk_update_container_statuses(self, request, queryset):
-        """–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
-        updated_count = 0
-        skipped_count = 0
-        error_count = 0
-        
-        for container in queryset:
-            try:
-                cars = container.container_cars.all()
-                if not cars.exists():
-                    skipped_count += 1
-                    continue
-                
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
-                all_transferred = all(car.status == 'TRANSFERRED' for car in cars)
-                transferred_cars_count = sum(1 for car in cars if car.status == 'TRANSFERRED')
-                total_cars_count = cars.count()
-                
-                if all_transferred and container.status != 'TRANSFERRED':
-                    old_status = container.status
-                    container.status = 'TRANSFERRED'
-                    container.save(update_fields=['status'])
-                    logger.info(f"Container {container.number} status updated from {old_status} to TRANSFERRED")
-                    updated_count += 1
-                else:
-                    skipped_count += 1
-                    
-            except Exception as e:
-                logger.error(f"Failed to update container {container.number}: {e}")
-                error_count += 1
-        
-        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
-        messages = []
-        if updated_count > 0:
-            messages.append(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: {updated_count}")
-        if skipped_count > 0:
-            messages.append(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: {skipped_count}")
-        if error_count > 0:
-            messages.append(f"–û—à–∏–±–æ–∫: {error_count}")
-        
-        if messages:
-            self.message_user(request, "; ".join(messages))
-        else:
-            self.message_user(request, "–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.")
-    bulk_update_container_statuses.short_description = "–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
-    
-    def sync_photos_from_gdrive(self, request, queryset):
-        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å Google Drive –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"""
-        from .google_drive_sync import GoogleDriveSync
-        
-        total_photos = 0
-        success_count = 0
-        error_count = 0
-        
-        for container in queryset:
-            try:
-                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–∞–ø–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –æ–±–µ–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö
-                container_number = container.number
-                photos_added = 0
-                
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–µ –ø–∞–ø–∫–∏ (–≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
-                for folder_type, folder_id in [
-                    ('unloaded', '1711SSTZ3_YgUcZfNrgNzhscbmlHXlsKb'),
-                    ('in_container', '11poTWYYG3uKTuGTYDWS2m8uA52mlzP6f')
-                ]:
-                    # –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏ –º–µ—Å—è—Ü–µ–≤
-                    month_folders = GoogleDriveSync.get_public_folder_files(folder_id)
-                    
-                    for month_folder in month_folders:
-                        if not month_folder.get('is_folder'):
-                            continue
-                        
-                        # –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
-                        container_folders = GoogleDriveSync.get_public_folder_files(month_folder['id'])
-                        
-                        for container_folder in container_folders:
-                            if container_folder['name'] == container_number:
-                                # –ù–∞—à–ª–∏ –ø–∞–ø–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!
-                                photo_type = 'UNLOADING' if folder_type == 'unloaded' else 'GENERAL'
-                                count = GoogleDriveSync.sync_container_folder(
-                                    container_number,
-                                    container_folder['id'],
-                                    photo_type
-                                )
-                                photos_added += count
-                
-                if photos_added > 0:
-                    success_count += 1
-                    total_photos += photos_added
-                    logger.info(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container_number}: –¥–æ–±–∞–≤–ª–µ–Ω–æ {photos_added} —Ñ–æ—Ç–æ")
-                else:
-                    logger.warning(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container_number}: –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ Google Drive")
-                    
-            except Exception as e:
-                error_count += 1
-                logger.error(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ {container.number}: {e}")
-        
-        # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
-        if total_photos > 0:
-            self.message_user(
-                request,
-                f"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ {total_photos} —Ñ–æ—Ç–æ –¥–ª—è {success_count} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {error_count}",
-                level='SUCCESS'
-            )
-        else:
-            self.message_user(
-                request,
-                f"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ Google Drive. –û—à–∏–±–æ–∫: {error_count}",
-                level='WARNING'
-            )
-    
-    sync_photos_from_gdrive.short_description = "üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive"
-
-    def resend_planned_notifications(self, request, queryset):
-        """–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –¥–∞—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏"""
-        from core.services.email_service import ContainerNotificationService
-        
-        total_sent = 0
-        total_failed = 0
-        containers_processed = 0
-        
-        for container in queryset:
-            if not container.planned_unload_date:
-                self.message_user(
-                    request,
-                    f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏",
-                    level='WARNING'
-                )
-                continue
-            
-            sent, failed = ContainerNotificationService.send_planned_to_all_clients(container, user=request.user)
-            total_sent += sent
-            total_failed += failed
-            if sent > 0:
-                containers_processed += 1
-        
-        if total_sent > 0:
-            self.message_user(
-                request,
-                f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}",
-                level='SUCCESS'
-            )
-        elif total_failed > 0:
-            self.message_user(
-                request,
-                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.",
-                level='ERROR'
-            )
-        else:
-            self.message_user(
-                request,
-                "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)",
-                level='WARNING'
-            )
-    
-    resend_planned_notifications.short_description = "üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ"
-
-    def resend_unload_notifications(self, request, queryset):
-        """–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"""
-        from core.services.email_service import ContainerNotificationService
-        
-        total_sent = 0
-        total_failed = 0
-        containers_processed = 0
-        
-        for container in queryset:
-            if not container.unload_date:
-                self.message_user(
-                    request,
-                    f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏",
-                    level='WARNING'
-                )
-                continue
-            
-            sent, failed = ContainerNotificationService.send_unload_to_all_clients(container, user=request.user)
-            total_sent += sent
-            total_failed += failed
-            if sent > 0:
-                containers_processed += 1
-        
-        if total_sent > 0:
-            self.message_user(
-                request,
-                f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}",
-                level='SUCCESS'
-            )
-        elif total_failed > 0:
-            self.message_user(
-                request,
-                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.",
-                level='ERROR'
-            )
-        else:
-            self.message_user(
-                request,
-                "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)",
-                level='WARNING'
-            )
-    
-    resend_unload_notifications.short_description = "üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ"
-
-    def change_view(self, request, object_id, form_url='', extra_context=None):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —à–∞–±–ª–æ–Ω"""
-        extra_context = extra_context or {}
-        
-        if object_id:
-            obj = self.get_object(request, object_id)
-            if obj:
-                # –¢–æ–ª—å–∫–æ —Å—á–∏—Ç–∞–µ–º —Ñ–æ—Ç–æ - –±—ã—Å—Ç—Ä—ã–π COUNT –∑–∞–ø—Ä–æ—Å
-                # –°–∞–º–∏ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX –ø—Ä–∏ –∫–ª–∏–∫–µ
-                extra_context['photos_count'] = obj.photos.count()
-                extra_context['container_id'] = object_id
-        
-        return super().change_view(request, object_id, form_url, extra_context)
-
-    def get_changelist(self, request, **kwargs):
-        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ '–í –ø–æ—Ä—Ç—É' –∏ '–†–∞–∑–≥—Ä—É–∂–µ–Ω'"""
-        # –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-        if not request.GET.get('status_multi'):
-            # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
-            get_params = request.GET.copy()
-            get_params.setlist('status_multi', ['IN_PORT', 'UNLOADED'])
-            request.GET = get_params
-        return super().get_changelist(request, **kwargs)
-
-@admin.register(Car)
-class CarAdmin(admin.ModelAdmin):
-    change_form_template = 'admin/core/car/change_form.html'
-    change_list_template = 'admin/core/car/change_list.html'  # –ö–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—É–º–º—ã –Ω–∞—Ü–µ–Ω–æ–∫
-    list_display = (
-        'vin', 'brand', 'vehicle_type', 'year_display', 'client', 'colored_status', 'container_display', 'warehouse', 'line',
-        'unload_date_display', 'days_display', 'storage_cost_display', 'total_price_display', 'markup_display', 'has_title'
-    )
-    list_editable = ('has_title',)
-    list_filter = (MultiStatusFilter, ClientAutocompleteFilter, MultiWarehouseFilter)
-    search_fields = ('vin', 'brand')
-    # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è list view
-    list_select_related = ('client', 'warehouse', 'line', 'carrier', 'container')
-    list_prefetch_related = ('car_services',)
-    
-    def get_queryset(self, request):
-        """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π queryset —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π –æ–±—â–µ–π –Ω–∞—Ü–µ–Ω–∫–∏.
-        
-        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç annotate + Sum –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –æ–±—â–µ–π –Ω–∞—Ü–µ–Ω–∫–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º,
-        —á—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç N+1 –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¢–°.
-        """
-        from django.db.models import Sum, F
-        from decimal import Decimal
-        
-        queryset = super().get_queryset(request)
-        
-        # –ê–Ω–Ω–æ—Ç–∏—Ä—É–µ–º –æ–±—â—É—é –Ω–∞—Ü–µ–Ω–∫—É –∏–∑ CarService
-        queryset = queryset.annotate(
-            _total_markup=Sum('car_services__markup_amount')
-        )
-        
-        return queryset
-    readonly_fields = (
-        'default_warehouse_prices_display', 'total_price', 'storage_cost', 'days', 'warehouse_payment_display',
-        'free_days_display', 'rate_display', 'services_summary_display', 'warehouse_services_display', 'line_services_display', 'carrier_services_display', 'company_services_display'
-    )
-    # inlines = []  # –£—Å–ª—É–≥–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª—ã –Ω–∏–∂–µ
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
-            'fields': (
-                ('year', 'brand', 'vehicle_type', 'vin', 'client', 'status'),
-                ('unload_date', 'transfer_date'),
-                ('has_title', 'title_notes'),
-            )
-        }),
-        ('–õ–∏–Ω–∏–∏', {
-            'classes': ('collapse',),
-            'fields': (
-                'line',
-                'line_services_display',
-            )
-        }),
-        ('–°–∫–ª–∞–¥', {
-            'classes': ('collapse',),
-            'fields': (
-                'warehouse',
-                'warehouse_services_display',
-            )
-        }),
-        ('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', {
-            'classes': ('collapse',),
-            'fields': (
-                'carrier',
-                'carrier_services_display',
-            )
-        }),
-        ('–£—Å–ª—É–≥–∏', {
-            'classes': ('collapse',),
-            'fields': (
-                'company_services_display',
-            )
-        }),
-        ('–§–∏–Ω–∞–Ω—Å—ã', {
-            'fields': (
-                'services_summary_display',
-            )
-        }),
-    )
-    actions = ['set_status_floating', 'set_status_in_port', 'set_status_unloaded', 'set_status_transferred', 'set_transferred_today', 'set_title_with_us']
-
-    def set_transferred_today(self, request, queryset):
-        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å '–ü–µ—Ä–µ–¥–∞–Ω' –∏ –¥–∞—Ç—É –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"""
-        from django.utils import timezone
-        
-        today = timezone.now().date()
-        updated = 0
-        
-        for car in queryset:
-            car.status = 'TRANSFERRED'
-            car.transfer_date = today
-            car.save()
-            updated += 1
-        
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏: {today}")
-    set_transferred_today.short_description = "–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è"
-
-    def default_warehouse_prices_display(self, obj):
-        details = obj.warehouse_details()
-        if "message" in details:
-            return details["message"]
-        html = '<table style="width:100%; border:1px solid #ddd; border-collapse:collapse;">'
-        html += '<tr><th style="border:1px solid #ddd; padding:8px;">–ü–æ–ª–µ</th><th style="border:1px solid #ddd; padding:8px;">–¶–µ–Ω–∞</th></tr>'
-        for key, value in details.items():
-            html += f'<tr><td style="border:1px solid #ddd; padding:8px;">{key}</td><td style="border:1px solid #ddd; padding:8px;">{value}</td></tr>'
-        html += '</table>'
-        return format_html(html)
-    default_warehouse_prices_display.short_description = "–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞"
-
-    # --- NEW: renderer –¥–ª—è –ø–æ–ª—è "–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É" ---
-    def warehouse_payment_display(self, obj):
-        return f"{obj.warehouse_payment_amount():.2f}"
-
-    warehouse_payment_display.short_description = '–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É'
-
-
-    def services_summary_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –≤—Å–µ–º —É—Å–ª—É–≥–∞–º —Å –Ω–∞—Ü–µ–Ω–∫–æ–π Caromoto Lithuania"""
-        from decimal import Decimal
-        from core.models import CarService
-        from django.db.models import Sum
-        
-        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
-        obj.update_days_and_storage()
-        
-        # –†–∞–∑–¥–µ–ª—è–µ–º —É—Å–ª—É–≥–∏: –ª–∏–Ω–∏–∏ (–≤—Å–µ + THS –∏–∑ —Å–∫–ª–∞–¥–∞), —Å–∫–ª–∞–¥ (–±–µ–∑ THS), –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫, –∫–æ–º–ø–∞–Ω–∏–∏
-        line_total = Decimal('0.00')  # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS (–¥–∞–∂–µ –µ—Å–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥)
-        warehouse_total = Decimal('0.00')  # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ THS)
-        carrier_total = obj.get_services_total_by_provider('CARRIER')
-        company_total = obj.get_services_total_by_provider('COMPANY')
-        
-        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ –∏ —Ä–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
-        # THS –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π –ª–∏–Ω–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥
-        for service in obj.car_services.all():
-            service_name = service.get_service_name().upper()
-            price = Decimal(str(service.final_price))
-            
-            if service.service_type == 'LINE' or 'THS' in service_name:
-                line_total += price  # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS –∏–∑ —Å–∫–ª–∞–¥–∞
-            elif service.service_type == 'WAREHOUSE':
-                warehouse_total += price  # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –±–µ–∑ THS
-        
-        # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
-        paid_days = obj.days or 0
-        
-        # –°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫ (–∏–∑ —É—Å–ª—É–≥)
-        distributed_markup = obj.car_services.aggregate(total=Sum('markup_amount'))['total'] or Decimal('0')
-        
-        # –ù–∞—Ü–µ–Ω–∫–∞ –∏–∑ –ø–æ–ª—è proft (–µ—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)
-        proft_amount = obj.proft or Decimal('0.00')
-        
-        # –û–±—â–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ = —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è (proft –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
-        total_markup = distributed_markup
-        
-        # –ë–∞–∑–æ–≤—ã–µ —Å—É–º–º—ã (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏)
-        base_total = line_total + warehouse_total + carrier_total + company_total
-        
-        html = ['<div style="margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;">']
-        html.append('<h3 style="margin-top:0; color:#495057;">–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º</h3>')
-        
-        html.append('<div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr; gap:15px; margin-bottom:20px;">')
-        
-        # –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π (THS, –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ì—Ä—É–∑–∏—é –∏ —Ç.–¥.) - —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
-        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
-        html.append('<strong>–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π:</strong><br>')
-        
-        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è THS –∏–∑ —Å–∫–ª–∞–¥–∞)
-        line_services_list = []
-        for service in obj.car_services.all():
-            service_name = service.get_service_name()
-            # THS —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π –ª–∏–Ω–∏–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥
-            if service.service_type == 'LINE' or 'THS' in service_name.upper():
-                price = Decimal(str(service.final_price))
-                line_services_list.append((service_name, price))
-        
-        for name, price in line_services_list:
-            html.append(f'<span style="font-size:13px; color:#6c757d;">{name}: {price:.2f}</span><br>')
-        
-        html.append(f'<span style="font-size:18px; color:#007bff; font-weight:bold;">–ò—Ç–æ–≥–æ: {line_total:.2f}</span>')
-        html.append('</div>')
-        
-        # –°–∫–ª–∞–¥ (–±–µ–∑ THS) - —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π —É—Å–ª—É–≥
-        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
-        html.append('<strong>–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞:</strong><br>')
-        
-        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É —Å–∫–ª–∞–¥–∞ (–∫—Ä–æ–º–µ THS)
-        warehouse_services_list = []
-        for service in obj.car_services.filter(service_type='WAREHOUSE'):
-            service_name = service.get_service_name()
-            if 'THS' not in service_name.upper():
-                # –ò—Å–ø–æ–ª—å–∑—É–µ–º final_price –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç default_price –µ—Å–ª–∏ custom_price –Ω–µ –∑–∞–¥–∞–Ω
-                price = Decimal(str(service.final_price))
-                warehouse_services_list.append((service_name, price))
-        
-        for name, price in warehouse_services_list:
-            html.append(f'<span style="font-size:13px; color:#6c757d;">{name}: {price:.2f}</span><br>')
-        
-        if obj.warehouse:
-            free_days = obj.warehouse.free_days or 0
-            html.append(f'<span style="font-size:12px; color:#adb5bd;">–ë–µ—Å–ø–ª. –¥–Ω–µ–π: {free_days}, –ü–ª–∞—Ç. –¥–Ω–µ–π: {paid_days}</span><br>')
-        
-        html.append(f'<span style="font-size:18px; color:#28a745; font-weight:bold;">–ò—Ç–æ–≥–æ: {warehouse_total:.2f}</span>')
-        html.append('</div>')
-        
-        # –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫
-        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
-        html.append('<strong>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫:</strong><br>')
-        html.append(f'<span style="font-size:18px; color:#ffc107;">{carrier_total:.2f}</span>')
-        html.append('</div>')
-        
-        # –ö–æ–º–ø–∞–Ω–∏–∏
-        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
-        html.append('<strong>–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π:</strong><br>')
-        
-        company_services_list = []
-        for service in obj.car_services.filter(service_type='COMPANY'):
-            try:
-                company_service = CompanyService.objects.select_related('company').get(id=service.service_id)
-                price = Decimal(str(service.final_price))
-                company_services_list.append((company_service.company.name, company_service.name, price))
-            except Exception:
-                continue
-        
-        for company_name, name, price in company_services_list:
-            html.append(f'<span style="font-size:13px; color:#6c757d;">{company_name}: {name}: {price:.2f}</span><br>')
-        
-        html.append(f'<span style="font-size:18px; color:#6f42c1; font-weight:bold;">–ò—Ç–æ–≥–æ: {company_total:.2f}</span>')
-        html.append('</div>')
-        
-        # –ù–∞—Ü–µ–Ω–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é —Å—É–º–º—É
-        html.append('<div style="background:#fffde7; padding:10px; border-radius:5px; border:1px solid #ffc107;">')
-        html.append('<strong style="color:#ff8f00;">–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞:</strong><br>')
-        html.append(f'<span style="font-size:18px; font-weight:bold; color:#ff8f00;">{distributed_markup:.2f}</span>')
-        if distributed_markup > 0:
-            html.append(f'<br><span style="font-size:11px; color:#666;">(—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ —É—Å–ª—É–≥–∞–º)</span>')
-        else:
-            html.append(f'<br><span style="font-size:11px; color:#666;">(–≤–≤–µ–¥–∏—Ç–µ –≤ –∂—ë–ª—Ç—ã—Ö –ø–æ–ª—è—Ö)</span>')
-        html.append('</div>')
-        
-        html.append('</div>')
-        
-        # –û–±—â–∏–π –∏—Ç–æ–≥
-        total_with_markup = base_total + total_markup
-        html.append('<div style="background:white; padding:15px; border-radius:5px; border:2px solid #6c757d;">')
-        html.append('<strong style="color:#6c757d;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong><br>')
-        html.append(f'<span style="font-size:20px; font-weight:bold; color:#495057;">{total_with_markup:.2f} EUR</span>')
-        html.append('</div>')
-        
-        html.append('</div>')
-        
-        return format_html(''.join(html))
-    services_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º'
-
-    def colored_status(self, obj):
-        color = obj.get_status_color()
-        return format_html(
-            '<span style="background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;">{}</span>',
-            color,
-            obj.get_status_display()
-        )
-    colored_status.short_description = '–°—Ç–∞—Ç—É—Å'
-
-    def container_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å—É –º–∞—à–∏–Ω—ã"""
-        if not obj.container:
-            return '-'
-        
-        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—à–∏–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ (–∫–∞–∫ —É —Å—Ç–∞—Ç—É—Å–∞)
-        color = obj.get_status_color()
-        
-        # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
-        container_url = f'/admin/core/container/{obj.container.id}/change/'
-        
-        return format_html(
-            '<a href="{}" target="_blank" style="text-decoration: none;"><span style="background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;">{}</span></a>',
-            container_url,
-            color,
-            obj.container.number
-        )
-    container_display.short_description = '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä'
-    container_display.admin_order_field = 'container__number'
-
-    def year_display(self, obj):
-        return obj.year
-    year_display.short_description = '–ì–æ–¥'
-    year_display.admin_order_field = 'year'
-
-    def unload_date_display(self, obj):
-        return obj.unload_date
-    unload_date_display.short_description = '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'
-    unload_date_display.admin_order_field = 'unload_date'
-
-    def transfer_date_display(self, obj):
-        return obj.transfer_date
-    transfer_date_display.short_description = '–ü–µ—Ä–µ–¥–∞–Ω'
-    transfer_date_display.admin_order_field = 'transfer_date'
-
-    def storage_cost_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π —Å–∫–ª–∞–¥–∞"""
-        try:
-            storage_cost = obj.calculate_storage_cost()
-            return f"{storage_cost:.2f}"
-        except Exception as e:
-            print(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
-            return f"{obj.storage_cost:.2f}"  # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
-    storage_cost_display.short_description = '–•—Ä–∞–Ω'
-    storage_cost_display.admin_order_field = 'storage_cost'
-
-    def days_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Å —É—á–µ—Ç–æ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –∏–∑ —Å–∫–ª–∞–¥–∞"""
-        if obj.warehouse and obj.unload_date:
-            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
-            end_date = obj.transfer_date if obj.status == 'TRANSFERRED' and obj.transfer_date else timezone.now().date()
-            total_days = (end_date - obj.unload_date).days + 1
-            
-            free_days = obj.warehouse.free_days or 0
-            chargeable_days = max(0, total_days - free_days)
-            return f"{chargeable_days} (–∏–∑ {total_days})"
-        return obj.days if hasattr(obj, 'days') else 0
-    days_display.short_description = '–ü–ª–∞—Ç.–¥–Ω.'
-    days_display.admin_order_field = 'days'
-
-    def total_price_display(self, obj):
-        # –î–ª—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
-        if obj.status != 'TRANSFERRED':
-            from decimal import Decimal
-            from django.db.models import Sum
-            from core.models import CarService
-            
-            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
-            obj.update_days_and_storage()
-            
-            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É —É—Å–ª—É–≥ (final_price = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞)
-            base_total = Decimal('0.00')
-            for cs in CarService.objects.filter(car=obj):
-                base_total += Decimal(str(cs.final_price))
-            
-            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –Ω–∞—Ü–µ–Ω–∫—É –∏–∑ CarService
-            distributed_markup = CarService.objects.filter(car=obj).aggregate(
-                total=Sum('markup_amount')
-            )['total'] or Decimal('0.00')
-            
-            total = base_total + distributed_markup
-            return f"{total:.2f}"
-        
-        return f"{obj.total_price:.2f}"
-    total_price_display.short_description = '–¶–µ–Ω–∞'
-    total_price_display.admin_order_field = 'total_price'
-
-    def markup_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±—â—É—é —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –¢–°.
-        
-        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –∏–∑ get_queryset –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
-        –ï—Å–ª–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–∞—Ä—Ç–æ—á–∫–∞ –¢–°), –¥–µ–ª–∞–µ—Ç –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å.
-        """
-        # –ï—Å–ª–∏ –µ—Å—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –∏–∑ get_queryset - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë (–¥–ª—è —Å–ø–∏—Å–∫–∞)
-        if hasattr(obj, '_total_markup'):
-            return f"{obj._total_markup:.2f}" if obj._total_markup else "0.00"
-        
-        # Fallback –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –¢–° –∏–ª–∏ –µ—Å–ª–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
-        from decimal import Decimal
-        from django.db.models import Sum
-        
-        total_markup = obj.car_services.aggregate(
-            total=Sum('markup_amount')
-        )['total'] or Decimal('0.00')
-        
-        return f"{total_markup:.2f}"
-    
-    markup_display.short_description = '–ù'  # –ù = –ù–∞—Ü–µ–Ω–∫–∞
-    markup_display.admin_order_field = '_total_markup'  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
-    
-    def changelist_view(self, request, extra_context=None):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º changelist_view –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã –Ω–∞—Ü–µ–Ω–æ–∫.
-        
-        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–æ–∫ –¥–ª—è –û–¢–û–ë–†–ê–ñ–ê–ï–ú–´–• –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¢–°
-        –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞.
-        """
-        from django.db.models import Sum
-        from decimal import Decimal
-        
-        # –í—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è response
-        response = super().changelist_view(request, extra_context)
-        
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º changelist –∏–∑ response
-            cl = response.context_data['cl']
-            
-            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π queryset (—Ç–µ –¢–°, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è)
-            queryset = cl.get_queryset(request)
-            
-            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¢–°
-            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Sum –±–µ–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
-            total_markup_sum = queryset.aggregate(
-                total=Sum('car_services__markup_amount')
-            )['total'] or Decimal('0.00')
-            
-            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
-            response.context_data['total_markup_sum'] = total_markup_sum
-            
-        except (AttributeError, KeyError):
-            # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É
-            pass
-        
-        return response
-
-    # –£–î–ê–õ–ï–ù–û: current_price_display - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ total_price
-
-    def free_days_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ —Å–∫–ª–∞–¥–∞"""
-        if obj.warehouse:
-            return obj.warehouse.free_days
-        return obj.free_days  # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
-    free_days_display.short_description = 'FREE'
-    free_days_display.admin_order_field = 'free_days'
-    
-    def rate_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∑–∞ —Å—É—Ç–∫–∏ –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞"""
-        if obj.warehouse:
-            daily_rate = obj._get_storage_daily_rate()
-            return f"{daily_rate:.2f}"
-        return "0.00"
-    rate_display.short_description = '–°—Ç–∞–≤–∫–∞/–¥–µ–Ω—å'
-
-    def set_status_floating(self, request, queryset):
-        updated = queryset.update(status='FLOATING')
-        for obj in queryset:
-            obj.update_days_and_storage()
-            obj.save(update_fields=['days', 'storage_cost', 'total_price'])
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø—É—Ç–∏' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
-    set_status_floating.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø—É—Ç–∏"
-
-    def set_status_in_port(self, request, queryset):
-        updated = queryset.update(status='IN_PORT')
-        for obj in queryset:
-            obj.update_days_and_storage()
-            obj.save(update_fields=['days', 'storage_cost', 'total_price'])
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
-    set_status_in_port.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É"
-
-    def set_status_unloaded(self, request, queryset):
-        updated = 0
-        for obj in queryset:
-            if obj.warehouse and obj.unload_date:
-                obj.status = 'UNLOADED'
-                obj.update_days_and_storage()
-                obj.save(update_fields=['status', 'days', 'storage_cost', 'total_price'])
-                updated += 1
-            else:
-                self.message_user(request, f"–ê–≤—Ç–æ–º–æ–±–∏–ª—å {obj.vin} –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'.", level='warning')
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
-    set_status_unloaded.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –†–∞–∑–≥—Ä—É–∂–µ–Ω"
-
-    def set_status_transferred(self, request, queryset):
-        updated = queryset.update(status='TRANSFERRED')
-        for obj in queryset:
-            if obj.status == 'TRANSFERRED' and not obj.transfer_date:
-                obj.transfer_date = timezone.now().date()
-            obj.update_days_and_storage()
-            obj.save(update_fields=['transfer_date', 'days', 'storage_cost', 'total_price'])
-        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
-    set_status_transferred.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω"
-
-    def set_title_with_us(self, request, queryset):
-        logger.info(f"Setting has_title=True for {queryset.count()} cars")
-        updated = queryset.update(has_title=True)
-        for obj in queryset:
-            logger.debug(f"Updating car {obj.vin} with has_title=True")
-            obj.save()
-        self.message_user(request, f"–¢–∞–π—Ç–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ '–£ –Ω–∞—Å' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
-    set_title_with_us.short_description = "–¢–∞–π—Ç–ª —É –Ω–∞—Å"
-
-    class Media:
-        css = {
-            'all': (
-                'css/logist2_custom_admin.css',
-                'style',  # –î–æ–±–∞–≤–ª—è–µ–º inline —Å—Ç–∏–ª–∏
-            )
-        }
-        js = ('js/htmx.min.js', 'js/logist2_htmx.js')
-
-    def get_queryset(self, request):
-        qs = super().get_queryset(request)
-        return qs.select_related('client', 'warehouse', 'container')
-
-    def save_model(self, request, obj, form, change):
-        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ–ª–µ–π —É—Å–ª—É–≥"""
-        super().save_model(request, obj, form, change)
-        
-        # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
-        removed_services = set()
-        for key, value in request.POST.items():
-            if key.startswith('remove_warehouse_service_') and value == '1':
-                service_id = key.replace('remove_warehouse_service_', '')
-                removed_services.add(f'warehouse_{service_id}')
-                try:
-                    deleted_count = CarService.objects.filter(
-                        car=obj,
-                        service_type='WAREHOUSE',
-                        service_id=service_id
-                    ).delete()
-                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                    DeletedCarService.objects.get_or_create(
-                        car=obj,
-                        service_type='WAREHOUSE',
-                        service_id=service_id
-                    )
-                    print(f"Deleted warehouse service {service_id}: {deleted_count}")
-                except Exception as e:
-                    print(f"Error deleting warehouse service {service_id}: {e}")
-            elif key.startswith('remove_line_service_') and value == '1':
-                service_id = key.replace('remove_line_service_', '')
-                removed_services.add(f'line_{service_id}')
-                try:
-                    deleted_count = CarService.objects.filter(
-                        car=obj,
-                        service_type='LINE',
-                        service_id=service_id
-                    ).delete()
-                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                    DeletedCarService.objects.get_or_create(
-                        car=obj,
-                        service_type='LINE',
-                        service_id=service_id
-                    )
-                    print(f"Deleted line service {service_id}: {deleted_count}")
-                except Exception as e:
-                    print(f"Error deleting line service {service_id}: {e}")
-            elif key.startswith('remove_carrier_service_') and value == '1':
-                service_id = key.replace('remove_carrier_service_', '')
-                removed_services.add(f'carrier_{service_id}')
-                try:
-                    deleted_count = CarService.objects.filter(
-                        car=obj,
-                        service_type='CARRIER',
-                        service_id=service_id
-                    ).delete()
-                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                    DeletedCarService.objects.get_or_create(
-                        car=obj,
-                        service_type='CARRIER',
-                        service_id=service_id
-                    )
-                    print(f"Deleted carrier service {service_id}: {deleted_count}")
-                except Exception as e:
-                    print(f"Error deleting carrier service {service_id}: {e}")
-            elif key.startswith('remove_company_service_') and value == '1':
-                service_id = key.replace('remove_company_service_', '')
-                removed_services.add(f'company_{service_id}')
-                try:
-                    deleted_count = CarService.objects.filter(
-                        car=obj,
-                        service_type='COMPANY',
-                        service_id=service_id
-                    ).delete()
-                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                    DeletedCarService.objects.get_or_create(
-                        car=obj,
-                        service_type='COMPANY',
-                        service_id=service_id
-                    )
-                    print(f"Deleted company service {service_id}: {deleted_count}")
-                except Exception as e:
-                    print(f"Error deleting company service {service_id}: {e}")
-        
-        print(f"Removed services: {removed_services}")
-        
-        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞
-        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
-        existing_warehouse_car_services = CarService.objects.filter(
-            car=obj,
-            service_type='WAREHOUSE'
-        )
-        
-        for car_service in existing_warehouse_car_services:
-            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
-            if f'warehouse_{car_service.service_id}' in removed_services:
-                continue
-            
-            field_name = f'warehouse_service_{car_service.service_id}'
-            value = request.POST.get(field_name)
-            
-            if value:
-                try:
-                    car_service.custom_price = float(value)
-                except (ValueError, TypeError):
-                    pass
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É
-            markup_field = f'markup_warehouse_service_{car_service.service_id}'
-            markup_value = request.POST.get(markup_field, '0')
-            try:
-                car_service.markup_amount = float(markup_value) if markup_value else 0
-            except (ValueError, TypeError):
-                car_service.markup_amount = 0
-            car_service.save()
-        
-        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
-        if obj.warehouse:
-            warehouse_services = WarehouseService.objects.filter(
-                warehouse=obj.warehouse, 
-                is_active=True,
-                default_price__gt=0
-            ).only('id', 'default_price')
-            
-            existing_car_service_ids = set(existing_warehouse_car_services.values_list('service_id', flat=True))
-            
-            # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
-            deleted_services = DeletedCarService.objects.filter(
-                car=obj,
-                service_type='WAREHOUSE'
-            ).values_list('service_id', flat=True)
-            
-            for service in warehouse_services:
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
-                if f'warehouse_{service.id}' in removed_services:
-                    continue
-                
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                if service.id in deleted_services:
-                    continue
-                
-                # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
-                if service.id not in existing_car_service_ids:
-                    field_name = f'warehouse_service_{service.id}'
-                    value = request.POST.get(field_name) or service.default_price
-                    # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏
-                    default_markup = getattr(service, 'default_markup', 0) or 0
-                    CarService.objects.create(
-                        car=obj,
-                        service_type='WAREHOUSE',
-                        service_id=service.id,
-                        custom_price=float(value),
-                        markup_amount=float(default_markup)
-                    )
-        
-        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏
-        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è THS)
-        existing_line_car_services = CarService.objects.filter(
-            car=obj,
-            service_type='LINE'
-        )
-        
-        for car_service in existing_line_car_services:
-            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
-            if f'line_{car_service.service_id}' in removed_services:
-                continue
-            
-            field_name = f'line_service_{car_service.service_id}'
-            value = request.POST.get(field_name)
-            
-            if value:
-                try:
-                    car_service.custom_price = float(value)
-                except (ValueError, TypeError):
-                    pass
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É
-            markup_field = f'markup_line_service_{car_service.service_id}'
-            markup_value = request.POST.get(markup_field, '0')
-            try:
-                car_service.markup_amount = float(markup_value) if markup_value else 0
-            except (ValueError, TypeError):
-                car_service.markup_amount = 0
-            car_service.save()
-        
-        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
-        if obj.line:
-            line_services = LineService.objects.filter(
-                line=obj.line, 
-                is_active=True,
-                default_price__gt=0
-            ).only('id', 'default_price')
-            
-            existing_car_service_ids = set(existing_line_car_services.values_list('service_id', flat=True))
-            
-            # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
-            deleted_services = DeletedCarService.objects.filter(
-                car=obj,
-                service_type='LINE'
-            ).values_list('service_id', flat=True)
-            
-            for service in line_services:
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
-                if f'line_{service.id}' in removed_services:
-                    continue
-                
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                if service.id in deleted_services:
-                    continue
-                
-                # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
-                if service.id not in existing_car_service_ids:
-                    field_name = f'line_service_{service.id}'
-                    value = request.POST.get(field_name) or service.default_price
-                    # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏
-                    default_markup = getattr(service, 'default_markup', 0) or 0
-                    CarService.objects.create(
-                        car=obj,
-                        service_type='LINE',
-                        service_id=service.id,
-                        custom_price=float(value),
-                        markup_amount=float(default_markup)
-                    )
-        
-        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
-        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
-        existing_carrier_car_services = CarService.objects.filter(
-            car=obj,
-            service_type='CARRIER'
-        )
-        
-        for car_service in existing_carrier_car_services:
-            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
-            if f'carrier_{car_service.service_id}' in removed_services:
-                continue
-            
-            field_name = f'carrier_service_{car_service.service_id}'
-            value = request.POST.get(field_name)
-            
-            if value:
-                try:
-                    car_service.custom_price = float(value)
-                except (ValueError, TypeError):
-                    pass
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É
-            markup_field = f'markup_carrier_service_{car_service.service_id}'
-            markup_value = request.POST.get(markup_field, '0')
-            try:
-                car_service.markup_amount = float(markup_value) if markup_value else 0
-            except (ValueError, TypeError):
-                car_service.markup_amount = 0
-            car_service.save()
-        
-        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
-        if obj.carrier:
-            carrier_services = CarrierService.objects.filter(
-                carrier=obj.carrier, 
-                is_active=True,
-                default_price__gt=0
-            ).only('id', 'default_price')
-            
-            existing_car_service_ids = set(existing_carrier_car_services.values_list('service_id', flat=True))
-            
-            # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
-            deleted_services = DeletedCarService.objects.filter(
-                car=obj,
-                service_type='CARRIER'
-            ).values_list('service_id', flat=True)
-            
-            for service in carrier_services:
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
-                if f'carrier_{service.id}' in removed_services:
-                    continue
-                
-                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
-                if service.id in deleted_services:
-                    continue
-                
-                # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
-                if service.id not in existing_car_service_ids:
-                    field_name = f'carrier_service_{service.id}'
-                    value = request.POST.get(field_name) or service.default_price
-                    # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏
-                    default_markup = getattr(service, 'default_markup', 0) or 0
-                    CarService.objects.create(
-                        car=obj,
-                        service_type='CARRIER',
-                        service_id=service.id,
-                        custom_price=float(value),
-                        markup_amount=float(default_markup)
-                    )
-
-        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π
-        existing_company_car_services = CarService.objects.filter(
-            car=obj,
-            service_type='COMPANY'
-        )
-        
-        for car_service in existing_company_car_services:
-            if f'company_{car_service.service_id}' in removed_services:
-                continue
-            
-            field_name = f'company_service_{car_service.service_id}'
-            value = request.POST.get(field_name)
-            
-            if value:
-                try:
-                    car_service.custom_price = float(value)
-                except (ValueError, TypeError):
-                    pass
-            
-            markup_field = f'markup_company_service_{car_service.service_id}'
-            markup_value = request.POST.get(markup_field, '0')
-            try:
-                car_service.markup_amount = float(markup_value) if markup_value else 0
-            except (ValueError, TypeError):
-                car_service.markup_amount = 0
-            car_service.save()
-        
-        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –¥–Ω–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞
-        if change and form and 'warehouse' in getattr(form, 'changed_data', []):
-            print(f"–°–∫–ª–∞–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è {obj.vin}, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è")
-            try:
-                # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
-                obj.update_days_and_storage()
-                obj.calculate_total_price()
-                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è
-                obj.save(update_fields=['storage_cost', 'days', 'total_price'])
-                print(f"–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–ª—è: storage_cost={obj.storage_cost}, days={obj.days}")
-            except Exception as e:
-                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
-
-    def warehouse_services_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤"""
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–æ—Ç –ª—é–±—ã—Ö —Å–∫–ª–∞–¥–æ–≤)
-            car_services = CarService.objects.filter(
-                car=obj, 
-                service_type='WAREHOUSE'
-            ).select_related('car')
-            
-            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
-            
-            if car_services:
-                for car_service in car_services:
-                    try:
-                        # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏ –∏ —Å–∫–ª–∞–¥–∞
-                        service = WarehouseService.objects.select_related('warehouse').get(id=car_service.service_id)
-                        current_value = car_service.custom_price or service.default_price
-                        markup_value = car_service.markup_amount or 0
-                        warehouse_name = service.warehouse.name
-                        
-                        # –ü–æ–¥—Å–≤–µ—Ç–∫–∞: –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥ - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥–∏–µ - –∂–µ–ª—Ç—ã–π
-                        bg_color = "#e8f5e9" if (obj.warehouse and service.warehouse.id == obj.warehouse.id) else "#fff9e6"
-                        
-                        html += f'''
-                        <div style="border: 1px solid #ddd; padding: 10px; background: {bg_color}; position: relative; min-width: 220px;">
-                            <button type="button" onclick="removeService({service.id}, 'warehouse')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
-                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">üì¶ {warehouse_name}</div>
-                            <strong>{service.name}</strong><br>
-                            <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
-                                <input type="number" name="warehouse_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
-                                <span style="color: #28a745; font-weight: bold;">+</span>
-                                <input type="number" name="markup_warehouse_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
-                            </div>
-                            <input type="hidden" name="remove_warehouse_service_{service.id}" id="remove_warehouse_service_{service.id}" value="">
-                        </div>
-                        '''
-                    except Exception as e:
-                        continue
-            
-            html += '</div>'
-            
-            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ - —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
-            html += f'''
-            <div style="margin-top: 10px;">
-                <button type="button" class="add-service-btn" onclick="openModal('warehouseServicesModal', 'warehouse')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª—é–±–æ–≥–æ —Å–∫–ª–∞–¥–∞">
-                    +
-                </button>
-                <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞</span>
-            </div>
-            '''
-            
-            # –î–æ–±–∞–≤–ª—è–µ–º JavaScript –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥
-            html += '''
-            <script>
-            function removeService(serviceId, serviceType) {
-                const serviceDiv = event.target.closest('div');
-                serviceDiv.style.display = 'none';
-                const hiddenField = document.getElementById('remove_' + serviceType + '_service_' + serviceId);
-                hiddenField.value = '1';
-                console.log('Removed service:', serviceType, serviceId, 'Field value:', hiddenField.value);
-            }
-            </script>
-            '''
-            
-            return mark_safe(html)
-        except Exception as e:
-            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
-    warehouse_services_display.short_description = "–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞"
-
-    def line_services_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏"""
-        if not obj.line:
-            return "–õ–∏–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞"
-        
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º
-            car_services = CarService.objects.filter(
-                car=obj, 
-                service_type='LINE'
-            )
-            
-            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
-            
-            for car_service in car_services:
-                try:
-                    # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏
-                    service = LineService.objects.get(id=car_service.service_id)
-                    current_value = car_service.custom_price or service.default_price
-                    markup_value = car_service.markup_amount or 0
-                    
-                    html += f'''
-                    <div style="border: 1px solid #ddd; padding: 10px; background: #e3f2fd; position: relative; min-width: 200px;">
-                        <button type="button" onclick="removeService({service.id}, 'line')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
-                        <strong>{service.name}</strong><br>
-                        <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
-                            <input type="number" name="line_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
-                            <span style="color: #28a745; font-weight: bold;">+</span>
-                            <input type="number" name="markup_line_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
-                        </div>
-                        <input type="hidden" name="remove_line_service_{service.id}" id="remove_line_service_{service.id}" value="">
-                    </div>
-                    '''
-                except:
-                    continue
-            
-            html += '</div>'
-            
-            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥
-            if obj.line:
-                html += f'''
-                <div style="margin-top: 10px;">
-                    <button type="button" class="add-service-btn" onclick="openModal('lineServicesModal', 'line')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏">
-                        +
-                    </button>
-                    <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏</span>
-                </div>
-                '''
-            
-            if not car_services:
-                html += '<div style="margin-top: 8px; color: #6c757d;">–£—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú+‚Äù.</div>'
-            
-            return mark_safe(html)
-        except Exception as e:
-            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
-    line_services_display.short_description = "–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏"
-
-    def carrier_services_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
-        if not obj.carrier:
-            return "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω"
-        
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º
-            car_services = CarService.objects.filter(
-                car=obj, 
-                service_type='CARRIER'
-            )
-            
-            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
-            
-            for car_service in car_services:
-                try:
-                    # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏
-                    service = CarrierService.objects.get(id=car_service.service_id)
-                    current_value = car_service.custom_price or service.default_price
-                    markup_value = car_service.markup_amount or 0
-                    
-                    html += f'''
-                    <div style="border: 1px solid #ddd; padding: 10px; background: #fff3e0; position: relative; min-width: 200px;">
-                        <button type="button" onclick="removeService({service.id}, 'carrier')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
-                        <strong>{service.name}</strong><br>
-                        <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
-                            <input type="number" name="carrier_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
-                            <span style="color: #28a745; font-weight: bold;">+</span>
-                            <input type="number" name="markup_carrier_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
-                        </div>
-                        <input type="hidden" name="remove_carrier_service_{service.id}" id="remove_carrier_service_{service.id}" value="">
-                    </div>
-                    '''
-                except:
-                    continue
-            
-            html += '</div>'
-            
-            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥
-            if obj.carrier:
-                html += f'''
-                <div style="margin-top: 10px;">
-                    <button type="button" class="add-service-btn" onclick="openModal('carrierServicesModal', 'carrier')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞">
-                        +
-                    </button>
-                    <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞</span>
-                </div>
-                '''
-            
-            if not car_services:
-                html += '<div style="margin-top: 8px; color: #6c757d;">–£—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú+‚Äù.</div>'
-            
-            return mark_safe(html)
-        except Exception as e:
-            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
-    carrier_services_display.short_description = "–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-
-    def company_services_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π"""
-        try:
-            car_services = CarService.objects.filter(
-                car=obj,
-                service_type='COMPANY'
-            )
-            
-            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
-            
-            if car_services:
-                for car_service in car_services:
-                    try:
-                        service = CompanyService.objects.select_related('company').get(id=car_service.service_id)
-                        current_value = car_service.custom_price if car_service.custom_price is not None else service.default_price
-                        markup_value = car_service.markup_amount or 0
-                        
-                        html += f'''
-                        <div style="border: 1px solid #ddd; padding: 10px; background: #f3e8ff; position: relative; min-width: 240px;">
-                            <button type="button" onclick="removeService({service.id}, 'company')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
-                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">üè¢ {service.company.name}</div>
-                            <strong>{service.name}</strong><br>
-                            <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
-                                <input type="number" name="company_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
-                                <span style="color: #28a745; font-weight: bold;">+</span>
-                                <input type="number" name="markup_company_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
-                            </div>
-                            <input type="hidden" name="remove_company_service_{service.id}" id="remove_company_service_{service.id}" value="">
-                        </div>
-                        '''
-                    except Exception:
-                        continue
-            
-            html += '</div>'
-            
-            html += f'''
-            <div style="margin-top: 10px;">
-                <button type="button" class="add-service-btn" onclick="openModal('companyServicesModal', 'company')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏">
-                    +
-                </button>
-                <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏</span>
-            </div>
-            '''
-            
-            return mark_safe(html)
-        except Exception as e:
-            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
-    company_services_display.short_description = "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π"
-
-    def get_changelist(self, request, **kwargs):
-        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ '–í –ø–æ—Ä—Ç—É' –∏ '–†–∞–∑–≥—Ä—É–∂–µ–Ω'"""
-        # –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-        if not request.GET.get('status_multi'):
-            # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
-            get_params = request.GET.copy()
-            get_params.setlist('status_multi', ['IN_PORT', 'UNLOADED'])
-            request.GET = get_params
-        return super().get_changelist(request, **kwargs)
-
-# WarehouseServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏"
-
-
-# –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–¥–º–∏–Ω
-# @admin.register(Warehouse)
-# class WarehouseAdmin(admin.ModelAdmin):
-
-@admin.register(Warehouse)
-class WarehouseAdmin(admin.ModelAdmin):
-    list_display = ('name', 'address', 'free_days', 'balance_display')
-    search_fields = ('name', 'address')
-    readonly_fields = ('balance',)
-    exclude = (
-        'default_unloading_fee', 'delivery_to_warehouse', 'loading_on_trawl',
-        'documents_fee', 'transfer_fee', 'transit_declaration', 'export_declaration',
-        'additional_expenses', 'complex_fee'
-    )
-    inlines = [WarehouseServiceInline]
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
-            'fields': ('name', 'address')
-        }),
-        ('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è', {
-            'fields': ('free_days',),
-            'description': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è. –°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.'
-        }),
-        ('–ë–∞–ª–∞–Ω—Å', {
-            'fields': ('balance',),
-            'description': '–ë–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞'
-        }),
-    )
-
-    def balance_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞"""
-        try:
-            balance = obj.balance or 0
-            color = '#28a745' if balance >= 0 else '#dc3545'
-            sign = '+' if balance >= 0 else ''
-            return format_html(
-                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
-                color, sign, balance
-            )
-        except:
-            return '-'
-    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
-
-    def balance_summary_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–∫–ª–∞–¥–∞"""
-        try:
-            balance = obj.balance or 0
-            
-            html = f"""
-            <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;">
-                <h3 style="margin-top:0; color:#495057;">–ë–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞</h3>
-                
-                <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
-                    <strong>–ë–∞–ª–∞–Ω—Å:</strong><br>
-                    <span style="font-size:18px; color:{'#28a745' if balance >= 0 else '#dc3545'};">{balance:.2f}</span>
-                </div>
-                </div>
-                
-                <div style="background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};">
-                    <strong style="color:{'#28a745' if total_balance >= 0 else '#dc3545'};">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</strong><br>
-                    <span style="font-size:24px; font-weight:bold; color:{'#28a745' if total_balance >= 0 else '#dc3545'};">{total_balance:.2f}</span>
-                </div>
-            </div>
-            """
-            
-            return format_html(html)
-        except Exception as e:
-            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {e}</p>')
-    balance_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É'
-
-    def balance_transactions_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–∫–ª–∞–¥–∞"""
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞
-            payments = Payment.objects.filter(
-                models.Q(from_warehouse=obj) | models.Q(to_warehouse=obj)
-            ).order_by('-date', '-id')[:20]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–ª–∞—Ç–µ–∂–µ–π
-            
-            if not payments.exists():
-                return format_html('<p style="color:#6c757d;">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>')
-            
-            html = ['<div style="margin-top:15px;">']
-            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>')
-            html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
-            html.append('<tr style="background-color:#f8f9fa;">')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–î–∞—Ç–∞</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–¢–∏–ø</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>')
-            html.append('</tr>')
-            
-            for payment in payments:
-                amount_color = '#28a745' if payment.to_warehouse == obj else '#dc3545'
-                html.append('<tr>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.date.strftime("%d.%m.%Y")}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.payment_type}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;">{payment.amount:.2f}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.sender}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.recipient}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.description or "-"}</td>')
-                html.append('</tr>')
-            
-            html.append('</table>')
-            html.append('</div>')
-            
-            return format_html(''.join(html))
-        except Exception as e:
-            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>')
-    balance_transactions_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏'
-    
-    def reset_warehouse_balance(self, request, queryset):
-        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤"""
-        from django.contrib import messages
-        
-        try:
-            for warehouse in queryset:
-                warehouse.balance = 0
-                warehouse.save()
-            
-            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} —Å–∫–ª–∞–¥–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
-        except Exception as e:
-            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
-    
-    reset_warehouse_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤'
-
-
-
-    def change_view(self, request, object_id, form_url='', extra_context=None):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥"""
-        extra_context = extra_context or {}
-        
-        if object_id:
-            obj = self.get_object(request, object_id)
-            
-            if request.method == 'POST':
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
-                for key, value in request.POST.items():
-                    if key.startswith('service_name_'):
-                        service_id = key.replace('service_name_', '')
-                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ)
-                        if service_id.isdigit():
-                            try:
-                                service = WarehouseService.objects.get(id=service_id, warehouse=obj)
-                                service.name = value
-                                service.save()
-                            except WarehouseService.DoesNotExist:
-                                pass
-                    elif key.startswith('service_price_'):
-                        service_id = key.replace('service_price_', '')
-                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ)
-                        if service_id.isdigit():
-                            try:
-                                service = WarehouseService.objects.get(id=service_id, warehouse=obj)
-                                service.default_price = float(value) if value else 0
-                                service.save()
-                            except (WarehouseService.DoesNotExist, ValueError):
-                                pass
-                    elif key.startswith('delete_service_'):
-                        service_id = key.replace('delete_service_', '')
-                        try:
-                            service = WarehouseService.objects.get(id=service_id, warehouse=obj)
-                            service.delete()
-                        except WarehouseService.DoesNotExist:
-                                pass
-                
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è —É—Å–ª—É–≥
-                old_fields_mapping = {
-                    'service_price_complex': 'complex_fee',
-                    'service_price_unloading': 'default_unloading_fee',
-                    'service_price_delivery': 'delivery_to_warehouse',
-                    'service_price_loading': 'loading_on_trawl',
-                    'service_price_documents': 'documents_fee',
-                    'service_price_transfer': 'transfer_fee',
-                    'service_price_transit': 'transit_declaration',
-                    'service_price_export': 'export_declaration',
-                    'service_price_additional': 'additional_expenses',
-                    'service_price_rate': 'rate',
-                }
-                
-                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –Ω—É–∂–Ω–æ –æ–±–Ω—É–ª–∏—Ç—å
-                for key, value in request.POST.items():
-                    if key.startswith('clear_field_'):
-                        field_name = key.replace('clear_field_', '')
-                        setattr(obj, field_name, 0)
-                        obj.save()
-                
-                # –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
-                for field_name, model_field in old_fields_mapping.items():
-                    if field_name in request.POST:
-                        try:
-                            value = float(request.POST[field_name]) if request.POST[field_name] else 0
-                            setattr(obj, model_field, value)
-                            obj.save()
-                        except ValueError:
-                            pass
-                
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏
-                for key, value in request.POST.items():
-                    if key.startswith('new_service_name_'):
-                        index = key.replace('new_service_name_', '')
-                        name = value
-                        price = request.POST.get(f'new_service_price_{index}', 0)
-                        
-                        if name:
-                            try:
-                                WarehouseService.objects.create(
-                                    warehouse=obj,
-                                    name=name,
-                                    default_price=float(price) if price else 0
-                                )
-                            except ValueError:
-                                pass
-        
-        return super().change_view(request, object_id, form_url, extra_context)
-
-
-# ============================================================================
-# –°–¢–ê–†–ê–Ø –ê–î–ú–ò–ù–ö–ê INVOICE - –£–î–ê–õ–ï–ù–ê
-# ============================================================================
-# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ NewInvoiceAdmin –∏–∑ admin_billing.py
-# ============================================================================
-
-# @admin.register(InvoiceOLD)  # –û—Ç–∫–ª—é—á–µ–Ω–æ
-
-# ============================================================================
-# –°–¢–ê–†–ê–Ø –ê–î–ú–ò–ù–ö–ê PAYMENT - –£–î–ê–õ–ï–ù–ê
-# ============================================================================
-# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TransactionAdmin –∏–∑ admin_billing.py
-# ============================================================================
-
-# @admin.register(PaymentOLD)  # –û—Ç–∫–ª—é—á–µ–Ω–æ
-
-@admin.register(Client)
-class ClientAdmin(admin.ModelAdmin):
-    change_form_template = 'admin/client_change.html'
-    list_display = ('name', 'emails_display', 'notification_enabled', 'new_balance_display', 'balance_status_new')
-    list_filter = ('name', 'notification_enabled')
-    search_fields = ('name', 'email', 'email2', 'email3', 'email4')
-    actions = ['reset_balances', 'recalculate_balance', 'reset_client_balance']
-    readonly_fields = ('balance', 'balance_updated_at', 'new_invoices_display', 'new_transactions_display')
-
-    def get_queryset(self, request):
-        """–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º with_balance_info –¥–ª—è –ø—Ä–µ–¥—Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"""
-        qs = super().get_queryset(request)
-        # –î–ª—è list view –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å annotate
-        if 'changelist' in request.path:
-            return qs.with_balance_info()
-        return qs
-
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'fields': ('name', 'notification_enabled')
-        }),
-        ('üìß Email-–∞–¥—Ä–µ—Å–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', {
-            'fields': ('email', 'email2', 'email3', 'email4'),
-            'description': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞'
-        }),
-        ('üí∞ –ë–∞–ª–∞–Ω—Å', {
-            'fields': ('balance', 'balance_updated_at', 'new_invoices_display', 'new_transactions_display'),
-            'description': '–ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π'
-        }),
-    )
-    
-    def emails_display(self, obj):
-        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ email-–∞–¥—Ä–µ—Å–æ–≤"""
-        emails = obj.get_notification_emails()
-        count = len(emails)
-        if count == 0:
-            return format_html('<span style="color: #999;">‚Äî</span>')
-        elif count == 1:
-            return format_html('<span title="{}">{}</span>', emails[0], emails[0])
-        else:
-            all_emails = ', '.join(emails)
-            return format_html('<span title="{}">{} (+{})</span>', all_emails, emails[0], count - 1)
-    emails_display.short_description = 'Email'
-
-    def real_balance_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ (–∏–Ω–≤–æ–π—Å—ã - –ø–ª–∞—Ç–µ–∂–∏)"""
-        balance = obj.real_balance
-        color = obj.balance_color
-        sign = '' if balance == 0 else ('+' if balance > 0 else '')
-        formatted = f"{balance:.2f}"
-        
-        return format_html(
-            '<span style="color:{}; font-weight:bold; font-size:14px;">{} {}</span>',
-            color, sign, formatted
-        )
-    real_balance_display.short_description = '–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å (–î–æ–ª–≥/–ü–µ—Ä–µ–ø–ª–∞—Ç–∞)'
-    real_balance_display.admin_order_field = '_real_balance_annotated'
-
-    def balance_status_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ —Ü–≤–µ—Ç–Ω—ã–º –±–µ–π–¥–∂–µ–º"""
-        status = obj.balance_status
-        color = obj.balance_color
-        bg_color = color.replace('#', '')
-        
-        return format_html(
-            '<span style="background-color:{}; color:white; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold;">{}</span>',
-            color, status
-        )
-    balance_status_display.short_description = '–°—Ç–∞—Ç—É—Å'
-
-    def new_balance_display(self, obj):
-        """–ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê - –µ–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å"""
-        balance = obj.balance
-        if balance > 0:
-            color = '#28a745'
-            text = f'+{balance:.2f}'
-        elif balance < 0:
-            color = '#dc3545'
-            text = f'{balance:.2f}'
-        else:
-            color = '#6c757d'
-            text = '0.00'
-        
-        return format_html(
-            '<span style="color:{}; font-weight:bold; font-size:15px;">{}</span>',
-            color, text
-        )
-    new_balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
-    new_balance_display.admin_order_field = 'balance'
-    
-    def balance_status_new(self, obj):
-        """–°—Ç–∞—Ç—É—Å –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞"""
-        balance = obj.balance
-        if balance > 0:
-            return format_html('<span style="background:#28a745; color:white; padding:3px 8px; border-radius:3px;">–ü–ï–†–ï–ü–õ–ê–¢–ê</span>')
-        elif balance < 0:
-            return format_html('<span style="background:#dc3545; color:white; padding:3px 8px; border-radius:3px;">–î–û–õ–ì</span>')
-        else:
-            return format_html('<span style="background:#6c757d; color:white; padding:3px 8px; border-radius:3px;">OK</span>')
-    balance_status_new.short_description = '–°—Ç–∞—Ç—É—Å'
-    
-    def new_invoices_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã"""
-        from core.models_billing import NewInvoice
-        
-        invoices = NewInvoice.objects.filter(recipient_client=obj).order_by('-date')[:10]
-        
-        if not invoices:
-            return format_html('<p style="color:#999;">–ò–Ω–≤–æ–π—Å–æ–≤ –µ—â–µ –Ω–µ—Ç. <a href="/admin/core/newinvoice/add/">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≤–æ–π—Å</a></p>')
-        
-        html = '<table style="width:100%; border-collapse:collapse;">'
-        html += '<tr style="background:#f5f5f5;"><th style="padding:8px;">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–û–ø–ª–∞—á–µ–Ω–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr>'
-        
-        for inv in invoices:
-            status_color = {'PAID': '#28a745', 'ISSUED': '#007bff', 'OVERDUE': '#dc3545'}.get(inv.status, '#6c757d')
-            html += f'''<tr style="border-bottom:1px solid #ddd;">
-                <td style="padding:8px;"><a href="/admin/core/newinvoice/{inv.pk}/change/">{inv.number}</a></td>
-                <td style="padding:8px;">{inv.date.strftime("%d.%m.%Y")}</td>
-                <td style="padding:8px;">{inv.total:.2f}</td>
-                <td style="padding:8px;">{inv.paid_amount:.2f}</td>
-                <td style="padding:8px;"><span style="background:{status_color}; color:white; padding:2px 6px; border-radius:3px;">{inv.get_status_display()}</span></td>
-            </tr>'''
-        
-        html += '</table>'
-        return format_html(html)
-    new_invoices_display.short_description = '–ò–Ω–≤–æ–π—Å—ã'
-    
-    def new_transactions_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã"""
-        from core.models_billing import Transaction
-        
-        transactions = Transaction.objects.filter(
-            models.Q(from_client=obj) | models.Q(to_client=obj)
-        ).order_by('-date')[:10]
-        
-        if not transactions:
-            return format_html('<p style="color:#999;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –µ—â–µ –Ω–µ—Ç</p>')
-        
-        html = '<table style="width:100%; border-collapse:collapse;">'
-        html += '<tr style="background:#f5f5f5;"><th style="padding:8px;">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th></tr>'
-        
-        for trx in transactions:
-            type_color = {'PAYMENT': '#28a745', 'REFUND': '#dc3545'}.get(trx.type, '#007bff')
-            direction = '‚Üë –ü–æ–ª—É—á–µ–Ω–æ' if trx.to_client == obj else '‚Üì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'
-            html += f'''<tr style="border-bottom:1px solid #ddd;">
-                <td style="padding:8px;"><a href="/admin/core/transaction/{trx.pk}/change/">{trx.number}</a></td>
-                <td style="padding:8px;">{trx.date.strftime("%d.%m.%Y %H:%M")}</td>
-                <td style="padding:8px;"><span style="background:{type_color}; color:white; padding:2px 6px; border-radius:3px;">{trx.get_type_display()}</span></td>
-                <td style="padding:8px; font-weight:bold;">{trx.amount:.2f}</td>
-                <td style="padding:8px;">{direction}</td>
-            </tr>'''
-        
-        html += '</table>'
-        return format_html(html)
-    new_transactions_display.short_description = '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'
-
-    def recalculate_balance(self, request, queryset):
-        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
-        from django.contrib import messages
-        
-        count = 0
-        for client in queryset:
-            try:
-                # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
-                client.sync_balance_fields()
-                count += 1
-                messages.success(request, f'–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω')
-            except Exception as e:
-                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}: {e}')
-        
-        if count > 0:
-            messages.success(request, f'–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è {count} –∫–ª–∏–µ–Ω—Ç–æ–≤')
-        else:
-            messages.warning(request, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞')
-    
-    recalculate_balance.short_description = '–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å'
-
-    def sync_all_balances(self, request, queryset):
-        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–æ–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
-        from django.contrib import messages
-        
-        count = 0
-        for client in queryset:
-            try:
-                client.sync_balance_fields()
-                count += 1
-                messages.success(request, f'–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω')
-            except Exception as e:
-                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}: {e}')
-        
-        if count > 0:
-            messages.success(request, f'–£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è {count} –∫–ª–∏–µ–Ω—Ç–æ–≤')
-        else:
-            messages.warning(request, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞')
-    
-    sync_all_balances.short_description = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å—ã'
-
-    def get_queryset(self, request):
-        """–ü–æ–ª—É—á–∞–µ–º queryset —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π"""
-        return Client.objects.with_balance_info()
-
-    def change_view(self, request, object_id, form_url='', extra_context=None):
-        extra_context = extra_context or {}
-        client = self.get_object(request, object_id)
-        if client:
-            try:
-                summary = client.get_balance_summary()
-                extra_context['balance_summary'] = summary
-            except Exception as e:
-                logger.error(f"Failed to get balance summary for client {client.name}: {e}")
-                extra_context['balance_summary_error'] = f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {str(e)}"
-        return super().change_view(request, object_id, form_url, extra_context)
-
-    def reset_balances(self, request, queryset):
-        if 'confirm' in request.POST:
-            client_ids = request.POST.getlist('_selected_action')
-            clients = Client.objects.filter(id__in=client_ids)
-            from django.core.management import call_command
-            failed_clients = []
-            for client in clients:
-                try:
-                    call_command('reset_client_balances', client_id=client.id)
-                except Exception as e:
-                    logger.error(f"Failed to reset balance for client {client.name}: {e}")
-                    failed_clients.append(f"{client.name}: {str(e)}")
-            if failed_clients:
-                self.message_user(request, f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: {'; '.join(failed_clients)}", level='error')
-            else:
-                self.message_user(request, f"–ë–∞–ª–∞–Ω—Å—ã –¥–ª—è {len(clients)} –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã")
-            return HttpResponseRedirect(request.get_full_path())
-        return render(request, 'admin/confirm_reset_balances.html', {
-            'clients': queryset,
-            'action': 'reset_balances',
-            'action_name': '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã'
-        })
-    reset_balances.short_description = "–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤"
-    
-    def reset_client_balance(self, request, queryset):
-        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
-        from django.contrib import messages
-        
-        try:
-            for client in queryset:
-                client.balance = 0
-                client.save()
-            
-            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
-        except Exception as e:
-            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
-    
-    reset_client_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤'
-    
-    # ========================================================================
-    # –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–û–ú –ö–õ–ò–ï–ù–¢–ê
-    # ========================================================================
-    
-    def get_urls(self):
-        from django.urls import path
-        urls = super().get_urls()
-        custom_urls = [
-            path('<int:client_id>/topup/', self.admin_site.admin_view(self.topup_balance_view), name='client_topup'),
-            path('<int:client_id>/reset-balance/', self.admin_site.admin_view(self.reset_balance_view), name='client_reset_balance'),
-            path('<int:client_id>/recalc-balance/', self.admin_site.admin_view(self.recalc_balance_view), name='client_recalc_balance'),
-            path('<int:client_id>/cars-in-warehouse/', self.admin_site.admin_view(self.cars_in_warehouse_view), name='client_cars_in_warehouse'),
-        ]
-        return custom_urls + urls
-    
-    def topup_balance_view(self, request, client_id):
-        """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞"""
-        from django.shortcuts import render, redirect
-        from django.contrib import messages
-        from decimal import Decimal
-        from core.services.billing_service import BillingService
-        
-        client = Client.objects.get(pk=client_id)
-        
-        if request.method == 'POST':
-            try:
-                amount = Decimal(request.POST.get('amount', 0))
-                method = request.POST.get('method', 'CASH')
-                description = request.POST.get('description', '')
-                
-                if amount <= 0:
-                    raise ValueError("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π")
-                
-                trx = BillingService.topup_balance(
-                    entity=client,
-                    amount=amount,
-                    method=method,
-                    description=description or f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}",
-                    created_by=request.user
-                )
-                
-                messages.success(
-                    request, 
-                    f'‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {trx.number}, —Å—É–º–º–∞: {amount}‚Ç¨'
-                )
-                
-                return redirect('admin:core_client_change', client_id)
-                
-            except Exception as e:
-                messages.error(request, f'‚ùå –û—à–∏–±–∫–∞: {e}')
-        
-        context = {
-            'client': client,
-            'opts': self.model._meta,
-            'title': f'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ - {client.name}',
-        }
-        
-        return render(request, 'admin/client_topup.html', context)
-    
-    def reset_balance_view(self, request, client_id):
-        """–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞"""
-        from django.shortcuts import redirect
-        from django.contrib import messages
-        from decimal import Decimal
-        
-        client = Client.objects.get(pk=client_id)
-        old_balance = client.balance
-        
-        client.balance = Decimal('0.00')
-        client.save(update_fields=['balance'])
-        
-        messages.success(request, f'‚úÖ –ë–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} –æ–±–Ω—É–ª—ë–Ω (–±—ã–ª: {old_balance}‚Ç¨)')
-        return redirect('admin:core_client_change', client_id)
-    
-    def recalc_balance_view(self, request, client_id):
-        """–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
-        from django.shortcuts import redirect
-        from django.contrib import messages
-        from django.db.models import Sum
-        from decimal import Decimal
-        from core.models_billing import Transaction
-        
-        client = Client.objects.get(pk=client_id)
-        old_balance = client.balance
-        
-        # –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (TOPUP)
-        topups = Transaction.objects.filter(
-            to_client=client,
-            type='TOPUP',
-            status='COMPLETED'
-        ).aggregate(Sum('amount'))['amount__sum'] or Decimal('0.00')
-        
-        # –ü–ª–∞—Ç–µ–∂–∏ (PAYMENT)
-        payments = Transaction.objects.filter(
-            from_client=client,
-            type='PAYMENT',
-            status='COMPLETED'
-        ).aggregate(Sum('amount'))['amount__sum'] or Decimal('0.00')
-        
-        # –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
-        new_balance = topups - payments
-        
-        client.balance = new_balance
-        client.save(update_fields=['balance'])
-        
-        messages.success(
-            request, 
-            f'‚úÖ –ë–∞–ª–∞–Ω—Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω: {old_balance}‚Ç¨ ‚Üí {new_balance}‚Ç¨ (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: {topups}‚Ç¨, –ø–ª–∞—Ç–µ–∂–∏: {payments}‚Ç¨)'
-        )
-        return redirect('admin:core_client_change', client_id)
-    
-    def cars_in_warehouse_view(self, request, client_id):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–∑–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ"""
-        from django.shortcuts import render
-        from django.http import JsonResponse
-        
-        client = Client.objects.get(pk=client_id)
-        
-        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º UNLOADED (–Ω–∞ —Å–∫–ª–∞–¥–µ)
-        cars = Car.objects.filter(
-            client=client,
-            status='UNLOADED'
-        ).select_related('warehouse', 'container').order_by('warehouse__name', '-unload_date')
-        
-        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–∫–ª–∞–¥–∞–º
-        warehouses_data = {}
-        for car in cars:
-            wh_name = car.warehouse.name if car.warehouse else '–ë–µ–∑ —Å–∫–ª–∞–¥–∞'
-            if wh_name not in warehouses_data:
-                warehouses_data[wh_name] = []
-            warehouses_data[wh_name].append(car)
-        
-        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
-        text_for_copy = f"–ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ - {client.name}\n"
-        text_for_copy += f"–î–∞—Ç–∞: {timezone.now().strftime('%d.%m.%Y')}\n"
-        text_for_copy += "=" * 40 + "\n\n"
-        
-        for wh_name, wh_cars in warehouses_data.items():
-            text_for_copy += f"üìç {wh_name} ({len(wh_cars)} –∞–≤—Ç–æ)\n"
-            text_for_copy += "-" * 30 + "\n"
-            for car in wh_cars:
-                text_for_copy += f"‚Ä¢ {car.vin} - {car.brand} {car.year}"
-                if car.unload_date:
-                    text_for_copy += f" (—Ä–∞–∑–≥—Ä. {car.unload_date.strftime('%d.%m.%Y')})"
-                text_for_copy += "\n"
-            text_for_copy += "\n"
-        
-        text_for_copy += f"–ò—Ç–æ–≥–æ: {cars.count()} –∞–≤—Ç–æ"
-        
-        context = {
-            'client': client,
-            'cars': cars,
-            'warehouses_data': warehouses_data,
-            'text_for_copy': text_for_copy,
-            'total_count': cars.count(),
-            'opts': self.model._meta,
-            'title': f'–ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ - {client.name}',
-        }
-        
-        return render(request, 'admin/client_cars_in_warehouse.html', context)
-
-@admin.register(Company)
-class CompanyAdmin(admin.ModelAdmin):
-    change_form_template = 'admin/company_change.html'
-    list_display = ('name', 'balance_display', 'is_main_company', 'created_at', 'updated_at')
-    search_fields = ('name',)
-    readonly_fields = ('created_at', 'updated_at', 'balance')
-    actions = ['reset_company_balance']
-    inlines = [CompanyServiceInline]
-    
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'fields': ('name',)
-        }),
-        ('–ë–∞–ª–∞–Ω—Å', {
-            'fields': ('balance',),
-            'description': '–ë–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏'
-        }),
-        ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'classes': ('collapse',),
-            'fields': ('created_at', 'updated_at')
-        }),
-    )
-
-    def balance_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏"""
-        try:
-            balance = obj.balance or 0
-            color = '#28a745' if balance >= 0 else '#dc3545'
-            sign = '+' if balance >= 0 else ''
-            return format_html(
-                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
-                color, sign, balance
-            )
-        except:
-            return '-'
-    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
-    
-    def is_main_company(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π"""
-        return obj.name == "Caromoto Lithuania"
-    is_main_company.boolean = True
-    is_main_company.short_description = "–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è"
-    
-    def invoices_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã"""
-        try:
-            # –ò–Ω–≤–æ–π—Å—ã, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π
-            outgoing_invoices = Invoice.objects.filter(
-                from_entity_type='COMPANY',
-                from_entity_id=obj.id
-            ).order_by('-issue_date')[:10]
-            
-            # –ò–Ω–≤–æ–π—Å—ã, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π
-            incoming_invoices = Invoice.objects.filter(
-                to_entity_type='COMPANY',
-                to_entity_id=obj.id
-            ).order_by('-issue_date')[:10]
-            
-            html = ['<div style="margin-top:15px;">']
-            
-            # –ò—Å—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã
-            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ò–Ω–≤–æ–π—Å—ã, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h4>')
-            if outgoing_invoices.exists():
-                html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
-                html.append('<tr style="background-color:#f8f9fa;">')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ù–æ–º–µ—Ä</th>')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ö–æ–º—É</th>')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—Ç–∞—Ç—É—Å</th>')
-                html.append('</tr>')
-                
-                for invoice in outgoing_invoices:
-                    status_color = '#28a745' if invoice.paid else '#dc3545'
-                    status_text = '–û–ø–ª–∞—á–µ–Ω' if invoice.paid else '–ù–µ –æ–ø–ª–∞—á–µ–Ω'
-                    html.append('<tr>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;"><a href="/admin/core/invoice/{invoice.id}/change/">{invoice.number}</a></td>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.to_entity_name}</td>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.total_amount:.2f}</td>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{status_color};">{status_text}</td>')
-                    html.append('</tr>')
-                
-                html.append('</table>')
-            else:
-                html.append('<p style="color:#6c757d;">–ù–µ—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>')
-            
-            # –í—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã
-            html.append('<h4 style="margin-top:20px; margin-bottom:10px; color:#495057;">–ò–Ω–≤–æ–π—Å—ã, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h4>')
-            if incoming_invoices.exists():
-                html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
-                html.append('<tr style="background-color:#f8f9fa;">')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ù–æ–º–µ—Ä</th>')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç –∫–æ–≥–æ</th>')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
-                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—Ç–∞—Ç—É—Å</th>')
-                html.append('</tr>')
-                
-                for invoice in incoming_invoices:
-                    status_color = '#28a745' if invoice.paid else '#dc3545'
-                    status_text = '–û–ø–ª–∞—á–µ–Ω' if invoice.paid else '–ù–µ –æ–ø–ª–∞—á–µ–Ω'
-                    html.append('<tr>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;"><a href="/admin/core/invoice/{invoice.id}/change/">{invoice.number}</a></td>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.from_entity_name}</td>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.total_amount:.2f}</td>')
-                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{status_color};">{status_text}</td>')
-                    html.append('</tr>')
-                
-                html.append('</table>')
-            else:
-                html.append('<p style="color:#6c757d;">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>')
-            
-            html.append('</div>')
-            return format_html(''.join(html))
-        except Exception as e:
-            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–æ–π—Å–æ–≤: {e}</p>')
-    invoices_display.short_description = '–°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã'
-    
-    def payments_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏"""
-        try:
-            # –ü–ª–∞—Ç–µ–∂–∏, –≥–¥–µ –∫–æ–º–ø–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
-            payments = Payment.objects.filter(
-                models.Q(from_company=obj) | models.Q(to_company=obj)
-            ).order_by('-date')[:20]
-            
-            if not payments.exists():
-                return format_html('<p style="color:#6c757d;">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>')
-            
-            html = ['<div style="margin-top:15px;">']
-            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>')
-            html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
-            html.append('<tr style="background-color:#f8f9fa;">')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–î–∞—Ç–∞</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–¢–∏–ø</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç –∫–æ–≥–æ</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ö–æ–º—É</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>')
-            html.append('</tr>')
-            
-            for payment in payments:
-                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
-                if payment.from_company == obj:
-                    # –ö–æ–º–ø–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ–Ω—å–≥–∏
-                    amount_color = '#dc3545'  # –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö
-                    amount_sign = '-'
-                    amount_display = f"{amount_sign}{payment.amount:.2f}"
-                else:
-                    # –ö–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∞–µ—Ç –¥–µ–Ω—å–≥–∏
-                    amount_color = '#28a745'  # –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö
-                    amount_sign = '+'
-                    amount_display = f"{amount_sign}{payment.amount:.2f}"
-                
-                html.append('<tr>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.date}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.get_payment_type_display()}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;">{amount_display}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.sender or "-"}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.recipient or "-"}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.description or "-"}</td>')
-                html.append('</tr>')
-            
-            html.append('</table>')
-            html.append('</div>')
-            return format_html(''.join(html))
-        except Exception as e:
-            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>')
-    payments_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏'
-    
-    def balance_summary_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É –∫–æ–º–ø–∞–Ω–∏–∏"""
-        try:
-            cash_balance = obj.cash_balance or 0
-            card_balance = obj.card_balance or 0
-            invoice_balance = obj.invoice_balance or 0
-            total_balance = cash_balance + card_balance + invoice_balance
-            
-            html = f"""
-            <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;">
-                <h3 style="margin-top:0; color:#495057;">–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É –∫–æ–º–ø–∞–Ω–∏–∏</h3>
-                
-                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px;">
-                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
-                        <strong>–ù–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong><br>
-                        <span style="font-size:18px; color:{'#28a745' if cash_balance >= 0 else '#dc3545'};">{cash_balance:.2f}</span>
-                    </div>
-                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
-                        <strong>–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong><br>
-                        <span style="font-size:18px; color:{'#28a745' if card_balance >= 0 else '#dc3545'};">{card_balance:.2f}</span>
-                    </div>
-                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
-                        <strong>–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å:</strong><br>
-                        <span style="font-size:18px; color:{'#28a745' if invoice_balance >= 0 else '#dc3545'};">{invoice_balance:.2f}</span>
-                    </div>
-                </div>
-                
-                <div style="background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};">
-                    <strong style="color:{'#28a745' if total_balance >= 0 else '#dc3545'};">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</strong><br>
-                    <span style="font-size:24px; font-weight:bold; color:{'#28a745' if total_balance >= 0 else '#dc3545'};">{total_balance:.2f}</span>
-                </div>
-                
-                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è Caromoto Lithuania) -->
-                {f'''
-                <div style="margin-top:20px; text-align:center;">
-                    <a href="/company-dashboard/" style="display:inline-block; padding:12px 24px; background:#667eea; color:white; text-decoration:none; border-radius:8px; font-weight:600; font-size:16px;">
-                        üè¢ –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ –∫–æ–º–ø–∞–Ω–∏–∏
-                    </a>
-                </div>
-                ''' if obj.name == "Caromoto Lithuania" else ""}
-            </div>
-            """
-            
-            return format_html(html)
-        except Exception as e:
-            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {e}</p>')
-    balance_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É'
-
-    def balance_transactions_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –∫–æ–º–ø–∞–Ω–∏–∏"""
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏
-            payments = Payment.objects.filter(
-                models.Q(from_company=obj) | models.Q(to_company=obj)
-            ).order_by('-date', '-id')[:20]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–ª–∞—Ç–µ–∂–µ–π
-            
-            if not payments.exists():
-                return format_html('<p style="color:#6c757d;">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>')
-            
-            html = ['<div style="margin-top:15px;">']
-            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>')
-            html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
-            html.append('<tr style="background-color:#f8f9fa;">')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–î–∞—Ç–∞</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–¢–∏–ø</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>')
-            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>')
-            html.append('</tr>')
-            
-            for payment in payments:
-                amount_color = '#28a745' if payment.to_company == obj else '#dc3545'
-                html.append('<tr>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.date.strftime("%d.%m.%Y")}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.get_payment_type_display()}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;">{payment.amount:.2f}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.sender or "-"}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.recipient or "-"}</td>')
-                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.description or "-"}</td>')
-                html.append('</tr>')
-            
-            html.append('</table>')
-            html.append('</div>')
-            
-            return format_html(''.join(html))
-        except Exception as e:
-            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>')
-    balance_transactions_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏'
-    
-    def reset_company_balance(self, request, queryset):
-        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π"""
-        from django.contrib import messages
-        
-        try:
-            for company in queryset:
-                company.balance = 0
-                company.save()
-            
-            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –∫–æ–º–ø–∞–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
-        except Exception as e:
-            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
-    
-    reset_company_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π'
-
-
-# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∫–µ Django
-admin.site.register(Container, ContainerAdmin)
-# LineServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏"
-
-
-@admin.register(Line)
-class LineAdmin(admin.ModelAdmin):
-    change_form_template = 'admin/line_change.html'
-    form = LineForm
-    list_display = ('name', 'balance_display')
-    search_fields = ('name',)
-    readonly_fields = ('balance',)
-    actions = ['reset_line_balance']
-    exclude = ('ocean_freight_rate', 'documentation_fee', 'handling_fee', 'ths_fee', 'additional_fees')
-    inlines = [LineTHSCoefficientInline, LineServiceInline]
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
-            'fields': ('name',)
-        }),
-        ('–ë–∞–ª–∞–Ω—Å', {
-            'fields': ('balance',),
-            'description': '–ë–∞–ª–∞–Ω—Å –ª–∏–Ω–∏–∏'
-        }),
-    )
-
-    def balance_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ª–∏–Ω–∏–∏"""
-        try:
-            balance = obj.balance or 0
-            color = '#28a745' if balance >= 0 else '#dc3545'
-            sign = '+' if balance >= 0 else ''
-            return format_html(
-                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
-                color, sign, balance
-            )
-        except Exception as e:
-            return '-'
-    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
-    
-    def reset_line_balance(self, request, queryset):
-        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π"""
-        from django.contrib import messages
-        
-        try:
-            for line in queryset:
-                line.balance = 0
-                line.save()
-            
-            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –ª–∏–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
-        except Exception as e:
-            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
-    
-    reset_line_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π'
-
-    def get_urls(self):
-        from django.urls import path
-        urls = super().get_urls()
-        custom_urls = [
-            path('<int:object_id>/recalculate_ths/',
-                 self.admin_site.admin_view(self.recalculate_ths_view),
-                 name='core_line_recalculate_ths'),
-        ]
-        return custom_urls + urls
-    
-    def recalculate_ths_view(self, request, object_id):
-        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º UNLOADED –∏ IN_PORT"""
-        from django.contrib import messages
-        from django.shortcuts import redirect
-        from django.db import transaction
-        from core.models import Container, Car, Line
-        from core.signals import create_ths_services_for_container
-        import logging
-        logger = logging.getLogger(__name__)
-        
-        print(f"=== RECALCULATE THS VIEW CALLED === object_id={object_id}")
-        logger.warning(f"=== RECALCULATE THS VIEW CALLED === object_id={object_id}")
-
-        # –ü–æ–ª—É—á–∞–µ–º –ª–∏–Ω–∏—é –Ω–∞–ø—Ä—è–º—É—é –ø–æ ID
-        try:
-            line = Line.objects.get(pk=object_id)
-        except Line.DoesNotExist:
-            messages.error(request, '–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
-            return redirect('admin:core_line_changelist')
-        print(f"Line: {line}")
-
-        logger.info(f"[RECALC THS] Starting for line {line.name}")
-
-        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Å –º–∞—à–∏–Ω–∞–º–∏ –≤ –Ω—É–∂–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞—Ö
-        containers = Container.objects.filter(
-            line=line,
-            container_cars__status__in=['UNLOADED', 'IN_PORT']
-        ).distinct()
-
-        updated_containers = 0
-        updated_cars = 0
-
-        try:
-            with transaction.atomic():
-                for container in containers:
-                    if container.ths:
-                        logger.info(f"[RECALC THS] Container {container.number}, THS={container.ths}")
-                        
-                        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS —É—Å–ª—É–≥–∏
-                        created = create_ths_services_for_container(container)
-                        logger.info(f"[RECALC THS] Created {created} THS services")
-                        updated_containers += 1
-
-                        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –º–∞—à–∏–Ω
-                        for car in container.container_cars.filter(status__in=['UNLOADED', 'IN_PORT']):
-                            old_price = car.total_price
-                            # –û—á–∏—â–∞–µ–º –∫—ç—à –∏ –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
-                            car.refresh_from_db()
-                            if hasattr(car, '_prefetched_objects_cache'):
-                                car._prefetched_objects_cache.clear()
-                            
-                            car.calculate_total_price()
-                            car.save(update_fields=['total_price', 'storage_cost', 'days'])
-                            logger.info(f"[RECALC THS] Car {car.vin}: {old_price} -> {car.total_price}")
-                            updated_cars += 1
-
-            messages.success(
-                request,
-                f'–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: {updated_containers} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, {updated_cars} –º–∞—à–∏–Ω'
-            )
-        except Exception as e:
-            logger.error(f"[RECALC THS] Error: {e}", exc_info=True)
-            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ: {e}')
-
-        from django.urls import reverse
-        return redirect(reverse('admin:core_line_change', args=[object_id]))
-
-    def change_view(self, request, object_id, form_url='', extra_context=None):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥"""
-        extra_context = extra_context or {}
-        
-        if object_id:
-            obj = self.get_object(request, object_id)
-            
-            if request.method == 'POST':
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
-                for key, value in request.POST.items():
-                    if key.startswith('service_name_'):
-                        service_id = key.replace('service_name_', '')
-                        try:
-                            service = LineService.objects.get(id=service_id, line=obj)
-                            service.name = value
-                            service.save()
-                        except LineService.DoesNotExist:
-                            pass
-                    elif key.startswith('service_price_'):
-                        service_id = key.replace('service_price_', '')
-                        try:
-                            service = LineService.objects.get(id=service_id, line=obj)
-                            service.default_price = float(value) if value else 0
-                            service.save()
-                        except (LineService.DoesNotExist, ValueError):
-                            pass
-                    elif key.startswith('delete_service_'):
-                        service_id = key.replace('delete_service_', '')
-                        try:
-                            service = LineService.objects.get(id=service_id, line=obj)
-                            service.delete()
-                        except LineService.DoesNotExist:
-                            pass
-                
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏
-                for key, value in request.POST.items():
-                    if key.startswith('new_service_name_'):
-                        index = key.replace('new_service_name_', '')
-                        name = value
-                        price = request.POST.get(f'new_service_price_{index}', 0)
-                        
-                        if name:
-                            try:
-                                LineService.objects.create(
-                                    line=obj,
-                                    name=name,
-                                    default_price=float(price) if price else 0
-                                )
-                            except ValueError:
-                                pass
-        
-        return super().change_view(request, object_id, form_url, extra_context)
-
-
-
-
-# CarServiceAdmin —É–¥–∞–ª–µ–Ω
-
-    def get_form(self, request, obj=None, **kwargs):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π"""
-        form = super().get_form(request, obj, **kwargs)
-        
-        if obj and obj.pk:
-            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤ fieldsets
-            dynamic_fields = []
-            for service in obj.services.all():
-                field_name = f'service_{service.id}'
-                dynamic_fields.append(field_name)
-            
-            if dynamic_fields:
-                # –û–±–Ω–æ–≤–ª—è–µ–º fieldsets –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
-                self.fieldsets = list(self.fieldsets)
-                for i, (title, options) in enumerate(self.fieldsets):
-                    if title == '–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã':
-                        fields = list(options['fields'])
-                        fields.append(tuple(dynamic_fields))
-                        self.fieldsets[i] = (title, {**options, 'fields': tuple(fields)})
-                        break
-        
-        return form
-
-
-# CarrierServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏"
-
-
-@admin.register(Carrier)
-class CarrierAdmin(admin.ModelAdmin):
-    change_form_template = 'admin/carrier_change.html'
-    form = CarrierForm
-    list_display = ('name', 'contact_person', 'phone', 'balance_display')
-    search_fields = ('name', 'contact_person', 'phone', 'email')
-    list_filter = ('created_at',)
-    readonly_fields = ('created_at', 'updated_at', 'balance')
-    exclude = ('transport_rate', 'loading_fee', 'unloading_fee', 'fuel_surcharge', 'additional_fees')
-    inlines = [CarrierServiceInline]
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'fields': ('name', 'short_name', 'contact_person', 'phone', 'email')
-        }),
-        ('–ë–∞–ª–∞–Ω—Å', {
-            'fields': ('balance',)
-        }),
-        ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'fields': ('created_at', 'updated_at'),
-            'classes': ('collapse',)
-        }),
-    )
-    
-    def balance_display(self, obj):
-        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
-        try:
-            balance = obj.balance or 0
-            color = '#28a745' if balance >= 0 else '#dc3545'
-            sign = '+' if balance >= 0 else ''
-            return format_html(
-                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
-                color, sign, balance
-            )
-        except:
-            return '-'
-    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
-
-    def change_view(self, request, object_id, form_url='', extra_context=None):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥"""
-        extra_context = extra_context or {}
-        
-        if object_id:
-            obj = self.get_object(request, object_id)
-            
-            if request.method == 'POST':
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
-                for key, value in request.POST.items():
-                    if key.startswith('service_name_'):
-                        service_id = key.replace('service_name_', '')
-                        try:
-                            service = CarrierService.objects.get(id=service_id, carrier=obj)
-                            service.name = value
-                            service.save()
-                        except CarrierService.DoesNotExist:
-                            pass
-                    elif key.startswith('service_price_'):
-                        service_id = key.replace('service_price_', '')
-                        try:
-                            service = CarrierService.objects.get(id=service_id, carrier=obj)
-                            service.default_price = float(value) if value else 0
-                            service.save()
-                        except (CarrierService.DoesNotExist, ValueError):
-                            pass
-                    elif key.startswith('delete_service_'):
-                        service_id = key.replace('delete_service_', '')
-                        try:
-                            service = CarrierService.objects.get(id=service_id, carrier=obj)
-                            service.delete()
-                        except CarrierService.DoesNotExist:
-                            pass
-                
-                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏
-                for key, value in request.POST.items():
-                    if key.startswith('new_service_name_'):
-                        index = key.replace('new_service_name_', '')
-                        name = value
-                        price = request.POST.get(f'new_service_price_{index}', 0)
-                        
-                        if name:
-                            try:
-                                CarrierService.objects.create(
-                                    carrier=obj,
-                                    name=name,
-                                    default_price=float(price) if price else 0
-                                )
-                            except ValueError:
-                                pass
-        
-        return super().change_view(request, object_id, form_url, extra_context)
-
-
-
-# Company —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ @admin.register –≤—ã—à–µ
-
-
-# ==============================================================================
-# üéâ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í –ò –ü–õ–ê–¢–ï–ñ–ï–ô
-# ==============================================================================
-# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
-# –ú–æ–¥–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ @admin.register() –≤ admin_billing.py
-
-try:
-    from .admin_billing import NewInvoiceAdmin, TransactionAdmin
-    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
-except ImportError as e:
-    import logging
-    logger = logging.getLogger('django')
-    logger.warning(f"‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã: {e}")
-    logger.warning("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã admin_billing.py –∏ models_billing.py —Å—É—â–µ—Å—Ç–≤—É—é—Ç")
-
+from django.contrib import admin
+
+# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
+from .admin_website import (
+    ClientUserAdmin, AIChatAdmin, NewsPostAdmin, ContactMessageAdmin, TrackingRequestAdmin
+)
+from .models_website import ContainerPhoto
+from django.utils import timezone
+from django.urls import reverse
+from django.utils.html import format_html
+from django.utils.safestring import mark_safe
+from django.http import HttpResponseRedirect
+from django.shortcuts import render
+from django.core.exceptions import ValidationError
+from django.db import models
+from django import forms
+from decimal import Decimal
+from .models import Client, Warehouse, Car, Container, Line, Company, Carrier, LineService, CarrierService, WarehouseService, CompanyService, CarService, DeletedCarService
+from .forms import LineForm, CarrierForm, WarehouseForm
+from .admin_filters import MultiStatusFilter, MultiWarehouseFilter, ClientAutocompleteFilter
+
+
+# Inline —Ñ–æ—Ä–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
+
+class WarehouseServiceInline(admin.TabularInline):
+    model = WarehouseService
+    extra = 1
+    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
+    verbose_name = "–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞"
+    verbose_name_plural = "–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞"
+    
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
+        return formset
+
+
+class LineServiceInline(admin.TabularInline):
+    model = LineService
+    extra = 1
+    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
+    verbose_name = "–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏"
+    verbose_name_plural = "–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏"
+
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
+        return formset
+
+
+class LineTHSCoefficientInline(admin.TabularInline):
+    """Inline –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–°
+    
+    –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç "–≤–µ—Å" —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS:
+    - 1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–ª–µ–≥–∫–æ–≤–æ–π)
+    - 2.0 = –¥–≤–æ–π–Ω–æ–π (–¥–∂–∏–ø, RV)
+    - 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞ (–º–æ—Ç–æ—Ü–∏–∫–ª)
+    """
+    from .models import LineTHSCoefficient
+    model = LineTHSCoefficient
+    extra = 0
+    fields = ('vehicle_type', 'coefficient')
+    verbose_name = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°"
+    verbose_name_plural = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°"
+    
+    def get_extra(self, request, obj=None, **kwargs):
+        """–ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ 11 —Ç–∏–ø–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è"""
+        if obj and obj.ths_coefficients.exists():
+            return 0
+        return 11  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –¢–°
+
+
+class CarrierServiceInline(admin.TabularInline):
+    model = CarrierService
+    extra = 1
+    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
+    verbose_name = "–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+    verbose_name_plural = "–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
+        return formset
+
+
+class CarrierTruckInline(admin.TabularInline):
+    """–ò–Ω–ª–∞–π–Ω –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+    from .models import CarrierTruck
+    model = CarrierTruck
+    extra = 1
+    fields = ('truck_number', 'trailer_number', 'is_active', 'notes')
+    verbose_name = "–ê–≤—Ç–æ–≤–æ–∑"
+    verbose_name_plural = "–ê–≤—Ç–æ–≤–æ–∑—ã –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+
+
+class CarrierDriverInline(admin.TabularInline):
+    """–ò–Ω–ª–∞–π–Ω –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+    from .models import CarrierDriver
+    model = CarrierDriver
+    extra = 1
+    fields = ('first_name', 'last_name', 'phone', 'is_active', 'notes')
+    verbose_name = "–í–æ–¥–∏—Ç–µ–ª—å"
+    verbose_name_plural = "–í–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+
+
+class CompanyServiceInline(admin.TabularInline):
+    model = CompanyService
+    extra = 1
+    fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default')
+    verbose_name = "–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏"
+    verbose_name_plural = "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏"
+    
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        formset.form.base_fields['description'].widget.attrs.update({'rows': 1})
+        return formset
+
+
+# –§–æ—Ä–º–∞ –¥–ª—è CarServiceInline
+class CarServiceInlineForm(forms.ModelForm):
+    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
+    warehouse_service = forms.ModelChoiceField(
+        queryset=WarehouseService.objects.select_related('warehouse').filter(is_active=True),
+        required=False,
+        label="–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞",
+        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É —Å–∫–ª–∞–¥–∞"
+    )
+    line_service = forms.ModelChoiceField(
+        queryset=LineService.objects.select_related('line').filter(is_active=True),
+        required=False,
+        label="–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏",
+        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏"
+    )
+    carrier_service = forms.ModelChoiceField(
+        queryset=CarrierService.objects.select_related('carrier').filter(is_active=True),
+        required=False,
+        label="–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞",
+        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+    )
+    company_service = forms.ModelChoiceField(
+        queryset=CompanyService.objects.select_related('company').filter(is_active=True),
+        required=False,
+        label="–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏",
+        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∫–æ–º–ø–∞–Ω–∏–∏"
+    )
+    
+    class Meta:
+        model = CarService
+        fields = '__all__'
+    
+    def __init__(self, *args, **kwargs):
+        super().__init__(*args, **kwargs)
+        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
+        if self.instance and self.instance.pk:
+            if self.instance.service_type == 'WAREHOUSE':
+                try:
+                    self.fields['warehouse_service'].initial = self.instance.service_id
+                except:
+                    pass
+            elif self.instance.service_type == 'LINE':
+                try:
+                    self.fields['line_service'].initial = self.instance.service_id
+                except:
+                    pass
+            elif self.instance.service_type == 'CARRIER':
+                try:
+                    self.fields['carrier_service'].initial = self.instance.service_id
+                except:
+                    pass
+            elif self.instance.service_type == 'COMPANY':
+                try:
+                    self.fields['company_service'].initial = self.instance.service_id
+                except:
+                    pass
+    
+    def save(self, commit=True):
+        instance = super().save(commit=False)
+        
+        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
+        if instance.service_type == 'WAREHOUSE' and self.cleaned_data.get('warehouse_service'):
+            instance.service_id = self.cleaned_data['warehouse_service'].id
+        elif instance.service_type == 'LINE' and self.cleaned_data.get('line_service'):
+            instance.service_id = self.cleaned_data['line_service'].id
+        elif instance.service_type == 'CARRIER' and self.cleaned_data.get('carrier_service'):
+            instance.service_id = self.cleaned_data['carrier_service'].id
+        elif instance.service_type == 'COMPANY' and self.cleaned_data.get('company_service'):
+            instance.service_id = self.cleaned_data['company_service'].id
+        
+        if commit:
+            instance.save()
+        return instance
+
+
+# Inline –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Å–ª—É–≥–∞–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
+class CarServiceInline(admin.TabularInline):
+    model = CarService
+    form = CarServiceInlineForm
+    extra = 1
+    can_delete = True
+    fields = ('service_type', 'warehouse_service', 'line_service', 'carrier_service', 'service_display', 'warehouse_display', 'custom_price', 'markup_amount', 'quantity', 'final_price_display', 'invoice_price_display', 'notes')
+    readonly_fields = ('service_display', 'warehouse_display', 'final_price_display', 'invoice_price_display')
+    verbose_name = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —É—Å–ª—É–≥–∞"
+    verbose_name_plural = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (–æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤/–∫–æ–º–ø–∞–Ω–∏–π)"
+    
+    def service_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"""
+        if obj and obj.pk:
+            return obj.get_service_name()
+        return "-"
+    service_display.short_description = "–£—Å–ª—É–≥–∞"
+    
+    def warehouse_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–∫–ª–∞–¥/–∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥–∏"""
+        if not obj or not obj.pk:
+            return "-"
+        
+        if obj.service_type == 'WAREHOUSE':
+            try:
+                service = WarehouseService.objects.select_related('warehouse').get(id=obj.service_id)
+                return service.warehouse.name
+            except WarehouseService.DoesNotExist:
+                return "–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"
+        elif obj.service_type == 'LINE':
+            try:
+                service = LineService.objects.select_related('line').get(id=obj.service_id)
+                return service.line.name
+            except LineService.DoesNotExist:
+                return "–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
+        elif obj.service_type == 'CARRIER':
+            try:
+                service = CarrierService.objects.select_related('carrier').get(id=obj.service_id)
+                return service.carrier.name
+            except CarrierService.DoesNotExist:
+                return "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"
+        return "-"
+    warehouse_display.short_description = "–ö–æ–º–ø–∞–Ω–∏—è/–°–∫–ª–∞–¥"
+    
+    def final_price_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É (–±–µ–∑ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)"""
+        if obj and obj.pk:
+            return f"{obj.final_price:.2f}"
+        return "0.00"
+    final_price_display.short_description = "–ò—Ç–æ–≥–æ"
+    
+    def invoice_price_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ü–µ–Ω—É –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ (—Å —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)"""
+        if obj and obj.pk:
+            return f"{obj.invoice_price:.2f}"
+        return "0.00"
+    invoice_price_display.short_description = "–í –∏–Ω–≤–æ–π—Å–µ"
+    
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏—è
+        formset.form.base_fields['service_type'].help_text = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞'
+        formset.form.base_fields['custom_price'].help_text = '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'
+        formset.form.base_fields['quantity'].help_text = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥'
+        return formset
+
+
+import json
+import logging
+from django.db.models import Q
+from django.contrib.admin import SimpleListFilter
+
+logger = logging.getLogger('django')
+
+CONTAINER_STATUS_COLORS = {
+    '–í –ø—É—Ç–∏': '#2772a8',  # –¢–µ–º–Ω–µ–µ —Å–∏–Ω–µ–≥–æ
+    '–í –ø–æ—Ä—Ç—É': '#8B0000',  # –¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
+    '–†–∞–∑–≥—Ä—É–∂–µ–Ω': '#239f58',  # –¢–µ–º–Ω–µ–µ –∑–µ–ª—ë–Ω–æ–≥–æ
+    '–ü–µ—Ä–µ–¥–∞–Ω': '#78458c',  # –¢–µ–º–Ω–µ–µ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ
+}
+
+class CarInline(admin.TabularInline):
+    model = Car
+    extra = 1
+    can_delete = True
+    show_change_link = True  # –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
+    fields = ('year', 'brand', 'vehicle_type', 'vin', 'client', 'total_price', 'has_title')  # –¥–æ–±–∞–≤–∏–ª–∏ vehicle_type
+    readonly_fields = ('total_price',)
+
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        for field in formset.form.base_fields.values():
+            field.help_text = ''
+        return formset
+
+
+class ContainerPhotoInline(admin.TabularInline):
+    """
+    Inline –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
+    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å Google Drive.
+    """
+    model = ContainerPhoto
+    extra = 0  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è - —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
+    can_delete = True
+    max_num = 100  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
+    fields = ('thumbnail_preview', 'photo', 'photo_type', 'is_public')
+    readonly_fields = ('thumbnail_preview',)
+    verbose_name = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è"
+    verbose_name_plural = "üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
+    
+    def thumbnail_preview(self, obj):
+        """–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"""
+        if obj.thumbnail:
+            return format_html(
+                '<a href="{}" target="_blank"><img src="{}" style="max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;" /></a>',
+                obj.photo.url if obj.photo else '#',
+                obj.thumbnail.url
+            )
+        elif obj.photo:
+            return format_html(
+                '<a href="{}" target="_blank"><img src="{}" style="max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;" /></a>',
+                obj.photo.url,
+                obj.photo.url
+            )
+        return '-'
+    thumbnail_preview.short_description = '–ü—Ä–µ–≤—å—é'
+    
+    def get_queryset(self, request):
+        """–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è"""
+        return super().get_queryset(request).only('id', 'container', 'photo', 'thumbnail', 'photo_type', 'is_public')
+
+
+# CarServiceInline —É–¥–∞–ª–µ–Ω
+
+class ContainerAdmin(admin.ModelAdmin):
+    change_form_template = 'admin/core/container/change_form.html'
+    list_display = ('number', 'colored_status', 'eta', 'planned_unload_date', 'unload_date', 'line', 'warehouse', 'photos_count_display')
+    list_display_links = ('number',)  # –î–µ–ª–∞–µ–º –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
+    list_filter = (MultiStatusFilter, ClientAutocompleteFilter, MultiWarehouseFilter)
+    search_fields = ('number',)
+    ordering = ['-unload_date', '-id']  # –°–Ω–∞—á–∞–ª–∞ –ø–æ –¥–∞—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É), –ø–æ—Ç–æ–º –ø–æ ID
+    inlines = [CarInline, ContainerPhotoInline]  # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–¥ —Å–ø–∏—Å–∫–æ–º –º–∞—à–∏–Ω
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
+            'classes': ('collapse',),
+            'fields': (
+                ('number', 'status', 'line', 'warehouse'),
+                ('ths', 'ths_payer'),
+                ('eta', 'planned_unload_date', 'unload_date'),
+                'google_drive_folder_url',
+            )
+        }),
+    )
+    readonly_fields = ('days', 'storage_cost')
+    actions = ['set_status_floating', 'set_status_in_port', 'set_status_unloaded', 'set_status_transferred', 'check_container_status', 'bulk_update_container_statuses', 'sync_photos_from_gdrive', 'resend_planned_notifications', 'resend_unload_notifications']
+
+    class Media:
+        css = {'all': ('css/logist2_custom_admin.css',)}
+        js = ('js/htmx.min.js',)
+
+    def get_queryset(self, request):
+        qs = super().get_queryset(request)
+        return qs.select_related('line', 'client', 'warehouse').prefetch_related('container_cars')
+
+    def save_model(self, request, obj, form, change):
+        import time
+        start_time = time.time()
+        logger.info(f"[TIMING] Container save_model started for {obj.number}")
+        
+        # –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∏ —É –Ω–µ–≥–æ –µ—â–µ –Ω–µ—Ç pk, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
+        if not change and not obj.pk:
+            super().save_model(request, obj, form, change)
+        elif change:
+            # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
+            super().save_model(request, obj, form, change)
+        
+        logger.info(f"[TIMING] Container saved in {time.time() - start_time:.2f}s")
+
+        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Å–∫–ª–∞–¥ ‚Äî —Ä–∞–∑–Ω–µ—Å—ë–º –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥ –≤–æ –≤—Å–µ –∞–≤—Ç–æ
+        if change and form and 'warehouse' in getattr(form, 'changed_data', []):
+            try:
+                logger.info(f"Warehouse changed for container {obj.id}, syncing cars...")
+                obj.sync_cars_after_warehouse_change()
+                logger.info(f"Successfully synced warehouse for {obj.container_cars.count()} cars")
+            except Exception as e:
+                logger.error(f"Failed to sync cars after warehouse change for container {obj.id}: {e}")
+
+        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Å—Ç–∞—Ç—É—Å ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+        if change and form and 'status' in getattr(form, 'changed_data', []):
+            try:
+                logger.info(f"Status changed for container {obj.id} to {obj.status}, bulk updating all cars...")
+                updated_count = obj.container_cars.update(status=obj.status)
+                logger.info(f"‚úÖ Updated status to '{obj.status}' for {updated_count} cars in container {obj.number}")
+            except Exception as e:
+                logger.error(f"Failed to update car statuses for container {obj.id}: {e}")
+
+        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+        if change and form and 'unload_date' in getattr(form, 'changed_data', []):
+            try:
+                from django.db.models.signals import post_save, post_delete
+                from core.signals import update_related_on_car_save, create_car_services_on_car_save, recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete
+                
+                logger.info(f"Unload date changed for container {obj.id} to {obj.unload_date}, bulk updating all cars...")
+                
+                # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑ –ë–î, —á—Ç–æ–±—ã –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
+                obj.refresh_from_db()
+                
+                # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
+                post_save.disconnect(update_related_on_car_save, sender=Car)
+                post_save.disconnect(create_car_services_on_car_save, sender=Car)
+                post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService)
+                post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService)
+                
+                cars_to_update = []
+                affected_invoices = set()
+                
+                for car in obj.container_cars.select_related('warehouse').all():
+                    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
+                    car.unload_date = obj.unload_date
+                    car.update_days_and_storage()
+                    car.calculate_total_price()
+                    cars_to_update.append(car)
+                    
+                    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
+                    for invoice in car.newinvoice_set.all():
+                        affected_invoices.add(invoice)
+                
+                # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
+                if cars_to_update:
+                    Car.objects.bulk_update(
+                        cars_to_update,
+                        ['unload_date', 'days', 'storage_cost', 'total_price'],
+                        batch_size=50
+                    )
+                    logger.info(f"‚úÖ Bulk updated {len(cars_to_update)} cars in container {obj.number}")
+                
+                # –í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ
+                post_save.connect(update_related_on_car_save, sender=Car)
+                post_save.connect(create_car_services_on_car_save, sender=Car)
+                post_save.connect(recalculate_car_price_on_service_save, sender=CarService)
+                post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService)
+                
+                # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–Ω–≤–æ–π—Å—ã –æ–¥–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º
+                if affected_invoices:
+                    logger.info(f"Updating {len(affected_invoices)} affected invoices...")
+                    for invoice in affected_invoices:
+                        try:
+                            if hasattr(invoice, 'regenerate_items_from_cars'):
+                                # NewInvoice
+                                invoice.regenerate_items_from_cars()
+                            else:
+                                # InvoiceOLD
+                                invoice.update_total_amount()
+                        except Exception as e:
+                            logger.error(f"Error updating invoice {invoice.id}: {e}")
+                    logger.info(f"‚úÖ Updated {len(affected_invoices)} invoices")
+                
+            except Exception as e:
+                logger.error(f"Failed to update cars after unload_date change for container {obj.id}: {e}")
+                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∏–≥–Ω–∞–ª—ã –≤–∫–ª—é—á–µ–Ω—ã –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
+                try:
+                    from django.db.models.signals import post_save, post_delete
+                    from core.signals import update_related_on_car_save, create_car_services_on_car_save, recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete
+                    post_save.connect(update_related_on_car_save, sender=Car)
+                    post_save.connect(create_car_services_on_car_save, sender=Car)
+                    post_save.connect(recalculate_car_price_on_service_save, sender=CarService)
+                    post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService)
+                except:
+                    pass
+
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å THS: –ª–∏–Ω–∏—è, —Å—É–º–º–∞ THS, –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ THS, —Å–∫–ª–∞–¥
+        # –°–∫–ª–∞–¥ –≤–∫–ª—é—á—ë–Ω –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ ths_payer='WAREHOUSE' THS –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞
+        changed_data = getattr(form, 'changed_data', []) if form else []
+        ths_related_changed = any(field in changed_data for field in ['line', 'ths', 'ths_payer', 'warehouse'])
+
+        # –î–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - —Å–æ–∑–¥–∞—ë–º THS –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã line –∏ ths
+        # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è THS –∏–ª–∏ —Å–∫–ª–∞–¥
+        should_create_ths = (not change and obj.line and obj.ths) or (change and ths_related_changed)
+
+        # –µ—Å–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å THS –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ THS –ø–æ–ª—è ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —É—Å–ª—É–≥–∏ THS
+        if should_create_ths:
+            line_start = time.time()
+            try:
+                from django.db.models.signals import post_save, post_delete
+                from core.signals import update_related_on_car_save, create_car_services_on_car_save, create_ths_services_for_container, recalculate_invoices_on_car_service_save, recalculate_invoices_on_car_service_delete
+                from core.models import recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete, LineService, WarehouseService
+                from core.models_billing import NewInvoice
+                
+                logger.info(f"[TIMING] THS-related change started for container {obj.id}, line: {obj.line}, ths: {obj.ths}, ths_payer: {obj.ths_payer}")
+                
+                # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å–∏–≥–Ω–∞–ª—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏ –∏ –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
+                post_save.disconnect(update_related_on_car_save, sender=Car)
+                post_save.disconnect(create_car_services_on_car_save, sender=Car)
+                post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService)
+                post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService)
+                post_save.disconnect(recalculate_invoices_on_car_service_save, sender=CarService)
+                post_delete.disconnect(recalculate_invoices_on_car_service_delete, sender=CarService)
+                
+                try:
+                    # 1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º –ª–∏–Ω–∏—é —É –≤—Å–µ—Ö –∞–≤—Ç–æ
+                    if 'line' in changed_data:
+                        car_ids = list(obj.container_cars.values_list('id', flat=True))
+                        updated_count = obj.container_cars.update(line=obj.line)
+                        logger.info(f"[TIMING] Line updated for {updated_count} cars")
+                    
+                    # 2. –°–æ–∑–¥–∞—ë–º —É—Å–ª—É–≥–∏ THS —Å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
+                    if obj.line and obj.ths:
+                        created_count = create_ths_services_for_container(obj)
+                        logger.info(f"[TIMING] Created {created_count} THS services with proportional distribution")
+                    else:
+                        # –ï—Å–ª–∏ –ª–∏–Ω–∏–∏ –Ω–µ—Ç –∏–ª–∏ THS = 0, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É—Å–ª—É–≥–∏ THS
+                        car_ids = list(obj.container_cars.values_list('id', flat=True))
+                        # –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥–∏ THS –æ—Ç –ª–∏–Ω–∏–π
+                        deleted_line = CarService.objects.filter(
+                            car_id__in=car_ids,
+                            service_type='LINE'
+                        ).filter(
+                            service_id__in=LineService.objects.filter(name__icontains='THS').values_list('id', flat=True)
+                        ).delete()
+                        # –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥–∏ THS –æ—Ç —Å–∫–ª–∞–¥–æ–≤
+                        deleted_wh = CarService.objects.filter(
+                            car_id__in=car_ids,
+                            service_type='WAREHOUSE'
+                        ).filter(
+                            service_id__in=WarehouseService.objects.filter(name__icontains='THS').values_list('id', flat=True)
+                        ).delete()
+                        logger.info(f"[TIMING] Deleted {deleted_line[0]} line THS services and {deleted_wh[0]} warehouse THS services")
+                    
+                    # 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∞–≤—Ç–æ (BULK)
+                    cars_to_update = []
+                    affected_invoices = set()
+                    for car in obj.container_cars.select_related('warehouse').all():
+                        car.update_days_and_storage()
+                        car.calculate_total_price()
+                        cars_to_update.append(car)
+                        # –°–æ–±–∏—Ä–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
+                        for invoice in NewInvoice.objects.filter(cars=car, status__in=['DRAFT', 'ISSUED', 'PARTIALLY_PAID', 'OVERDUE']):
+                            affected_invoices.add(invoice)
+                    
+                    if cars_to_update:
+                        Car.objects.bulk_update(
+                            cars_to_update,
+                            ['days', 'storage_cost', 'total_price'],
+                            batch_size=50
+                        )
+                        logger.info(f"[TIMING] Recalculated prices for {len(cars_to_update)} cars")
+                    
+                    # 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
+                    if affected_invoices:
+                        logger.info(f"[TIMING] Updating {len(affected_invoices)} affected invoices...")
+                        for invoice in affected_invoices:
+                            try:
+                                invoice.regenerate_items_from_cars()
+                            except Exception as e:
+                                logger.error(f"Error updating invoice {invoice.number}: {e}")
+                        logger.info(f"[TIMING] Invoices updated")
+                    
+                    logger.info(f"[TIMING] THS-related change completed in {time.time() - line_start:.2f}s")
+                    
+                finally:
+                    # –í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ
+                    post_save.connect(update_related_on_car_save, sender=Car)
+                    post_save.connect(create_car_services_on_car_save, sender=Car)
+                    post_save.connect(recalculate_car_price_on_service_save, sender=CarService)
+                    post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService)
+                    post_save.connect(recalculate_invoices_on_car_service_save, sender=CarService)
+                    post_delete.connect(recalculate_invoices_on_car_service_delete, sender=CarService)
+                    
+            except Exception as e:
+                logger.error(f"Failed to update cars after line change for container {obj.id}: {e}", exc_info=True)
+
+    def save_formset(self, request, form, formset, change):
+        import time
+        formset_start = time.time()
+        logger.info(f"[TIMING] save_formset started for {formset.model.__name__}")
+        
+        instances = formset.save(commit=False)
+        logger.info(f"[TIMING] formset.save(commit=False) took {time.time() - formset_start:.2f}s")
+        
+        parent = form.instance  # –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
+
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
+        if not parent.pk:
+            logger.error("Parent container doesn't have a primary key - saving parent first")
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –æ–±—ä–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞
+            parent.save()
+            logger.info(f"Saved parent container {parent.pk}")
+
+        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∏ –Ω–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
+        if not instances and not formset.deleted_objects:
+            logger.info(f"[TIMING] No changes in formset, skipping. Total: {time.time() - formset_start:.2f}s")
+            formset.save_m2m()
+            return
+
+        logger.info(f"[TIMING] Processing {len(instances)} changed instances")
+
+        for obj in instances:
+            if isinstance(obj, Car):
+                # –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
+                if not obj.container_id:
+                    obj.container = parent
+
+                # —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ –∫–∞–∫ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+                obj.status = parent.status
+
+                # —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç/–ª–∏–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
+                if not obj.warehouse_id and parent.warehouse_id:
+                    obj.warehouse = parent.warehouse
+                if not obj.client_id and parent.client_id:
+                    obj.client = parent.client
+                if not obj.line_id and parent.line_id:
+                    obj.line = parent.line
+                
+                # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
+                if parent.unload_date:
+                    obj.unload_date = parent.unload_date
+                    logger.debug(f"Car {obj.vin}: inherited unload_date={obj.unload_date} from container {parent.number}")
+
+                creating = obj.pk is None
+                if creating and obj.warehouse_id:
+                    # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (rate/free_days –∏ –ø—Ä.) –î–û –ø–µ—Ä–≤–æ–≥–æ save()
+                    obj.set_initial_warehouse_values()
+
+                # –ø–µ—Ä–µ—Å—á—ë—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
+                obj.update_days_and_storage()
+                
+                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç - —Å–∏–≥–Ω–∞–ª post_save –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç calculate_total_price
+                obj.save()
+                
+                logger.debug(f"Saved Car {obj.vin} (creating={creating}, has_title={obj.has_title})")
+                
+                # –î–ª—è –Ω–æ–≤—ã—Ö –º–∞—à–∏–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—ë–º —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
+                if creating and obj.warehouse_id:
+                    from core.models import WarehouseService, CarService
+                    from decimal import Decimal
+                    
+                    warehouse_services = WarehouseService.objects.filter(
+                        warehouse=obj.warehouse,
+                        is_active=True,
+                        add_by_default=True
+                    )
+                    
+                    for service in warehouse_services:
+                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —É—Å–ª—É–≥–∏
+                        if not CarService.objects.filter(car=obj, service_type='WAREHOUSE', service_id=service.id).exists():
+                            # –î–ª—è "–•—Ä–∞–Ω–µ–Ω–∏–µ" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∏ –Ω–∞—Ü–µ–Ω–∫—É √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
+                            if service.name == '–•—Ä–∞–Ω–µ–Ω–∏–µ':
+                                days = Decimal(str(obj.days or 0))
+                                custom_price = days * Decimal(str(service.default_price or 0))
+                                default_markup = days * Decimal(str(service.default_markup or 0))
+                            else:
+                                custom_price = service.default_price
+                                default_markup = service.default_markup or Decimal('0')
+                            
+                            CarService.objects.create(
+                                car=obj,
+                                service_type='WAREHOUSE',
+                                service_id=service.id,
+                                custom_price=custom_price,
+                                markup_amount=default_markup
+                            )
+                            logger.info(f"üè≠ [FORMSET] –°–æ–∑–¥–∞–Ω–∞ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞ '{service.name}' –¥–ª—è {obj.vin} (—Ü–µ–Ω–∞: {custom_price}, –Ω–∞—Ü–µ–Ω–∫–∞: {default_markup})")
+            else:
+                obj.save()
+
+        # –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
+        deleted_cars = [o for o in formset.deleted_objects if isinstance(o, Car)]
+        logger.info(f"[FORMSET] deleted_objects count: {len(formset.deleted_objects)}, deleted_cars: {len(deleted_cars)}")
+        
+        for o in formset.deleted_objects:
+            try:
+                # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService
+                if isinstance(o, Car):
+                    o.car_services.all().delete()
+                o.delete()
+                logger.info(f"[FORMSET] Deleted object: {o}")
+            except Exception as e:
+                logger.error(f"Error deleting object {o}: {e}")
+
+        formset.save_m2m()
+
+        # –ü–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¢–° (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ) - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS
+        # –£—Å–ª–æ–≤–∏–µ: –µ—Å—Ç—å line, –µ—Å—Ç—å ths, –∏ (–µ—Å—Ç—å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã)
+        cars_changed = bool(instances) or bool(deleted_cars)
+        logger.info(f"[FORMSET] instances count: {len(instances)}, cars_changed: {cars_changed}")
+        logger.info(f"[FORMSET] parent.line: {parent.line}, parent.ths: {parent.ths}")
+        
+        # –í–°–ï–ì–î–ê –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS –µ—Å–ª–∏ –µ—Å—Ç—å line –∏ ths (–¥–∞–∂–µ –±–µ–∑ —è–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
+        if parent.line and parent.ths:
+            try:
+                from core.signals import create_ths_services_for_container
+                from django.db import transaction
+                
+                # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ –ë–î
+                parent.refresh_from_db()
+                
+                logger.info(f"[FORMSET] Starting THS recalculation for container {parent.number}")
+                
+                # –ò—Å–ø–æ–ª—å–∑—É–µ–º savepoint –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
+                with transaction.atomic():
+                    # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS –¥–ª—è –í–°–ï–• –º–∞—à–∏–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+                    cars_in_container = list(parent.container_cars.all())
+                    logger.info(f"[FORMSET] Found {len(cars_in_container)} cars in container")
+                    
+                    if cars_in_container:
+                        created = create_ths_services_for_container(parent)
+                        logger.info(f"[FORMSET] Created/updated {created} THS services for container {parent.number}")
+                        
+                        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –í–°–ï–• –º–∞—à–∏–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è THS
+                        for car in cars_in_container:
+                            car.refresh_from_db()  # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–∑ –ë–î
+                            car.calculate_total_price()
+                            car.save(update_fields=['total_price', 'storage_cost', 'days'])
+                            logger.info(f"[FORMSET] Recalculated price for car {car.vin}: {car.total_price}")
+                        logger.info(f"[FORMSET] Recalculated prices for all {len(cars_in_container)} cars")
+                    else:
+                        logger.info(f"[FORMSET] No cars left in container {parent.number}")
+            except Exception as e:
+                logger.error(f"Failed to create THS services in formset for container {parent.id}: {e}", exc_info=True)
+
+
+    def get_form(self, request, obj=None, **kwargs):
+        form = super().get_form(request, obj, **kwargs)
+        for field in form.base_fields.values():
+            field.help_text = ''
+        return form
+
+    def colored_status(self, obj):
+        color = obj.get_status_color()
+        return format_html(
+            '<span style="background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;">{}</span>',
+            color,
+            obj.get_status_display()
+        )
+    colored_status.short_description = '–°—Ç–∞—Ç—É—Å'
+    
+    def photos_count_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"""
+        count = obj.photos.count()
+        if count > 0:
+            return format_html(
+                '<span style="background-color: #4285f4; color: white; padding: 2px 8px; border-radius: 10px;">üì∑ {}</span>',
+                count
+            )
+        return '-'
+    photos_count_display.short_description = '–§–æ—Ç–æ'
+
+    def set_status_floating(self, request, queryset):
+        updated = queryset.update(status='FLOATING')
+        for obj in queryset:
+            obj.update_days_and_storage()
+            obj.sync_cars()
+            obj.save(update_fields=['days', 'storage_cost'])
+            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+            obj.container_cars.update(status='FLOATING')
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø—É—Ç–∏' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
+    set_status_floating.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø—É—Ç–∏"
+
+    def set_status_in_port(self, request, queryset):
+        updated = queryset.update(status='IN_PORT')
+        for obj in queryset:
+            obj.update_days_and_storage()
+            obj.sync_cars()
+            obj.save(update_fields=['days', 'storage_cost'])
+            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+            obj.container_cars.update(status='IN_PORT')
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
+    set_status_in_port.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É"
+
+    def set_status_unloaded(self, request, queryset):
+        updated = 0
+        for obj in queryset:
+            if obj.warehouse and obj.unload_date:
+                obj.status = 'UNLOADED'
+                obj.update_days_and_storage()
+                obj.sync_cars()
+                obj.save(update_fields=['status', 'days', 'storage_cost'])
+                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+                obj.container_cars.update(status='UNLOADED')
+                updated += 1
+            else:
+                self.message_user(request, f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {obj.number} –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'.", level='warning')
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
+    set_status_unloaded.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –†–∞–∑–≥—Ä—É–∂–µ–Ω"
+
+    def set_status_transferred(self, request, queryset):
+        updated = queryset.update(status='TRANSFERRED')
+        for obj in queryset:
+            obj.update_days_and_storage()
+            obj.sync_cars()
+            obj.save(update_fields=['days', 'storage_cost'])
+            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
+            obj.container_cars.update(status='TRANSFERRED')
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.")
+    set_status_transferred.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω"
+
+    def check_container_status(self, request, queryset):
+        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
+        updated_count = 0
+        for obj in queryset:
+            try:
+                old_status = obj.status
+                obj.check_and_update_status_from_cars()
+                if obj.status != old_status:
+                    updated_count += 1
+            except Exception as e:
+                logger.error(f"Failed to check status for container {obj.number}: {e}")
+        
+        if updated_count > 0:
+            self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è {updated_count} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.")
+        else:
+            self.message_user(request, "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.")
+    check_container_status.short_description = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
+
+    def bulk_update_container_statuses(self, request, queryset):
+        """–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
+        updated_count = 0
+        skipped_count = 0
+        error_count = 0
+        
+        for container in queryset:
+            try:
+                cars = container.container_cars.all()
+                if not cars.exists():
+                    skipped_count += 1
+                    continue
+                
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
+                all_transferred = all(car.status == 'TRANSFERRED' for car in cars)
+                transferred_cars_count = sum(1 for car in cars if car.status == 'TRANSFERRED')
+                total_cars_count = cars.count()
+                
+                if all_transferred and container.status != 'TRANSFERRED':
+                    old_status = container.status
+                    container.status = 'TRANSFERRED'
+                    container.save(update_fields=['status'])
+                    logger.info(f"Container {container.number} status updated from {old_status} to TRANSFERRED")
+                    updated_count += 1
+                else:
+                    skipped_count += 1
+                    
+            except Exception as e:
+                logger.error(f"Failed to update container {container.number}: {e}")
+                error_count += 1
+        
+        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
+        messages = []
+        if updated_count > 0:
+            messages.append(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: {updated_count}")
+        if skipped_count > 0:
+            messages.append(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: {skipped_count}")
+        if error_count > 0:
+            messages.append(f"–û—à–∏–±–æ–∫: {error_count}")
+        
+        if messages:
+            self.message_user(request, "; ".join(messages))
+        else:
+            self.message_user(request, "–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.")
+    bulk_update_container_statuses.short_description = "–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
+    
+    def sync_photos_from_gdrive(self, request, queryset):
+        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å Google Drive –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"""
+        from .google_drive_sync import GoogleDriveSync
+        
+        total_photos = 0
+        success_count = 0
+        error_count = 0
+        
+        for container in queryset:
+            try:
+                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–∞–ø–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –æ–±–µ–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö
+                container_number = container.number
+                photos_added = 0
+                
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–µ –ø–∞–ø–∫–∏ (–≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
+                for folder_type, folder_id in [
+                    ('unloaded', '1711SSTZ3_YgUcZfNrgNzhscbmlHXlsKb'),
+                    ('in_container', '11poTWYYG3uKTuGTYDWS2m8uA52mlzP6f')
+                ]:
+                    # –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏ –º–µ—Å—è—Ü–µ–≤
+                    month_folders = GoogleDriveSync.get_public_folder_files(folder_id)
+                    
+                    for month_folder in month_folders:
+                        if not month_folder.get('is_folder'):
+                            continue
+                        
+                        # –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
+                        container_folders = GoogleDriveSync.get_public_folder_files(month_folder['id'])
+                        
+                        for container_folder in container_folders:
+                            if container_folder['name'] == container_number:
+                                # –ù–∞—à–ª–∏ –ø–∞–ø–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!
+                                photo_type = 'UNLOADING' if folder_type == 'unloaded' else 'GENERAL'
+                                count = GoogleDriveSync.sync_container_folder(
+                                    container_number,
+                                    container_folder['id'],
+                                    photo_type
+                                )
+                                photos_added += count
+                
+                if photos_added > 0:
+                    success_count += 1
+                    total_photos += photos_added
+                    logger.info(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container_number}: –¥–æ–±–∞–≤–ª–µ–Ω–æ {photos_added} —Ñ–æ—Ç–æ")
+                else:
+                    logger.warning(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container_number}: –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ Google Drive")
+                    
+            except Exception as e:
+                error_count += 1
+                logger.error(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ {container.number}: {e}")
+        
+        # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
+        if total_photos > 0:
+            self.message_user(
+                request,
+                f"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ {total_photos} —Ñ–æ—Ç–æ –¥–ª—è {success_count} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {error_count}",
+                level='SUCCESS'
+            )
+        else:
+            self.message_user(
+                request,
+                f"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ Google Drive. –û—à–∏–±–æ–∫: {error_count}",
+                level='WARNING'
+            )
+    
+    sync_photos_from_gdrive.short_description = "üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive"
+
+    def resend_planned_notifications(self, request, queryset):
+        """–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –¥–∞—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏"""
+        from core.services.email_service import ContainerNotificationService
+        
+        total_sent = 0
+        total_failed = 0
+        containers_processed = 0
+        
+        for container in queryset:
+            if not container.planned_unload_date:
+                self.message_user(
+                    request,
+                    f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏",
+                    level='WARNING'
+                )
+                continue
+            
+            sent, failed = ContainerNotificationService.send_planned_to_all_clients(container, user=request.user)
+            total_sent += sent
+            total_failed += failed
+            if sent > 0:
+                containers_processed += 1
+        
+        if total_sent > 0:
+            self.message_user(
+                request,
+                f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}",
+                level='SUCCESS'
+            )
+        elif total_failed > 0:
+            self.message_user(
+                request,
+                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.",
+                level='ERROR'
+            )
+        else:
+            self.message_user(
+                request,
+                "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)",
+                level='WARNING'
+            )
+    
+    resend_planned_notifications.short_description = "üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ"
+
+    def resend_unload_notifications(self, request, queryset):
+        """–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"""
+        from core.services.email_service import ContainerNotificationService
+        
+        total_sent = 0
+        total_failed = 0
+        containers_processed = 0
+        
+        for container in queryset:
+            if not container.unload_date:
+                self.message_user(
+                    request,
+                    f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏",
+                    level='WARNING'
+                )
+                continue
+            
+            sent, failed = ContainerNotificationService.send_unload_to_all_clients(container, user=request.user)
+            total_sent += sent
+            total_failed += failed
+            if sent > 0:
+                containers_processed += 1
+        
+        if total_sent > 0:
+            self.message_user(
+                request,
+                f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}",
+                level='SUCCESS'
+            )
+        elif total_failed > 0:
+            self.message_user(
+                request,
+                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.",
+                level='ERROR'
+            )
+        else:
+            self.message_user(
+                request,
+                "–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)",
+                level='WARNING'
+            )
+    
+    resend_unload_notifications.short_description = "üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ"
+
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —à–∞–±–ª–æ–Ω"""
+        extra_context = extra_context or {}
+        
+        if object_id:
+            obj = self.get_object(request, object_id)
+            if obj:
+                # –¢–æ–ª—å–∫–æ —Å—á–∏—Ç–∞–µ–º —Ñ–æ—Ç–æ - –±—ã—Å—Ç—Ä—ã–π COUNT –∑–∞–ø—Ä–æ—Å
+                # –°–∞–º–∏ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX –ø—Ä–∏ –∫–ª–∏–∫–µ
+                extra_context['photos_count'] = obj.photos.count()
+                extra_context['container_id'] = object_id
+        
+        return super().change_view(request, object_id, form_url, extra_context)
+
+    def get_changelist(self, request, **kwargs):
+        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ '–í –ø–æ—Ä—Ç—É' –∏ '–†–∞–∑–≥—Ä—É–∂–µ–Ω'"""
+        # –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+        if not request.GET.get('status_multi'):
+            # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
+            get_params = request.GET.copy()
+            get_params.setlist('status_multi', ['IN_PORT', 'UNLOADED'])
+            request.GET = get_params
+        return super().get_changelist(request, **kwargs)
+
+@admin.register(Car)
+class CarAdmin(admin.ModelAdmin):
+    change_form_template = 'admin/core/car/change_form.html'
+    change_list_template = 'admin/core/car/change_list.html'  # –ö–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—É–º–º—ã –Ω–∞—Ü–µ–Ω–æ–∫
+    list_display = (
+        'vin', 'brand', 'vehicle_type', 'year_display', 'client', 'colored_status', 'container_display', 'warehouse', 'line',
+        'unload_date_display', 'days_display', 'storage_cost_display', 'total_price_display', 'markup_display', 'has_title'
+    )
+    list_editable = ('has_title',)
+    list_filter = (MultiStatusFilter, ClientAutocompleteFilter, MultiWarehouseFilter)
+    search_fields = ('vin', 'brand')
+    # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è list view
+    list_select_related = ('client', 'warehouse', 'line', 'carrier', 'container')
+    list_prefetch_related = ('car_services',)
+    
+    def get_queryset(self, request):
+        """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π queryset —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π –æ–±—â–µ–π –Ω–∞—Ü–µ–Ω–∫–∏.
+        
+        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç annotate + Sum –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –æ–±—â–µ–π –Ω–∞—Ü–µ–Ω–∫–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º,
+        —á—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç N+1 –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¢–°.
+        """
+        from django.db.models import Sum, F
+        from decimal import Decimal
+        
+        queryset = super().get_queryset(request)
+        
+        # –ê–Ω–Ω–æ—Ç–∏—Ä—É–µ–º –æ–±—â—É—é –Ω–∞—Ü–µ–Ω–∫—É –∏–∑ CarService
+        queryset = queryset.annotate(
+            _total_markup=Sum('car_services__markup_amount')
+        )
+        
+        return queryset
+    readonly_fields = (
+        'default_warehouse_prices_display', 'total_price', 'storage_cost', 'days', 'warehouse_payment_display',
+        'free_days_display', 'rate_display', 'services_summary_display', 'warehouse_services_display', 'line_services_display', 'carrier_services_display', 'company_services_display'
+    )
+    # inlines = []  # –£—Å–ª—É–≥–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª—ã –Ω–∏–∂–µ
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
+            'fields': (
+                ('year', 'brand', 'vehicle_type', 'vin', 'client', 'status'),
+                ('unload_date', 'transfer_date'),
+                ('has_title', 'title_notes'),
+            )
+        }),
+        ('–õ–∏–Ω–∏–∏', {
+            'classes': ('collapse',),
+            'fields': (
+                'line',
+                'line_services_display',
+            )
+        }),
+        ('–°–∫–ª–∞–¥', {
+            'classes': ('collapse',),
+            'fields': (
+                'warehouse',
+                'warehouse_services_display',
+            )
+        }),
+        ('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', {
+            'classes': ('collapse',),
+            'fields': (
+                'carrier',
+                'carrier_services_display',
+            )
+        }),
+        ('–£—Å–ª—É–≥–∏', {
+            'classes': ('collapse',),
+            'fields': (
+                'company_services_display',
+            )
+        }),
+        ('–§–∏–Ω–∞–Ω—Å—ã', {
+            'fields': (
+                'services_summary_display',
+            )
+        }),
+    )
+    actions = ['set_status_floating', 'set_status_in_port', 'set_status_unloaded', 'set_status_transferred', 'set_transferred_today', 'set_title_with_us']
+
+    def set_transferred_today(self, request, queryset):
+        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å '–ü–µ—Ä–µ–¥–∞–Ω' –∏ –¥–∞—Ç—É –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"""
+        from django.utils import timezone
+        
+        today = timezone.now().date()
+        updated = 0
+        
+        for car in queryset:
+            car.status = 'TRANSFERRED'
+            car.transfer_date = today
+            car.save()
+            updated += 1
+        
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏: {today}")
+    set_transferred_today.short_description = "–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è"
+
+    def default_warehouse_prices_display(self, obj):
+        details = obj.warehouse_details()
+        if "message" in details:
+            return details["message"]
+        html = '<table style="width:100%; border:1px solid #ddd; border-collapse:collapse;">'
+        html += '<tr><th style="border:1px solid #ddd; padding:8px;">–ü–æ–ª–µ</th><th style="border:1px solid #ddd; padding:8px;">–¶–µ–Ω–∞</th></tr>'
+        for key, value in details.items():
+            html += f'<tr><td style="border:1px solid #ddd; padding:8px;">{key}</td><td style="border:1px solid #ddd; padding:8px;">{value}</td></tr>'
+        html += '</table>'
+        return format_html(html)
+    default_warehouse_prices_display.short_description = "–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞"
+
+    # --- NEW: renderer –¥–ª—è –ø–æ–ª—è "–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É" ---
+    def warehouse_payment_display(self, obj):
+        return f"{obj.warehouse_payment_amount():.2f}"
+
+    warehouse_payment_display.short_description = '–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É'
+
+
+    def services_summary_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –≤—Å–µ–º —É—Å–ª—É–≥–∞–º —Å –Ω–∞—Ü–µ–Ω–∫–æ–π Caromoto Lithuania"""
+        from decimal import Decimal
+        from core.models import CarService
+        from django.db.models import Sum
+        
+        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
+        obj.update_days_and_storage()
+        
+        # –†–∞–∑–¥–µ–ª—è–µ–º —É—Å–ª—É–≥–∏: –ª–∏–Ω–∏–∏ (–≤—Å–µ + THS –∏–∑ —Å–∫–ª–∞–¥–∞), —Å–∫–ª–∞–¥ (–±–µ–∑ THS), –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫, –∫–æ–º–ø–∞–Ω–∏–∏
+        line_total = Decimal('0.00')  # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS (–¥–∞–∂–µ –µ—Å–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥)
+        warehouse_total = Decimal('0.00')  # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ THS)
+        carrier_total = obj.get_services_total_by_provider('CARRIER')
+        company_total = obj.get_services_total_by_provider('COMPANY')
+        
+        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ –∏ —Ä–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
+        # THS –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π –ª–∏–Ω–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥
+        for service in obj.car_services.all():
+            service_name = service.get_service_name().upper()
+            price = Decimal(str(service.final_price))
+            
+            if service.service_type == 'LINE' or 'THS' in service_name:
+                line_total += price  # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS –∏–∑ —Å–∫–ª–∞–¥–∞
+            elif service.service_type == 'WAREHOUSE':
+                warehouse_total += price  # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –±–µ–∑ THS
+        
+        # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
+        paid_days = obj.days or 0
+        
+        # –°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫ (–∏–∑ —É—Å–ª—É–≥)
+        distributed_markup = obj.car_services.aggregate(total=Sum('markup_amount'))['total'] or Decimal('0')
+        
+        # –ù–∞—Ü–µ–Ω–∫–∞ –∏–∑ –ø–æ–ª—è proft (–µ—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)
+        proft_amount = obj.proft or Decimal('0.00')
+        
+        # –û–±—â–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ = —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è (proft –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
+        total_markup = distributed_markup
+        
+        # –ë–∞–∑–æ–≤—ã–µ —Å—É–º–º—ã (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏)
+        base_total = line_total + warehouse_total + carrier_total + company_total
+        
+        html = ['<div style="margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;">']
+        html.append('<h3 style="margin-top:0; color:#495057;">–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º</h3>')
+        
+        html.append('<div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr; gap:15px; margin-bottom:20px;">')
+        
+        # –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π (THS, –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ì—Ä—É–∑–∏—é –∏ —Ç.–¥.) - —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
+        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
+        html.append('<strong>–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π:</strong><br>')
+        
+        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è THS –∏–∑ —Å–∫–ª–∞–¥–∞)
+        line_services_list = []
+        for service in obj.car_services.all():
+            service_name = service.get_service_name()
+            # THS —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π –ª–∏–Ω–∏–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥
+            if service.service_type == 'LINE' or 'THS' in service_name.upper():
+                price = Decimal(str(service.final_price))
+                line_services_list.append((service_name, price))
+        
+        for name, price in line_services_list:
+            html.append(f'<span style="font-size:13px; color:#6c757d;">{name}: {price:.2f}</span><br>')
+        
+        html.append(f'<span style="font-size:18px; color:#007bff; font-weight:bold;">–ò—Ç–æ–≥–æ: {line_total:.2f}</span>')
+        html.append('</div>')
+        
+        # –°–∫–ª–∞–¥ (–±–µ–∑ THS) - —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π —É—Å–ª—É–≥
+        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
+        html.append('<strong>–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞:</strong><br>')
+        
+        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É —Å–∫–ª–∞–¥–∞ (–∫—Ä–æ–º–µ THS)
+        warehouse_services_list = []
+        for service in obj.car_services.filter(service_type='WAREHOUSE'):
+            service_name = service.get_service_name()
+            if 'THS' not in service_name.upper():
+                # –ò—Å–ø–æ–ª—å–∑—É–µ–º final_price –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç default_price –µ—Å–ª–∏ custom_price –Ω–µ –∑–∞–¥–∞–Ω
+                price = Decimal(str(service.final_price))
+                warehouse_services_list.append((service_name, price))
+        
+        for name, price in warehouse_services_list:
+            html.append(f'<span style="font-size:13px; color:#6c757d;">{name}: {price:.2f}</span><br>')
+        
+        if obj.warehouse:
+            free_days = obj.warehouse.free_days or 0
+            html.append(f'<span style="font-size:12px; color:#adb5bd;">–ë–µ—Å–ø–ª. –¥–Ω–µ–π: {free_days}, –ü–ª–∞—Ç. –¥–Ω–µ–π: {paid_days}</span><br>')
+        
+        html.append(f'<span style="font-size:18px; color:#28a745; font-weight:bold;">–ò—Ç–æ–≥–æ: {warehouse_total:.2f}</span>')
+        html.append('</div>')
+        
+        # –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫
+        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
+        html.append('<strong>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫:</strong><br>')
+        html.append(f'<span style="font-size:18px; color:#ffc107;">{carrier_total:.2f}</span>')
+        html.append('</div>')
+        
+        # –ö–æ–º–ø–∞–Ω–∏–∏
+        html.append('<div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">')
+        html.append('<strong>–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π:</strong><br>')
+        
+        company_services_list = []
+        for service in obj.car_services.filter(service_type='COMPANY'):
+            try:
+                company_service = CompanyService.objects.select_related('company').get(id=service.service_id)
+                price = Decimal(str(service.final_price))
+                company_services_list.append((company_service.company.name, company_service.name, price))
+            except Exception:
+                continue
+        
+        for company_name, name, price in company_services_list:
+            html.append(f'<span style="font-size:13px; color:#6c757d;">{company_name}: {name}: {price:.2f}</span><br>')
+        
+        html.append(f'<span style="font-size:18px; color:#6f42c1; font-weight:bold;">–ò—Ç–æ–≥–æ: {company_total:.2f}</span>')
+        html.append('</div>')
+        
+        # –ù–∞—Ü–µ–Ω–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é —Å—É–º–º—É
+        html.append('<div style="background:#fffde7; padding:10px; border-radius:5px; border:1px solid #ffc107;">')
+        html.append('<strong style="color:#ff8f00;">–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞:</strong><br>')
+        html.append(f'<span style="font-size:18px; font-weight:bold; color:#ff8f00;">{distributed_markup:.2f}</span>')
+        if distributed_markup > 0:
+            html.append(f'<br><span style="font-size:11px; color:#666;">(—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ —É—Å–ª—É–≥–∞–º)</span>')
+        else:
+            html.append(f'<br><span style="font-size:11px; color:#666;">(–≤–≤–µ–¥–∏—Ç–µ –≤ –∂—ë–ª—Ç—ã—Ö –ø–æ–ª—è—Ö)</span>')
+        html.append('</div>')
+        
+        html.append('</div>')
+        
+        # –û–±—â–∏–π –∏—Ç–æ–≥
+        total_with_markup = base_total + total_markup
+        html.append('<div style="background:white; padding:15px; border-radius:5px; border:2px solid #6c757d;">')
+        html.append('<strong style="color:#6c757d;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong><br>')
+        html.append(f'<span style="font-size:20px; font-weight:bold; color:#495057;">{total_with_markup:.2f} EUR</span>')
+        html.append('</div>')
+        
+        html.append('</div>')
+        
+        return format_html(''.join(html))
+    services_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º'
+
+    def colored_status(self, obj):
+        color = obj.get_status_color()
+        return format_html(
+            '<span style="background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;">{}</span>',
+            color,
+            obj.get_status_display()
+        )
+    colored_status.short_description = '–°—Ç–∞—Ç—É—Å'
+
+    def container_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å—É –º–∞—à–∏–Ω—ã"""
+        if not obj.container:
+            return '-'
+        
+        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—à–∏–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ (–∫–∞–∫ —É —Å—Ç–∞—Ç—É—Å–∞)
+        color = obj.get_status_color()
+        
+        # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
+        container_url = f'/admin/core/container/{obj.container.id}/change/'
+        
+        return format_html(
+            '<a href="{}" target="_blank" style="text-decoration: none;"><span style="background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;">{}</span></a>',
+            container_url,
+            color,
+            obj.container.number
+        )
+    container_display.short_description = '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä'
+    container_display.admin_order_field = 'container__number'
+
+    def year_display(self, obj):
+        return obj.year
+    year_display.short_description = '–ì–æ–¥'
+    year_display.admin_order_field = 'year'
+
+    def unload_date_display(self, obj):
+        return obj.unload_date
+    unload_date_display.short_description = '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'
+    unload_date_display.admin_order_field = 'unload_date'
+
+    def transfer_date_display(self, obj):
+        return obj.transfer_date
+    transfer_date_display.short_description = '–ü–µ—Ä–µ–¥–∞–Ω'
+    transfer_date_display.admin_order_field = 'transfer_date'
+
+    def storage_cost_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π —Å–∫–ª–∞–¥–∞"""
+        try:
+            storage_cost = obj.calculate_storage_cost()
+            return f"{storage_cost:.2f}"
+        except Exception as e:
+            print(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
+            return f"{obj.storage_cost:.2f}"  # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
+    storage_cost_display.short_description = '–•—Ä–∞–Ω'
+    storage_cost_display.admin_order_field = 'storage_cost'
+
+    def days_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Å —É—á–µ—Ç–æ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –∏–∑ —Å–∫–ª–∞–¥–∞"""
+        if obj.warehouse and obj.unload_date:
+            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
+            end_date = obj.transfer_date if obj.status == 'TRANSFERRED' and obj.transfer_date else timezone.now().date()
+            total_days = (end_date - obj.unload_date).days + 1
+            
+            free_days = obj.warehouse.free_days or 0
+            chargeable_days = max(0, total_days - free_days)
+            return f"{chargeable_days} (–∏–∑ {total_days})"
+        return obj.days if hasattr(obj, 'days') else 0
+    days_display.short_description = '–ü–ª–∞—Ç.–¥–Ω.'
+    days_display.admin_order_field = 'days'
+
+    def total_price_display(self, obj):
+        # –î–ª—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
+        if obj.status != 'TRANSFERRED':
+            from decimal import Decimal
+            from django.db.models import Sum
+            from core.models import CarService
+            
+            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏
+            obj.update_days_and_storage()
+            
+            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É —É—Å–ª—É–≥ (final_price = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞)
+            base_total = Decimal('0.00')
+            for cs in CarService.objects.filter(car=obj):
+                base_total += Decimal(str(cs.final_price))
+            
+            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –Ω–∞—Ü–µ–Ω–∫—É –∏–∑ CarService
+            distributed_markup = CarService.objects.filter(car=obj).aggregate(
+                total=Sum('markup_amount')
+            )['total'] or Decimal('0.00')
+            
+            total = base_total + distributed_markup
+            return f"{total:.2f}"
+        
+        return f"{obj.total_price:.2f}"
+    total_price_display.short_description = '–¶–µ–Ω–∞'
+    total_price_display.admin_order_field = 'total_price'
+
+    def markup_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±—â—É—é —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É –¥–ª—è –¢–°.
+        
+        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –∏–∑ get_queryset –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
+        –ï—Å–ª–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–∞—Ä—Ç–æ—á–∫–∞ –¢–°), –¥–µ–ª–∞–µ—Ç –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å.
+        """
+        # –ï—Å–ª–∏ –µ—Å—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –∏–∑ get_queryset - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë (–¥–ª—è —Å–ø–∏—Å–∫–∞)
+        if hasattr(obj, '_total_markup'):
+            return f"{obj._total_markup:.2f}" if obj._total_markup else "0.00"
+        
+        # Fallback –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –¢–° –∏–ª–∏ –µ—Å–ª–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
+        from decimal import Decimal
+        from django.db.models import Sum
+        
+        total_markup = obj.car_services.aggregate(
+            total=Sum('markup_amount')
+        )['total'] or Decimal('0.00')
+        
+        return f"{total_markup:.2f}"
+    
+    markup_display.short_description = '–ù'  # –ù = –ù–∞—Ü–µ–Ω–∫–∞
+    markup_display.admin_order_field = '_total_markup'  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
+    
+    def changelist_view(self, request, extra_context=None):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º changelist_view –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã –Ω–∞—Ü–µ–Ω–æ–∫.
+        
+        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–æ–∫ –¥–ª—è –û–¢–û–ë–†–ê–ñ–ê–ï–ú–´–• –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¢–°
+        –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞.
+        """
+        from django.db.models import Sum
+        from decimal import Decimal
+        
+        # –í—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è response
+        response = super().changelist_view(request, extra_context)
+        
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º changelist –∏–∑ response
+            cl = response.context_data['cl']
+            
+            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π queryset (—Ç–µ –¢–°, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è)
+            queryset = cl.get_queryset(request)
+            
+            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¢–°
+            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Sum –±–µ–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
+            total_markup_sum = queryset.aggregate(
+                total=Sum('car_services__markup_amount')
+            )['total'] or Decimal('0.00')
+            
+            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
+            response.context_data['total_markup_sum'] = total_markup_sum
+            
+        except (AttributeError, KeyError):
+            # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É
+            pass
+        
+        return response
+
+    # –£–î–ê–õ–ï–ù–û: current_price_display - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ total_price
+
+    def free_days_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ —Å–∫–ª–∞–¥–∞"""
+        if obj.warehouse:
+            return obj.warehouse.free_days
+        return obj.free_days  # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
+    free_days_display.short_description = 'FREE'
+    free_days_display.admin_order_field = 'free_days'
+    
+    def rate_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∑–∞ —Å—É—Ç–∫–∏ –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞"""
+        if obj.warehouse:
+            daily_rate = obj._get_storage_daily_rate()
+            return f"{daily_rate:.2f}"
+        return "0.00"
+    rate_display.short_description = '–°—Ç–∞–≤–∫–∞/–¥–µ–Ω—å'
+
+    def set_status_floating(self, request, queryset):
+        updated = queryset.update(status='FLOATING')
+        for obj in queryset:
+            obj.update_days_and_storage()
+            obj.save(update_fields=['days', 'storage_cost', 'total_price'])
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø—É—Ç–∏' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
+    set_status_floating.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø—É—Ç–∏"
+
+    def set_status_in_port(self, request, queryset):
+        updated = queryset.update(status='IN_PORT')
+        for obj in queryset:
+            obj.update_days_and_storage()
+            obj.save(update_fields=['days', 'storage_cost', 'total_price'])
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
+    set_status_in_port.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É"
+
+    def set_status_unloaded(self, request, queryset):
+        updated = 0
+        for obj in queryset:
+            if obj.warehouse and obj.unload_date:
+                obj.status = 'UNLOADED'
+                obj.update_days_and_storage()
+                obj.save(update_fields=['status', 'days', 'storage_cost', 'total_price'])
+                updated += 1
+            else:
+                self.message_user(request, f"–ê–≤—Ç–æ–º–æ–±–∏–ª—å {obj.vin} –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'.", level='warning')
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
+    set_status_unloaded.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –†–∞–∑–≥—Ä—É–∂–µ–Ω"
+
+    def set_status_transferred(self, request, queryset):
+        updated = queryset.update(status='TRANSFERRED')
+        for obj in queryset:
+            if obj.status == 'TRANSFERRED' and not obj.transfer_date:
+                obj.transfer_date = timezone.now().date()
+            obj.update_days_and_storage()
+            obj.save(update_fields=['transfer_date', 'days', 'storage_cost', 'total_price'])
+        self.message_user(request, f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
+    set_status_transferred.short_description = "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω"
+
+    def set_title_with_us(self, request, queryset):
+        logger.info(f"Setting has_title=True for {queryset.count()} cars")
+        updated = queryset.update(has_title=True)
+        for obj in queryset:
+            logger.debug(f"Updating car {obj.vin} with has_title=True")
+            obj.save()
+        self.message_user(request, f"–¢–∞–π—Ç–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ '–£ –Ω–∞—Å' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.")
+    set_title_with_us.short_description = "–¢–∞–π—Ç–ª —É –Ω–∞—Å"
+
+    class Media:
+        css = {
+            'all': (
+                'css/logist2_custom_admin.css',
+                'style',  # –î–æ–±–∞–≤–ª—è–µ–º inline —Å—Ç–∏–ª–∏
+            )
+        }
+        js = ('js/htmx.min.js', 'js/logist2_htmx.js')
+
+    def get_queryset(self, request):
+        qs = super().get_queryset(request)
+        return qs.select_related('client', 'warehouse', 'container')
+
+    def save_model(self, request, obj, form, change):
+        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ–ª–µ–π —É—Å–ª—É–≥"""
+        super().save_model(request, obj, form, change)
+        
+        # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
+        removed_services = set()
+        for key, value in request.POST.items():
+            if key.startswith('remove_warehouse_service_') and value == '1':
+                service_id = key.replace('remove_warehouse_service_', '')
+                removed_services.add(f'warehouse_{service_id}')
+                try:
+                    deleted_count = CarService.objects.filter(
+                        car=obj,
+                        service_type='WAREHOUSE',
+                        service_id=service_id
+                    ).delete()
+                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                    DeletedCarService.objects.get_or_create(
+                        car=obj,
+                        service_type='WAREHOUSE',
+                        service_id=service_id
+                    )
+                    print(f"Deleted warehouse service {service_id}: {deleted_count}")
+                except Exception as e:
+                    print(f"Error deleting warehouse service {service_id}: {e}")
+            elif key.startswith('remove_line_service_') and value == '1':
+                service_id = key.replace('remove_line_service_', '')
+                removed_services.add(f'line_{service_id}')
+                try:
+                    deleted_count = CarService.objects.filter(
+                        car=obj,
+                        service_type='LINE',
+                        service_id=service_id
+                    ).delete()
+                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                    DeletedCarService.objects.get_or_create(
+                        car=obj,
+                        service_type='LINE',
+                        service_id=service_id
+                    )
+                    print(f"Deleted line service {service_id}: {deleted_count}")
+                except Exception as e:
+                    print(f"Error deleting line service {service_id}: {e}")
+            elif key.startswith('remove_carrier_service_') and value == '1':
+                service_id = key.replace('remove_carrier_service_', '')
+                removed_services.add(f'carrier_{service_id}')
+                try:
+                    deleted_count = CarService.objects.filter(
+                        car=obj,
+                        service_type='CARRIER',
+                        service_id=service_id
+                    ).delete()
+                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                    DeletedCarService.objects.get_or_create(
+                        car=obj,
+                        service_type='CARRIER',
+                        service_id=service_id
+                    )
+                    print(f"Deleted carrier service {service_id}: {deleted_count}")
+                except Exception as e:
+                    print(f"Error deleting carrier service {service_id}: {e}")
+            elif key.startswith('remove_company_service_') and value == '1':
+                service_id = key.replace('remove_company_service_', '')
+                removed_services.add(f'company_{service_id}')
+                try:
+                    deleted_count = CarService.objects.filter(
+                        car=obj,
+                        service_type='COMPANY',
+                        service_id=service_id
+                    ).delete()
+                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                    DeletedCarService.objects.get_or_create(
+                        car=obj,
+                        service_type='COMPANY',
+                        service_id=service_id
+                    )
+                    print(f"Deleted company service {service_id}: {deleted_count}")
+                except Exception as e:
+                    print(f"Error deleting company service {service_id}: {e}")
+        
+        print(f"Removed services: {removed_services}")
+        
+        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞
+        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
+        existing_warehouse_car_services = CarService.objects.filter(
+            car=obj,
+            service_type='WAREHOUSE'
+        )
+        
+        for car_service in existing_warehouse_car_services:
+            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
+            if f'warehouse_{car_service.service_id}' in removed_services:
+                continue
+            
+            field_name = f'warehouse_service_{car_service.service_id}'
+            value = request.POST.get(field_name)
+            
+            if value:
+                try:
+                    car_service.custom_price = float(value)
+                except (ValueError, TypeError):
+                    pass
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É
+            markup_field = f'markup_warehouse_service_{car_service.service_id}'
+            markup_value = request.POST.get(markup_field, '0')
+            try:
+                car_service.markup_amount = float(markup_value) if markup_value else 0
+            except (ValueError, TypeError):
+                car_service.markup_amount = 0
+            car_service.save()
+        
+        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
+        if obj.warehouse:
+            warehouse_services = WarehouseService.objects.filter(
+                warehouse=obj.warehouse, 
+                is_active=True,
+                default_price__gt=0
+            ).only('id', 'default_price')
+            
+            existing_car_service_ids = set(existing_warehouse_car_services.values_list('service_id', flat=True))
+            
+            # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
+            deleted_services = DeletedCarService.objects.filter(
+                car=obj,
+                service_type='WAREHOUSE'
+            ).values_list('service_id', flat=True)
+            
+            for service in warehouse_services:
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
+                if f'warehouse_{service.id}' in removed_services:
+                    continue
+                
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                if service.id in deleted_services:
+                    continue
+                
+                # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
+                if service.id not in existing_car_service_ids:
+                    field_name = f'warehouse_service_{service.id}'
+                    value = request.POST.get(field_name) or service.default_price
+                    # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏
+                    default_markup = getattr(service, 'default_markup', 0) or 0
+                    CarService.objects.create(
+                        car=obj,
+                        service_type='WAREHOUSE',
+                        service_id=service.id,
+                        custom_price=float(value),
+                        markup_amount=float(default_markup)
+                    )
+        
+        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏
+        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è THS)
+        existing_line_car_services = CarService.objects.filter(
+            car=obj,
+            service_type='LINE'
+        )
+        
+        for car_service in existing_line_car_services:
+            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
+            if f'line_{car_service.service_id}' in removed_services:
+                continue
+            
+            field_name = f'line_service_{car_service.service_id}'
+            value = request.POST.get(field_name)
+            
+            if value:
+                try:
+                    car_service.custom_price = float(value)
+                except (ValueError, TypeError):
+                    pass
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É
+            markup_field = f'markup_line_service_{car_service.service_id}'
+            markup_value = request.POST.get(markup_field, '0')
+            try:
+                car_service.markup_amount = float(markup_value) if markup_value else 0
+            except (ValueError, TypeError):
+                car_service.markup_amount = 0
+            car_service.save()
+        
+        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
+        if obj.line:
+            line_services = LineService.objects.filter(
+                line=obj.line, 
+                is_active=True,
+                default_price__gt=0
+            ).only('id', 'default_price')
+            
+            existing_car_service_ids = set(existing_line_car_services.values_list('service_id', flat=True))
+            
+            # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
+            deleted_services = DeletedCarService.objects.filter(
+                car=obj,
+                service_type='LINE'
+            ).values_list('service_id', flat=True)
+            
+            for service in line_services:
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
+                if f'line_{service.id}' in removed_services:
+                    continue
+                
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                if service.id in deleted_services:
+                    continue
+                
+                # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
+                if service.id not in existing_car_service_ids:
+                    field_name = f'line_service_{service.id}'
+                    value = request.POST.get(field_name) or service.default_price
+                    # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏
+                    default_markup = getattr(service, 'default_markup', 0) or 0
+                    CarService.objects.create(
+                        car=obj,
+                        service_type='LINE',
+                        service_id=service.id,
+                        custom_price=float(value),
+                        markup_amount=float(default_markup)
+                    )
+        
+        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+        existing_carrier_car_services = CarService.objects.filter(
+            car=obj,
+            service_type='CARRIER'
+        )
+        
+        for car_service in existing_carrier_car_services:
+            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
+            if f'carrier_{car_service.service_id}' in removed_services:
+                continue
+            
+            field_name = f'carrier_service_{car_service.service_id}'
+            value = request.POST.get(field_name)
+            
+            if value:
+                try:
+                    car_service.custom_price = float(value)
+                except (ValueError, TypeError):
+                    pass
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É
+            markup_field = f'markup_carrier_service_{car_service.service_id}'
+            markup_value = request.POST.get(markup_field, '0')
+            try:
+                car_service.markup_amount = float(markup_value) if markup_value else 0
+            except (ValueError, TypeError):
+                car_service.markup_amount = 0
+            car_service.save()
+        
+        # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
+        if obj.carrier:
+            carrier_services = CarrierService.objects.filter(
+                carrier=obj.carrier, 
+                is_active=True,
+                default_price__gt=0
+            ).only('id', 'default_price')
+            
+            existing_car_service_ids = set(existing_carrier_car_services.values_list('service_id', flat=True))
+            
+            # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
+            deleted_services = DeletedCarService.objects.filter(
+                car=obj,
+                service_type='CARRIER'
+            ).values_list('service_id', flat=True)
+            
+            for service in carrier_services:
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞
+                if f'carrier_{service.id}' in removed_services:
+                    continue
+                
+                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
+                if service.id in deleted_services:
+                    continue
+                
+                # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
+                if service.id not in existing_car_service_ids:
+                    field_name = f'carrier_service_{service.id}'
+                    value = request.POST.get(field_name) or service.default_price
+                    # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏
+                    default_markup = getattr(service, 'default_markup', 0) or 0
+                    CarService.objects.create(
+                        car=obj,
+                        service_type='CARRIER',
+                        service_id=service.id,
+                        custom_price=float(value),
+                        markup_amount=float(default_markup)
+                    )
+
+        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π
+        existing_company_car_services = CarService.objects.filter(
+            car=obj,
+            service_type='COMPANY'
+        )
+        
+        for car_service in existing_company_car_services:
+            if f'company_{car_service.service_id}' in removed_services:
+                continue
+            
+            field_name = f'company_service_{car_service.service_id}'
+            value = request.POST.get(field_name)
+            
+            if value:
+                try:
+                    car_service.custom_price = float(value)
+                except (ValueError, TypeError):
+                    pass
+            
+            markup_field = f'markup_company_service_{car_service.service_id}'
+            markup_value = request.POST.get(markup_field, '0')
+            try:
+                car_service.markup_amount = float(markup_value) if markup_value else 0
+            except (ValueError, TypeError):
+                car_service.markup_amount = 0
+            car_service.save()
+        
+        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –¥–Ω–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞
+        if change and form and 'warehouse' in getattr(form, 'changed_data', []):
+            print(f"–°–∫–ª–∞–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è {obj.vin}, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è")
+            try:
+                # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
+                obj.update_days_and_storage()
+                obj.calculate_total_price()
+                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è
+                obj.save(update_fields=['storage_cost', 'days', 'total_price'])
+                print(f"–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–ª—è: storage_cost={obj.storage_cost}, days={obj.days}")
+            except Exception as e:
+                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
+
+    def warehouse_services_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤"""
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–æ—Ç –ª—é–±—ã—Ö —Å–∫–ª–∞–¥–æ–≤)
+            car_services = CarService.objects.filter(
+                car=obj, 
+                service_type='WAREHOUSE'
+            ).select_related('car')
+            
+            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
+            
+            if car_services:
+                for car_service in car_services:
+                    try:
+                        # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏ –∏ —Å–∫–ª–∞–¥–∞
+                        service = WarehouseService.objects.select_related('warehouse').get(id=car_service.service_id)
+                        current_value = car_service.custom_price or service.default_price
+                        markup_value = car_service.markup_amount or 0
+                        warehouse_name = service.warehouse.name
+                        
+                        # –ü–æ–¥—Å–≤–µ—Ç–∫–∞: –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥ - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥–∏–µ - –∂–µ–ª—Ç—ã–π
+                        bg_color = "#e8f5e9" if (obj.warehouse and service.warehouse.id == obj.warehouse.id) else "#fff9e6"
+                        
+                        html += f'''
+                        <div style="border: 1px solid #ddd; padding: 10px; background: {bg_color}; position: relative; min-width: 220px;">
+                            <button type="button" onclick="removeService({service.id}, 'warehouse')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
+                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">üì¶ {warehouse_name}</div>
+                            <strong>{service.name}</strong><br>
+                            <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
+                                <input type="number" name="warehouse_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
+                                <span style="color: #28a745; font-weight: bold;">+</span>
+                                <input type="number" name="markup_warehouse_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
+                            </div>
+                            <input type="hidden" name="remove_warehouse_service_{service.id}" id="remove_warehouse_service_{service.id}" value="">
+                        </div>
+                        '''
+                    except Exception as e:
+                        continue
+            
+            html += '</div>'
+            
+            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ - —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
+            html += f'''
+            <div style="margin-top: 10px;">
+                <button type="button" class="add-service-btn" onclick="openModal('warehouseServicesModal', 'warehouse')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª—é–±–æ–≥–æ —Å–∫–ª–∞–¥–∞">
+                    +
+                </button>
+                <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞</span>
+            </div>
+            '''
+            
+            # –î–æ–±–∞–≤–ª—è–µ–º JavaScript –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥
+            html += '''
+            <script>
+            function removeService(serviceId, serviceType) {
+                const serviceDiv = event.target.closest('div');
+                serviceDiv.style.display = 'none';
+                const hiddenField = document.getElementById('remove_' + serviceType + '_service_' + serviceId);
+                hiddenField.value = '1';
+                console.log('Removed service:', serviceType, serviceId, 'Field value:', hiddenField.value);
+            }
+            </script>
+            '''
+            
+            return mark_safe(html)
+        except Exception as e:
+            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
+    warehouse_services_display.short_description = "–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞"
+
+    def line_services_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏"""
+        if not obj.line:
+            return "–õ–∏–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞"
+        
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º
+            car_services = CarService.objects.filter(
+                car=obj, 
+                service_type='LINE'
+            )
+            
+            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
+            
+            for car_service in car_services:
+                try:
+                    # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏
+                    service = LineService.objects.get(id=car_service.service_id)
+                    current_value = car_service.custom_price or service.default_price
+                    markup_value = car_service.markup_amount or 0
+                    
+                    html += f'''
+                    <div style="border: 1px solid #ddd; padding: 10px; background: #e3f2fd; position: relative; min-width: 200px;">
+                        <button type="button" onclick="removeService({service.id}, 'line')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
+                        <strong>{service.name}</strong><br>
+                        <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
+                            <input type="number" name="line_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
+                            <span style="color: #28a745; font-weight: bold;">+</span>
+                            <input type="number" name="markup_line_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
+                        </div>
+                        <input type="hidden" name="remove_line_service_{service.id}" id="remove_line_service_{service.id}" value="">
+                    </div>
+                    '''
+                except:
+                    continue
+            
+            html += '</div>'
+            
+            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥
+            if obj.line:
+                html += f'''
+                <div style="margin-top: 10px;">
+                    <button type="button" class="add-service-btn" onclick="openModal('lineServicesModal', 'line')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏">
+                        +
+                    </button>
+                    <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏</span>
+                </div>
+                '''
+            
+            if not car_services:
+                html += '<div style="margin-top: 8px; color: #6c757d;">–£—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú+‚Äù.</div>'
+            
+            return mark_safe(html)
+        except Exception as e:
+            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
+    line_services_display.short_description = "–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏"
+
+    def carrier_services_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+        if not obj.carrier:
+            return "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω"
+        
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º
+            car_services = CarService.objects.filter(
+                car=obj, 
+                service_type='CARRIER'
+            )
+            
+            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
+            
+            for car_service in car_services:
+                try:
+                    # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏
+                    service = CarrierService.objects.get(id=car_service.service_id)
+                    current_value = car_service.custom_price or service.default_price
+                    markup_value = car_service.markup_amount or 0
+                    
+                    html += f'''
+                    <div style="border: 1px solid #ddd; padding: 10px; background: #fff3e0; position: relative; min-width: 200px;">
+                        <button type="button" onclick="removeService({service.id}, 'carrier')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
+                        <strong>{service.name}</strong><br>
+                        <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
+                            <input type="number" name="carrier_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
+                            <span style="color: #28a745; font-weight: bold;">+</span>
+                            <input type="number" name="markup_carrier_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
+                        </div>
+                        <input type="hidden" name="remove_carrier_service_{service.id}" id="remove_carrier_service_{service.id}" value="">
+                    </div>
+                    '''
+                except:
+                    continue
+            
+            html += '</div>'
+            
+            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥
+            if obj.carrier:
+                html += f'''
+                <div style="margin-top: 10px;">
+                    <button type="button" class="add-service-btn" onclick="openModal('carrierServicesModal', 'carrier')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞">
+                        +
+                    </button>
+                    <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞</span>
+                </div>
+                '''
+            
+            if not car_services:
+                html += '<div style="margin-top: 8px; color: #6c757d;">–£—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú+‚Äù.</div>'
+            
+            return mark_safe(html)
+        except Exception as e:
+            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
+    carrier_services_display.short_description = "–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+
+    def company_services_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π"""
+        try:
+            car_services = CarService.objects.filter(
+                car=obj,
+                service_type='COMPANY'
+            )
+            
+            html = '<div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">'
+            
+            if car_services:
+                for car_service in car_services:
+                    try:
+                        service = CompanyService.objects.select_related('company').get(id=car_service.service_id)
+                        current_value = car_service.custom_price if car_service.custom_price is not None else service.default_price
+                        markup_value = car_service.markup_amount or 0
+                        
+                        html += f'''
+                        <div style="border: 1px solid #ddd; padding: 10px; background: #f3e8ff; position: relative; min-width: 240px;">
+                            <button type="button" onclick="removeService({service.id}, 'company')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
+                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">üè¢ {service.company.name}</div>
+                            <strong>{service.name}</strong><br>
+                            <div style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
+                                <input type="number" name="company_service_{service.id}" value="{current_value}" step="0.01" style="width: 80px;" title="–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏">
+                                <span style="color: #28a745; font-weight: bold;">+</span>
+                                <input type="number" name="markup_company_service_{service.id}" value="{markup_value}" step="0.01" style="width: 60px; background: #fffde7; border-color: #ffc107;" title="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞" placeholder="0">
+                            </div>
+                            <input type="hidden" name="remove_company_service_{service.id}" id="remove_company_service_{service.id}" value="">
+                        </div>
+                        '''
+                    except Exception:
+                        continue
+            
+            html += '</div>'
+            
+            html += f'''
+            <div style="margin-top: 10px;">
+                <button type="button" class="add-service-btn" onclick="openModal('companyServicesModal', 'company')" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏">
+                    +
+                </button>
+                <span style="margin-left: 5px; color: #666;">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏</span>
+            </div>
+            '''
+            
+            return mark_safe(html)
+        except Exception as e:
+            return f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}"
+    company_services_display.short_description = "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π"
+
+    def get_changelist(self, request, **kwargs):
+        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ '–í –ø–æ—Ä—Ç—É' –∏ '–†–∞–∑–≥—Ä—É–∂–µ–Ω'"""
+        # –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+        if not request.GET.get('status_multi'):
+            # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
+            get_params = request.GET.copy()
+            get_params.setlist('status_multi', ['IN_PORT', 'UNLOADED'])
+            request.GET = get_params
+        return super().get_changelist(request, **kwargs)
+
+# WarehouseServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏"
+
+
+# –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–¥–º–∏–Ω
+# @admin.register(Warehouse)
+# class WarehouseAdmin(admin.ModelAdmin):
+
+@admin.register(Warehouse)
+class WarehouseAdmin(admin.ModelAdmin):
+    list_display = ('name', 'address', 'free_days', 'balance_display')
+    search_fields = ('name', 'address')
+    readonly_fields = ('balance',)
+    exclude = (
+        'default_unloading_fee', 'delivery_to_warehouse', 'loading_on_trawl',
+        'documents_fee', 'transfer_fee', 'transit_declaration', 'export_declaration',
+        'additional_expenses', 'complex_fee'
+    )
+    inlines = [WarehouseServiceInline]
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
+            'fields': ('name', 'address')
+        }),
+        ('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è', {
+            'fields': ('free_days',),
+            'description': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è. –°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.'
+        }),
+        ('–ë–∞–ª–∞–Ω—Å', {
+            'fields': ('balance',),
+            'description': '–ë–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞'
+        }),
+    )
+
+    def balance_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞"""
+        try:
+            balance = obj.balance or 0
+            color = '#28a745' if balance >= 0 else '#dc3545'
+            sign = '+' if balance >= 0 else ''
+            return format_html(
+                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
+                color, sign, balance
+            )
+        except:
+            return '-'
+    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
+
+    def balance_summary_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–∫–ª–∞–¥–∞"""
+        try:
+            balance = obj.balance or 0
+            
+            html = f"""
+            <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;">
+                <h3 style="margin-top:0; color:#495057;">–ë–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞</h3>
+                
+                <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
+                    <strong>–ë–∞–ª–∞–Ω—Å:</strong><br>
+                    <span style="font-size:18px; color:{'#28a745' if balance >= 0 else '#dc3545'};">{balance:.2f}</span>
+                </div>
+                </div>
+                
+                <div style="background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};">
+                    <strong style="color:{'#28a745' if total_balance >= 0 else '#dc3545'};">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</strong><br>
+                    <span style="font-size:24px; font-weight:bold; color:{'#28a745' if total_balance >= 0 else '#dc3545'};">{total_balance:.2f}</span>
+                </div>
+            </div>
+            """
+            
+            return format_html(html)
+        except Exception as e:
+            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {e}</p>')
+    balance_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É'
+
+    def balance_transactions_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–∫–ª–∞–¥–∞"""
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞
+            payments = Payment.objects.filter(
+                models.Q(from_warehouse=obj) | models.Q(to_warehouse=obj)
+            ).order_by('-date', '-id')[:20]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–ª–∞—Ç–µ–∂–µ–π
+            
+            if not payments.exists():
+                return format_html('<p style="color:#6c757d;">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>')
+            
+            html = ['<div style="margin-top:15px;">']
+            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>')
+            html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
+            html.append('<tr style="background-color:#f8f9fa;">')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–î–∞—Ç–∞</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–¢–∏–ø</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>')
+            html.append('</tr>')
+            
+            for payment in payments:
+                amount_color = '#28a745' if payment.to_warehouse == obj else '#dc3545'
+                html.append('<tr>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.date.strftime("%d.%m.%Y")}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.payment_type}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;">{payment.amount:.2f}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.sender}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.recipient}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.description or "-"}</td>')
+                html.append('</tr>')
+            
+            html.append('</table>')
+            html.append('</div>')
+            
+            return format_html(''.join(html))
+        except Exception as e:
+            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>')
+    balance_transactions_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏'
+    
+    def reset_warehouse_balance(self, request, queryset):
+        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤"""
+        from django.contrib import messages
+        
+        try:
+            for warehouse in queryset:
+                warehouse.balance = 0
+                warehouse.save()
+            
+            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} —Å–∫–ª–∞–¥–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
+        except Exception as e:
+            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
+    
+    reset_warehouse_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤'
+
+
+
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥"""
+        extra_context = extra_context or {}
+        
+        if object_id:
+            obj = self.get_object(request, object_id)
+            
+            if request.method == 'POST':
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
+                for key, value in request.POST.items():
+                    if key.startswith('service_name_'):
+                        service_id = key.replace('service_name_', '')
+                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ)
+                        if service_id.isdigit():
+                            try:
+                                service = WarehouseService.objects.get(id=service_id, warehouse=obj)
+                                service.name = value
+                                service.save()
+                            except WarehouseService.DoesNotExist:
+                                pass
+                    elif key.startswith('service_price_'):
+                        service_id = key.replace('service_price_', '')
+                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ)
+                        if service_id.isdigit():
+                            try:
+                                service = WarehouseService.objects.get(id=service_id, warehouse=obj)
+                                service.default_price = float(value) if value else 0
+                                service.save()
+                            except (WarehouseService.DoesNotExist, ValueError):
+                                pass
+                    elif key.startswith('delete_service_'):
+                        service_id = key.replace('delete_service_', '')
+                        try:
+                            service = WarehouseService.objects.get(id=service_id, warehouse=obj)
+                            service.delete()
+                        except WarehouseService.DoesNotExist:
+                                pass
+                
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è —É—Å–ª—É–≥
+                old_fields_mapping = {
+                    'service_price_complex': 'complex_fee',
+                    'service_price_unloading': 'default_unloading_fee',
+                    'service_price_delivery': 'delivery_to_warehouse',
+                    'service_price_loading': 'loading_on_trawl',
+                    'service_price_documents': 'documents_fee',
+                    'service_price_transfer': 'transfer_fee',
+                    'service_price_transit': 'transit_declaration',
+                    'service_price_export': 'export_declaration',
+                    'service_price_additional': 'additional_expenses',
+                    'service_price_rate': 'rate',
+                }
+                
+                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –Ω—É–∂–Ω–æ –æ–±–Ω—É–ª–∏—Ç—å
+                for key, value in request.POST.items():
+                    if key.startswith('clear_field_'):
+                        field_name = key.replace('clear_field_', '')
+                        setattr(obj, field_name, 0)
+                        obj.save()
+                
+                # –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
+                for field_name, model_field in old_fields_mapping.items():
+                    if field_name in request.POST:
+                        try:
+                            value = float(request.POST[field_name]) if request.POST[field_name] else 0
+                            setattr(obj, model_field, value)
+                            obj.save()
+                        except ValueError:
+                            pass
+                
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏
+                for key, value in request.POST.items():
+                    if key.startswith('new_service_name_'):
+                        index = key.replace('new_service_name_', '')
+                        name = value
+                        price = request.POST.get(f'new_service_price_{index}', 0)
+                        
+                        if name:
+                            try:
+                                WarehouseService.objects.create(
+                                    warehouse=obj,
+                                    name=name,
+                                    default_price=float(price) if price else 0
+                                )
+                            except ValueError:
+                                pass
+        
+        return super().change_view(request, object_id, form_url, extra_context)
+
+
+# ============================================================================
+# –°–¢–ê–†–ê–Ø –ê–î–ú–ò–ù–ö–ê INVOICE - –£–î–ê–õ–ï–ù–ê
+# ============================================================================
+# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ NewInvoiceAdmin –∏–∑ admin_billing.py
+# ============================================================================
+
+# @admin.register(InvoiceOLD)  # –û—Ç–∫–ª—é—á–µ–Ω–æ
+
+# ============================================================================
+# –°–¢–ê–†–ê–Ø –ê–î–ú–ò–ù–ö–ê PAYMENT - –£–î–ê–õ–ï–ù–ê
+# ============================================================================
+# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TransactionAdmin –∏–∑ admin_billing.py
+# ============================================================================
+
+# @admin.register(PaymentOLD)  # –û—Ç–∫–ª—é—á–µ–Ω–æ
+
+@admin.register(Client)
+class ClientAdmin(admin.ModelAdmin):
+    change_form_template = 'admin/client_change.html'
+    list_display = ('name', 'emails_display', 'notification_enabled', 'new_balance_display', 'balance_status_new')
+    list_filter = ('name', 'notification_enabled')
+    search_fields = ('name', 'email', 'email2', 'email3', 'email4')
+    actions = ['reset_balances', 'recalculate_balance', 'reset_client_balance']
+    readonly_fields = ('balance', 'balance_updated_at', 'new_invoices_display', 'new_transactions_display')
+
+    def get_queryset(self, request):
+        """–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º with_balance_info –¥–ª—è –ø—Ä–µ–¥—Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö"""
+        qs = super().get_queryset(request)
+        # –î–ª—è list view –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å annotate
+        if 'changelist' in request.path:
+            return qs.with_balance_info()
+        return qs
+
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': ('name', 'notification_enabled')
+        }),
+        ('üìß Email-–∞–¥—Ä–µ—Å–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', {
+            'fields': ('email', 'email2', 'email3', 'email4'),
+            'description': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞'
+        }),
+        ('üí∞ –ë–∞–ª–∞–Ω—Å', {
+            'fields': ('balance', 'balance_updated_at', 'new_invoices_display', 'new_transactions_display'),
+            'description': '–ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π'
+        }),
+    )
+    
+    def emails_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ email-–∞–¥—Ä–µ—Å–æ–≤"""
+        emails = obj.get_notification_emails()
+        count = len(emails)
+        if count == 0:
+            return format_html('<span style="color: #999;">‚Äî</span>')
+        elif count == 1:
+            return format_html('<span title="{}">{}</span>', emails[0], emails[0])
+        else:
+            all_emails = ', '.join(emails)
+            return format_html('<span title="{}">{} (+{})</span>', all_emails, emails[0], count - 1)
+    emails_display.short_description = 'Email'
+
+    def real_balance_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ (–∏–Ω–≤–æ–π—Å—ã - –ø–ª–∞—Ç–µ–∂–∏)"""
+        balance = obj.real_balance
+        color = obj.balance_color
+        sign = '' if balance == 0 else ('+' if balance > 0 else '')
+        formatted = f"{balance:.2f}"
+        
+        return format_html(
+            '<span style="color:{}; font-weight:bold; font-size:14px;">{} {}</span>',
+            color, sign, formatted
+        )
+    real_balance_display.short_description = '–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å (–î–æ–ª–≥/–ü–µ—Ä–µ–ø–ª–∞—Ç–∞)'
+    real_balance_display.admin_order_field = '_real_balance_annotated'
+
+    def balance_status_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ —Ü–≤–µ—Ç–Ω—ã–º –±–µ–π–¥–∂–µ–º"""
+        status = obj.balance_status
+        color = obj.balance_color
+        bg_color = color.replace('#', '')
+        
+        return format_html(
+            '<span style="background-color:{}; color:white; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold;">{}</span>',
+            color, status
+        )
+    balance_status_display.short_description = '–°—Ç–∞—Ç—É—Å'
+
+    def new_balance_display(self, obj):
+        """–ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê - –µ–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å"""
+        balance = obj.balance
+        if balance > 0:
+            color = '#28a745'
+            text = f'+{balance:.2f}'
+        elif balance < 0:
+            color = '#dc3545'
+            text = f'{balance:.2f}'
+        else:
+            color = '#6c757d'
+            text = '0.00'
+        
+        return format_html(
+            '<span style="color:{}; font-weight:bold; font-size:15px;">{}</span>',
+            color, text
+        )
+    new_balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
+    new_balance_display.admin_order_field = 'balance'
+    
+    def balance_status_new(self, obj):
+        """–°—Ç–∞—Ç—É—Å –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞"""
+        balance = obj.balance
+        if balance > 0:
+            return format_html('<span style="background:#28a745; color:white; padding:3px 8px; border-radius:3px;">–ü–ï–†–ï–ü–õ–ê–¢–ê</span>')
+        elif balance < 0:
+            return format_html('<span style="background:#dc3545; color:white; padding:3px 8px; border-radius:3px;">–î–û–õ–ì</span>')
+        else:
+            return format_html('<span style="background:#6c757d; color:white; padding:3px 8px; border-radius:3px;">OK</span>')
+    balance_status_new.short_description = '–°—Ç–∞—Ç—É—Å'
+    
+    def new_invoices_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã"""
+        from core.models_billing import NewInvoice
+        
+        invoices = NewInvoice.objects.filter(recipient_client=obj).order_by('-date')[:10]
+        
+        if not invoices:
+            return format_html('<p style="color:#999;">–ò–Ω–≤–æ–π—Å–æ–≤ –µ—â–µ –Ω–µ—Ç. <a href="/admin/core/newinvoice/add/">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≤–æ–π—Å</a></p>')
+        
+        html = '<table style="width:100%; border-collapse:collapse;">'
+        html += '<tr style="background:#f5f5f5;"><th style="padding:8px;">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–û–ø–ª–∞—á–µ–Ω–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr>'
+        
+        for inv in invoices:
+            status_color = {'PAID': '#28a745', 'ISSUED': '#007bff', 'OVERDUE': '#dc3545'}.get(inv.status, '#6c757d')
+            html += f'''<tr style="border-bottom:1px solid #ddd;">
+                <td style="padding:8px;"><a href="/admin/core/newinvoice/{inv.pk}/change/">{inv.number}</a></td>
+                <td style="padding:8px;">{inv.date.strftime("%d.%m.%Y")}</td>
+                <td style="padding:8px;">{inv.total:.2f}</td>
+                <td style="padding:8px;">{inv.paid_amount:.2f}</td>
+                <td style="padding:8px;"><span style="background:{status_color}; color:white; padding:2px 6px; border-radius:3px;">{inv.get_status_display()}</span></td>
+            </tr>'''
+        
+        html += '</table>'
+        return format_html(html)
+    new_invoices_display.short_description = '–ò–Ω–≤–æ–π—Å—ã'
+    
+    def new_transactions_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã"""
+        from core.models_billing import Transaction
+        
+        transactions = Transaction.objects.filter(
+            models.Q(from_client=obj) | models.Q(to_client=obj)
+        ).order_by('-date')[:10]
+        
+        if not transactions:
+            return format_html('<p style="color:#999;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –µ—â–µ –Ω–µ—Ç</p>')
+        
+        html = '<table style="width:100%; border-collapse:collapse;">'
+        html += '<tr style="background:#f5f5f5;"><th style="padding:8px;">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th></tr>'
+        
+        for trx in transactions:
+            type_color = {'PAYMENT': '#28a745', 'REFUND': '#dc3545'}.get(trx.type, '#007bff')
+            direction = '‚Üë –ü–æ–ª—É—á–µ–Ω–æ' if trx.to_client == obj else '‚Üì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'
+            html += f'''<tr style="border-bottom:1px solid #ddd;">
+                <td style="padding:8px;"><a href="/admin/core/transaction/{trx.pk}/change/">{trx.number}</a></td>
+                <td style="padding:8px;">{trx.date.strftime("%d.%m.%Y %H:%M")}</td>
+                <td style="padding:8px;"><span style="background:{type_color}; color:white; padding:2px 6px; border-radius:3px;">{trx.get_type_display()}</span></td>
+                <td style="padding:8px; font-weight:bold;">{trx.amount:.2f}</td>
+                <td style="padding:8px;">{direction}</td>
+            </tr>'''
+        
+        html += '</table>'
+        return format_html(html)
+    new_transactions_display.short_description = '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'
+
+    def recalculate_balance(self, request, queryset):
+        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
+        from django.contrib import messages
+        
+        count = 0
+        for client in queryset:
+            try:
+                # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
+                client.sync_balance_fields()
+                count += 1
+                messages.success(request, f'–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω')
+            except Exception as e:
+                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}: {e}')
+        
+        if count > 0:
+            messages.success(request, f'–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è {count} –∫–ª–∏–µ–Ω—Ç–æ–≤')
+        else:
+            messages.warning(request, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞')
+    
+    recalculate_balance.short_description = '–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å'
+
+    def sync_all_balances(self, request, queryset):
+        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–æ–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
+        from django.contrib import messages
+        
+        count = 0
+        for client in queryset:
+            try:
+                client.sync_balance_fields()
+                count += 1
+                messages.success(request, f'–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω')
+            except Exception as e:
+                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}: {e}')
+        
+        if count > 0:
+            messages.success(request, f'–£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è {count} –∫–ª–∏–µ–Ω—Ç–æ–≤')
+        else:
+            messages.warning(request, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞')
+    
+    sync_all_balances.short_description = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å—ã'
+
+    def get_queryset(self, request):
+        """–ü–æ–ª—É—á–∞–µ–º queryset —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π"""
+        return Client.objects.with_balance_info()
+
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        extra_context = extra_context or {}
+        client = self.get_object(request, object_id)
+        if client:
+            try:
+                summary = client.get_balance_summary()
+                extra_context['balance_summary'] = summary
+            except Exception as e:
+                logger.error(f"Failed to get balance summary for client {client.name}: {e}")
+                extra_context['balance_summary_error'] = f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {str(e)}"
+        return super().change_view(request, object_id, form_url, extra_context)
+
+    def reset_balances(self, request, queryset):
+        if 'confirm' in request.POST:
+            client_ids = request.POST.getlist('_selected_action')
+            clients = Client.objects.filter(id__in=client_ids)
+            from django.core.management import call_command
+            failed_clients = []
+            for client in clients:
+                try:
+                    call_command('reset_client_balances', client_id=client.id)
+                except Exception as e:
+                    logger.error(f"Failed to reset balance for client {client.name}: {e}")
+                    failed_clients.append(f"{client.name}: {str(e)}")
+            if failed_clients:
+                self.message_user(request, f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: {'; '.join(failed_clients)}", level='error')
+            else:
+                self.message_user(request, f"–ë–∞–ª–∞–Ω—Å—ã –¥–ª—è {len(clients)} –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã")
+            return HttpResponseRedirect(request.get_full_path())
+        return render(request, 'admin/confirm_reset_balances.html', {
+            'clients': queryset,
+            'action': 'reset_balances',
+            'action_name': '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã'
+        })
+    reset_balances.short_description = "–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤"
+    
+    def reset_client_balance(self, request, queryset):
+        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
+        from django.contrib import messages
+        
+        try:
+            for client in queryset:
+                client.balance = 0
+                client.save()
+            
+            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
+        except Exception as e:
+            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
+    
+    reset_client_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤'
+    
+    # ========================================================================
+    # –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–û–ú –ö–õ–ò–ï–ù–¢–ê
+    # ========================================================================
+    
+    def get_urls(self):
+        from django.urls import path
+        urls = super().get_urls()
+        custom_urls = [
+            path('<int:client_id>/topup/', self.admin_site.admin_view(self.topup_balance_view), name='client_topup'),
+            path('<int:client_id>/reset-balance/', self.admin_site.admin_view(self.reset_balance_view), name='client_reset_balance'),
+            path('<int:client_id>/recalc-balance/', self.admin_site.admin_view(self.recalc_balance_view), name='client_recalc_balance'),
+            path('<int:client_id>/cars-in-warehouse/', self.admin_site.admin_view(self.cars_in_warehouse_view), name='client_cars_in_warehouse'),
+        ]
+        return custom_urls + urls
+    
+    def topup_balance_view(self, request, client_id):
+        """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞"""
+        from django.shortcuts import render, redirect
+        from django.contrib import messages
+        from decimal import Decimal
+        from core.services.billing_service import BillingService
+        
+        client = Client.objects.get(pk=client_id)
+        
+        if request.method == 'POST':
+            try:
+                amount = Decimal(request.POST.get('amount', 0))
+                method = request.POST.get('method', 'CASH')
+                description = request.POST.get('description', '')
+                
+                if amount <= 0:
+                    raise ValueError("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π")
+                
+                trx = BillingService.topup_balance(
+                    entity=client,
+                    amount=amount,
+                    method=method,
+                    description=description or f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}",
+                    created_by=request.user
+                )
+                
+                messages.success(
+                    request, 
+                    f'‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {trx.number}, —Å—É–º–º–∞: {amount}‚Ç¨'
+                )
+                
+                return redirect('admin:core_client_change', client_id)
+                
+            except Exception as e:
+                messages.error(request, f'‚ùå –û—à–∏–±–∫–∞: {e}')
+        
+        context = {
+            'client': client,
+            'opts': self.model._meta,
+            'title': f'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ - {client.name}',
+        }
+        
+        return render(request, 'admin/client_topup.html', context)
+    
+    def reset_balance_view(self, request, client_id):
+        """–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞"""
+        from django.shortcuts import redirect
+        from django.contrib import messages
+        from decimal import Decimal
+        
+        client = Client.objects.get(pk=client_id)
+        old_balance = client.balance
+        
+        client.balance = Decimal('0.00')
+        client.save(update_fields=['balance'])
+        
+        messages.success(request, f'‚úÖ –ë–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} –æ–±–Ω—É–ª—ë–Ω (–±—ã–ª: {old_balance}‚Ç¨)')
+        return redirect('admin:core_client_change', client_id)
+    
+    def recalc_balance_view(self, request, client_id):
+        """–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
+        from django.shortcuts import redirect
+        from django.contrib import messages
+        from django.db.models import Sum
+        from decimal import Decimal
+        from core.models_billing import Transaction
+        
+        client = Client.objects.get(pk=client_id)
+        old_balance = client.balance
+        
+        # –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (TOPUP)
+        topups = Transaction.objects.filter(
+            to_client=client,
+            type='TOPUP',
+            status='COMPLETED'
+        ).aggregate(Sum('amount'))['amount__sum'] or Decimal('0.00')
+        
+        # –ü–ª–∞—Ç–µ–∂–∏ (PAYMENT)
+        payments = Transaction.objects.filter(
+            from_client=client,
+            type='PAYMENT',
+            status='COMPLETED'
+        ).aggregate(Sum('amount'))['amount__sum'] or Decimal('0.00')
+        
+        # –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
+        new_balance = topups - payments
+        
+        client.balance = new_balance
+        client.save(update_fields=['balance'])
+        
+        messages.success(
+            request, 
+            f'‚úÖ –ë–∞–ª–∞–Ω—Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω: {old_balance}‚Ç¨ ‚Üí {new_balance}‚Ç¨ (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: {topups}‚Ç¨, –ø–ª–∞—Ç–µ–∂–∏: {payments}‚Ç¨)'
+        )
+        return redirect('admin:core_client_change', client_id)
+    
+    def cars_in_warehouse_view(self, request, client_id):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–∑–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ"""
+        from django.shortcuts import render
+        from django.http import JsonResponse
+        
+        client = Client.objects.get(pk=client_id)
+        
+        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º UNLOADED (–Ω–∞ —Å–∫–ª–∞–¥–µ)
+        cars = Car.objects.filter(
+            client=client,
+            status='UNLOADED'
+        ).select_related('warehouse', 'container').order_by('warehouse__name', '-unload_date')
+        
+        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–∫–ª–∞–¥–∞–º
+        warehouses_data = {}
+        for car in cars:
+            wh_name = car.warehouse.name if car.warehouse else '–ë–µ–∑ —Å–∫–ª–∞–¥–∞'
+            if wh_name not in warehouses_data:
+                warehouses_data[wh_name] = []
+            warehouses_data[wh_name].append(car)
+        
+        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
+        text_for_copy = f"–ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ - {client.name}\n"
+        text_for_copy += f"–î–∞—Ç–∞: {timezone.now().strftime('%d.%m.%Y')}\n"
+        text_for_copy += "=" * 40 + "\n\n"
+        
+        for wh_name, wh_cars in warehouses_data.items():
+            text_for_copy += f"üìç {wh_name} ({len(wh_cars)} –∞–≤—Ç–æ)\n"
+            text_for_copy += "-" * 30 + "\n"
+            for car in wh_cars:
+                text_for_copy += f"‚Ä¢ {car.vin} - {car.brand} {car.year}"
+                if car.unload_date:
+                    text_for_copy += f" (—Ä–∞–∑–≥—Ä. {car.unload_date.strftime('%d.%m.%Y')})"
+                text_for_copy += "\n"
+            text_for_copy += "\n"
+        
+        text_for_copy += f"–ò—Ç–æ–≥–æ: {cars.count()} –∞–≤—Ç–æ"
+        
+        context = {
+            'client': client,
+            'cars': cars,
+            'warehouses_data': warehouses_data,
+            'text_for_copy': text_for_copy,
+            'total_count': cars.count(),
+            'opts': self.model._meta,
+            'title': f'–ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ - {client.name}',
+        }
+        
+        return render(request, 'admin/client_cars_in_warehouse.html', context)
+
+@admin.register(Company)
+class CompanyAdmin(admin.ModelAdmin):
+    change_form_template = 'admin/company_change.html'
+    list_display = ('name', 'balance_display', 'is_main_company', 'created_at', 'updated_at')
+    search_fields = ('name',)
+    readonly_fields = ('created_at', 'updated_at', 'balance')
+    actions = ['reset_company_balance']
+    inlines = [CompanyServiceInline]
+    
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': ('name',)
+        }),
+        ('–ë–∞–ª–∞–Ω—Å', {
+            'fields': ('balance',),
+            'description': '–ë–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏'
+        }),
+        ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'classes': ('collapse',),
+            'fields': ('created_at', 'updated_at')
+        }),
+    )
+
+    def balance_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏"""
+        try:
+            balance = obj.balance or 0
+            color = '#28a745' if balance >= 0 else '#dc3545'
+            sign = '+' if balance >= 0 else ''
+            return format_html(
+                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
+                color, sign, balance
+            )
+        except:
+            return '-'
+    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
+    
+    def is_main_company(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π"""
+        return obj.name == "Caromoto Lithuania"
+    is_main_company.boolean = True
+    is_main_company.short_description = "–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è"
+    
+    def invoices_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã"""
+        try:
+            # –ò–Ω–≤–æ–π—Å—ã, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π
+            outgoing_invoices = Invoice.objects.filter(
+                from_entity_type='COMPANY',
+                from_entity_id=obj.id
+            ).order_by('-issue_date')[:10]
+            
+            # –ò–Ω–≤–æ–π—Å—ã, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π
+            incoming_invoices = Invoice.objects.filter(
+                to_entity_type='COMPANY',
+                to_entity_id=obj.id
+            ).order_by('-issue_date')[:10]
+            
+            html = ['<div style="margin-top:15px;">']
+            
+            # –ò—Å—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã
+            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ò–Ω–≤–æ–π—Å—ã, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h4>')
+            if outgoing_invoices.exists():
+                html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
+                html.append('<tr style="background-color:#f8f9fa;">')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ù–æ–º–µ—Ä</th>')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ö–æ–º—É</th>')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—Ç–∞—Ç—É—Å</th>')
+                html.append('</tr>')
+                
+                for invoice in outgoing_invoices:
+                    status_color = '#28a745' if invoice.paid else '#dc3545'
+                    status_text = '–û–ø–ª–∞—á–µ–Ω' if invoice.paid else '–ù–µ –æ–ø–ª–∞—á–µ–Ω'
+                    html.append('<tr>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;"><a href="/admin/core/invoice/{invoice.id}/change/">{invoice.number}</a></td>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.to_entity_name}</td>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.total_amount:.2f}</td>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{status_color};">{status_text}</td>')
+                    html.append('</tr>')
+                
+                html.append('</table>')
+            else:
+                html.append('<p style="color:#6c757d;">–ù–µ—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>')
+            
+            # –í—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã
+            html.append('<h4 style="margin-top:20px; margin-bottom:10px; color:#495057;">–ò–Ω–≤–æ–π—Å—ã, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h4>')
+            if incoming_invoices.exists():
+                html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
+                html.append('<tr style="background-color:#f8f9fa;">')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ù–æ–º–µ—Ä</th>')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç –∫–æ–≥–æ</th>')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
+                html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—Ç–∞—Ç—É—Å</th>')
+                html.append('</tr>')
+                
+                for invoice in incoming_invoices:
+                    status_color = '#28a745' if invoice.paid else '#dc3545'
+                    status_text = '–û–ø–ª–∞—á–µ–Ω' if invoice.paid else '–ù–µ –æ–ø–ª–∞—á–µ–Ω'
+                    html.append('<tr>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;"><a href="/admin/core/invoice/{invoice.id}/change/">{invoice.number}</a></td>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.from_entity_name}</td>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{invoice.total_amount:.2f}</td>')
+                    html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{status_color};">{status_text}</td>')
+                    html.append('</tr>')
+                
+                html.append('</table>')
+            else:
+                html.append('<p style="color:#6c757d;">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>')
+            
+            html.append('</div>')
+            return format_html(''.join(html))
+        except Exception as e:
+            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–æ–π—Å–æ–≤: {e}</p>')
+    invoices_display.short_description = '–°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã'
+    
+    def payments_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏"""
+        try:
+            # –ü–ª–∞—Ç–µ–∂–∏, –≥–¥–µ –∫–æ–º–ø–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
+            payments = Payment.objects.filter(
+                models.Q(from_company=obj) | models.Q(to_company=obj)
+            ).order_by('-date')[:20]
+            
+            if not payments.exists():
+                return format_html('<p style="color:#6c757d;">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>')
+            
+            html = ['<div style="margin-top:15px;">']
+            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>')
+            html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
+            html.append('<tr style="background-color:#f8f9fa;">')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–î–∞—Ç–∞</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–¢–∏–ø</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç –∫–æ–≥–æ</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ö–æ–º—É</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>')
+            html.append('</tr>')
+            
+            for payment in payments:
+                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º
+                if payment.from_company == obj:
+                    # –ö–æ–º–ø–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ–Ω—å–≥–∏
+                    amount_color = '#dc3545'  # –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö
+                    amount_sign = '-'
+                    amount_display = f"{amount_sign}{payment.amount:.2f}"
+                else:
+                    # –ö–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∞–µ—Ç –¥–µ–Ω—å–≥–∏
+                    amount_color = '#28a745'  # –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö
+                    amount_sign = '+'
+                    amount_display = f"{amount_sign}{payment.amount:.2f}"
+                
+                html.append('<tr>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.date}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.get_payment_type_display()}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;">{amount_display}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.sender or "-"}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.recipient or "-"}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.description or "-"}</td>')
+                html.append('</tr>')
+            
+            html.append('</table>')
+            html.append('</div>')
+            return format_html(''.join(html))
+        except Exception as e:
+            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>')
+    payments_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏'
+    
+    def balance_summary_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É –∫–æ–º–ø–∞–Ω–∏–∏"""
+        try:
+            cash_balance = obj.cash_balance or 0
+            card_balance = obj.card_balance or 0
+            invoice_balance = obj.invoice_balance or 0
+            total_balance = cash_balance + card_balance + invoice_balance
+            
+            html = f"""
+            <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;">
+                <h3 style="margin-top:0; color:#495057;">–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É –∫–æ–º–ø–∞–Ω–∏–∏</h3>
+                
+                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px;">
+                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
+                        <strong>–ù–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong><br>
+                        <span style="font-size:18px; color:{'#28a745' if cash_balance >= 0 else '#dc3545'};">{cash_balance:.2f}</span>
+                    </div>
+                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
+                        <strong>–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong><br>
+                        <span style="font-size:18px; color:{'#28a745' if card_balance >= 0 else '#dc3545'};">{card_balance:.2f}</span>
+                    </div>
+                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;">
+                        <strong>–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å:</strong><br>
+                        <span style="font-size:18px; color:{'#28a745' if invoice_balance >= 0 else '#dc3545'};">{invoice_balance:.2f}</span>
+                    </div>
+                </div>
+                
+                <div style="background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};">
+                    <strong style="color:{'#28a745' if total_balance >= 0 else '#dc3545'};">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</strong><br>
+                    <span style="font-size:24px; font-weight:bold; color:{'#28a745' if total_balance >= 0 else '#dc3545'};">{total_balance:.2f}</span>
+                </div>
+                
+                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è Caromoto Lithuania) -->
+                {f'''
+                <div style="margin-top:20px; text-align:center;">
+                    <a href="/company-dashboard/" style="display:inline-block; padding:12px 24px; background:#667eea; color:white; text-decoration:none; border-radius:8px; font-weight:600; font-size:16px;">
+                        üè¢ –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ –∫–æ–º–ø–∞–Ω–∏–∏
+                    </a>
+                </div>
+                ''' if obj.name == "Caromoto Lithuania" else ""}
+            </div>
+            """
+            
+            return format_html(html)
+        except Exception as e:
+            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {e}</p>')
+    balance_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É'
+
+    def balance_transactions_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –∫–æ–º–ø–∞–Ω–∏–∏"""
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏
+            payments = Payment.objects.filter(
+                models.Q(from_company=obj) | models.Q(to_company=obj)
+            ).order_by('-date', '-id')[:20]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–ª–∞—Ç–µ–∂–µ–π
+            
+            if not payments.exists():
+                return format_html('<p style="color:#6c757d;">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>')
+            
+            html = ['<div style="margin-top:15px;">']
+            html.append('<h4 style="margin-bottom:10px; color:#495057;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>')
+            html.append('<table style="width:100%; border-collapse:collapse; font-size:12px;">')
+            html.append('<tr style="background-color:#f8f9fa;">')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–î–∞—Ç–∞</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–¢–∏–ø</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–°—É–º–º–∞</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>')
+            html.append('<th style="border:1px solid #dee2e6; padding:8px; text-align:left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>')
+            html.append('</tr>')
+            
+            for payment in payments:
+                amount_color = '#28a745' if payment.to_company == obj else '#dc3545'
+                html.append('<tr>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.date.strftime("%d.%m.%Y")}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.get_payment_type_display()}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;">{payment.amount:.2f}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.sender or "-"}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.recipient or "-"}</td>')
+                html.append(f'<td style="border:1px solid #dee2e6; padding:8px;">{payment.description or "-"}</td>')
+                html.append('</tr>')
+            
+            html.append('</table>')
+            html.append('</div>')
+            
+            return format_html(''.join(html))
+        except Exception as e:
+            return format_html(f'<p style="color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>')
+    balance_transactions_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏'
+    
+    def reset_company_balance(self, request, queryset):
+        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π"""
+        from django.contrib import messages
+        
+        try:
+            for company in queryset:
+                company.balance = 0
+                company.save()
+            
+            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –∫–æ–º–ø–∞–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
+        except Exception as e:
+            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
+    
+    reset_company_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π'
+
+
+# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∫–µ Django
+admin.site.register(Container, ContainerAdmin)
+# LineServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏"
+
+
+@admin.register(Line)
+class LineAdmin(admin.ModelAdmin):
+    change_form_template = 'admin/line_change.html'
+    form = LineForm
+    list_display = ('name', 'balance_display')
+    search_fields = ('name',)
+    readonly_fields = ('balance',)
+    actions = ['reset_line_balance']
+    exclude = ('ocean_freight_rate', 'documentation_fee', 'handling_fee', 'ths_fee', 'additional_fees')
+    inlines = [LineTHSCoefficientInline, LineServiceInline]
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', {
+            'fields': ('name',)
+        }),
+        ('–ë–∞–ª–∞–Ω—Å', {
+            'fields': ('balance',),
+            'description': '–ë–∞–ª–∞–Ω—Å –ª–∏–Ω–∏–∏'
+        }),
+    )
+
+    def balance_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ª–∏–Ω–∏–∏"""
+        try:
+            balance = obj.balance or 0
+            color = '#28a745' if balance >= 0 else '#dc3545'
+            sign = '+' if balance >= 0 else ''
+            return format_html(
+                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
+                color, sign, balance
+            )
+        except Exception as e:
+            return '-'
+    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
+    
+    def reset_line_balance(self, request, queryset):
+        """–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π"""
+        from django.contrib import messages
+        
+        try:
+            for line in queryset:
+                line.balance = 0
+                line.save()
+            
+            messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –ª–∏–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã')
+        except Exception as e:
+            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}')
+    
+    reset_line_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π'
+
+    def get_urls(self):
+        from django.urls import path
+        urls = super().get_urls()
+        custom_urls = [
+            path('<int:object_id>/recalculate_ths/',
+                 self.admin_site.admin_view(self.recalculate_ths_view),
+                 name='core_line_recalculate_ths'),
+        ]
+        return custom_urls + urls
+    
+    def recalculate_ths_view(self, request, object_id):
+        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º UNLOADED –∏ IN_PORT"""
+        from django.contrib import messages
+        from django.shortcuts import redirect
+        from django.db import transaction
+        from core.models import Container, Car, Line
+        from core.signals import create_ths_services_for_container
+        import logging
+        logger = logging.getLogger(__name__)
+        
+        print(f"=== RECALCULATE THS VIEW CALLED === object_id={object_id}")
+        logger.warning(f"=== RECALCULATE THS VIEW CALLED === object_id={object_id}")
+
+        # –ü–æ–ª—É—á–∞–µ–º –ª–∏–Ω–∏—é –Ω–∞–ø—Ä—è–º—É—é –ø–æ ID
+        try:
+            line = Line.objects.get(pk=object_id)
+        except Line.DoesNotExist:
+            messages.error(request, '–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
+            return redirect('admin:core_line_changelist')
+        print(f"Line: {line}")
+
+        logger.info(f"[RECALC THS] Starting for line {line.name}")
+
+        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Å –º–∞—à–∏–Ω–∞–º–∏ –≤ –Ω—É–∂–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞—Ö
+        containers = Container.objects.filter(
+            line=line,
+            container_cars__status__in=['UNLOADED', 'IN_PORT']
+        ).distinct()
+
+        updated_containers = 0
+        updated_cars = 0
+
+        try:
+            with transaction.atomic():
+                for container in containers:
+                    if container.ths:
+                        logger.info(f"[RECALC THS] Container {container.number}, THS={container.ths}")
+                        
+                        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS —É—Å–ª—É–≥–∏
+                        created = create_ths_services_for_container(container)
+                        logger.info(f"[RECALC THS] Created {created} THS services")
+                        updated_containers += 1
+
+                        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –º–∞—à–∏–Ω
+                        for car in container.container_cars.filter(status__in=['UNLOADED', 'IN_PORT']):
+                            old_price = car.total_price
+                            # –û—á–∏—â–∞–µ–º –∫—ç—à –∏ –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
+                            car.refresh_from_db()
+                            if hasattr(car, '_prefetched_objects_cache'):
+                                car._prefetched_objects_cache.clear()
+                            
+                            car.calculate_total_price()
+                            car.save(update_fields=['total_price', 'storage_cost', 'days'])
+                            logger.info(f"[RECALC THS] Car {car.vin}: {old_price} -> {car.total_price}")
+                            updated_cars += 1
+
+            messages.success(
+                request,
+                f'–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: {updated_containers} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, {updated_cars} –º–∞—à–∏–Ω'
+            )
+        except Exception as e:
+            logger.error(f"[RECALC THS] Error: {e}", exc_info=True)
+            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ: {e}')
+
+        from django.urls import reverse
+        return redirect(reverse('admin:core_line_change', args=[object_id]))
+
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥"""
+        extra_context = extra_context or {}
+        
+        if object_id:
+            obj = self.get_object(request, object_id)
+            
+            if request.method == 'POST':
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
+                for key, value in request.POST.items():
+                    if key.startswith('service_name_'):
+                        service_id = key.replace('service_name_', '')
+                        try:
+                            service = LineService.objects.get(id=service_id, line=obj)
+                            service.name = value
+                            service.save()
+                        except LineService.DoesNotExist:
+                            pass
+                    elif key.startswith('service_price_'):
+                        service_id = key.replace('service_price_', '')
+                        try:
+                            service = LineService.objects.get(id=service_id, line=obj)
+                            service.default_price = float(value) if value else 0
+                            service.save()
+                        except (LineService.DoesNotExist, ValueError):
+                            pass
+                    elif key.startswith('delete_service_'):
+                        service_id = key.replace('delete_service_', '')
+                        try:
+                            service = LineService.objects.get(id=service_id, line=obj)
+                            service.delete()
+                        except LineService.DoesNotExist:
+                            pass
+                
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏
+                for key, value in request.POST.items():
+                    if key.startswith('new_service_name_'):
+                        index = key.replace('new_service_name_', '')
+                        name = value
+                        price = request.POST.get(f'new_service_price_{index}', 0)
+                        
+                        if name:
+                            try:
+                                LineService.objects.create(
+                                    line=obj,
+                                    name=name,
+                                    default_price=float(price) if price else 0
+                                )
+                            except ValueError:
+                                pass
+        
+        return super().change_view(request, object_id, form_url, extra_context)
+
+
+
+
+# CarServiceAdmin —É–¥–∞–ª–µ–Ω
+
+    def get_form(self, request, obj=None, **kwargs):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π"""
+        form = super().get_form(request, obj, **kwargs)
+        
+        if obj and obj.pk:
+            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤ fieldsets
+            dynamic_fields = []
+            for service in obj.services.all():
+                field_name = f'service_{service.id}'
+                dynamic_fields.append(field_name)
+            
+            if dynamic_fields:
+                # –û–±–Ω–æ–≤–ª—è–µ–º fieldsets –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
+                self.fieldsets = list(self.fieldsets)
+                for i, (title, options) in enumerate(self.fieldsets):
+                    if title == '–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã':
+                        fields = list(options['fields'])
+                        fields.append(tuple(dynamic_fields))
+                        self.fieldsets[i] = (title, {**options, 'fields': tuple(fields)})
+                        break
+        
+        return form
+
+
+# CarrierServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏"
+
+
+@admin.register(Carrier)
+class CarrierAdmin(admin.ModelAdmin):
+    change_form_template = 'admin/carrier_change.html'
+    form = CarrierForm
+    list_display = ('name', 'eori_code', 'contact_person', 'phone', 'balance_display')
+    search_fields = ('name', 'eori_code', 'contact_person', 'phone', 'email')
+    list_filter = ('created_at',)
+    readonly_fields = ('created_at', 'updated_at', 'balance')
+    exclude = ('transport_rate', 'loading_fee', 'unloading_fee', 'fuel_surcharge', 'additional_fees')
+    inlines = [CarrierServiceInline, CarrierTruckInline, CarrierDriverInline]
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': ('name', 'short_name', 'eori_code', 'contact_person', 'phone', 'email')
+        }),
+        ('–ë–∞–ª–∞–Ω—Å', {
+            'fields': ('balance',)
+        }),
+        ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': ('created_at', 'updated_at'),
+            'classes': ('collapse',)
+        }),
+    )
+    
+    def balance_display(self, obj):
+        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+        try:
+            balance = obj.balance or 0
+            color = '#28a745' if balance >= 0 else '#dc3545'
+            sign = '+' if balance >= 0 else ''
+            return format_html(
+                '<span style="color:{}; font-weight:bold;">{} {:.2f}</span>',
+                color, sign, balance
+            )
+        except:
+            return '-'
+    balance_display.short_description = '–ë–∞–ª–∞–Ω—Å'
+
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥"""
+        extra_context = extra_context or {}
+        
+        if object_id:
+            obj = self.get_object(request, object_id)
+            
+            if request.method == 'POST':
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
+                for key, value in request.POST.items():
+                    if key.startswith('service_name_'):
+                        service_id = key.replace('service_name_', '')
+                        try:
+                            service = CarrierService.objects.get(id=service_id, carrier=obj)
+                            service.name = value
+                            service.save()
+                        except CarrierService.DoesNotExist:
+                            pass
+                    elif key.startswith('service_price_'):
+                        service_id = key.replace('service_price_', '')
+                        try:
+                            service = CarrierService.objects.get(id=service_id, carrier=obj)
+                            service.default_price = float(value) if value else 0
+                            service.save()
+                        except (CarrierService.DoesNotExist, ValueError):
+                            pass
+                    elif key.startswith('delete_service_'):
+                        service_id = key.replace('delete_service_', '')
+                        try:
+                            service = CarrierService.objects.get(id=service_id, carrier=obj)
+                            service.delete()
+                        except CarrierService.DoesNotExist:
+                            pass
+                
+                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏
+                for key, value in request.POST.items():
+                    if key.startswith('new_service_name_'):
+                        index = key.replace('new_service_name_', '')
+                        name = value
+                        price = request.POST.get(f'new_service_price_{index}', 0)
+                        
+                        if name:
+                            try:
+                                CarrierService.objects.create(
+                                    carrier=obj,
+                                    name=name,
+                                    default_price=float(price) if price else 0
+                                )
+                            except ValueError:
+                                pass
+        
+        return super().change_view(request, object_id, form_url, extra_context)
+
+
+
+# Company —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ @admin.register –≤—ã—à–µ
+
+
+# ==============================================================================
+# üöõ –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–í–û–ó–û–í –ù–ê –ó–ê–ì–†–£–ó–ö–£
+# ==============================================================================
+
+from .models import AutoTransport, CarrierTruck, CarrierDriver
+
+@admin.register(AutoTransport)
+class AutoTransportAdmin(admin.ModelAdmin):
+    """
+    –ê–¥–º–∏–Ω–∫–∞ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
+    
+    –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
+    - AJAX –≤—ã–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
+    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ EORI –∫–æ–¥–∞ –∏–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è
+    - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
+    """
+    
+    change_form_template = 'admin/core/autotransport/change_form.html'
+    
+    list_display = (
+        'number',
+        'carrier',
+        'truck_display',
+        'driver_display',
+        'cars_count_display',
+        'status_display',
+        'loading_date',
+        'actions_display'
+    )
+    
+    list_filter = (
+        'status',
+        'carrier',
+        'loading_date',
+        'created_at',
+    )
+    
+    search_fields = (
+        'number',
+        'carrier__name',
+        'truck_number_manual',
+        'driver_name_manual',
+        'border_crossing',
+    )
+    
+    readonly_fields = (
+        'number',
+        'created_at',
+        'updated_at',
+        'created_by',
+        'cars_count',
+    )
+    
+    filter_horizontal = ('cars',)
+    
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': ('number', 'status')
+        }),
+        ('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', {
+            'fields': ('carrier', 'eori_code')
+        }),
+        ('–ê–≤—Ç–æ–≤–æ–∑', {
+            'fields': (
+                ('truck', 'truck_number_manual', 'trailer_number_manual'),
+            ),
+            'description': '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–≤–æ–∑ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é'
+        }),
+        ('–í–æ–¥–∏—Ç–µ–ª—å', {
+            'fields': (
+                ('driver', 'driver_name_manual', 'driver_phone'),
+            ),
+            'description': '–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é'
+        }),
+        ('–ì—Ä–∞–Ω–∏—Ü–∞ –∏ –º–∞—Ä—à—Ä—É—Ç', {
+            'fields': ('border_crossing',)
+        }),
+        ('–ê–≤—Ç–æ–º–æ–±–∏–ª–∏', {
+            'fields': ('cars', 'cars_count'),
+            'description': '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –∞–≤—Ç–æ–≤–æ–∑'
+        }),
+        ('–î–∞—Ç—ã', {
+            'fields': (
+                'loading_date',
+                'departure_date',
+                'estimated_delivery_date',
+                'actual_delivery_date',
+            )
+        }),
+        ('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ', {
+            'fields': ('notes',),
+            'classes': ('collapse',)
+        }),
+        ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': ('created_at', 'updated_at', 'created_by'),
+            'classes': ('collapse',)
+        }),
+    )
+    
+    def save_model(self, request, obj, form, change):
+        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–≤–æ–∑–∞ —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø–æ–ª–µ–π"""
+        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ç–æ —Å–æ–∑–¥–∞–ª
+        if not change:
+            obj.created_by = request.user.username
+        
+        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç
+        super().save_model(request, obj, form, change)
+        
+        # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω" - —Å–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å—ã
+        if obj.status == 'FORMED':
+            try:
+                invoices = obj.generate_invoices()
+                from django.contrib import messages
+                messages.success(
+                    request,
+                    f'–ê–≤—Ç–æ–≤–æ–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –°–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–Ω–≤–æ–π—Å–æ–≤: {len(invoices)}'
+                )
+            except Exception as e:
+                from django.contrib import messages
+                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤: {e}')
+    
+    def truck_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∞–≤—Ç–æ–≤–æ–∑–∞"""
+        return obj.truck_full_number
+    truck_display.short_description = '–ê–≤—Ç–æ–≤–æ–∑'
+    
+    def driver_display(self, obj):
+        """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è"""
+        return f"{obj.driver_full_name} ({obj.driver_phone or '–Ω–µ—Ç —Ç–µ–ª.'})"
+    driver_display.short_description = '–í–æ–¥–∏—Ç–µ–ª—å'
+    
+    def cars_count_display(self, obj):
+        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
+        count = obj.cars_count
+        return format_html(
+            '<span style="font-weight:bold;">{} –∞–≤—Ç–æ</span>',
+            count
+        )
+    cars_count_display.short_description = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ'
+    
+    def status_display(self, obj):
+        """–¶–≤–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—É—Å"""
+        colors = {
+            'DRAFT': '#6c757d',
+            'FORMED': '#28a745',
+            'LOADED': '#17a2b8',
+            'IN_TRANSIT': '#ffc107',
+            'DELIVERED': '#28a745',
+            'CANCELLED': '#dc3545',
+        }
+        color = colors.get(obj.status, '#6c757d')
+        return format_html(
+            '<span style="color:{}; font-weight:bold;">{}</span>',
+            color, obj.get_status_display()
+        )
+    status_display.short_description = '–°—Ç–∞—Ç—É—Å'
+    
+    def actions_display(self, obj):
+        """–ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π"""
+        html = []
+        
+        if obj.status == 'DRAFT':
+            html.append(format_html(
+                '<a class="button" href="{}">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</a>',
+                reverse('admin:core_autotransport_change', args=[obj.id])
+            ))
+        
+        if obj.id:
+            html.append(format_html(
+                '<a class="button" href="{}">–ò–Ω–≤–æ–π—Å—ã</a>',
+                reverse('admin:core_newinvoice_changelist') + f'?auto_transport__id__exact={obj.id}'
+            ))
+        
+        return format_html(' '.join(html))
+    actions_display.short_description = '–î–µ–π—Å—Ç–≤–∏—è'
+    
+    def add_view(self, request, form_url='', extra_context=None):
+        """–ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–≤–æ–∑–∞"""
+        extra_context = self._get_extra_context(None, extra_context)
+        return super().add_view(request, form_url, extra_context)
+    
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        """–ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–≤–æ–∑–∞"""
+        extra_context = self._get_extra_context(object_id, extra_context)
+        return super().change_view(request, object_id, form_url, extra_context)
+    
+    def _get_extra_context(self, object_id, extra_context=None):
+        """–ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–±–ª–æ–Ω–∞"""
+        extra_context = extra_context or {}
+        
+        # –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–∞—Ö)
+        from .models import Car
+        extra_context['cars'] = Car.objects.select_related('client').all()
+        
+        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–≤—Ç–æ–≤–æ–∑ - –ø–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID
+        if object_id:
+            try:
+                autotransport = self.get_object(None, object_id)
+                extra_context['selected_car_ids'] = list(autotransport.cars.values_list('pk', flat=True))
+            except:
+                extra_context['selected_car_ids'] = []
+        else:
+            extra_context['selected_car_ids'] = []
+        
+        return extra_context
+
+
+# ==============================================================================
+# üéâ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í –ò –ü–õ–ê–¢–ï–ñ–ï–ô
+# ==============================================================================
+# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
+# –ú–æ–¥–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ @admin.register() –≤ admin_billing.py
+
+try:
+    from .admin_billing import NewInvoiceAdmin, TransactionAdmin
+    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
+except ImportError as e:
+    import logging
+    logger = logging.getLogger('django')
+    logger.warning(f"‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã: {e}")
+    logger.warning("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã admin_billing.py –∏ models_billing.py —Å—É—â–µ—Å—Ç–≤—É—é—Ç")
+
 # –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã @admin.register
\ No newline at end of file
diff --git a/core/admin_billing.py b/core/admin_billing.py
index 78081c1..28a7895 100644
--- a/core/admin_billing.py
+++ b/core/admin_billing.py
@@ -1,864 +1,864 @@
-"""
-–ê–¥–º–∏–Ω–∫–∞ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∏–Ω–≤–æ–π—Å–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å–æ–≤
-=========================================================
-
-–ü—Ä–æ—Å—Ç–æ–π –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å:
-- –ò–Ω–≤–æ–π—Å–∞–º–∏
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
-- –ë–∞–ª–∞–Ω—Å–∞–º–∏
-
-–ê–≤—Ç–æ—Ä—ã: AI Assistant
-–î–∞—Ç–∞: 30 —Å–µ–Ω—Ç—è–±—Ä—è 2025
-"""
-
-from django.contrib import admin
-from django.utils.html import format_html
-from django.urls import reverse, path
-from django.shortcuts import render, redirect
-from django.contrib import messages
-from django.db.models import Sum, Q
-from django.utils import timezone
-from decimal import Decimal
-
-from .models_billing import NewInvoice, InvoiceItem, Transaction
-from .services.billing_service import BillingService
-
-
-# ============================================================================
-# INLINE –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –∏–Ω–≤–æ–π—Å–∞
-# ============================================================================
-
-class InvoiceItemInline(admin.TabularInline):
-    """Inline –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –∏–Ω–≤–æ–π—Å–∞"""
-    
-    model = InvoiceItem
-    extra = 3  # 3 –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
-    fields = ('description', 'car', 'quantity', 'unit_price', 'total_price')
-    readonly_fields = ('total_price',)
-    autocomplete_fields = ['car']
-    
-    verbose_name = "–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞"
-    verbose_name_plural = "üì¶ –ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ)"
-    
-    def get_formset(self, request, obj=None, **kwargs):
-        formset = super().get_formset(request, obj, **kwargs)
-        # –£–±–∏—Ä–∞–µ–º help_text –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
-        for field in formset.form.base_fields.values():
-            field.help_text = ''
-        return formset
-
-
-# ============================================================================
-# –ê–î–ú–ò–ù–ö–ê –î–õ–Ø –ò–ù–í–û–ô–°–û–í
-# ============================================================================
-
-@admin.register(NewInvoice)
-class NewInvoiceAdmin(admin.ModelAdmin):
-    """
-    –ü—Ä–æ—Å—Ç–∞—è –∏ –ø–æ–Ω—è—Ç–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
-    """
-    
-    change_form_template = 'admin/core/newinvoice/change_form.html'
-    
-    class Media:
-        css = {
-            'all': ('admin/css/widgets.css',)
-        }
-        js = ('admin/js/SelectBox.js', 'admin/js/SelectFilter2.js',)
-    
-    list_display = (
-        'number_display',
-        'notes_display',
-        'recipient_display',
-        'total_display',
-        'paid_amount_display',
-        'remaining_display',
-        'status_display',
-        'actions_display'
-    )
-    
-    list_filter = (
-        'status',
-        'date',
-        'recipient_client',
-    )
-    
-    search_fields = (
-        'number',
-        'recipient_client__name',
-        'notes',
-    )
-    
-    readonly_fields = (
-        'number',
-        'subtotal',
-        'total',
-        'paid_amount',
-        'created_at',
-        'updated_at',
-        'created_by',
-    )
-    
-    fieldsets = (
-        ('üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'fields': (
-                ('date', 'due_date', 'status'),
-            )
-        }),
-        ('üè¢ –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∏–Ω–≤–æ–π—Å–∞', {
-            'fields': ('issuer_company',),
-            'description': '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: Caromoto Lithuania'
-        }),
-        ('üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –∏–Ω–≤–æ–π—Å–∞', {
-            'fields': ('recipient_client',),
-        }),
-        ('üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏', {
-            'fields': ('cars',),
-            'description': '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥'
-        }),
-        ('üí∞ –§–∏–Ω–∞–Ω—Å—ã', {
-            'fields': (
-                ('subtotal', 'discount', 'tax'),
-                ('total', 'paid_amount'),
-            ),
-            'classes': ('collapse',),
-        }),
-        ('üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ', {
-            'fields': ('notes',),
-            'classes': ('collapse',),
-        }),
-        ('‚öôÔ∏è –ü—Ä–æ—á–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –∫–ª–∏–µ–Ω—Ç)', {
-            'fields': (
-                ('recipient_warehouse', 'recipient_line'),
-                ('recipient_carrier', 'recipient_company'),
-            ),
-            'classes': ('collapse',),
-        }),
-        ('‚öôÔ∏è –ü—Ä–æ—á–∏–µ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –∫–æ–º–ø–∞–Ω–∏—è)', {
-            'fields': (
-                ('issuer_warehouse', 'issuer_line', 'issuer_carrier'),
-            ),
-            'classes': ('collapse',),
-        }),
-    )
-    
-    inlines = [InvoiceItemInline]
-    
-    filter_horizontal = ('cars',)
-    
-    actions = ['mark_as_paid', 'cancel_invoices', 'regenerate_items']
-    
-    def add_view(self, request, form_url='', extra_context=None):
-        """–ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞"""
-        from core.models import Company, Client, Car
-        
-        if request.method == 'POST':
-            return self._handle_custom_form(request, None)
-        
-        extra_context = self._get_extra_context(None, extra_context)
-        return super().add_view(request, form_url, extra_context)
-    
-    def change_view(self, request, object_id, form_url='', extra_context=None):
-        """–ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞"""
-        if request.method == 'POST':
-            return self._handle_custom_form(request, object_id)
-        
-        extra_context = self._get_extra_context(object_id, extra_context)
-        return super().change_view(request, object_id, form_url, extra_context)
-    
-    def _get_extra_context(self, object_id, extra_context=None):
-        """–ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–±–ª–æ–Ω–∞"""
-        from core.models import Company, Client, Car
-        
-        extra_context = extra_context or {}
-        
-        # –ü–æ–ª—É—á–∞–µ–º queryset –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
-        extra_context['companies'] = Company.objects.all().order_by('name')
-        extra_context['clients'] = Client.objects.all().order_by('name')
-        extra_context['cars'] = Car.objects.all().select_related('client').order_by('-id')[:500]
-        
-        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º Caromoto Lithuania –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-        try:
-            caromoto = Company.objects.get(name="Caromoto Lithuania")
-            extra_context['default_company_id'] = caromoto.pk
-        except Company.DoesNotExist:
-            extra_context['default_company_id'] = None
-        
-        # –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–∞—à–∏–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
-        selected_car_ids = []
-        if object_id:
-            try:
-                invoice = NewInvoice.objects.get(pk=object_id)
-                selected_car_ids = list(invoice.cars.values_list('pk', flat=True))
-            except NewInvoice.DoesNotExist:
-                pass
-        extra_context['selected_car_ids'] = selected_car_ids
-        
-        return extra_context
-    
-    def _handle_custom_form(self, request, object_id):
-        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Ñ–æ—Ä–º—É"""
-        from core.models import Company, Client, Car
-        from django.utils import timezone
-        from datetime import datetime
-        
-        try:
-            # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
-            if object_id:
-                invoice = NewInvoice.objects.get(pk=object_id)
-            else:
-                invoice = NewInvoice()
-            
-            # –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ POST
-            date_str = request.POST.get('date')
-            if date_str:
-                invoice.date = datetime.strptime(date_str, '%Y-%m-%d').date()
-            
-            due_date_str = request.POST.get('due_date')
-            if due_date_str:
-                invoice.due_date = datetime.strptime(due_date_str, '%Y-%m-%d').date()
-            else:
-                invoice.due_date = None
-            
-            invoice.status = request.POST.get('status', 'ISSUED')
-            invoice.notes = request.POST.get('notes', '')
-            
-            # –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤—ã—Ö
-            invoice.issuer_company = None
-            invoice.issuer_warehouse = None
-            invoice.issuer_line = None
-            invoice.issuer_carrier = None
-            invoice.recipient_client = None
-            invoice.recipient_company = None
-            invoice.recipient_warehouse = None
-            invoice.recipient_line = None
-            invoice.recipient_carrier = None
-            
-            # –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–ø–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç "type_id", –Ω–∞–ø—Ä–∏–º–µ—Ä "company_123")
-            issuer_value = request.POST.get('issuer', '')
-            if issuer_value and '_' in issuer_value:
-                issuer_type, issuer_id = issuer_value.rsplit('_', 1)
-                if issuer_type == 'company':
-                    invoice.issuer_company = Company.objects.get(pk=issuer_id)
-                elif issuer_type == 'warehouse':
-                    from core.models import Warehouse
-                    invoice.issuer_warehouse = Warehouse.objects.get(pk=issuer_id)
-                elif issuer_type == 'line':
-                    from core.models import Line
-                    invoice.issuer_line = Line.objects.get(pk=issuer_id)
-                elif issuer_type == 'carrier':
-                    from core.models import Carrier
-                    invoice.issuer_carrier = Carrier.objects.get(pk=issuer_id)
-            else:
-                # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Caromoto Lithuania
-                try:
-                    invoice.issuer_company = Company.objects.get(name="Caromoto Lithuania")
-                except Company.DoesNotExist:
-                    pass
-            
-            # –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–ø–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç "type_id", –Ω–∞–ø—Ä–∏–º–µ—Ä "client_456")
-            recipient_value = request.POST.get('recipient', '')
-            if recipient_value and '_' in recipient_value:
-                recipient_type, recipient_id = recipient_value.rsplit('_', 1)
-                if recipient_type == 'client':
-                    invoice.recipient_client = Client.objects.get(pk=recipient_id)
-                elif recipient_type == 'company':
-                    invoice.recipient_company = Company.objects.get(pk=recipient_id)
-                elif recipient_type == 'warehouse':
-                    from core.models import Warehouse
-                    invoice.recipient_warehouse = Warehouse.objects.get(pk=recipient_id)
-                elif recipient_type == 'line':
-                    from core.models import Line
-                    invoice.recipient_line = Line.objects.get(pk=recipient_id)
-                elif recipient_type == 'carrier':
-                    from core.models import Carrier
-                    invoice.recipient_carrier = Carrier.objects.get(pk=recipient_id)
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–≤–æ–π—Å
-            invoice.save()
-            
-            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ (ManyToMany)
-            car_ids = request.POST.getlist('cars')
-            if car_ids:
-                cars = Car.objects.filter(pk__in=car_ids)
-                invoice.cars.set(cars)
-                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —É—Å–ª—É–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
-                invoice.regenerate_items_from_cars()
-                messages.success(request, f'‚úÖ –ò–Ω–≤–æ–π—Å {invoice.number} —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –°–æ–∑–¥–∞–Ω–æ {invoice.items.count()} –ø–æ–∑–∏—Ü–∏–π.')
-            else:
-                invoice.cars.clear()
-                messages.success(request, f'‚úÖ –ò–Ω–≤–æ–π—Å {invoice.number} —Å–æ—Ö—Ä–∞–Ω–µ–Ω!')
-            
-            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É–¥–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å
-            if '_save' in request.POST:
-                return redirect('admin:core_newinvoice_changelist')
-            elif '_continue' in request.POST:
-                return redirect('admin:core_newinvoice_change', invoice.pk)
-            elif '_addanother' in request.POST:
-                return redirect('admin:core_newinvoice_add')
-            else:
-                return redirect('admin:core_newinvoice_changelist')
-                
-        except Exception as e:
-            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞: {str(e)}')
-            import traceback
-            traceback.print_exc()
-            
-            if object_id:
-                return redirect('admin:core_newinvoice_change', object_id)
-            else:
-                return redirect('admin:core_newinvoice_add')
-    
-    def save_model(self, request, obj, form, change):
-        """–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–≤–æ–π—Å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
-        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-        if not obj.issuer_company and not obj.issuer_warehouse and not obj.issuer_line and not obj.issuer_carrier:
-            try:
-                from core.models import Company
-                caromoto = Company.objects.get(name="Caromoto Lithuania")
-                obj.issuer_company = caromoto
-                import logging
-                logger = logging.getLogger(__name__)
-                logger.info(f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∏–Ω–≤–æ–π—Å–∞ {obj.number}")
-            except Company.DoesNotExist:
-                import logging
-                logger = logging.getLogger(__name__)
-                logger.warning("–ö–æ–º–ø–∞–Ω–∏—è Caromoto Lithuania –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
-        
-        # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç
-        super().save_model(request, obj, form, change)
-        
-        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑—å cars (ManyToMany —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ save_related)
-    
-    def save_related(self, request, form, formsets, change):
-        """–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ManyToMany —Å–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
-        # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–≤—è–∑–∏
-        super().save_related(request, form, formsets, change)
-        
-        # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏
-        if form.instance.cars.exists():
-            form.instance.regenerate_items_from_cars()
-            messages.success(request, f"‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ {form.instance.items.count()} –ø–æ–∑–∏—Ü–∏–π –∏–∑ —É—Å–ª—É–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π!")
-    
-    actions = ['mark_as_paid', 'cancel_invoices', 'export_to_pdf', 'regenerate_items']
-    
-    # ========================================================================
-    # –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–û–õ–ï–ô –í –°–ü–ò–°–ö–ï
-    # ========================================================================
-    
-    def number_display(self, obj):
-        """–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ —Å —Å—Å—ã–ª–∫–æ–π"""
-        url = reverse('admin:core_newinvoice_change', args=[obj.pk])
-        return format_html('<a href="{}" style="font-weight: bold;">{}</a>', url, obj.number)
-    number_display.short_description = '–ù–æ–º–µ—Ä'
-    number_display.admin_order_field = 'number'
-    
-    def notes_display(self, obj):
-        """–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞"""
-        if obj.notes:
-            # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤
-            notes_text = obj.notes[:50] + '...' if len(obj.notes) > 50 else obj.notes
-            return format_html('<span title="{}">{}</span>', obj.notes, notes_text)
-        return format_html('<span style="color: #999;">‚Äî</span>')
-    notes_display.short_description = '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è'
-    notes_display.admin_order_field = 'notes'
-    
-    def issuer_display(self, obj):
-        """–í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"""
-        issuer = obj.issuer
-        if issuer:
-            return format_html(
-                '<strong>{}</strong>',
-                str(issuer)
-            )
-        return '-'
-    issuer_display.short_description = '–í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å'
-    
-    def recipient_display(self, obj):
-        """–ü–æ–ª—É—á–∞—Ç–µ–ª—å"""
-        recipient = obj.recipient
-        if recipient:
-            return format_html(
-                '<strong>{}</strong>',
-                str(recipient)
-            )
-        return '-'
-    recipient_display.short_description = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å'
-    
-    def total_display(self, obj):
-        """–ò—Ç–æ–≥–æ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
-        amount = f"{obj.total:.2f}"
-        return format_html(
-            '<span style="font-weight: bold; font-size: 1.1em;">{}</span>',
-            amount
-        )
-    total_display.short_description = '–ò—Ç–æ–≥–æ'
-    total_display.admin_order_field = 'total'
-    
-    def paid_amount_display(self, obj):
-        """–û–ø–ª–∞—á–µ–Ω–æ"""
-        if obj.paid_amount > 0:
-            color = '#28a745' if obj.paid_amount >= obj.total else '#ffc107'
-            amount = f"{obj.paid_amount:.2f}"
-            return format_html(
-                '<span style="color: {}; font-weight: bold;">{}</span>',
-                color,
-                amount
-            )
-        return format_html('<span style="color: #999;">0.00</span>')
-    paid_amount_display.short_description = '–û–ø–ª–∞—á–µ–Ω–æ'
-    paid_amount_display.admin_order_field = 'paid_amount'
-    
-    def remaining_display(self, obj):
-        """–û—Å—Ç–∞—Ç–æ–∫"""
-        remaining = obj.remaining_amount
-        if remaining > 0:
-            amount = f"{remaining:.2f}"
-            return format_html(
-                '<span style="color: #dc3545; font-weight: bold;">{}</span>',
-                amount
-            )
-        return format_html('<span style="color: #28a745;">‚úì</span>')
-    remaining_display.short_description = '–û—Å—Ç–∞—Ç–æ–∫'
-    
-    def status_display(self, obj):
-        """–°—Ç–∞—Ç—É—Å —Å —Ü–≤–µ—Ç–æ–º"""
-        colors = {
-            'DRAFT': '#6c757d',
-            'ISSUED': '#007bff',
-            'PARTIALLY_PAID': '#ffc107',
-            'PAID': '#28a745',
-            'OVERDUE': '#dc3545',
-            'CANCELLED': '#6c757d',
-        }
-        color = colors.get(obj.status, '#6c757d')
-        
-        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö
-        icon = ''
-        if obj.is_overdue:
-            icon = '‚ö† '
-        
-        return format_html(
-            '<span style="background-color: {}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">{}{}</span>',
-            color,
-            icon,
-            obj.get_status_display()
-        )
-    status_display.short_description = '–°—Ç–∞—Ç—É—Å'
-    status_display.admin_order_field = 'status'
-    
-    def actions_display(self, obj):
-        """–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è"""
-        if obj.status in ['ISSUED', 'PARTIALLY_PAID', 'OVERDUE']:
-            pay_url = reverse('admin:pay_invoice', args=[obj.pk])
-            return format_html(
-                '<a href="{}" class="button" style="background: #28a745; color: white; padding: 3px 10px; border-radius: 3px; text-decoration: none;">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</a>',
-                pay_url
-            )
-        elif obj.status == 'PAID':
-            return format_html('<span style="color: #28a745;">‚úì –û–ø–ª–∞—á–µ–Ω</span>')
-        return '-'
-    actions_display.short_description = '–î–µ–π—Å—Ç–≤–∏—è'
-    
-    # ========================================================================
-    # –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï READONLY –ü–û–õ–Ø
-    # ========================================================================
-    
-    def remaining_amount_display(self, obj):
-        """–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ"""
-        remaining = obj.remaining_amount
-        if remaining > 0:
-            amount = f"{remaining:.2f}"
-            return format_html(
-                '<span style="font-size: 1.2em; color: #dc3545; font-weight: bold;">{}</span>',
-                amount
-            )
-        return format_html('<span style="color: #28a745; font-size: 1.2em;">‚úì –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω</span>')
-    remaining_amount_display.short_description = '–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ'
-    
-    def status_info_display(self, obj):
-        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ"""
-        info = []
-        
-        if obj.is_overdue:
-            days_overdue = abs(obj.days_until_due)
-            info.append(format_html(
-                '<div style="background: #fff3cd; border-left: 4px solid #dc3545; padding: 10px; margin: 5px 0;">'
-                '<strong>‚ö† –ü–†–û–°–†–û–ß–ï–ù</strong><br>'
-                '–ü—Ä–æ—Å—Ä–æ—á–∫–∞: {} –¥–Ω.'
-                '</div>',
-                days_overdue
-            ))
-        elif obj.days_until_due <= 3 and obj.status not in ['PAID', 'CANCELLED']:
-            info.append(format_html(
-                '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 5px 0;">'
-                '<strong>‚ö† –°–†–û–ß–ù–û</strong><br>'
-                '–î–æ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã: {} –¥–Ω.'
-                '</div>',
-                obj.days_until_due
-            ))
-        
-        if obj.paid_amount > obj.total:
-            overpayment = obj.paid_amount - obj.total
-            overpayment_str = f"{overpayment:.2f}"
-            info.append(format_html(
-                '<div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 10px; margin: 5px 0;">'
-                '<strong>‚Ñπ –ü–ï–†–ï–ü–õ–ê–¢–ê</strong><br>'
-                '–ü–µ—Ä–µ–ø–ª–∞—á–µ–Ω–æ: {}'
-                '</div>',
-                overpayment_str
-            ))
-        
-        return format_html(''.join(info)) if info else '–ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π'
-    status_info_display.short_description = '–°—Ç–∞—Ç—É—Å –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è'
-    
-    def payment_history_display(self, obj):
-        """–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π"""
-        transactions = obj.transactions.all().order_by('-date')
-        
-        if not transactions:
-            return format_html('<p style="color: #999;">–ü–ª–∞—Ç–µ–∂–µ–π –µ—â–µ –Ω–µ –±—ã–ª–æ</p>')
-        
-        html = '<table style="width: 100%; border-collapse: collapse;">'
-        html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">–î–∞—Ç–∞</th><th style="padding: 8px; text-align: left;">–ù–æ–º–µ—Ä</th><th style="padding: 8px; text-align: left;">–¢–∏–ø</th><th style="padding: 8px; text-align: left;">–°–ø–æ—Å–æ–±</th><th style="padding: 8px; text-align: right;">–°—É–º–º–∞</th></tr>'
-        
-        for trx in transactions:
-            color = '#28a745' if trx.type == 'PAYMENT' else '#dc3545'
-            trx_amount = f"{trx.amount:.2f}"
-            html += f'''
-            <tr style="border-bottom: 1px solid #ddd;">
-                <td style="padding: 8px;">{trx.date.strftime("%d.%m.%Y %H:%M")}</td>
-                <td style="padding: 8px;">{trx.number}</td>
-                <td style="padding: 8px;">{trx.get_type_display()}</td>
-                <td style="padding: 8px;">{trx.get_method_display()}</td>
-                <td style="padding: 8px; text-align: right; color: {color}; font-weight: bold;">{trx_amount}</td>
-            </tr>
-            '''
-        
-        html += '</table>'
-        return format_html(html)
-    payment_history_display.short_description = '–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π'
-    
-    # ========================================================================
-    # –î–ï–ô–°–¢–í–ò–Ø
-    # ========================================================================
-    
-    def mark_as_paid(self, request, queryset):
-        """–ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ"""
-        updated = 0
-        for invoice in queryset:
-            if invoice.status != 'PAID':
-                invoice.paid_amount = invoice.total
-                invoice.status = 'PAID'
-                invoice.save()
-                updated += 1
-        
-        self.message_user(request, f'–ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ: {updated} –∏–Ω–≤–æ–π—Å–æ–≤', messages.SUCCESS)
-    mark_as_paid.short_description = "‚úì –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ"
-    
-    def cancel_invoices(self, request, queryset):
-        """–û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω–≤–æ–π—Å—ã"""
-        cancelled = 0
-        errors = 0
-        
-        for invoice in queryset:
-            try:
-                BillingService.cancel_invoice(invoice, reason="–ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É")
-                cancelled += 1
-            except ValueError as e:
-                errors += 1
-        
-        if cancelled > 0:
-            self.message_user(request, f'–û—Ç–º–µ–Ω–µ–Ω–æ: {cancelled} –∏–Ω–≤–æ–π—Å–æ–≤', messages.SUCCESS)
-        if errors > 0:
-            self.message_user(request, f'–û—à–∏–±–æ–∫: {errors} –∏–Ω–≤–æ–π—Å–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –±—ã–ª–∏ –ø–ª–∞—Ç–µ–∂–∏)', messages.WARNING)
-    cancel_invoices.short_description = "‚úó –û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω–≤–æ–π—Å—ã"
-    
-    def export_to_pdf(self, request, queryset):
-        """–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (–∑–∞–≥–ª—É—à–∫–∞)"""
-        self.message_user(request, '–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', messages.INFO)
-    export_to_pdf.short_description = "üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"
-    
-    def regenerate_items(self, request, queryset):
-        """–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
-        count = 0
-        for invoice in queryset:
-            if invoice.cars.exists():
-                invoice.regenerate_items_from_cars()
-                count += 1
-        
-        if count > 0:
-            self.message_user(request, f'‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã –¥–ª—è {count} –∏–Ω–≤–æ–π—Å–æ–≤', messages.SUCCESS)
-        else:
-            self.message_user(request, '‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≤–æ–π—Å—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏', messages.WARNING)
-    regenerate_items.short_description = "üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
-    
-    # ========================================================================
-    # –ö–ê–°–¢–û–ú–ù–´–ï –£–†–õ–´
-    # ========================================================================
-    
-    def get_urls(self):
-        urls = super().get_urls()
-        custom_urls = [
-            path('<int:invoice_id>/pay/', self.admin_site.admin_view(self.pay_invoice_view), name='pay_invoice'),
-        ]
-        return custom_urls + urls
-    
-    def pay_invoice_view(self, request, invoice_id):
-        """–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã –∏–Ω–≤–æ–π—Å–∞"""
-        invoice = NewInvoice.objects.get(pk=invoice_id)
-        
-        if request.method == 'POST':
-            try:
-                amount = Decimal(request.POST.get('amount', 0))
-                method = request.POST.get('method', 'CASH')
-                description = request.POST.get('description', '')
-                
-                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞
-                payer = invoice.recipient
-                
-                result = BillingService.pay_invoice(
-                    invoice=invoice,
-                    amount=amount,
-                    method=method,
-                    payer=payer,
-                    description=description,
-                    created_by=request.user
-                )
-                
-                messages.success(request, f'–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {result["transaction"].number}')
-                
-                if result['overpayment'] > 0:
-                    messages.warning(request, f'–í–Ω–∏–º–∞–Ω–∏–µ: –ø–µ—Ä–µ–ø–ª–∞—Ç–∞ {result["overpayment"]:.2f}')
-                
-                return redirect('admin:core_newinvoice_change', invoice_id)
-                
-            except Exception as e:
-                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞: {str(e)}')
-        
-        # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
-        client_balance = None
-        if invoice.recipient_client:
-            client_balance = invoice.recipient_client.balance
-        
-        context = {
-            'invoice': invoice,
-            'remaining': invoice.remaining_amount,
-            'client_balance': client_balance,
-            'opts': self.model._meta,
-            'has_view_permission': self.has_view_permission(request),
-        }
-        
-        return render(request, 'admin/invoice_pay.html', context)
-
-
-# ============================================================================
-# –ê–î–ú–ò–ù–ö–ê –î–õ–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
-# ============================================================================
-
-@admin.register(Transaction)
-class TransactionAdmin(admin.ModelAdmin):
-    """
-    –ü—Ä–æ—Å—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
-    """
-    
-    list_display = (
-        'number_display',
-        'date',
-        'type_display',
-        'method_display',
-        'sender_display',
-        'recipient_display',
-        'amount_display',
-        'status_display',
-        'invoice_link',
-    )
-    
-    list_filter = (
-        'type',
-        'method',
-        'status',
-        'date',
-    )
-    
-    search_fields = (
-        'number',
-        'description',
-        'invoice__number',
-    )
-    
-    readonly_fields = (
-        'number',
-        'date',
-        'created_at',
-        'created_by',
-        'sender_info_display',
-        'recipient_info_display',
-    )
-    
-    fieldsets = (
-        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
-            'fields': (
-                'number',
-                'date',
-                'type',
-                'method',
-                'status',
-            )
-        }),
-        ('–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å', {
-            'fields': (
-                ('from_client', 'from_warehouse'),
-                ('from_line', 'from_carrier', 'from_company'),
-                'sender_info_display',
-            )
-        }),
-        ('–ü–æ–ª—É—á–∞—Ç–µ–ª—å', {
-            'fields': (
-                ('to_client', 'to_warehouse'),
-                ('to_line', 'to_carrier', 'to_company'),
-                'recipient_info_display',
-            )
-        }),
-        ('–î–µ—Ç–∞–ª–∏', {
-            'fields': (
-                'amount',
-                'invoice',
-                'description',
-            )
-        }),
-        ('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ', {
-            'fields': (
-                'created_at',
-                'created_by',
-            ),
-            'classes': ('collapse',),
-        }),
-    )
-    
-    # ========================================================================
-    # –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–û–õ–ï–ô
-    # ========================================================================
-    
-    def number_display(self, obj):
-        """–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"""
-        return format_html('<strong>{}</strong>', obj.number)
-    number_display.short_description = '–ù–æ–º–µ—Ä'
-    number_display.admin_order_field = 'number'
-    
-    def type_display(self, obj):
-        """–¢–∏–ø —Å –∏–∫–æ–Ω–∫–æ–π"""
-        icons = {
-            'PAYMENT': 'üí≥',
-            'REFUND': '‚Ü©',
-            'ADJUSTMENT': '‚öô',
-            'TRANSFER': '‚Üî',
-            'BALANCE_TOPUP': 'üí∞',
-        }
-        icon = icons.get(obj.type, '')
-        return format_html('{} {}', icon, obj.get_type_display())
-    type_display.short_description = '–¢–∏–ø'
-    type_display.admin_order_field = 'type'
-    
-    def method_display(self, obj):
-        """–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã"""
-        return obj.get_method_display()
-    method_display.short_description = '–°–ø–æ—Å–æ–±'
-    method_display.admin_order_field = 'method'
-    
-    def sender_display(self, obj):
-        """–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å"""
-        sender = obj.sender
-        if sender:
-            return format_html(
-                '<strong>{}</strong>',
-                str(sender)
-            )
-        return '-'
-    sender_display.short_description = '–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å'
-    
-    def recipient_display(self, obj):
-        """–ü–æ–ª—É—á–∞—Ç–µ–ª—å"""
-        recipient = obj.recipient
-        if recipient:
-            return format_html(
-                '<strong>{}</strong>',
-                str(recipient)
-            )
-        return '-'
-    recipient_display.short_description = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å'
-    
-    def amount_display(self, obj):
-        """–°—É–º–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
-        color = '#28a745' if obj.type == 'PAYMENT' else '#dc3545' if obj.type == 'REFUND' else '#007bff'
-        amount = f"{obj.amount:.2f}"
-        return format_html(
-            '<span style="color: {}; font-weight: bold; font-size: 1.1em;">{}</span>',
-            color,
-            amount
-        )
-    amount_display.short_description = '–°—É–º–º–∞'
-    amount_display.admin_order_field = 'amount'
-    
-    def status_display(self, obj):
-        """–°—Ç–∞—Ç—É—Å"""
-        colors = {
-            'PENDING': '#ffc107',
-            'COMPLETED': '#28a745',
-            'FAILED': '#dc3545',
-            'CANCELLED': '#6c757d',
-        }
-        color = colors.get(obj.status, '#6c757d')
-        return format_html(
-            '<span style="background-color: {}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">{}</span>',
-            color,
-            obj.get_status_display()
-        )
-    status_display.short_description = '–°—Ç–∞—Ç—É—Å'
-    status_display.admin_order_field = 'status'
-    
-    def invoice_link(self, obj):
-        """–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å"""
-        if obj.invoice:
-            url = reverse('admin:core_newinvoice_change', args=[obj.invoice.pk])
-            return format_html('<a href="{}">{}</a>', url, obj.invoice.number)
-        return '-'
-    invoice_link.short_description = '–ò–Ω–≤–æ–π—Å'
-    
-    def sender_info_display(self, obj):
-        """–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ"""
-        sender = obj.sender
-        if not sender:
-            return '–ù–µ —É–∫–∞–∑–∞–Ω'
-        
-        info = f'<strong>{sender}</strong><br>'
-        info += f'–¢–∏–ø: {sender.__class__.__name__}<br>'
-        
-        if hasattr(sender, 'balance'):
-            balance_str = f"{sender.balance:.2f}"
-            info += f'–ë–∞–ª–∞–Ω—Å: {balance_str}'
-        
-        return format_html(info)
-    sender_info_display.short_description = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ'
-    
-    def recipient_info_display(self, obj):
-        """–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ"""
-        recipient = obj.recipient
-        if not recipient:
-            return '–ù–µ —É–∫–∞–∑–∞–Ω'
-        
-        info = f'<strong>{recipient}</strong><br>'
-        info += f'–¢–∏–ø: {recipient.__class__.__name__}<br>'
-        
-        if hasattr(recipient, 'balance'):
-            balance_str = f"{recipient.balance:.2f}"
-            info += f'–ë–∞–ª–∞–Ω—Å: {balance_str}'
-        
-        return format_html(info)
-    recipient_info_display.short_description = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ'
-
-
-# ============================================================================
-# InvoiceItem –ù–ï —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ - —Ç–æ–ª—å–∫–æ inline –≤ NewInvoice
-# ============================================================================
-# –ü–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —É—Å–ª—É–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (CarService)
+"""
+–ê–¥–º–∏–Ω–∫–∞ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∏–Ω–≤–æ–π—Å–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å–æ–≤
+=========================================================
+
+–ü—Ä–æ—Å—Ç–æ–π –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å:
+- –ò–Ω–≤–æ–π—Å–∞–º–∏
+- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
+- –ë–∞–ª–∞–Ω—Å–∞–º–∏
+
+–ê–≤—Ç–æ—Ä—ã: AI Assistant
+–î–∞—Ç–∞: 30 —Å–µ–Ω—Ç—è–±—Ä—è 2025
+"""
+
+from django.contrib import admin
+from django.utils.html import format_html
+from django.urls import reverse, path
+from django.shortcuts import render, redirect
+from django.contrib import messages
+from django.db.models import Sum, Q
+from django.utils import timezone
+from decimal import Decimal
+
+from .models_billing import NewInvoice, InvoiceItem, Transaction
+from .services.billing_service import BillingService
+
+
+# ============================================================================
+# INLINE –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –∏–Ω–≤–æ–π—Å–∞
+# ============================================================================
+
+class InvoiceItemInline(admin.TabularInline):
+    """Inline –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –∏–Ω–≤–æ–π—Å–∞"""
+    
+    model = InvoiceItem
+    extra = 3  # 3 –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
+    fields = ('description', 'car', 'quantity', 'unit_price', 'total_price')
+    readonly_fields = ('total_price',)
+    autocomplete_fields = ['car']
+    
+    verbose_name = "–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞"
+    verbose_name_plural = "üì¶ –ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ)"
+    
+    def get_formset(self, request, obj=None, **kwargs):
+        formset = super().get_formset(request, obj, **kwargs)
+        # –£–±–∏—Ä–∞–µ–º help_text –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
+        for field in formset.form.base_fields.values():
+            field.help_text = ''
+        return formset
+
+
+# ============================================================================
+# –ê–î–ú–ò–ù–ö–ê –î–õ–Ø –ò–ù–í–û–ô–°–û–í
+# ============================================================================
+
+@admin.register(NewInvoice)
+class NewInvoiceAdmin(admin.ModelAdmin):
+    """
+    –ü—Ä–æ—Å—Ç–∞—è –∏ –ø–æ–Ω—è—Ç–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
+    """
+    
+    change_form_template = 'admin/core/newinvoice/change_form.html'
+    
+    class Media:
+        css = {
+            'all': ('admin/css/widgets.css',)
+        }
+        js = ('admin/js/SelectBox.js', 'admin/js/SelectFilter2.js',)
+    
+    list_display = (
+        'number_display',
+        'notes_display',
+        'recipient_display',
+        'total_display',
+        'paid_amount_display',
+        'remaining_display',
+        'status_display',
+        'actions_display'
+    )
+    
+    list_filter = (
+        'status',
+        'date',
+        'recipient_client',
+    )
+    
+    search_fields = (
+        'number',
+        'recipient_client__name',
+        'notes',
+    )
+    
+    readonly_fields = (
+        'number',
+        'subtotal',
+        'total',
+        'paid_amount',
+        'created_at',
+        'updated_at',
+        'created_by',
+    )
+    
+    fieldsets = (
+        ('üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': (
+                ('date', 'due_date', 'status'),
+            )
+        }),
+        ('üè¢ –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∏–Ω–≤–æ–π—Å–∞', {
+            'fields': ('issuer_company',),
+            'description': '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: Caromoto Lithuania'
+        }),
+        ('üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –∏–Ω–≤–æ–π—Å–∞', {
+            'fields': ('recipient_client',),
+        }),
+        ('üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏', {
+            'fields': ('cars',),
+            'description': '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥'
+        }),
+        ('üí∞ –§–∏–Ω–∞–Ω—Å—ã', {
+            'fields': (
+                ('subtotal', 'discount', 'tax'),
+                ('total', 'paid_amount'),
+            ),
+            'classes': ('collapse',),
+        }),
+        ('üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ', {
+            'fields': ('notes',),
+            'classes': ('collapse',),
+        }),
+        ('‚öôÔ∏è –ü—Ä–æ—á–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –∫–ª–∏–µ–Ω—Ç)', {
+            'fields': (
+                ('recipient_warehouse', 'recipient_line'),
+                ('recipient_carrier', 'recipient_company'),
+            ),
+            'classes': ('collapse',),
+        }),
+        ('‚öôÔ∏è –ü—Ä–æ—á–∏–µ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –∫–æ–º–ø–∞–Ω–∏—è)', {
+            'fields': (
+                ('issuer_warehouse', 'issuer_line', 'issuer_carrier'),
+            ),
+            'classes': ('collapse',),
+        }),
+    )
+    
+    inlines = [InvoiceItemInline]
+    
+    filter_horizontal = ('cars',)
+    
+    actions = ['mark_as_paid', 'cancel_invoices', 'regenerate_items']
+    
+    def add_view(self, request, form_url='', extra_context=None):
+        """–ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞"""
+        from core.models import Company, Client, Car
+        
+        if request.method == 'POST':
+            return self._handle_custom_form(request, None)
+        
+        extra_context = self._get_extra_context(None, extra_context)
+        return super().add_view(request, form_url, extra_context)
+    
+    def change_view(self, request, object_id, form_url='', extra_context=None):
+        """–ö–∞—Å—Ç–æ–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞"""
+        if request.method == 'POST':
+            return self._handle_custom_form(request, object_id)
+        
+        extra_context = self._get_extra_context(object_id, extra_context)
+        return super().change_view(request, object_id, form_url, extra_context)
+    
+    def _get_extra_context(self, object_id, extra_context=None):
+        """–ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–±–ª–æ–Ω–∞"""
+        from core.models import Company, Client, Car
+        
+        extra_context = extra_context or {}
+        
+        # –ü–æ–ª—É—á–∞–µ–º queryset –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
+        extra_context['companies'] = Company.objects.all().order_by('name')
+        extra_context['clients'] = Client.objects.all().order_by('name')
+        extra_context['cars'] = Car.objects.all().select_related('client').order_by('-id')[:500]
+        
+        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º Caromoto Lithuania –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+        try:
+            caromoto = Company.objects.get(name="Caromoto Lithuania")
+            extra_context['default_company_id'] = caromoto.pk
+        except Company.DoesNotExist:
+            extra_context['default_company_id'] = None
+        
+        # –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–∞—à–∏–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
+        selected_car_ids = []
+        if object_id:
+            try:
+                invoice = NewInvoice.objects.get(pk=object_id)
+                selected_car_ids = list(invoice.cars.values_list('pk', flat=True))
+            except NewInvoice.DoesNotExist:
+                pass
+        extra_context['selected_car_ids'] = selected_car_ids
+        
+        return extra_context
+    
+    def _handle_custom_form(self, request, object_id):
+        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Ñ–æ—Ä–º—É"""
+        from core.models import Company, Client, Car
+        from django.utils import timezone
+        from datetime import datetime
+        
+        try:
+            # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
+            if object_id:
+                invoice = NewInvoice.objects.get(pk=object_id)
+            else:
+                invoice = NewInvoice()
+            
+            # –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ POST
+            date_str = request.POST.get('date')
+            if date_str:
+                invoice.date = datetime.strptime(date_str, '%Y-%m-%d').date()
+            
+            due_date_str = request.POST.get('due_date')
+            if due_date_str:
+                invoice.due_date = datetime.strptime(due_date_str, '%Y-%m-%d').date()
+            else:
+                invoice.due_date = None
+            
+            invoice.status = request.POST.get('status', 'ISSUED')
+            invoice.notes = request.POST.get('notes', '')
+            
+            # –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤—ã—Ö
+            invoice.issuer_company = None
+            invoice.issuer_warehouse = None
+            invoice.issuer_line = None
+            invoice.issuer_carrier = None
+            invoice.recipient_client = None
+            invoice.recipient_company = None
+            invoice.recipient_warehouse = None
+            invoice.recipient_line = None
+            invoice.recipient_carrier = None
+            
+            # –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–ø–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç "type_id", –Ω–∞–ø—Ä–∏–º–µ—Ä "company_123")
+            issuer_value = request.POST.get('issuer', '')
+            if issuer_value and '_' in issuer_value:
+                issuer_type, issuer_id = issuer_value.rsplit('_', 1)
+                if issuer_type == 'company':
+                    invoice.issuer_company = Company.objects.get(pk=issuer_id)
+                elif issuer_type == 'warehouse':
+                    from core.models import Warehouse
+                    invoice.issuer_warehouse = Warehouse.objects.get(pk=issuer_id)
+                elif issuer_type == 'line':
+                    from core.models import Line
+                    invoice.issuer_line = Line.objects.get(pk=issuer_id)
+                elif issuer_type == 'carrier':
+                    from core.models import Carrier
+                    invoice.issuer_carrier = Carrier.objects.get(pk=issuer_id)
+            else:
+                # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Caromoto Lithuania
+                try:
+                    invoice.issuer_company = Company.objects.get(name="Caromoto Lithuania")
+                except Company.DoesNotExist:
+                    pass
+            
+            # –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–ø–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç "type_id", –Ω–∞–ø—Ä–∏–º–µ—Ä "client_456")
+            recipient_value = request.POST.get('recipient', '')
+            if recipient_value and '_' in recipient_value:
+                recipient_type, recipient_id = recipient_value.rsplit('_', 1)
+                if recipient_type == 'client':
+                    invoice.recipient_client = Client.objects.get(pk=recipient_id)
+                elif recipient_type == 'company':
+                    invoice.recipient_company = Company.objects.get(pk=recipient_id)
+                elif recipient_type == 'warehouse':
+                    from core.models import Warehouse
+                    invoice.recipient_warehouse = Warehouse.objects.get(pk=recipient_id)
+                elif recipient_type == 'line':
+                    from core.models import Line
+                    invoice.recipient_line = Line.objects.get(pk=recipient_id)
+                elif recipient_type == 'carrier':
+                    from core.models import Carrier
+                    invoice.recipient_carrier = Carrier.objects.get(pk=recipient_id)
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–≤–æ–π—Å
+            invoice.save()
+            
+            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ (ManyToMany)
+            car_ids = request.POST.getlist('cars')
+            if car_ids:
+                cars = Car.objects.filter(pk__in=car_ids)
+                invoice.cars.set(cars)
+                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —É—Å–ª—É–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
+                invoice.regenerate_items_from_cars()
+                messages.success(request, f'‚úÖ –ò–Ω–≤–æ–π—Å {invoice.number} —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –°–æ–∑–¥–∞–Ω–æ {invoice.items.count()} –ø–æ–∑–∏—Ü–∏–π.')
+            else:
+                invoice.cars.clear()
+                messages.success(request, f'‚úÖ –ò–Ω–≤–æ–π—Å {invoice.number} —Å–æ—Ö—Ä–∞–Ω–µ–Ω!')
+            
+            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É–¥–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å
+            if '_save' in request.POST:
+                return redirect('admin:core_newinvoice_changelist')
+            elif '_continue' in request.POST:
+                return redirect('admin:core_newinvoice_change', invoice.pk)
+            elif '_addanother' in request.POST:
+                return redirect('admin:core_newinvoice_add')
+            else:
+                return redirect('admin:core_newinvoice_changelist')
+                
+        except Exception as e:
+            messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞: {str(e)}')
+            import traceback
+            traceback.print_exc()
+            
+            if object_id:
+                return redirect('admin:core_newinvoice_change', object_id)
+            else:
+                return redirect('admin:core_newinvoice_add')
+    
+    def save_model(self, request, obj, form, change):
+        """–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–≤–æ–π—Å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
+        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+        if not obj.issuer_company and not obj.issuer_warehouse and not obj.issuer_line and not obj.issuer_carrier:
+            try:
+                from core.models import Company
+                caromoto = Company.objects.get(name="Caromoto Lithuania")
+                obj.issuer_company = caromoto
+                import logging
+                logger = logging.getLogger(__name__)
+                logger.info(f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∏–Ω–≤–æ–π—Å–∞ {obj.number}")
+            except Company.DoesNotExist:
+                import logging
+                logger = logging.getLogger(__name__)
+                logger.warning("–ö–æ–º–ø–∞–Ω–∏—è Caromoto Lithuania –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
+        
+        # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç
+        super().save_model(request, obj, form, change)
+        
+        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑—å cars (ManyToMany —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ save_related)
+    
+    def save_related(self, request, form, formsets, change):
+        """–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ManyToMany —Å–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
+        # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–≤—è–∑–∏
+        super().save_related(request, form, formsets, change)
+        
+        # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏
+        if form.instance.cars.exists():
+            form.instance.regenerate_items_from_cars()
+            messages.success(request, f"‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ {form.instance.items.count()} –ø–æ–∑–∏—Ü–∏–π –∏–∑ —É—Å–ª—É–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π!")
+    
+    actions = ['mark_as_paid', 'cancel_invoices', 'export_to_pdf', 'regenerate_items']
+    
+    # ========================================================================
+    # –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–û–õ–ï–ô –í –°–ü–ò–°–ö–ï
+    # ========================================================================
+    
+    def number_display(self, obj):
+        """–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ —Å —Å—Å—ã–ª–∫–æ–π"""
+        url = reverse('admin:core_newinvoice_change', args=[obj.pk])
+        return format_html('<a href="{}" style="font-weight: bold;">{}</a>', url, obj.number)
+    number_display.short_description = '–ù–æ–º–µ—Ä'
+    number_display.admin_order_field = 'number'
+    
+    def notes_display(self, obj):
+        """–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞"""
+        if obj.notes:
+            # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤
+            notes_text = obj.notes[:50] + '...' if len(obj.notes) > 50 else obj.notes
+            return format_html('<span title="{}">{}</span>', obj.notes, notes_text)
+        return format_html('<span style="color: #999;">‚Äî</span>')
+    notes_display.short_description = '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è'
+    notes_display.admin_order_field = 'notes'
+    
+    def issuer_display(self, obj):
+        """–í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"""
+        issuer = obj.issuer
+        if issuer:
+            return format_html(
+                '<strong>{}</strong>',
+                str(issuer)
+            )
+        return '-'
+    issuer_display.short_description = '–í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å'
+    
+    def recipient_display(self, obj):
+        """–ü–æ–ª—É—á–∞—Ç–µ–ª—å"""
+        recipient = obj.recipient
+        if recipient:
+            return format_html(
+                '<strong>{}</strong>',
+                str(recipient)
+            )
+        return '-'
+    recipient_display.short_description = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å'
+    
+    def total_display(self, obj):
+        """–ò—Ç–æ–≥–æ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
+        amount = f"{obj.total:.2f}"
+        return format_html(
+            '<span style="font-weight: bold; font-size: 1.1em;">{}</span>',
+            amount
+        )
+    total_display.short_description = '–ò—Ç–æ–≥–æ'
+    total_display.admin_order_field = 'total'
+    
+    def paid_amount_display(self, obj):
+        """–û–ø–ª–∞—á–µ–Ω–æ"""
+        if obj.paid_amount > 0:
+            color = '#28a745' if obj.paid_amount >= obj.total else '#ffc107'
+            amount = f"{obj.paid_amount:.2f}"
+            return format_html(
+                '<span style="color: {}; font-weight: bold;">{}</span>',
+                color,
+                amount
+            )
+        return format_html('<span style="color: #999;">0.00</span>')
+    paid_amount_display.short_description = '–û–ø–ª–∞—á–µ–Ω–æ'
+    paid_amount_display.admin_order_field = 'paid_amount'
+    
+    def remaining_display(self, obj):
+        """–û—Å—Ç–∞—Ç–æ–∫"""
+        remaining = obj.remaining_amount
+        if remaining > 0:
+            amount = f"{remaining:.2f}"
+            return format_html(
+                '<span style="color: #dc3545; font-weight: bold;">{}</span>',
+                amount
+            )
+        return format_html('<span style="color: #28a745;">‚úì</span>')
+    remaining_display.short_description = '–û—Å—Ç–∞—Ç–æ–∫'
+    
+    def status_display(self, obj):
+        """–°—Ç–∞—Ç—É—Å —Å —Ü–≤–µ—Ç–æ–º"""
+        colors = {
+            'DRAFT': '#6c757d',
+            'ISSUED': '#007bff',
+            'PARTIALLY_PAID': '#ffc107',
+            'PAID': '#28a745',
+            'OVERDUE': '#dc3545',
+            'CANCELLED': '#6c757d',
+        }
+        color = colors.get(obj.status, '#6c757d')
+        
+        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö
+        icon = ''
+        if obj.is_overdue:
+            icon = '‚ö† '
+        
+        return format_html(
+            '<span style="background-color: {}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">{}{}</span>',
+            color,
+            icon,
+            obj.get_status_display()
+        )
+    status_display.short_description = '–°—Ç–∞—Ç—É—Å'
+    status_display.admin_order_field = 'status'
+    
+    def actions_display(self, obj):
+        """–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è"""
+        if obj.status in ['ISSUED', 'PARTIALLY_PAID', 'OVERDUE']:
+            pay_url = reverse('admin:pay_invoice', args=[obj.pk])
+            return format_html(
+                '<a href="{}" class="button" style="background: #28a745; color: white; padding: 3px 10px; border-radius: 3px; text-decoration: none;">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</a>',
+                pay_url
+            )
+        elif obj.status == 'PAID':
+            return format_html('<span style="color: #28a745;">‚úì –û–ø–ª–∞—á–µ–Ω</span>')
+        return '-'
+    actions_display.short_description = '–î–µ–π—Å—Ç–≤–∏—è'
+    
+    # ========================================================================
+    # –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï READONLY –ü–û–õ–Ø
+    # ========================================================================
+    
+    def remaining_amount_display(self, obj):
+        """–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ"""
+        remaining = obj.remaining_amount
+        if remaining > 0:
+            amount = f"{remaining:.2f}"
+            return format_html(
+                '<span style="font-size: 1.2em; color: #dc3545; font-weight: bold;">{}</span>',
+                amount
+            )
+        return format_html('<span style="color: #28a745; font-size: 1.2em;">‚úì –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω</span>')
+    remaining_amount_display.short_description = '–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ'
+    
+    def status_info_display(self, obj):
+        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ"""
+        info = []
+        
+        if obj.is_overdue:
+            days_overdue = abs(obj.days_until_due)
+            info.append(format_html(
+                '<div style="background: #fff3cd; border-left: 4px solid #dc3545; padding: 10px; margin: 5px 0;">'
+                '<strong>‚ö† –ü–†–û–°–†–û–ß–ï–ù</strong><br>'
+                '–ü—Ä–æ—Å—Ä–æ—á–∫–∞: {} –¥–Ω.'
+                '</div>',
+                days_overdue
+            ))
+        elif obj.days_until_due <= 3 and obj.status not in ['PAID', 'CANCELLED']:
+            info.append(format_html(
+                '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 5px 0;">'
+                '<strong>‚ö† –°–†–û–ß–ù–û</strong><br>'
+                '–î–æ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã: {} –¥–Ω.'
+                '</div>',
+                obj.days_until_due
+            ))
+        
+        if obj.paid_amount > obj.total:
+            overpayment = obj.paid_amount - obj.total
+            overpayment_str = f"{overpayment:.2f}"
+            info.append(format_html(
+                '<div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 10px; margin: 5px 0;">'
+                '<strong>‚Ñπ –ü–ï–†–ï–ü–õ–ê–¢–ê</strong><br>'
+                '–ü–µ—Ä–µ–ø–ª–∞—á–µ–Ω–æ: {}'
+                '</div>',
+                overpayment_str
+            ))
+        
+        return format_html(''.join(info)) if info else '–ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π'
+    status_info_display.short_description = '–°—Ç–∞—Ç—É—Å –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è'
+    
+    def payment_history_display(self, obj):
+        """–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π"""
+        transactions = obj.transactions.all().order_by('-date')
+        
+        if not transactions:
+            return format_html('<p style="color: #999;">–ü–ª–∞—Ç–µ–∂–µ–π –µ—â–µ –Ω–µ –±—ã–ª–æ</p>')
+        
+        html = '<table style="width: 100%; border-collapse: collapse;">'
+        html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">–î–∞—Ç–∞</th><th style="padding: 8px; text-align: left;">–ù–æ–º–µ—Ä</th><th style="padding: 8px; text-align: left;">–¢–∏–ø</th><th style="padding: 8px; text-align: left;">–°–ø–æ—Å–æ–±</th><th style="padding: 8px; text-align: right;">–°—É–º–º–∞</th></tr>'
+        
+        for trx in transactions:
+            color = '#28a745' if trx.type == 'PAYMENT' else '#dc3545'
+            trx_amount = f"{trx.amount:.2f}"
+            html += f'''
+            <tr style="border-bottom: 1px solid #ddd;">
+                <td style="padding: 8px;">{trx.date.strftime("%d.%m.%Y %H:%M")}</td>
+                <td style="padding: 8px;">{trx.number}</td>
+                <td style="padding: 8px;">{trx.get_type_display()}</td>
+                <td style="padding: 8px;">{trx.get_method_display()}</td>
+                <td style="padding: 8px; text-align: right; color: {color}; font-weight: bold;">{trx_amount}</td>
+            </tr>
+            '''
+        
+        html += '</table>'
+        return format_html(html)
+    payment_history_display.short_description = '–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π'
+    
+    # ========================================================================
+    # –î–ï–ô–°–¢–í–ò–Ø
+    # ========================================================================
+    
+    def mark_as_paid(self, request, queryset):
+        """–ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ"""
+        updated = 0
+        for invoice in queryset:
+            if invoice.status != 'PAID':
+                invoice.paid_amount = invoice.total
+                invoice.status = 'PAID'
+                invoice.save()
+                updated += 1
+        
+        self.message_user(request, f'–ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ: {updated} –∏–Ω–≤–æ–π—Å–æ–≤', messages.SUCCESS)
+    mark_as_paid.short_description = "‚úì –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ"
+    
+    def cancel_invoices(self, request, queryset):
+        """–û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω–≤–æ–π—Å—ã"""
+        cancelled = 0
+        errors = 0
+        
+        for invoice in queryset:
+            try:
+                BillingService.cancel_invoice(invoice, reason="–ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É")
+                cancelled += 1
+            except ValueError as e:
+                errors += 1
+        
+        if cancelled > 0:
+            self.message_user(request, f'–û—Ç–º–µ–Ω–µ–Ω–æ: {cancelled} –∏–Ω–≤–æ–π—Å–æ–≤', messages.SUCCESS)
+        if errors > 0:
+            self.message_user(request, f'–û—à–∏–±–æ–∫: {errors} –∏–Ω–≤–æ–π—Å–æ–≤ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –±—ã–ª–∏ –ø–ª–∞—Ç–µ–∂–∏)', messages.WARNING)
+    cancel_invoices.short_description = "‚úó –û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω–≤–æ–π—Å—ã"
+    
+    def export_to_pdf(self, request, queryset):
+        """–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (–∑–∞–≥–ª—É—à–∫–∞)"""
+        self.message_user(request, '–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', messages.INFO)
+    export_to_pdf.short_description = "üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"
+    
+    def regenerate_items(self, request, queryset):
+        """–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
+        count = 0
+        for invoice in queryset:
+            if invoice.cars.exists():
+                invoice.regenerate_items_from_cars()
+                count += 1
+        
+        if count > 0:
+            self.message_user(request, f'‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã –¥–ª—è {count} –∏–Ω–≤–æ–π—Å–æ–≤', messages.SUCCESS)
+        else:
+            self.message_user(request, '‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≤–æ–π—Å—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏', messages.WARNING)
+    regenerate_items.short_description = "üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
+    
+    # ========================================================================
+    # –ö–ê–°–¢–û–ú–ù–´–ï –£–†–õ–´
+    # ========================================================================
+    
+    def get_urls(self):
+        urls = super().get_urls()
+        custom_urls = [
+            path('<int:invoice_id>/pay/', self.admin_site.admin_view(self.pay_invoice_view), name='pay_invoice'),
+        ]
+        return custom_urls + urls
+    
+    def pay_invoice_view(self, request, invoice_id):
+        """–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã –∏–Ω–≤–æ–π—Å–∞"""
+        invoice = NewInvoice.objects.get(pk=invoice_id)
+        
+        if request.method == 'POST':
+            try:
+                amount = Decimal(request.POST.get('amount', 0))
+                method = request.POST.get('method', 'CASH')
+                description = request.POST.get('description', '')
+                
+                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞
+                payer = invoice.recipient
+                
+                result = BillingService.pay_invoice(
+                    invoice=invoice,
+                    amount=amount,
+                    method=method,
+                    payer=payer,
+                    description=description,
+                    created_by=request.user
+                )
+                
+                messages.success(request, f'–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {result["transaction"].number}')
+                
+                if result['overpayment'] > 0:
+                    messages.warning(request, f'–í–Ω–∏–º–∞–Ω–∏–µ: –ø–µ—Ä–µ–ø–ª–∞—Ç–∞ {result["overpayment"]:.2f}')
+                
+                return redirect('admin:core_newinvoice_change', invoice_id)
+                
+            except Exception as e:
+                messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞: {str(e)}')
+        
+        # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
+        client_balance = None
+        if invoice.recipient_client:
+            client_balance = invoice.recipient_client.balance
+        
+        context = {
+            'invoice': invoice,
+            'remaining': invoice.remaining_amount,
+            'client_balance': client_balance,
+            'opts': self.model._meta,
+            'has_view_permission': self.has_view_permission(request),
+        }
+        
+        return render(request, 'admin/invoice_pay.html', context)
+
+
+# ============================================================================
+# –ê–î–ú–ò–ù–ö–ê –î–õ–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
+# ============================================================================
+
+@admin.register(Transaction)
+class TransactionAdmin(admin.ModelAdmin):
+    """
+    –ü—Ä–æ—Å—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
+    """
+    
+    list_display = (
+        'number_display',
+        'date',
+        'type_display',
+        'method_display',
+        'sender_display',
+        'recipient_display',
+        'amount_display',
+        'status_display',
+        'invoice_link',
+    )
+    
+    list_filter = (
+        'type',
+        'method',
+        'status',
+        'date',
+    )
+    
+    search_fields = (
+        'number',
+        'description',
+        'invoice__number',
+    )
+    
+    readonly_fields = (
+        'number',
+        'date',
+        'created_at',
+        'created_by',
+        'sender_info_display',
+        'recipient_info_display',
+    )
+    
+    fieldsets = (
+        ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', {
+            'fields': (
+                'number',
+                'date',
+                'type',
+                'method',
+                'status',
+            )
+        }),
+        ('–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å', {
+            'fields': (
+                ('from_client', 'from_warehouse'),
+                ('from_line', 'from_carrier', 'from_company'),
+                'sender_info_display',
+            )
+        }),
+        ('–ü–æ–ª—É—á–∞—Ç–µ–ª—å', {
+            'fields': (
+                ('to_client', 'to_warehouse'),
+                ('to_line', 'to_carrier', 'to_company'),
+                'recipient_info_display',
+            )
+        }),
+        ('–î–µ—Ç–∞–ª–∏', {
+            'fields': (
+                'amount',
+                'invoice',
+                'description',
+            )
+        }),
+        ('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ', {
+            'fields': (
+                'created_at',
+                'created_by',
+            ),
+            'classes': ('collapse',),
+        }),
+    )
+    
+    # ========================================================================
+    # –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–û–õ–ï–ô
+    # ========================================================================
+    
+    def number_display(self, obj):
+        """–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"""
+        return format_html('<strong>{}</strong>', obj.number)
+    number_display.short_description = '–ù–æ–º–µ—Ä'
+    number_display.admin_order_field = 'number'
+    
+    def type_display(self, obj):
+        """–¢–∏–ø —Å –∏–∫–æ–Ω–∫–æ–π"""
+        icons = {
+            'PAYMENT': 'üí≥',
+            'REFUND': '‚Ü©',
+            'ADJUSTMENT': '‚öô',
+            'TRANSFER': '‚Üî',
+            'BALANCE_TOPUP': 'üí∞',
+        }
+        icon = icons.get(obj.type, '')
+        return format_html('{} {}', icon, obj.get_type_display())
+    type_display.short_description = '–¢–∏–ø'
+    type_display.admin_order_field = 'type'
+    
+    def method_display(self, obj):
+        """–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã"""
+        return obj.get_method_display()
+    method_display.short_description = '–°–ø–æ—Å–æ–±'
+    method_display.admin_order_field = 'method'
+    
+    def sender_display(self, obj):
+        """–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å"""
+        sender = obj.sender
+        if sender:
+            return format_html(
+                '<strong>{}</strong>',
+                str(sender)
+            )
+        return '-'
+    sender_display.short_description = '–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å'
+    
+    def recipient_display(self, obj):
+        """–ü–æ–ª—É—á–∞—Ç–µ–ª—å"""
+        recipient = obj.recipient
+        if recipient:
+            return format_html(
+                '<strong>{}</strong>',
+                str(recipient)
+            )
+        return '-'
+    recipient_display.short_description = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å'
+    
+    def amount_display(self, obj):
+        """–°—É–º–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
+        color = '#28a745' if obj.type == 'PAYMENT' else '#dc3545' if obj.type == 'REFUND' else '#007bff'
+        amount = f"{obj.amount:.2f}"
+        return format_html(
+            '<span style="color: {}; font-weight: bold; font-size: 1.1em;">{}</span>',
+            color,
+            amount
+        )
+    amount_display.short_description = '–°—É–º–º–∞'
+    amount_display.admin_order_field = 'amount'
+    
+    def status_display(self, obj):
+        """–°—Ç–∞—Ç—É—Å"""
+        colors = {
+            'PENDING': '#ffc107',
+            'COMPLETED': '#28a745',
+            'FAILED': '#dc3545',
+            'CANCELLED': '#6c757d',
+        }
+        color = colors.get(obj.status, '#6c757d')
+        return format_html(
+            '<span style="background-color: {}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">{}</span>',
+            color,
+            obj.get_status_display()
+        )
+    status_display.short_description = '–°—Ç–∞—Ç—É—Å'
+    status_display.admin_order_field = 'status'
+    
+    def invoice_link(self, obj):
+        """–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å"""
+        if obj.invoice:
+            url = reverse('admin:core_newinvoice_change', args=[obj.invoice.pk])
+            return format_html('<a href="{}">{}</a>', url, obj.invoice.number)
+        return '-'
+    invoice_link.short_description = '–ò–Ω–≤–æ–π—Å'
+    
+    def sender_info_display(self, obj):
+        """–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ"""
+        sender = obj.sender
+        if not sender:
+            return '–ù–µ —É–∫–∞–∑–∞–Ω'
+        
+        info = f'<strong>{sender}</strong><br>'
+        info += f'–¢–∏–ø: {sender.__class__.__name__}<br>'
+        
+        if hasattr(sender, 'balance'):
+            balance_str = f"{sender.balance:.2f}"
+            info += f'–ë–∞–ª–∞–Ω—Å: {balance_str}'
+        
+        return format_html(info)
+    sender_info_display.short_description = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ'
+    
+    def recipient_info_display(self, obj):
+        """–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ"""
+        recipient = obj.recipient
+        if not recipient:
+            return '–ù–µ —É–∫–∞–∑–∞–Ω'
+        
+        info = f'<strong>{recipient}</strong><br>'
+        info += f'–¢–∏–ø: {recipient.__class__.__name__}<br>'
+        
+        if hasattr(recipient, 'balance'):
+            balance_str = f"{recipient.balance:.2f}"
+            info += f'–ë–∞–ª–∞–Ω—Å: {balance_str}'
+        
+        return format_html(info)
+    recipient_info_display.short_description = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ'
+
+
+# ============================================================================
+# InvoiceItem –ù–ï —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ - —Ç–æ–ª—å–∫–æ inline –≤ NewInvoice
+# ============================================================================
+# –ü–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —É—Å–ª—É–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (CarService)
diff --git a/core/admin_filters.py b/core/admin_filters.py
index beb8793..3fc82dc 100644
--- a/core/admin_filters.py
+++ b/core/admin_filters.py
@@ -1,166 +1,166 @@
-from django.contrib.admin import SimpleListFilter
-from django.db import models
-from django.utils.translation import gettext_lazy as _
-from django.utils.html import format_html
-from django.urls import reverse
-import json
-
-
-class MultiStatusFilter(SimpleListFilter):
-    """–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏"""
-    title = _('–°—Ç–∞—Ç—É—Å')
-    parameter_name = 'status_multi'
-    template = 'admin/multi_status_filter.html'
-
-    def lookups(self, request, model_admin):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤"""
-        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –º–æ–¥–µ–ª–∏
-        status_choices = None
-        
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ STATUS_CHOICES –≤ —Å–∞–º–æ–π –º–æ–¥–µ–ª–∏
-        if hasattr(model_admin.model, 'STATUS_CHOICES'):
-            status_choices = model_admin.model.STATUS_CHOICES
-        # –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º Container.STATUS_CHOICES (–¥–ª—è –º–æ–¥–µ–ª–∏ Car)
-        elif hasattr(model_admin.model, 'Container') and hasattr(model_admin.model.Container, 'STATUS_CHOICES'):
-            status_choices = model_admin.model.Container.STATUS_CHOICES
-        # –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Container –Ω–∞–ø—Ä—è–º—É—é
-        else:
-            try:
-                from core.models import Container
-                if hasattr(Container, 'STATUS_CHOICES'):
-                    status_choices = Container.STATUS_CHOICES
-            except ImportError:
-                pass
-        
-        if status_choices:
-            choices = []
-            for status_code, status_name in status_choices:
-                choices.append((status_code, status_name))
-            return choices
-        
-        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–ª—É—á–∞–µ–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö
-        statuses = model_admin.model.objects.values_list('status', flat=True).distinct().order_by('status')
-        choices = []
-        for status in statuses:
-            choices.append((status, status))
-        return choices
-
-    def queryset(self, request, queryset):
-        """–§–∏–ª—å—Ç—Ä—É–µ—Ç queryset –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤"""
-        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
-        selected_statuses = request.GET.getlist(self.parameter_name)
-        if selected_statuses:
-            return queryset.filter(status__in=selected_statuses)
-        return queryset
-
-    def choices(self, changelist):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ"""
-        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ request
-        request = getattr(changelist, 'request', None)
-        if not request:
-            # –ï—Å–ª–∏ –Ω–µ—Ç request, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
-            current_selections = []
-        else:
-            current_selections = request.GET.getlist(self.parameter_name)
-        
-        for lookup, title in self.lookup_choices:
-            yield {
-                'selected': lookup in current_selections,
-                'query_string': changelist.get_query_string({
-                    self.parameter_name: lookup
-                }, []),
-                'display': title,
-                'value': lookup,
-            }
-
-
-class MultiWarehouseFilter(SimpleListFilter):
-    """–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏"""
-    title = _('–°–∫–ª–∞–¥')
-    parameter_name = 'warehouse_multi'
-    template = 'admin/multi_warehouse_filter.html'
-
-    def lookups(self, request, model_admin):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤"""
-        from core.models import Warehouse
-        warehouses = Warehouse.objects.all().order_by('name')
-        
-        choices = []
-        for warehouse in warehouses:
-            choices.append((warehouse.id, warehouse.name))
-        
-        return choices
-
-    def queryset(self, request, queryset):
-        """–§–∏–ª—å—Ç—Ä—É–µ—Ç queryset –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤"""
-        if self.value():
-            selected_warehouses = request.GET.getlist(self.parameter_name)
-            if selected_warehouses:
-                return queryset.filter(warehouse_id__in=selected_warehouses)
-        return queryset
-
-    def choices(self, changelist):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ"""
-        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ request
-        request = getattr(changelist, 'request', None)
-        if not request:
-            # –ï—Å–ª–∏ –Ω–µ—Ç request, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
-            current_selections = []
-        else:
-            current_selections = request.GET.getlist(self.parameter_name)
-        
-        for lookup, title in self.lookup_choices:
-            yield {
-                'selected': lookup in current_selections,
-                'query_string': changelist.get_query_string({
-                    self.parameter_name: lookup
-                }, []),
-                'display': title,
-                'value': lookup,
-            }
-
-
-class ClientAutocompleteFilter(SimpleListFilter):
-    """–§–∏–ª—å—Ç—Ä –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º (–ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏)"""
-    title = _('–ö–ª–∏–µ–Ω—Ç')
-    parameter_name = 'client__id__exact'
-    template = 'admin/client_autocomplete_filter.html'
-
-    def lookups(self, request, model_admin):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è"""
-        from core.models import Client
-        clients = Client.objects.all().order_by('name')
-        return [(str(c.id), c.name) for c in clients]
-
-    def queryset(self, request, queryset):
-        """–§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É"""
-        if self.value():
-            return queryset.filter(client_id=self.value())
-        return queryset
-
-    def choices(self, changelist):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞"""
-        from core.models import Client
-        
-        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è Select2
-        clients = Client.objects.all().order_by('name')
-        clients_data = [{'id': str(c.id), 'text': c.name} for c in clients]
-        
-        # –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
-        current_value = self.value()
-        current_text = ''
-        if current_value:
-            try:
-                current_text = Client.objects.get(id=current_value).name
-            except Client.DoesNotExist:
-                pass
-        
-        yield {
-            'selected': current_value is None,
-            'query_string': changelist.get_query_string(remove=[self.parameter_name]),
-            'display': _('–í—Å–µ'),
-            'clients_json': json.dumps(clients_data),
-            'current_value': current_value or '',
-            'current_text': current_text,
-            'parameter_name': self.parameter_name,
-        }
+from django.contrib.admin import SimpleListFilter
+from django.db import models
+from django.utils.translation import gettext_lazy as _
+from django.utils.html import format_html
+from django.urls import reverse
+import json
+
+
+class MultiStatusFilter(SimpleListFilter):
+    """–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏"""
+    title = _('–°—Ç–∞—Ç—É—Å')
+    parameter_name = 'status_multi'
+    template = 'admin/multi_status_filter.html'
+
+    def lookups(self, request, model_admin):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤"""
+        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –º–æ–¥–µ–ª–∏
+        status_choices = None
+        
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ STATUS_CHOICES –≤ —Å–∞–º–æ–π –º–æ–¥–µ–ª–∏
+        if hasattr(model_admin.model, 'STATUS_CHOICES'):
+            status_choices = model_admin.model.STATUS_CHOICES
+        # –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º Container.STATUS_CHOICES (–¥–ª—è –º–æ–¥–µ–ª–∏ Car)
+        elif hasattr(model_admin.model, 'Container') and hasattr(model_admin.model.Container, 'STATUS_CHOICES'):
+            status_choices = model_admin.model.Container.STATUS_CHOICES
+        # –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Container –Ω–∞–ø—Ä—è–º—É—é
+        else:
+            try:
+                from core.models import Container
+                if hasattr(Container, 'STATUS_CHOICES'):
+                    status_choices = Container.STATUS_CHOICES
+            except ImportError:
+                pass
+        
+        if status_choices:
+            choices = []
+            for status_code, status_name in status_choices:
+                choices.append((status_code, status_name))
+            return choices
+        
+        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–ª—É—á–∞–µ–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö
+        statuses = model_admin.model.objects.values_list('status', flat=True).distinct().order_by('status')
+        choices = []
+        for status in statuses:
+            choices.append((status, status))
+        return choices
+
+    def queryset(self, request, queryset):
+        """–§–∏–ª—å—Ç—Ä—É–µ—Ç queryset –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤"""
+        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
+        selected_statuses = request.GET.getlist(self.parameter_name)
+        if selected_statuses:
+            return queryset.filter(status__in=selected_statuses)
+        return queryset
+
+    def choices(self, changelist):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ"""
+        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ request
+        request = getattr(changelist, 'request', None)
+        if not request:
+            # –ï—Å–ª–∏ –Ω–µ—Ç request, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
+            current_selections = []
+        else:
+            current_selections = request.GET.getlist(self.parameter_name)
+        
+        for lookup, title in self.lookup_choices:
+            yield {
+                'selected': lookup in current_selections,
+                'query_string': changelist.get_query_string({
+                    self.parameter_name: lookup
+                }, []),
+                'display': title,
+                'value': lookup,
+            }
+
+
+class MultiWarehouseFilter(SimpleListFilter):
+    """–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏"""
+    title = _('–°–∫–ª–∞–¥')
+    parameter_name = 'warehouse_multi'
+    template = 'admin/multi_warehouse_filter.html'
+
+    def lookups(self, request, model_admin):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤"""
+        from core.models import Warehouse
+        warehouses = Warehouse.objects.all().order_by('name')
+        
+        choices = []
+        for warehouse in warehouses:
+            choices.append((warehouse.id, warehouse.name))
+        
+        return choices
+
+    def queryset(self, request, queryset):
+        """–§–∏–ª—å—Ç—Ä—É–µ—Ç queryset –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤"""
+        if self.value():
+            selected_warehouses = request.GET.getlist(self.parameter_name)
+            if selected_warehouses:
+                return queryset.filter(warehouse_id__in=selected_warehouses)
+        return queryset
+
+    def choices(self, changelist):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ"""
+        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ request
+        request = getattr(changelist, 'request', None)
+        if not request:
+            # –ï—Å–ª–∏ –Ω–µ—Ç request, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
+            current_selections = []
+        else:
+            current_selections = request.GET.getlist(self.parameter_name)
+        
+        for lookup, title in self.lookup_choices:
+            yield {
+                'selected': lookup in current_selections,
+                'query_string': changelist.get_query_string({
+                    self.parameter_name: lookup
+                }, []),
+                'display': title,
+                'value': lookup,
+            }
+
+
+class ClientAutocompleteFilter(SimpleListFilter):
+    """–§–∏–ª—å—Ç—Ä –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º (–ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏)"""
+    title = _('–ö–ª–∏–µ–Ω—Ç')
+    parameter_name = 'client__id__exact'
+    template = 'admin/client_autocomplete_filter.html'
+
+    def lookups(self, request, model_admin):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è"""
+        from core.models import Client
+        clients = Client.objects.all().order_by('name')
+        return [(str(c.id), c.name) for c in clients]
+
+    def queryset(self, request, queryset):
+        """–§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É"""
+        if self.value():
+            return queryset.filter(client_id=self.value())
+        return queryset
+
+    def choices(self, changelist):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞"""
+        from core.models import Client
+        
+        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è Select2
+        clients = Client.objects.all().order_by('name')
+        clients_data = [{'id': str(c.id), 'text': c.name} for c in clients]
+        
+        # –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
+        current_value = self.value()
+        current_text = ''
+        if current_value:
+            try:
+                current_text = Client.objects.get(id=current_value).name
+            except Client.DoesNotExist:
+                pass
+        
+        yield {
+            'selected': current_value is None,
+            'query_string': changelist.get_query_string(remove=[self.parameter_name]),
+            'display': _('–í—Å–µ'),
+            'clients_json': json.dumps(clients_data),
+            'current_value': current_value or '',
+            'current_text': current_text,
+            'parameter_name': self.parameter_name,
+        }
diff --git a/core/ai_rag_index.json b/core/ai_rag_index.json
new file mode 100644
index 0000000..f13e681
--- /dev/null
+++ b/core/ai_rag_index.json
@@ -0,0 +1 @@
+{"version": 1, "model": "", "created_at": 1769292161, "chunks": [{"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "# –û—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø–æ –ø—Ä–æ–µ–∫—Ç—É Logist2 **–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 24 —è–Ω–≤–∞—Ä—è 2026 –≥. --- ## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –ø—Ä–æ–º—Ç–∞ –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –¥–æ—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–°: 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¢–° —Å 2 –¥–æ 11 2. –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ THS –ø–æ —Ç–∏–ø–∞–º –¢–° 3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞—Ç—å –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ THS (–ª–∏–Ω–∏—è –∏–ª–∏ —Å–∫–ª–∞–¥) 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –¢–° --- ## –í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –†–ê–ë–û–¢–ê ### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–§–∞–π–ª:** `core/models.py` - –º–æ–¥–µ–ª—å `Car` –ë—ã–ª–æ 2 —Ç–∏–ø–∞ (CAR, MOTO), —Å—Ç–∞–ª–æ 11: - SEDAN (–õ–µ–≥–∫–æ–≤–æ–π), CROSSOVER (–ö—Ä–æ—Å—Å–æ–≤–µ—Ä), SUV (–î–∂–∏–ø), PICKUP (–ü–∏–∫–∞–ø) - NEW_CAR (–ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å), MOTO (–ú–æ—Ç–æ—Ü–∏–∫–ª), BIG_MOTO (–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª) - ATV (–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏), BOAT (–õ–æ–¥–∫–∞), RV (–ê–≤—Ç–æ–¥–æ–º), CONSTRUCTION (–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞) **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0089_expand_vehicle_types_and_ths_system.py` - –†–∞—Å—à–∏—Ä–µ–Ω `max_length` –ø–æ–ª—è —Å 10 –¥–æ 20 - –ó–∞–ø–∏—Å–∏ —Å `CAR` –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ `SEDAN` --- ### 2. –°–∏—Å—Ç–µ–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –ø–æ —Ç–∏–ø–∞–º –¢–° (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ú–æ–¥–µ–ª—å `LineTHSCoefficient`** –≤ `core/models.py` (—Ä–∞–Ω–µ–µ LineTHSPercent): - –°–≤—è–∑–∞–Ω–∞ —Å –ª–∏–Ω–∏–µ–π —á–µ—Ä–µ–∑ ForeignKey - –•—Ä–∞–Ω–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–° - unique_", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "6.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ú–æ–¥–µ–ª—å `LineTHSCoefficient`** –≤ `core/models.py` (—Ä–∞–Ω–µ–µ LineTHSPercent): - –°–≤—è–∑–∞–Ω–∞ —Å –ª–∏–Ω–∏–µ–π —á–µ—Ä–µ–∑ ForeignKey - –•—Ä–∞–Ω–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–° - unique_together: line + vehicle_type - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = 1.0 **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0093_rename_ths_percent_to_coefficient.py` - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å LineTHSPercent ‚Üí LineTHSCoefficient - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –ø–æ–ª–µ percent ‚Üí coefficient - –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25 **–ê–¥–º–∏–Ω–∫–∞:** `LineTHSCoefficientInline` –≤ `LineAdmin` **–õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS:** - –°—É–º–º–∞ THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º - –§–æ—Ä–º—É–ª–∞: THS_–¢–° = –æ–±—â–∏–π_THS √ó (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç_–¢–° / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤) - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –≤–≤–µ—Ä—Ö –¥–æ 5 EUR **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:** | –¢–∏–ø –¢–° | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç | |--------|-------------| | –õ–µ–≥–∫–æ–≤–æ–π | 1.0 | | –ö—Ä–æ—Å—Å–æ–≤–µ—Ä | 1.2 | | –î–∂–∏–ø/–ü–∏–∫–∞–ø | 1.5 | | –ú–æ—Ç–æ—Ü–∏–∫–ª | 0.3 | | –ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª | 0.5 | | –õ–æ–¥–∫–∞ | 2.0 | | –ê–≤—Ç–æ–¥–æ–º (RV) | 3.0 | | –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ | 2.5 | --- ### 3. –ü–æ–ª–µ \"–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑\" –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü–æ–ª–µ `ths_payer`** –≤ –º–æ–¥–µ–ª–∏ `Container`: - LINE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='LINE' - WAREHOUSE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='WAREHOUS", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "3. –ü–æ–ª–µ \"–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑\" –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü–æ–ª–µ `ths_payer`** –≤ –º–æ–¥–µ–ª–∏ `Container`: - LINE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='LINE' - WAREHOUSE = —É—Å–ª—É–≥–∞ THS –∫–∞–∫ service_type='WAREHOUSE' **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0090_update_ths_payer_labels.py` --- ### 4. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ THS –¥–æ 5 EUR **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `round_up_to_5()` –≤–Ω—É—Ç—Ä–∏ `calculate_ths_for_container()` –≤ `core/signals.py` –ü—Ä–∏–º–µ—Ä: 73.12 EUR -> 75 EUR --- ### 5. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è THS —É—Å–ª—É–≥ **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ –§—É–Ω–∫—Ü–∏—è `create_ths_services_for_container()` –≤ `core/signals.py`: - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π THS - –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏ - –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º service_type - –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `ContainerAdmin.save_model()` –∏ `save_formset()` --- ### 6. –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ü–µ–Ω (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** - –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `current_price` –∏–∑ –º–æ–¥–µ–ª–∏ `Car` - –û—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ `total_price` (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ \"–¶–µ–Ω–∞\") - –¶–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ —Å—Ç–∞—Ç—É—Å–∞ \"–ü–µ—Ä–µ–¥–∞–Ω\" - –ü–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ —Ü–µ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0092_remove_current_price.py` --- ### 7. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å–ª—É–≥–∞ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–¥–∞–Ω\" - –ü–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ —Ü–µ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0092_remove_current_price.py` --- ### 7. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å–ª—É–≥–∞ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π 5 EUR, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –µ—â—ë –Ω–µ –±—ã–ª–æ. **–†–µ—à–µ–Ω–∏–µ:** - –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `rate` –∏–∑ –º–æ–¥–µ–ª–∏ `Warehouse` - –°—Ç–∞–≤–∫–∞ –∑–∞ –¥–µ–Ω—å —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ (`WarehouseService.default_price`) - –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å - –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç - —Ü–µ–Ω–∞ = 0 **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0091_remove_warehouse_rate.py` **–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ `Car`:** - `update_days_and_storage()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–Ω–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Å—á—ë—Ç —Ü–µ–Ω—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è - `_get_storage_daily_rate()` - –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" - `_update_storage_service_price()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –≤ CarService --- ### 8. –£–ª—É—á—à–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –ø–æ —É—Å–ª—É–≥–∞–º (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `services_summary_display`:** - THS –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞) - –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–∫–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ) - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania --- ### 9. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ THS –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "—å—â–∏–∫–∞) - –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–∫–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ) - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania --- ### 9. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ THS –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å `ths_payer='WAREHOUSE'` —É—Å–ª—É–≥–∞ THS –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å. **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ `'warehouse'` –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª–µ–π –≤ `ContainerAdmin.save_model()` --- ### 10. –ö–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** - –í –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ \"‚Üª –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" - –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è THS-—É—Å–ª—É–≥–∏ –¥–ª—è –≤—Å–µ—Ö –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º \"–†–∞–∑–≥—Ä—É–∂–µ–Ω\" –∏–ª–∏ \"–í –ø—É—Ç–∏\" - –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–µ —Ü–µ–Ω—ã –¢–° **–§–∞–π–ª—ã:** - `templates/admin/line_change.html` - —à–∞–±–ª–æ–Ω —Å –∫–Ω–æ–ø–∫–æ–π - `core/admin.py` - –º–µ—Ç–æ–¥ `recalculate_ths_view()` –≤ `LineAdmin` **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** 1. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–Ω–∏—é 3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" 4. –î–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: X –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, Y –¢–°\" --- ### 11. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS-—É—Å–ª—É–≥ —Ü–µ–Ω–∞ –¢–° –Ω–µ –æ–±", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": " 4. –î–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: X –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, Y –¢–°\" --- ### 11. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã (16.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS-—É—Å–ª—É–≥ —Ü–µ–Ω–∞ –¢–° –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –∏–∑-–∑–∞ –∫—ç—à–∞ `_prefetched_objects_cache`. **–†–µ—à–µ–Ω–∏–µ:** –í –º–µ—Ç–æ–¥–µ `calculate_total_price()` –¥–æ–±–∞–≤–ª–µ–Ω —Å–±—Ä–æ—Å –∫—ç—à–∞ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á—ë—Ç–æ–º: ```python if hasattr(self, '_prefetched_objects_cache'): self._prefetched_objects_cache.pop('car_services', None) ``` --- ### 12. –°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ (17.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–¶–µ–ª—å:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫—Ä—ã—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–ø—Ä–∏–±—ã–ª—å) –ø–æ —É—Å–ª—É–≥–∞–º, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ. **–ù–æ–≤–æ–µ –ø–æ–ª–µ `markup_amount`** –≤ –º–æ–¥–µ–ª–∏ `CarService`: - –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏ - –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ - –ù–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ **–ù–æ–≤–æ–µ –ø–æ–ª–µ `default_markup`** –≤ –º–æ–¥–µ–ª—è—Ö —É—Å–ª—É–≥: - `WarehouseService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ - `LineService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏ - `CarrierService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ default_markup **–ú–∏–≥—Ä–∞—Ü–∏–∏:** - `0094_add_hide_markup_in_fiel", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": " —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏ - `CarrierService.default_markup` - –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ default_markup **–ú–∏–≥—Ä–∞—Ü–∏–∏:** - `0094_add_hide_markup_in_field.py` - `0095_add_markup_distribution.py` - `0096_add_default_markup_to_services.py` **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¢–°:** - –†—è–¥–æ–º —Å –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–æ–π –ø–æ—è–≤–∏–ª–æ—Å—å –∂—ë–ª—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞—Ü–µ–Ω–∫–∏ - –ù–∞—Ü–µ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –±–ª–æ–∫–∞—Ö —É—Å–ª—É–≥ (—Å–∫–ª–∞–¥, –ª–∏–Ω–∏—è, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫) - –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –Ω–∞—Ü–µ–Ω–∫–∏ **–õ–æ–≥–∏–∫–∞ —Ü–µ–Ω:** - `final_price` = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏) ‚Äî –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞ - `invoice_price` = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ + –Ω–∞—Ü–µ–Ω–∫–∞ ‚Äî –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É - `total_price` –¢–° = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö –Ω–∞—Ü–µ–Ω–æ–∫ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\":** - –ù–∞—Ü–µ–Ω–∫–∞ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π (–∫–∞–∫ –∏ —Ü–µ–Ω–∞) - –ü—Ä–∏ `default_markup=1` –∏ 7 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π ‚Üí –Ω–∞—Ü–µ–Ω–∫–∞ = 7 EUR **–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º (services_summary_display):** - –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤–∫–ª—é—á–∞—è THS –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥) - –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–±–µ–∑ THS) - –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –æ—Ç–¥–µ–ª—å–Ω–æ - –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º **–ò–Ω–≤–æ–π—Å:** - –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π - –ù–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–∫–ª–∞–¥) - –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–±–µ–∑ THS) - –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –æ—Ç–¥–µ–ª—å–Ω–æ - –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º **–ò–Ω–≤–æ–π—Å:** - –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π - –ù–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è Company) --- ### 13. –û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 24.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** - –ï—Å–ª–∏ –≤—Å–µ –¢–° –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å `TRANSFERRED`, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ `TRANSFERRED` - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `Car.save()` –∏ –≤ –¥–µ–π—Å—Ç–≤–∏—è—Ö –∞–¥–º–∏–Ω–∫–∏ **–§–∞–π–ª—ã:** - `core/models.py` ‚Äî `Container.check_and_update_status_from_cars()`, –≤—ã–∑–æ–≤ –∏–∑ `Car.save()` - `core/admin.py` ‚Äî –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö ## –†–ï–®–Å–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ | # | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ | |---|----------|---------|---------| | 1 | THS –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º | –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ —Å–∏–≥–Ω–∞–ª–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª –ª–æ–≥–∏–∫—É | –û—Ç–∫–ª—é—á–µ–Ω–∞ —Å–µ–∫—Ü–∏—è \"–£–°–õ–£–ì–ò –õ–ò–ù–ò–ò\" –≤ create_car_services_on_car_save | | 2 | THS –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è –∫–∞–∫ LINE –≤–º–µ—Å—Ç–æ WAREHOUSE | –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ ths_payer | –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ create_ths_services_for_container() | | 3 | THS –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ change=True | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ save_formset() –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "r | –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ create_ths_services_for_container() | | 3 | THS –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ change=True | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ save_formset() –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° | | 4 | –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–ª–∏—Å—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¢–° | –°–∏–≥–Ω–∞–ª update_cars_on_line_service_change | –û—Ç–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è | | 5 | –¶–µ–Ω–∞ –Ω–∞ 5 EUR –±–æ–ª—å—à–µ –ø—Ä–∏ 0 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π | –£—Å–ª—É–≥–∞ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π | –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: –¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞ | | 6 | –§–∏–ª—å—Ç—Ä `icontains` –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" | –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –≤ PostgreSQL | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ `name='–•—Ä–∞–Ω–µ–Ω–∏–µ'` | | 7 | –¶–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –¢–° –æ—Ç–ª–∏—á–∞–ª–∞—Å—å –æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ | Prefetch –∫—ç—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è | –†–∞—Å—á—ë—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î –≤ `total_price_display` | | 8 | THS –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ | –ü–æ–ª–µ warehouse –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª–æ—Å—å | –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ ths_related_changed | | 9 | –ü—Ä–æ—Ü–µ–Ω—Ç—ã THS –Ω–µ–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã | –¢—Ä—É–¥–Ω–æ –ø–æ–Ω—è—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ | –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç) | | 10 | –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° | –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ö–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ | | 11 | –¶–µ–Ω–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS | –ö—ç—à car_services –Ω–µ —Å–±", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–æ–±–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° | –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ö–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ | | 11 | –¶–µ–Ω–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS | –ö—ç—à car_services –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è | –°–±—Ä–æ—Å –∫—ç—à–∞ –≤ calculate_total_price() | | 12 | –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É | Form –≤–Ω—É—Ç—Ä–∏ form | –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Å—Å—ã–ª–∫—É (—Ç–µ–≥ `<a>`) | | 13 | –ù–∞—Ü–µ–Ω–∫–∞ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –≤ –∏–Ω–≤–æ–π—Å–µ | –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ \"–ù–∞—Ü–µ–Ω–∫–∞ Caromoto\" | –ù–∞—Ü–µ–Ω–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —É—Å–ª—É–≥–∞–º —Å–∫—Ä—ã—Ç–æ | | 14 | –ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –ø–æ —É—Å–ª—É–≥–∞–º | –¢–æ–ª—å–∫–æ –æ–±—â–µ–µ –ø–æ–ª–µ proft | –ñ—ë–ª—Ç—ã–µ –ø–æ–ª—è –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ | | 15 | –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –≤ —Å–≤–æ–¥–∫–µ | custom_price=None —Å—á–∏—Ç–∞–ª–æ—Å—å –∫–∞–∫ 0 | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è final_price —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None` | | 16 | THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –≤ —É—Å–ª—É–≥–∞—Ö –ª–∏–Ω–∏–π | –§–∏–ª—å—Ç—Ä –ø–æ service_type='LINE' | THS —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç service_type | | 17 | +5 EUR –ø—Ä–∏ 0 –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π | custom_price=0 ‚Üí False ‚Üí default_price=5 | –ü—Ä–æ–≤–µ—Ä–∫–∞ `custom_price is not None` | | 18 | –í —É—Å–ª—É–≥–∞—Ö –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –Ω–µ—Ç —Ñ–ª–∞–≥–∞ \"–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\" | –ù–µ –±—ã–ª–æ –ø–æ–ª—è add_by_default | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –∏ –∏–Ω–ª–∞–π–Ω—ã –¥–ª—è LineService/CarrierService | | 19 | –£—Å–ª—É–≥–∞ —Å add_by_default –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": " –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –Ω–µ—Ç —Ñ–ª–∞–≥–∞ \"–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\" | –ù–µ –±—ã–ª–æ –ø–æ–ª—è add_by_default | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –∏ –∏–Ω–ª–∞–π–Ω—ã –¥–ª—è LineService/CarrierService | | 19 | –£—Å–ª—É–≥–∞ —Å add_by_default –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¢–° | –°–∏–≥–Ω–∞–ª—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ CarService –¥–ª—è –≤—Å–µ—Ö –¢–° | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–≤—è–∑–µ–π, –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö | --- ## –ù–ï–í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø –†–ê–ë–û–¢–ê (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ–º—Ç—É) - –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. - –û—Ç–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ (–æ—Ç—á—ë—Ç—ã/—Å–≤–æ–¥–∫–∏) –Ω–µ –≤—ã–¥–µ–ª–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å. --- ## –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´ ### –ú–æ–¥–µ–ª–∏ (`core/models.py`) - –¢–∏–ø—ã –¢–° —Ä–∞—Å—à–∏—Ä–µ–Ω—ã –¥–æ 11 - –ú–æ–¥–µ–ª—å `LineTHSCoefficient` –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS (—Ä–∞–Ω–µ–µ LineTHSPercent) - –ü–æ–ª–µ `ths_payer` –≤ `Container` - –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `rate` –∏–∑ `Warehouse` - –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `current_price` –∏–∑ `Car` - –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á—ë—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è: `update_days_and_storage()`, `_get_storage_daily_rate()`, `_update_storage_service_price()` - –°–±—Ä–æ—Å –∫—ç—à–∞ –≤ `calculate_total_price()` - **–ù–æ–≤–æ–µ:** `CarService.markup_amount` - —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è —É—Å–ª—É–≥–∏ - **–ù–æ–≤–æ–µ:** `CarService.final_price` - —Ü–µ–Ω–∞ –±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None`) - **–ù–æ–≤–æ–µ:** `CarService.invoice_price` - —Ü–µ–Ω–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ - **–ù–æ–≤–æ–µ:** `WarehouseService.d", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–∞ –¥–ª—è —É—Å–ª—É–≥–∏ - **–ù–æ–≤–æ–µ:** `CarService.final_price` - —Ü–µ–Ω–∞ –±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `is not None`) - **–ù–æ–≤–æ–µ:** `CarService.invoice_price` - —Ü–µ–Ω–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ - **–ù–æ–≤–æ–µ:** `WarehouseService.default_markup`, `LineService.default_markup`, `CarrierService.default_markup` - **–ù–æ–≤–æ–µ:** `calculate_total_price()` —É—á–∏—Ç—ã–≤–∞–µ—Ç markup_amount - **–ù–æ–≤–æ–µ:** `Container.check_and_update_status_from_cars()` + –≤—ã–∑–æ–≤ –∏–∑ `Car.save()` - **–ù–æ–≤–æ–µ:** `CompanyService` + —Ç–∏–ø `COMPANY` –≤ `CarService` - **–ù–æ–≤–æ–µ:** `LineService.add_by_default`, `CarrierService.add_by_default` - **–ù–æ–≤–æ–µ:** `Car.get_company_services()` –∏ —É—á—ë—Ç `company_total` –≤ —Ä–∞—Å—á—ë—Ç–µ —Ü–µ–Ω—ã ### –ê–¥–º–∏–Ω–∫–∞ (`core/admin.py`) - `LineTHSCoefficientInline` –≤ LineAdmin (—Å –ø–æ–ª–µ–º coefficient –≤–º–µ—Å—Ç–æ percent) - `LineAdmin.recalculate_ths_view()` - –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ THS - `LineAdmin.get_urls()` - –∫–∞—Å—Ç–æ–º–Ω—ã–π URL –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ - `ContainerAdmin.save_model()` - –≤—ã–∑–æ–≤ THS –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ line/ths/ths_payer/warehouse - `ContainerAdmin.save_formset()` - –≤—ã–∑–æ–≤ THS –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° - `WarehouseAdmin` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ rate - `CarAdmin.services_summary_display()` - —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ - `CarAdmin.total_price_display()` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã - **–ù–æ–≤–æ–µ:** –ñ—ë–ª—Ç—ã–µ –ø", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° - `WarehouseAdmin` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ rate - `CarAdmin.services_summary_display()` - —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ - `CarAdmin.total_price_display()` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã - **–ù–æ–≤–æ–µ:** –ñ—ë–ª—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞—Ü–µ–Ω–∫–∏ —Ä—è–¥–æ–º —Å –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–æ–π - **–ù–æ–≤–æ–µ:** `save_model()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç markup_amount –¥–ª—è —É—Å–ª—É–≥ - **–ù–æ–≤–æ–µ:** –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (–≤–∫–ª—é—á–∞—è THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥) - **–ù–æ–≤–æ–µ:** –°–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ - **–ù–æ–≤–æ–µ:** –ò–Ω–ª–∞–π–Ω `CompanyServiceInline` –≤ `CompanyAdmin` - **–ù–æ–≤–æ–µ:** –ë–ª–æ–∫ \"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏\" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –¢–° - **–ù–æ–≤–æ–µ:** –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ —É –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ ### –°–∏–≥–Ω–∞–ª—ã (`core/signals.py`) - `calculate_ths_for_container()` - —Ä–∞—Å—á—ë—Ç THS –ø–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º - `create_ths_services_for_container()` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥ THS - `round_up_to_5()` - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 5 EUR - –ò–∑–º–µ–Ω—ë–Ω —Ñ–∏–ª—å—Ç—Ä \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –Ω–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - **–ù–æ–≤–æ–µ:** –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `default_markup` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService - **–ù–æ–≤–æ–µ:** –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ –Ω–∞ –¥–Ω–∏ –¥–ª—è —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" - **–ù–æ–≤–æ–µ:** –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–° (Caromoto Lithuania) - **–ù–æ–≤–æ–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—Å–ª—É–≥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º) ### –ë–∏–ª–ª–∏–Ω–≥ (", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" - **–ù–æ–≤–æ–µ:** –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–° (Caromoto Lithuania) - **–ù–æ–≤–æ–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—Å–ª—É–≥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º) ### –ë–∏–ª–ª–∏–Ω–≥ (`core/models_billing.py`) - **–ù–æ–≤–æ–µ:** –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ - **–ù–æ–≤–æ–µ:** `invoice_price` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ü–µ–Ω—ã —É—Å–ª—É–≥–∏ (—Å –Ω–∞—Ü–µ–Ω–∫–æ–π) ### –í—å—é—Ö–∏ (`core/views.py`) - **–ù–æ–≤–æ–µ:** `add_services()` –∫–æ–ø–∏—Ä—É–µ—Ç `default_price` –∏ `default_markup` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ - **–ù–æ–≤–æ–µ:** `get_companies()` –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `company` –≤ get_available_services/add_services ### –®–∞–±–ª–æ–Ω—ã - `templates/admin/line_change.html` - –∫–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" - `templates/admin/core/car/change_form.html` - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ \"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏\" ### –ú–∏–≥—Ä–∞—Ü–∏–∏ - `0089_expand_vehicle_types_and_ths_system.py` - `0090_update_ths_payer_labels.py` - `0091_remove_warehouse_rate.py` - `0092_remove_current_price.py` - `0093_rename_ths_percent_to_coefficient.py` - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã - `0094_add_hide_markup_in_field.py` - –ø–æ–ª–µ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ - `0095_add_markup_distribution.py` - –ø–æ–ª–µ markup_amount –≤ CarService - `0096_add_default_markup_to_services.py` - –ø–æ–ª–µ default_markup –≤ —É—Å–ª—É–≥–∞—Ö - `0099_add_default_flag", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "py` - –ø–æ–ª–µ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ - `0095_add_markup_distribution.py` - –ø–æ–ª–µ markup_amount –≤ CarService - `0096_add_default_markup_to_services.py` - –ø–æ–ª–µ default_markup –≤ —É—Å–ª—É–≥–∞—Ö - `0099_add_default_flags_line_carrier_services.py` - `0100_add_company_service.py` - `0101_alter_carservice_service_type_and_more.py` --- ## –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø 1. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 1.0 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏) 2. –î–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ 3. –°—Ç–∞–≤–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ 4. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —É—Å–ª—É–≥—É \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Å –Ω—É–∂–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π –∑–∞ –¥–µ–Ω—å 5. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ --- ### 14. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (21.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ #### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive **–§–∞–π–ª:** `core/google_drive_sync.py` **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Google Drive –ø–æ –Ω–æ–º–µ—Ä—É - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–ø–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä \"ECMU5566195 CAROMOTO D\") - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º: - `IN_CONTAINER` - —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–∞–ø–∫–∞ \"KONTO VIDUS\") - `UNLOADING` - —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–ø–∞–ø–∫–∞ \"AUTO I≈† KONTO\") - –ê–≤—Ç–æ–º–∞—Ç", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–º (–Ω–∞–ø—Ä–∏–º–µ—Ä \"ECMU5566195 CAROMOTO D\") - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º: - `IN_CONTAINER` - —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–∞–ø–∫–∞ \"KONTO VIDUS\") - `UNLOADING` - —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–ø–∞–ø–∫–∞ \"AUTO I≈† KONTO\") - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É Google Drive **Management –∫–æ–º–∞–Ω–¥–∞:** `sync_photos_gdrive` ```bash python manage.py sync_photos_gdrive --no-photos # –¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º) python manage.py sync_photos_gdrive --recent # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã python manage.py sync_photos_gdrive --container ECMU5566195 # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ``` **Cron –∑–∞–¥–∞—á–∏ (sync_photos_cron.sh):** - –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ - –†–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 3:00 - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–∞–≤–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ #### –ì–∞–ª–µ—Ä–µ—è –≤ –∞–¥–º–∏–Ω–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ **–§–∞–π–ª—ã:** - `templates/admin/core/container/change_form.html` - `templates/admin/core/container/photos_gallery.html` **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** - –ì–∞–ª–µ—Ä–µ—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤—ë—Ä–Ω—É—Ç–∞ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) - –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ - –í–∫–ª–∞–¥–∫–∏ \"–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ\" –∏ \"–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ\" - Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä - Lightbox –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã—Ö —Ñ–æ—Ç–æ - –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã **API endpoint:** `GET /core/container/<id>/photos-j", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–æ–≤–æ–∫ - –í–∫–ª–∞–¥–∫–∏ \"–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ\" –∏ \"–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ\" - Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä - Lightbox –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã—Ö —Ñ–æ—Ç–æ - –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã **API endpoint:** `GET /core/container/<id>/photos-json/` #### –ì–∞–ª–µ—Ä–µ—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ **–§–∞–π–ª:** `templates/website/home.html` **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** - –í–∫–ª–∞–¥–∫–∏ \"–í—Å–µ\", \"–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ\", \"–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ\" - –í—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è - –ö–Ω–æ–ø–∫–∞ \"–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ\" (–∑–µ–ª—ë–Ω–∞—è) - Lightbox —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ - –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ (drag —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏) **API endpoint:** `GET /api/container-photos/<container_number>/` - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `photo_type_code` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º --- ### 15. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ (21.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–§–∞–π–ª:** `core/views_website.py` - —Ñ—É–Ω–∫—Ü–∏—è `track_shipment` **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** - –£–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `current_price` –∏–∑ `ClientCarSerializer` - –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VIN (—É–±–∏—Ä–∞—é—Ç—Å—è –ø—Ä–æ–±–µ–ª—ã, —Ç–∏—Ä–µ) - –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é VIN - –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ --- ### 16. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (21.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ VPS —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": " - –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ --- ### 16. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (21.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ VPS —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏), —Ö–æ—Ç—è —Ñ–∞–π–ª—ã –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. **–ü—Ä–∏—á–∏–Ω–∞:** API endpoints –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ URL –±–µ–∑ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `/container_photos/...` –≤–º–µ—Å—Ç–æ `/media/container_photos/...`). **–†–µ—à–µ–Ω–∏–µ:** - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ `core/views.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_container_photos_json`) - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤ `core/views_website.py` (—Ñ—É–Ω–∫—Ü–∏—è `get_container_photos`) - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`) **–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ```python # Ensure URLs have /media/ prefix photo_url = photo.photo.url if photo_url and not photo_url.startswith('/media/') and not photo_url.startswith('http'): photo_url = '/media/' + photo_url.lstrip('/') ``` --- ### 17. –£–ª—É—á—à–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ (21.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–µ–µ –º–∏–≥–∞–Ω–∏–µ –∏–∑-–∑–∞ `transform: translateY(-2px)` –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö `box-shadow`. **–†–µ—à–µ–Ω–∏–µ:** - –£–±—Ä–∞–Ω `transform: translateY` (–ø—Ä–∏–ø–æ–¥–Ω–∏–º–∞–Ω–∏", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "—à–µ–Ω–æ **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–µ–µ –º–∏–≥–∞–Ω–∏–µ –∏–∑-–∑–∞ `transform: translateY(-2px)` –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö `box-shadow`. **–†–µ—à–µ–Ω–∏–µ:** - –£–±—Ä–∞–Ω `transform: translateY` (–ø—Ä–∏–ø–æ–¥–Ω–∏–º–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏) - –£–±—Ä–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–π `box-shadow` - –ò–∑–º–µ–Ω—ë–Ω `transition: all` –Ω–∞ `transition: opacity` (—É–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –≤—Å–µ—Ö —Å–≤–æ–π—Å—Ç–≤) - –§–∏–Ω–∞–ª—å–Ω—ã–π hover-—ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–æ—Å—Ç–æ–µ `opacity: 0.85` **–§–∞–π–ª:** `core/static/website/css/style.css` **–î–æ:** ```css .btn { transition: all 0.3s ease; } .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,.2); } ``` **–ü–æ—Å–ª–µ:** ```css .btn { transition: opacity 0.2s ease; } .btn:hover { opacity: 0.85; } ``` --- ## –ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô | –î–∞—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | |------|----------| | 14.01.2026 | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è THS —Å–∏—Å—Ç–µ–º—ã | | 16.01.2026 (–¥–µ–Ω—å) | –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ü–µ–Ω, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è | | 16.01.2026 (–≤–µ—á–µ—Ä) | –ó–∞–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –∫–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\", –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ | | 17.01.2026 | –°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏: markup_amount, default_markup, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª—É–≥–∞–º | | 21.01.2026 | –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º, –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ | | 21.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏: markup_amount, default_markup, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª—É–≥–∞–º | | 21.01.2026 | –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º, –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ | | 21.01.2026 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ VPS (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ /media/ –ø—Ä–µ—Ñ–∏–∫—Å–∞) | | 21.01.2026 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–Ω–æ–ø–æ–∫ (—É–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ–π opacity) | | 21.01.2026 | –£–ª—É—á—à–µ–Ω–∏–µ Lightbox –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∑—É–º–µ, touch-–∂–µ—Å—Ç—ã | | 23.01.2026 | AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î, —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é | | 24.01.2026 | –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: –æ–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ TRANSFERRED | | 24.01.2026 | –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π, add_by_default –¥–ª—è –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏—è | --- ### 18. AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ (23.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** - –ü–æ–¥–∫–ª—é—á—ë–Ω AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–∑ –ë–î (VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã, —Ñ–æ—Ç–æ) - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç–∞/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É - –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∏ –≤—ã–¥–∞—á–∞ —Å—Ç–∞—Ç—É—Å–∞, –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞—Ç –∏ —Ñ–æ—Ç–æ - –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ - –í –∞–¥–º–∏–Ω–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω —á–∞—Ç-–≤–∏–¥–µ—Ç **–§–∞–π–ª—ã:** - `core/ser", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "–¥–∂–µ—Ä—É - –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∏ –≤—ã–¥–∞—á–∞ —Å—Ç–∞—Ç—É—Å–∞, –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞—Ç –∏ —Ñ–æ—Ç–æ - –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ - –í –∞–¥–º–∏–Ω–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω —á–∞—Ç-–≤–∏–¥–µ—Ç **–§–∞–π–ª—ã:** - `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø–æ–∏—Å–∫ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ñ–æ—Ç–æ - `core/views_website.py` ‚Äî AI —á–∞—Ç, –±–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ñ–æ—Ç–æ, —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é - `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `.env` - `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ - `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞ - `core/static/website/js/ai-chat.js` ‚Äî CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏, fallback-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - `templates/website/home.html` ‚Äî –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ç–æ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º `track`/`photos` - `env.example`, `env.local.example` ‚Äî –ø—Ä–∏–º–µ—Ä AI –Ω–∞—Å—Ç—Ä–æ–µ–∫ **–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é:** - `/?track=ECMU5566195&photos=1` ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ --- ### 19. –°–∏—Å—Ç–µ–º–∞ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π –∏ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ª—É–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (24.01.2026) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** - –î–æ–±–∞–≤–ª–µ–Ω—ã **—É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π** (`CompanyService`) –∏ —Ç–∏–ø `COMPANY` –¥–ª—è `CarService` - –ö–æ–º–ø–∞–Ω–∏—è —Å—Ç–∞–ª–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥ (–≤–∫–ª—é—á–∞—è –¥–æ–±–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\LOGIST2_PROGRESS_REPORT.md", "content": "6) **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ **–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** - –î–æ–±–∞–≤–ª–µ–Ω—ã **—É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π** (`CompanyService`) –∏ —Ç–∏–ø `COMPANY` –¥–ª—è `CarService` - –ö–æ–º–ø–∞–Ω–∏—è —Å—Ç–∞–ª–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥ (–≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –∫ –¢–°) - –î–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–π –∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `add_by_default` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥: —É—Å–ª—É–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–æ–ª—å—à–µ **–Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¢–°** - –í –∫–∞—Ä—Ç–æ—á–∫–µ –¢–° –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ \"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏\" —Å –º–æ–¥–∞–ª—å–Ω—ã–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º - –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ —É –ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ —É—Å–ª—É–≥ –Ω–µ—Ç) **–§–∞–π–ª—ã:** - `core/models.py` ‚Äî –º–æ–¥–µ–ª—å CompanyService, —Ç–∏–ø `COMPANY`, —Ä–∞—Å—á—ë—Ç totals - `core/admin.py` ‚Äî –∏–Ω–ª–∞–π–Ω—ã –∏ UI –¥–ª—è CompanyService, –ø—Ä–∞–≤–∫–∏ add_by_default - `core/signals.py` ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ add_by_default —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–° - `core/views.py` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `company` –≤ get_available_services/add_services - `templates/admin/core/car/change_form.html` ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏ - `logist2/urls.py` ‚Äî endpoint `GET /api/companies/` **–ú–∏–≥—Ä–∞—Ü–∏–∏:** - `0099_add_default_flags_line_carrier_services.py` - `0100_add_company_service.py` - `0101_alter_carservice_service_type_and_more.py`", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "# –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê LOGIST2 –î–õ–Ø AI ## –û –ü–†–û–ï–ö–¢–ï **–ù–∞–∑–≤–∞–Ω–∏–µ:** Logist2 (Caromoto Lithuania) **–¢–∏–ø:** Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –¢–°, –∫–ª–∏–µ–Ω—Ç–∞–º–∏, —Å–∫–ª–∞–¥–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏ ### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ - **Backend:** Django 5.1.7 + Python 3.10-3.12 - **Database:** PostgreSQL (—Ç–µ—Å—Ç—ã ‚Äî SQLite —á–µ—Ä–µ–∑ `settings_test.py`) - **API:** Django REST Framework - **Frontend:** Django templates + Bootstrap 5 + HTMX + –∫–∞—Å—Ç–æ–º–Ω—ã–π JS - **WebSockets:** Channels + Daphne (Redis –≤ `settings_base.py`, InMemory –≤ `settings.py`) - **Web Server:** Nginx + Gunicorn, —Å—Ç–∞—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ WhiteNoise - **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç:** Django templates + REST API ### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã - **CRM —Å–∏—Å—Ç–µ–º–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –±–∞–ª–∞–Ω—Å–∞–º–∏ - **–õ–æ–≥–∏—Å—Ç–∏–∫–∞** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –¢–°, —Å–∫–ª–∞–¥—ã, –ª–∏–Ω–∏–∏, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏ - **–ë–∏–ª–ª–∏–Ω–≥** - –∏–Ω–≤–æ–π—Å—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã - **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–æ–≤, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ - **Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ - **–°–∏—Å—Ç–µ–º–∞ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π** - —É—Å–ª—É–≥–∏ Company (Caromoto Lithuania) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø ## VPS –°–ï–†–í–ï–† **IP:** 176.118.198.78 **SSH:** `root@176.118.198.78` **–î–æ–º–µ–Ω:** https://caromoto-lt.com > ‚ö†Ô∏è **–ü–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–ª—É–≥–∏ Company (Caromoto Lithuania) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø ## VPS –°–ï–†–í–ï–† **IP:** 176.118.198.78 **SSH:** `root@176.118.198.78` **–î–æ–º–µ–Ω:** https://caromoto-lt.com > ‚ö†Ô∏è **–ü–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `CREDENTIALS.md` (–Ω–µ –≤ git) ### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ ``` –ü—Ä–æ–µ–∫—Ç: /var/www/www-root/data/www/logist2 Virtualenv: /var/www/www-root/data/www/logist2/.venv Media: /var/www/www-root/data/www/logist2/media Static: /var/www/www-root/data/www/logist2/staticfiles ``` ### –°–µ—Ä–≤–∏—Å—ã ```bash # Gunicorn (Django application) systemctl restart gunicorn systemctl status gunicorn # Daphne (WebSockets) systemctl restart daphne systemctl status daphne # Nginx systemctl reload nginx nginx -t ``` ### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ``` –§–∞–π–ª: /etc/nginx/vhosts/www-root/176.118.198.78.conf location /media/ { alias /var/www/www-root/data/www/logist2/media/; } location /static/ { alias /var/www/www-root/data/www/logist2/staticfiles/; } ``` ## –î–ï–ü–õ–û–ô ### –°–ø–æ—Å–æ–± 1: PowerShell —Å–∫—Ä–∏–ø—Ç (—Å Windows) ```powershell .\\deploy.ps1 ``` ### –°–ø–æ—Å–æ–± 2: Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ```bash ssh root@176.118.198.78 cd /var/www/www-root/data/www/logist2 git pull origin master source .venv/bin/activate python manage.py migrate python manage.py collectstatic --noinput", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": " Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ```bash ssh root@176.118.198.78 cd /var/www/www-root/data/www/logist2 git pull origin master source .venv/bin/activate python manage.py migrate python manage.py collectstatic --noinput systemctl restart gunicorn systemctl restart daphne ``` ### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç deploy.ps1: 1. –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SCP: `core/*`, `logist2/*`, `templates/*` 2. –ó–∞–ø—É—Å–∫–∞–µ—Ç collectstatic 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç gunicorn –∏ daphne ### ‚ö†Ô∏è –í–ê–ñ–ù–û: –ß—Ç–æ –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ: - `.env` —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–∞—Ä–æ–ª–∏ –ë–î) ‚Äî **–±–µ–∑–æ–ø–∞—Å–µ–Ω** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω–∞** - Media —Ñ–∞–π–ª—ã (—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏) ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω—ã** - Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚Äî **–±–µ–∑–æ–ø–∞—Å–Ω–∞** ## –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ``` logist2/ ‚îú‚îÄ‚îÄ core/ # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚îÇ ‚îú‚îÄ‚îÄ models.py # –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Container, Car, Client, etc) ‚îÇ ‚îú‚îÄ‚îÄ models_website.py # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îú‚îÄ‚îÄ models_billing.py # –ë–∏–ª–ª–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–∞ ‚îÇ ‚îú‚îÄ‚îÄ admin.py # Django Admin –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚îÇ ‚îú‚îÄ‚îÄ admin_website.py # Admin –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îú‚îÄ‚îÄ views.py # Views –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ ‚îÇ ‚îú‚îÄ‚îÄ views_website.py # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îú‚îÄ‚îÄ google_drive_sync.py # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive ‚îÇ ‚îú‚îÄ‚îÄ management/commands/ # Management –∫–æ–º–∞–Ω–¥—ã ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ add_performance_indexes.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ ap", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": " ‚îú‚îÄ‚îÄ views_website.py # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îú‚îÄ‚îÄ google_drive_sync.py # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive ‚îÇ ‚îú‚îÄ‚îÄ management/commands/ # Management –∫–æ–º–∞–Ω–¥—ã ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ add_performance_indexes.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ apply_optimizations.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ check_photo_environment.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ cleanup_broken_photos.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ create_default_company.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ fix_photo_names.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ fix_ths_line_services.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ generate_thumbnails.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ init_new_balance_system.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ migrate_services.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ recalculate_car_services.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ recalculate_storage.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ regenerate_thumbnails.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ reset_billing.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ sync_client_balances.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ sync_google_drive_photos.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ sync_photos_gdrive.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ test_invoice_markup.py ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ test_unload_date_inheritance.py ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ update_container_statuses.py ‚îÇ ‚îú‚îÄ‚îÄ services/ # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ ai_chat_service.py # AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î) ‚îÇ ‚îú‚îÄ‚îÄ static/ # –°—Ç–∞—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ ‚îÇ ‚îî‚îÄ‚îÄ templates/ # –®–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏ ‚îú‚îÄ‚îÄ templates/ # –û–±—â–∏–µ —à–∞–±–ª–æ–Ω—ã ‚îÇ ‚îú‚îÄ‚îÄ admin/ # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–¥–º–∏–Ω —à–∞–±–ª–æ–Ω—ã ‚îÇ ‚îî‚îÄ‚îÄ website/ # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç ‚îú‚îÄ‚îÄ media/ # –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã ‚îÇ ‚îú‚îÄ‚îÄ container_photos/ # –§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ thumbnails/ # –ú–∏–Ω–∏–∞—Ç—é—Ä—ã ‚îÇ ‚îú‚îÄ‚îÄ container_archiv", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "‚îÇ ‚îú‚îÄ‚îÄ admin/ # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–¥–º–∏–Ω —à–∞–±–ª–æ–Ω—ã ‚îÇ ‚îî‚îÄ‚îÄ website/ # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç ‚îú‚îÄ‚îÄ media/ # –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã ‚îÇ ‚îú‚îÄ‚îÄ container_photos/ # –§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ thumbnails/ # –ú–∏–Ω–∏–∞—Ç—é—Ä—ã ‚îÇ ‚îú‚îÄ‚îÄ container_archives/ # ZIP –∞—Ä—Ö–∏–≤—ã ‚îÇ ‚îî‚îÄ‚îÄ car_photos/ # –§–æ—Ç–æ –¢–° ‚îú‚îÄ‚îÄ logist2/ # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ ‚îÇ ‚îú‚îÄ‚îÄ settings.py # –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (InMemory Channels) ‚îÇ ‚îú‚îÄ‚îÄ settings_base.py # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Redis Channels) ‚îÇ ‚îú‚îÄ‚îÄ settings_dev.py # Dev-–ø—Ä–æ—Ñ–∏–ª—å ‚îÇ ‚îú‚îÄ‚îÄ settings_prod.py # Prod-–ø—Ä–æ—Ñ–∏–ª—å ‚îÇ ‚îú‚îÄ‚îÄ settings_test.py # Test-–ø—Ä–æ—Ñ–∏–ª—å (SQLite) ‚îÇ ‚îú‚îÄ‚îÄ urls.py # URL routing ‚îÇ ‚îî‚îÄ‚îÄ wsgi.py / asgi.py # WSGI/ASGI ‚îú‚îÄ‚îÄ requirements.txt # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ‚îî‚îÄ‚îÄ requirements_website.txt # –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ``` ## –ö–õ–Æ–ß–ï–í–´–ï –ú–û–î–ï–õ–ò ### Container (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä) - `number` - –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) - `status` - —Å—Ç–∞—Ç—É—Å (FLOATING, IN_PORT, UNLOADED, TRANSFERRED) - `line`, `warehouse`, `client` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏ - `ths`, `ths_payer` - —Å—É–º–º–∞ THS –∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ (LINE/WAREHOUSE) - `planned_unload_date`, `unload_date`, `eta`, `unloaded_status_at` - –∫–ª—é—á–µ–≤—ã–µ –¥–∞—Ç—ã - `customs_procedure`, `sklad`, `dekl`, `proft` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ/legacy –ø–æ–ª—è - `google_drive_folder_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –≤ Google Drive - `", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "`eta`, `unloaded_status_at` - –∫–ª—é—á–µ–≤—ã–µ –¥–∞—Ç—ã - `customs_procedure`, `sklad`, `dekl`, `proft` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ/legacy –ø–æ–ª—è - `google_drive_folder_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –≤ Google Drive - `container_cars` - —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¢–° ### Car (–¢–°) - `vin` - VIN –Ω–æ–º–µ—Ä (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) - `container` - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ —Å 20.10.2025) - `client` - –∫–ª–∏–µ–Ω—Ç-–≤–ª–∞–¥–µ–ª–µ—Ü - `warehouse`, `line`, `carrier` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏ - `vehicle_type` - —Ç–∏–ø –¢–° (11 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) - `status`, `unload_date`, `transfer_date` - —Å—Ç–∞—Ç—É—Å—ã –∏ –¥–∞—Ç—ã - `days`, `storage_cost` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç) - `car_services` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤/–ª–∏–Ω–∏–π/–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ ### CarService (–£—Å–ª—É–≥–∞ –¢–°) - `car` - —Å–≤—è–∑—å —Å –¢–° - `service_type` - —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (WAREHOUSE, LINE, CARRIER, COMPANY) - `service_id` - ID —É—Å–ª—É–≥–∏ (WarehouseService, LineService, CarrierService, CompanyService) - `custom_price` - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π) - `markup_amount` - —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–æ–π—Å–µ) - `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥ - **–ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç –õ–Æ–ë–´–• —Å–∫–ª–∞–¥–æ–≤ –∫ –¢–° (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)** ### CompanyService (–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏) - `company` - —Å–≤—è–∑—å —Å Company (Caromoto Lithuani", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–µ) - `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥ - **–ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç –õ–Æ–ë–´–• —Å–∫–ª–∞–¥–æ–≤ –∫ –¢–° (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)** ### CompanyService (–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏) - `company` - —Å–≤—è–∑—å —Å Company (Caromoto Lithuania –∏ –¥—Ä.) - `name`, `description` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ - `default_price`, `default_markup` - —Ü–µ–Ω–∞ –∏ –Ω–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - `is_active` - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - `add_by_default` - –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ —É—Å–ª—É–≥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ–≤—ã–º –¢–° –∫–æ–º–ø–∞–Ω–∏–∏ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** - `LineService` –∏ `CarrierService` —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —Ñ–ª–∞–≥ `add_by_default` ### ContainerPhoto (–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) - `container` - —Å–≤—è–∑—å —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º - `photo` - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ - `thumbnail` - –º–∏–Ω–∏–∞—Ç—é—Ä–∞ (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) - `is_public` - –¥–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É ### AI-–ø–æ–º–æ—â–Ω–∏–∫ (—á–∞—Ç) - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –ë–î –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å - –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—ã/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è - –í–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ ### NewInvoice (–ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å) - –û–°–ù–û–í–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ë–ò–õ–õ–ò–ù–ì–ê - `number` - –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) - `issuer_*` - –∫—Ç–æ –≤—ã—Å—Ç–∞–≤–∏–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å Company, Warehouse, Line, Carrier) - `recipient_*` - –∫–æ–º—É –≤—ã—Å—Ç–∞–≤–ª–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å Client, Compa", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–ê –ë–ò–õ–õ–ò–ù–ì–ê - `number` - –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) - `issuer_*` - –∫—Ç–æ –≤—ã—Å—Ç–∞–≤–∏–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å Company, Warehouse, Line, Carrier) - `recipient_*` - –∫–æ–º—É –≤—ã—Å—Ç–∞–≤–ª–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å Client, Company, Warehouse, Line, Carrier) - `cars` - ManyToMany —Å–≤—è–∑—å —Å –¢–° - `items` - –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —É—Å–ª—É–≥ –¢–°) - **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¢–° –∏–Ω–≤–æ–π—Å –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª ### InvoiceItem (–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞) - `invoice` - —Å–≤—è–∑—å —Å –∏–Ω–≤–æ–π—Å–æ–º - `car` - —Å–≤—è–∑—å —Å –¢–° (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - `description` - –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ - `quantity` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - `unit_price` - —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É - `total_price` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è (quantity √ó unit_price) **–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –æ—Ç Caromoto Lithuania –∫–ª–∏–µ–Ω—Ç—É:** 1. –•—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è Company): `{car.days} –¥–Ω–µ–π √ó —Å—Ç–∞–≤–∫–∞ –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\"` + —Å—Ç–∞—Ç—É—Å `[–ü–µ—Ä–µ–¥–∞–Ω]` –∏–ª–∏ `[–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ]` 2. –í—Å–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ (–æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤, –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ) 3. –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π 4. –í—Å–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ 5. –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ü–µ–Ω—ã —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ `markup_amount` (–æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è) ## API ENDPOINTS ### –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –¢–°: - `GET /api/warehouses/` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ - `GET /api/car/<car", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ü–µ–Ω—ã —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ `markup_amount` (–æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è) ## API ENDPOINTS ### –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –¢–°: - `GET /api/warehouses/` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ - `GET /api/car/<car_id>/get_available_services/?type=warehouse&warehouse_id=<id>` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ - `GET /api/companies/` - —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π - `GET /api/car/<car_id>/get_available_services/?type=company&company_id=<id>` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ - `POST /api/car/<car_id>/add_services/` - –¥–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫ –¢–° - `GET /core/api/search-counterparties/` - –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤ - `GET /core/api/search-cars/` - –ø–æ–∏—Å–∫ –¢–° –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤ ### –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞: - `POST /api/track/` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –ø–æ VIN –∏–ª–∏ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - `GET /api/container-photos/<container_number>/` - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - `POST /api/download-photos-archive/` - —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π - `POST /api/ai-chat/` - AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î, –±–ª–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤) ### –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é: - `/?track=<–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ ## GOOGLE DRIVE –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ Google Drive: ``` –ì–ª–∞–≤–Ω–∞—è –ø–∞–ø–∫–∞: https://drive.google.com/drive/u/1/folders/1Pk", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ ## GOOGLE DRIVE –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ Google Drive: ``` –ì–ª–∞–≤–Ω–∞—è –ø–∞–ø–∫–∞: https://drive.google.com/drive/u/1/folders/1PkrfxocilDZjDaT3R1SQ9DflyWBBFNpW ‚îú‚îÄ‚îÄ AUTO I≈† KONTO (–í–´–ì–†–£–ñ–ï–ù–ù–´–ï) ‚îÇ ‚îî‚îÄ‚îÄ [–º–µ—Å—è—Ü]/[–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞]/[—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏] ‚îÇ ‚îî‚îÄ‚îÄ KONTO VIDUS (–í –ö–û–ù–¢–ï–ô–ù–ï–†–ï) ‚îî‚îÄ‚îÄ [–º–µ—Å—è—Ü]/[–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞]/[—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏] ``` ### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞: 1. –í –∞–¥–º–∏–Ω–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–∞–ø–∫—É Google Drive 2. –ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É \"üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive\" 3. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–≤ —Ñ–æ–Ω–µ) 4. –ú–∏–Ω–∏–∞—Ç—é—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 5. –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è ## –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ ### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: ```bash # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ssh root@176.118.198.78 # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ–µ–∫—Ç cd /var/www/www-root/data/www/logist2 source .venv/bin/activate # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π python manage.py check_photo_environment # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä python manage.py regenerate_thumbnails python manage.py regenerate_thumbnails --force # –£–¥–∞–ª–µ–Ω–∏–µ –±–∏—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π python manage.py cleanup_broken_photos python manage.py cleanup_broken_photos --delete # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è –∫–æ–º", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": " regenerate_thumbnails --force # –£–¥–∞–ª–µ–Ω–∏–µ –±–∏—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π python manage.py cleanup_broken_photos python manage.py cleanup_broken_photos --delete # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è –∫–æ–º–∞–Ω–¥–∞) python manage.py sync_google_drive_photos # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —Å Google Drive (–ù–û–í–ê–Ø - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) python manage.py sync_photos_gdrive --no-photos # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ python manage.py sync_photos_gdrive --recent # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (14 –¥–Ω–µ–π) python manage.py sync_photos_gdrive --container ECMU5566195 # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä python manage.py sync_photos_gdrive --verbose # –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–í–ê–ñ–ù–û!) ./fix_media_permissions.sh # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ journalctl -u gunicorn -f journalctl -u daphne -f # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Python find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true ``` ### –õ–æ–∫–∞–ª—å–Ω–æ: ```powershell # –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ .\\START_ME.bat # –î–µ–ø–ª–æ–π –Ω–∞ VPS .\\deploy.ps1 # –ú–∏–≥—Ä–∞—Ü–∏–∏ python manage.py makemigrations python manage.py migrate ``` ## EMAIL –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê–ú (–î–µ–∫–∞–±—Ä—å 2025) ### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: - **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã –≤ –ø", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "py makemigrations python manage.py migrate ``` ## EMAIL –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê–ú (–î–µ–∫–∞–±—Ä—å 2025) ### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: - **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã –≤ –ø–æ–ª–µ \"–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\" - **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ - –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º, —á—å–∏ –¢–° –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ - –í –ø–∏—Å—å–º–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¢–° –∫–ª–∏–µ–Ω—Ç–∞ (VIN, –º–∞—Ä–∫–∞, –≥–æ–¥) - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—á–µ—Ä–µ–∑ NotificationLog) ### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—è—Ö: **Client (core/models.py):** - `email` ‚Äî Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - `notification_enabled` ‚Äî –§–ª–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True) **Container (core/models.py):** - `planned_unload_date` ‚Äî \"–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\" (–ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ) **NotificationLog (core/models_website.py):** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –¢–∏–ø—ã: PLANNED (–ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞), UNLOADED (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞) - –•—Ä–∞–Ω–∏—Ç: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–ª–∏–µ–Ω—Ç, email, —Å–ø–∏—Å–æ–∫ –¢–°, —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏, –æ—à–∏–±–∫–∏ ### –§–∞–π–ª—ã: ``` core/services/email_service.py # –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π core/signals.py # –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ templates/email/planned_notification.html # –®–∞–±–ª–æ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏, –æ—à–∏–±–∫–∏ ### –§–∞–π–ª—ã: ``` core/services/email_service.py # –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π core/signals.py # –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ templates/email/planned_notification.html # –®–∞–±–ª–æ–Ω –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–∏ templates/email/unload_notification.html # –®–∞–±–ª–æ–Ω —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ``` ### SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ .env) ‚Äî —á–µ—Ä–µ–∑ Brevo: ``` EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend EMAIL_HOST=smtp-relay.brevo.com EMAIL_PORT=587 EMAIL_USE_TLS=True # –ü–∞—Ä–æ–ª–∏ –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md ``` ### –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∏—Å—å–º–∞—Ö (settings_base.py): ``` COMPANY_NAME = 'Caromoto Lithuania' COMPANY_PHONE = '+37068830450' COMPANY_EMAIL = 'lithuania@caromoto.com' COMPANY_WEBSITE = 'https://caromoto-lt.com' ``` ### Brevo (–±—ã–≤—à–∏–π Sendinblue): - **–ê–∫–∫–∞—É–Ω—Ç:** Caromoto Lithuania - **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ:** 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å - **–î–æ–º–µ–Ω:** caromoto-lt.com ‚úÖ **Authenticated** - **DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Hostika.LT** (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–º–µ–Ω–∞): - TXT: `brevo-code:6113c7d9b16365464c534b6bff2e13b6` - CNAME: `brevo1._domainkey` ‚Üí `b1.caromoto-lt-com.dkim.brevo.com` - CNAME: `brevo2._domainkey` ‚Üí `b2.caromoto-lt-com.dkim.brevo.com` - TXT: `_dmarc` ‚Üí `v=DMARC1; p=none; rua=mailto:rua@dmarc.brevo.com` - **–ü–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "`brevo1._domainkey` ‚Üí `b1.caromoto-lt-com.dkim.brevo.com` - CNAME: `brevo2._domainkey` ‚Üí `b2.caromoto-lt-com.dkim.brevo.com` - TXT: `_dmarc` ‚Üí `v=DMARC1; p=none; rua=mailto:rua@dmarc.brevo.com` - **–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** https://app.brevo.com - **–¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:** SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–ª–∞—Ç–Ω–æ, ~0.05-0.08‚Ç¨/SMS) ### –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: - **üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ - **üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ** ‚Äî —Ä—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ ### –°—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–µ–∫–∞–±—Ä—å 2025): - ‚úÖ –ü–µ—Ä–µ—à–ª–∏ –Ω–∞ Brevo (–±—ã–≤—à–∏–π Sendinblue) –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ - ‚úÖ SMTP –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ smtp-relay.brevo.com - ‚úÖ DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Hostika.LT (DKIM, DMARC, Brevo code) - ‚úÖ –î–æ–º–µ–Ω caromoto-lt.com –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –≤ Brevo - ‚úÖ Gmail –∏ –¥—Ä—É–≥–∏–µ –ø–æ—á—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç ### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É email: 1. –ê–¥–º–∏–Ω–∫–∞ ‚Üí –ö–ª–∏–µ–Ω—Ç—ã ‚Üí –≤—ã–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ 2. –í —Ä–∞–∑–¥–µ–ª–µ \"–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\" —É–∫–∞–∑–∞—Ç—å Email –∏ –≤–∫–ª—é—á–∏—Ç—å \"–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\" --- ## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï ### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç: ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è CRM —Å–∏—Å—Ç–µ–º–∞ ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–° ‚úÖ –ë–∏–ª–ª–∏–Ω–≥ –∏ –±–∞–ª–∞–Ω—Å—ã ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª ‚úÖ Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π) ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä ‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º (—á–µ—Ä–µ–∑ Brevo SM", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–∞ ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –¢–° ‚úÖ –ë–∏–ª–ª–∏–Ω–≥ –∏ –±–∞–ª–∞–Ω—Å—ã ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª ‚úÖ Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π) ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä ‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º (—á–µ—Ä–µ–∑ Brevo SMTP) ### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: ‚ö†Ô∏è SSH connection timeout –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö ‚ö†Ô∏è –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –µ—Å–ª–∏ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è ‚ö†Ô∏è –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Google Drive - –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å 1-2 –º–∏–Ω—É—Ç—ã ‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤—Ä—É—á–Ω—É—é (—á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –æ—Ç root) –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `./fix_media_permissions.sh` ### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—è–Ω–≤–∞—Ä—å 2026): **21.01.2026 - –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:** 1. **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° GOOGLE DRIVE:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Google Drive –ø–æ –Ω–æ–º–µ—Ä—É - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–ø–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ - ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø–∞–º: IN_CONTAINER (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ) –∏ UNLOADING (–≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ) - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É Google Drive - ‚úÖ Management –∫–æ–º–∞–Ω–¥–∞ `sync_photos_gdrive` —Å —Ä–µ–∂–∏–º–∞–º–∏: --no-photos, --recent, --container - ‚úÖ Cron –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 2. **–ì–ê–õ–ï–†–ï–Ø –í –ê–î–ú–ò–ù–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê:** - ‚úÖ –°–≤—ë—Ä–Ω—É—Ç–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≥–∞–ª", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "nagement –∫–æ–º–∞–Ω–¥–∞ `sync_photos_gdrive` —Å —Ä–µ–∂–∏–º–∞–º–∏: --no-photos, --recent, --container - ‚úÖ Cron –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 2. **–ì–ê–õ–ï–†–ï–Ø –í –ê–î–ú–ò–ù–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê:** - ‚úÖ –°–≤—ë—Ä–Ω—É—Ç–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≥–∞–ª–µ—Ä–µ—è (–±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) - ‚úÖ AJAX –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ - ‚úÖ –í–∫–ª–∞–¥–∫–∏ \"–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ\" –∏ \"–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ\" - ‚úÖ Lazy loading –º–∏–Ω–∏–∞—Ç—é—Ä - ‚úÖ Lightbox —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π 3. **–ì–ê–õ–ï–†–ï–Ø –ù–ê –ö–õ–ò–ï–ù–¢–°–ö–û–ú –°–ê–ô–¢–ï:** - ‚úÖ –í–∫–ª–∞–¥–∫–∏ \"–í—Å–µ\", \"–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ\", \"–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ\" - ‚úÖ –í—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è - ‚úÖ –ö–Ω–æ–ø–∫–∞ \"–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ\" (–∑–µ–ª—ë–Ω–∞—è) - ‚úÖ Lightbox —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ - ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (drag –ø—Ä–∏ –∑–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏) 4. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–ò–°–ö–ê:** - ‚úÖ –£–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `current_price` –∏–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ - ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VIN –ø—Ä–∏ –ø–æ–∏—Å–∫–µ - ‚úÖ –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é VIN 5. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï URL –§–û–¢–û–ì–†–ê–§–ò–ô –ù–ê VPS:** - ‚úÖ –§–æ—Ç–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏–∫–æ–Ω–∫–∞ –ø–æ–ª–æ–º–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏) - ‚úÖ –ü—Ä–∏—á–∏–Ω–∞: API –≤–æ–∑–≤—Ä–∞—â–∞–ª URL –±–µ–∑ `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–∞ - ‚úÖ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –≤ `views.py` –∏ `views_website.py` - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`) 6. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï HOVER-–≠–§–§–ï–ö–¢–ê –ö–ù–û–ü–û–ö:** - ‚úÖ –£–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `/media/` –≤ `views.py` –∏ `views_website.py` - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (`chown -R www-root:www-root`) 6. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï HOVER-–≠–§–§–ï–ö–¢–ê –ö–ù–û–ü–û–ö:** - ‚úÖ –£–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ - ‚úÖ –ó–∞–º–µ–Ω—ë–Ω `transition: all` –Ω–∞ `transition: opacity` (—É–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É) - ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π hover-—ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–æ—Å—Ç–æ–π `opacity: 0.85` - ‚úÖ –§–∞–π–ª: `core/static/website/css/style.css` 7. **–£–õ–£–ß–®–ï–ù–ò–ï LIGHTBOX –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í:** - ‚úÖ –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å—Ç–∞–ª–∏ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ (35% –≤–º–µ—Å—Ç–æ 90%) - ‚úÖ –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑—É–º–µ > 1, –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∑—É–º–∞ - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω pinch-to-zoom (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏) - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º –ø—Ä–∏ –∑—É–º–µ - ‚úÖ –§–∞–π–ª: `templates/website/home.html` **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** - `core/google_drive_sync.py` - –∞–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–∞–ø–æ–∫, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º - `core/management/commands/sync_photos_gdrive.py` - –Ω–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã - `core/views.py` - API endpoint –¥–ª—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ - `core/views_website.py` - —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫, API –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ñ–æ—Ç–æ - `core/serializers_website.py` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ current_price - `templates/admin/core/container/change_form.html` - –∫–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - `tem", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "s_website.py` - —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫, API –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ñ–æ—Ç–æ - `core/serializers_website.py` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ current_price - `templates/admin/core/container/change_form.html` - –∫–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - `templates/admin/core/container/photos_gallery.html` - AJAX –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ - `templates/website/home.html` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≥–∞–ª–µ—Ä–µ—è —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ –∏ lightbox - `sync_photos_cron.sh` - cron —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - `core/static/website/css/style.css` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω hover-—ç—Ñ—Ñ–µ–∫—Ç –∫–Ω–æ–ø–æ–∫ (—É–±—Ä–∞–Ω–æ –º–∏–≥–∞–Ω–∏–µ) **23.01.2026 - AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ:** 1. **AI-–ß–ê–¢:** –ø–æ–¥–∫–ª—é—á—ë–Ω —á–∞—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ 2. **–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–î:** VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ 3. **–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –§–ò–ù–ê–ù–°–û–í:** –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—É/–±–∞–ª–∞–Ω—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è 4. **–ì–ê–õ–ï–†–ï–Ø –§–û–¢–û:** —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ `/?track=<–Ω–æ–º–µ—Ä>&photos=1` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** - `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI - `core/views_website.py` ‚Äî endpoint AI –∏ –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ç–æ/–≥–∞–ª–µ—Ä–µ–∏ - `core/static/website/js/ai-chat.js` ‚Äî CSRF –∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ - `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ - `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞ - `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ - `templates/admin/base_site.html` ‚Äî –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ - `core/static/admin/css/ai-chat.css` ‚Äî —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–≤–∏–¥–∂–µ—Ç–∞ - `logist2/settings.py`, `logist2/settings_base.py` ‚Äî AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - `env.example`, `env.local.example` ‚Äî –ø—Ä–∏–º–µ—Ä—ã AI –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö --- ### –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–µ–∫–∞–±—Ä—å 2025): **13.12.2025 - Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º:** 1. **–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –†–ê–ó–ì–†–£–ó–ö–ï –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:** ‚≠ê –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ - ‚úÖ –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ - ‚úÖ –í –ø–∏—Å—å–º–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¢–° –∫–ª–∏–µ–Ω—Ç–∞ (VIN, –º–∞—Ä–∫–∞, –≥–æ–¥) - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ NotificationLog - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ - ‚úÖ –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ 2. **–ù–û–í–´–ï –ú–û–î–ï–õ–ò –ò –ü–û–õ–Ø:** - `Client.email` ‚Äî email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - `Client.notification_enabled` ‚Äî —Ñ–ª–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - `Container.planned_unload_date` ‚Äî \"–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\" - `NotificationLog` ‚Äî –∂—É—Ä–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π 3. **SMTP –ù–ê–°–¢–†–û–ô–ö–ê (—á–µ—Ä–µ–∑ Brevo):** - ~~–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä~~ ‚Üí –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ **Brevo** (–±—ã–≤—à–∏–π Sendinblue) - –ü—Ä–∏—á–∏–Ω–∞: Gmail ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\" - `NotificationLog` ‚Äî –∂—É—Ä–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π 3. **SMTP –ù–ê–°–¢–†–û–ô–ö–ê (—á–µ—Ä–µ–∑ Brevo):** - ~~–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä~~ ‚Üí –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ **Brevo** (–±—ã–≤—à–∏–π Sendinblue) - –ü—Ä–∏—á–∏–Ω–∞: Gmail –æ—Ç–∫–ª–æ–Ω—è–ª –ø–∏—Å—å–º–∞ –±–µ–∑ PTR –∑–∞–ø–∏—Å–∏ - Brevo –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É (95-99%) - –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å - DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è DKIM/DMARC –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ISPmanager - ‚è≥ –û–∂–∏–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–∞ –≤ Brevo **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** - `core/models.py` ‚Äî –Ω–æ–≤—ã–µ –ø–æ–ª—è Client –∏ Container - `core/models_website.py` ‚Äî –º–æ–¥–µ–ª—å NotificationLog - `core/services/email_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–æ–≤—ã–π —Ñ–∞–π–ª) - `core/signals.py` ‚Äî —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ - `core/admin.py` ‚Äî –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π - `core/admin_website.py` ‚Äî –∞–¥–º–∏–Ω–∫–∞ NotificationLog - `logist2/settings_base.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ email - `templates/email/planned_notification.html` ‚Äî —à–∞–±–ª–æ–Ω (–Ω–æ–≤—ã–π) - `templates/email/unload_notification.html` ‚Äî —à–∞–±–ª–æ–Ω (–Ω–æ–≤—ã–π) --- ### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ–∫—Ç—è–±—Ä—å 2025): **21.10.2025 - –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:** 1. **–ù–ê–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ê–¢–´ –†–ê–ó–ì–†–£–ó–ö–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê:** –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤—Å–µ–º–∏ –¢–° - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ —Å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:** 1. **–ù–ê–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ê–¢–´ –†–ê–ó–ì–†–£–ó–ö–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê:** –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤—Å–µ–º–∏ –¢–° - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ —Å–∏–≥–Ω–∞–ª `post_save` –¥–ª—è Container - —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –õ–Æ–ë–û–ú —Å–ø–æ—Å–æ–±–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ —É–ª—É—á—à–µ–Ω –∫–æ–¥ –≤ `ContainerAdmin.save_model()` –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ - –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `if not car.unload_date:` - —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –í–°–ï –¢–° –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ - –£–ª—É—á—à–µ–Ω—ã –º–µ—Ç–æ–¥—ã `Container.sync_cars_after_warehouse_change()` –∏ `sync_cars_after_edit()` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `Car.save()` - –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `ContainerAdmin.save_formset()` - –Ω–æ–≤—ã–µ –¢–° –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—é—Ç –¥–∞—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `test_unload_date_inheritance` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ü—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—Å–µ –¢–° –≤ –Ω—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —ç—Ç—É –¥–∞—Ç—É 2. **–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:** ‚ö° - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `bulk_update()` –≤–º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–° –≤ —Ü–∏–∫–ª–µ (–æ–¥–Ω–∏–º SQL –∑–∞–ø—Ä–æ—Å–æ–º) - –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ - –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¢–° (–≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ) - –î–æ–±–∞–≤–ª–µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": " (–æ–¥–Ω–∏–º SQL –∑–∞–ø—Ä–æ—Å–æ–º) - –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ - –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¢–° (–≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ) - –î–æ–±–∞–≤–ª–µ–Ω `select_related('warehouse')` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å 20+ –¢–° —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 10-20 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ 3. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–¶–ï–ù–ö–ò –í –ò–ù–í–û–ô–°–ê–•:** - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ Caromoto Lithuania –∫–∞–∫ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –≤ `NewInvoiceAdmin.save_model()` - ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `test_invoice_markup` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ü–µ–Ω–∫–∏ - ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –∏–Ω–≤–æ–π—Å—ã 4. **–£–õ–£–ß–®–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê –ê–î–ú–ò–ù–ö–ò:** - ‚úÖ –£–¥–∞–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü \"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫\" –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–° (–Ω–µ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ \"–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è\" –≤ –º–µ–Ω—é Actions –¥–ª—è –¢–° - –ú–∞—Å—Å–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ \"–ü–µ—Ä–µ–¥–∞–Ω\" —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π - –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¢–° - ‚úÖ –£–¥–∞–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–° 5. **–¢–ï–°–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´:** - `python manage.py test_unload_date_inheritance` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ - `python manage.py test_invoic", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—ã–±–æ—Ä–∞ –¢–° - ‚úÖ –£–¥–∞–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ –¢–° 5. **–¢–ï–°–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´:** - `python manage.py test_unload_date_inheritance` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ - `python manage.py test_invoice_markup` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ –≤ –∏–Ω–≤–æ–π—Å—ã **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** - `core/admin.py` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ \"–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è\" - `core/models.py` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ - `core/signals.py` - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - `core/admin_billing.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ Caromoto Lithuania - `core/models_billing.py` - —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ **20.10.2025 - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î, —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–≤–æ–π—Å–æ–≤:** 1. **–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–î:** - ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è production –ë–î –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä —á–µ—Ä–µ–∑ `pg_dump`/`pg_restore` - ‚úÖ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è 2. **–£–°–õ–£–ì–ò –°–ö–õ–ê–î–û–í:** - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª—É–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –∫ –æ–¥–Ω–æ–º—É –¢–° - –ò–∑–º–µ–Ω–µ–Ω `get_warehouse_services()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ - –î–æ–±–∞–≤–ª–µ–Ω API endpoint `/api/warehouses/` –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ - –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "get_warehouse_services()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ - –î–æ–±–∞–≤–ª–µ–Ω API endpoint `/api/warehouses/` –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ - –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥–∏–µ - –∂–µ–ª—Ç—ã–π) - –í—Å–µ —É—Å–ª—É–≥–∏ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –≤ –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å 3. **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–°–ß–ï–¢ –ò–ù–í–û–ô–°–û–í:** ‚≠ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª** `update_related_on_car_save` - —É–±—Ä–∞–Ω `return` –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ NewInvoice - ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¢–°: - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏ - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ - ‚úÖ **–ù–∞—Ü–µ–Ω–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è** –≤ –∏–Ω–≤–æ–π—Å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è - ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π - ‚úÖ **–°—Ç–∞—Ç—É—Å –≤ –æ–ø–∏—Å–∞–Ω–∏–∏:** `[–ü–µ—Ä–µ–¥–∞–Ω –î–ê–¢–ê]` –∏–ª–∏ `[–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –î–ê–¢–ê]` - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ 4. **–î–†–£–ì–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:** - ‚úÖ **–ü–û–õ–ï CONTAINER:** –°–¥–µ–ª–∞–Ω–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –≤ –º–æ–¥–µ–ª–∏ Car (–º–∏–≥—Ä–∞—Ü–∏—è 0080) - ‚úÖ **–§–û–ù–û–í–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º —Ñ–æ–Ω–æ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∞–π—Ç–∞ - –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ `core/static/website/images/` - –î–æ–±–∞–≤–ª–µ–Ω—ã `hero-backgrou", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "ar (–º–∏–≥—Ä–∞—Ü–∏—è 0080) - ‚úÖ **–§–û–ù–û–í–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º —Ñ–æ–Ω–æ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∞–π—Ç–∞ - –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ `core/static/website/images/` - –î–æ–±–∞–≤–ª–µ–Ω—ã `hero-background.jpg` –∏ `caromoto_logo.png` **–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive - –£–ª—É—á—à–µ–Ω–∞ –∞–¥–º–∏–Ω–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è - **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä –Ω–∞ VPS (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞) - –î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `fix_media_permissions.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ - **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å Google Drive (—Å—É—Ñ—Ñ–∏–∫—Å—ã) - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `fix_photo_names` –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π ## üî¥ –ê–ö–¢–ò–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (20.10.2025) ### ‚ö†Ô∏è –ù–ï–†–ï–®–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä –≤ Django –∞–¥–º–∏–Ω–∫–µ –Ω–∞ VPS **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:** - –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä - –§–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Nginx - –í Python –∫–æ–¥–µ Django –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL —Å `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–æ–º - –í –º–µ—Ç–æ–¥–µ `image_preview` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `_safe_media_url` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—É—Ç–µ–π - **–ù–û –≤ HTML –∞–¥–º–∏–Ω–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏** (`/container_ph", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL —Å `/media/` –ø—Ä–µ—Ñ–∏–∫—Å–æ–º - –í –º–µ—Ç–æ–¥–µ `image_preview` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `_safe_media_url` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—É—Ç–µ–π - **–ù–û –≤ HTML –∞–¥–º–∏–Ω–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏** (`/container_photos/...` –±–µ–∑ `/media/`) **–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–æ–±–æ–≤–∞–Ω–æ:** 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Ñ–∞–π–ª–æ–≤ (`chown www-data:www-data`) 2. ‚úÖ –£–±—Ä–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π `CustomFileSystemStorage` –∏–∑ `settings.py` 3. ‚úÖ –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `MEDIA_URL`/`MEDIA_ROOT` 4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_safe_media_url()` –≤ `ContainerPhotoAdmin` 5. ‚úÖ –£–±—Ä–∞–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è URL –≤ –º–µ—Ç–æ–¥–µ `save()` –º–æ–¥–µ–ª–∏ `ContainerPhoto` 6. ‚úÖ –£–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç `MediaFileInput` widget 7. ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã: `regenerate_thumbnails`, `fix_photo_names`, `cleanup_broken_photos` **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞:** ```python # Python –∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ü–†–ê–í–ò–õ–¨–ù–´–ï URL: obj.thumbnail.url -> '/media/container_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg' image_preview(obj) -> '<img src=\"/media/container_photos/...\" />' # –ù–û –≤ HTML –±—Ä–∞—É–∑–µ—Ä–∞: <img src=\"/container_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg\" /> ``` **–í—ã–≤–æ–¥:** - –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ Python –∫–æ–¥–µ Django (–æ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL) - –ü—Ä–æ–±–ª–µ–º–∞ –≥–¥–µ-—Ç–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç-—Å–∞–π–¥–∞ ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "er_photos/2025/10/19/thumb_IMG_20251015_101923806.jpg\" /> ``` **–í—ã–≤–æ–¥:** - –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ Python –∫–æ–¥–µ Django (–æ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL) - –ü—Ä–æ–±–ª–µ–º–∞ –≥–¥–µ-—Ç–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç-—Å–∞–π–¥–∞ - –í–æ–∑–º–æ–∂–Ω–æ: JavaScript, –∫–∞—Å—Ç–æ–º–Ω—ã–µ admin templates, –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è middleware - –¢—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è **–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π:** - `logist2/settings.py` - —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π storage - `core/admin_website.py` - –¥–æ–±–∞–≤–ª–µ–Ω `_safe_media_url()`, —É–±—Ä–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π import - `core/models_website.py` - —É–±—Ä–∞–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è URL –≤ `save()` **–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤:** - `core/signals.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `update_related_on_car_save`, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ NewInvoice - `core/models_billing.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Ü–µ–Ω–∫–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏, –∞–≤—Ç–æ–ø–µ—Ä–µ—Å—á–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è - `core/models.py` - `get_warehouse_services()` –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –æ—Ç –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ ## –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL ``` DB_NAME=logist2_db DB_USER=arturas DB_HOST=localhost DB_PORT=5432 # –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md ``` ### Django Superuser (–∞–¥–º–∏–Ω–∫–∞) ``` Username: arturas URL: https://caromoto-lt.com/admin/ # –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md ``` ### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ ``` Nginx: www", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md ``` ### Django Superuser (–∞–¥–º–∏–Ω–∫–∞) ``` Username: arturas URL: https://caromoto-lt.com/admin/ # –ü–∞—Ä–æ–ª—å –≤ —Ñ–∞–π–ª–µ CREDENTIALS.md ``` ### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ ``` Nginx: www-data –∏–ª–∏ www-root Gunicorn: www-root ``` ### AI —á–∞—Ç (–≤ `.env`) ``` AI_CHAT_ENABLED=True AI_API_KEY=... AI_API_BASE_URL=https://api.openai.com/v1 AI_MODEL=gpt-4o-mini AI_MAX_TOKENS=400 AI_TEMPERATURE=0.2 AI_REQUEST_TIMEOUT=40 ``` ### –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã ```bash # Media —Ñ–∞–π–ª—ã chown -R www-root:www-root media/ chmod -R 755 media/ # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ chmod -R 775 media/container_photos/ chmod -R 775 media/container_archives/ ``` ## ‚ö†Ô∏è POWERSHELL –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø (–í–ê–ñ–ù–û!) –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ Shell tool –Ω–∞ Windows –ø–æ–º–Ω–∏: ### –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ PowerShell: - `&&` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `;` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã - `cd path && command` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `Set-Location` –∏–ª–∏ –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏ - –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ `\"...'...'...\"` ‚Äî –ø—Ä–æ–±–ª–µ–º—ã —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º - –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ SSH ‚Äî –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –ª–æ–º–∞–µ—Ç—Å—è - –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ heredoc `<< EOF` ‚Äî –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - `$variable` –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî PowerShell –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ —Å–≤–æ—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ### –ü–†–ê–í–ò–õ–¨–ù–´–ï –ü–û–î–•–û–î–´: **–î–ª—è SSH –∫–æ–º–∞–Ω–¥:** ```powershell # –ü–õ–û–•–û: ssh root@server \"cd /path && p", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "`<< EOF` ‚Äî –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - `$variable` –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî PowerShell –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ —Å–≤–æ—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ### –ü–†–ê–í–ò–õ–¨–ù–´–ï –ü–û–î–•–û–î–´: **–î–ª—è SSH –∫–æ–º–∞–Ω–¥:** ```powershell # –ü–õ–û–•–û: ssh root@server \"cd /path && python script.py\" # –•–û–†–û–®–û (–ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã): ssh root@server \"systemctl restart gunicorn\" ssh root@server \"python manage.py migrate\" # –•–û–†–û–®–û (—Å –ø—É—Ç—ë–º): ssh root@server \"cd /var/www/www-root/data/www/logist2; source .venv/bin/activate; python manage.py migrate\" ``` **–î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:** ```powershell # –ü–õ–û–•–û: cd c:\\project && python manage.py runserver # –•–û–†–û–®–û: c:\\project\\.venv\\Scripts\\python.exe c:\\project\\manage.py runserver ``` **–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:** - –ò—Å–ø–æ–ª—å–∑—É–π `deploy.ps1` —Å–∫—Ä–∏–ø—Ç - –ò–ª–∏ –≤—ã–ø–æ–ª–Ω—è–π –∫–æ–º–∞–Ω–¥—ã –ø–æ –æ–¥–Ω–æ–π - –ò–∑–±–µ–≥–∞–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö ‚Äî –ª—É—á—à–µ —Å–æ–∑–¥–∞–π —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ### SSH + Python shell: ```powershell # –ü–õ–û–•–û (–∫–∞–≤—ã—á–∫–∏): ssh root@server \"python -c 'from models import X; print(X.objects.all())'\" # –•–û–†–û–®–û (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞): ssh root@server \"cd /path; source .venv/bin/activate; python manage.py showmigrations\" ``` --- ## –ü–ê–ú–Ø–¢–ö–ê –î–õ–Ø AI 1. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—Å–∏—Ç 2. **–°—Ä–∞–∑—É –¥–µ–ø–ª–æ–π** - –∏–∑–º–µ–Ω–∏ –∫–æ–¥ –∏ –∑–∞–¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ git push 3. **SSH –Ω–µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "/activate; python manage.py showmigrations\" ``` --- ## –ü–ê–ú–Ø–¢–ö–ê –î–õ–Ø AI 1. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—Å–∏—Ç 2. **–°—Ä–∞–∑—É –¥–µ–ø–ª–æ–π** - –∏–∑–º–µ–Ω–∏ –∫–æ–¥ –∏ –∑–∞–¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ git push 3. **SSH –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω** - –µ—Å–ª–∏ timeout, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É 4. **–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è** - Caromoto Lithuania (–≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –Ω–µ–π) 5. **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π gunicorn –∏ daphne 6. **–û—á–∏—â–∞–π __pycache__** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ 7. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î** - –∏—Å–ø–æ–ª—å–∑—É–π pg_dump/pg_restore –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å production 8. **–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç –ª—é–±—ã—Ö —Å–∫–ª–∞–¥–æ–≤ —á–µ—Ä–µ–∑ CarService (–Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ) 9. **–ò–Ω–≤–æ–π—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Car —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ NewInvoice 10. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤** - –µ—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ –Ω–µ—Ç `return` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ 11. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ planned_unload_date –∏–ª–∏ unload_date –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 12. **SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ) 13. **Brevo –¥–ª—è email** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è smtp-relay.brevo.com –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å) 14. **SMS —á–µ—Ä–µ–∑ Bre", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "—Å—Ç—Ä–æ–π–∫–∏** - —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ) 13. **Brevo –¥–ª—è email** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è smtp-relay.brevo.com –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å) 14. **SMS —á–µ—Ä–µ–∑ Brevo** - –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º (–ø–ª–∞—Ç–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–µ phone –≤ Client) ## –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´ ### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (Linux/Bash): ```bash # –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π —Å —Å–µ—Ä–≤–µ—Ä–∞ cd /var/www/www-root/data/www/logist2 && git pull && source .venv/bin/activate && python manage.py migrate && python manage.py collectstatic --noinput && find . -type d -name __pycache__ -delete && systemctl restart gunicorn && systemctl restart daphne # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ systemctl is-active gunicorn daphne nginx # –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ journalctl -u gunicorn -n 50 --no-pager # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π python manage.py check_photo_environment python manage.py regenerate_thumbnails # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ media —Ñ–∞–π–ª–∞–º (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π) ./fix_media_permissions.sh # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö cd /var/www/www-root/data/www/logist2 PGPASSWORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_backup_$(date +%Y%m%d).dump # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ email (—á–µ—Ä–µ–∑ Brevo) journalctl -u gunicorn --since '10 minutes ago'", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": "ORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_backup_$(date +%Y%m%d).dump # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ email (—á–µ—Ä–µ–∑ Brevo) journalctl -u gunicorn --since '10 minutes ago' --no-pager | grep -i email # –ü—Ä–æ–≤–µ—Ä–∫–∞ SMTP –Ω–∞—Å—Ç—Ä–æ–µ–∫ grep EMAIL /var/www/www-root/data/www/logist2/.env # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –≤ –ø–∞–Ω–µ–ª–∏ Brevo: https://app.brevo.com ``` ### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (PowerShell): ```powershell # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä # –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –¥–∞–º–ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ssh root@176.118.198.78 \"cd /var/www/www-root/data/www/logist2 && PGPASSWORD='YOUR_DB_PASSWORD' pg_dump -U arturas -h localhost -d logist2_db -F c -b -f logist2_sync_backup.dump\" # –®–∞–≥ 2: –°–∫–∞—á–∞—Ç—å –¥–∞–º–ø scp root@176.118.198.78:/var/www/www-root/data/www/logist2/logist2_sync_backup.dump . # –®–∞–≥ 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ $env:PGPASSWORD='YOUR_DB_PASSWORD'; pg_restore -U arturas -h localhost -d logist2_db --clean --if-exists logist2_sync_backup.dump # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π .\\.venv\\Scripts\\activate.ps1 py manage.py shell -c \"from core.models import Car, Client, Container; print(f'Cars: {Car.objects.count()}'); print(f'Clients: {Client.objects.count()}'); print(f'Containers", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\AI_PROJECT_CONTEXT.md", "content": ".venv\\Scripts\\activate.ps1 py manage.py shell -c \"from core.models import Car, Client, Container; print(f'Cars: {Car.objects.count()}'); print(f'Clients: {Client.objects.count()}'); print(f'Containers: {Container.objects.count()}')\" ``` ## –†–ï–ü–û–ó–ò–¢–û–†–ò–ô **GitHub:** https://github.com/Arturas7777/logist2.git **Branch:** master --- **–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º.**", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "# –ü–û–õ–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê LOGIST2 **–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 24 —è–Ω–≤–∞—Ä—è 2026 **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏ --- ## üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:** Logist2 (Caromoto Lithuania) **–¢–∏–ø:** Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ä—Å–∫–∏–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏, –¢–°, —Å–∫–ª–∞–¥–∞–º–∏, –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –∏–Ω–≤–æ–π—Å–∞–º–∏ ### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | |-----------|------------| | Backend | Django 5.1.7, Python 3.10-3.12 | | API | Django REST Framework | | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | PostgreSQL (—Ç–µ—Å—Ç—ã ‚Äî SQLite –≤ `settings_test.py`) | | Web-—Å–µ—Ä–≤–µ—Ä | Nginx + Gunicorn, —Å—Ç–∞—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ WhiteNoise | | WebSockets | Django Channels + Daphne (Redis –≤ `settings_base.py`, InMemory –≤ `settings.py`) | | –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | HTMX + –∫–∞—Å—Ç–æ–º–Ω—ã–π JS | | UI —Å–∞–π—Ç–∞ | Bootstrap 5 | | Email | Brevo (SMTP) | | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | Google Drive API | ### –°–µ—Ä–≤–µ—Ä - **IP:** 176.118.198.78 - **–î–æ–º–µ–Ω:** https://caromoto-lt.com - **–ü—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:** `/var/www/www-root/data/www/logist2` --- ## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ò–ï–†–ê–†–•–ò–Ø –î–ê–ù–ù–´–• ### –ì–ª–∞–≤–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è ``` –ö–û–ù–¢–ï–ô–ù–ï–† (Container) ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, \"—Ä–æ–¥–∏—Ç–µ–ª—å\" ‚îÇ ‚îú‚îÄ‚îÄ –ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è (Line) ‚îú‚îÄ‚îÄ –°–∫–ª–∞–¥ (Warehouse) ‚îú‚îÄ‚îÄ THS (—Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –ª–∏–Ω–∏—è–º –∑–∞ –≤", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "--- ## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ò–ï–†–ê–†–•–ò–Ø –î–ê–ù–ù–´–• ### –ì–ª–∞–≤–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è ``` –ö–û–ù–¢–ï–ô–ù–ï–† (Container) ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, \"—Ä–æ–¥–∏—Ç–µ–ª—å\" ‚îÇ ‚îú‚îÄ‚îÄ –ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è (Line) ‚îú‚îÄ‚îÄ –°–∫–ª–∞–¥ (Warehouse) ‚îú‚îÄ‚îÄ THS (—Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –ª–∏–Ω–∏—è–º –∑–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) ‚îÇ ‚îî‚îÄ‚îÄ –ê–í–¢–û–ú–û–ë–ò–õ–ò (Car) ‚Äî \"–¥–µ—Ç–∏\", –Ω–∞—Å–ª–µ–¥—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚îÇ ‚îú‚îÄ‚îÄ –ö–ª–∏–µ–Ω—Ç (Client) ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –¢–° ‚îú‚îÄ‚îÄ –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ (Carrier) ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –¢–° –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚îÇ ‚îî‚îÄ‚îÄ –£–°–õ–£–ì–ò (CarService) ‚Äî —Å–≤—è–∑—å –¢–° —Å —É—Å–ª—É–≥–∞–º–∏ ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (LINE) ‚Äî –≤–∫–ª—é—á–∞—è THS ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (WAREHOUSE) ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Ä–∞–∑–≥—Ä—É–∑–∫–∞ –∏ –¥—Ä. ‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (CARRIER) ‚îî‚îÄ‚îÄ –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ (COMPANY) ``` ### –ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö **–í–ê–ñ–ù–û:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –¢–° –≤–Ω—É—Ç—Ä–∏: | –ü–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –≤ –¢–° | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ | |-----------------|------------------|------------| | `status` | ‚úÖ –î–∞ | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¢–° | | `warehouse` | ‚úÖ –î–∞ | –°–∫–ª–∞–¥ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° | | `unload_date` | ‚úÖ –î–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) | –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è | | `line` | ‚úÖ –î–∞ | –õ–∏–Ω–∏—è –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° | | `ths` | ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è | THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ —Ç–∏–ø–∞–º –¢–° | **–û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –ö–æ–≥–¥–∞ –í–°–ï", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "| –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è | | `line` | ‚úÖ –î–∞ | –õ–∏–Ω–∏—è –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –¢–° | | `ths` | ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è | THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ —Ç–∏–ø–∞–º –¢–° | **–û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –ö–æ–≥–¥–∞ –í–°–ï –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å \"–ü–µ—Ä–µ–¥–∞–Ω\" ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–æ–∂–µ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å \"–ü–µ—Ä–µ–¥–∞–Ω\". --- ## üì¶ –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• ### Container (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä) ```python # –§–∞–π–ª: core/models.py Container: number # –ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) status # FLOATING (–í –ø—É—Ç–∏), IN_PORT (–í –ø–æ—Ä—Ç—É), UNLOADED (–†–∞–∑–≥—Ä—É–∂–µ–Ω), TRANSFERRED (–ü–µ—Ä–µ–¥–∞–Ω) line # FK ‚Üí Line (–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è) warehouse # FK ‚Üí Warehouse (–°–∫–ª–∞–¥ —Ä–∞–∑–≥—Ä—É–∑–∫–∏) client # FK ‚Üí Client (–∫–ª–∏–µ–Ω—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) customs_procedure # –¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (TRANSIT/IMPORT/REEXPORT/EXPORT) # THS —Å–∏—Å—Ç–µ–º–∞ ths # Decimal ‚Äî –æ–±—â–∞—è —Å—É–º–º–∞ THS –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ths_payer # LINE –∏–ª–∏ WAREHOUSE ‚Äî –∫–æ–º—É –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS sklad # –û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) dekl # –î–µ–∫–ª–∞—Ä–∞—Ü–∏—è (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) proft # –ù–∞—Ü–µ–Ω–∫–∞ (legacy –ø–æ–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) # –î–∞—Ç—ã eta # –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è planned_unload_date # \"–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\" ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email –∫–ª–∏–µ–Ω—Ç–∞–º unload_date # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email unloaded_status_at # –ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "—è planned_unload_date # \"–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\" ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email –∫–ª–∏–µ–Ω—Ç–∞–º unload_date # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email unloaded_status_at # –ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å \"–†–∞–∑–≥—Ä—É–∂–µ–Ω\" # –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (legacy —Ä–∞—Å—á—ë—Ç) free_days # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ days # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ rate # –°—Ç–∞–≤–∫–∞ (legacy) storage_cost # –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (legacy) notes # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è # Google Drive google_drive_folder_url # –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ``` **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ \"–†–∞–∑–≥—Ä—É–∂–µ–Ω\" –ø–æ–ª—è `warehouse` –∏ `unload_date` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã. ### Car (–ê–≤—Ç–æ–º–æ–±–∏–ª—å/–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ) ```python # –§–∞–π–ª: core/models.py Car: # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è vin # VIN –Ω–æ–º–µ—Ä (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π, 17 —Å–∏–º–≤–æ–ª–æ–≤) brand # –ú–∞—Ä–∫–∞ (Toyota, BMW –∏ —Ç.–¥.) year # –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ # –¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ù–û–ì–û –°–†–ï–î–°–¢–í–ê (11 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) vehicle_type: SEDAN # –õ–µ–≥–∫–æ–≤–æ–π (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS: 1.0) CROSSOVER # –ö—Ä–æ—Å—Å–æ–≤–µ—Ä (1.2) SUV # –î–∂–∏–ø (1.5) PICKUP # –ü–∏–∫–∞–ø (1.5) NEW_CAR # –ù–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å (1.0) MOTO # –ú–æ—Ç–æ—Ü–∏–∫–ª (0.3) BIG_MOTO # –ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª (0.5) ATV # –ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏ (0.5) BOAT # –õ–æ–¥–∫–∞ (2.0) RV # –ê–≤—Ç–æ–¥–æ–º (3.0) CONSTRUCTION # –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ (2.5) # –°–≤—è–∑–∏ container # FK ‚Üí Container (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL –¥–ª—è –¢–° –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) client #", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": " –º–æ—Ç–æ—Ü–∏–∫–ª (0.5) ATV # –ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏ (0.5) BOAT # –õ–æ–¥–∫–∞ (2.0) RV # –ê–≤—Ç–æ–¥–æ–º (3.0) CONSTRUCTION # –°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞ (2.5) # –°–≤—è–∑–∏ container # FK ‚Üí Container (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL –¥–ª—è –¢–° –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) client # FK ‚Üí Client (–≤–ª–∞–¥–µ–ª–µ—Ü) warehouse # FK ‚Üí Warehouse (—Å–∫–ª–∞–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è) line # FK ‚Üí Line (–º–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è) carrier # FK ‚Üí Carrier (–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫) # –°—Ç–∞—Ç—É—Å –∏ –¥–∞—Ç—ã status # –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ unload_date # –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) transfer_date # –î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–ª–∏–µ–Ω—Ç—É # –•—Ä–∞–Ω–µ–Ω–∏–µ free_days # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–∏–∑ —Å–∫–ª–∞–¥–∞) days # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) storage_cost # –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞) # –¶–µ–Ω–∞ total_price # –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + –Ω–∞—Ü–µ–Ω–∫–∏ proft # –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania (legacy –ø–æ–ª–µ) hide_markup_in # FK ‚Üí CarService (–≤ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Å–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É) # –î–æ–∫—É–º–µ–Ω—Ç—ã has_title # –ï—Å—Ç—å –ª–∏ Title title_notes # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ Title # –î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã (legacy –ø–æ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Å—Ç–∞—Ä—ã—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö/–æ—Ç—á–µ—Ç–∞—Ö) unload_fee, delivery_fee, loading_fee, docs_fee, transfer_fee transit_declaration, export_declaration, extra_costs, complex_fee price, auction_fee, transport_usa, ocean_freight, transport_kz broker_fee, additional_expenses, rate ``` ### CarSer", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "_fee, transfer_fee transit_declaration, export_declaration, extra_costs, complex_fee price, auction_fee, transport_usa, ocean_freight, transport_kz broker_fee, additional_expenses, rate ``` ### CarService (–°–≤—è–∑—å –¢–° —Å —É—Å–ª—É–≥–∞–º–∏) ```python # –§–∞–π–ª: core/models.py CarService: car # FK ‚Üí Car service_type # LINE, WAREHOUSE, CARRIER –∏–ª–∏ COMPANY service_id # ID —É—Å–ª—É–≥–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ (LineService/WarehouseService/CarrierService/CompanyService) custom_price # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π) markup_amount # –°–ö–†–´–¢–ê–Ø –ù–ê–¶–ï–ù–ö–ê (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–µ –≤ –∏–Ω–≤–æ–π—Å–µ, –Ω–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ) quantity # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–æ–±—ã—á–Ω–æ 1) notes # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è # –°–≤–æ–π—Å—Ç–≤–∞ (property) final_price # = custom_price √ó quantity (–ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏, –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞) invoice_price # = (custom_price + markup_amount) √ó quantity (–¥–ª—è –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É) ``` ### –£—Å–ª—É–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ ```python # –§–∞–π–ª: core/models.py LineService: # –£—Å–ª—É–≥–∏ –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π line # FK ‚Üí Line name # \"THS MAERSK 3 –ê–í–¢–û\", \"–î–æ–∫—É–º–µ–Ω—Ç—ã\" –∏ —Ç.–¥. default_price # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é default_markup # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é is_active # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ add_by_default # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ WarehouseService: # ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "fault_price # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é default_markup # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é is_active # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ add_by_default # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ WarehouseService: # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ warehouse # FK ‚Üí Warehouse name # \"–•—Ä–∞–Ω–µ–Ω–∏–µ\", \"–†–∞–∑–≥—Ä—É–∑–∫–∞\", \"–î–æ–∫—É–º–µ–Ω—Ç—ã\" –∏ —Ç.–¥. default_price # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" ‚Äî —Å—Ç–∞–≤–∫–∞ –∑–∞ –î–ï–ù–¨) default_markup # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" ‚Äî –Ω–∞—Ü–µ–Ω–∫–∞ –∑–∞ –î–ï–ù–¨) is_active # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ add_by_default # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ CarrierService: # –£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ carrier # FK ‚Üí Carrier name # \"–î–æ—Å—Ç–∞–≤–∫–∞\", \"–ü–æ–≥—Ä—É–∑–∫–∞\" –∏ —Ç.–¥. default_price # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é default_markup # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é is_active # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ add_by_default # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ CompanyService: # –£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π company # FK ‚Üí Company (Caromoto Lithuania –∏ –¥—Ä.) name # \"–î–æ–∫—É–º–µ–Ω—Ç—ã\", \"–ö–æ–º–∏—Å—Å–∏—è\" –∏ —Ç.–¥. description # –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ default_price # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é default_markup # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é is_active # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ add_by_default # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –∫–æ–º–ø–∞–Ω–∏–∏ ``` ### LineTHSCoefficient (–ö–æ—ç—Ñ—Ñ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": " # –¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é default_markup # –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é is_active # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É—Å–ª—É–≥–∞ add_by_default # ‚úÖ –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –∫–æ–º–ø–∞–Ω–∏–∏ ``` ### LineTHSCoefficient (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS) ```python # –§–∞–π–ª: core/models.py LineTHSCoefficient: line # FK ‚Üí Line vehicle_type # –¢–∏–ø –¢–° (SEDAN, MOTO –∏ —Ç.–¥.) coefficient # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–≤–µ—Å) –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS # –ü—Ä–∏–º–µ—Ä: –õ–∏–Ω–∏—è MAERSK # SEDAN: 1.0, SUV: 1.5, MOTO: 0.3, BOAT: 2.0 ``` --- ## üí∞ –°–ò–°–¢–ï–ú–ê THS (TERMINAL HANDLING SURCHARGE) ### –ß—Ç–æ —Ç–∞–∫–æ–µ THS THS ‚Äî —ç—Ç–æ —Å–±–æ—Ä –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –ø–æ—Ä—Ç—É. –°—É–º–º–∞ THS —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¢–° –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö \"–≤–µ—Å—É\" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É). ### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è THS ``` 1. –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—É–º–º—É THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø–æ–ª—É—á–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –µ–≥–æ —Ç–∏–ø–∞ –∏–∑ LineTHSCoefficient 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª—é: THS_–¢–° = –æ–±—â–∏–π_THS √ó (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤) 4. –û–∫—Ä—É–≥–ª–∏—Ç—å –í–í–ï–†–• –¥–æ 5 EUR (73.12 ‚Üí 75 EUR) ``` ### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ ``` –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR 3 –¢–°: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(1.5) + –º–æ—Ç–æ(0.3) = —Å—É–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 2.8 - –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/2.8) = 178.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 180 EUR - –î–∂–∏–ø: 500 √ó (1.5/2.8) = 267.86 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "—Ç–µ–π–Ω–µ—Ä THS = 500 EUR 3 –¢–°: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(1.5) + –º–æ—Ç–æ(0.3) = —Å—É–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 2.8 - –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/2.8) = 178.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 180 EUR - –î–∂–∏–ø: 500 √ó (1.5/2.8) = 267.86 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 270 EUR - –ú–æ—Ç–æ: 500 √ó (0.3/2.8) = 53.57 ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 55 EUR ``` ### –ü–æ–ª–µ ths_payer –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –æ—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°: | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ | |----------|----------|---------------------| | `LINE` | –û–ø–ª–∞—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ | CarService —Å service_type='LINE' | | `WAREHOUSE` | –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ | CarService —Å service_type='WAREHOUSE' | **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WAREHOUSE:** –ò–Ω–æ–≥–¥–∞ —Å–∫–ª–∞–¥ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç THS –ª–∏–Ω–∏–∏ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏, –∞ –ø–æ—Ç–æ–º –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á—ë—Ç –Ω–∞–º. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ THS –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞. ### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ```python # –§–∞–π–ª: core/signals.py calculate_ths_for_container(container) # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {car_id: ths_amount} create_ths_services_for_container(container) # –°–æ–∑–¥–∞—ë—Ç CarService –∑–∞–ø–∏—Å–∏ —Å THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö # –¢–∏–ø —É—Å–ª—É–≥–∏ (LINE/WAREHOUSE) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–ª–µ–º ths_payer round_up_to_5(value) # –û–∫—Ä—É–≥–ª—è–µ—Ç –≤–≤–µ—Ä—Ö —Å —à–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "arService –∑–∞–ø–∏—Å–∏ —Å THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ THS-—É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö # –¢–∏–ø —É—Å–ª—É–≥–∏ (LINE/WAREHOUSE) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–ª–µ–º ths_payer round_up_to_5(value) # –û–∫—Ä—É–≥–ª—è–µ—Ç –≤–≤–µ—Ä—Ö —Å —à–∞–≥–æ–º 5 EUR # –ü—Ä–∏–º–µ—Ä: 73.12 ‚Üí 75 ``` ### –ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è THS 1. **–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** ‚Äî –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è: `line`, `ths`, `ths_payer`, `warehouse` 2. **–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\"** –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏ --- ## üè≠ –°–ò–°–¢–ï–ú–ê –£–°–õ–£–ì –°–ö–õ–ê–î–û–í ### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¢–° –Ω–∞ —Å–∫–ª–∞–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —É—Å–ª—É–≥–∏ —Å —Ñ–ª–∞–≥–æ–º `add_by_default=True`. **–î–ª—è –ª–∏–Ω–∏–π, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤ –∏ –∫–æ–º–ø–∞–Ω–∏–π:** - –õ–æ–≥–∏–∫–∞ `add_by_default` —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–∫–ª–∞–¥–∞–º - –£—Å–ª—É–≥–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¢–°**, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¢–° –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è **–¢–∏–ø–∏—á–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞:** - **–•—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî —Ü–µ–Ω–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å - **–†–∞–∑–≥—Ä—É–∑–∫–∞** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ - **–î–æ–∫—É–º–µ–Ω—Ç—ã** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ - **–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ ### –£—Å–ª—É–≥–∞ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" ‚Äî –æ—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ ```python # –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: storage_price = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å storage_markup = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å # –ì–¥–µ: # - –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ = (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –¥–∞—Ç–∞_–ø–µ—Ä–µ–¥–∞—á–∏)", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "thon # –¶–µ–Ω–∞ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: storage_price = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å storage_markup = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å # –ì–¥–µ: # - –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ = (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –¥–∞—Ç–∞_–ø–µ—Ä–µ–¥–∞—á–∏) - –¥–∞—Ç–∞_—Ä–∞–∑–≥—Ä—É–∑–∫–∏ - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ # - —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ WarehouseService.default_price –¥–ª—è —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" # - –Ω–∞—Ü–µ–Ω–∫–∞_–∑–∞_–¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ WarehouseService.default_markup ``` **–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç (–¢–° –µ—â—ë –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏) ‚Äî —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" = 0. ### –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ - –£–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–∫–ª–∞–¥–∞ (`Warehouse.free_days`) - –ù–∞—Å–ª–µ–¥—É—é—Ç—Å—è –≤ –¢–° –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞ - –í–ª–∏—è—é—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è --- ## üíµ –°–ò–°–¢–ï–ú–ê –ù–ê–¶–ï–ù–ö–ò (MARKUP) ### –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –ù–∞—Ü–µ–Ω–∫–∞ Caromoto Lithuania ‚Äî —ç—Ç–æ –ø—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —É—Å–ª—É–≥–∞–º. ### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ```python CarService.markup_amount # –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏ # –¶–µ–Ω—ã: final_price = custom_price √ó quantity # –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞ invoice_price = (custom_price + markup_amount) √ó quantity # –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ``` ### –ü—Ä–∏–º–µ—Ä ``` –£—Å–ª—É–≥–∞ \"–†–∞–∑–≥—Ä—É–∑–∫–∞\": - custom_price = 50 EUR - markup_amount = 10 EUR - –í –∏–Ω–≤–æ–π—Å–µ –∫–ª–∏–µ–Ω—Ç—É: 60 EUR (–∫–ª–∏–µ–Ω—Ç –Ω", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "—Ç–∞ invoice_price = (custom_price + markup_amount) √ó quantity # –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ``` ### –ü—Ä–∏–º–µ—Ä ``` –£—Å–ª—É–≥–∞ \"–†–∞–∑–≥—Ä—É–∑–∫–∞\": - custom_price = 50 EUR - markup_amount = 10 EUR - –í –∏–Ω–≤–æ–π—Å–µ –∫–ª–∏–µ–Ω—Ç—É: 60 EUR (–∫–ª–∏–µ–Ω—Ç –Ω–µ –≤–∏–¥–∏—Ç, —á—Ç–æ 10 EUR ‚Äî —ç—Ç–æ –Ω–∞—Ü–µ–Ω–∫–∞) ``` ### –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CarService –Ω–∞—Ü–µ–Ω–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ `default_markup` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —É—Å–ª—É–≥–∏ (LineService, WarehouseService, CarrierService). --- ## üìß EMAIL-–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ### –¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ | –°–æ–±—ã—Ç–∏–µ | –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –ö–æ–º—É | |---------|-----------------|------| | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `planned_unload_date` | \"–ü–ª–∞–Ω–∏—Ä—É–µ–º —Ä–∞–∑–≥—Ä—É–∑–∫—É\" | –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `unload_date` | \"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≥—Ä—É–∂–µ–Ω\" | –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | ### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ ```python Client: email # –û—Å–Ω–æ–≤–Ω–æ–π email email2, email3, email4 # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ email notification_enabled # –ü–æ–ª—É—á–∞—Ç—å –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True) ``` ### Email-—Å–µ—Ä–≤–∏—Å ```python # –§–∞–π–ª: core/services/email_service.py ContainerNotificationService: send_planned_to_all_clients(container) # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ send_unload_to_all_clients(container) # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ was_planned_notification_sent(container) # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ was_unloa", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "ients(container) # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ send_unload_to_all_clients(container) # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ was_planned_notification_sent(container) # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ was_unload_notification_sent(container) # –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ``` ### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –º–æ–¥–µ–ª–∏ `NotificationLog`. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è. --- ## üìÑ –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í ### –ú–æ–¥–µ–ª—å NewInvoice ```python # –§–∞–π–ª: core/models_billing.py NewInvoice: number # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: INV-202601-0001) date # –î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è due_date # –°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é +14 –¥–Ω–µ–π) # –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–û–î–ò–ù –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö) issuer_company # FK ‚Üí Company (Caromoto Lithuania) issuer_warehouse # FK ‚Üí Warehouse issuer_line # FK ‚Üí Line issuer_carrier # FK ‚Üí Carrier # –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–û–î–ò–ù –∏–∑ –ø—è—Ç–∏) recipient_client # FK ‚Üí Client recipient_warehouse # FK ‚Üí Warehouse recipient_line # FK ‚Üí Line recipient_carrier # FK ‚Üí Carrier recipient_company # FK ‚Üí Company # –§–∏–Ω–∞–Ω—Å—ã subtotal # –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π discount # –°–∫–∏–¥–∫–∞ tax # –ù–∞–ª–æ–≥ total # –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ paid_amount # –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ # –°–≤—è–∑—å —Å –¢–° cars # ManyToMan", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "er # FK ‚Üí Carrier recipient_company # FK ‚Üí Company # –§–∏–Ω–∞–Ω—Å—ã subtotal # –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π discount # –°–∫–∏–¥–∫–∞ tax # –ù–∞–ª–æ–≥ total # –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ paid_amount # –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ # –°–≤—è–∑—å —Å –¢–° cars # ManyToMany ‚Üí Car (–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¢–°) status # DRAFT, ISSUED, PARTIALLY_PAID, PAID, OVERDUE, CANCELLED ``` ### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¢–° –≤ –∏–Ω–≤–æ–π—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥ (CarService). **–õ–æ–≥–∏–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è:** | –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å | –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è | |-------------|------------------------| | Company (Caromoto Lithuania) | –í–°–ï —É—Å–ª—É–≥–∏ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ + —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º) | | Warehouse | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ | | Line | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–π –ª–∏–Ω–∏–∏ | | Carrier | –¢–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ | ### –ú–µ—Ç–æ–¥ regenerate_items_from_cars() ```python # –§–∞–π–ª: core/models_billing.py ‚Üí NewInvoice regenerate_items_from_cars(): # 1. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ # 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–°: # - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ (update_days_and_storage) # - –°–æ–∑–¥–∞—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ CarService # 3. –î–ª—è Company: –¥–æ–±–∞–≤–ª—è–µ—Ç markup_amount –∫ —Ü–µ–Ω–∞–º (—Å–∫—Ä—ã—Ç–æ) # 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–∏ ``` ### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –∏–Ω–≤–æ–π—Å–æ–≤ –ò–Ω–≤–æ–π—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "d_storage) # - –°–æ–∑–¥–∞—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ CarService # 3. –î–ª—è Company: –¥–æ–±–∞–≤–ª—è–µ—Ç markup_amount –∫ —Ü–µ–Ω–∞–º (—Å–∫—Ä—ã—Ç–æ) # 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–∏ ``` ### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –∏–Ω–≤–æ–π—Å–æ–≤ –ò–Ω–≤–æ–π—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏: - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –¢–° (CarService) - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¢–° (–¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å—Ç–∞—Ç—É—Å) –≠—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã –≤ `core/signals.py`. --- ## üì∏ –§–û–¢–û–ì–†–ê–§–ò–ò –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ### Google Drive –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ```python # –§–∞–π–ª: core/google_drive_sync.py GoogleDriveSync: sync_container_by_number(container_number) # –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–∞–ø–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É download_folder_photos(folder_url, container) # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ ``` ### –¢–∏–ø—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π | –¢–∏–ø | –ö–æ–¥ | –ü–∞–ø–∫–∞ –Ω–∞ Google Drive | |-----|-----|----------------------| | –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | `IN_CONTAINER` | \"KONTO VIDUS\" | | –í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ | `UNLOADING` | \"AUTO I≈† KONTO\" | ### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏: - –£—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ \"–†–∞–∑–≥—Ä—É–∂–µ–Ω\" - –£—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ### Management –∫–æ–º–∞–Ω–¥–∞ ```bash python manage.py sync_photos_gdrive --no-photos # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ python manage.py sync_photos_gdrive --recent # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã python manage.py sync_photos_gdrive --container ECMU5566195 # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ``` --- ## ü§ñ AI-–ü–û–ú–û", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "drive --no-photos # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ python manage.py sync_photos_gdrive --recent # –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã python manage.py sync_photos_gdrive --container ECMU5566195 # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ``` --- ## ü§ñ AI-–ü–û–ú–û–©–ù–ò–ö ### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª - –ß–∞—Ç-–≤–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–∞–π—Ç–µ –∏ –≤ –∞–¥–º–∏–Ω–∫–µ - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –ë–î: VIN/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å—Ç–∞—Ç—É—Å, —Å–∫–ª–∞–¥, –¥–∞—Ç—ã –∏ —Ñ–æ—Ç–æ - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω—ã/–æ–ø–ª–∞—Ç—ã/–±–∞–ª–∞–Ω—Å—ã/–∏–Ω–≤–æ–π—Å—ã) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É - –°—Å—ã–ª–∫–∏ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ### –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥–∞–ª–µ—Ä–µ—é - `/?track=<–Ω–æ–º–µ—Ä_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞>&photos=1` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ ### Endpoint - `POST /api/ai-chat/` ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `message` –∏ `session_id` ### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env` ``` AI_CHAT_ENABLED=True AI_API_KEY=... AI_API_BASE_URL=https://api.openai.com/v1 AI_MODEL=gpt-4o-mini AI_MAX_TOKENS=400 AI_TEMPERATURE=0.2 AI_REQUEST_TIMEOUT=40 ``` ### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã - `core/services/ai_chat_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å AI, —Å–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤—ã–∑–æ–≤ API - `core/views_website.py` ‚Äî endpoint –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (—Ñ–∏–Ω–∞–Ω—Å—ã/—Ñ–æ—Ç–æ/—Å—Å—ã–ª–∫–∏) - `core/static/website/js/ai-chat.js` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç, CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ - `templates/admin/base_site.html` + `core/stati", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "e/views_website.py` ‚Äî endpoint –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (—Ñ–∏–Ω–∞–Ω—Å—ã/—Ñ–æ—Ç–æ/—Å—Å—ã–ª–∫–∏) - `core/static/website/js/ai-chat.js` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —á–∞—Ç, CSRF, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ - `templates/admin/base_site.html` + `core/static/admin/css/ai-chat.css` ‚Äî –≤–∏–¥–∂–µ—Ç –≤ –∞–¥–º–∏–Ω–∫–µ ## üîß –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í ### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã ``` logist2/ ‚îú‚îÄ‚îÄ core/ # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚îÇ ‚îú‚îÄ‚îÄ models.py # –ì–ª–∞–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Container, Car, CarService –∏ –¥—Ä.) ‚îÇ ‚îú‚îÄ‚îÄ models_billing.py # –ò–Ω–≤–æ–π—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (NewInvoice, InvoiceItem) ‚îÇ ‚îú‚îÄ‚îÄ models_website.py # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ admin.py # Django Admin (ContainerAdmin, CarAdmin, LineAdmin) ‚îÇ ‚îú‚îÄ‚îÄ admin_billing.py # Admin –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤ ‚îÇ ‚îú‚îÄ‚îÄ admin_website.py # Admin –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ signals.py # –°–∏–≥–Ω–∞–ª—ã (–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, THS, email) ‚îÇ ‚îú‚îÄ‚îÄ views.py # Views –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ ‚îÇ ‚îú‚îÄ‚îÄ views_website.py # Views –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ google_drive_sync.py # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Drive ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ services/ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ email_service.py # Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ ai_chat_service.py # AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î) ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ billing_service.py # –ë–∏–ª–ª–∏–Ω–≥ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ balance_manager.py # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ management/commands/ # Management –∫–æ–º–∞–Ω–¥—ã ‚îÇ ‚îî‚îÄ‚îÄ migrations/ # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": " AI-–ø–æ–º–æ—â–Ω–∏–∫ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î) ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ billing_service.py # –ë–∏–ª–ª–∏–Ω–≥ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ balance_manager.py # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ management/commands/ # Management –∫–æ–º–∞–Ω–¥—ã ‚îÇ ‚îî‚îÄ‚îÄ migrations/ # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (88+ —Ñ–∞–π–ª–æ–≤) ‚îÇ ‚îú‚îÄ‚îÄ templates/ ‚îÇ ‚îú‚îÄ‚îÄ admin/ # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∞–¥–º–∏–Ω–∫–∏ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ line_change.html # –ö–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ base_site.html # –í—Å—Ç–∞–≤–∫–∞ AI-–≤–∏–¥–∂–µ—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ core/container/ # –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚îÇ ‚îú‚îÄ‚îÄ email/ # –®–∞–±–ª–æ–Ω—ã email ‚îÇ ‚îî‚îÄ‚îÄ website/ # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç ‚îÇ ‚îú‚îÄ‚îÄ logist2/ ‚îÇ ‚îú‚îÄ‚îÄ settings.py # –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (InMemory Channels) ‚îÇ ‚îú‚îÄ‚îÄ settings_base.py # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Redis Channels) ‚îÇ ‚îú‚îÄ‚îÄ settings_dev.py # Dev-–ø—Ä–æ—Ñ–∏–ª—å ‚îÇ ‚îú‚îÄ‚îÄ settings_prod.py # Prod-–ø—Ä–æ—Ñ–∏–ª—å ‚îÇ ‚îú‚îÄ‚îÄ settings_test.py # Test-–ø—Ä–æ—Ñ–∏–ª—å (SQLite) ‚îÇ ‚îú‚îÄ‚îÄ urls.py # URL routing ‚îÇ ‚îî‚îÄ‚îÄ wsgi.py / asgi.py # WSGI/ASGI ‚îÇ ‚îú‚îÄ‚îÄ requirements.txt # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ‚îî‚îÄ‚îÄ requirements_website.txt # –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ``` --- ## üîÑ –ö–õ–Æ–ß–ï–í–´–ï –°–ò–ì–ù–ê–õ–´ ### –§–∞–π–ª: core/signals.py ```python # –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Container save_old_container_values() # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è update_related_on_container_save() # –û–±–Ω–æ–≤–ª—è–µ—Ç –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ send_container_notifications_on_save() # –û—Ç–ø—Ä", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "Container save_old_container_values() # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è update_related_on_container_save() # –û–±–Ω–æ–≤–ª—è–µ—Ç –¢–° –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ send_container_notifications_on_save() # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è auto_sync_photos_on_container_change() # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ —Å Google Drive # –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Car save_old_contractors() # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã update_related_on_car_save() # –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–≤–æ–π—Å—ã create_car_services_on_car_save() # –°–æ–∑–¥–∞—ë—Ç —É—Å–ª—É–≥–∏ (—Å–∫–ª–∞–¥, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫) # –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ CarService recalculate_invoices_on_car_service_save() # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã recalculate_invoices_on_car_service_delete() # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã # –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞—Ö update_cars_on_warehouse_service_change() # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService update_cars_on_carrier_service_change() # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService update_cars_on_company_service_change() # –û–±–Ω–æ–≤–ª—è–µ—Ç CarService (Company) delete_car_services_on_company_service_delete() # –£–¥–∞–ª—è–µ—Ç Company CarService ``` --- ## ‚öôÔ∏è –ê–î–ú–ò–ù–ö–ê (DJANGO ADMIN) ### ContainerAdmin **–ò–Ω–ª–∞–π–Ω—ã:** - `CarInline` ‚Äî —Å–ø–∏—Å–æ–∫ –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ - `ContainerPhotoInline` ‚Äî —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ **Actions:** - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–í –ø—É—Ç–∏, –í –ø–æ—Ä—Ç—É, –†–∞–∑–≥—Ä—É–∂–µ–Ω, –ü–µ—Ä–µ–¥–∞–Ω) - –°–∏–Ω—Ö—Ä–æ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "NGO ADMIN) ### ContainerAdmin **–ò–Ω–ª–∞–π–Ω—ã:** - `CarInline` ‚Äî —Å–ø–∏—Å–æ–∫ –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ - `ContainerPhotoInline` ‚Äî —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ **Actions:** - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–í –ø—É—Ç–∏, –í –ø–æ—Ä—Ç—É, –†–∞–∑–≥—Ä—É–∂–µ–Ω, –ü–µ—Ä–µ–¥–∞–Ω) - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —Å Google Drive - –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π **save_model() ‚Äî –∫–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞:** 1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è `warehouse` ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∫–ª–∞–¥ –≤–æ –≤—Å–µ –¢–° 2. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è `status` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¢–° (bulk_update) 3. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å `unload_date` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –≤–æ –≤—Å–µ—Ö –¢–° (bulk_update) 4. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å `line/ths/ths_payer/warehouse` ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS ### CarAdmin **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª—É–≥ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ü–µ–Ω–∫–∏ - –°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º (services_summary_display) - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ü–µ–Ω—ã ### LineAdmin **–ò–Ω–ª–∞–π–Ω—ã:** - `LineServiceInline` ‚Äî —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ - `LineTHSCoefficientInline` ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS **–ö–Ω–æ–ø–∫–∞ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\":** - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —ç—Ç–æ–π –ª–∏–Ω–∏–∏ - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ --- ## üìä –°–¢–ê–¢–£–°–´ ### –°—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–¢–° | –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | |-----|----------|----------| | `FLOATING` | –í –ø—É—Ç–∏ | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –º–æ—Ä–µ | | `IN_PORT` | –í –ø–æ—Ä—Ç—É | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–±—ã–ª, –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–≥—Ä—É–∑–∫–∏ | | `UNLOAD", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "### –°—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/–¢–° | –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | |-----|----------|----------| | `FLOATING` | –í –ø—É—Ç–∏ | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –º–æ—Ä–µ | | `IN_PORT` | –í –ø–æ—Ä—Ç—É | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–±—ã–ª, –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–≥—Ä—É–∑–∫–∏ | | `UNLOADED` | –†–∞–∑–≥—Ä—É–∂–µ–Ω | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≥—Ä—É–∂–µ–Ω, –¢–° –Ω–∞ —Å–∫–ª–∞–¥–µ | | `TRANSFERRED` | –ü–µ—Ä–µ–¥–∞–Ω | –¢–° –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç—É | ### –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–∞ | –ö–æ–¥ | –ù–∞–∑–≤–∞–Ω–∏–µ | |-----|----------| | `DRAFT` | –ß–µ—Ä–Ω–æ–≤–∏–∫ | | `ISSUED` | –í—ã—Å—Ç–∞–≤–ª–µ–Ω | | `PARTIALLY_PAID` | –ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω | | `PAID` | –û–ø–ª–∞—á–µ–Ω | | `OVERDUE` | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω | | `CANCELLED` | –û—Ç–º–µ–Ω–µ–Ω | --- ## üõ†Ô∏è –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ ### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ ```bash # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ssh root@176.118.198.78 cd /var/www/www-root/data/www/logist2 source .venv/bin/activate # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ systemctl restart gunicorn systemctl restart daphne # –ú–∏–≥—Ä–∞—Ü–∏–∏ python manage.py migrate # –°—Ç–∞—Ç–∏–∫–∞ python manage.py collectstatic --noinput # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ python manage.py sync_photos_gdrive --no-photos # –ü—Ä–∞–≤–∞ –Ω–∞ media —Ñ–∞–π–ª—ã ./fix_media_permissions.sh ``` ### –õ–æ–∫–∞–ª—å–Ω–æ (PowerShell) ```powershell # –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ .\\START_ME.bat # –î–µ–ø–ª–æ–π .\\deploy.ps1 # –ú–∏–≥—Ä–∞—Ü–∏–∏ python manage.py makemigrations python manage.py migrate ``` --- ## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–Æ–ê–ù–°–´ ### 1. –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ü—Ä–∏ –≤–Ω–µ–¥—Ä", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": " –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ .\\START_ME.bat # –î–µ–ø–ª–æ–π .\\deploy.ps1 # –ú–∏–≥—Ä–∞—Ü–∏–∏ python manage.py makemigrations python manage.py migrate ``` --- ## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–Æ–ê–ù–°–´ ### 1. –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ü—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ù–ï –ù–£–ñ–ù–û –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ü–µ–Ω—ã/—É—Å–ª—É–≥–∏ –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¢–° –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Å–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö. ### 2. PowerShell –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è - –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç `&&` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `;` - –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ SSH –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å—Å—è - –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `deploy.ps1` ### 3. –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ - –õ–æ–∫–∞–ª—å–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `settings.py` (InMemory Channels). - –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≤—è–∑–∫–∞ `settings_base.py` + `settings_prod.py` (Redis Channels, ASGI –≤–∫–ª—é—á–µ–Ω). ### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Django –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –¢–° –Ω—É–∂–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å prefetch –∫—ç—à: ```python if hasattr(self, '_prefetched_objects_cache'): self._prefetched_objects_cache.pop('car_services', None) ``` ### 5. Email —á–µ—Ä–µ–∑ Brevo - –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 300 –ø–∏—Å–µ–º/–¥–µ–Ω—å - SMTP: smtp-relay.brevo.com - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ### 6. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ï—Å–ª–∏ –¥–ª—è —Ç–∏–ø–∞ –¢–° –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ `LineTHSCoefficient`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 1.0. --- ## üìù –¢–ò–ü–ò–ß–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "–µ—Ä–µ ### 6. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ï—Å–ª–∏ –¥–ª—è —Ç–∏–ø–∞ –¢–° –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ `LineTHSCoefficient`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 1.0. --- ## üìù –¢–ò–ü–ò–ß–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 1. –£–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 2. –í—ã–±—Ä–∞—Ç—å –ª–∏–Ω–∏—é ‚Üí —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS 3. –£–∫–∞–∑–∞—Ç—å —Å—É–º–º—É THS –∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (LINE/WAREHOUSE) 4. –í—ã–±—Ä–∞—Ç—å —Å–∫–ª–∞–¥ ‚Üí —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 5. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω ‚Üí –∫–∞–∂–¥–æ–º—É –¢–° —Å–æ–∑–¥–∞–¥—É—Ç—Å—è —É—Å–ª—É–≥–∏ 6. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí THS —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ –≤—Å–µ–º –¢–° ### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏ 1. –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ 2. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí –¥–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å–µ–º –¢–° 3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—é—Ç—Å—è –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è 4. –û–±–Ω–æ–≤—è—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã 5. –ö–ª–∏–µ–Ω—Ç–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS 1. –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ª–∏–Ω–∏–∏ 2. –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∏–Ω–ª–∞–π–Ω–µ `LineTHSCoefficientInline` 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–Ω–∏—é 4. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\" 5. THS –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ ### –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ –∫–ª–∏–µ–Ω—Ç—É 1. –°–æ–∑–¥–∞—Ç—å NewInvoice 2. –í—ã–±—Ä–∞—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è: Caromoto Lithuania (Company) 3. –í—ã–±—Ä–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –ö–ª–∏–µ–Ω—Ç 4. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ ManyToMany 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ CarS", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\PROMT_LOGIST2.md", "content": "–∫–ª–∏–µ–Ω—Ç—É 1. –°–æ–∑–¥–∞—Ç—å NewInvoice 2. –í—ã–±—Ä–∞—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è: Caromoto Lithuania (Company) 3. –í—ã–±—Ä–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –ö–ª–∏–µ–Ω—Ç 4. –î–æ–±–∞–≤–∏—Ç—å –¢–° —á–µ—Ä–µ–∑ ManyToMany 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ CarService 6. –°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ --- ## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´ - `AI_PROJECT_CONTEXT.md` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI —Å –¥–µ—Ç–∞–ª—è–º–∏ –¥–µ–ø–ª–æ—è - `LOGIST2_PROGRESS_REPORT.md` ‚Äî –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ - `CREDENTIALS.md` ‚Äî –ø–∞—Ä–æ–ª–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã (–Ω–µ –≤ git) --- **–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "from django.db import models from django.core.validators import MinValueValidator from .constants import STATUS_COLORS from django.utils import timezone from channels.layers import get_channel_layer from asgiref.sync import async_to_sync from django.db.models import Sum, Q from django.db import transaction from decimal import Decimal import logging from datetime import timedelta # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã from .managers import ( OptimizedCarManager, OptimizedContainerManager, OptimizedClientManager, OptimizedWarehouseManager, OptimizedCompanyManager ) logger = logging.getLogger('django') def get_current_user(): \"\"\"–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\" from django.contrib.auth.models import AnonymousUser from django.contrib.auth import get_user try: user = get_user() if user.is_authenticated: return user.username return 'system' except: return 'system' # –ë–∞–∑–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ class BaseManager(models.Manager): def update_related(self, instance): pass # –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –±–∞–ª–∞–Ω—Å–æ–≤ # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ class Line(models.Model): name = models.CharField(max_length=100, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.Decimal", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –±–∞–ª–∞–Ω—Å–æ–≤ # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ class Line(models.Model): name = models.CharField(max_length=100, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã\") balance_updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω\") # –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã ocean_freight_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∑–∞ –∞–≤—Ç–æ)\") documentation_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\") handling_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏\") ths_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"THS —Å–±–æ—Ä (–æ–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º)\") additional_fees = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã\") class Meta: verbose_name = \"–õ–∏–Ω–∏—è\" verbose_name_plural = \"–õ–∏–Ω–∏–∏\" def __str__(self): return self.name class LineTHSCoefficient(models.Mod", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "al_places=2, default=0.00, verbose_name=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã\") class Meta: verbose_name = \"–õ–∏–Ω–∏—è\" verbose_name_plural = \"–õ–∏–Ω–∏–∏\" def __str__(self): return self.name class LineTHSCoefficient(models.Model): \"\"\"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–° —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–∏–Ω–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ–∂–¥—É –¢–° –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö \"–≤–µ—Å—É\" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É). –ü—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR 3 –º–∞—à–∏–Ω—ã: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(2.0) + –º–æ—Ç–æ(0.5) = —Å—É–º–º–∞ –≤–µ—Å–æ–≤ 3.5 - –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/3.5) = 143 EUR - –î–∂–∏–ø: 500 √ó (2.0/3.5) = 286 EUR - –ú–æ—Ç–æ: 500 √ó (0.5/3.5) = 71 EUR \"\"\" # –¢–∏–ø—ã –¢–° –¥—É–±–ª–∏—Ä—É–µ–º –∑–¥–µ—Å—å —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ VEHICLE_TYPE_CHOICES = [ ('SEDAN', '–õ–µ–≥–∫–æ–≤–æ–π'), ('CROSSOVER', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä'), ('SUV', '–î–∂–∏–ø'), ('PICKUP', '–ü–∏–∫–∞–ø'), ('NEW_CAR', '–ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞'), ('MOTO', '–ú–æ—Ç–æ—Ü–∏–∫–ª'), ('BIG_MOTO', '–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª'), ('ATV', '–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏'), ('BOAT', '–õ–æ–¥–∫–∞'), ('RV', '–ê–≤—Ç–æ–¥–æ–º (RV)'), ('CONSTRUCTION', '–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞'), ] line = models.ForeignKey(Line, on_delete=models.CASCADE, related_name='ths_coefficients', verbose_name=\"–õ–∏–Ω–∏—è\") vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, verbose_name=\"–¢–∏–ø –¢–°\") coefficient = models.DecimalField(max_digits=5,", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "lated_name='ths_coefficients', verbose_name=\"–õ–∏–Ω–∏—è\") vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, verbose_name=\"–¢–∏–ø –¢–°\") coefficient = models.DecimalField(max_digits=5, decimal_places=2, default=1.00, verbose_name=\"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç\", help_text=\"–í–µ—Å —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç, 2.0 = –¥–≤–æ–π–Ω–æ–π, 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞)\") class Meta: verbose_name = \"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°\" verbose_name_plural = \"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°\" unique_together = ['line', 'vehicle_type'] def __str__(self): return f\"{self.line.name} - {self.get_vehicle_type_display()}: √ó{self.coefficient}\" class Carrier(models.Model): name = models.CharField(max_length=100, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\") short_name = models.CharField(max_length=20, blank=True, null=True, verbose_name=\"–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\") contact_person = models.CharField(max_length=100, blank=True, null=True, verbose_name=\"–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ\") phone = models.CharField(max_length=20, blank=True, null=True, verbose_name=\"–¢–µ–ª–µ—Ñ–æ–Ω\") email = models.EmailField(blank=True, null=True, verbose_name=\"Email\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "e=\"–¢–µ–ª–µ—Ñ–æ–Ω\") email = models.EmailField(blank=True, null=True, verbose_name=\"Email\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã\") balance_updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω\") # –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã transport_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∑–∞ –∫–º)\") loading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–≥—Ä—É–∑–∫–∏\") unloading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–≥—Ä—É–∑–∫–∏\") fuel_surcharge = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–¢–æ–ø–ª–∏–≤–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞\") additional_fees = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã\") created_at = models.DateTimeField(auto_now_add=True, verbose_name=\"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è\") updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\") objects = OptimizedCompanyManager() class Me", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "at = models.DateTimeField(auto_now_add=True, verbose_name=\"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è\") updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\") objects = OptimizedCompanyManager() class Meta: verbose_name = \"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫\" verbose_name_plural = \"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏\" def __str__(self): return self.name class Client(models.Model): name = models.CharField(max_length=100, verbose_name=\"–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞\") email = models.EmailField(blank=True, null=True, verbose_name=\"Email 1\", help_text=\"–û—Å–Ω–æ–≤–Ω–æ–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤\") email2 = models.EmailField(blank=True, null=True, verbose_name=\"Email 2\", help_text=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\") email3 = models.EmailField(blank=True, null=True, verbose_name=\"Email 3\", help_text=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\") email4 = models.EmailField(blank=True, null=True, verbose_name=\"Email 4\", help_text=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\") notification_enabled = models.BooleanField(default=True, verbose_name=\"–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\", help_text=\"–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–µ–Ω–∏—è\", help_text=\"–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥\") balance_updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω\") objects = OptimizedClientManager() class Meta: verbose_name = \"–ö–ª–∏–µ–Ω—Ç\" verbose_name_plural = \"–ö–ª–∏–µ–Ω—Ç—ã\" def __str__(self): return self.name def get_notification_emails(self): \"\"\" –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö email-–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ü—É—Å—Ç—ã–µ –∏ None –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è. \"\"\" emails = [] for field in [self.email, self.email2, self.email3, self.email4]: if field and field.strip(): emails.append(field.strip()) return emails def has_notification_emails(self): \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\"\"\" return len(self.get_notification_emails()) > 0 @property def balance_status(self): \"\"\"–°—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\"\"\" if self.balance > 0: return \"–ü–ï–†–ï–ü–õ–ê–¢–ê\" elif self.balance < 0: return \"–î–û–õ–ì\" return \"–ë–ê–õ–ê–ù–°\" @property def balance_color(self): \"\"\"–¶–≤–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞\"\"\" if self.balance > 0: return \"#28a745\" # –∑–µ–ª–µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": ".balance > 0: return \"–ü–ï–†–ï–ü–õ–ê–¢–ê\" elif self.balance < 0: return \"–î–û–õ–ì\" return \"–ë–ê–õ–ê–ù–°\" @property def balance_color(self): \"\"\"–¶–≤–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞\"\"\" if self.balance > 0: return \"#28a745\" # –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–ø–ª–∞—Ç—ã elif self.balance < 0: return \"#dc3545\" # –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –¥–æ–ª–≥–∞ return \"#6c757d\" # —Å–µ—Ä—ã–π –¥–ª—è –Ω—É–ª—è class Warehouse(models.Model): name = models.CharField(max_length=100, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞\") address = models.CharField(max_length=300, blank=True, verbose_name=\"–ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã\") balance_updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω\") # –¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ default_unloading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É\") free_days = models.PositiveIntegerField(default=0, verbose_name=\"–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏\") # –£–î–ê–õ–ï–ù–û: rate - —Å—Ç–∞–≤–∫–∞ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" (WarehouseService) complex_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ö–æ–º–ø–ª–µ–∫—Å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–µ –¥–Ω–∏\") # –£–î–ê–õ–ï–ù–û: rate - —Å—Ç–∞–≤–∫–∞ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" (WarehouseService) complex_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ö–æ–º–ø–ª–µ–∫—Å\",validators=[MinValueValidator(0)]) delivery_to_warehouse = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞\") loading_on_trawl = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª\") documents_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–î–æ–∫—É–º–µ–Ω—Ç—ã\") transfer_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É\") transit_declaration = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.\") export_declaration = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.\") additional_expenses = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã\") objects = OptimizedWarehouseManager() class Meta: verbose_name = \"–°–∫–ª–∞–¥\" verbose_name_plural = \"–°–∫–ª–∞–¥—ã\" def __str__(self): return self.name # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã c", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ces=2, default=0, verbose_name=\"–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã\") objects = OptimizedWarehouseManager() class Meta: verbose_name = \"–°–∫–ª–∞–¥\" verbose_name_plural = \"–°–∫–ª–∞–¥—ã\" def __str__(self): return self.name # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã class ContainerManager(BaseManager): def update_related(self, instance): cars = instance.container_cars.all() if not cars: return ths_per_car = (instance.ths or 0) / cars.count() for car in cars: car.sync_with_container(instance, ths_per_car) car.save() class Container(models.Model): STATUS_CHOICES = [ ('FLOATING', '–í –ø—É—Ç–∏'), ('IN_PORT', '–í –ø–æ—Ä—Ç—É'), ('UNLOADED', '–†–∞–∑–≥—Ä—É–∂–µ–Ω'), ('TRANSFERRED', '–ü–µ—Ä–µ–¥–∞–Ω'), ] def get_status_color(self): return STATUS_COLORS.get(self.status, '#3a8c3d') # –¢–µ–º–Ω–µ–µ –∑–µ–ª—ë–Ω–æ–≥–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é CUSTOMS_PROCEDURE_CHOICES = ( ('TRANSIT', '–¢—Ä–∞–Ω–∑–∏—Ç'), ('IMPORT', '–ò–º–ø–æ—Ä—Ç'), ('REEXPORT', '–†–µ—ç–∫—Å–ø–æ—Ä—Ç'), ('EXPORT', '–≠–∫—Å–ø–æ—Ä—Ç'), ) number = models.CharField(max_length=100, unique=True, verbose_name=\"–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\") status = models.CharField(max_length=50, choices=STATUS_CHOICES, default='FLOATING', verbose_name=\"–°—Ç–∞—Ç—É—Å\") line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è\") eta = models.DateField(null=True, blank=True, v", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ault='FLOATING', verbose_name=\"–°—Ç–∞—Ç—É—Å\") line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è\") eta = models.DateField(null=True, blank=True, verbose_name=\"ETA\") client = models.ForeignKey('Client', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–ö–ª–∏–µ–Ω—Ç\") customs_procedure = models.CharField(max_length=20, choices=CUSTOMS_PROCEDURE_CHOICES, null=True, blank=True, verbose_name=\"–¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞\") THS_PAYER_CHOICES = [ ('LINE', '–ù–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏'), ('WAREHOUSE', '–ß–µ—Ä–µ–∑ —Å–∫–ª–∞–¥'), ] ths = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–û–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º\", validators=[MinValueValidator(0)]) ths_payer = models.CharField(max_length=20, choices=THS_PAYER_CHOICES, default='LINE', verbose_name=\"–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑\", help_text=\"–û—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°: –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥\") sklad = models.DecimalField(max_digits=10, decimal_places=2, default=160, verbose_name=\"–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É\", validators=[MinValueValidator(0)]) dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è\", validators=[MinValueValidator(0", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "e_name=\"–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É\", validators=[MinValueValidator(0)]) dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è\", validators=[MinValueValidator(0)]) proft = models.DecimalField(max_digits=10, decimal_places=2, default=20, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞\", validators=[MinValueValidator(0)]) warehouse = models.ForeignKey('Warehouse', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–°–∫–ª–∞–¥\") planned_unload_date = models.DateField(null=True, blank=True, verbose_name=\"–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å\", help_text=\"–£–∫–∞–∂–∏—Ç–µ –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)\") unload_date = models.DateField(null=True, blank=True, verbose_name=\"–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏\") unloaded_status_at = models.DateTimeField( null=True, blank=True, verbose_name=\"–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å\", help_text=\"–ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' (–¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ)\" ) free_days = models.PositiveIntegerField(default=0, verbose_name=\"–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏\") days = models.PositiveIntegerField(default=0, verbose_name=\"–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏\") rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name=\"–°—Ç–∞–≤–∫–∞\", validators=[MinValueValidator(0)]) s", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": " = models.PositiveIntegerField(default=0, verbose_name=\"–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏\") rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name=\"–°—Ç–∞–≤–∫–∞\", validators=[MinValueValidator(0)]) storage_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–°–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ\") notes = models.CharField(max_length=200, blank=True, verbose_name=\"–ü—Ä–∏–º–µ—á–∞–Ω–∏—è\") # Google Drive integration google_drive_folder_url = models.URLField(max_length=500, blank=True, verbose_name=\"Google Drive –ø–∞–ø–∫–∞\", help_text=\"–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Google Drive\") objects = OptimizedContainerManager() # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ legacy_objects = ContainerManager() def update_days_and_storage(self): if self.status == 'UNLOADED' and self.unload_date: total_days = (timezone.now().date() - self.unload_date).days + 1 self.days = max(0, total_days - self.free_days) self.storage_cost = self.days * (self.rate or 0) else: self.days = 0 self.storage_cost = 0 def sync_cars(self): self.update_days_and_storage() Container.objects.update_related(self) def save(self, *args, **kwargs): if self.status == 'UNLOADED' and (not self.warehouse or not self.unlo", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "st = 0 def sync_cars(self): self.update_days_and_storage() Container.objects.update_related(self) def save(self, *args, **kwargs): if self.status == 'UNLOADED' and (not self.warehouse or not self.unload_date): raise ValueError(\"–î–ª—è —Å—Ç–∞—Ç—É—Å–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'\") super().save(*args, **kwargs) def sync_cars_after_warehouse_change(self): \"\"\" –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥ –∫–æ –≤—Å–µ–º –∞–≤—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: - —Å—Ç–∞–≤–∏—Ç warehouse - –∂—ë—Å—Ç–∫–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ –ø–æ–ª—è –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ - –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—É–º–º—ã \"\"\" # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á if not self.pk: return for car in self.container_cars.all(): car.warehouse = self.warehouse car.apply_warehouse_defaults(force=True) # –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å rate/free_days –∏ –ø—Ä–æ—á–µ–µ # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) if self.unload_date: car.unload_date = self.unload_date logger.debug(f\"Car {car.vin}: forced unload_date={self.unload_date} from container {self.number}\") car.update_days_and_storage() car.calculate_total_price() car.save() def sync_cars_after_edit(self): \"\"\" –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –º–∞—à–∏–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "date={self.unload_date} from container {self.number}\") car.update_days_and_storage() car.calculate_total_price() car.save() def sync_cars_after_edit(self): \"\"\" –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –º–∞—à–∏–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: ‚Äî –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ —É –∞–≤—Ç–æ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ, ‚Äî –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ), ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (rate/free_days/–∏ —Ç.–¥.) –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö/–¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö, ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ü–µ–Ω—ã. \"\"\" # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á if not self.pk: return from .models import Car # –µ—Å–ª–∏ —Ñ–∞–π–ª –æ–±—â–∏–π, –∏–º–ø–æ—Ä—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω for car in self.container_cars.all(): changed = False # –±–∞–∑–æ–≤—ã–µ —Å–≤—è–∑–∫–∏ if not car.warehouse and self.warehouse: car.warehouse = self.warehouse changed = True if not car.client and self.client: car.client = self.client changed = True # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) if self.unload_date: if car.unload_date != self.unload_date: car.unload_date = self.unload_date changed = True logger.info(f\"Car {car.vin}: forced unload_date update to {self.unload_date} from container {self.number}\") # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ/–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ) if car.warehous", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": " = True logger.info(f\"Car {car.vin}: forced unload_date update to {self.unload_date} from container {self.number}\") # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ/–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ) if car.warehouse: before_rate = car.rate before_free = car.free_days car.apply_warehouse_defaults(override_on_defaults=True) changed = changed or (car.rate != before_rate or car.free_days != before_free) # –ø–µ—Ä–µ—Å—á—ë—Ç car.update_days_and_storage() car.calculate_total_price() if changed: car.save() # —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç WS-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —É —Ç–µ–±—è —ç—Ç–æ –≤ save() else: # –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å—Ç–æ–∏–º–æ—Å—Ç—å/–¥–Ω–∏ –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –¥–∞—Ç—ã car.save(update_fields=['storage_cost', 'days', 'total_price']) def check_and_update_status_from_cars(self): \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\"\"\" if not self.pk: return cars = self.container_cars.all() if not cars.exists(): return # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å \"–ü–µ—Ä–µ–¥–∞–Ω\" all_transferred = all(car.status == 'TRANSFERRED' for car in cars) if all_transferred and self.status != 'TRANSFERRED': self.status = 'TRANSFERRED' self.save(update_fields=['status']) logger.info(f\"Container {self.number} status automatically changed ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "or car in cars) if all_transferred and self.status != 'TRANSFERRED': self.status = 'TRANSFERRED' self.save(update_fields=['status']) logger.info(f\"Container {self.number} status automatically changed to TRANSFERRED\") def __str__(self): return self.number class Meta: verbose_name = \"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä\" verbose_name_plural = \"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã\" indexes = [ models.Index(fields=['status']), models.Index(fields=['client', 'status']), models.Index(fields=['warehouse', 'status']), models.Index(fields=['line']), models.Index(fields=['eta']), models.Index(fields=['unload_date']), ] # –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ class CarManager(BaseManager): pass class Car(models.Model): # –¢–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫) VEHICLE_TYPE_CHOICES = [ ('SEDAN', '–õ–µ–≥–∫–æ–≤–æ–π'), ('CROSSOVER', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä'), ('SUV', '–î–∂–∏–ø'), ('PICKUP', '–ü–∏–∫–∞–ø'), ('NEW_CAR', '–ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞'), ('MOTO', '–ú–æ—Ç–æ—Ü–∏–∫–ª'), ('BIG_MOTO', '–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª'), ('ATV', '–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏'), ('BOAT', '–õ–æ–¥–∫–∞'), ('RV', '–ê–≤—Ç–æ–¥–æ–º (RV)'), ('CONSTRUCTION', '–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞'), ] year = models.PositiveIntegerField(verbose_name=\"–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞\") brand = models.CharField(max_length=50, verbose_name=\"–ú–∞—Ä–∫–∞\") vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, defa", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": " models.PositiveIntegerField(verbose_name=\"–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞\") brand = models.CharField(max_length=50, verbose_name=\"–ú–∞—Ä–∫–∞\") vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, default='SEDAN', verbose_name=\"–¢–∏–ø –¢–°\") vin = models.CharField(max_length=17, unique=True, verbose_name=\"VIN\") client = models.ForeignKey('Client', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–ö–ª–∏–µ–Ω—Ç\") status = models.CharField(max_length=20, choices=Container.STATUS_CHOICES, verbose_name=\"–°—Ç–∞—Ç—É—Å\") warehouse = models.ForeignKey('Warehouse', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–°–∫–ª–∞–¥\") line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–õ–∏–Ω–∏—è\") carrier = models.ForeignKey('Carrier', on_delete=models.SET_NULL, null=True, blank=True, verbose_name=\"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫\") unload_date = models.DateField(null=True, blank=True, verbose_name=\"–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏\") transfer_date = models.DateField(null=True, blank=True, verbose_name=\"–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏\") has_title = models.BooleanField(default=False, verbose_name=\"–¢\") title_notes = models.CharField(max_length=200, blank=True, verbose_name=\"–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ —Ç–∞–π—Ç–ª—É\") total_price = mode", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "name=\"–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏\") has_title = models.BooleanField(default=False, verbose_name=\"–¢\") title_notes = models.CharField(max_length=200, blank=True, verbose_name=\"–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ —Ç–∞–π—Ç–ª—É\") total_price = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–¶–µ–Ω–∞\") # –£–î–ê–õ–ï–ù–û: current_price - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ total_price storage_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name=\"–°–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ\") days = models.PositiveIntegerField(default=0, verbose_name=\"–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏\") container = models.ForeignKey('Container', on_delete=models.CASCADE, related_name=\"container_cars\", null=True, blank=True, verbose_name=\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä\") # –†–∞—Å—Ö–æ–¥—ã ths = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–û–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º\", validators=[MinValueValidator(0)]) unload_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É\", validators=[MinValueValidator(0)]) delivery_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞\", validators=[MinValueValidator(0)]) loading_fee = models.DecimalField(max_d", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "delivery_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞\", validators=[MinValueValidator(0)]) loading_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª\", validators=[MinValueValidator(0)]) docs_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ–∫—É–º–µ–Ω—Ç—ã\", validators=[MinValueValidator(0)]) transfer_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É\", validators=[MinValueValidator(0)]) transit_declaration = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.\", validators=[MinValueValidator(0)]) export_declaration = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.\", validators=[MinValueValidator(0)]) extra_costs = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã\", validators=[MinValueValidator(0)]) dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbos", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ts=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã\", validators=[MinValueValidator(0)]) dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è\", validators=[MinValueValidator(0)]) proft = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal('20.00'), null=True, blank=True, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞\", validators=[MinValueValidator(0)]) hide_markup_in = models.ForeignKey( 'CarService', on_delete=models.SET_NULL, null=True, blank=True, related_name='cars_with_hidden_markup', verbose_name=\"–°–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≤ —É—Å–ª—É–≥–µ\", help_text=\"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –∏–Ω–≤–æ–π—Å–µ)\" ) free_days = models.PositiveIntegerField(default=0, verbose_name=\"–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏\") rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name=\"–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏\", validators=[MinValueValidator(0)]) complex_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–ö–æ–º–ø–ª–µ–∫—Å\", validators=[MinValueValidator(0)]) price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–¶–µ–Ω–∞\", validators=[MinValueValida", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "nk=True, verbose_name=\"–ö–æ–º–ø–ª–µ–∫—Å\", validators=[MinValueValidator(0)]) price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–¶–µ–Ω–∞\", validators=[MinValueValidator(0)]) auction_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–ê—É–∫—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä\", validators=[MinValueValidator(0)]) transport_usa = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –°–®–ê\", validators=[MinValueValidator(0)]) ocean_freight = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–û–∫–µ–∞–Ω—Å–∫–∏–π —Ñ—Ä–∞—Ö—Ç\", validators=[MinValueValidator(0)]) transport_kz = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ö–ó\", validators=[MinValueValidator(0)]) broker_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å–±–æ—Ä\", validators=[MinValueValidator(0)]) additional_expenses = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã\", validators=[MinValueValidator(0)]) objects = OptimizedCarManager() # –°", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "nal_expenses = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã\", validators=[MinValueValidator(0)]) objects = OptimizedCarManager() # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ legacy_objects = CarManager() def get_status_color(self): return STATUS_COLORS.get(self.status, '#3a8c3d') def apply_warehouse_defaults(self, force: bool = False): \"\"\" –ö–æ–ø–∏—Ä—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ –≤ –∞–≤—Ç–æ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥. force=True ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Å–∫–ª–∞–¥–∞. force=False ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ –¥–µ—Ñ–æ–ª—Ç—É –º–æ–¥–µ–ª–∏. \"\"\" if not self.warehouse: return from decimal import Decimal # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True) # –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π —É—Å–ª—É–≥ –Ω–∞ –ø–æ–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è service_mapping = { '–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É': 'unload_fee', '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞': 'delivery_fee', '–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª': 'loading_fee', '–î–æ–∫—É–º–µ–Ω—Ç—ã': 'docs_fee', '–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É': 'transfer_fee', '–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.': 'transit_declaration', '–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.': 'export_declaration', '–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã': 'extra_costs', '–ö–æ–º–ø–ª–µ–∫—Å': 'complex_fee', '–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ee', '–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É': 'transfer_fee', '–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.': 'transit_declaration', '–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.': 'export_declaration', '–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã': 'extra_costs', '–ö–æ–º–ø–ª–µ–∫—Å': 'complex_fee', '–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏': 'rate', '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏': 'free_days', } for service in warehouse_services: car_field = service_mapping.get(service.name) if car_field: wh_val = service.default_price or 0 cur_val = getattr(self, car_field, None) if force: setattr(self, car_field, wh_val) else: if cur_val is None: setattr(self, car_field, wh_val) else: try: cur = Decimal(str(cur_val)) if cur == 0: setattr(self, car_field, wh_val) else: model_default = self._meta.get_field(car_field).default mdl = Decimal(str(model_default or 0)) if cur == mdl: setattr(self, car_field, wh_val) except Exception: setattr(self, car_field, wh_val) def warehouse_details(self): \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ –∏–∑ —Å–∫–ª–∞–¥–∞ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥.\"\"\" if not self.warehouse: return {\"message\": \"–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω\"} # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True) details = {\"–ù–∞–∑–≤–∞–Ω–∏–µ\": self.warehouse.name} for service in warehouse_services: details[service.name] = ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–∞ warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True) details = {\"–ù–∞–∑–≤–∞–Ω–∏–µ\": self.warehouse.name} for service in warehouse_services: details[service.name] = str(service.default_price) return details def set_initial_warehouse_values(self): \"\"\"–ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ. –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –º–æ–¥–µ–ª—å–Ω–æ–º—É –¥–µ—Ñ–æ–ª—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, rate=5) –∏–ª–∏ 0 ‚Äî –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞. \"\"\" if not self.warehouse: return initializing = self._state.adding def _override(cur_val, field_name, wh_val): if cur_val is None: return wh_val if initializing: # –ø–µ—Ä–µ—Ç–∏—Ä–∞–µ–º, –µ—Å–ª–∏ 0 –∏–ª–∏ —Ä–∞–≤–Ω–æ –º–æ–¥–µ–ª—å–Ω–æ–º—É –¥–µ—Ñ–æ–ª—Ç—É try: cur = Decimal(str(cur_val)) if cur == 0: return wh_val model_default = self._meta.get_field(field_name).default mdl = Decimal(str(model_default or 0)) if cur == mdl: return wh_val except Exception: return wh_val return cur_val # –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è (rate —É–¥–∞–ª—ë–Ω - —Å—Ç–∞–≤–∫–∞ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\") self.free_days = _override(self.free_days, 'free_days', self.warehouse.free_days or 0) # –∑–∞–æ–¥–Ω–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ —É—Å–ª—É–≥–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ self.unload_fee = _override(self.unload_fee, 'unload_fee', self.warehouse.default_unloading_fee or 0) self.delivery", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ays', self.warehouse.free_days or 0) # –∑–∞–æ–¥–Ω–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ —É—Å–ª—É–≥–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ self.unload_fee = _override(self.unload_fee, 'unload_fee', self.warehouse.default_unloading_fee or 0) self.delivery_fee = _override(self.delivery_fee, 'delivery_fee', self.warehouse.delivery_to_warehouse or 0) self.loading_fee = _override(self.loading_fee, 'loading_fee', self.warehouse.loading_on_trawl or 0) self.docs_fee = _override(self.docs_fee, 'docs_fee', self.warehouse.documents_fee or 0) self.transfer_fee = _override(self.transfer_fee, 'transfer_fee', self.warehouse.transfer_fee or 0) self.transit_declaration = _override(self.transit_declaration, 'transit_declaration', self.warehouse.transit_declaration or 0) self.export_declaration = _override(self.export_declaration, 'export_declaration', self.warehouse.export_declaration or 0) self.extra_costs = _override(self.extra_costs, 'extra_costs', self.warehouse.additional_expenses or 0) self.complex_fee = _override(self.complex_fee, 'complex_fee', self.warehouse.complex_fee or 0) def calculate_total_price(self): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥ CarService. –¶–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫. –í–ê–ñ–ù–û: total_price –≤–∫–ª—é—á–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "f.warehouse.complex_fee or 0) def calculate_total_price(self): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥ CarService. –¶–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫. –í–ê–ñ–ù–û: total_price –≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É (markup_amount)! –≠—Ç–æ –ø–æ–ª–Ω–∞—è —Å—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –∑–∞–ø–ª–∞—Ç–∏—Ç –∫–ª–∏–µ–Ω—Ç. \"\"\" from django.db.models import Sum # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à related objects —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ –ë–î if hasattr(self, '_prefetched_objects_cache'): self._prefetched_objects_cache.pop('car_services', None) # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –∏ —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" self.update_days_and_storage() # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—ã –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –∏–∑ CarService (final_price = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏) line_total = self.get_services_total_by_provider('LINE') carrier_total = self.get_services_total_by_provider('CARRIER') warehouse_total = self.get_warehouse_services_total() # –í–∫–ª—é—á–∞–µ—Ç —É—Å–ª—É–≥—É \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" company_total = self.get_services_total_by_provider('COMPANY') # –°—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫ distributed_markup = self.car_services.aggregate(total=Sum('markup_amount'))['total'] or Decimal('0') # –û–±—â–∞—è —Å—É–º–º–∞ = —É—Å–ª—É–≥–∏ + —Å–∫—Ä—ã—Ç—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏ self.total_price = line_total + warehouse_total + carrier_total + company_total + distributed_markup re", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "te(total=Sum('markup_amount'))['total'] or Decimal('0') # –û–±—â–∞—è —Å—É–º–º–∞ = —É—Å–ª—É–≥–∏ + —Å–∫—Ä—ã—Ç—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏ self.total_price = line_total + warehouse_total + carrier_total + company_total + distributed_markup return self.total_price def update_days_and_storage(self): \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è. –¶–µ–Ω–∞ –∑–∞ –¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞. –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å \"\"\" if not self.unload_date or not self.warehouse: self.days = 0 self.storage_cost = Decimal('0.00') self._update_storage_service_price() return # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∫–ª–∞–¥–∞ free_days = int(self.warehouse.free_days or 0) end_date = self.transfer_date if self.status == 'TRANSFERRED' and self.transfer_date else timezone.now().date() total_days = (end_date - self.unload_date).days + 1 self.days = max(0, total_days - free_days) # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" daily_rate = self._get_storage_daily_rate() self.storage_cost = Decimal(str(self.days)) * daily_rate # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ CarService self._update_storage_service_price() def _get_storage_daily_rate(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞.\"\"\" if not self.wa", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ CarService self._update_storage_service_price() def _get_storage_daily_rate(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞.\"\"\" if not self.warehouse: return Decimal('0.00') try: storage_service = WarehouseService.objects.filter( warehouse=self.warehouse, name='–•—Ä–∞–Ω–µ–Ω–∏–µ', is_active=True ).first() if storage_service: return Decimal(str(storage_service.default_price or 0)) except Exception: pass return Decimal('0.00') def _update_storage_service_price(self): \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' –≤ CarService. –¶–µ–Ω–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å (–∏–∑ WarehouseService) –í–ê–ñ–ù–û: markup_amount –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ù–∞—Ü–µ–Ω–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ (–∏–∑ default_markup) –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –∞–¥–º–∏–Ω–∫–µ. \"\"\" if not self.pk or not self.warehouse: return try: # –ù–∞—Ö–æ–¥–∏–º —É—Å–ª—É–≥—É \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞ storage_service = WarehouseService.objects.filter( warehouse=self.warehouse, name='–•—Ä–∞–Ω–µ–Ω–∏–µ', is_active=True ).first() if storage_service: days = Decimal(str(self.days)) # –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å storage_price = days * Decimal(str(storage_service.default_price or 0)) # –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —Ü–µ–Ω—É –≤ CarSer", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "t() if storage_service: days = Decimal(str(self.days)) # –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å storage_price = days * Decimal(str(storage_service.default_price or 0)) # –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —Ü–µ–Ω—É –≤ CarService (markup_amount –Ω–µ —Ç—Ä–æ–≥–∞–µ–º!) # –ù–∞—Ü–µ–Ω–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –≤ –∞–¥–º–∏–Ω–∫–µ from core.models import CarService CarService.objects.filter( car=self, service_type='WAREHOUSE', service_id=storage_service.id ).update(custom_price=storage_price) # –°–±—Ä–∞—Å—ã–≤–∞–µ–º prefetch –∫—ç—à —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ if hasattr(self, '_prefetched_objects_cache'): self._prefetched_objects_cache.pop('car_services', None) except Exception: pass # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ def sync_with_container(self, container, ths_per_car): \"\"\"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º.\"\"\" self.status = container.status self.warehouse = container.warehouse self.unload_date = container.unload_date self.transfer_date = timezone.now().date() if container.status == 'TRANSFERRED' else None self.ths = ths_per_car self.dekl = container.dekl self.proft = container.proft self.set_initial_warehouse_values() self.update_days_and_storage() self.calculate_total_price() WAREHOUS", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ERRED' else None self.ths = ths_per_car self.dekl = container.dekl self.proft = container.proft self.set_initial_warehouse_values() self.update_days_and_storage() self.calculate_total_price() WAREHOUSE_FEE_FIELDS = ( 'unload_fee', # —Ü–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É 'delivery_fee', # –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞ 'loading_fee', # –ø–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª 'docs_fee', # –¥–æ–∫—É–º–µ–Ω—Ç—ã 'transfer_fee', # –ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É 'transit_declaration', # —Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª. 'export_declaration', # —ç–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª. 'extra_costs', # –¥–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã 'complex_fee', # –∫–æ–º–ø–ª–µ–∫—Å ) def warehouse_payment_amount(self) -> Decimal: \"\"\"–°–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω—ã —Å–∫–ª–∞–¥—É –∑–∞ —É—Å–ª—É–≥–∏ (–±–µ–∑ —É—á—ë—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥.\"\"\" return self.get_warehouse_services_total() @property def warehouse_payment(self) -> Decimal: # —É–¥–æ–±–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è return self.warehouse_payment_amount() def get_line_services(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" if not self.line or not self.pk: return self.car_services.none() # –ü–æ–ª—É—á–∞–µ–º ID —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏ line_service_ids = LineService.objects.only('id').filter(line=self.line).values_list('id', flat=True) return self.car_services.filter(service_type='LINE', service_id__in=line_service_ids) def g", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": " –ª–∏–Ω–∏–∏ line_service_ids = LineService.objects.only('id').filter(line=self.line).values_list('id', flat=True) return self.car_services.filter(service_type='LINE', service_id__in=line_service_ids) def get_carrier_services(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" if not self.carrier or not self.pk: return self.car_services.none() # –ü–æ–ª—É—á–∞–µ–º ID —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ carrier_service_ids = CarrierService.objects.only('id').filter(carrier=self.carrier).values_list('id', flat=True) return self.car_services.filter(service_type='CARRIER', service_id__in=carrier_service_ids) def get_company_services(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" if not self.pk: return self.car_services.none() return self.car_services.filter(service_type='COMPANY') def get_warehouse_services(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–≤–∫–ª—é—á–∞—è —É—Å–ª—É–≥–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤)\"\"\" if not self.pk: return self.car_services.none() # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É –∞–≤—Ç–æ–º–æ–±–∏–ª—é return self.car_services.filter(service_type='WAREHOUSE') def get_services_total_by_provider(self, provider_type): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞. –î–ª—è —Å–∫–ª–∞–¥–∞: —Å—Ç–æ–∏–º–æ—Å—Ç—å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–≤—Ç–æ–º–æ–±–∏–ª—é return self.car_services.filter(service_type='WAREHOUSE') def get_services_total_by_provider(self, provider_type): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞. –î–ª—è —Å–∫–ª–∞–¥–∞: —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —É—Å–ª—É–≥—É \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" (CarService). \"\"\" total = Decimal('0.00') if provider_type == 'LINE' and self.line: services = self.get_line_services() elif provider_type == 'CARRIER' and self.carrier: services = self.get_carrier_services() elif provider_type == 'COMPANY': services = self.get_company_services() elif provider_type == 'WAREHOUSE' and self.warehouse: services = self.get_warehouse_services() else: return total for service in services: total += Decimal(str(service.final_price)) return total def get_warehouse_services_total(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è)\"\"\" if not self.warehouse: return Decimal('0.00') services = self.get_warehouse_services() total = Decimal('0.00') for service in services: total += Decimal(str(service.final_price)) return total def calculate_storage_cost(self): \"\"\"–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ. –°—Ç–∞–≤–∫–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞. \"\"\" if not self.warehouse or not self.unload_date:", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "turn total def calculate_storage_cost(self): \"\"\"–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ. –°—Ç–∞–≤–∫–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞. \"\"\" if not self.warehouse or not self.unload_date: return Decimal('0.00') # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Å–æ —Å–∫–ª–∞–¥–∞ daily_rate = self._get_storage_daily_rate() free_days = self.warehouse.free_days or 0 # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è # –í–∫–ª—é—á–∞–µ–º –¥–µ–Ω—å —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∏ –¥–µ–Ω—å –∑–∞–±–æ—Ä–∞ –∞–≤—Ç–æ end_date = self.transfer_date if self.status == 'TRANSFERRED' and self.transfer_date else timezone.now().date() total_days = (end_date - self.unload_date).days + 1 # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ (–æ–±—â–∏–µ –¥–Ω–∏ –º–∏–Ω—É—Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ) chargeable_days = max(0, total_days - free_days) # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å storage_cost = daily_rate * chargeable_days return storage_cost def get_rates_by_provider(self, provider_type): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫–∏ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\"\"\" rates = [] if provider_type == 'LINE' and self.line: services = self.get_line_services() elif provider_type == 'CARRIER' and self.carrier: services = self.get_carrier_services() elif provider_type == 'WAREHOUSE' and self.warehouse: services = self.get_warehouse_services() else: return ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "() elif provider_type == 'CARRIER' and self.carrier: services = self.get_carrier_services() elif provider_type == 'WAREHOUSE' and self.warehouse: services = self.get_warehouse_services() else: return rates # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º service_type, –∏–∑–º–µ–Ω–∏–º –ª–æ–≥–∏–∫—É) return rates def get_parameters_by_provider(self, provider_type): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\"\"\" parameters = [] if provider_type == 'LINE' and self.line: services = self.get_line_services() elif provider_type == 'CARRIER' and self.carrier: services = self.get_carrier_services() elif provider_type == 'WAREHOUSE' and self.warehouse: services = self.get_warehouse_services() else: return parameters # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º service_type, –∏–∑–º–µ–Ω–∏–º –ª–æ–≥–∏–∫—É) return parameters def save(self, *args, **kwargs): # –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –î–û –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–æ–≤ # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á if not self.warehouse and self.container and self.container.pk and self.container.warehouse: self.warehouse = self.container.warehouse # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ) if self.container and self.container.pk and self.co", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": " and self.container.warehouse: self.warehouse = self.container.warehouse # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ) if self.container and self.container.pk and self.container.unload_date: self.unload_date = self.container.unload_date if self.transfer_date and self.status != 'TRANSFERRED': self.status = 'TRANSFERRED' # –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ ‚Äî —Ç—è–Ω–µ–º –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (–≤ —Ç.—á. rate/free_days) –î–û –ø–µ—Ä–≤–æ–≥–æ save() if self.pk is None and self.warehouse: try: self.set_initial_warehouse_values() except Exception as e: logger.error(f\"Failed to set initial warehouse values for car {self.vin}: {e}\") if self.status == 'TRANSFERRED' and not self.transfer_date: from django.utils import timezone self.transfer_date = timezone.now().date() # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å pk super().save(*args, **kwargs) # –ø–µ—Ä–µ—Å—á—ë—Ç –ü–û–°–õ–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –∫–æ–≥–¥–∞ —É –æ–±—ä–µ–∫—Ç–∞ —É–∂–µ –µ—Å—Ç—å pk try: old_total_price = self.total_price self.calculate_total_price() # –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—â–µ —Ä–∞–∑ —Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å if self.total_price != old_total_price: super().save(update_fields=['total_price']) except Exception as e: logger.error(f\"Failed to calculate total price for car {self.vin}: {e}", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å if self.total_price != old_total_price: super().save(update_fields=['total_price']) except Exception as e: logger.error(f\"Failed to calculate total price for car {self.vin}: {e}\") # –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á if self.pk: try: Car.objects.update_related(self) except Exception as e: logger.error(f\"Failed to update related objects for car {self.id}: {e}\") # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã if self.container and self.container.pk: try: self.container.check_and_update_status_from_cars() except Exception as e: logger.error(f\"Failed to check container status for car {self.id}: {e}\") def _notify(): try: channel_layer = get_channel_layer() async_to_sync(channel_layer.group_send)( \"updates\", { \"type\": \"data_update\", \"data\": { \"model\": \"Car\", \"id\": self.id, \"status\": self.status, \"storage_cost\": str(self.storage_cost), \"days\": self.days, \"price\": str(self.total_price), }, }, ) except Exception as e: logger.error(f\"Failed to send WebSocket notification for car {self.id}: {e}\") transaction.on_commit(_notify) def __str__(self): return f\"{self.brand} ({self.vin})\" class Meta: verbose_name = \"", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "n as e: logger.error(f\"Failed to send WebSocket notification for car {self.id}: {e}\") transaction.on_commit(_notify) def __str__(self): return f\"{self.brand} ({self.vin})\" class Meta: verbose_name = \"–ê–≤—Ç–æ–º–æ–±–∏–ª—å\" verbose_name_plural = \"–ê–≤—Ç–æ–º–æ–±–∏–ª–∏\" indexes = [ models.Index(fields=['vin']), models.Index(fields=['status']), models.Index(fields=['unload_date', 'transfer_date']), # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ models.Index(fields=['client', 'status']), models.Index(fields=['warehouse', 'status']), models.Index(fields=['line']), models.Index(fields=['carrier']), models.Index(fields=['container']), models.Index(fields=['unload_date']), models.Index(fields=['transfer_date']), ] class Company(models.Model): \"\"\"–ú–æ–¥–µ–ª—å –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Caromoto Lithuania\"\"\" name = models.CharField(max_length=100, default=\"Caromoto Lithuania\", verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏\") # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã\") balance_updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω\") # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ created_at", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "rbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã\") balance_updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω\") # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ created_at = models.DateTimeField(auto_now_add=True, verbose_name=\"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è\") updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\") objects = OptimizedCompanyManager() class Meta: verbose_name = \"–ö–æ–º–ø–∞–Ω–∏—è\" verbose_name_plural = \"–ö–æ–º–ø–∞–Ω–∏–∏\" def __str__(self): return self.name class CompanyService(models.Model): \"\"\"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π\"\"\" company = models.ForeignKey(Company, on_delete=models.CASCADE, related_name='services', verbose_name=\"–ö–æ–º–ø–∞–Ω–∏—è\") name = models.CharField(max_length=200, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\") description = models.TextField(blank=True, verbose_name=\"–û–ø–∏—Å–∞–Ω–∏–µ\") default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\") default_markup = models.DecimalField( max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ\" ) is_active = models.BooleanField(default=True, verbose_name=\"–ê", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ\" ) is_active = models.BooleanField(default=True, verbose_name=\"–ê–∫—Ç–∏–≤–Ω–∞\") add_by_default = models.BooleanField( default=False, verbose_name=\"–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏\" ) def __str__(self): return f\"{self.company.name} - {self.name}\" class Meta: verbose_name = \"–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π\" # –ú–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥ class LineService(models.Model): \"\"\"–£—Å–ª—É–≥–∏ –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π\"\"\" line = models.ForeignKey(Line, on_delete=models.CASCADE, related_name='services', verbose_name=\"–õ–∏–Ω–∏—è\") name = models.CharField(max_length=200, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\") description = models.TextField(blank=True, verbose_name=\"–û–ø–∏—Å–∞–Ω–∏–µ\") default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\") default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ\") ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "= models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ\") is_active = models.BooleanField(default=True, verbose_name=\"–ê–∫—Ç–∏–≤–Ω–∞\") add_by_default = models.BooleanField( default=False, verbose_name=\"–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∏–∏\" ) def __str__(self): return f\"{self.line.name} - {self.name}\" class Meta: verbose_name = \"–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π\" class CarrierService(models.Model): \"\"\"–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤\"\"\" carrier = models.ForeignKey(Carrier, on_delete=models.CASCADE, related_name='services', verbose_name=\"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫\") name = models.CharField(max_length=200, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\") description = models.TextField(blank=True, verbose_name=\"–û–ø–∏—Å–∞–Ω–∏–µ\") default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\") default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\") default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ\") is_active = models.BooleanField(default=True, verbose_name=\"–ê–∫—Ç–∏–≤–Ω–∞\") add_by_default = models.BooleanField( default=False, verbose_name=\"–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" ) def __str__(self): return f\"{self.carrier.name} - {self.name}\" class Meta: verbose_name = \"–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤\" class WarehouseService(models.Model): \"\"\"–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤\"\"\" warehouse = models.ForeignKey(Warehouse, on_delete=models.CASCADE, related_name='services', verbose_name=\"–°–∫–ª–∞–¥\") name = models.CharField(max_length=200, verbose_name=\"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\") description = models.TextField(blank=True, verbose_name=\"–û–ø–∏—Å–∞–Ω–∏–µ\") default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\") default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_tex", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "digits=10, decimal_places=2, default=0, verbose_name=\"–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\") default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name=\"–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ\") is_active = models.BooleanField(default=True, verbose_name=\"–ê–∫—Ç–∏–≤–Ω–∞\") add_by_default = models.BooleanField(default=False, verbose_name=\"–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\", help_text=\"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ\") def __str__(self): return f\"{self.warehouse.name} - {self.name}\" class Meta: verbose_name = \"–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤\" class DeletedCarService(models.Model): \"\"\"–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —É—Å–ª—É–≥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='deleted_services', verbose_name=\"–ê–≤—Ç–æ–º–æ–±–∏–ª—å\") service_type = models.CharField(max_length=20, choices=[ ('LINE', '–õ–∏–Ω–∏—è'), ('CARRIER', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'), ('WAREHOUSE', '–°–∫–ª–∞–¥'), ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'), ], verbose_name=\"–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\") service_id = models.PositiveIntegerField(verbose_name=\"ID —É—Å–ª—É–≥–∏\") deleted_at = models.DateTimeField", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": ", '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'), ('WAREHOUSE', '–°–∫–ª–∞–¥'), ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'), ], verbose_name=\"–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\") service_id = models.PositiveIntegerField(verbose_name=\"ID —É—Å–ª—É–≥–∏\") deleted_at = models.DateTimeField(auto_now_add=True, verbose_name=\"–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è\") class Meta: unique_together = ['car', 'service_type', 'service_id'] verbose_name = \"–£–¥–∞–ª–µ–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\" verbose_name_plural = \"–£–¥–∞–ª–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π\" class CarService(models.Model): \"\"\"–°–≤—è–∑—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —É—Å–ª—É–≥–∞–º–∏ –∏ –∏—Ö —Ü–µ–Ω–∞–º–∏\"\"\" SERVICE_TYPES = [ ('LINE', '–õ–∏–Ω–∏—è'), ('CARRIER', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'), ('WAREHOUSE', '–°–∫–ª–∞–¥'), ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'), ] car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='car_services', verbose_name=\"–ê–≤—Ç–æ–º–æ–±–∏–ª—å\") service_type = models.CharField(max_length=20, choices=SERVICE_TYPES, verbose_name=\"–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\") service_id = models.PositiveIntegerField(verbose_name=\"ID —É—Å–ª—É–≥–∏\") custom_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name=\"–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞\") markup_amount = models.DecimalField( max_digits=10, decimal_places=2, default=0, verbose_name=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞\", help_text=\"–°—É–º–º–∞ –Ω–∞—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞\") markup_amount = models.DecimalField( max_digits=10, decimal_places=2, default=0, verbose_name=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞\", help_text=\"–°—É–º–º–∞ –Ω–∞—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ (—Å–∫—Ä—ã—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)\" ) quantity = models.PositiveIntegerField(default=1, verbose_name=\"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ\") notes = models.TextField(blank=True, verbose_name=\"–ü—Ä–∏–º–µ—á–∞–Ω–∏—è\") created_at = models.DateTimeField(auto_now_add=True, verbose_name=\"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è\") updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\") def __str__(self): return f\"{self.car.vin} - {self.get_service_name()}: {self.final_price}\" def get_service_name(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\"\"\" if self.service_type == 'LINE': try: service = LineService.objects.get(id=self.service_id) return service.name except LineService.DoesNotExist: return \"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\" elif self.service_type == 'CARRIER': try: service = CarrierService.objects.get(id=self.service_id) return service.name except CarrierService.DoesNotExist: return \"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\" elif self.service_type == 'WAREHOUSE': try: service = WarehouseService.objects.get(id=self.service_id) return service.name except WarehouseService.DoesNotExist: retur", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "Exist: return \"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\" elif self.service_type == 'WAREHOUSE': try: service = WarehouseService.objects.get(id=self.service_id) return service.name except WarehouseService.DoesNotExist: return \"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\" elif self.service_type == 'COMPANY': try: service = CompanyService.objects.get(id=self.service_id) return service.name except CompanyService.DoesNotExist: return \"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\" return \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞\" def get_default_price(self): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\"\"\" if self.service_type == 'LINE': try: service = LineService.objects.get(id=self.service_id) return service.default_price except LineService.DoesNotExist: return 0 elif self.service_type == 'CARRIER': try: service = CarrierService.objects.get(id=self.service_id) return service.default_price except CarrierService.DoesNotExist: return 0 elif self.service_type == 'WAREHOUSE': try: service = WarehouseService.objects.get(id=self.service_id) return service.default_price except WarehouseService.DoesNotExist: return 0 elif self.service_type == 'COMPANY': try: service = CompanyService.objects.get(id=self.service_id) return service.default_price except CompanyService.DoesNotExist: return 0 return 0 @property ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "eturn 0 elif self.service_type == 'COMPANY': try: service = CompanyService.objects.get(id=self.service_id) return service.default_price except CompanyService.DoesNotExist: return 0 return 0 @property def final_price(self): \"\"\"–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–ë–ï–ó —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ - –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞)\"\"\" # –ò—Å–ø–æ–ª—å–∑—É–µ–º custom_price –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ 0), –∏–Ω–∞—á–µ default_price price = self.custom_price if self.custom_price is not None else self.get_default_price() return price * self.quantity @property def invoice_price(self): \"\"\"–¶–µ–Ω–∞ –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ (–° —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)\"\"\" # –ò—Å–ø–æ–ª—å–∑—É–µ–º custom_price –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ 0), –∏–Ω–∞—á–µ default_price base_price = self.custom_price if self.custom_price is not None else self.get_default_price() markup = self.markup_amount or Decimal('0') return (base_price + markup) * self.quantity def get_total_distributed_markup(self): \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ\"\"\" if not self.car_id: return Decimal('0') return CarService.objects.filter(car_id=self.car_id).aggregate( total=models.Sum('markup_amount') )['total'] or Decimal('0') class Meta: verbose_name = \"–£—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π\"", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ice.objects.filter(car_id=self.car_id).aggregate( total=models.Sum('markup_amount') )['total'] or Decimal('0') class Meta: verbose_name = \"–£—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π\" unique_together = ('car', 'service_type', 'service_id') indexes = [ models.Index(fields=['car', 'service_type']), models.Index(fields=['service_type', 'service_id']), models.Index(fields=['car']), ] # –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ from django.db.models.signals import post_save, post_delete from django.dispatch import receiver @receiver(post_save, sender=CarService) def recalculate_car_price_on_service_save(sender, instance, **kwargs): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏\"\"\" # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥ if getattr(instance.car, '_creating_services', False): return try: instance.car.calculate_total_price() # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã Car.objects.filter(id=instance.car.id).update( total_price=instance.car.total_price ) except Exception as e: print(f\"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}\") @receiver(post_delete, sender=CarService) def recalculate_", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "ance.car.id).update( total_price=instance.car.total_price ) except Exception as e: print(f\"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}\") @receiver(post_delete, sender=CarService) def recalculate_car_price_on_service_delete(sender, instance, **kwargs): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏\"\"\" # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥ if getattr(instance.car, '_creating_services', False): return try: instance.car.calculate_total_price() # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã Car.objects.filter(id=instance.car.id).update( total_price=instance.car.total_price ) except Exception as e: print(f\"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}\") @receiver(post_save, sender=Car) def recalculate_car_price_on_car_save(sender, instance, **kwargs): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ —Ä–∞—Å—á–µ—Ç\"\"\" # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ if getattr(instance, '_recalculating_price', False): return if getattr(instance, '_creating_services', False): return try: # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ if hasattr(instance, '_state') and instance._state.adding: return # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ update_fields=['total_price'] - –æ–∑–Ω–∞—á–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": "'_creating_services', False): return try: # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ if hasattr(instance, '_state') and instance._state.adding: return # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ update_fields=['total_price'] - –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ü–µ–Ω–∞ —É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ update_fields = kwargs.get('update_fields') if update_fields and 'total_price' in update_fields: return # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ instance._recalculating_price = True try: instance.calculate_total_price() # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã Car.objects.filter(id=instance.id).update( total_price=instance.total_price ) finally: instance._recalculating_price = False except Exception as e: print(f\"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è: {e}\") # ============================================================================== # üéâ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í –ò –ü–õ–ê–¢–ï–ñ–ï–ô # ============================================================================== # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã Django –∏—Ö –≤–∏–¥–µ–ª from .models_billing import ( NewInvoice, InvoiceItem, Transaction, SimpleBalanceMixin ) # ============================================================================== # üåê –ú–û–î–ï–õ–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û –°–ê–ô–¢–ê # ========================", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models.py", "content": " NewInvoice, InvoiceItem, Transaction, SimpleBalanceMixin ) # ============================================================================== # üåê –ú–û–î–ï–õ–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û –°–ê–ô–¢–ê # ============================================================================== # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞ from .models_website import ( ClientUser, CarPhoto, ContainerPhoto, AIChat, NewsPost, ContactMessage, TrackingRequest )", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "from django.contrib import admin # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) from .admin_website import ( ClientUserAdmin, AIChatAdmin, NewsPostAdmin, ContactMessageAdmin, TrackingRequestAdmin ) from .models_website import ContainerPhoto from django.utils import timezone from django.urls import reverse from django.utils.html import format_html from django.utils.safestring import mark_safe from django.http import HttpResponseRedirect from django.shortcuts import render from django.core.exceptions import ValidationError from django.db import models from django import forms from decimal import Decimal from .models import Client, Warehouse, Car, Container, Line, Company, Carrier, LineService, CarrierService, WarehouseService, CompanyService, CarService, DeletedCarService from .forms import LineForm, CarrierForm, WarehouseForm from .admin_filters import MultiStatusFilter, MultiWarehouseFilter, ClientAutocompleteFilter # Inline —Ñ–æ—Ä–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ class WarehouseServiceInline(admin.TabularInline): model = WarehouseService extra = 1 fields = ('name', 'description', 'default_price', 'default_ma", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∞–º–∏ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ class WarehouseServiceInline(admin.TabularInline): model = WarehouseService extra = 1 fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default') verbose_name = \"–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞\" def get_formset(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) formset.form.base_fields['description'].widget.attrs.update({'rows': 1}) return formset class LineServiceInline(admin.TabularInline): model = LineService extra = 1 fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default') verbose_name = \"–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏\" def get_formset(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) formset.form.base_fields['description'].widget.attrs.update({'rows': 1}) return formset class LineTHSCoefficientInline(admin.TabularInline): \"\"\"Inline –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–° –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç \"–≤–µ—Å\" —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS: - 1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–ª–µ–≥–∫–æ–≤–æ–π) - 2.0 = –¥–≤–æ–π–Ω–æ–π (–¥–∂–∏–ø, RV) - 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞ (–º–æ—Ç–æ—Ü–∏–∫–ª) \"\"", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¢–° –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç \"–≤–µ—Å\" —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS: - 1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–ª–µ–≥–∫–æ–≤–æ–π) - 2.0 = –¥–≤–æ–π–Ω–æ–π (–¥–∂–∏–ø, RV) - 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞ (–º–æ—Ç–æ—Ü–∏–∫–ª) \"\"\" from .models import LineTHSCoefficient model = LineTHSCoefficient extra = 0 fields = ('vehicle_type', 'coefficient') verbose_name = \"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°\" verbose_name_plural = \"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°\" def get_extra(self, request, obj=None, **kwargs): \"\"\"–ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ 11 —Ç–∏–ø–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è\"\"\" if obj and obj.ths_coefficients.exists(): return 0 return 11 # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –¢–° class CarrierServiceInline(admin.TabularInline): model = CarrierService extra = 1 fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default') verbose_name = \"–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" def get_formset(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) formset.form.base_fields['description'].widget.attrs.update({'rows': 1}) return formset class CompanyServiceInline(admin.TabularInline): model = CompanyService extra = 1 fields = ('name', 'description', 'default_price',", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ields['description'].widget.attrs.update({'rows': 1}) return formset class CompanyServiceInline(admin.TabularInline): model = CompanyService extra = 1 fields = ('name', 'description', 'default_price', 'default_markup', 'is_active', 'add_by_default') verbose_name = \"–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏\" verbose_name_plural = \"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏\" def get_formset(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) formset.form.base_fields['description'].widget.attrs.update({'rows': 1}) return formset # –§–æ—Ä–º–∞ –¥–ª—è CarServiceInline class CarServiceInlineForm(forms.ModelForm): # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏ warehouse_service = forms.ModelChoiceField( queryset=WarehouseService.objects.select_related('warehouse').filter(is_active=True), required=False, label=\"–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞\", help_text=\"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É —Å–∫–ª–∞–¥–∞\" ) line_service = forms.ModelChoiceField( queryset=LineService.objects.select_related('line').filter(is_active=True), required=False, label=\"–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏\", help_text=\"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏\" ) carrier_service = forms.ModelChoiceField( queryset=CarrierService.objects.select_related('carrier').filter(is_active=True), required=False, label=\"–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\", help_text=\"", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏\" ) carrier_service = forms.ModelChoiceField( queryset=CarrierService.objects.select_related('carrier').filter(is_active=True), required=False, label=\"–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\", help_text=\"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" ) company_service = forms.ModelChoiceField( queryset=CompanyService.objects.select_related('company').filter(is_active=True), required=False, label=\"–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏\", help_text=\"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∫–æ–º–ø–∞–Ω–∏–∏\" ) class Meta: model = CarService fields = '__all__' def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è if self.instance and self.instance.pk: if self.instance.service_type == 'WAREHOUSE': try: self.fields['warehouse_service'].initial = self.instance.service_id except: pass elif self.instance.service_type == 'LINE': try: self.fields['line_service'].initial = self.instance.service_id except: pass elif self.instance.service_type == 'CARRIER': try: self.fields['carrier_service'].initial = self.instance.service_id except: pass elif self.instance.service_type == 'COMPANY': try: self.fields['company_service'].initial = self.instance.service_id except: pass def save(self, commit=True", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ial = self.instance.service_id except: pass elif self.instance.service_type == 'COMPANY': try: self.fields['company_service'].initial = self.instance.service_id except: pass def save(self, commit=True): instance = super().save(commit=False) # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ if instance.service_type == 'WAREHOUSE' and self.cleaned_data.get('warehouse_service'): instance.service_id = self.cleaned_data['warehouse_service'].id elif instance.service_type == 'LINE' and self.cleaned_data.get('line_service'): instance.service_id = self.cleaned_data['line_service'].id elif instance.service_type == 'CARRIER' and self.cleaned_data.get('carrier_service'): instance.service_id = self.cleaned_data['carrier_service'].id elif instance.service_type == 'COMPANY' and self.cleaned_data.get('company_service'): instance.service_id = self.cleaned_data['company_service'].id if commit: instance.save() return instance # Inline –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Å–ª—É–≥–∞–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è class CarServiceInline(admin.TabularInline): model = CarService form = CarServiceInlineForm extra = 1 can_delete = True fields = ('service_type', 'warehouse_service', 'line_service', 'carrier_service', 'servic", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ServiceInline(admin.TabularInline): model = CarService form = CarServiceInlineForm extra = 1 can_delete = True fields = ('service_type', 'warehouse_service', 'line_service', 'carrier_service', 'service_display', 'warehouse_display', 'custom_price', 'markup_amount', 'quantity', 'final_price_display', 'invoice_price_display', 'notes') readonly_fields = ('service_display', 'warehouse_display', 'final_price_display', 'invoice_price_display') verbose_name = \"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —É—Å–ª—É–≥–∞\" verbose_name_plural = \"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (–æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤/–∫–æ–º–ø–∞–Ω–∏–π)\" def service_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏\"\"\" if obj and obj.pk: return obj.get_service_name() return \"-\" service_display.short_description = \"–£—Å–ª—É–≥–∞\" def warehouse_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–∫–ª–∞–¥/–∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è —É—Å–ª—É–≥–∏\"\"\" if not obj or not obj.pk: return \"-\" if obj.service_type == 'WAREHOUSE': try: service = WarehouseService.objects.select_related('warehouse').get(id=obj.service_id) return service.warehouse.name except WarehouseService.DoesNotExist: return \"–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω\" elif obj.service_type == 'LINE': try: service = LineService.objects.select_related('line').get(id=obj.service_id) return service.line.name e", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ept WarehouseService.DoesNotExist: return \"–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω\" elif obj.service_type == 'LINE': try: service = LineService.objects.select_related('line').get(id=obj.service_id) return service.line.name except LineService.DoesNotExist: return \"–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\" elif obj.service_type == 'CARRIER': try: service = CarrierService.objects.select_related('carrier').get(id=obj.service_id) return service.carrier.name except CarrierService.DoesNotExist: return \"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω\" return \"-\" warehouse_display.short_description = \"–ö–æ–º–ø–∞–Ω–∏—è/–°–∫–ª–∞–¥\" def final_price_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É (–±–µ–∑ —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)\"\"\" if obj and obj.pk: return f\"{obj.final_price:.2f}\" return \"0.00\" final_price_display.short_description = \"–ò—Ç–æ–≥–æ\" def invoice_price_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ü–µ–Ω—É –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ (—Å —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)\"\"\" if obj and obj.pk: return f\"{obj.invoice_price:.2f}\" return \"0.00\" invoice_price_display.short_description = \"–í –∏–Ω–≤–æ–π—Å–µ\" def get_formset(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏—è formset.form.base_fields['service_type'].help_text = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞' formset.form.base_fields['cust", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ne, **kwargs): formset = super().get_formset(request, obj, **kwargs) # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏—è formset.form.base_fields['service_type'].help_text = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞' formset.form.base_fields['custom_price'].help_text = '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' formset.form.base_fields['quantity'].help_text = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥' return formset import json import logging from django.db.models import Q from django.contrib.admin import SimpleListFilter logger = logging.getLogger('django') CONTAINER_STATUS_COLORS = { '–í –ø—É—Ç–∏': '#2772a8', # –¢–µ–º–Ω–µ–µ —Å–∏–Ω–µ–≥–æ '–í –ø–æ—Ä—Ç—É': '#8B0000', # –¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π '–†–∞–∑–≥—Ä—É–∂–µ–Ω': '#239f58', # –¢–µ–º–Ω–µ–µ –∑–µ–ª—ë–Ω–æ–≥–æ '–ü–µ—Ä–µ–¥–∞–Ω': '#78458c', # –¢–µ–º–Ω–µ–µ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ } class CarInline(admin.TabularInline): model = Car extra = 1 can_delete = True show_change_link = True # –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã fields = ('year', 'brand', 'vehicle_type', 'vin', 'client', 'total_price', 'has_title') # –¥–æ–±–∞–≤–∏–ª–∏ vehicle_type readonly_fields = ('total_price',) def get_formset(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) for field in formset.form.base_fields.values(): field.help_text = '' return formset class ContainerPhotoIn", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "set(self, request, obj=None, **kwargs): formset = super().get_formset(request, obj, **kwargs) for field in formset.form.base_fields.values(): field.help_text = '' return formset class ContainerPhotoInline(admin.TabularInline): \"\"\" Inline –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å Google Drive. \"\"\" model = ContainerPhoto extra = 0 # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è - —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ can_delete = True max_num = 100 # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ fields = ('thumbnail_preview', 'photo', 'photo_type', 'is_public') readonly_fields = ('thumbnail_preview',) verbose_name = \"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è\" verbose_name_plural = \"üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\" def thumbnail_preview(self, obj): \"\"\"–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏\"\"\" if obj.thumbnail: return format_html( '<a href=\"{}\" target=\"_blank\"><img src=\"{}\" style=\"max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;\" /></a>', obj.photo.url if obj.photo else '#', obj.thumbnail.url ) elif obj.photo: return format_html( '<a href=\"{}\" target=\"_blank\"><img src=\"{}\" style=\"max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;\" /></a>', obj.photo.url, ob", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "umbnail.url ) elif obj.photo: return format_html( '<a href=\"{}\" target=\"_blank\"><img src=\"{}\" style=\"max-width: 80px; max-height: 80px; border-radius: 4px; cursor: pointer;\" /></a>', obj.photo.url, obj.photo.url ) return '-' thumbnail_preview.short_description = '–ü—Ä–µ–≤—å—é' def get_queryset(self, request): \"\"\"–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è\"\"\" return super().get_queryset(request).only('id', 'container', 'photo', 'thumbnail', 'photo_type', 'is_public') # CarServiceInline —É–¥–∞–ª–µ–Ω class ContainerAdmin(admin.ModelAdmin): change_form_template = 'admin/core/container/change_form.html' list_display = ('number', 'colored_status', 'eta', 'planned_unload_date', 'unload_date', 'line', 'warehouse', 'photos_count_display') list_display_links = ('number',) # –î–µ–ª–∞–µ–º –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º list_filter = (MultiStatusFilter, ClientAutocompleteFilter, MultiWarehouseFilter) search_fields = ('number',) ordering = ['-unload_date', '-id'] # –°–Ω–∞—á–∞–ª–∞ –ø–æ –¥–∞—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É), –ø–æ—Ç–æ–º –ø–æ ID inlines = [CarInline, ContainerPhotoInline] # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–¥ —Å–ø–∏—Å–∫–æ–º –º–∞—à–∏–Ω fieldsets = ( ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', { 'classes': ('collapse',), 'fields': ( ('number', 'status', 'line', 'warehouse'), ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–º –ø–æ ID inlines = [CarInline, ContainerPhotoInline] # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–¥ —Å–ø–∏—Å–∫–æ–º –º–∞—à–∏–Ω fieldsets = ( ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', { 'classes': ('collapse',), 'fields': ( ('number', 'status', 'line', 'warehouse'), ('ths', 'ths_payer'), ('eta', 'planned_unload_date', 'unload_date'), 'google_drive_folder_url', ) }), ) readonly_fields = ('days', 'storage_cost') actions = ['set_status_floating', 'set_status_in_port', 'set_status_unloaded', 'set_status_transferred', 'check_container_status', 'bulk_update_container_statuses', 'sync_photos_from_gdrive', 'resend_planned_notifications', 'resend_unload_notifications'] class Media: css = {'all': ('css/logist2_custom_admin.css',)} js = ('js/htmx.min.js',) def get_queryset(self, request): qs = super().get_queryset(request) return qs.select_related('line', 'client', 'warehouse').prefetch_related('container_cars') def save_model(self, request, obj, form, change): import time start_time = time.time() logger.info(f\"[TIMING] Container save_model started for {obj.number}\") # –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∏ —É –Ω–µ–≥–æ –µ—â–µ –Ω–µ—Ç pk, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ if not change and not obj.pk: super().save_model(request, obj, form, change) elif change: # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –æ–±—ã", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "er}\") # –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∏ —É –Ω–µ–≥–æ –µ—â–µ –Ω–µ—Ç pk, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ if not change and not obj.pk: super().save_model(request, obj, form, change) elif change: # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ super().save_model(request, obj, form, change) logger.info(f\"[TIMING] Container saved in {time.time() - start_time:.2f}s\") # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Å–∫–ª–∞–¥ ‚Äî —Ä–∞–∑–Ω–µ—Å—ë–º –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥ –≤–æ –≤—Å–µ –∞–≤—Ç–æ if change and form and 'warehouse' in getattr(form, 'changed_data', []): try: logger.info(f\"Warehouse changed for container {obj.id}, syncing cars...\") obj.sync_cars_after_warehouse_change() logger.info(f\"Successfully synced warehouse for {obj.container_cars.count()} cars\") except Exception as e: logger.error(f\"Failed to sync cars after warehouse change for container {obj.id}: {e}\") # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Å—Ç–∞—Ç—É—Å ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ if change and form and 'status' in getattr(form, 'changed_data', []): try: logger.info(f\"Status changed for container {obj.id} to {obj.status}, bulk updating all cars...\") updated_count = obj.container_cars.update(status=obj.status) logger.info(f\"‚úÖ Updated status to '{obj.status}' for {updated_count} cars in container {obj.number}\") except Exception as e:", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " all cars...\") updated_count = obj.container_cars.update(status=obj.status) logger.info(f\"‚úÖ Updated status to '{obj.status}' for {updated_count} cars in container {obj.number}\") except Exception as e: logger.error(f\"Failed to update car statuses for container {obj.id}: {e}\") # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ if change and form and 'unload_date' in getattr(form, 'changed_data', []): try: from django.db.models.signals import post_save, post_delete from core.signals import update_related_on_car_save, create_car_services_on_car_save, recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete logger.info(f\"Unload date changed for container {obj.id} to {obj.unload_date}, bulk updating all cars...\") # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑ –ë–î, —á—Ç–æ–±—ã –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö obj.refresh_from_db() # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ post_save.disconnect(update_related_on_car_save, sender=Car) post_save.disconnect(create_car_services_on_car_save, sender=Car) post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService) post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService) ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "car_services_on_car_save, sender=Car) post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService) post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService) cars_to_update = [] affected_invoices = set() for car in obj.container_cars.select_related('warehouse').all(): # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ —É –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π car.unload_date = obj.unload_date car.update_days_and_storage() car.calculate_total_price() cars_to_update.append(car) # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) for invoice in car.newinvoice_set.all(): affected_invoices.add(invoice) # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º if cars_to_update: Car.objects.bulk_update( cars_to_update, ['unload_date', 'days', 'storage_cost', 'total_price'], batch_size=50 ) logger.info(f\"‚úÖ Bulk updated {len(cars_to_update)} cars in container {obj.number}\") # –í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ post_save.connect(update_related_on_car_save, sender=Car) post_save.connect(create_car_services_on_car_save, sender=Car) post_save.connect(recalculate_car_price_on_service_save, sender=CarService) post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService) # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–Ω–≤–æ–π—Å—ã –æ–¥–Ω", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "=Car) post_save.connect(recalculate_car_price_on_service_save, sender=CarService) post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService) # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–Ω–≤–æ–π—Å—ã –æ–¥–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º if affected_invoices: logger.info(f\"Updating {len(affected_invoices)} affected invoices...\") for invoice in affected_invoices: try: if hasattr(invoice, 'regenerate_items_from_cars'): # NewInvoice invoice.regenerate_items_from_cars() else: # InvoiceOLD invoice.update_total_amount() except Exception as e: logger.error(f\"Error updating invoice {invoice.id}: {e}\") logger.info(f\"‚úÖ Updated {len(affected_invoices)} invoices\") except Exception as e: logger.error(f\"Failed to update cars after unload_date change for container {obj.id}: {e}\") # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∏–≥–Ω–∞–ª—ã –≤–∫–ª—é—á–µ–Ω—ã –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ try: from django.db.models.signals import post_save, post_delete from core.signals import update_related_on_car_save, create_car_services_on_car_save, recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete post_save.connect(update_related_on_car_save, sender=Car) post_save.connect(create_car_services_on_car_save, sender=Car) post_save.connect(recalculate_car_price_on_ser", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "late_car_price_on_service_delete post_save.connect(update_related_on_car_save, sender=Car) post_save.connect(create_car_services_on_car_save, sender=Car) post_save.connect(recalculate_car_price_on_service_save, sender=CarService) post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService) except: pass # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å THS: –ª–∏–Ω–∏—è, —Å—É–º–º–∞ THS, –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ THS, —Å–∫–ª–∞–¥ # –°–∫–ª–∞–¥ –≤–∫–ª—é—á—ë–Ω –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ ths_payer='WAREHOUSE' THS –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞ changed_data = getattr(form, 'changed_data', []) if form else [] ths_related_changed = any(field in changed_data for field in ['line', 'ths', 'ths_payer', 'warehouse']) # –î–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - —Å–æ–∑–¥–∞—ë–º THS –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã line –∏ ths # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è THS –∏–ª–∏ —Å–∫–ª–∞–¥ should_create_ths = (not change and obj.line and obj.ths) or (change and ths_related_changed) # –µ—Å–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å THS –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ THS –ø–æ–ª—è ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —É—Å–ª—É–≥–∏ THS if should_create_ths: line_start = time.time() try: from django.db.models.signals import post_save, post_delete from core.signals import update_related_on_car_save, create_car_services_on_car_save, create_ths_services_for_container, recalcu", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "time() try: from django.db.models.signals import post_save, post_delete from core.signals import update_related_on_car_save, create_car_services_on_car_save, create_ths_services_for_container, recalculate_invoices_on_car_service_save, recalculate_invoices_on_car_service_delete from core.models import recalculate_car_price_on_service_save, recalculate_car_price_on_service_delete, LineService, WarehouseService from core.models_billing import NewInvoice logger.info(f\"[TIMING] THS-related change started for container {obj.id}, line: {obj.line}, ths: {obj.ths}, ths_payer: {obj.ths_payer}\") # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï —Å–∏–≥–Ω–∞–ª—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏ –∏ –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π post_save.disconnect(update_related_on_car_save, sender=Car) post_save.disconnect(create_car_services_on_car_save, sender=Car) post_save.disconnect(recalculate_car_price_on_service_save, sender=CarService) post_delete.disconnect(recalculate_car_price_on_service_delete, sender=CarService) post_save.disconnect(recalculate_invoices_on_car_service_save, sender=CarService) post_delete.disconnect(recalculate_invoices_on_car_service_delete, sender=CarService) try: # 1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º –ª–∏–Ω–∏—é —É –≤—Å–µ—Ö –∞–≤—Ç–æ if 'line'", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "es_on_car_service_save, sender=CarService) post_delete.disconnect(recalculate_invoices_on_car_service_delete, sender=CarService) try: # 1. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º –ª–∏–Ω–∏—é —É –≤—Å–µ—Ö –∞–≤—Ç–æ if 'line' in changed_data: car_ids = list(obj.container_cars.values_list('id', flat=True)) updated_count = obj.container_cars.update(line=obj.line) logger.info(f\"[TIMING] Line updated for {updated_count} cars\") # 2. –°–æ–∑–¥–∞—ë–º —É—Å–ª—É–≥–∏ THS —Å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º if obj.line and obj.ths: created_count = create_ths_services_for_container(obj) logger.info(f\"[TIMING] Created {created_count} THS services with proportional distribution\") else: # –ï—Å–ª–∏ –ª–∏–Ω–∏–∏ –Ω–µ—Ç –∏–ª–∏ THS = 0, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É—Å–ª—É–≥–∏ THS car_ids = list(obj.container_cars.values_list('id', flat=True)) # –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥–∏ THS –æ—Ç –ª–∏–Ω–∏–π deleted_line = CarService.objects.filter( car_id__in=car_ids, service_type='LINE' ).filter( service_id__in=LineService.objects.filter(name__icontains='THS').values_list('id', flat=True) ).delete() # –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥–∏ THS –æ—Ç —Å–∫–ª–∞–¥–æ–≤ deleted_wh = CarService.objects.filter( car_id__in=car_ids, service_type='WAREHOUSE' ).filter( service_id__in=WarehouseService.objects.filter(name__icontains='THS').values_list('id',", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–≥–∏ THS –æ—Ç —Å–∫–ª–∞–¥–æ–≤ deleted_wh = CarService.objects.filter( car_id__in=car_ids, service_type='WAREHOUSE' ).filter( service_id__in=WarehouseService.objects.filter(name__icontains='THS').values_list('id', flat=True) ).delete() logger.info(f\"[TIMING] Deleted {deleted_line[0]} line THS services and {deleted_wh[0]} warehouse THS services\") # 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∞–≤—Ç–æ (BULK) cars_to_update = [] affected_invoices = set() for car in obj.container_cars.select_related('warehouse').all(): car.update_days_and_storage() car.calculate_total_price() cars_to_update.append(car) # –°–æ–±–∏—Ä–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã for invoice in NewInvoice.objects.filter(cars=car, status__in=['DRAFT', 'ISSUED', 'PARTIALLY_PAID', 'OVERDUE']): affected_invoices.add(invoice) if cars_to_update: Car.objects.bulk_update( cars_to_update, ['days', 'storage_cost', 'total_price'], batch_size=50 ) logger.info(f\"[TIMING] Recalculated prices for {len(cars_to_update)} cars\") # 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã if affected_invoices: logger.info(f\"[TIMING] Updating {len(affected_invoices)} affected invoices...\") for invoice in affected_invoices: try: invoice.regenerate_items_from_cars() except Exception as e: logger.error(f\"Error upd", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ger.info(f\"[TIMING] Updating {len(affected_invoices)} affected invoices...\") for invoice in affected_invoices: try: invoice.regenerate_items_from_cars() except Exception as e: logger.error(f\"Error updating invoice {invoice.number}: {e}\") logger.info(f\"[TIMING] Invoices updated\") logger.info(f\"[TIMING] THS-related change completed in {time.time() - line_start:.2f}s\") finally: # –í–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ post_save.connect(update_related_on_car_save, sender=Car) post_save.connect(create_car_services_on_car_save, sender=Car) post_save.connect(recalculate_car_price_on_service_save, sender=CarService) post_delete.connect(recalculate_car_price_on_service_delete, sender=CarService) post_save.connect(recalculate_invoices_on_car_service_save, sender=CarService) post_delete.connect(recalculate_invoices_on_car_service_delete, sender=CarService) except Exception as e: logger.error(f\"Failed to update cars after line change for container {obj.id}: {e}\", exc_info=True) def save_formset(self, request, form, formset, change): import time formset_start = time.time() logger.info(f\"[TIMING] save_formset started for {formset.model.__name__}\") instances = formset.save(commit=False) logger.info(f\"[TIMING] ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "orm, formset, change): import time formset_start = time.time() logger.info(f\"[TIMING] save_formset started for {formset.model.__name__}\") instances = formset.save(commit=False) logger.info(f\"[TIMING] formset.save(commit=False) took {time.time() - formset_start:.2f}s\") parent = form.instance # –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á if not parent.pk: logger.error(\"Parent container doesn't have a primary key - saving parent first\") # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –æ–±—ä–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞ parent.save() logger.info(f\"Saved parent container {parent.pk}\") # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∏ –Ω–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ if not instances and not formset.deleted_objects: logger.info(f\"[TIMING] No changes in formset, skipping. Total: {time.time() - formset_start:.2f}s\") formset.save_m2m() return logger.info(f\"[TIMING] Processing {len(instances)} changed instances\") for obj in instances: if isinstance(obj, Car): # –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É if not obj.container_id: obj.container = parent # —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ –∫–∞–∫ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ obj.status = parent.status # —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç/–ª–∏–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã if not obj.warehouse_id and parent.warehouse_id: obj.warehouse = parent.warehouse ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "parent # —Å—Ç–∞—Ç—É—Å –≤—Å–µ–≥–¥–∞ –∫–∞–∫ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ obj.status = parent.status # —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç/–ª–∏–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã if not obj.warehouse_id and parent.warehouse_id: obj.warehouse = parent.warehouse if not obj.client_id and parent.client_id: obj.client = parent.client if not obj.line_id and parent.line_id: obj.line = parent.line # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ) if parent.unload_date: obj.unload_date = parent.unload_date logger.debug(f\"Car {obj.vin}: inherited unload_date={obj.unload_date} from container {parent.number}\") creating = obj.pk is None if creating and obj.warehouse_id: # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (rate/free_days –∏ –ø—Ä.) –î–û –ø–µ—Ä–≤–æ–≥–æ save() obj.set_initial_warehouse_values() # –ø–µ—Ä–µ—Å—á—ë—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º obj.update_days_and_storage() # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç - —Å–∏–≥–Ω–∞–ª post_save –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç calculate_total_price obj.save() logger.debug(f\"Saved Car {obj.vin} (creating={creating}, has_title={obj.has_title})\") # –î–ª—è –Ω–æ–≤—ã—Ö –º–∞—à–∏–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—ë–º —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π if creating and obj.warehouse_id: from core.models import WarehouseService, CarService from decimal import Decimal warehouse_services = WarehouseService.objects.filter( warehou", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π if creating and obj.warehouse_id: from core.models import WarehouseService, CarService from decimal import Decimal warehouse_services = WarehouseService.objects.filter( warehouse=obj.warehouse, is_active=True, add_by_default=True ) for service in warehouse_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —É—Å–ª—É–≥–∏ if not CarService.objects.filter(car=obj, service_type='WAREHOUSE', service_id=service.id).exists(): # –î–ª—è \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∏ –Ω–∞—Ü–µ–Ω–∫—É √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π if service.name == '–•—Ä–∞–Ω–µ–Ω–∏–µ': days = Decimal(str(obj.days or 0)) custom_price = days * Decimal(str(service.default_price or 0)) default_markup = days * Decimal(str(service.default_markup or 0)) else: custom_price = service.default_price default_markup = service.default_markup or Decimal('0') CarService.objects.create( car=obj, service_type='WAREHOUSE', service_id=service.id, custom_price=custom_price, markup_amount=default_markup ) logger.info(f\"üè≠ [FORMSET] –°–æ–∑–¥–∞–Ω–∞ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞ '{service.name}' –¥–ª—è {obj.vin} (—Ü–µ–Ω–∞: {custom_price}, –Ω–∞—Ü–µ–Ω–∫–∞: {default_markup})\") else: obj.save() # –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ deleted_cars = [o for o in formset.deleted_objects if isinstance(o, Car)] logger.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "bj.vin} (—Ü–µ–Ω–∞: {custom_price}, –Ω–∞—Ü–µ–Ω–∫–∞: {default_markup})\") else: obj.save() # –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ deleted_cars = [o for o in formset.deleted_objects if isinstance(o, Car)] logger.info(f\"[FORMSET] deleted_objects count: {len(formset.deleted_objects)}, deleted_cars: {len(deleted_cars)}\") for o in formset.deleted_objects: try: # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService if isinstance(o, Car): o.car_services.all().delete() o.delete() logger.info(f\"[FORMSET] Deleted object: {o}\") except Exception as e: logger.error(f\"Error deleting object {o}: {e}\") formset.save_m2m() # –ü–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¢–° (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ) - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS # –£—Å–ª–æ–≤–∏–µ: –µ—Å—Ç—å line, –µ—Å—Ç—å ths, –∏ (–µ—Å—Ç—å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã) cars_changed = bool(instances) or bool(deleted_cars) logger.info(f\"[FORMSET] instances count: {len(instances)}, cars_changed: {cars_changed}\") logger.info(f\"[FORMSET] parent.line: {parent.line}, parent.ths: {parent.ths}\") # –í–°–ï–ì–î–ê –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS –µ—Å–ª–∏ –µ—Å—Ç—å line –∏ ths (–¥–∞–∂–µ –±–µ–∑ —è–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π) if parent.line and parent.ths: try: from core.signals import create_ths_services_for_container from django.db import transaction # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " –µ—Å—Ç—å line –∏ ths (–¥–∞–∂–µ –±–µ–∑ —è–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π) if parent.line and parent.ths: try: from core.signals import create_ths_services_for_container from django.db import transaction # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ –ë–î parent.refresh_from_db() logger.info(f\"[FORMSET] Starting THS recalculation for container {parent.number}\") # –ò—Å–ø–æ–ª—å–∑—É–µ–º savepoint –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ with transaction.atomic(): # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS –¥–ª—è –í–°–ï–• –º–∞—à–∏–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ cars_in_container = list(parent.container_cars.all()) logger.info(f\"[FORMSET] Found {len(cars_in_container)} cars in container\") if cars_in_container: created = create_ths_services_for_container(parent) logger.info(f\"[FORMSET] Created/updated {created} THS services for container {parent.number}\") # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –í–°–ï–• –º–∞—à–∏–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è THS for car in cars_in_container: car.refresh_from_db() # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–∑ –ë–î car.calculate_total_price() car.save(update_fields=['total_price', 'storage_cost', 'days']) logger.info(f\"[FORMSET] Recalculated price for car {car.vin}: {car.total_price}\") logger.info(f\"[FORMSET] Recalculated prices for all {len(cars_in_container)} cars\") else: logger.info(f\"[FORMSET] No cars l", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "r.info(f\"[FORMSET] Recalculated price for car {car.vin}: {car.total_price}\") logger.info(f\"[FORMSET] Recalculated prices for all {len(cars_in_container)} cars\") else: logger.info(f\"[FORMSET] No cars left in container {parent.number}\") except Exception as e: logger.error(f\"Failed to create THS services in formset for container {parent.id}: {e}\", exc_info=True) def get_form(self, request, obj=None, **kwargs): form = super().get_form(request, obj, **kwargs) for field in form.base_fields.values(): field.help_text = '' return form def colored_status(self, obj): color = obj.get_status_color() return format_html( '<span style=\"background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;\">{}</span>', color, obj.get_status_display() ) colored_status.short_description = '–°—Ç–∞—Ç—É—Å' def photos_count_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\"\"\" count = obj.photos.count() if count > 0: return format_html( '<span style=\"background-color: #4285f4; color: white; padding: 2px 8px; border-radius: 10px;\">üì∑ {}</span>', count ) return '-' photos_count_display.short_description = '–§–æ—Ç–æ' def set_status_floating(self, request, queryset): updated = queryset.update(status=", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ing: 2px 8px; border-radius: 10px;\">üì∑ {}</span>', count ) return '-' photos_count_display.short_description = '–§–æ—Ç–æ' def set_status_floating(self, request, queryset): updated = queryset.update(status='FLOATING') for obj in queryset: obj.update_days_and_storage() obj.sync_cars() obj.save(update_fields=['days', 'storage_cost']) # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ obj.container_cars.update(status='FLOATING') self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø—É—Ç–∏' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.\") set_status_floating.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø—É—Ç–∏\" def set_status_in_port(self, request, queryset): updated = queryset.update(status='IN_PORT') for obj in queryset: obj.update_days_and_storage() obj.sync_cars() obj.save(update_fields=['days', 'storage_cost']) # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ obj.container_cars.update(status='IN_PORT') self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.\") set_status_in_port.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É\" def set_status_unloaded(self, request, queryset): updated = 0 for obj in queryset: if obj.warehouse and obj.unload_date: obj.status = 'UNLOADED' obj.update_day", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "scription = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É\" def set_status_unloaded(self, request, queryset): updated = 0 for obj in queryset: if obj.warehouse and obj.unload_date: obj.status = 'UNLOADED' obj.update_days_and_storage() obj.sync_cars() obj.save(update_fields=['status', 'days', 'storage_cost']) # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ obj.container_cars.update(status='UNLOADED') updated += 1 else: self.message_user(request, f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {obj.number} –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'.\", level='warning') self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.\") set_status_unloaded.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –†–∞–∑–≥—Ä—É–∂–µ–Ω\" def set_status_transferred(self, request, queryset): updated = queryset.update(status='TRANSFERRED') for obj in queryset: obj.update_days_and_storage() obj.sync_cars() obj.save(update_fields=['days', 'storage_cost']) # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É –≤—Å–µ—Ö –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ obj.container_cars.update(status='TRANSFERRED') self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.\") set_status_transferred.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω\" def check_container_status(s", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "D') self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –∏—Ö –∞–≤—Ç–æ.\") set_status_transferred.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω\" def check_container_status(self, request, queryset): \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π\"\"\" updated_count = 0 for obj in queryset: try: old_status = obj.status obj.check_and_update_status_from_cars() if obj.status != old_status: updated_count += 1 except Exception as e: logger.error(f\"Failed to check status for container {obj.number}: {e}\") if updated_count > 0: self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è {updated_count} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.\") else: self.message_user(request, \"–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\") check_container_status.short_description = \"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\" def bulk_update_container_statuses(self, request, queryset): \"\"\"–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π\"\"\" updated_count = 0 skipped_count = 0 error_count = 0 for container in queryset: try: cars = container.container_cars.all() if not cars.exists(): skipped_count += 1 continue # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã all_transferred = all(car.stat", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "count = 0 for container in queryset: try: cars = container.container_cars.all() if not cars.exists(): skipped_count += 1 continue # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã all_transferred = all(car.status == 'TRANSFERRED' for car in cars) transferred_cars_count = sum(1 for car in cars if car.status == 'TRANSFERRED') total_cars_count = cars.count() if all_transferred and container.status != 'TRANSFERRED': old_status = container.status container.status = 'TRANSFERRED' container.save(update_fields=['status']) logger.info(f\"Container {container.number} status updated from {old_status} to TRANSFERRED\") updated_count += 1 else: skipped_count += 1 except Exception as e: logger.error(f\"Failed to update container {container.number}: {e}\") error_count += 1 # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è messages = [] if updated_count > 0: messages.append(f\"–û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: {updated_count}\") if skipped_count > 0: messages.append(f\"–ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: {skipped_count}\") if error_count > 0: messages.append(f\"–û—à–∏–±–æ–∫: {error_count}\") if messages: self.message_user(request, \"; \".join(messages)) else: self.message_user(request, \"–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\") bulk_update_container_statuses.short_de", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ppend(f\"–û—à–∏–±–æ–∫: {error_count}\") if messages: self.message_user(request, \"; \".join(messages)) else: self.message_user(request, \"–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\") bulk_update_container_statuses.short_description = \"–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤\" def sync_photos_from_gdrive(self, request, queryset): \"\"\"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å Google Drive –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤\"\"\" from .google_drive_sync import GoogleDriveSync total_photos = 0 success_count = 0 error_count = 0 for container in queryset: try: # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–∞–ø–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –æ–±–µ–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö container_number = container.number photos_added = 0 # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–µ –ø–∞–ø–∫–∏ (–≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ) for folder_type, folder_id in [ ('unloaded', '1711SSTZ3_YgUcZfNrgNzhscbmlHXlsKb'), ('in_container', '11poTWYYG3uKTuGTYDWS2m8uA52mlzP6f') ]: # –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏ –º–µ—Å—è—Ü–µ–≤ month_folders = GoogleDriveSync.get_public_folder_files(folder_id) for month_folder in month_folders: if not month_folder.get('is_folder'): continue # –ü–æ–ª—É—á–∞–µ–º –ø–∞–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ container_folders = GoogleDriveSync.get_public_folder_files(month_folder['id']) for container_folder in container_folders: if container_folder['name'] == container_number", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–ø–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ container_folders = GoogleDriveSync.get_public_folder_files(month_folder['id']) for container_folder in container_folders: if container_folder['name'] == container_number: # –ù–∞—à–ª–∏ –ø–∞–ø–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞! photo_type = 'UNLOADING' if folder_type == 'unloaded' else 'GENERAL' count = GoogleDriveSync.sync_container_folder( container_number, container_folder['id'], photo_type ) photos_added += count if photos_added > 0: success_count += 1 total_photos += photos_added logger.info(f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container_number}: –¥–æ–±–∞–≤–ª–µ–Ω–æ {photos_added} —Ñ–æ—Ç–æ\") else: logger.warning(f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container_number}: –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ Google Drive\") except Exception as e: error_count += 1 logger.error(f\"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ {container.number}: {e}\") # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é if total_photos > 0: self.message_user( request, f\"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ {total_photos} —Ñ–æ—Ç–æ –¥–ª—è {success_count} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {error_count}\", level='SUCCESS' ) else: self.message_user( request, f\"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ Google Drive. –û—à–∏–±–æ–∫: {error_count}\", level='WARNING' ) sync_photos_from_gdrive.short_description = \"üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Dr", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "quest, f\"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ Google Drive. –û—à–∏–±–æ–∫: {error_count}\", level='WARNING' ) sync_photos_from_gdrive.short_description = \"üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å Google Drive\" def resend_planned_notifications(self, request, queryset): \"\"\"–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π –¥–∞—Ç–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏\"\"\" from core.services.email_service import ContainerNotificationService total_sent = 0 total_failed = 0 containers_processed = 0 for container in queryset: if not container.planned_unload_date: self.message_user( request, f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏\", level='WARNING' ) continue sent, failed = ContainerNotificationService.send_planned_to_all_clients(container, user=request.user) total_sent += sent total_failed += failed if sent > 0: containers_processed += 1 if total_sent > 0: self.message_user( request, f\"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}\", level='SUCCESS' ) elif total_failed > 0: self.message_user( request, f\"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.\", level='ERROR' ) else: se", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "{total_failed}\", level='SUCCESS' ) elif total_failed > 0: self.message_user( request, f\"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.\", level='ERROR' ) else: self.message_user( request, \"–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)\", level='WARNING' ) resend_planned_notifications.short_description = \"üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ\" def resend_unload_notifications(self, request, queryset): \"\"\"–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\"\"\" from core.services.email_service import ContainerNotificationService total_sent = 0 total_failed = 0 containers_processed = 0 for container in queryset: if not container.unload_date: self.message_user( request, f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏\", level='WARNING' ) continue sent, failed = ContainerNotificationService.send_unload_to_all_clients(container, user=request.user) total_sent += sent total_failed += failed if sent > 0: containers_processed += 1 if total_sent > 0: self.message_user( request, f\"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}\"", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "f sent > 0: containers_processed += 1 if total_sent > 0: self.message_user( request, f\"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {total_sent} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –¥–ª—è {containers_processed} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û—à–∏–±–æ–∫: {total_failed}\", level='SUCCESS' ) elif total_failed > 0: self.message_user( request, f\"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –û—à–∏–±–æ–∫: {total_failed}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∫–ª–∏–µ–Ω—Ç–æ–≤.\", level='ERROR' ) else: self.message_user( request, \"–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)\", level='WARNING' ) resend_unload_notifications.short_description = \"üìß –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ\" def change_view(self, request, object_id, form_url='', extra_context=None): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —à–∞–±–ª–æ–Ω\"\"\" extra_context = extra_context or {} if object_id: obj = self.get_object(request, object_id) if obj: # –¢–æ–ª—å–∫–æ —Å—á–∏—Ç–∞–µ–º —Ñ–æ—Ç–æ - –±—ã—Å—Ç—Ä—ã–π COUNT –∑–∞–ø—Ä–æ—Å # –°–∞–º–∏ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX –ø—Ä–∏ –∫–ª–∏–∫–µ extra_context['photos_count'] = obj.photos.count() extra_context['container_id'] = object_id return super().change_view(request, object_id, form_url, extra_context) def get_changelist(self, request, **kwargs): \"\"\"–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "xtra_context['container_id'] = object_id return super().change_view(request, object_id, form_url, extra_context) def get_changelist(self, request, **kwargs): \"\"\"–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ '–í –ø–æ—Ä—Ç—É' –∏ '–†–∞–∑–≥—Ä—É–∂–µ–Ω'\"\"\" # –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é if not request.GET.get('status_multi'): # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ get_params = request.GET.copy() get_params.setlist('status_multi', ['IN_PORT', 'UNLOADED']) request.GET = get_params return super().get_changelist(request, **kwargs) @admin.register(Car) class CarAdmin(admin.ModelAdmin): change_form_template = 'admin/core/car/change_form.html' list_display = ( 'vin', 'brand', 'vehicle_type', 'year_display', 'client', 'colored_status', 'container_display', 'warehouse', 'line', 'unload_date_display', 'days_display', 'storage_cost_display', 'total_price_display', 'has_title' ) list_editable = ('has_title',) list_filter = (MultiStatusFilter, ClientAutocompleteFilter, MultiWarehouseFilter) search_fields = ('vin', 'brand') # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è list view list_select_related = ('client', 'warehouse', 'line', 'carrier', 'container') list_prefetch_related = ('car_se", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ch_fields = ('vin', 'brand') # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è list view list_select_related = ('client', 'warehouse', 'line', 'carrier', 'container') list_prefetch_related = ('car_services',) readonly_fields = ( 'default_warehouse_prices_display', 'total_price', 'storage_cost', 'days', 'warehouse_payment_display', 'free_days_display', 'rate_display', 'services_summary_display', 'warehouse_services_display', 'line_services_display', 'carrier_services_display', 'company_services_display' ) # inlines = [] # –£—Å–ª—É–≥–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª—ã –Ω–∏–∂–µ fieldsets = ( ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', { 'fields': ( ('year', 'brand', 'vehicle_type', 'vin', 'client', 'status'), ('unload_date', 'transfer_date'), ('has_title', 'title_notes'), ) }), ('–õ–∏–Ω–∏–∏', { 'classes': ('collapse',), 'fields': ( 'line', 'line_services_display', ) }), ('–°–∫–ª–∞–¥', { 'classes': ('collapse',), 'fields': ( 'warehouse', 'warehouse_services_display', ) }), ('–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫', { 'classes': ('collapse',), 'fields': ( 'carrier', 'carrier_services_display', ) }), ('–£—Å–ª—É–≥–∏', { 'classes': ('collapse',), 'fields': ( 'company_services_display', ) }), ('–§–∏–Ω–∞–Ω—Å—ã', { 'fields': ( 'services_summary_display', ) }), ) actions = ['set_sta", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "'carrier_services_display', ) }), ('–£—Å–ª—É–≥–∏', { 'classes': ('collapse',), 'fields': ( 'company_services_display', ) }), ('–§–∏–Ω–∞–Ω—Å—ã', { 'fields': ( 'services_summary_display', ) }), ) actions = ['set_status_floating', 'set_status_in_port', 'set_status_unloaded', 'set_status_transferred', 'set_transferred_today', 'set_title_with_us'] def set_transferred_today(self, request, queryset): \"\"\"–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å '–ü–µ—Ä–µ–¥–∞–Ω' –∏ –¥–∞—Ç—É –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\"\"\" from django.utils import timezone today = timezone.now().date() updated = 0 for car in queryset: car.status = 'TRANSFERRED' car.transfer_date = today car.save() updated += 1 self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏: {today}\") set_transferred_today.short_description = \"–ü–µ—Ä–µ–¥–∞–Ω —Å–µ–≥–æ–¥–Ω—è\" def default_warehouse_prices_display(self, obj): details = obj.warehouse_details() if \"message\" in details: return details[\"message\"] html = '<table style=\"width:100%; border:1px solid #ddd; border-collapse:collapse;\">' html += '<tr><th style=\"border:1px solid #ddd; padding:8px;\">–ü–æ–ª–µ</th><th style=\"border:1px solid #ddd; padding:8px;\">–¶–µ–Ω–∞</th></tr>' for key, value in details.items(): html += f'<tr><td st", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "llapse;\">' html += '<tr><th style=\"border:1px solid #ddd; padding:8px;\">–ü–æ–ª–µ</th><th style=\"border:1px solid #ddd; padding:8px;\">–¶–µ–Ω–∞</th></tr>' for key, value in details.items(): html += f'<tr><td style=\"border:1px solid #ddd; padding:8px;\">{key}</td><td style=\"border:1px solid #ddd; padding:8px;\">{value}</td></tr>' html += '</table>' return format_html(html) default_warehouse_prices_display.short_description = \"–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞\" # --- NEW: renderer –¥–ª—è –ø–æ–ª—è \"–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É\" --- def warehouse_payment_display(self, obj): return f\"{obj.warehouse_payment_amount():.2f}\" warehouse_payment_display.short_description = '–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É' def services_summary_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –≤—Å–µ–º —É—Å–ª—É–≥–∞–º —Å –Ω–∞—Ü–µ–Ω–∫–æ–π Caromoto Lithuania\"\"\" from decimal import Decimal from core.models import CarService from django.db.models import Sum # –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º obj.update_days_and_storage() # –†–∞–∑–¥–µ–ª—è–µ–º —É—Å–ª—É–≥–∏: –ª–∏–Ω–∏–∏ (–≤—Å–µ + THS –∏–∑ —Å–∫–ª–∞–¥–∞), —Å–∫–ª–∞–¥ (–±–µ–∑ THS), –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫, –∫–æ–º–ø–∞–Ω–∏–∏ line_total = Decimal('0.00') # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS (–¥–∞–∂–µ –µ—Å–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥) warehouse_total = Decimal('0.00') # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ THS) carrier_total = obj.get_services", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–µ–∑ THS), –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫, –∫–æ–º–ø–∞–Ω–∏–∏ line_total = Decimal('0.00') # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS (–¥–∞–∂–µ –µ—Å–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥) warehouse_total = Decimal('0.00') # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ THS) carrier_total = obj.get_services_total_by_provider('CARRIER') company_total = obj.get_services_total_by_provider('COMPANY') # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ –∏ —Ä–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º # THS –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π –ª–∏–Ω–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ for service in obj.car_services.all(): service_name = service.get_service_name().upper() price = Decimal(str(service.final_price)) if service.service_type == 'LINE' or 'THS' in service_name: line_total += price # –í—Å–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π + THS –∏–∑ —Å–∫–ª–∞–¥–∞ elif service.service_type == 'WAREHOUSE': warehouse_total += price # –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –±–µ–∑ THS # –ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è paid_days = obj.days or 0 # –°—É–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫ (–∏–∑ —É—Å–ª—É–≥) distributed_markup = obj.car_services.aggregate(total=Sum('markup_amount'))['total'] or Decimal('0') # –ù–∞—Ü–µ–Ω–∫–∞ –∏–∑ –ø–æ–ª—è proft (–µ—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞) proft_amount = obj.proft or Decimal('0.00') # –û–±—â–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ = —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è (proft –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) total_markup = distributed_markup # –ë–∞–∑–æ–≤—ã–µ —Å—É–º–º—ã (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏) base_total = line_total +", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "t_amount = obj.proft or Decimal('0.00') # –û–±—â–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ = —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è (proft –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) total_markup = distributed_markup # –ë–∞–∑–æ–≤—ã–µ —Å—É–º–º—ã (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏) base_total = line_total + warehouse_total + carrier_total + company_total html = ['<div style=\"margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;\">'] html.append('<h3 style=\"margin-top:0; color:#495057;\">–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º</h3>') html.append('<div style=\"display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr; gap:15px; margin-bottom:20px;\">') # –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π (THS, –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ì—Ä—É–∑–∏—é –∏ —Ç.–¥.) - —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π html.append('<div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\">') html.append('<strong>–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π:</strong><br>') # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è THS –∏–∑ —Å–∫–ª–∞–¥–∞) line_services_list = [] for service in obj.car_services.all(): service_name = service.get_service_name() # THS —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª—É–≥–æ–π –ª–∏–Ω–∏–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ if service.service_type == 'LINE' or 'THS' in service_name.upper(): price = Decimal(str(service.final_price)) line_services_list.append((service_name, price)) for name, price in line_servi", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥ if service.service_type == 'LINE' or 'THS' in service_name.upper(): price = Decimal(str(service.final_price)) line_services_list.append((service_name, price)) for name, price in line_services_list: html.append(f'<span style=\"font-size:13px; color:#6c757d;\">{name}: {price:.2f}</span><br>') html.append(f'<span style=\"font-size:18px; color:#007bff; font-weight:bold;\">–ò—Ç–æ–≥–æ: {line_total:.2f}</span>') html.append('</div>') # –°–∫–ª–∞–¥ (–±–µ–∑ THS) - —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π —É—Å–ª—É–≥ html.append('<div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\">') html.append('<strong>–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞:</strong><br>') # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É —Å–∫–ª–∞–¥–∞ (–∫—Ä–æ–º–µ THS) warehouse_services_list = [] for service in obj.car_services.filter(service_type='WAREHOUSE'): service_name = service.get_service_name() if 'THS' not in service_name.upper(): # –ò—Å–ø–æ–ª—å–∑—É–µ–º final_price –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç default_price –µ—Å–ª–∏ custom_price –Ω–µ –∑–∞–¥–∞–Ω price = Decimal(str(service.final_price)) warehouse_services_list.append((service_name, price)) for name, price in warehouse_services_list: html.append(f'<span style=\"font-size:13px; color:#6c757d;\">{name}: {price:.2f}</span><br>') if obj.warehouse: free_days = o", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "st.append((service_name, price)) for name, price in warehouse_services_list: html.append(f'<span style=\"font-size:13px; color:#6c757d;\">{name}: {price:.2f}</span><br>') if obj.warehouse: free_days = obj.warehouse.free_days or 0 html.append(f'<span style=\"font-size:12px; color:#adb5bd;\">–ë–µ—Å–ø–ª. –¥–Ω–µ–π: {free_days}, –ü–ª–∞—Ç. –¥–Ω–µ–π: {paid_days}</span><br>') html.append(f'<span style=\"font-size:18px; color:#28a745; font-weight:bold;\">–ò—Ç–æ–≥–æ: {warehouse_total:.2f}</span>') html.append('</div>') # –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ html.append('<div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\">') html.append('<strong>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫:</strong><br>') html.append(f'<span style=\"font-size:18px; color:#ffc107;\">{carrier_total:.2f}</span>') html.append('</div>') # –ö–æ–º–ø–∞–Ω–∏–∏ html.append('<div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\">') html.append('<strong>–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π:</strong><br>') company_services_list = [] for service in obj.car_services.filter(service_type='COMPANY'): try: company_service = CompanyService.objects.select_related('company').get(id=service.service_id) price = Decimal(str(service.final_price)) company_services_list.append((comp", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "service_type='COMPANY'): try: company_service = CompanyService.objects.select_related('company').get(id=service.service_id) price = Decimal(str(service.final_price)) company_services_list.append((company_service.company.name, company_service.name, price)) except Exception: continue for company_name, name, price in company_services_list: html.append(f'<span style=\"font-size:13px; color:#6c757d;\">{company_name}: {name}: {price:.2f}</span><br>') html.append(f'<span style=\"font-size:18px; color:#6f42c1; font-weight:bold;\">–ò—Ç–æ–≥–æ: {company_total:.2f}</span>') html.append('</div>') # –ù–∞—Ü–µ–Ω–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é —Å—É–º–º—É html.append('<div style=\"background:#fffde7; padding:10px; border-radius:5px; border:1px solid #ffc107;\">') html.append('<strong style=\"color:#ff8f00;\">–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞:</strong><br>') html.append(f'<span style=\"font-size:18px; font-weight:bold; color:#ff8f00;\">{distributed_markup:.2f}</span>') if distributed_markup > 0: html.append(f'<br><span style=\"font-size:11px; color:#666;\">(—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ —É—Å–ª—É–≥–∞–º)</span>') else: html.append(f'<br><span style=\"font-size:11px; color:#666;\">(–≤–≤–µ–¥–∏—Ç–µ –≤ –∂—ë–ª—Ç—ã—Ö –ø–æ–ª—è—Ö)</span>') html.append('</div>') html.append('</div>') # –û–±—â–∏–π –∏—Ç–æ–≥ ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": ":#666;\">(—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ —É—Å–ª—É–≥–∞–º)</span>') else: html.append(f'<br><span style=\"font-size:11px; color:#666;\">(–≤–≤–µ–¥–∏—Ç–µ –≤ –∂—ë–ª—Ç—ã—Ö –ø–æ–ª—è—Ö)</span>') html.append('</div>') html.append('</div>') # –û–±—â–∏–π –∏—Ç–æ–≥ total_with_markup = base_total + total_markup html.append('<div style=\"background:white; padding:15px; border-radius:5px; border:2px solid #6c757d;\">') html.append('<strong style=\"color:#6c757d;\">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong><br>') html.append(f'<span style=\"font-size:20px; font-weight:bold; color:#495057;\">{total_with_markup:.2f} EUR</span>') html.append('</div>') html.append('</div>') return format_html(''.join(html)) services_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ —É—Å–ª—É–≥–∞–º' def colored_status(self, obj): color = obj.get_status_color() return format_html( '<span style=\"background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;\">{}</span>', color, obj.get_status_display() ) colored_status.short_description = '–°—Ç–∞—Ç—É—Å' def container_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å—É –º–∞—à–∏–Ω—ã\"\"\" if not obj.container: return '-' # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—à–∏–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ (–∫–∞–∫ —É —Å—Ç–∞—Ç—É—Å–∞) color = obj.get_status_color() # –°", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å—É –º–∞—à–∏–Ω—ã\"\"\" if not obj.container: return '-' # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—à–∏–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ (–∫–∞–∫ —É —Å—Ç–∞—Ç—É—Å–∞) color = obj.get_status_color() # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä container_url = f'/admin/core/container/{obj.container.id}/change/' return format_html( '<a href=\"{}\" target=\"_blank\" style=\"text-decoration: none;\"><span style=\"background-color: {}; color: white; padding: 4px 8px; border-radius: 4px;\">{}</span></a>', container_url, color, obj.container.number ) container_display.short_description = '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä' container_display.admin_order_field = 'container__number' def year_display(self, obj): return obj.year year_display.short_description = '–ì–æ–¥' year_display.admin_order_field = 'year' def unload_date_display(self, obj): return obj.unload_date unload_date_display.short_description = '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏' unload_date_display.admin_order_field = 'unload_date' def transfer_date_display(self, obj): return obj.transfer_date transfer_date_display.short_description = '–ü–µ—Ä–µ–¥–∞–Ω' transfer_date_display.admin_order_field = 'transfer_date' def storage_cost_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ate_display.short_description = '–ü–µ—Ä–µ–¥–∞–Ω' transfer_date_display.admin_order_field = 'transfer_date' def storage_cost_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π —Å–∫–ª–∞–¥–∞\"\"\" try: storage_cost = obj.calculate_storage_cost() return f\"{storage_cost:.2f}\" except Exception as e: print(f\"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}\") return f\"{obj.storage_cost:.2f}\" # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ storage_cost_display.short_description = '–•—Ä–∞–Ω' storage_cost_display.admin_order_field = 'storage_cost' def days_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Å —É—á–µ—Ç–æ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –∏–∑ —Å–∫–ª–∞–¥–∞\"\"\" if obj.warehouse and obj.unload_date: # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è end_date = obj.transfer_date if obj.status == 'TRANSFERRED' and obj.transfer_date else timezone.now().date() total_days = (end_date - obj.unload_date).days + 1 free_days = obj.warehouse.free_days or 0 chargeable_days = max(0, total_days - free_days) return f\"{chargeable_days} (–∏–∑ {total_days})\" return obj.days if hasattr(obj, 'days') else 0 days_display.short_description = '–ü–ª–∞—Ç.–¥–Ω.' days_display.admin_order_field = 'days' def total_price_display(self, obj): # –î–ª—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "rn obj.days if hasattr(obj, 'days') else 0 days_display.short_description = '–ü–ª–∞—Ç.–¥–Ω.' days_display.admin_order_field = 'days' def total_price_display(self, obj): # –î–ª—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ if obj.status != 'TRANSFERRED': from decimal import Decimal from django.db.models import Sum from core.models import CarService # –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ obj.update_days_and_storage() # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É —É—Å–ª—É–≥ (final_price = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞) base_total = Decimal('0.00') for cs in CarService.objects.filter(car=obj): base_total += Decimal(str(cs.final_price)) # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –Ω–∞—Ü–µ–Ω–∫—É –∏–∑ CarService distributed_markup = CarService.objects.filter(car=obj).aggregate( total=Sum('markup_amount') )['total'] or Decimal('0.00') total = base_total + distributed_markup return f\"{total:.2f}\" return f\"{obj.total_price:.2f}\" total_price_display.short_description = '–¶–µ–Ω–∞' total_price_display.admin_order_field = 'total_price' # –£–î–ê–õ–ï–ù–û: current_price_display - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ total_price def free_days_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ —Å–∫–ª–∞–¥–∞\"\"\" if obj.warehouse: return obj.warehouse.free_days return obj.free_days # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ free_days_di", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—å–∫–æ total_price def free_days_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ —Å–∫–ª–∞–¥–∞\"\"\" if obj.warehouse: return obj.warehouse.free_days return obj.free_days # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ free_days_display.short_description = 'FREE' free_days_display.admin_order_field = 'free_days' def rate_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∑–∞ —Å—É—Ç–∫–∏ –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞\"\"\" if obj.warehouse: daily_rate = obj._get_storage_daily_rate() return f\"{daily_rate:.2f}\" return \"0.00\" rate_display.short_description = '–°—Ç–∞–≤–∫–∞/–¥–µ–Ω—å' def set_status_floating(self, request, queryset): updated = queryset.update(status='FLOATING') for obj in queryset: obj.update_days_and_storage() obj.save(update_fields=['days', 'storage_cost', 'total_price']) self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø—É—Ç–∏' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\") set_status_floating.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø—É—Ç–∏\" def set_status_in_port(self, request, queryset): updated = queryset.update(status='IN_PORT') for obj in queryset: obj.update_days_and_storage() obj.save(update_fields=['days', 'storage_cost', 'total_price']) self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\") set_status_in_port.sh", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "bj.update_days_and_storage() obj.save(update_fields=['days', 'storage_cost', 'total_price']) self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–í –ø–æ—Ä—Ç—É' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\") set_status_in_port.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –í –ø–æ—Ä—Ç—É\" def set_status_unloaded(self, request, queryset): updated = 0 for obj in queryset: if obj.warehouse and obj.unload_date: obj.status = 'UNLOADED' obj.update_days_and_storage() obj.save(update_fields=['status', 'days', 'storage_cost', 'total_price']) updated += 1 else: self.message_user(request, f\"–ê–≤—Ç–æ–º–æ–±–∏–ª—å {obj.vin} –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'.\", level='warning') self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\") set_status_unloaded.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –†–∞–∑–≥—Ä—É–∂–µ–Ω\" def set_status_transferred(self, request, queryset): updated = queryset.update(status='TRANSFERRED') for obj in queryset: if obj.status == 'TRANSFERRED' and not obj.transfer_date: obj.transfer_date = timezone.now().date() obj.update_days_and_storage() obj.save(update_fields=['transfer_date', 'days', 'storage_cost', 'total_price']) self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {update", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "imezone.now().date() obj.update_days_and_storage() obj.save(update_fields=['transfer_date', 'days', 'storage_cost', 'total_price']) self.message_user(request, f\"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\") set_status_transferred.short_description = \"–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –ü–µ—Ä–µ–¥–∞–Ω\" def set_title_with_us(self, request, queryset): logger.info(f\"Setting has_title=True for {queryset.count()} cars\") updated = queryset.update(has_title=True) for obj in queryset: logger.debug(f\"Updating car {obj.vin} with has_title=True\") obj.save() self.message_user(request, f\"–¢–∞–π—Ç–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ '–£ –Ω–∞—Å' –¥–ª—è {updated} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\") set_title_with_us.short_description = \"–¢–∞–π—Ç–ª —É –Ω–∞—Å\" class Media: css = { 'all': ( 'css/logist2_custom_admin.css', 'style', # –î–æ–±–∞–≤–ª—è–µ–º inline —Å—Ç–∏–ª–∏ ) } js = ('js/htmx.min.js', 'js/logist2_htmx.js') def get_queryset(self, request): qs = super().get_queryset(request) return qs.select_related('client', 'warehouse', 'container') def save_model(self, request, obj, form, change): \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ–ª–µ–π —É—Å–ª—É–≥\"\"\" super().save_model(request, obj, form, change) # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ removed_services = set() for key, value in request.POST.items():", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "): \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ–ª–µ–π —É—Å–ª—É–≥\"\"\" super().save_model(request, obj, form, change) # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ removed_services = set() for key, value in request.POST.items(): if key.startswith('remove_warehouse_service_') and value == '1': service_id = key.replace('remove_warehouse_service_', '') removed_services.add(f'warehouse_{service_id}') try: deleted_count = CarService.objects.filter( car=obj, service_type='WAREHOUSE', service_id=service_id ).delete() # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ DeletedCarService.objects.get_or_create( car=obj, service_type='WAREHOUSE', service_id=service_id ) print(f\"Deleted warehouse service {service_id}: {deleted_count}\") except Exception as e: print(f\"Error deleting warehouse service {service_id}: {e}\") elif key.startswith('remove_line_service_') and value == '1': service_id = key.replace('remove_line_service_', '') removed_services.add(f'line_{service_id}') try: deleted_count = CarService.objects.filter( car=obj, service_type='LINE', service_id=service_id ).delete() # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ DeletedCarService.objects.get_or_create( car=obj, service_type='LINE', service_id=service_id ) print(f\"Deleted line service {service_id}:", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": ", service_id=service_id ).delete() # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ DeletedCarService.objects.get_or_create( car=obj, service_type='LINE', service_id=service_id ) print(f\"Deleted line service {service_id}: {deleted_count}\") except Exception as e: print(f\"Error deleting line service {service_id}: {e}\") elif key.startswith('remove_carrier_service_') and value == '1': service_id = key.replace('remove_carrier_service_', '') removed_services.add(f'carrier_{service_id}') try: deleted_count = CarService.objects.filter( car=obj, service_type='CARRIER', service_id=service_id ).delete() # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ DeletedCarService.objects.get_or_create( car=obj, service_type='CARRIER', service_id=service_id ) print(f\"Deleted carrier service {service_id}: {deleted_count}\") except Exception as e: print(f\"Error deleting carrier service {service_id}: {e}\") elif key.startswith('remove_company_service_') and value == '1': service_id = key.replace('remove_company_service_', '') removed_services.add(f'company_{service_id}') try: deleted_count = CarService.objects.filter( car=obj, service_type='COMPANY', service_id=service_id ).delete() # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ DeletedCarService.objects.get_or_create(", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ny_{service_id}') try: deleted_count = CarService.objects.filter( car=obj, service_type='COMPANY', service_id=service_id ).delete() # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ DeletedCarService.objects.get_or_create( car=obj, service_type='COMPANY', service_id=service_id ) print(f\"Deleted company service {service_id}: {deleted_count}\") except Exception as e: print(f\"Error deleting company service {service_id}: {e}\") print(f\"Removed services: {removed_services}\") # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ existing_warehouse_car_services = CarService.objects.filter( car=obj, service_type='WAREHOUSE' ) for car_service in existing_warehouse_car_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ if f'warehouse_{car_service.service_id}' in removed_services: continue field_name = f'warehouse_service_{car_service.service_id}' value = request.POST.get(field_name) if value: try: car_service.custom_price = float(value) except (ValueError, TypeError): pass # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É markup_field = f'markup_warehouse_service_{car_service.service_id}' markup_value = request.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value el", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—é –Ω–∞—Ü–µ–Ω–∫—É markup_field = f'markup_warehouse_service_{car_service.service_id}' markup_value = request.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value else 0 except (ValueError, TypeError): car_service.markup_amount = 0 car_service.save() # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) if obj.warehouse: warehouse_services = WarehouseService.objects.filter( warehouse=obj.warehouse, is_active=True, default_price__gt=0 ).only('id', 'default_price') existing_car_service_ids = set(existing_warehouse_car_services.values_list('service_id', flat=True)) # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥ deleted_services = DeletedCarService.objects.filter( car=obj, service_type='WAREHOUSE' ).values_list('service_id', flat=True) for service in warehouse_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ if f'warehouse_{service.id}' in removed_services: continue # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ if service.id in deleted_services: continue # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ if service.id not in existing_car_service_ids: field_name = f'warehouse_service_{service.id}' value = request.POST.get(field_name) or service.default_price # –ü–æ–ª—É", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ if service.id not in existing_car_service_ids: field_name = f'warehouse_service_{service.id}' value = request.POST.get(field_name) or service.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup', 0) or 0 CarService.objects.create( car=obj, service_type='WAREHOUSE', service_id=service.id, custom_price=float(value), markup_amount=float(default_markup) ) # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏ # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è THS) existing_line_car_services = CarService.objects.filter( car=obj, service_type='LINE' ) for car_service in existing_line_car_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ if f'line_{car_service.service_id}' in removed_services: continue field_name = f'line_service_{car_service.service_id}' value = request.POST.get(field_name) if value: try: car_service.custom_price = float(value) except (ValueError, TypeError): pass # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É markup_field = f'markup_line_service_{car_service.service_id}' markup_value = request.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value else 0 except (ValueError, Type", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " f'markup_line_service_{car_service.service_id}' markup_value = request.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value else 0 except (ValueError, TypeError): car_service.markup_amount = 0 car_service.save() # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) if obj.line: line_services = LineService.objects.filter( line=obj.line, is_active=True, default_price__gt=0 ).only('id', 'default_price') existing_car_service_ids = set(existing_line_car_services.values_list('service_id', flat=True)) # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥ deleted_services = DeletedCarService.objects.filter( car=obj, service_type='LINE' ).values_list('service_id', flat=True) for service in line_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ if f'line_{service.id}' in removed_services: continue # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ if service.id in deleted_services: continue # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ if service.id not in existing_car_service_ids: field_name = f'line_service_{service.id}' value = request.POST.get(field_name) or service.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "rvice_ids: field_name = f'line_service_{service.id}' value = request.POST.get(field_name) or service.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup', 0) or 0 CarService.objects.create( car=obj, service_type='LINE', service_id=service.id, custom_price=float(value), markup_amount=float(default_markup) ) # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ existing_carrier_car_services = CarService.objects.filter( car=obj, service_type='CARRIER' ) for car_service in existing_carrier_car_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ if f'carrier_{car_service.service_id}' in removed_services: continue field_name = f'carrier_service_{car_service.service_id}' value = request.POST.get(field_name) if value: try: car_service.custom_price = float(value) except (ValueError, TypeError): pass # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É markup_field = f'markup_carrier_service_{car_service.service_id}' markup_value = request.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value else 0 except (ValueError, TypeError): car_service.markup_amount = 0 car_service.save() # –ó–∞—Ç–µ–º —Å–æ–∑", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "est.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value else 0 except (ValueError, TypeError): car_service.markup_amount = 0 car_service.save() # –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) if obj.carrier: carrier_services = CarrierService.objects.filter( carrier=obj.carrier, is_active=True, default_price__gt=0 ).only('id', 'default_price') existing_car_service_ids = set(existing_carrier_car_services.values_list('service_id', flat=True)) # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥ deleted_services = DeletedCarService.objects.filter( car=obj, service_type='CARRIER' ).values_list('service_id', flat=True) for service in carrier_services: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —É—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ if f'carrier_{service.id}' in removed_services: continue # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ if service.id in deleted_services: continue # –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ—Ç –≤ CarService, —Å–æ–∑–¥–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ if service.id not in existing_car_service_ids: field_name = f'carrier_service_{service.id}' value = request.POST.get(field_name) or service.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup', 0) or 0 CarService.objects.create( ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "_{service.id}' value = request.POST.get(field_name) or service.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup', 0) or 0 CarService.objects.create( car=obj, service_type='CARRIER', service_id=service.id, custom_price=float(value), markup_amount=float(default_markup) ) # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π existing_company_car_services = CarService.objects.filter( car=obj, service_type='COMPANY' ) for car_service in existing_company_car_services: if f'company_{car_service.service_id}' in removed_services: continue field_name = f'company_service_{car_service.service_id}' value = request.POST.get(field_name) if value: try: car_service.custom_price = float(value) except (ValueError, TypeError): pass markup_field = f'markup_company_service_{car_service.service_id}' markup_value = request.POST.get(markup_field, '0') try: car_service.markup_amount = float(markup_value) if markup_value else 0 except (ValueError, TypeError): car_service.markup_amount = 0 car_service.save() # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –¥–Ω–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ if change and form and 'warehouse' in getattr(form, 'changed_data', []): print(f\"–°–∫–ª–∞–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è {obj.v", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " = 0 car_service.save() # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –¥–Ω–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞ if change and form and 'warehouse' in getattr(form, 'changed_data', []): print(f\"–°–∫–ª–∞–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è {obj.vin}, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è\") try: # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ obj.update_days_and_storage() obj.calculate_total_price() # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è obj.save(update_fields=['storage_cost', 'days', 'total_price']) print(f\"–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–ª—è: storage_cost={obj.storage_cost}, days={obj.days}\") except Exception as e: print(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}\") def warehouse_services_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤\"\"\" try: # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–æ—Ç –ª—é–±—ã—Ö —Å–∫–ª–∞–¥–æ–≤) car_services = CarService.objects.filter( car=obj, service_type='WAREHOUSE' ).select_related('car') html = '<div style=\"margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;\">' if car_services: for car_service in car_services: try: # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏ –∏ —Å–∫–ª–∞–¥–∞ service = WarehouseService.objects.select_related('warehouse').get(id=car_service.service_id) current_value = car_service.custom_price or service.def", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "r_services: try: # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏ –∏ —Å–∫–ª–∞–¥–∞ service = WarehouseService.objects.select_related('warehouse').get(id=car_service.service_id) current_value = car_service.custom_price or service.default_price markup_value = car_service.markup_amount or 0 warehouse_name = service.warehouse.name # –ü–æ–¥—Å–≤–µ—Ç–∫–∞: –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥ - –∑–µ–ª–µ–Ω—ã–π, –¥—Ä—É–≥–∏–µ - –∂–µ–ª—Ç—ã–π bg_color = \"#e8f5e9\" if (obj.warehouse and service.warehouse.id == obj.warehouse.id) else \"#fff9e6\" html += f''' <div style=\"border: 1px solid #ddd; padding: 10px; background: {bg_color}; position: relative; min-width: 220px;\"> <button type=\"button\" onclick=\"removeService({service.id}, 'warehouse')\" style=\"position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;\">√ó</button> <div style=\"font-size: 11px; color: #666; margin-bottom: 3px;\">üì¶ {warehouse_name}</div> <strong>{service.name}</strong><br> <div style=\"display: flex; gap: 5px; align-items: center; margin-top: 5px;\"> <input type=\"number\" name=\"warehouse_service_{service.id}\" value=\"{current_value}\" step=\"0.01\" style=\"width: 80px;\" title=\"–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏\"> <span style=\"color", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "5px; align-items: center; margin-top: 5px;\"> <input type=\"number\" name=\"warehouse_service_{service.id}\" value=\"{current_value}\" step=\"0.01\" style=\"width: 80px;\" title=\"–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏\"> <span style=\"color: #28a745; font-weight: bold;\">+</span> <input type=\"number\" name=\"markup_warehouse_service_{service.id}\" value=\"{markup_value}\" step=\"0.01\" style=\"width: 60px; background: #fffde7; border-color: #ffc107;\" title=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞\" placeholder=\"0\"> </div> <input type=\"hidden\" name=\"remove_warehouse_service_{service.id}\" id=\"remove_warehouse_service_{service.id}\" value=\"\"> </div> ''' except Exception as e: continue html += '</div>' # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ - —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ html += f''' <div style=\"margin-top: 10px;\"> <button type=\"button\" class=\"add-service-btn\" onclick=\"openModal('warehouseServicesModal', 'warehouse')\" title=\"–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª—é–±–æ–≥–æ —Å–∫–ª–∞–¥–∞\"> + </button> <span style=\"margin-left: 5px; color: #666;\">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞</span> </div> ''' # –î–æ–±–∞–≤–ª—è–µ–º JavaScript –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥ html += ''' <script> function removeService(serviceId, serviceType) { const serviceDiv = event.target.closest('div'); serviceDiv.style.display = 'none'; const hiddenField = document.g", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "—è —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥ html += ''' <script> function removeService(serviceId, serviceType) { const serviceDiv = event.target.closest('div'); serviceDiv.style.display = 'none'; const hiddenField = document.getElementById('remove_' + serviceType + '_service_' + serviceId); hiddenField.value = '1'; console.log('Removed service:', serviceType, serviceId, 'Field value:', hiddenField.value); } </script> ''' return mark_safe(html) except Exception as e: return f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}\" warehouse_services_display.short_description = \"–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞\" def line_services_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏\"\"\" if not obj.line: return \"–õ–∏–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞\" try: # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º car_services = CarService.objects.filter( car=obj, service_type='LINE' ) html = '<div style=\"margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;\">' for car_service in car_services: try: # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏ service = LineService.objects.get(id=car_service.service_id) current_value = car_service.custom_price or service.default_price markup_value = car_service.markup_amount or 0 html += f''' <div style=\"border: 1px solid #ddd; padding: 10px; bac", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "_service.service_id) current_value = car_service.custom_price or service.default_price markup_value = car_service.markup_amount or 0 html += f''' <div style=\"border: 1px solid #ddd; padding: 10px; background: #e3f2fd; position: relative; min-width: 200px;\"> <button type=\"button\" onclick=\"removeService({service.id}, 'line')\" style=\"position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;\">√ó</button> <strong>{service.name}</strong><br> <div style=\"display: flex; gap: 5px; align-items: center; margin-top: 5px;\"> <input type=\"number\" name=\"line_service_{service.id}\" value=\"{current_value}\" step=\"0.01\" style=\"width: 80px;\" title=\"–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏\"> <span style=\"color: #28a745; font-weight: bold;\">+</span> <input type=\"number\" name=\"markup_line_service_{service.id}\" value=\"{markup_value}\" step=\"0.01\" style=\"width: 60px; background: #fffde7; border-color: #ffc107;\" title=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞\" placeholder=\"0\"> </div> <input type=\"hidden\" name=\"remove_line_service_{service.id}\" id=\"remove_line_service_{service.id}\" value=\"\"> </div> ''' except: continue html += '</div>' # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–Ω–∫–∞\" placeholder=\"0\"> </div> <input type=\"hidden\" name=\"remove_line_service_{service.id}\" id=\"remove_line_service_{service.id}\" value=\"\"> </div> ''' except: continue html += '</div>' # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥ if obj.line: html += f''' <div style=\"margin-top: 10px;\"> <button type=\"button\" class=\"add-service-btn\" onclick=\"openModal('lineServicesModal', 'line')\" title=\"–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏\"> + </button> <span style=\"margin-left: 5px; color: #666;\">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏</span> </div> ''' if not car_services: html += '<div style=\"margin-top: 8px; color: #6c757d;\">–£—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú+‚Äù.</div>' return mark_safe(html) except Exception as e: return f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}\" line_services_display.short_description = \"–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏\" def carrier_services_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\"\"\" if not obj.carrier: return \"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω\" try: # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–≤—è–∑–∞–Ω—ã —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º car_services = CarService.objects.filter( car=obj, service_type='CARRIER' ) html = '<div style=\"margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;\">' for car_service in car_services: try: # –ü", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " car_services = CarService.objects.filter( car=obj, service_type='CARRIER' ) html = '<div style=\"margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;\">' for car_service in car_services: try: # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥–∏ service = CarrierService.objects.get(id=car_service.service_id) current_value = car_service.custom_price or service.default_price markup_value = car_service.markup_amount or 0 html += f''' <div style=\"border: 1px solid #ddd; padding: 10px; background: #fff3e0; position: relative; min-width: 200px;\"> <button type=\"button\" onclick=\"removeService({service.id}, 'carrier')\" style=\"position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;\">√ó</button> <strong>{service.name}</strong><br> <div style=\"display: flex; gap: 5px; align-items: center; margin-top: 5px;\"> <input type=\"number\" name=\"carrier_service_{service.id}\" value=\"{current_value}\" step=\"0.01\" style=\"width: 80px;\" title=\"–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏\"> <span style=\"color: #28a745; font-weight: bold;\">+</span> <input type=\"number\" name=\"markup_carrier_service_{service.id}\" value=\"{markup_value}\" step=\"0.01\" style=\"wid", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "dth: 80px;\" title=\"–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏\"> <span style=\"color: #28a745; font-weight: bold;\">+</span> <input type=\"number\" name=\"markup_carrier_service_{service.id}\" value=\"{markup_value}\" step=\"0.01\" style=\"width: 60px; background: #fffde7; border-color: #ffc107;\" title=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞\" placeholder=\"0\"> </div> <input type=\"hidden\" name=\"remove_carrier_service_{service.id}\" id=\"remove_carrier_service_{service.id}\" value=\"\"> </div> ''' except: continue html += '</div>' # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥ if obj.carrier: html += f''' <div style=\"margin-top: 10px;\"> <button type=\"button\" class=\"add-service-btn\" onclick=\"openModal('carrierServicesModal', 'carrier')\" title=\"–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\"> + </button> <span style=\"margin-left: 5px; color: #666;\">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞</span> </div> ''' if not car_services: html += '<div style=\"margin-top: 8px; color: #6c757d;\">–£—Å–ª—É–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú+‚Äù.</div>' return mark_safe(html) except Exception as e: return f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}\" carrier_services_display.short_description = \"–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" def company_services_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π\"\"\" try: car_ser", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}\" carrier_services_display.short_description = \"–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" def company_services_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–π\"\"\" try: car_services = CarService.objects.filter( car=obj, service_type='COMPANY' ) html = '<div style=\"margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;\">' if car_services: for car_service in car_services: try: service = CompanyService.objects.select_related('company').get(id=car_service.service_id) current_value = car_service.custom_price if car_service.custom_price is not None else service.default_price markup_value = car_service.markup_amount or 0 html += f''' <div style=\"border: 1px solid #ddd; padding: 10px; background: #f3e8ff; position: relative; min-width: 240px;\"> <button type=\"button\" onclick=\"removeService({service.id}, 'company')\" style=\"position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;\">√ó</button> <div style=\"font-size: 11px; color: #666; margin-bottom: 3px;\">üè¢ {service.company.name}</div> <strong>{service.name}</strong><br> <div style=\"display: flex; gap: 5", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ointer; font-size: 12px;\">√ó</button> <div style=\"font-size: 11px; color: #666; margin-bottom: 3px;\">üè¢ {service.company.name}</div> <strong>{service.name}</strong><br> <div style=\"display: flex; gap: 5px; align-items: center; margin-top: 5px;\"> <input type=\"number\" name=\"company_service_{service.id}\" value=\"{current_value}\" step=\"0.01\" style=\"width: 80px;\" title=\"–¶–µ–Ω–∞ —É—Å–ª—É–≥–∏\"> <span style=\"color: #28a745; font-weight: bold;\">+</span> <input type=\"number\" name=\"markup_company_service_{service.id}\" value=\"{markup_value}\" step=\"0.01\" style=\"width: 60px; background: #fffde7; border-color: #ffc107;\" title=\"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞\" placeholder=\"0\"> </div> <input type=\"hidden\" name=\"remove_company_service_{service.id}\" id=\"remove_company_service_{service.id}\" value=\"\"> </div> ''' except Exception: continue html += '</div>' html += f''' <div style=\"margin-top: 10px;\"> <button type=\"button\" class=\"add-service-btn\" onclick=\"openModal('companyServicesModal', 'company')\" title=\"–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏\"> + </button> <span style=\"margin-left: 5px; color: #666;\">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏</span> </div> ''' return mark_safe(html) except Exception as e: return f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}\" company_services_d", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " </button> <span style=\"margin-left: 5px; color: #666;\">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏</span> </div> ''' return mark_safe(html) except Exception as e: return f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥: {e}\" company_services_display.short_description = \"–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π\" def get_changelist(self, request, **kwargs): \"\"\"–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ '–í –ø–æ—Ä—Ç—É' –∏ '–†–∞–∑–≥—Ä—É–∂–µ–Ω'\"\"\" # –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é if not request.GET.get('status_multi'): # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é GET –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ get_params = request.GET.copy() get_params.setlist('status_multi', ['IN_PORT', 'UNLOADED']) request.GET = get_params return super().get_changelist(request, **kwargs) # WarehouseServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª \"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏\" # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–¥–º–∏–Ω # @admin.register(Warehouse) # class WarehouseAdmin(admin.ModelAdmin): @admin.register(Warehouse) class WarehouseAdmin(admin.ModelAdmin): list_display = ('name', 'address', 'free_days', 'balance_display') search_fields = ('name', 'address') readonly_fields = ('balance',) exclude = ( 'default_unloading_fee', 'delivery_to_warehouse', 'loading_on_trawl', 'documents_fee', 'transfer_fee', 'transit_declaration', 'e", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "fields = ('name', 'address') readonly_fields = ('balance',) exclude = ( 'default_unloading_fee', 'delivery_to_warehouse', 'loading_on_trawl', 'documents_fee', 'transfer_fee', 'transit_declaration', 'export_declaration', 'additional_expenses', 'complex_fee' ) inlines = [WarehouseServiceInline] fieldsets = ( ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', { 'fields': ('name', 'address') }), ('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è', { 'fields': ('free_days',), 'description': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è. –°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.' }), ('–ë–∞–ª–∞–Ω—Å', { 'fields': ('balance',), 'description': '–ë–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞' }), ) def balance_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞\"\"\" try: balance = obj.balance or 0 color = '#28a745' if balance >= 0 else '#dc3545' sign = '+' if balance >= 0 else '' return format_html( '<span style=\"color:{}; font-weight:bold;\">{} {:.2f}</span>', color, sign, balance ) except: return '-' balance_display.short_description = '–ë–∞–ª–∞–Ω—Å' def balance_summary_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–∫–ª–∞–¥–∞\"\"\" try: balance = obj.balance or 0 html = f\"\"\" <div style=\"background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;\"> <h3 style=\"margin-top:0; color", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–∫–ª–∞–¥–∞\"\"\" try: balance = obj.balance or 0 html = f\"\"\" <div style=\"background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;\"> <h3 style=\"margin-top:0; color:#495057;\">–ë–∞–ª–∞–Ω—Å —Å–∫–ª–∞–¥–∞</h3> <div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\"> <strong>–ë–∞–ª–∞–Ω—Å:</strong><br> <span style=\"font-size:18px; color:{'#28a745' if balance >= 0 else '#dc3545'};\">{balance:.2f}</span> </div> </div> <div style=\"background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};\"> <strong style=\"color:{'#28a745' if total_balance >= 0 else '#dc3545'};\">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</strong><br> <span style=\"font-size:24px; font-weight:bold; color:{'#28a745' if total_balance >= 0 else '#dc3545'};\">{total_balance:.2f}</span> </div> </div> \"\"\" return format_html(html) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {e}</p>') balance_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É' def balance_transactions_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–∫–ª–∞–¥–∞\"\"\" try: # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ payments = Payment.objects.filter( models.Q(f", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "hort_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É' def balance_transactions_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–∫–ª–∞–¥–∞\"\"\" try: # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ payments = Payment.objects.filter( models.Q(from_warehouse=obj) | models.Q(to_warehouse=obj) ).order_by('-date', '-id')[:20] # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–ª–∞—Ç–µ–∂–µ–π if not payments.exists(): return format_html('<p style=\"color:#6c757d;\">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>') html = ['<div style=\"margin-top:15px;\">'] html.append('<h4 style=\"margin-bottom:10px; color:#495057;\">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>') html.append('<table style=\"width:100%; border-collapse:collapse; font-size:12px;\">') html.append('<tr style=\"background-color:#f8f9fa;\">') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–î–∞—Ç–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–¢–∏–ø</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "x; text-align:left;\">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û–ø–∏—Å–∞–Ω–∏–µ</th>') html.append('</tr>') for payment in payments: amount_color = '#28a745' if payment.to_warehouse == obj else '#dc3545' html.append('<tr>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.date.strftime(\"%d.%m.%Y\")}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.payment_type}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;\">{payment.amount:.2f}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.sender}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.recipient}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.description or \"-\"}</td>') html.append('</tr>') html.append('</table>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>') ba", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "nd('</tr>') html.append('</table>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>') balance_transactions_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏' def reset_warehouse_balance(self, request, queryset): \"\"\"–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤\"\"\" from django.contrib import messages try: for warehouse in queryset: warehouse.balance = 0 warehouse.save() messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} —Å–∫–ª–∞–¥–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}') reset_warehouse_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤' def change_view(self, request, object_id, form_url='', extra_context=None): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥\"\"\" extra_context = extra_context or {} if object_id: obj = self.get_object(request, object_id) if request.method == 'POST': # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('service_name_'): service_id = key.replace('service_name_', '') # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ) if service_id.isdigit(): try: se", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": ", value in request.POST.items(): if key.startswith('service_name_'): service_id = key.replace('service_name_', '') # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ) if service_id.isdigit(): try: service = WarehouseService.objects.get(id=service_id, warehouse=obj) service.name = value service.save() except WarehouseService.DoesNotExist: pass elif key.startswith('service_price_'): service_id = key.replace('service_price_', '') # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID —É—Å–ª—É–≥–∏ (—á–∏—Å–ª–æ) if service_id.isdigit(): try: service = WarehouseService.objects.get(id=service_id, warehouse=obj) service.default_price = float(value) if value else 0 service.save() except (WarehouseService.DoesNotExist, ValueError): pass elif key.startswith('delete_service_'): service_id = key.replace('delete_service_', '') try: service = WarehouseService.objects.get(id=service_id, warehouse=obj) service.delete() except WarehouseService.DoesNotExist: pass # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è —É—Å–ª—É–≥ old_fields_mapping = { 'service_price_complex': 'complex_fee', 'service_price_unloading': 'default_unloading_fee', 'service_price_delivery': 'delivery_to_warehouse', 'service_price_loading': 'loading_on_trawl', 'service_price_documents'", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "e_complex': 'complex_fee', 'service_price_unloading': 'default_unloading_fee', 'service_price_delivery': 'delivery_to_warehouse', 'service_price_loading': 'loading_on_trawl', 'service_price_documents': 'documents_fee', 'service_price_transfer': 'transfer_fee', 'service_price_transit': 'transit_declaration', 'service_price_export': 'export_declaration', 'service_price_additional': 'additional_expenses', 'service_price_rate': 'rate', } # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –Ω—É–∂–Ω–æ –æ–±–Ω—É–ª–∏—Ç—å for key, value in request.POST.items(): if key.startswith('clear_field_'): field_name = key.replace('clear_field_', '') setattr(obj, field_name, 0) obj.save() # –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π for field_name, model_field in old_fields_mapping.items(): if field_name in request.POST: try: value = float(request.POST[field_name]) if request.POST[field_name] else 0 setattr(obj, model_field, value) obj.save() except ValueError: pass # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('new_service_name_'): index = key.replace('new_service_name_', '') name = value price = request.POST.get(f'new_service_price_{index}', 0) if name: try: WarehouseService.objects.create( warehouse=obj,", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "('new_service_name_'): index = key.replace('new_service_name_', '') name = value price = request.POST.get(f'new_service_price_{index}', 0) if name: try: WarehouseService.objects.create( warehouse=obj, name=name, default_price=float(price) if price else 0 ) except ValueError: pass return super().change_view(request, object_id, form_url, extra_context) # ============================================================================ # –°–¢–ê–†–ê–Ø –ê–î–ú–ò–ù–ö–ê INVOICE - –£–î–ê–õ–ï–ù–ê # ============================================================================ # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ NewInvoiceAdmin –∏–∑ admin_billing.py # ============================================================================ # @admin.register(InvoiceOLD) # –û—Ç–∫–ª—é—á–µ–Ω–æ # ============================================================================ # –°–¢–ê–†–ê–Ø –ê–î–ú–ò–ù–ö–ê PAYMENT - –£–î–ê–õ–ï–ù–ê # ============================================================================ # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TransactionAdmin –∏–∑ admin_billing.py # ============================================================================ # @admin.register(PaymentOLD) # –û—Ç–∫–ª—é—á–µ–Ω–æ @admin.register(Client) class ClientAdmin(admin.ModelAdmin): change_form_template = 'admin/client_change.html' list_di", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "======================================= # @admin.register(PaymentOLD) # –û—Ç–∫–ª—é—á–µ–Ω–æ @admin.register(Client) class ClientAdmin(admin.ModelAdmin): change_form_template = 'admin/client_change.html' list_display = ('name', 'emails_display', 'notification_enabled', 'new_balance_display', 'balance_status_new') list_filter = ('name', 'notification_enabled') search_fields = ('name', 'email', 'email2', 'email3', 'email4') actions = ['reset_balances', 'recalculate_balance', 'reset_client_balance'] readonly_fields = ('balance', 'balance_updated_at', 'new_invoices_display', 'new_transactions_display') def get_queryset(self, request): \"\"\"–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º with_balance_info –¥–ª—è –ø—Ä–µ–¥—Ä–∞—Å—á–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö\"\"\" qs = super().get_queryset(request) # –î–ª—è list view –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å annotate if 'changelist' in request.path: return qs.with_balance_info() return qs fieldsets = ( ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', { 'fields': ('name', 'notification_enabled') }), ('üìß Email-–∞–¥—Ä–µ—Å–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', { 'fields': ('email', 'email2', 'email3', 'email4'), 'description': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞' }), ('üí∞ –ë–∞–ª–∞–Ω—Å', { 'fields': ('balance', 'balance_updated_at", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ds': ('email', 'email2', 'email3', 'email4'), 'description': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞' }), ('üí∞ –ë–∞–ª–∞–Ω—Å', { 'fields': ('balance', 'balance_updated_at', 'new_invoices_display', 'new_transactions_display'), 'description': '–ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π' }), ) def emails_display(self, obj): \"\"\"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ email-–∞–¥—Ä–µ—Å–æ–≤\"\"\" emails = obj.get_notification_emails() count = len(emails) if count == 0: return format_html('<span style=\"color: #999;\">‚Äî</span>') elif count == 1: return format_html('<span title=\"{}\">{}</span>', emails[0], emails[0]) else: all_emails = ', '.join(emails) return format_html('<span title=\"{}\">{} (+{})</span>', all_emails, emails[0], count - 1) emails_display.short_description = 'Email' def real_balance_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ (–∏–Ω–≤–æ–π—Å—ã - –ø–ª–∞—Ç–µ–∂–∏)\"\"\" balance = obj.real_balance color = obj.balance_color sign = '' if balance == 0 else ('+' if balance > 0 else '') formatted = f\"{balance:.2f}\" return format_html( '<span style=\"color:{}; font-weight:bold; font-size:14px;\">{} {}</span>', color, sign, formatted ) real_balance_display.short_description = '–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å (–î", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ted = f\"{balance:.2f}\" return format_html( '<span style=\"color:{}; font-weight:bold; font-size:14px;\">{} {}</span>', color, sign, formatted ) real_balance_display.short_description = '–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å (–î–æ–ª–≥/–ü–µ—Ä–µ–ø–ª–∞—Ç–∞)' real_balance_display.admin_order_field = '_real_balance_annotated' def balance_status_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ —Ü–≤–µ—Ç–Ω—ã–º –±–µ–π–¥–∂–µ–º\"\"\" status = obj.balance_status color = obj.balance_color bg_color = color.replace('#', '') return format_html( '<span style=\"background-color:{}; color:white; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold;\">{}</span>', color, status ) balance_status_display.short_description = '–°—Ç–∞—Ç—É—Å' def new_balance_display(self, obj): \"\"\"–ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê - –µ–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å\"\"\" balance = obj.balance if balance > 0: color = '#28a745' text = f'+{balance:.2f}' elif balance < 0: color = '#dc3545' text = f'{balance:.2f}' else: color = '#6c757d' text = '0.00' return format_html( '<span style=\"color:{}; font-weight:bold; font-size:15px;\">{}</span>', color, text ) new_balance_display.short_description = '–ë–∞–ª–∞–Ω—Å' new_balance_display.admin_order_field = 'balance' def balance_status_new(self, obj): \"\"\"–°—Ç–∞—Ç—É—Å –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞\"\"\" balan", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "15px;\">{}</span>', color, text ) new_balance_display.short_description = '–ë–∞–ª–∞–Ω—Å' new_balance_display.admin_order_field = 'balance' def balance_status_new(self, obj): \"\"\"–°—Ç–∞—Ç—É—Å –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞\"\"\" balance = obj.balance if balance > 0: return format_html('<span style=\"background:#28a745; color:white; padding:3px 8px; border-radius:3px;\">–ü–ï–†–ï–ü–õ–ê–¢–ê</span>') elif balance < 0: return format_html('<span style=\"background:#dc3545; color:white; padding:3px 8px; border-radius:3px;\">–î–û–õ–ì</span>') else: return format_html('<span style=\"background:#6c757d; color:white; padding:3px 8px; border-radius:3px;\">OK</span>') balance_status_new.short_description = '–°—Ç–∞—Ç—É—Å' def new_invoices_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã\"\"\" from core.models_billing import NewInvoice invoices = NewInvoice.objects.filter(recipient_client=obj).order_by('-date')[:10] if not invoices: return format_html('<p style=\"color:#999;\">–ò–Ω–≤–æ–π—Å–æ–≤ –µ—â–µ –Ω–µ—Ç. <a href=\"/admin/core/newinvoice/add/\">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω–≤–æ–π—Å</a></p>') html = '<table style=\"width:100%; border-collapse:collapse;\">' html += '<tr style=\"background:#f5f5f5;\"><th style=\"padding:8px;\">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–û–ø–ª–∞—á–µ–Ω–æ</th><th>–°—Ç", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "</a></p>') html = '<table style=\"width:100%; border-collapse:collapse;\">' html += '<tr style=\"background:#f5f5f5;\"><th style=\"padding:8px;\">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–û–ø–ª–∞—á–µ–Ω–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr>' for inv in invoices: status_color = {'PAID': '#28a745', 'ISSUED': '#007bff', 'OVERDUE': '#dc3545'}.get(inv.status, '#6c757d') html += f'''<tr style=\"border-bottom:1px solid #ddd;\"> <td style=\"padding:8px;\"><a href=\"/admin/core/newinvoice/{inv.pk}/change/\">{inv.number}</a></td> <td style=\"padding:8px;\">{inv.date.strftime(\"%d.%m.%Y\")}</td> <td style=\"padding:8px;\">{inv.total:.2f}</td> <td style=\"padding:8px;\">{inv.paid_amount:.2f}</td> <td style=\"padding:8px;\"><span style=\"background:{status_color}; color:white; padding:2px 6px; border-radius:3px;\">{inv.get_status_display()}</span></td> </tr>''' html += '</table>' return format_html(html) new_invoices_display.short_description = '–ò–Ω–≤–æ–π—Å—ã' def new_transactions_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã\"\"\" from core.models_billing import Transaction transactions = Transaction.objects.filter( models.Q(from_client=obj) | models.Q(to_client=obj) ).order_by('-date')[:10] if not transactions: return format_htm", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "om core.models_billing import Transaction transactions = Transaction.objects.filter( models.Q(from_client=obj) | models.Q(to_client=obj) ).order_by('-date')[:10] if not transactions: return format_html('<p style=\"color:#999;\">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –µ—â–µ –Ω–µ—Ç</p>') html = '<table style=\"width:100%; border-collapse:collapse;\">' html += '<tr style=\"background:#f5f5f5;\"><th style=\"padding:8px;\">–ù–æ–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th></tr>' for trx in transactions: type_color = {'PAYMENT': '#28a745', 'REFUND': '#dc3545'}.get(trx.type, '#007bff') direction = '‚Üë –ü–æ–ª—É—á–µ–Ω–æ' if trx.to_client == obj else '‚Üì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' html += f'''<tr style=\"border-bottom:1px solid #ddd;\"> <td style=\"padding:8px;\"><a href=\"/admin/core/transaction/{trx.pk}/change/\">{trx.number}</a></td> <td style=\"padding:8px;\">{trx.date.strftime(\"%d.%m.%Y %H:%M\")}</td> <td style=\"padding:8px;\"><span style=\"background:{type_color}; color:white; padding:2px 6px; border-radius:3px;\">{trx.get_type_display()}</span></td> <td style=\"padding:8px; font-weight:bold;\">{trx.amount:.2f}</td> <td style=\"padding:8px;\">{direction}</td> </tr>''' html += '</table>' return format_html(html) new_transactions_display.short_descri", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "d> <td style=\"padding:8px; font-weight:bold;\">{trx.amount:.2f}</td> <td style=\"padding:8px;\">{direction}</td> </tr>''' html += '</table>' return format_html(html) new_transactions_display.short_description = '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏' def recalculate_balance(self, request, queryset): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\"\"\" from django.contrib import messages count = 0 for client in queryset: try: # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ client.sync_balance_fields() count += 1 messages.success(request, f'–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}: {e}') if count > 0: messages.success(request, f'–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è {count} –∫–ª–∏–µ–Ω—Ç–æ–≤') else: messages.warning(request, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞') recalculate_balance.short_description = '–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å' def sync_all_balances(self, request, queryset): \"\"\"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–æ–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\"\"\" from django.contrib import messages count = 0 for client in queryset: try: client.sync_balance_fields() count += 1 messages.success(request, f'–ò–Ω", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–æ–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\"\"\" from django.contrib import messages count = 0 for client in queryset: try: client.sync_balance_fields() count += 1 messages.success(request, f'–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}: {e}') if count > 0: messages.success(request, f'–£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –¥–ª—è {count} –∫–ª–∏–µ–Ω—Ç–æ–≤') else: messages.warning(request, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞') sync_all_balances.short_description = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å—ã' def get_queryset(self, request): \"\"\"–ü–æ–ª—É—á–∞–µ–º queryset —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π\"\"\" return Client.objects.with_balance_info() def change_view(self, request, object_id, form_url='', extra_context=None): extra_context = extra_context or {} client = self.get_object(request, object_id) if client: try: summary = client.get_balance_summary() extra_context['balance_summary'] = summary except Exception as e: logger.error(f\"Failed to get balance summary for client {client.name}: {e}\") extra_context['balance_summary_error'] = f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {str(e)}\" re", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "'] = summary except Exception as e: logger.error(f\"Failed to get balance summary for client {client.name}: {e}\") extra_context['balance_summary_error'] = f\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {str(e)}\" return super().change_view(request, object_id, form_url, extra_context) def reset_balances(self, request, queryset): if 'confirm' in request.POST: client_ids = request.POST.getlist('_selected_action') clients = Client.objects.filter(id__in=client_ids) from django.core.management import call_command failed_clients = [] for client in clients: try: call_command('reset_client_balances', client_id=client.id) except Exception as e: logger.error(f\"Failed to reset balance for client {client.name}: {e}\") failed_clients.append(f\"{client.name}: {str(e)}\") if failed_clients: self.message_user(request, f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: {'; '.join(failed_clients)}\", level='error') else: self.message_user(request, f\"–ë–∞–ª–∞–Ω—Å—ã –¥–ª—è {len(clients)} –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã\") return HttpResponseRedirect(request.get_full_path()) return render(request, 'admin/confirm_reset_balances.html', { 'clients': queryset, 'action': 'reset_balances', 'action_name': '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã' }) reset_balances.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "nseRedirect(request.get_full_path()) return render(request, 'admin/confirm_reset_balances.html', { 'clients': queryset, 'action': 'reset_balances', 'action_name': '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã' }) reset_balances.short_description = \"–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤\" def reset_client_balance(self, request, queryset): \"\"\"–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\"\"\" from django.contrib import messages try: for client in queryset: client.balance = 0 client.save() messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –∫–ª–∏–µ–Ω—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}') reset_client_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤' # ======================================================================== # –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–û–ú –ö–õ–ò–ï–ù–¢–ê # ======================================================================== def get_urls(self): from django.urls import path urls = super().get_urls() custom_urls = [ path('<int:client_id>/topup/', self.admin_site.admin_view(self.topup_balance_view), name='client_topup'), path('<int:client_id>/reset-balance/', self.admin_site.admin_view(self.reset_balance_view), name='client_reset_balance'), p", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": ", self.admin_site.admin_view(self.topup_balance_view), name='client_topup'), path('<int:client_id>/reset-balance/', self.admin_site.admin_view(self.reset_balance_view), name='client_reset_balance'), path('<int:client_id>/recalc-balance/', self.admin_site.admin_view(self.recalc_balance_view), name='client_recalc_balance'), path('<int:client_id>/cars-in-warehouse/', self.admin_site.admin_view(self.cars_in_warehouse_view), name='client_cars_in_warehouse'), ] return custom_urls + urls def topup_balance_view(self, request, client_id): \"\"\"–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞\"\"\" from django.shortcuts import render, redirect from django.contrib import messages from decimal import Decimal from core.services.billing_service import BillingService client = Client.objects.get(pk=client_id) if request.method == 'POST': try: amount = Decimal(request.POST.get('amount', 0)) method = request.POST.get('method', 'CASH') description = request.POST.get('description', '') if amount <= 0: raise ValueError(\"–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π\") trx = BillingService.topup_balance( entity=client, amount=amount, method=method, description=description or f\"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}\", created_by=reque", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π\") trx = BillingService.topup_balance( entity=client, amount=amount, method=method, description=description or f\"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ {client.name}\", created_by=request.user ) messages.success( request, f'‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {trx.number}, —Å—É–º–º–∞: {amount}‚Ç¨' ) return redirect('admin:core_client_change', client_id) except Exception as e: messages.error(request, f'‚ùå –û—à–∏–±–∫–∞: {e}') context = { 'client': client, 'opts': self.model._meta, 'title': f'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ - {client.name}', } return render(request, 'admin/client_topup.html', context) def reset_balance_view(self, request, client_id): \"\"\"–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞\"\"\" from django.shortcuts import redirect from django.contrib import messages from decimal import Decimal client = Client.objects.get(pk=client_id) old_balance = client.balance client.balance = Decimal('0.00') client.save(update_fields=['balance']) messages.success(request, f'‚úÖ –ë–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {client.name} –æ–±–Ω—É–ª—ë–Ω (–±—ã–ª: {old_balance}‚Ç¨)') return redirect('admin:core_client_change', client_id) def recalc_balance_view(self, request, client_id): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\"\"\" from django.shortcuts import redire", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "‚Ç¨)') return redirect('admin:core_client_change', client_id) def recalc_balance_view(self, request, client_id): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\"\"\" from django.shortcuts import redirect from django.contrib import messages from django.db.models import Sum from decimal import Decimal from core.models_billing import Transaction client = Client.objects.get(pk=client_id) old_balance = client.balance # –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (TOPUP) topups = Transaction.objects.filter( to_client=client, type='TOPUP', status='COMPLETED' ).aggregate(Sum('amount'))['amount__sum'] or Decimal('0.00') # –ü–ª–∞—Ç–µ–∂–∏ (PAYMENT) payments = Transaction.objects.filter( from_client=client, type='PAYMENT', status='COMPLETED' ).aggregate(Sum('amount'))['amount__sum'] or Decimal('0.00') # –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å new_balance = topups - payments client.balance = new_balance client.save(update_fields=['balance']) messages.success( request, f'‚úÖ –ë–∞–ª–∞–Ω—Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω: {old_balance}‚Ç¨ ‚Üí {new_balance}‚Ç¨ (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: {topups}‚Ç¨, –ø–ª–∞—Ç–µ–∂–∏: {payments}‚Ç¨)' ) return redirect('admin:core_client_change', client_id) def cars_in_warehouse_view(self, request, client_id): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–∑–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ\"\"\" from django.shortcut", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "‚Ç¨)' ) return redirect('admin:core_client_change', client_id) def cars_in_warehouse_view(self, request, client_id): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–∑–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ\"\"\" from django.shortcuts import render from django.http import JsonResponse client = Client.objects.get(pk=client_id) # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º UNLOADED (–Ω–∞ —Å–∫–ª–∞–¥–µ) cars = Car.objects.filter( client=client, status='UNLOADED' ).select_related('warehouse', 'container').order_by('warehouse__name', '-unload_date') # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–∫–ª–∞–¥–∞–º warehouses_data = {} for car in cars: wh_name = car.warehouse.name if car.warehouse else '–ë–µ–∑ —Å–∫–ª–∞–¥–∞' if wh_name not in warehouses_data: warehouses_data[wh_name] = [] warehouses_data[wh_name].append(car) # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è text_for_copy = f\"–ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ - {client.name}\\n\" text_for_copy += f\"–î–∞—Ç–∞: {timezone.now().strftime('%d.%m.%Y')}\\n\" text_for_copy += \"=\" * 40 + \"\\n\\n\" for wh_name, wh_cars in warehouses_data.items(): text_for_copy += f\"üìç {wh_name} ({len(wh_cars)} –∞–≤—Ç–æ)\\n\" text_for_copy += \"-\" * 30 + \"\\n\" for car in wh_cars: text_for_copy += f\"‚Ä¢ {car.vin} - {car.brand} {car.year}\" if car.unload_date: text_for_copy += f\" (—Ä–∞–∑–≥—Ä. {car.unload_date.st", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "len(wh_cars)} –∞–≤—Ç–æ)\\n\" text_for_copy += \"-\" * 30 + \"\\n\" for car in wh_cars: text_for_copy += f\"‚Ä¢ {car.vin} - {car.brand} {car.year}\" if car.unload_date: text_for_copy += f\" (—Ä–∞–∑–≥—Ä. {car.unload_date.strftime('%d.%m.%Y')})\" text_for_copy += \"\\n\" text_for_copy += \"\\n\" text_for_copy += f\"–ò—Ç–æ–≥–æ: {cars.count()} –∞–≤—Ç–æ\" context = { 'client': client, 'cars': cars, 'warehouses_data': warehouses_data, 'text_for_copy': text_for_copy, 'total_count': cars.count(), 'opts': self.model._meta, 'title': f'–ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ - {client.name}', } return render(request, 'admin/client_cars_in_warehouse.html', context) @admin.register(Company) class CompanyAdmin(admin.ModelAdmin): change_form_template = 'admin/company_change.html' list_display = ('name', 'balance_display', 'is_main_company', 'created_at', 'updated_at') search_fields = ('name',) readonly_fields = ('created_at', 'updated_at', 'balance') actions = ['reset_company_balance'] inlines = [CompanyServiceInline] fieldsets = ( ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', { 'fields': ('name',) }), ('–ë–∞–ª–∞–Ω—Å', { 'fields': ('balance',), 'description': '–ë–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏' }), ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', { 'classes': ('collapse',), 'fields': ('created_at', 'updated_at') }), ) def balanc", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "s': ('name',) }), ('–ë–∞–ª–∞–Ω—Å', { 'fields': ('balance',), 'description': '–ë–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏' }), ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', { 'classes': ('collapse',), 'fields': ('created_at', 'updated_at') }), ) def balance_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏\"\"\" try: balance = obj.balance or 0 color = '#28a745' if balance >= 0 else '#dc3545' sign = '+' if balance >= 0 else '' return format_html( '<span style=\"color:{}; font-weight:bold;\">{} {:.2f}</span>', color, sign, balance ) except: return '-' balance_display.short_description = '–ë–∞–ª–∞–Ω—Å' def is_main_company(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π\"\"\" return obj.name == \"Caromoto Lithuania\" is_main_company.boolean = True is_main_company.short_description = \"–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è\" def invoices_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã\"\"\" try: # –ò–Ω–≤–æ–π—Å—ã, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π outgoing_invoices = Invoice.objects.filter( from_entity_type='COMPANY', from_entity_id=obj.id ).order_by('-issue_date')[:10] # –ò–Ω–≤–æ–π—Å—ã, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π incoming_invoices = Invoice.objects.filter( to_entity_type='COMPANY', to_entity_id=obj.id ).order_by('-issue_date')[:10] html = ['<div style=\"margin-top:15px;\">'] # –ò—Å—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã html.app", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–æ–º–ø–∞–Ω–∏–µ–π incoming_invoices = Invoice.objects.filter( to_entity_type='COMPANY', to_entity_id=obj.id ).order_by('-issue_date')[:10] html = ['<div style=\"margin-top:15px;\">'] # –ò—Å—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã html.append('<h4 style=\"margin-bottom:10px; color:#495057;\">–ò–Ω–≤–æ–π—Å—ã, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h4>') if outgoing_invoices.exists(): html.append('<table style=\"width:100%; border-collapse:collapse; font-size:12px;\">') html.append('<tr style=\"background-color:#f8f9fa;\">') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ù–æ–º–µ—Ä</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ö–æ–º—É</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—Ç–∞—Ç—É—Å</th>') html.append('</tr>') for invoice in outgoing_invoices: status_color = '#28a745' if invoice.paid else '#dc3545' status_text = '–û–ø–ª–∞—á–µ–Ω' if invoice.paid else '–ù–µ –æ–ø–ª–∞—á–µ–Ω' html.append('<tr>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\"><a href=\"/admin/core/invoice/{invoice.id}/change/\">{invoice.number}</a></td>') html.append(f'<td style=\"borde", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "–∞—á–µ–Ω' html.append('<tr>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\"><a href=\"/admin/core/invoice/{invoice.id}/change/\">{invoice.number}</a></td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{invoice.to_entity_name}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{invoice.total_amount:.2f}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px; color:{status_color};\">{status_text}</td>') html.append('</tr>') html.append('</table>') else: html.append('<p style=\"color:#6c757d;\">–ù–µ—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>') # –í—Ö–æ–¥—è—â–∏–µ –∏–Ω–≤–æ–π—Å—ã html.append('<h4 style=\"margin-top:20px; margin-bottom:10px; color:#495057;\">–ò–Ω–≤–æ–π—Å—ã, –ø–æ–ª—É—á–∞–µ–º—ã–µ –∫–æ–º–ø–∞–Ω–∏–µ–π</h4>') if incoming_invoices.exists(): html.append('<table style=\"width:100%; border-collapse:collapse; font-size:12px;\">') html.append('<tr style=\"background-color:#f8f9fa;\">') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ù–æ–º–µ—Ä</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û—Ç –∫–æ–≥–æ</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th sty", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "d('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û—Ç –∫–æ–≥–æ</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—Ç–∞—Ç—É—Å</th>') html.append('</tr>') for invoice in incoming_invoices: status_color = '#28a745' if invoice.paid else '#dc3545' status_text = '–û–ø–ª–∞—á–µ–Ω' if invoice.paid else '–ù–µ –æ–ø–ª–∞—á–µ–Ω' html.append('<tr>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\"><a href=\"/admin/core/invoice/{invoice.id}/change/\">{invoice.number}</a></td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{invoice.from_entity_name}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{invoice.total_amount:.2f}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px; color:{status_color};\">{status_text}</td>') html.append('</tr>') html.append('</table>') else: html.append('<p style=\"color:#6c757d;\">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–æ–π—Å–æ–≤: {e}</p>') invoic", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "d;\">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–æ–π—Å–æ–≤: {e}</p>') invoices_display.short_description = '–°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã' def payments_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏\"\"\" try: # –ü–ª–∞—Ç–µ–∂–∏, –≥–¥–µ –∫–æ–º–ø–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º payments = Payment.objects.filter( models.Q(from_company=obj) | models.Q(to_company=obj) ).order_by('-date')[:20] if not payments.exists(): return format_html('<p style=\"color:#6c757d;\">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>') html = ['<div style=\"margin-top:15px;\">'] html.append('<h4 style=\"margin-bottom:10px; color:#495057;\">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>') html.append('<table style=\"width:100%; border-collapse:collapse; font-size:12px;\">') html.append('<tr style=\"background-color:#f8f9fa;\">') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–î–∞—Ç–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–¢–∏–ø</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padd", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " #dee2e6; padding:8px; text-align:left;\">–¢–∏–ø</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û—Ç –∫–æ–≥–æ</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ö–æ–º—É</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û–ø–∏—Å–∞–Ω–∏–µ</th>') html.append('</tr>') for payment in payments: # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º if payment.from_company == obj: # –ö–æ–º–ø–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ–Ω—å–≥–∏ amount_color = '#dc3545' # –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö amount_sign = '-' amount_display = f\"{amount_sign}{payment.amount:.2f}\" else: # –ö–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∞–µ—Ç –¥–µ–Ω—å–≥–∏ amount_color = '#28a745' # –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö amount_sign = '+' amount_display = f\"{amount_sign}{payment.amount:.2f}\" html.append('<tr>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.date}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.get_payment_type_display()}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;\">{a", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "d style=\"border:1px solid #dee2e6; padding:8px;\">{payment.get_payment_type_display()}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;\">{amount_display}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.sender or \"-\"}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.recipient or \"-\"}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.description or \"-\"}</td>') html.append('</tr>') html.append('</table>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>') payments_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏' def balance_summary_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–∞–ª–∞–Ω—Å—É –∫–æ–º–ø–∞–Ω–∏–∏\"\"\" try: cash_balance = obj.cash_balance or 0 card_balance = obj.card_balance or 0 invoice_balance = obj.invoice_balance or 0 total_balance = cash_balance + card_balance + invoice_balance html = f\"\"\" <div style=\"background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;\"> <h3 style=\"margin-top:0; color:#495057;\">–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "alance + card_balance + invoice_balance html = f\"\"\" <div style=\"background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6;\"> <h3 style=\"margin-top:0; color:#495057;\">–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É –∫–æ–º–ø–∞–Ω–∏–∏</h3> <div style=\"display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px;\"> <div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\"> <strong>–ù–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong><br> <span style=\"font-size:18px; color:{'#28a745' if cash_balance >= 0 else '#dc3545'};\">{cash_balance:.2f}</span> </div> <div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\"> <strong>–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong><br> <span style=\"font-size:18px; color:{'#28a745' if card_balance >= 0 else '#dc3545'};\">{card_balance:.2f}</span> </div> <div style=\"background:white; padding:10px; border-radius:5px; border:1px solid #dee2e6;\"> <strong>–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å:</strong><br> <span style=\"font-size:18px; color:{'#28a745' if invoice_balance >= 0 else '#dc3545'};\">{invoice_balance:.2f}</span> </div> </div> <div style=\"background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};\"> <s", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": ">= 0 else '#dc3545'};\">{invoice_balance:.2f}</span> </div> </div> <div style=\"background:white; padding:15px; border-radius:5px; border:2px solid {'#28a745' if total_balance >= 0 else '#dc3545'};\"> <strong style=\"color:{'#28a745' if total_balance >= 0 else '#dc3545'};\">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</strong><br> <span style=\"font-size:24px; font-weight:bold; color:{'#28a745' if total_balance >= 0 else '#dc3545'};\">{total_balance:.2f}</span> </div> <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è Caromoto Lithuania) --> {f''' <div style=\"margin-top:20px; text-align:center;\"> <a href=\"/company-dashboard/\" style=\"display:inline-block; padding:12px 24px; background:#667eea; color:white; text-decoration:none; border-radius:8px; font-weight:600; font-size:16px;\"> üè¢ –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ –∫–æ–º–ø–∞–Ω–∏–∏ </a> </div> ''' if obj.name == \"Caromoto Lithuania\" else \"\"} </div> \"\"\" return format_html(html) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: {e}</p>') balance_summary_display.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É' def balance_transactions_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –∫–æ–º–ø–∞–Ω–∏–∏\"\"\" try: # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ payments = Payment.objects.filter( mo", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ay.short_description = '–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É' def balance_transactions_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –∫–æ–º–ø–∞–Ω–∏–∏\"\"\" try: # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ payments = Payment.objects.filter( models.Q(from_company=obj) | models.Q(to_company=obj) ).order_by('-date', '-id')[:20] # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–ª–∞—Ç–µ–∂–µ–π if not payments.exists(): return format_html('<p style=\"color:#6c757d;\">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>') html = ['<div style=\"margin-top:15px;\">'] html.append('<h4 style=\"margin-bottom:10px; color:#495057;\">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>') html.append('<table style=\"width:100%; border-collapse:collapse; font-size:12px;\">') html.append('<tr style=\"background-color:#f8f9fa;\">') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–î–∞—Ç–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–¢–∏–ø</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–°—É–º–º–∞</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "g:8px; text-align:left;\">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>') html.append('<th style=\"border:1px solid #dee2e6; padding:8px; text-align:left;\">–û–ø–∏—Å–∞–Ω–∏–µ</th>') html.append('</tr>') for payment in payments: amount_color = '#28a745' if payment.to_company == obj else '#dc3545' html.append('<tr>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.date.strftime(\"%d.%m.%Y\")}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.get_payment_type_display()}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px; color:{amount_color}; font-weight:bold;\">{payment.amount:.2f}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.sender or \"-\"}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.recipient or \"-\"}</td>') html.append(f'<td style=\"border:1px solid #dee2e6; padding:8px;\">{payment.description or \"-\"}</td>') html.append('</tr>') html.append('</table>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ption or \"-\"}</td>') html.append('</tr>') html.append('</table>') html.append('</div>') return format_html(''.join(html)) except Exception as e: return format_html(f'<p style=\"color:#dc3545;\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: {e}</p>') balance_transactions_display.short_description = '–ü–ª–∞—Ç–µ–∂–∏' def reset_company_balance(self, request, queryset): \"\"\"–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π\"\"\" from django.contrib import messages try: for company in queryset: company.balance = 0 company.save() messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –∫–æ–º–ø–∞–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}') reset_company_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π' # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∫–µ Django admin.site.register(Container, ContainerAdmin) # LineServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª \"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏\" @admin.register(Line) class LineAdmin(admin.ModelAdmin): change_form_template = 'admin/line_change.html' form = LineForm list_display = ('name', 'balance_display') search_fields = ('name',) readonly_fields = ('balance',) actions = ['reset_line_balance'] exclude = ('ocean_freight_rate', 'documentation_", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "l' form = LineForm list_display = ('name', 'balance_display') search_fields = ('name',) readonly_fields = ('balance',) actions = ['reset_line_balance'] exclude = ('ocean_freight_rate', 'documentation_fee', 'handling_fee', 'ths_fee', 'additional_fees') inlines = [LineTHSCoefficientInline, LineServiceInline] fieldsets = ( ('–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', { 'fields': ('name',) }), ('–ë–∞–ª–∞–Ω—Å', { 'fields': ('balance',), 'description': '–ë–∞–ª–∞–Ω—Å –ª–∏–Ω–∏–∏' }), ) def balance_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ª–∏–Ω–∏–∏\"\"\" try: balance = obj.balance or 0 color = '#28a745' if balance >= 0 else '#dc3545' sign = '+' if balance >= 0 else '' return format_html( '<span style=\"color:{}; font-weight:bold;\">{} {:.2f}</span>', color, sign, balance ) except Exception as e: return '-' balance_display.short_description = '–ë–∞–ª–∞–Ω—Å' def reset_line_balance(self, request, queryset): \"\"\"–û–±–Ω—É–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π\"\"\" from django.contrib import messages try: for line in queryset: line.balance = 0 line.save() messages.success(request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –ª–∏–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}') reset_line_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "request, f'–ë–∞–ª–∞–Ω—Å—ã {queryset.count()} –ª–∏–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã') except Exception as e: messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: {e}') reset_line_balance.short_description = '–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π' def get_urls(self): from django.urls import path urls = super().get_urls() custom_urls = [ path('<int:object_id>/recalculate_ths/', self.admin_site.admin_view(self.recalculate_ths_view), name='core_line_recalculate_ths'), ] return custom_urls + urls def recalculate_ths_view(self, request, object_id): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º UNLOADED –∏ IN_PORT\"\"\" from django.contrib import messages from django.shortcuts import redirect from django.db import transaction from core.models import Container, Car, Line from core.signals import create_ths_services_for_container import logging logger = logging.getLogger(__name__) print(f\"=== RECALCULATE THS VIEW CALLED === object_id={object_id}\") logger.warning(f\"=== RECALCULATE THS VIEW CALLED === object_id={object_id}\") # –ü–æ–ª—É—á–∞–µ–º –ª–∏–Ω–∏—é –Ω–∞–ø—Ä—è–º—É—é –ø–æ ID try: line = Line.objects.get(pk=object_id) except Line.DoesNotExist: messages.error(request, '–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞') return redirect('admin:core_line_changelist')", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ect_id}\") # –ü–æ–ª—É—á–∞–µ–º –ª–∏–Ω–∏—é –Ω–∞–ø—Ä—è–º—É—é –ø–æ ID try: line = Line.objects.get(pk=object_id) except Line.DoesNotExist: messages.error(request, '–õ–∏–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞') return redirect('admin:core_line_changelist') print(f\"Line: {line}\") logger.info(f\"[RECALC THS] Starting for line {line.name}\") # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Å –º–∞—à–∏–Ω–∞–º–∏ –≤ –Ω—É–∂–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞—Ö containers = Container.objects.filter( line=line, container_cars__status__in=['UNLOADED', 'IN_PORT'] ).distinct() updated_containers = 0 updated_cars = 0 try: with transaction.atomic(): for container in containers: if container.ths: logger.info(f\"[RECALC THS] Container {container.number}, THS={container.ths}\") # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º THS —É—Å–ª—É–≥–∏ created = create_ths_services_for_container(container) logger.info(f\"[RECALC THS] Created {created} THS services\") updated_containers += 1 # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –º–∞—à–∏–Ω for car in container.container_cars.filter(status__in=['UNLOADED', 'IN_PORT']): old_price = car.total_price # –û—á–∏—â–∞–µ–º –∫—ç—à –∏ –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ car.refresh_from_db() if hasattr(car, '_prefetched_objects_cache'): car._prefetched_objects_cache.clear() car.calculate_total_price() car.save(update_fields=['total_price', 'storage_cost', 'days']) lo", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "car.refresh_from_db() if hasattr(car, '_prefetched_objects_cache'): car._prefetched_objects_cache.clear() car.calculate_total_price() car.save(update_fields=['total_price', 'storage_cost', 'days']) logger.info(f\"[RECALC THS] Car {car.vin}: {old_price} -> {car.total_price}\") updated_cars += 1 messages.success( request, f'–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: {updated_containers} –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, {updated_cars} –º–∞—à–∏–Ω' ) except Exception as e: logger.error(f\"[RECALC THS] Error: {e}\", exc_info=True) messages.error(request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ: {e}') from django.urls import reverse return redirect(reverse('admin:core_line_change', args=[object_id])) def change_view(self, request, object_id, form_url='', extra_context=None): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥\"\"\" extra_context = extra_context or {} if object_id: obj = self.get_object(request, object_id) if request.method == 'POST': # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('service_name_'): service_id = key.replace('service_name_', '') try: service = LineService.objects.get(id=service_id, line=obj) service.name = value service.save() except LineService.DoesNotExist: pass elif key.startswith('service", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": " key.replace('service_name_', '') try: service = LineService.objects.get(id=service_id, line=obj) service.name = value service.save() except LineService.DoesNotExist: pass elif key.startswith('service_price_'): service_id = key.replace('service_price_', '') try: service = LineService.objects.get(id=service_id, line=obj) service.default_price = float(value) if value else 0 service.save() except (LineService.DoesNotExist, ValueError): pass elif key.startswith('delete_service_'): service_id = key.replace('delete_service_', '') try: service = LineService.objects.get(id=service_id, line=obj) service.delete() except LineService.DoesNotExist: pass # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('new_service_name_'): index = key.replace('new_service_name_', '') name = value price = request.POST.get(f'new_service_price_{index}', 0) if name: try: LineService.objects.create( line=obj, name=name, default_price=float(price) if price else 0 ) except ValueError: pass return super().change_view(request, object_id, form_url, extra_context) # CarServiceAdmin —É–¥–∞–ª–µ–Ω def get_form(self, request, obj=None, **kwargs): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "pass return super().change_view(request, object_id, form_url, extra_context) # CarServiceAdmin —É–¥–∞–ª–µ–Ω def get_form(self, request, obj=None, **kwargs): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π\"\"\" form = super().get_form(request, obj, **kwargs) if obj and obj.pk: # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤ fieldsets dynamic_fields = [] for service in obj.services.all(): field_name = f'service_{service.id}' dynamic_fields.append(field_name) if dynamic_fields: # –û–±–Ω–æ–≤–ª—è–µ–º fieldsets –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π self.fieldsets = list(self.fieldsets) for i, (title, options) in enumerate(self.fieldsets): if title == '–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã': fields = list(options['fields']) fields.append(tuple(dynamic_fields)) self.fieldsets[i] = (title, {**options, 'fields': tuple(fields)}) break return form # CarrierServiceInline —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª \"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏\" @admin.register(Carrier) class CarrierAdmin(admin.ModelAdmin): change_form_template = 'admin/carrier_change.html' form = CarrierForm list_display = ('name', 'contact_person', 'phone', 'balance_display') search_fields = ('name', 'contact_person', 'phone', 'email') list_filter = ('created_at',) readonly_fields = ('creat", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "= CarrierForm list_display = ('name', 'contact_person', 'phone', 'balance_display') search_fields = ('name', 'contact_person', 'phone', 'email') list_filter = ('created_at',) readonly_fields = ('created_at', 'updated_at', 'balance') exclude = ('transport_rate', 'loading_fee', 'unloading_fee', 'fuel_surcharge', 'additional_fees') inlines = [CarrierServiceInline] fieldsets = ( ('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', { 'fields': ('name', 'short_name', 'contact_person', 'phone', 'email') }), ('–ë–∞–ª–∞–Ω—Å', { 'fields': ('balance',) }), ('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', { 'fields': ('created_at', 'updated_at'), 'classes': ('collapse',) }), ) def balance_display(self, obj): \"\"\"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\"\"\" try: balance = obj.balance or 0 color = '#28a745' if balance >= 0 else '#dc3545' sign = '+' if balance >= 0 else '' return format_html( '<span style=\"color:{}; font-weight:bold;\">{} {:.2f}</span>', color, sign, balance ) except: return '-' balance_display.short_description = '–ë–∞–ª–∞–Ω—Å' def change_view(self, request, object_id, form_url='', extra_context=None): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥\"\"\" extra_context = extra_context or {} if object_id: obj = self.get_object(request, object_id) if request.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "bject_id, form_url='', extra_context=None): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º change_view –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ª—É–≥\"\"\" extra_context = extra_context or {} if object_id: obj = self.get_object(request, object_id) if request.method == 'POST': # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('service_name_'): service_id = key.replace('service_name_', '') try: service = CarrierService.objects.get(id=service_id, carrier=obj) service.name = value service.save() except CarrierService.DoesNotExist: pass elif key.startswith('service_price_'): service_id = key.replace('service_price_', '') try: service = CarrierService.objects.get(id=service_id, carrier=obj) service.default_price = float(value) if value else 0 service.save() except (CarrierService.DoesNotExist, ValueError): pass elif key.startswith('delete_service_'): service_id = key.replace('delete_service_', '') try: service = CarrierService.objects.get(id=service_id, carrier=obj) service.delete() except CarrierService.DoesNotExist: pass # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('new_service_name_'): index = key.replace('new_service_name_', '') name = value price = request.P", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "esNotExist: pass # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ for key, value in request.POST.items(): if key.startswith('new_service_name_'): index = key.replace('new_service_name_', '') name = value price = request.POST.get(f'new_service_price_{index}', 0) if name: try: CarrierService.objects.create( carrier=obj, name=name, default_price=float(price) if price else 0 ) except ValueError: pass return super().change_view(request, object_id, form_url, extra_context) # Company —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ @admin.register –≤—ã—à–µ # ============================================================================== # üéâ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í –ò –ü–õ–ê–¢–ï–ñ–ï–ô # ============================================================================== # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã # –ú–æ–¥–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ @admin.register() –≤ admin_billing.py try: from .admin_billing import NewInvoiceAdmin, TransactionAdmin # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ except ImportError as e: import logging logger = logging.getLogger('django') logger.warning(f\"‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã: {e}\") logger.warning(\"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã admin_billing.py –∏ models_billing.py —Å—É—â–µ—Å—Ç–≤—É—é—Ç\") # –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ —É–∂", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\admin.py", "content": "ng.getLogger('django') logger.warning(f\"‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã: {e}\") logger.warning(\"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã admin_billing.py –∏ models_billing.py —Å—É—â–µ—Å—Ç–≤—É—é—Ç\") # –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã @admin.register", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "from django.db.models.signals import post_save, post_delete, pre_delete, pre_save from django.dispatch import receiver from .models import Car, Container, WarehouseService, LineService, CarrierService, Company, CompanyService, CarService, DeletedCarService, LineTHSCoefficient from .models_billing import NewInvoice from django.db.models import Sum from channels.layers import get_channel_layer from asgiref.sync import async_to_sync from django.db import transaction, OperationalError from django.utils import timezone from decimal import Decimal import logging logger = logging.getLogger('django') # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å _old_container_values = {} @receiver(pre_save, sender=Container) def save_old_container_values(sender, instance, **kwargs): \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\"\"\" print(f\"[PRE_SAVE] Container {instance.number} pk={instance.pk}\", flush=True) if instance.pk: try: old = Container.objects.filter(pk=instance.pk).values('status', 'unload_date').first() if old: _old_container_values[instance.pk] = old print(f\"[PRE_SAVE] Saved old values: {old}\", flush=True) # –§–∏–∫—Å–∏—Ä—É–µ–º –º–æ–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ UNLOADED old_status ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "ues('status', 'unload_date').first() if old: _old_container_values[instance.pk] = old print(f\"[PRE_SAVE] Saved old values: {old}\", flush=True) # –§–∏–∫—Å–∏—Ä—É–µ–º –º–æ–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ UNLOADED old_status = old.get('status') if ( instance.status == 'UNLOADED' and old_status != 'UNLOADED' and not instance.unloaded_status_at ): instance.unloaded_status_at = timezone.now() except Exception as e: print(f\"[PRE_SAVE] Error: {e}\", flush=True) else: # –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –µ—Å–ª–∏ —Å—Ä–∞–∑—É UNLOADED ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ if instance.status == 'UNLOADED' and not instance.unloaded_status_at: instance.unloaded_status_at = timezone.now() @receiver(post_save, sender=Container) def update_related_on_container_save(sender, instance, created, **kwargs): \"\"\" –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ ContainerAdmin.save_model(), –Ω–æ —ç—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞: - form.changed_data –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É (API, shell, management command) \"\"\" old_values = _old_container_values.pop(instance.pk, None) if not instance.pk: return # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ if old_values: old_unload_date = old_values.get('unloa", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "gement command) \"\"\" old_values = _old_container_values.pop(instance.pk, None) if not instance.pk: return # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ if old_values: old_unload_date = old_values.get('unload_date') new_unload_date = instance.unload_date # –ï—Å–ª–∏ –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å - –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∞–≤—Ç–æ if old_unload_date != new_unload_date and new_unload_date is not None: logger.info(f\"üîÑ [SIGNAL] unload_date changed for container {instance.number}: {old_unload_date} -> {new_unload_date}\") try: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ –∞–≤—Ç–æ (—á–µ—Ä–µ–∑ admin.save_model) # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –∞–≤—Ç–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –¥–∞—Ç—É first_car = instance.container_cars.first() if first_car and first_car.unload_date == new_unload_date: logger.debug(f\"[SIGNAL] Cars already updated by admin.save_model, skipping\") return # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —É –≤—Å–µ—Ö –∞–≤—Ç–æ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (–±—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥—ë–∂–Ω–æ) updated_count = instance.container_cars.update(unload_date=new_unload_date) logger.info(f\"‚úÖ [SIGNAL] Updated unload_date to {new_unload_date} for {updated_count} cars in container {instance.number}\") # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–Ω–∏ –∏ —Ü–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ if updated_count > 0: cars_to_update = [] for car in instance.container_cars.select_related('warehouse').", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "dated_count} cars in container {instance.number}\") # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–Ω–∏ –∏ —Ü–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ if updated_count > 0: cars_to_update = [] for car in instance.container_cars.select_related('warehouse').all(): car.update_days_and_storage() car.calculate_total_price() cars_to_update.append(car) if cars_to_update: Car.objects.bulk_update( cars_to_update, ['days', 'storage_cost', 'total_price'], batch_size=50 ) logger.info(f\"‚úÖ [SIGNAL] Recalculated prices for {len(cars_to_update)} cars\") except Exception as e: logger.error(f\"‚ùå [SIGNAL] Failed to update cars for container {instance.number}: {e}\", exc_info=True) @receiver(post_save, sender=Car) def update_related_on_car_save(sender, instance, **kwargs): # –û–±–Ω–æ–≤–ª—è–µ–º total_amount –∏–Ω–≤–æ–π—Å–æ–≤ –ú–ê–°–°–û–í–û —á–µ—Ä–µ–∑ bulk_update logger.debug(f\"üîî Signal post_save triggered for Car {instance.id} ({instance.vin})\") # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á if not instance.pk: logger.debug(\"Skipping - no PK\") return # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∏–Ω–≤–æ–π—Å—ã (NewInvoice) # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ logger.debug(f\"Checking NewInvoice update for car {instance.id}, _updating_invoices={getattr(instance, '_updating_invoices', False)}\") if not getattr(instance, '_updating", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": " –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ logger.debug(f\"Checking NewInvoice update for car {instance.id}, _updating_invoices={getattr(instance, '_updating_invoices', False)}\") if not getattr(instance, '_updating_invoices', False): try: instance._updating_invoices = True # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–æ–≤—ã–µ –∏–Ω–≤–æ–π—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º # –ò—Å–ø–æ–ª—å–∑—É–µ–º select_for_update(nowait=True) —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É new_invoices = list(NewInvoice.objects.filter(cars=instance).values_list('id', flat=True)) logger.debug(f\"Found {len(new_invoices)} NewInvoice(s) for car {instance.vin}\") if new_invoices: for invoice_id in new_invoices: try: # –ö–∞–∂–¥—ã–π –∏–Ω–≤–æ–π—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ with transaction.atomic(): invoice = NewInvoice.objects.select_for_update(nowait=True).get(id=invoice_id) logger.info(f\"Regenerating invoice {invoice.number} for car {instance.vin}...\") invoice.regenerate_items_from_cars() logger.info(f\"‚úÖ Auto-regenerated invoice {invoice.number} for car {instance.vin}\") except OperationalError: # –ò–Ω–≤–æ–π—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º logger.warning(f\"‚è≠Ô∏è Skipping invoice {invoice_id} - locked by another transaction\") except NewInvoice.DoesNotExist: logger.warning(f\"‚è≠Ô∏è Invoice {invo", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "–Ω–≤–æ–π—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º logger.warning(f\"‚è≠Ô∏è Skipping invoice {invoice_id} - locked by another transaction\") except NewInvoice.DoesNotExist: logger.warning(f\"‚è≠Ô∏è Invoice {invoice_id} was deleted\") else: logger.debug(f\"No NewInvoice found for car {instance.vin}\") except Exception as e: logger.error(f\"‚ùå Failed to update new invoices for car {instance.id}: {e}\", exc_info=True) finally: instance._updating_invoices = False else: logger.debug(f\"Skipping NewInvoice update (recursion protection) for car {instance.id}\") # –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è CarService –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º _old_contractors = {} @receiver(pre_save, sender=Car) def save_old_contractors(sender, instance, **kwargs): \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º\"\"\" if instance.pk: try: old_instance = Car.objects.get(pk=instance.pk) _old_contractors[instance.pk] = { 'warehouse_id': old_instance.warehouse_id, 'line_id': old_instance.line_id, 'carrier_id': old_instance.carrier_id } except Car.DoesNotExist: pass def find_line_service_by_container_count(line, container, vehicle_type): \"\"\" –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é —É—Å–ª—É–≥—É ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "id': old_instance.line_id, 'carrier_id': old_instance.carrier_id } except Car.DoesNotExist: pass def find_line_service_by_container_count(line, container, vehicle_type): \"\"\" –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é —É—Å–ª—É–≥—É –ª–∏–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ —Ç–∏–ø–∞ –¢–°. –£–°–¢–ê–†–ï–í–®–ò–ô –ú–ï–¢–û–î - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –î–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ calculate_ths_for_container(). –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞: - –î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤: –∏—â–µ–º \"THS {–õ–ò–ù–ò–Ø} MOTO\" –∏–ª–∏ \"MOTO\" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ - –î–ª—è –∞–≤—Ç–æ: –∏—â–µ–º \"THS {–õ–ò–ù–ò–Ø} {–ö–û–õ-–í–û} –ê–í–¢–û\" –∏–ª–∏ \"{–ö–û–õ-–í–û} –ê–í–¢–û\" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –í–ê–ñ–ù–û: –ú–æ—Ç–æ—Ü–∏–∫–ª—ã –ù–ï —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ! \"\"\" if not line or not container: return None line_name_upper = line.name.upper() # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–û–õ–¨–ö–û –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–º–æ—Ç–æ—Ü–∏–∫–ª—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è!) # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Å–µ –º–æ—Ç–æ-—Ç–∏–ø—ã moto_types = ['MOTO', 'BIG_MOTO', 'ATV'] car_count = container.container_cars.exclude(vehicle_type__in=moto_types).count() # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ services = LineService.objects.filter(line=line, is_active=True) if vehicle_type in moto_types: # –î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤ –∏—â–µ–º —É—Å–ª—É–≥—É —Å MOTO –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ for service in services: service_name_upper = service.name.upper() if 'MOTO' in service_name_upper: # ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "ne, is_active=True) if vehicle_type in moto_types: # –î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤ –∏—â–µ–º —É—Å–ª—É–≥—É —Å MOTO –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ for service in services: service_name_upper = service.name.upper() if 'MOTO' in service_name_upper: # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —É—Å–ª—É–≥–∞ –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∏–∏ if line_name_upper in service_name_upper or 'THS' in service_name_upper: return service # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é, –∏—â–µ–º –ª—é–±—É—é —Å MOTO for service in services: if 'MOTO' in service.name.upper(): return service else: # –î–ª—è –∞–≤—Ç–æ –∏—â–µ–º —É—Å–ª—É–≥—É –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É # –§–æ—Ä–º–∞—Ç: \"THS MAERSK 3 –ê–í–¢–û\" –∏–ª–∏ \"3 –ê–í–¢–û\" search_patterns = [ f'{car_count} –ê–í–¢–û', f'{car_count} AUTO', f'{car_count}–ê–í–¢–û', f'{car_count}AUTO', ] for service in services: service_name_upper = service.name.upper() for pattern in search_patterns: if pattern in service_name_upper: return service return None def calculate_ths_for_container(container): \"\"\" –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º. –ê–ª–≥–æ—Ä–∏—Ç–º: 1. –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—É–º–º—É THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø–æ–ª—É—á–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –µ–≥–æ —Ç–∏–ø–∞ –∏–∑ LineTHSCoefficient 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª—é –∫–∞–∂–¥–æ–≥–æ –¢–° = –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 4. THS –¥–ª—è –¢–° = –æ–±—â–∏–π_THS √ó –¥–æ–ª—è –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å: {car_id: ths_amount} –ü—Ä–∏–º–µ—Ä: -", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –µ–≥–æ —Ç–∏–ø–∞ –∏–∑ LineTHSCoefficient 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª—é –∫–∞–∂–¥–æ–≥–æ –¢–° = –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç / —Å—É–º–º–∞_–≤—Å–µ—Ö_–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 4. THS –¥–ª—è –¢–° = –æ–±—â–∏–π_THS √ó –¥–æ–ª—è –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å: {car_id: ths_amount} –ü—Ä–∏–º–µ—Ä: - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR - 3 –º–∞—à–∏–Ω—ã: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(2.0) + –º–æ—Ç–æ(0.5) = —Å—É–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 3.5 - –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/3.5) = 143 EUR ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 145 EUR - –î–∂–∏–ø: 500 √ó (2.0/3.5) = 286 EUR ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 290 EUR - –ú–æ—Ç–æ: 500 √ó (0.5/3.5) = 71 EUR ‚Üí –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 75 EUR \"\"\" from core.models import LineTHSCoefficient if not container or not container.line or not container.ths: return {} total_ths = Decimal(str(container.ths)) if total_ths <= 0: return {} # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ cars = list(container.container_cars.all()) if not cars: return {} # –ü–æ–ª—É—á–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è —Ç–∏–ø–æ–≤ –¢–° —ç—Ç–æ–π –ª–∏–Ω–∏–∏ ths_coefficients = { tc.vehicle_type: Decimal(str(tc.coefficient)) for tc in LineTHSCoefficient.objects.filter(line=container.line) } # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω total_coefficient = Decimal('0.00') car_coefficients = {} for car in cars: # –ü–æ–ª—É—á–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è —Ç–∏–ø–∞ –¢–°, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1.0 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π) coeff = ths_coefficients.get(car.vehicle_type, Decimal('1.00')) car", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "fficient = Decimal('0.00') car_coefficients = {} for car in cars: # –ü–æ–ª—É—á–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è —Ç–∏–ø–∞ –¢–°, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1.0 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π) coeff = ths_coefficients.get(car.vehicle_type, Decimal('1.00')) car_coefficients[car.id] = coeff total_coefficient += coeff # –§—É–Ω–∫—Ü–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É —Å —à–∞–≥–æ–º 5 EUR def round_up_to_5(value): \"\"\"–û–∫—Ä—É–≥–ª—è–µ—Ç –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É —Å —à–∞–≥–æ–º 5 EUR. –ü—Ä–∏–º–µ—Ä: 73.12 -> 75\"\"\" import math return Decimal(str(math.ceil(float(value) / 5) * 5)) # –ï—Å–ª–∏ —Å—É–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ = 0, –¥–µ–ª–∏–º –ø–æ—Ä–æ–≤–Ω—É if total_coefficient == 0: equal_share = total_ths / len(cars) return {car.id: round_up_to_5(equal_share) for car in cars} # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É result = {} for car in cars: car_share = car_coefficients[car.id] / total_coefficient car_ths = total_ths * car_share # –û–∫—Ä—É–≥–ª—è–µ–º –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É —Å —à–∞–≥–æ–º 5 EUR result[car.id] = round_up_to_5(car_ths) logger.info(f\"THS distribution for container {container.number}: total={total_ths}, coefficients={car_coefficients}, result={result}\") return result def create_ths_services_for_container(container): \"\"\" –°–æ–∑–¥–∞–µ—Ç —É—Å–ª—É–≥–∏ THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "={car_coefficients}, result={result}\") return result def create_ths_services_for_container(container): \"\"\" –°–æ–∑–¥–∞–µ—Ç —É—Å–ª—É–≥–∏ THS –¥–ª—è –≤—Å–µ—Ö –¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —É—Å–ª—É–≥–∏ (LINE –∏–ª–∏ WAREHOUSE) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–ª–µ–º container.ths_payer. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥. \"\"\" if not container or not container.line: return 0 # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º THS –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–° ths_distribution = calculate_ths_for_container(container) if not ths_distribution: return 0 # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å–ª—É–≥–∏ (LINE –∏–ª–∏ WAREHOUSE) service_type = container.ths_payer if hasattr(container, 'ths_payer') else 'LINE' # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —É—Å–ª—É–≥—É THS –¥–ª—è –ª–∏–Ω–∏–∏ # –ò—â–µ–º —É—Å–ª—É–≥—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º \"THS\" –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—É—é —É—Å–ª—É–≥—É line_service = None if service_type == 'LINE': line_service = LineService.objects.filter( line=container.line, is_active=True, name__icontains='THS' ).first() if not line_service: # –°–æ–∑–¥–∞–µ–º —É—Å–ª—É–≥—É THS –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç line_service, created = LineService.objects.get_or_create( line=container.line, name=f\"THS {container.line.name}\", defaults={ 'description': '–£—Å–ª—É–≥–∞ THS (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', 'default_price': 0, 'is_active': True } ) warehouse_service = None if servic", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "container.line, name=f\"THS {container.line.name}\", defaults={ 'description': '–£—Å–ª—É–≥–∞ THS (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', 'default_price': 0, 'is_active': True } ) warehouse_service = None if service_type == 'WAREHOUSE' and container.warehouse: warehouse_service = WarehouseService.objects.filter( warehouse=container.warehouse, is_active=True, name__icontains='THS' ).first() if not warehouse_service: # –°–æ–∑–¥–∞–µ–º —É—Å–ª—É–≥—É THS –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç warehouse_service, created = WarehouseService.objects.get_or_create( warehouse=container.warehouse, name=f\"THS {container.warehouse.name}\", defaults={ 'description': '–£—Å–ª—É–≥–∞ THS (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', 'default_price': 0, 'is_active': True, 'add_by_default': False } ) created_count = 0 for car_id, ths_amount in ths_distribution.items(): try: car = Car.objects.get(id=car_id) # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É—Å–ª—É–≥–∏ THS –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ # –£–¥–∞–ª—è–µ–º –æ—Ç –ª–∏–Ω–∏–∏ CarService.objects.filter( car=car, service_type='LINE' ).filter( service_id__in=LineService.objects.filter( name__icontains='THS' ).values_list('id', flat=True) ).delete() # –£–¥–∞–ª—è–µ–º –æ—Ç —Å–∫–ª–∞–¥–∞ CarService.objects.filter( car=car, service_type='WAREHOUSE' ).filter( service_id__in=WarehouseService.objects.filter( ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "e__icontains='THS' ).values_list('id', flat=True) ).delete() # –£–¥–∞–ª—è–µ–º –æ—Ç —Å–∫–ª–∞–¥–∞ CarService.objects.filter( car=car, service_type='WAREHOUSE' ).filter( service_id__in=WarehouseService.objects.filter( name__icontains='THS' ).values_list('id', flat=True) ).delete() # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —É—Å–ª—É–≥—É THS if service_type == 'LINE' and line_service: CarService.objects.create( car=car, service_type='LINE', service_id=line_service.id, custom_price=ths_amount, quantity=1, notes=f\"THS —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –¢–∏–ø –¢–°: {car.get_vehicle_type_display()}\" ) logger.info(f\"üö¢ THS {ths_amount} EUR –¥–ª—è {car.vin} (—Ç–∏–ø: {car.get_vehicle_type_display()}) –æ—Ç –ª–∏–Ω–∏–∏\") created_count += 1 elif service_type == 'WAREHOUSE' and warehouse_service: CarService.objects.create( car=car, service_type='WAREHOUSE', service_id=warehouse_service.id, custom_price=ths_amount, quantity=1, notes=f\"THS —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –¢–∏–ø –¢–°: {car.get_vehicle_type_display()}\" ) logger.info(f\"üè≠ THS {ths_amount} EUR –¥–ª—è {car.vin} (—Ç–∏–ø: {car.get_vehicle_type_display()}) –æ—Ç —Å–∫–ª–∞–¥–∞\") created_count += 1 except Car.DoesNotExist: logger.warning(f\"Car {car_id} not found when creating THS service\") except Exception as e: logger.error(f\"Error creating ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "hicle_type_display()}) –æ—Ç —Å–∫–ª–∞–¥–∞\") created_count += 1 except Car.DoesNotExist: logger.warning(f\"Car {car_id} not found when creating THS service\") except Exception as e: logger.error(f\"Error creating THS service for car {car_id}: {e}\") return created_count def find_warehouse_services_for_car(warehouse): \"\"\" –ù–∞—Ö–æ–¥–∏—Ç —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —Å —Ñ–ª–∞–≥–æ–º add_by_default=True. \"\"\" if not warehouse: return [] # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —Å —Ñ–ª–∞–≥–æ–º add_by_default=True return list(WarehouseService.objects.filter( warehouse=warehouse, is_active=True, add_by_default=True )) def find_line_services_for_car(line): \"\"\" –ù–∞—Ö–æ–¥–∏—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. THS-—É—Å–ª—É–≥–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è (THS —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ). \"\"\" if not line: return [] return list(LineService.objects.filter( line=line, is_active=True, add_by_default=True ).exclude(name__icontains='THS')) def find_carrier_services_for_car(carrier): \"\"\" –ù–∞—Ö–æ–¥–∏—Ç —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. \"\"\" if not carrier: return [] return list(CarrierService.objects.filter( carrier=carrier, is_active=True, add_by_", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "\"\" –ù–∞—Ö–æ–¥–∏—Ç —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. \"\"\" if not carrier: return [] return list(CarrierService.objects.filter( carrier=carrier, is_active=True, add_by_default=True )) def get_main_company(): \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é (Caromoto Lithuania), –µ—Å–ª–∏ –µ—Å—Ç—å.\"\"\" return Company.objects.filter(name=\"Caromoto Lithuania\").first() def find_company_services_for_car(company): \"\"\" –ù–∞—Ö–æ–¥–∏—Ç —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. \"\"\" if not company: return [] return list(CompanyService.objects.filter( company=company, is_active=True, add_by_default=True )) @receiver(post_save, sender=Car) def create_car_services_on_car_save(sender, instance, **kwargs): \"\"\" –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ CarService –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏. –£–º–Ω—ã–π –≤—ã–±–æ—Ä —É—Å–ª—É–≥: - –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π: –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞–≤—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (THS MAERSK 3 –ê–í–¢–û) - –î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤: –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —É—Å–ª—É–≥–∞ —Å MOTO (THS CMA MOTO) - –£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤: –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è \"–†–∞–∑–≥—Ä—É–∑–∫–∞/–ü–æ–≥—Ä—É–∑–∫–∞/–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è\" –∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" \"\"\" if not instance.pk: return # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–µ–º —É—Å–ª—É–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ if getattr(instance, '_creating_services', False): return # –ü—Ä–æ–≤", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "–≥—Ä—É–∑–∫–∞/–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è\" –∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" \"\"\" if not instance.pk: return # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–µ–º —É—Å–ª—É–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ if getattr(instance, '_creating_services', False): return # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ —Å–º–µ–Ω–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤) created = kwargs.get('created', False) if not created: # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã old_contractors = _old_contractors.get(instance.pk, {}) if old_contractors: warehouse_changed = old_contractors.get('warehouse_id') != instance.warehouse_id line_changed = old_contractors.get('line_id') != instance.line_id carrier_changed = old_contractors.get('carrier_id') != instance.carrier_id # –ï—Å–ª–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —É—Å–ª—É–≥–∏ if not (warehouse_changed or line_changed or carrier_changed): # –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è _old_contractors.pop(instance.pk, None) return else: # –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π - –∑–Ω–∞—á–∏—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –Ω–µ –º–µ–Ω—è–ª–∏—Å—å return # –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è _old_contractors.pop(instance.pk, None) # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ instance._creating_services = True try: # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥ deleted_warehouse_services = set( DeletedCar", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "ractors.pop(instance.pk, None) # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ instance._creating_services = True try: # –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥ deleted_warehouse_services = set( DeletedCarService.objects.filter(car=instance, service_type='WAREHOUSE').values_list('service_id', flat=True) ) deleted_line_services = set( DeletedCarService.objects.filter(car=instance, service_type='LINE').values_list('service_id', flat=True) ) deleted_carrier_services = set( DeletedCarService.objects.filter(car=instance, service_type='CARRIER').values_list('service_id', flat=True) ) deleted_company_services = set( DeletedCarService.objects.filter(car=instance, service_type='COMPANY').values_list('service_id', flat=True) ) # ========== –£–°–õ–£–ì–ò –°–ö–õ–ê–î–ê ========== # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ –µ—Å–ª–∏ —Å–∫–ª–∞–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è instance.car_services.filter(service_type='WAREHOUSE').delete() if instance.warehouse: # –ù–∞—Ö–æ–¥–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞ (–†–∞–∑–≥—Ä—É–∑–∫–∞/–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è –∏ –•—Ä–∞–Ω–µ–Ω–∏–µ) warehouse_services = find_warehouse_services_for_car(instance.warehouse) for service in warehouse_services: if service.id not in deleted_warehouse_services: # –î–ª—è —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Ü–µ–Ω–∞ –∏ –Ω–∞—Ü–µ–Ω–∫–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å # –ï—Å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "ouse_services_for_car(instance.warehouse) for service in warehouse_services: if service.id not in deleted_warehouse_services: # –î–ª—è —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Ü–µ–Ω–∞ –∏ –Ω–∞—Ü–µ–Ω–∫–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å # –ï—Å–ª–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π –Ω–µ—Ç - —Ü–µ–Ω–∞ = 0 if service.name == '–•—Ä–∞–Ω–µ–Ω–∏–µ': days = Decimal(str(instance.days or 0)) custom_price = days * Decimal(str(service.default_price or 0)) # –ù–∞—Ü–µ–Ω–∫–∞ —Ç–æ–∂–µ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ –¥–Ω–∏ default_markup = days * Decimal(str(getattr(service, 'default_markup', 0) or 0)) else: custom_price = service.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup', None) or Decimal('0') CarService.objects.get_or_create( car=instance, service_type='WAREHOUSE', service_id=service.id, defaults={'custom_price': custom_price, 'markup_amount': default_markup} ) logger.info(f\"üè≠ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞ '{service.name}' –¥–ª—è {instance.vin} (—Ü–µ–Ω–∞: {custom_price}, –Ω–∞—Ü–µ–Ω–∫–∞: {default_markup})\") # ========== –£–°–õ–£–ì–ò –õ–ò–ù–ò–ò ========== # THS —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ create_ths_services_for_container() # –ó–¥–µ—Å—å –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —Å add_by_default=True (–∫—Ä–æ–º–µ THS) instance.car_services.filter( service_type='LINE' ).exclude( service_id__in=LineService.objects.fi", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "create_ths_services_for_container() # –ó–¥–µ—Å—å –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏ —Å add_by_default=True (–∫—Ä–æ–º–µ THS) instance.car_services.filter( service_type='LINE' ).exclude( service_id__in=LineService.objects.filter(name__icontains='THS').values_list('id', flat=True) ).delete() if instance.line: line_services = find_line_services_for_car(instance.line) for service in line_services: if service.id not in deleted_line_services: default_markup = getattr(service, 'default_markup', None) or Decimal('0') CarService.objects.get_or_create( car=instance, service_type='LINE', service_id=service.id, defaults={'custom_price': service.default_price, 'markup_amount': default_markup} ) logger.info(f\"üö¢ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏ '{service.name}' –¥–ª—è {instance.vin} (—Ü–µ–Ω–∞: {service.default_price}, –Ω–∞—Ü–µ–Ω–∫–∞: {default_markup})\") # ========== –£–°–õ–£–ì–ò –ü–ï–†–ï–í–û–ó–ß–ò–ö–ê ========== # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è instance.car_services.filter(service_type='CARRIER').delete() if instance.carrier: carrier_services = find_carrier_services_for_car(instance.carrier) for service in carrier_services: if service.id not in deleted_carrier_services: # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "services = find_carrier_services_for_car(instance.carrier) for service in carrier_services: if service.id not in deleted_carrier_services: # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(service, 'default_markup', None) or Decimal('0') CarService.objects.get_or_create( car=instance, service_type='CARRIER', service_id=service.id, defaults={'custom_price': service.default_price, 'markup_amount': default_markup} ) # ========== –£–°–õ–£–ì–ò –ö–û–ú–ü–ê–ù–ò–ò ========== # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∞–≤—Ç–æ –∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ if created: main_company = get_main_company() if main_company: company_services = find_company_services_for_car(main_company) for service in company_services: if service.id in deleted_company_services: continue default_markup = getattr(service, 'default_markup', None) or Decimal('0') CarService.objects.get_or_create( car=instance, service_type='COMPANY', service_id=service.id, defaults={'custom_price': service.default_price, 'markup_amount': default_markup} ) except Exception as e: logger.error(f\"Error creating car services: {e}\") finally: # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ instance._creating_services = False @receiver(post_save, sender=WarehouseService) def", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "pt Exception as e: logger.error(f\"Error creating car services: {e}\") finally: # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ instance._creating_services = False @receiver(post_save, sender=WarehouseService) def update_cars_on_warehouse_service_change(sender, instance, **kwargs): \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ CarService –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞\"\"\" try: # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —Å —ç—Ç–∏–º —Å–∫–ª–∞–¥–æ–º cars = Car.objects.filter(warehouse=instance.warehouse) for car in cars: car_service = CarService.objects.filter( car=car, service_type='WAREHOUSE', service_id=instance.id ).first() if instance.is_active and instance.default_price > 0: if not car_service: # –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–≤—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ continue # –î–ª—è —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" —Ü–µ–Ω–∞ –∏ –Ω–∞—Ü–µ–Ω–∫–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å if instance.name == '–•—Ä–∞–Ω–µ–Ω–∏–µ': days = Decimal(str(car.days or 0)) custom_price = days * Decimal(str(instance.default_price or 0)) default_markup = days * Decimal(str(getattr(instance, 'default_markup', 0) or 0)) else: custom_price = instance.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(instance, 'default_markup', None) or Decimal('0') # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å CarService car_service.custom_pri", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": " instance.default_price # –ü–æ–ª—É—á–∞–µ–º default_markup –∏–∑ —É—Å–ª—É–≥–∏ default_markup = getattr(instance, 'default_markup', None) or Decimal('0') # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å CarService car_service.custom_price = custom_price car_service.markup_amount = default_markup car_service.save(update_fields=['custom_price', 'markup_amount']) else: # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å CarService –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ —Ü–µ–Ω–∞ = 0 CarService.objects.filter( car=car, service_type='WAREHOUSE', service_id=instance.id ).delete() except Exception as e: logger.error(f\"Error updating cars on warehouse service change: {e}\") @receiver(post_save, sender=LineService) def update_cars_on_line_service_change(sender, instance, **kwargs): \"\"\" –û–¢–ö–õ–Æ–ß–ï–ù–û: –£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ (THS) —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —á–µ—Ä–µ–∑ create_ths_services_for_container() –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –≠—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª –±–æ–ª—å—à–µ –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º. \"\"\" # –¢–æ–ª—å–∫–æ —É–¥–∞–ª—è–µ–º —É—Å–ª—É–≥—É –µ—Å–ª–∏ –æ–Ω–∞ —Å—Ç–∞–ª–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π if not instance.is_active: try: deleted = CarService.objects.filter( service_type='LINE', service_id=instance.id ).delete() if deleted[0] > 0: logger.info(f\"Deleted {deleted[0]} LINE services for inactive LineService {instance.id}\") except ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "= CarService.objects.filter( service_type='LINE', service_id=instance.id ).delete() if deleted[0] > 0: logger.info(f\"Deleted {deleted[0]} LINE services for inactive LineService {instance.id}\") except Exception as e: logger.error(f\"Error deleting inactive line service: {e}\") @receiver(post_save, sender=CarrierService) def update_cars_on_carrier_service_change(sender, instance, **kwargs): \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ CarService –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\"\"\" try: # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —Å —ç—Ç–∏–º –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–º cars = Car.objects.filter(carrier=instance.carrier) for car in cars: car_service = CarService.objects.filter( car=car, service_type='CARRIER', service_id=instance.id ).first() if instance.is_active and instance.default_price > 0: if not car_service: # –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–≤—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ continue default_markup = getattr(instance, 'default_markup', None) or Decimal('0') car_service.custom_price = instance.default_price car_service.markup_amount = default_markup car_service.save(update_fields=['custom_price', 'markup_amount']) else: # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å CarService –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ —Ü–µ–Ω–∞ = 0 CarService.objects.filter( car=car, service_type='CARRIER', service_id=insta", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": ".save(update_fields=['custom_price', 'markup_amount']) else: # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å CarService –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ —Ü–µ–Ω–∞ = 0 CarService.objects.filter( car=car, service_type='CARRIER', service_id=instance.id ).delete() except Exception as e: logger.error(f\"Error updating cars on carrier service change: {e}\") @receiver(post_save, sender=CompanyService) def update_cars_on_company_service_change(sender, instance, **kwargs): \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ CarService –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏\"\"\" try: car_services = CarService.objects.filter( service_type='COMPANY', service_id=instance.id ) if instance.is_active and instance.default_price > 0: default_markup = getattr(instance, 'default_markup', None) or Decimal('0') car_services.update(custom_price=instance.default_price, markup_amount=default_markup) else: car_services.delete() except Exception as e: logger.error(f\"Error updating cars on company service change: {e}\") # ============================================================================ # –°–ò–ì–ù–ê–õ–´ –î–õ–Ø –ü–ï–†–ï–°–ß–ï–¢–ê –ò–ù–í–û–ô–°–û–í –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò –£–°–õ–£–ì –ê–í–¢–û–ú–û–ë–ò–õ–Ø # ============================================================================ @receiver(post_save, sender=CarService) def recalculate_invo", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "–ò–ì–ù–ê–õ–´ –î–õ–Ø –ü–ï–†–ï–°–ß–ï–¢–ê –ò–ù–í–û–ô–°–û–í –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò –£–°–õ–£–ì –ê–í–¢–û–ú–û–ë–ò–õ–Ø # ============================================================================ @receiver(post_save, sender=CarService) def recalculate_invoices_on_car_service_save(sender, instance, **kwargs): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" try: car = instance.car if not car: return # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏–Ω–≤–æ–π—Å—ã —Å —ç—Ç–∏–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–∫—Ä–æ–º–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö) invoices = NewInvoice.objects.filter( cars=car, status__in=['DRAFT', 'ISSUED', 'PARTIALLY_PAID', 'OVERDUE'] ) for invoice in invoices: logger.info(f\"üîÑ –ü–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–≤–æ–π—Å–∞ {invoice.number} –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ {car.vin}\") invoice.regenerate_items_from_cars() except Exception as e: logger.error(f\"Error recalculating invoices on CarService save: {e}\") @receiver(post_delete, sender=CarService) def recalculate_invoices_on_car_service_delete(sender, instance, **kwargs): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–≤–æ–π—Å—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" try: car = instance.car if not car: return # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏–Ω–≤–æ–π—Å—ã —Å —ç—Ç–∏–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–∫—Ä–æ–º–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö) invoices = NewInvoice.objects.filter( cars=car, status__in=['DRAFT', 'ISSUED', 'PARTIALLY_PAID', 'OVERDUE'] ) for invoice ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "turn # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏–Ω–≤–æ–π—Å—ã —Å —ç—Ç–∏–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–∫—Ä–æ–º–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö) invoices = NewInvoice.objects.filter( cars=car, status__in=['DRAFT', 'ISSUED', 'PARTIALLY_PAID', 'OVERDUE'] ) for invoice in invoices: logger.info(f\"üîÑ –ü–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–≤–æ–π—Å–∞ {invoice.number} –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ {car.vin}\") invoice.regenerate_items_from_cars() except Exception as e: logger.error(f\"Error recalculating invoices on CarService delete: {e}\") # ============================================================================ # –ö–ê–°–ö–ê–î–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï CarService –ü–†–ò –£–î–ê–õ–ï–ù–ò–ò –£–°–õ–£–ì –ò–ó –°–ü–†–ê–í–û–ß–ù–ò–ö–û–í # ============================================================================ @receiver(pre_delete, sender=LineService) def delete_car_services_on_line_service_delete(sender, instance, **kwargs): \"\"\" –£–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ '–±–∏—Ç—ã—Ö' –∑–∞–ø–∏—Å–µ–π —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ service_id. \"\"\" try: deleted_count = CarService.objects.filter( service_type='LINE', service_id=instance.id ).delete()[0] if deleted_count > 0: logger.info(f\"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {deleted_count} CarService –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ LineService '{instance.name}' (id={instance.id})\") except Exception as e: log", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "d=instance.id ).delete()[0] if deleted_count > 0: logger.info(f\"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {deleted_count} CarService –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ LineService '{instance.name}' (id={instance.id})\") except Exception as e: logger.error(f\"Error deleting CarService on LineService delete: {e}\") @receiver(pre_delete, sender=WarehouseService) def delete_car_services_on_warehouse_service_delete(sender, instance, **kwargs): \"\"\" –£–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ '–±–∏—Ç—ã—Ö' –∑–∞–ø–∏—Å–µ–π —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ service_id. \"\"\" try: deleted_count = CarService.objects.filter( service_type='WAREHOUSE', service_id=instance.id ).delete()[0] if deleted_count > 0: logger.info(f\"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {deleted_count} CarService –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ WarehouseService '{instance.name}' (id={instance.id})\") except Exception as e: logger.error(f\"Error deleting CarService on WarehouseService delete: {e}\") @receiver(pre_delete, sender=CarrierService) def delete_car_services_on_carrier_service_delete(sender, instance, **kwargs): \"\"\" –£–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ '–±–∏—Ç—ã—Ö' –∑–∞–ø–∏—Å–µ–π —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ service_id. \"\"\" try: deleted_count = Car", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "er, instance, **kwargs): \"\"\" –£–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ '–±–∏—Ç—ã—Ö' –∑–∞–ø–∏—Å–µ–π —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ service_id. \"\"\" try: deleted_count = CarService.objects.filter( service_type='CARRIER', service_id=instance.id ).delete()[0] if deleted_count > 0: logger.info(f\"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {deleted_count} CarService –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ CarrierService '{instance.name}' (id={instance.id})\") except Exception as e: logger.error(f\"Error deleting CarService on CarrierService delete: {e}\") @receiver(pre_delete, sender=CompanyService) def delete_car_services_on_company_service_delete(sender, instance, **kwargs): \"\"\" –£–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ CarService –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏. \"\"\" try: deleted_count = CarService.objects.filter( service_type='COMPANY', service_id=instance.id ).delete()[0] if deleted_count > 0: logger.info(f\"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {deleted_count} CarService –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ CompanyService '{instance.name}' (id={instance.id})\") except Exception as e: logger.error(f\"Error deleting CarService on CompanyService delete: {e}\") # ============================================================================ # –°–ò–ì–ù–ê–õ–´ –î–õ–Ø EMAIL-–£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ö–õ–ò–ï–ù–¢–û", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "on as e: logger.error(f\"Error deleting CarService on CompanyService delete: {e}\") # ============================================================================ # –°–ò–ì–ù–ê–õ–´ –î–õ–Ø EMAIL-–£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ö–õ–ò–ï–ù–¢–û–í # ============================================================================ # –•—Ä–∞–Ω–∏–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π _old_notification_values = {} @receiver(pre_save, sender=Container) def save_old_notification_values(sender, instance, **kwargs): \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è planned_unload_date –∏ unload_date –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º\"\"\" if instance.pk: try: old = Container.objects.filter(pk=instance.pk).values('planned_unload_date', 'unload_date').first() if old: _old_notification_values[instance.pk] = { 'planned_unload_date': old.get('planned_unload_date'), 'unload_date': old.get('unload_date') } except Exception: pass @receiver(post_save, sender=Container) def send_container_notifications_on_save(sender, instance, created, **kwargs): \"\"\" –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º: - –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ planned_unload_date -> —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ - –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ unload_date -> —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ \"\"\" if not instance.pk: return # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "–∞–º: - –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ planned_unload_date -> —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ - –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ unload_date -> —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ \"\"\" if not instance.pk: return # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è old_values = _old_notification_values.pop(instance.pk, {}) old_planned_unload_date = old_values.get('planned_unload_date') old_unload_date = old_values.get('unload_date') # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ should_notify_planned = False if instance.planned_unload_date: if created: should_notify_planned = True elif old_planned_unload_date is None: # –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–ø–µ—Ä–≤—ã–µ should_notify_planned = True # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–≥—Ä—É–∑–∫–µ should_notify_unload = False if instance.unload_date: if created: should_notify_unload = True elif old_unload_date is None: # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–ø–µ—Ä–≤—ã–µ should_notify_unload = True # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ if should_notify_planned: def send_planned_notifications(): try: from core.services.email_service import ContainerNotificationService if not ContainerNotificationService.was_planned_notification_sent(instance): ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": "otify_planned: def send_planned_notifications(): try: from core.services.email_service import ContainerNotificationService if not ContainerNotificationService.was_planned_notification_sent(instance): sent, failed = ContainerNotificationService.send_planned_to_all_clients(instance) if sent > 0: logger.info(f\"üìß Auto-sent planned unload notifications for {instance.number}: {sent} sent, {failed} failed\") else: logger.debug(f\"Planned unload notifications already sent for {instance.number}\") except Exception as e: logger.error(f\"Failed to send planned unload notifications for {instance.number}: {e}\") transaction.on_commit(send_planned_notifications) if should_notify_unload: def send_unload_notifications(): try: from core.services.email_service import ContainerNotificationService if not ContainerNotificationService.was_unload_notification_sent(instance): sent, failed = ContainerNotificationService.send_unload_to_all_clients(instance) if sent > 0: logger.info(f\"üìß Auto-sent unload notifications for {instance.number}: {sent} sent, {failed} failed\") else: logger.debug(f\"Unload notifications already sent for {instance.number}\") except Exception as e: logger.error(f\"Failed to send unload notifi", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\signals.py", "content": " for {instance.number}: {sent} sent, {failed} failed\") else: logger.debug(f\"Unload notifications already sent for {instance.number}\") except Exception as e: logger.error(f\"Failed to send unload notifications for {instance.number}: {e}\") transaction.on_commit(send_unload_notifications) # –°–∏–≥–Ω–∞–ª –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å Google Drive @receiver(post_save, sender=Container) def auto_sync_photos_on_container_change(sender, instance, created, **kwargs): \"\"\" –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π cron. –õ–æ–≥–∏–∫–∞: —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ \"–†–∞–∑–≥—Ä—É–∂–µ–Ω\" –∏ –∑–∞—Ç–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å. \"\"\" if not instance.pk: return if instance.status == 'UNLOADED': logger.info( f\"üì∏ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {instance.number}: —Å—Ç–∞—Ç—É—Å UNLOADED. \" \"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ –∫—Ä–æ–Ω—É (—á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –∏ –¥–∞–ª–µ–µ –∫–∞–∂–¥—ã–π —á–∞—Å).\" )", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "from django.http import HttpResponse, JsonResponse import re from django.views.decorators.http import require_GET from django.utils import timezone from django.template.loader import render_to_string from django.contrib.auth.decorators import login_required from django.db.models import Q, Sum from datetime import timedelta, datetime from typing import Optional from .models import Car, Container, Client, Warehouse, Line, Company, Carrier, CarService, WarehouseService, LineService, CarrierService, CompanyService from .models_billing import NewInvoice as Invoice, Transaction as Payment from .services.comparison_service import ComparisonService from .pagination import paginate_queryset, paginated_json_response, PaginationHelper from .cache_utils import cache_company_stats, cache_client_stats, cache_warehouse_stats, cache_comparison_data from decimal import Decimal import logging from django.shortcuts import render, get_object_or_404 from django.contrib.admin.views.decorators import staff_member_required from django.utils import timezone from django.views.decorators.csrf import csrf_exempt from django.apps import apps logger = logging.getLogger('django') def car_list_api(request): \"\"\"–í–æ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ember_required from django.utils import timezone from django.views.decorators.csrf import csrf_exempt from django.apps import apps logger = logging.getLogger('django') def car_list_api(request): \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ —Å—Ç–∞—Ç—É—Å—É.\"\"\" raw_client = (request.GET.get('client_id') or request.GET.get('client') or '').strip() # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º client_id: –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã m = re.search(r\"\\d+\", raw_client) raw_client = m.group(0) if m else '' search_query: str = request.GET.get('search', '').strip().lower() logger.info(f\"car_list_api called with GET: {request.GET}\") logger.info(f\"Extracted client: '{raw_client}', search: '{search_query}'\") try: client_id_int = int(raw_client) except (TypeError, ValueError): client_id_int = None if client_id_int: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å prefetch allowed_statuses = ['UNLOADED', 'IN_PORT', 'FLOATING', 'TRANSFERRED'] all_cars = Car.objects.by_client(client_id_int).filter( status__in=allowed_statuses ).select_related('client', 'warehouse', 'container', 'line', 'carrier') logger.info(f\"All cars for client {client_id_int}: {all_cars.count()}\") if all_cars.exists(): for car in all_cars: logger.debug(f\"Car {car.pk", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ted('client', 'warehouse', 'container', 'line', 'carrier') logger.info(f\"All cars for client {client_id_int}: {all_cars.count()}\") if all_cars.exists(): for car in all_cars: logger.debug(f\"Car {car.pk}: VIN={car.vin}, Brand={car.brand}, Year={car.year}, Status={car.status}, Transfer Date={car.transfer_date}\") else: logger.warning(f\"No cars found for client {client_id_int}\") if search_query: year_q = Q() if search_query.isdigit(): try: year_q = Q(year=int(search_query)) except Exception: year_q = Q() all_cars = all_cars.filter( Q(vin__icontains=search_query) | Q(brand__icontains=search_query) | year_q ) logger.info(f\"Filtered cars with search '{search_query}': {all_cars.count()}\") if all_cars.exists(): for car in all_cars: logger.debug(f\"Filtered car: {car.pk} - VIN: {car.vin}, Brand: {car.brand}, Year: {car.year}, Status: {car.status}, Transfer Date={car.transfer_date}\") html = render_to_string('admin/car_options.html', context={'cars': all_cars}, request=request) logger.debug(f\"Returning HTML: {html[:100]}...\") return HttpResponse(html, content_type='text/html') logger.warning(\"Invalid or missing client id, returning no client selected\") return HttpResponse('<option class=\"no-resu", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ing HTML: {html[:100]}...\") return HttpResponse(html, content_type='text/html') logger.warning(\"Invalid or missing client id, returning no client selected\") return HttpResponse('<option class=\"no-results\">–ö–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</option>', content_type='text/html') @require_GET def get_invoice_total(request): \"\"\"–í—ã—á–∏—Å–ª—è–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\"\"\" car_ids = request.GET.get('car_ids', '').split(',') car_ids = [int(cid) for cid in car_ids if cid.strip().isdigit()] logger.info(f\"get_invoice_total called with car_ids: {car_ids}\") result = {'total_amount': '0.00'} if not car_ids: logger.warning(\"No valid car IDs provided, returning 0.00\") return JsonResponse(result) try: cars = Car.objects.filter(id__in=car_ids).select_related( 'client', 'warehouse', 'container', 'line', 'carrier' ) if not cars.exists(): logger.warning(f\"No cars found for IDs: {car_ids}\") result['error'] = 'No cars found for the provided IDs' return JsonResponse(result) logger.info(f\"Cars found: {list(cars)}\") for car in cars: logger.debug(f\"Car {car.pk}: total_price={car.total_price}, storage_cost={car.storage_cost}\") except Exception as e: logger.error(f\"Error querying cars: {e}\") result['error'] = f\"Error qu", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "car in cars: logger.debug(f\"Car {car.pk}: total_price={car.total_price}, storage_cost={car.storage_cost}\") except Exception as e: logger.error(f\"Error querying cars: {e}\") result['error'] = f\"Error querying cars: {e}\" return JsonResponse(result, status=500) try: total = Decimal('0.00') for car in cars: current_price, total_price = car.calculate_total_price() add = total_price if (total_price and total_price > 0) else (current_price or Decimal('0.00')) total += Decimal(str(add)) result['total_amount'] = str(total) logger.info(f\"Calculated total_amount (in-memory): {result['total_amount']}\") return JsonResponse(result) except Exception as e: logger.error(f\"Error calculating total in-memory: {e}\") result['error'] = str(e) return JsonResponse(result, status=500) @require_GET def get_container_data(request, container_id: int): \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ ID.\"\"\" logger.info(f\"get_container_data called with container_id: {container_id}\") try: container = Container.objects.get(id=container_id) container.refresh_from_db() data = { 'free_days': container.free_days, 'storage_cost': str(container.storage_cost), 'status': container.status, } logger.info(f\"get_container_data: ID={containe", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ner_id) container.refresh_from_db() data = { 'free_days': container.free_days, 'storage_cost': str(container.storage_cost), 'status': container.status, } logger.info(f\"get_container_data: ID={container_id}, free_days={container.free_days}, storage_cost={container.storage_cost}\") return JsonResponse(data) except Container.DoesNotExist: logger.error(f\"Container not found: ID={container_id}\") return JsonResponse({'error': 'Container not found'}, status=404) @require_GET def get_client_balance(request): \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ ID.\"\"\" client_id: Optional[str] = request.GET.get('client_id') logger.info(f\"get_client_balance called with client_id: {client_id}\") if client_id and client_id.isdigit(): try: from decimal import Decimal client = Client.objects.get(id=client_id) details = client.balance_details() # –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º: total_balance –∏ status real_balance = client.real_balance total_balance = real_balance # –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å status = '–ü–µ—Ä–µ–ø–ª–∞—Ç–∞' if total_balance < 0 else ('–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å' if total_balance > 0 else '–ù–æ–ª—å') response = { **details, 'total_balance': str(total_balance), 'status': status, } logger.info(f\"Client balance for {client", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "' if total_balance < 0 else ('–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å' if total_balance > 0 else '–ù–æ–ª—å') response = { **details, 'total_balance': str(total_balance), 'status': status, } logger.info(f\"Client balance for {client_id}: {response}\") return JsonResponse(response) except Client.DoesNotExist: logger.error(f\"Client not found: ID={client_id}\") return JsonResponse({'error': 'Client not found'}, status=404) logger.warning(\"Invalid client ID\") return JsonResponse({'error': 'Invalid client ID'}, status=400) @login_required def register_payment(request): \"\"\"–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–µ–∂ –¥–ª—è –∏–Ω–≤–æ–π—Å–∞.\"\"\" if request.method != 'POST': logger.warning(\"Invalid request method for register_payment\") return JsonResponse({'status': 'error', 'message': 'Invalid request method'}, status=400) invoice_id: Optional[str] = request.POST.get('invoice_id') amount: float = float(request.POST.get('amount', 0)) payment_type: Optional[str] = request.POST.get('payment_type') from_balance: bool = request.POST.get('from_balance') == 'on' from_cash_balance: bool = request.POST.get('from_cash_balance') == 'on' description: str = request.POST.get('description', '') payer_id: Optional[str] = request.POST.get('payer_id') recipient: str = request", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ash_balance: bool = request.POST.get('from_cash_balance') == 'on' description: str = request.POST.get('description', '') payer_id: Optional[str] = request.POST.get('payer_id') recipient: str = request.POST.get('recipient', '') logger.info(f\"Registering payment: invoice_id={invoice_id}, amount={amount}, payment_type={payment_type}, from_balance={from_balance}, from_cash_balance={from_cash_balance}, payer_id={payer_id}\") try: invoice = Invoice.objects.get(id=invoice_id) if invoice_id else None payer = Client.objects.get(id=payer_id) if payer_id else None if from_balance and not payer: logger.error(\"Payer required for balance payment\") return JsonResponse({'status': 'error', 'message': '–ü–ª–∞—Ç–µ–ª—å—â–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –æ–ø–ª–∞—Ç—ã —Å –±–∞–ª–∞–Ω—Å–∞'}, status=400) # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ —Å –±–∞–ª–∞–Ω—Å–∞ if from_balance and payer: if not payer.can_pay_from_balance(amount, payment_type, from_cash_balance): logger.error(f\"Insufficient funds for client {payer.name}: amount={amount}, from_cash_balance={from_cash_balance}\") return JsonResponse({'status': 'error', 'message': f\"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ {'–Ω–∞–ª–∏—á–Ω–æ–º' if from_cash_balance else '–±–µ–∑–Ω–∞–ª–∏—á–Ω–æ–º'} –±–∞–ª–∞–Ω—Å–µ\"}, status=400) payment = Payment( inv", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ce={from_cash_balance}\") return JsonResponse({'status': 'error', 'message': f\"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ {'–Ω–∞–ª–∏—á–Ω–æ–º' if from_cash_balance else '–±–µ–∑–Ω–∞–ª–∏—á–Ω–æ–º'} –±–∞–ª–∞–Ω—Å–µ\"}, status=400) payment = Payment( invoice=invoice, amount=amount, payment_type=payment_type, description=description, from_client=payer, to_client=recipient if hasattr(recipient, 'name') else None, to_warehouse=recipient if hasattr(recipient, 'name') and 'warehouse' in str(type(recipient)).lower() else None, to_line=recipient if hasattr(recipient, 'name') and 'line' in str(type(recipient)).lower() else None, to_company=recipient if hasattr(recipient, 'name') and 'company' in str(type(recipient)).lower() else None ) payment.save() logger.info(f\"Payment saved: id={payment.pk}, client_id={payer.pk if payer else 'N/A'}, cash_balance={payer.cash_balance if payer else 'N/A'}, card_balance={payer.card_balance if payer else 'N/A'}\") return JsonResponse({ 'status': 'success', 'message': f'–ü–ª–∞—Ç–µ–∂ –Ω–∞ —Å—É–º–º—É {amount} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'client_balance': str(payer.invoice_balance) if payer else None, 'cash_balance': str(payer.cash_balance) if payer else None, 'card_balance': str(payer.card_balance) if payer else None }) except (Invoice.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ient_balance': str(payer.invoice_balance) if payer else None, 'cash_balance': str(payer.cash_balance) if payer else None, 'card_balance': str(payer.card_balance) if payer else None }) except (Invoice.DoesNotExist, Client.DoesNotExist) as e: logger.error(f\"Error registering payment: {e}\") return JsonResponse({'status': 'error', 'message': str(e)}, status=404) except ValueError as e: logger.error(f\"Error registering payment: {e}\") return JsonResponse({'status': 'error', 'message': str(e)}, status=400) except Exception as e: logger.error(f\"Unexpected error registering payment: {e}\") return JsonResponse({'status': 'error', 'message': str(e)}, status=500) @staff_member_required def company_dashboard(request): \"\"\"–î–∞—à–±–æ—Ä–¥ –¥–ª—è Caromoto Lithuania —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º\"\"\" # –ü–æ–ª—É—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–ø–∞–Ω–∏–∏ stats = cache_company_stats() if not stats: # Fallback –∫ –ø—Ä—è–º–æ–º—É –∑–∞–ø—Ä–æ—Å—É –µ—Å–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω company = get_object_or_404(Company, name=\"Caromoto Lithuania\") # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü now = timezone.now() start_of_month = now.replace(day=1, hour=0, minute=0, second=0, microsecond=0) # –û–±—â–∏–π –±–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏ company_total_balance = company.invoice_balance + company.cash_balance + company.car", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "mezone.now() start_of_month = now.replace(day=1, hour=0, minute=0, second=0, microsecond=0) # –û–±—â–∏–π –±–∞–ª–∞–Ω—Å –∫–æ–º–ø–∞–Ω–∏–∏ company_total_balance = company.invoice_balance + company.cash_balance + company.card_balance # –ü—Ä–∏–±—ã–ª—å –∑–∞ –º–µ—Å—è—Ü (–≤—Ö–æ–¥—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏) monthly_income = Payment.objects.filter( to_company=company, date__gte=start_of_month ).aggregate(total=Sum('amount'))['total'] or 0 # –†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü (–∏—Å—Ö–æ–¥—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏) monthly_expenses = Payment.objects.filter( from_company=company, date__gte=start_of_month ).aggregate(total=Sum('amount'))['total'] or 0 # –ü—Ä–∏–±—ã–ª—å –∑–∞ –º–µ—Å—è—Ü monthly_profit = monthly_income - monthly_expenses # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤ (–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ) active_invoices_count = Invoice.objects.filter( paid=False ).count() # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20) recent_transactions = Payment.objects.filter( Q(from_company=company) | Q(to_company=company) ).order_by('-date')[:20] # –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã (–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ) active_invoices = Invoice.objects.filter( paid=False ).order_by('-issue_date')[:10] else: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ company_total_balance = stats['company']['total_balance'] monthly_profit = stats['monthly']['payment", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ce.objects.filter( paid=False ).order_by('-issue_date')[:10] else: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ company_total_balance = stats['company']['total_balance'] monthly_profit = stats['monthly']['payments']['total_amount'] - stats['monthly']['invoices']['total_amount'] monthly_expenses = stats['monthly']['invoices']['total_amount'] active_invoices_count = stats['monthly']['invoices']['count'] # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö company = get_object_or_404(Company, name=\"Caromoto Lithuania\") # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20) - –Ω–µ –∫—ç—à–∏—Ä—É–µ–º –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ recent_transactions = Payment.objects.filter( Q(from_company=company) | Q(to_company=company) ).order_by('-date')[:20] # –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã (–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ) - –Ω–µ –∫—ç—à–∏—Ä—É–µ–º –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ active_invoices = Invoice.objects.filter( paid=False ).order_by('-issue_date')[:10] # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–∏–º–∏—Ç–∞—Ü–∏—è) recent_activities = [ { 'icon': 'üí∞', 'title': '–ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω', 'description': f'–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å—É–º–º—É {monthly_income:.2f} ‚Ç¨', 'time': now }, { 'icon': 'üìÑ', 'title': '–ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω', 'description': f'–ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å #{active_invoices_count + 1}', 'time': now - timedelta(hours=2) }, { 'icon': 'üí≥', 'title': '–¢—Ä", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "hly_income:.2f} ‚Ç¨', 'time': now }, { 'icon': 'üìÑ', 'title': '–ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω', 'description': f'–ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å #{active_invoices_count + 1}', 'time': now - timedelta(hours=2) }, { 'icon': 'üí≥', 'title': '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞', 'description': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–æ–º–ø–∞–Ω–∏–∏', 'time': now - timedelta(hours=4) } ] context = { 'company': company, 'company_total_balance': company_total_balance, 'monthly_profit': monthly_profit, 'monthly_expenses': monthly_expenses, 'active_invoices_count': active_invoices_count, 'recent_transactions': recent_transactions, 'active_invoices': active_invoices, 'recent_activities': recent_activities, } return render(request, 'admin/company_dashboard.html', context) @staff_member_required def get_payment_objects(request): \"\"\"AJAX view –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –ø–ª–∞—Ç–µ–∂–∞\"\"\" object_type = request.GET.get('type') logger.info(f\"get_payment_objects called with type: {object_type}\") if not object_type: logger.warning(\"No type parameter provided\") return JsonResponse({'error': 'Type parameter is required'}, status=400) try: # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ —Ç–∏–ø—É logger.info(f\"Getting model for type: {object_type}\") model = apps.get_model('core', object_type.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "eturn JsonResponse({'error': 'Type parameter is required'}, status=400) try: # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ —Ç–∏–ø—É logger.info(f\"Getting model for type: {object_type}\") model = apps.get_model('core', object_type.title()) logger.info(f\"Model class: {model}\") # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –º–æ–¥–µ–ª–∏, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∏–º–µ–Ω–∏ objects = model.objects.all().order_by('name' if hasattr(model, 'name') else 'id') logger.info(f\"Found {objects.count()} objects\") # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è JSON objects_list = [] for obj in objects: display_name = getattr(obj, 'name', str(obj)) objects_list.append({ 'id': obj.id, 'name': display_name }) logger.info(f\"Returning {len(objects_list)} objects\") return JsonResponse({ 'type': object_type, 'objects': objects_list }) except Exception as e: logger.error(f\"Error getting objects for type {object_type}: {e}\") return JsonResponse({'error': str(e)}, status=500) @require_GET def search_partners_api(request): \"\"\"API –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ —Ç–∏–ø—É –∏ –Ω–∞–∑–≤–∞–Ω–∏—é\"\"\" entity_type = request.GET.get('entity_type', '').strip().upper() search_query = request.GET.get('search', '').strip() if not entity_type: response = JsonResponse({'error': 'Entity type is required'}, status=400) response['Co", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "T.get('entity_type', '').strip().upper() search_query = request.GET.get('search', '').strip() if not entity_type: response = JsonResponse({'error': 'Entity type is required'}, status=400) response['Content-Type'] = 'application/json' return response try: # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ model_map = { 'CLIENT': Client, 'WAREHOUSE': Warehouse, 'LINE': Line, 'CARRIER': Carrier, 'COMPANY': Company } if entity_type not in model_map: response = JsonResponse({'error': f'Invalid entity type: {entity_type}'}, status=400) response['Content-Type'] = 'application/json' return response model = model_map[entity_type] # –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é if search_query and len(search_query) >= 2: # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä name_filter = Q(name__icontains=search_query) # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ short_name, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –µ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç if hasattr(model, 'short_name'): name_filter |= Q(short_name__icontains=search_query) objects = model.objects.filter(name_filter).order_by('name' if hasattr(model, 'name') else 'id')[:10] else: # –ï—Å–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∏—á–µ–≥–æ objects = model.objects.none() # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è JSON objects_list = [] for obj in objects: display_name = ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "lse: # –ï—Å–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∏—á–µ–≥–æ objects = model.objects.none() # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è JSON objects_list = [] for obj in objects: display_name = getattr(obj, 'name', str(obj)) objects_list.append({ 'id': obj.id, 'name': display_name, 'type': entity_type }) response = JsonResponse({ 'type': entity_type, 'objects': objects_list }) response['Content-Type'] = 'application/json' return response except Exception as e: logger.error(f\"Error searching partners for type {entity_type}: {e}\") response = JsonResponse({'error': str(e)}, status=500) response['Content-Type'] = 'application/json' return response @require_GET def get_invoice_cars_api(request): \"\"\"API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º\"\"\" from_entity_type = request.GET.get('from_entity_type') from_entity_id = request.GET.get('from_entity_id') to_entity_type = request.GET.get('to_entity_type') to_entity_id = request.GET.get('to_entity_id') search_query = request.GET.get('search', '').strip() logger.info(f\"get_invoice_cars_api called with: from_entity_type={from_entity_type}, from_entity_id={from_entity_id}, to_entity_type={to_en", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ty_id') search_query = request.GET.get('search', '').strip() logger.info(f\"get_invoice_cars_api called with: from_entity_type={from_entity_type}, from_entity_id={from_entity_id}, to_entity_type={to_entity_type}, to_entity_id={to_entity_id}, search_query={search_query}\") # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) if not all([from_entity_type, from_entity_id]): logger.warning(f\"Missing from_entity parameters: from_entity_type={from_entity_type}, from_entity_id={from_entity_id}\") response = JsonResponse({'error': 'From entity parameters are required'}, status=400) response['Content-Type'] = 'application/json' return response try: # –ü–æ–ª—É—á–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤ six_months_ago = timezone.now().date() - timedelta(days=180) cars = Car.objects.none() # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º if from_entity_type == 'CLIENT': # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ cars = Car.objects.filter( Q(client_id=from_entity_id) & Q(status__in=['UNLOADED', 'IN_PORT', 'TRANSFERRED', 'FLOATING']) & Q(unload_date__gte=six_months_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') elif from_entity_type ==", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "& Q(status__in=['UNLOADED', 'IN_PORT', 'TRANSFERRED', 'FLOATING']) & Q(unload_date__gte=six_months_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') elif from_entity_type == 'WAREHOUSE': # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - —Å–∫–ª–∞–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ cars = Car.objects.filter( Q(warehouse_id=from_entity_id) & Q(status__in=['UNLOADED', 'IN_PORT', 'TRANSFERRED']) & Q(unload_date__gte=six_months_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') elif from_entity_type == 'LINE': # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –ª–∏–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–æ–π –ª–∏–Ω–∏–µ–π cars = Car.objects.filter( Q(line_id=from_entity_id) & Q(status__in=['UNLOADED', 'IN_PORT', 'TRANSFERRED']) & Q(unload_date__gte=six_months_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') elif from_entity_type == 'COMPANY': # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –∫–æ–º–ø–∞–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ cars = Car.objects.filter( Q(status__in=['UNLOADED', 'IN_PORT', 'TRANSFERRED']) & Q(unload_date__gte=six_months_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω if to_entity_type and to_entity_id: i", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": " Q(unload_date__gte=six_months_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω if to_entity_type and to_entity_id: if to_entity_type == 'WAREHOUSE': # –ï—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å - —Å–∫–ª–∞–¥, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ cars = cars.filter(warehouse_id=to_entity_id) elif to_entity_type == 'CLIENT': # –ï—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å - –∫–ª–∏–µ–Ω—Ç, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ cars = cars.filter(client_id=to_entity_id) # –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º if search_query: year_q = Q() if search_query.isdigit(): try: year_q = Q(year=int(search_query)) except Exception: year_q = Q() cars = cars.filter( Q(vin__icontains=search_query) | Q(brand__icontains=search_query) | year_q ) # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è cars_data = [] logger.info(f\"Found {cars.count()} cars for entity type {to_entity_type} with ID {to_entity_id}\") for car in cars: # –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è total_cost = car.total_price or car.current_price or Decimal('0.00') cars_data.append({ 'id': car.id, 'vin': car.vin, 'brand': car.brand, 'year': car.year, 'status': car.status, 'client_name': car.client.name if car.client else '–ù–µ —É–∫–∞–∑–∞–Ω', 'warehouse", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "r Decimal('0.00') cars_data.append({ 'id': car.id, 'vin': car.vin, 'brand': car.brand, 'year': car.year, 'status': car.status, 'client_name': car.client.name if car.client else '–ù–µ —É–∫–∞–∑–∞–Ω', 'warehouse_name': car.warehouse.name if car.warehouse else '–ù–µ —É–∫–∞–∑–∞–Ω', 'unload_date': car.unload_date.strftime('%d.%m.%Y') if car.unload_date else '–ù–µ —É–∫–∞–∑–∞–Ω–∞', 'transfer_date': car.transfer_date.strftime('%d.%m.%Y') if car.transfer_date else '–ù–µ —É–∫–∞–∑–∞–Ω–∞', 'total_cost': f\"{total_cost:.2f}\", # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥ 'storage_cost': float(car.storage_cost or 0), 'ocean_freight': float(car.ocean_freight or 0), 'ths': float(car.ths or 0), 'delivery_fee': float(car.delivery_fee or 0), 'transport_kz': float(car.transport_kz or 0) }) logger.info(f\"Returning {len(cars_data)} cars\") response = JsonResponse({'cars': cars_data}) response['Content-Type'] = 'application/json' return response except Exception as e: logger.error(f\"Error getting invoice cars: {e}\") response = JsonResponse({'error': str(e)}, status=500) response['Content-Type'] = 'application/json' return response @require_GET def get_warehouse_cars_api(request): \"\"\"API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è —Å–∫–ª–∞–¥–∞ (Caromot", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "or': str(e)}, status=500) response['Content-Type'] = 'application/json' return response @require_GET def get_warehouse_cars_api(request): \"\"\"API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è —Å–∫–ª–∞–¥–∞ (Caromoto Lithuania)\"\"\" warehouse_id = request.GET.get('warehouse_id') search_query = request.GET.get('search', '').strip() if not warehouse_id: response = JsonResponse({'error': 'Warehouse ID is required'}, status=400) response['Content-Type'] = 'application/json' return response try: # –ü–æ–ª—É—á–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–∫–ª–∞–¥–∞ month_ago = timezone.now().date() - timedelta(days=30) # –ò—â–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–∞–∑–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –Ω–∞ —Å–∫–ª–∞–¥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü cars = Car.objects.filter( Q(warehouse_id=warehouse_id) & Q(status__in=['UNLOADED', 'TRANSFERRED']) & Q(unload_date__gte=month_ago) ).select_related('client', 'warehouse', 'container', 'line', 'carrier') if search_query: year_q = Q() if search_query.isdigit(): try: year_q = Q(year=int(search_query)) except Exception: year_q = Q() cars = cars.filter( Q(vin__icontains=search_query) | Q(brand__icontains=search_query) | year_q ) # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è cars_data = [] for car in cars: # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–æ–∏", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "year_q = Q() cars = cars.filter( Q(vin__icontains=search_query) | Q(brand__icontains=search_query) | year_q ) # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è cars_data = [] for car in cars: # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–∫–ª–∞–¥—Å–∫–∏—Ö —É—Å–ª—É–≥ warehouse_services = ( (car.unload_fee or Decimal('0.00')) + (car.delivery_fee or Decimal('0.00')) + (car.loading_fee or Decimal('0.00')) + (car.docs_fee or Decimal('0.00')) + (car.transfer_fee or Decimal('0.00')) + (car.transit_declaration or Decimal('0.00')) + (car.export_declaration or Decimal('0.00')) + (car.extra_costs or Decimal('0.00')) + (car.complex_fee or Decimal('0.00')) + (car.storage_cost or Decimal('0.00')) ) cars_data.append({ 'id': car.id, 'vin': car.vin, 'brand': car.brand, 'year': car.year, 'status': car.status, 'client_name': car.client.name if car.client else '–ù–µ —É–∫–∞–∑–∞–Ω', 'unload_date': car.unload_date.strftime('%d.%m.%Y') if car.unload_date else '–ù–µ —É–∫–∞–∑–∞–Ω–∞', 'transfer_date': car.transfer_date.strftime('%d.%m.%Y') if car.transfer_date else '–ù–µ —É–∫–∞–∑–∞–Ω–∞', 'warehouse_services_cost': f\"{warehouse_services:.2f}\", 'storage_cost': f\"{car.storage_cost or 0:.2f}\", 'total_warehouse_cost': f\"{warehouse_services:.2f}\" }) response = JsonResponse({'cars': c", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "–∑–∞–Ω–∞', 'warehouse_services_cost': f\"{warehouse_services:.2f}\", 'storage_cost': f\"{car.storage_cost or 0:.2f}\", 'total_warehouse_cost': f\"{warehouse_services:.2f}\" }) response = JsonResponse({'cars': cars_data}) response['Content-Type'] = 'application/json' return response except Exception as e: logger.error(f\"Error getting warehouse cars: {e}\") response = JsonResponse({'error': str(e)}, status=500) response['Content-Type'] = 'application/json' return response @staff_member_required def comparison_dashboard(request): \"\"\"–î–∞—à–±–æ—Ä–¥ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—É–º–º –º–µ–∂–¥—É —Ä–∞—Å—á–µ—Ç–∞–º–∏ –∏ —Å—á–µ—Ç–∞–º–∏ —Å–∫–ª–∞–¥–∞\"\"\" # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ start_date = request.GET.get('start_date') end_date = request.GET.get('end_date') if start_date: start_date = datetime.strptime(start_date, '%Y-%m-%d').date() if end_date: end_date = datetime.strptime(end_date, '%Y-%m-%d').date() # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è comparison_service = ComparisonService() # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π –æ—Ç—á–µ—Ç report = comparison_service.get_comparison_report(start_date, end_date) # –ù–∞—Ö–æ–¥–∏–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è discrepancies = comparison_service.find_discrepancies(start_date, end_date) # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º clients = Client.objects.all() client_comparisons = [] ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "e, end_date) # –ù–∞—Ö–æ–¥–∏–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è discrepancies = comparison_service.find_discrepancies(start_date, end_date) # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º clients = Client.objects.all() client_comparisons = [] for client in clients: comparison = comparison_service.compare_client_costs_with_warehouse_invoices( client, start_date, end_date ) if comparison['status'] != 'no_data': client_comparisons.append(comparison) # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–∫–ª–∞–¥–∞–º warehouses = Warehouse.objects.all() warehouse_comparisons = [] for warehouse in warehouses: comparison = comparison_service.compare_warehouse_costs_with_payments( warehouse, start_date, end_date ) if comparison['status'] != 'no_data': warehouse_comparisons.append(comparison) context = { 'report': report, 'discrepancies': discrepancies, 'client_comparisons': client_comparisons, 'warehouse_comparisons': warehouse_comparisons, 'start_date': start_date, 'end_date': end_date, } return render(request, 'admin/comparison_dashboard.html', context) @require_GET def compare_car_costs_api(request): \"\"\"API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" car_id = request.GET.get('car_id') if not car_id: return JsonResponse({'error': 'Car ID is required'}, stat", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "def compare_car_costs_api(request): \"\"\"API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è\"\"\" car_id = request.GET.get('car_id') if not car_id: return JsonResponse({'error': 'Car ID is required'}, status=400) try: car = Car.objects.get(id=car_id) comparison_service = ComparisonService() result = comparison_service.compare_car_costs_with_warehouse_invoices(car) return JsonResponse(result) except Car.DoesNotExist: return JsonResponse({'error': 'Car not found'}, status=404) except Exception as e: return JsonResponse({'error': str(e)}, status=500) @require_GET def compare_client_costs_api(request): \"\"\"API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞\"\"\" client_id = request.GET.get('client_id') start_date = request.GET.get('start_date') end_date = request.GET.get('end_date') if not client_id: return JsonResponse({'error': 'Client ID is required'}, status=400) try: client = Client.objects.get(id=client_id) comparison_service = ComparisonService() if start_date: start_date = datetime.strptime(start_date, '%Y-%m-%d').date() if end_date: end_date = datetime.strptime(end_date, '%Y-%m-%d').date() result = comparison_service.compare_client_costs_with_warehouse_invoices( client, start_date, end_da", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "art_date, '%Y-%m-%d').date() if end_date: end_date = datetime.strptime(end_date, '%Y-%m-%d').date() result = comparison_service.compare_client_costs_with_warehouse_invoices( client, start_date, end_date ) return JsonResponse(result) except Client.DoesNotExist: return JsonResponse({'error': 'Client not found'}, status=404) except Exception as e: return JsonResponse({'error': str(e)}, status=500) @require_GET def compare_warehouse_costs_api(request): \"\"\"API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞\"\"\" warehouse_id = request.GET.get('warehouse_id') start_date = request.GET.get('start_date') end_date = request.GET.get('end_date') if not warehouse_id: return JsonResponse({'error': 'Warehouse ID is required'}, status=400) try: warehouse = Warehouse.objects.get(id=warehouse_id) comparison_service = ComparisonService() if start_date: start_date = datetime.strptime(start_date, '%Y-%m-%d').date() if end_date: end_date = datetime.strptime(end_date, '%Y-%m-%d').date() result = comparison_service.compare_warehouse_costs_with_payments( warehouse, start_date, end_date ) return JsonResponse(result) except Warehouse.DoesNotExist: return JsonResponse({'error': 'Warehouse not found'}, status=404) except E", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "e_warehouse_costs_with_payments( warehouse, start_date, end_date ) return JsonResponse(result) except Warehouse.DoesNotExist: return JsonResponse({'error': 'Warehouse not found'}, status=404) except Exception as e: return JsonResponse({'error': str(e)}, status=500) @require_GET def get_discrepancies_api(request): \"\"\"API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π\"\"\" start_date = request.GET.get('start_date') end_date = request.GET.get('end_date') try: comparison_service = ComparisonService() if start_date: start_date = datetime.strptime(start_date, '%Y-%m-%d').date() if end_date: end_date = datetime.strptime(end_date, '%Y-%m-%d').date() discrepancies = comparison_service.find_discrepancies(start_date, end_date) return JsonResponse({'discrepancies': discrepancies}) except Exception as e: return JsonResponse({'error': str(e)}, status=500) @staff_member_required @csrf_exempt def get_warehouses(request): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤\"\"\" try: warehouses = Warehouse.objects.all().order_by('name') warehouses_data = [{ 'id': warehouse.id, 'name': warehouse.name } for warehouse in warehouses] return JsonResponse({'warehouses': warehouses_data}) except Exception as e: logger.error(f\"Error loading w", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "arehouses_data = [{ 'id': warehouse.id, 'name': warehouse.name } for warehouse in warehouses] return JsonResponse({'warehouses': warehouses_data}) except Exception as e: logger.error(f\"Error loading warehouses: {e}\") return JsonResponse({'error': str(e)}, status=500) @staff_member_required @csrf_exempt def get_companies(request): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π\"\"\" try: companies = Company.objects.all().order_by('name') companies_data = [{ 'id': company.id, 'name': company.name } for company in companies] return JsonResponse({'companies': companies_data}) except Exception as e: logger.error(f\"Error loading companies: {e}\") return JsonResponse({'error': str(e)}, status=500) def get_available_services(request, car_id): \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é\"\"\" logger.info(f\"get_available_services called: car_id={car_id}, method={request.method}\") service_type = request.GET.get('type') logger.info(f\"get_available_services called: car_id={car_id}, service_type={service_type}\") if not service_type: logger.error(\"Service type is required\") return JsonResponse({'error': 'Service type is required'}, status=400) try: car = Car.objects.get(id=car_id) logger.info(f\"Found car", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "pe}\") if not service_type: logger.error(\"Service type is required\") return JsonResponse({'error': 'Service type is required'}, status=400) try: car = Car.objects.get(id=car_id) logger.info(f\"Found car: {car.vin}, warehouse={car.warehouse}, line={car.line}, carrier={car.carrier}\") services = [] if service_type == 'warehouse': # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–∫–ª–∞–¥ warehouse_id = request.GET.get('warehouse_id') if warehouse_id: warehouse = Warehouse.objects.get(id=warehouse_id) logger.info(f\"Processing warehouse services for selected warehouse: {warehouse}\") elif car.warehouse: warehouse = car.warehouse logger.info(f\"Processing warehouse services for car's warehouse: {warehouse}\") else: logger.info(\"No warehouse selected or assigned to car\") return JsonResponse({'services': []}) # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é existing_service_ids = CarService.objects.filter( car=car, service_type='WAREHOUSE' ).values_list('service_id', flat=True) logger.info(f\"Existing warehouse service IDs: {list(existing_service_ids)}\") available_services = WarehouseService.objects.filter( warehouse=warehouse ).exclude(id__in=existing_service_ids) logger.info(f\"Available warehouse", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "warehouse service IDs: {list(existing_service_ids)}\") available_services = WarehouseService.objects.filter( warehouse=warehouse ).exclude(id__in=existing_service_ids) logger.info(f\"Available warehouse services count: {available_services.count()}\") services = [{ 'id': service.id, 'name': service.name, 'price': float(service.default_price) } for service in available_services] elif service_type == 'line' and car.line: logger.info(f\"Processing line services for line: {car.line}\") # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é existing_service_ids = CarService.objects.filter( car=car, service_type='LINE' ).values_list('service_id', flat=True) logger.info(f\"Existing line service IDs: {list(existing_service_ids)}\") available_services = LineService.objects.filter( line=car.line ).exclude(id__in=existing_service_ids) logger.info(f\"Available line services count: {available_services.count()}\") services = [{ 'id': service.id, 'name': service.name, 'price': float(service.default_price) } for service in available_services] elif service_type == 'carrier' and car.carrier: logger.info(f\"Processing carrier services for carrier: {car.carrier}\") # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "ce) } for service in available_services] elif service_type == 'carrier' and car.carrier: logger.info(f\"Processing carrier services for carrier: {car.carrier}\") # –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é existing_service_ids = CarService.objects.filter( car=car, service_type='CARRIER' ).values_list('service_id', flat=True) logger.info(f\"Existing carrier service IDs: {list(existing_service_ids)}\") available_services = CarrierService.objects.filter( carrier=car.carrier ).exclude(id__in=existing_service_ids) logger.info(f\"Available carrier services count: {available_services.count()}\") services = [{ 'id': service.id, 'name': service.name, 'price': float(service.default_price) } for service in available_services] elif service_type == 'company': company_id = request.GET.get('company_id') if not company_id: logger.info(\"No company selected\") return JsonResponse({'services': []}) company = Company.objects.get(id=company_id) logger.info(f\"Processing company services for company: {company}\") existing_service_ids = CarService.objects.filter( car=car, service_type='COMPANY' ).values_list('service_id', flat=True) available_services = CompanyService.objects.filter( comp", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "r company: {company}\") existing_service_ids = CarService.objects.filter( car=car, service_type='COMPANY' ).values_list('service_id', flat=True) available_services = CompanyService.objects.filter( company=company ).exclude(id__in=existing_service_ids) services = [{ 'id': service.id, 'name': service.name, 'price': float(service.default_price) } for service in available_services] else: logger.warning(f\"No {service_type} associated with car {car_id}\") services = [] logger.info(f\"Returning {len(services)} services\") return JsonResponse({'services': services}) except Car.DoesNotExist: logger.error(f\"Car not found: {car_id}\") return JsonResponse({'error': 'Car not found'}, status=404) except Exception as e: logger.error(f\"Error getting available services: {e}\", exc_info=True) return JsonResponse({'error': str(e)}, status=500) @staff_member_required @csrf_exempt def add_services(request, car_id): \"\"\"–î–æ–±–∞–≤–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é\"\"\" if request.method != 'POST': return JsonResponse({'error': 'Only POST method allowed'}, status=405) try: import json data = json.loads(request.body) service_type = data.get('service_type') service_ids = data.get('service_ids', []) if not service_type o", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "rror': 'Only POST method allowed'}, status=405) try: import json data = json.loads(request.body) service_type = data.get('service_type') service_ids = data.get('service_ids', []) if not service_type or not service_ids: return JsonResponse({'error': 'Service type and IDs are required'}, status=400) car = Car.objects.get(id=car_id) added_count = 0 for service_id in service_ids: service_type_upper = service_type.upper() custom_price = None markup_amount = Decimal('0') try: if service_type_upper == 'WAREHOUSE': service = WarehouseService.objects.get(id=service_id) if service.name == '–•—Ä–∞–Ω–µ–Ω–∏–µ': days = Decimal(str(car.days or 0)) custom_price = days * Decimal(str(service.default_price or 0)) markup_amount = days * Decimal(str(getattr(service, 'default_markup', 0) or 0)) else: custom_price = service.default_price markup_amount = getattr(service, 'default_markup', 0) or 0 elif service_type_upper == 'LINE': service = LineService.objects.get(id=service_id) custom_price = service.default_price markup_amount = getattr(service, 'default_markup', 0) or 0 elif service_type_upper == 'CARRIER': service = CarrierService.objects.get(id=service_id) custom_price = service.default_price markup_amount =", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "arkup_amount = getattr(service, 'default_markup', 0) or 0 elif service_type_upper == 'CARRIER': service = CarrierService.objects.get(id=service_id) custom_price = service.default_price markup_amount = getattr(service, 'default_markup', 0) or 0 elif service_type_upper == 'COMPANY': service = CompanyService.objects.get(id=service_id) custom_price = service.default_price markup_amount = getattr(service, 'default_markup', 0) or 0 else: continue CarService.objects.create( car=car, service_type=service_type_upper, service_id=service_id, custom_price=custom_price, markup_amount=markup_amount ) added_count += 1 except Exception as e: logger.error(f\"Error adding service {service_id} ({service_type_upper}) to car {car_id}: {e}\") return JsonResponse({ 'success': True, 'message': f'–î–æ–±–∞–≤–ª–µ–Ω–æ {added_count} —É—Å–ª—É–≥', 'added_count': added_count }) except Exception as e: return JsonResponse({'error': str(e)}, status=500) def get_container_photos_json(request, container_id): \"\"\" API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AJAX –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª \"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\". \"\"\" try: from .models import Container from .models_website import ContainerPhoto container = Contain", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "—è —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AJAX –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª \"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞\". \"\"\" try: from .models import Container from .models_website import ContainerPhoto container = Container.objects.get(id=container_id) photos_data = [] for photo in container.photos.only('id', 'photo', 'thumbnail', 'photo_type').all(): # Ensure URLs have /media/ prefix photo_url = photo.photo.url if photo.photo else '' if photo_url and not photo_url.startswith('/media/') and not photo_url.startswith('http'): photo_url = '/media/' + photo_url.lstrip('/') thumb_url = photo.thumbnail.url if photo.thumbnail else photo_url if thumb_url and not thumb_url.startswith('/media/') and not thumb_url.startswith('http'): thumb_url = '/media/' + thumb_url.lstrip('/') photos_data.append({ 'id': photo.id, 'url': photo_url, 'thumbnail': thumb_url, 'type': photo.photo_type or 'GENERAL' }) return JsonResponse({ 'success': True, 'photos': photos_data, 'count': len(photos_data) }) except Container.DoesNotExist: return JsonResponse({'success': False, 'error': 'Container not found'}, status=404) except Exception as e: return JsonResponse({'success': False, 'error': str(e)}, status=500) @csrf_exempt def sync_co", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "return JsonResponse({'success': False, 'error': 'Container not found'}, status=404) except Exception as e: return JsonResponse({'success': False, 'error': str(e)}, status=500) @csrf_exempt def sync_container_photos_from_gdrive(request, container_id): \"\"\" –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Google Drive. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É Google Drive - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë. –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç –ø–∞–ø–∫—É –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–∞–ø–æ–∫ Google Drive (–í–´–ì–†–£–ñ–ï–ù–ù–´–ï / –í –ö–û–ù–¢–ï–ô–ù–ï–†–ï). \"\"\" try: if request.method != 'POST': return JsonResponse({'success': False, 'error': 'Only POST method allowed'}, status=405) from .google_drive_sync import GoogleDriveSync from .models import Container from django.db import connection container = Container.objects.get(id=container_id) container_number = container.number folder_url = container.google_drive_folder_url # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ —Ñ–æ–Ω–µ connection.close() # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ import threading def download_in_background(): try: # Django –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ from django.db import connection as thread_connection from .models import Container as ContainerModel # –ü–µ—Ä–µ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "download_in_background(): try: # Django –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ from django.db import connection as thread_connection from .models import Container as ContainerModel # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ container_obj = ContainerModel.objects.get(id=container_id) if folder_url: # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—Å—ã–ª–∫—É GoogleDriveSync.download_folder_photos(folder_url, container_obj) else: # –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Google Drive GoogleDriveSync.sync_container_by_number(container_number) thread_connection.close() except Exception as e: logger.error(f\"Background download error for {container_number}: {e}\", exc_info=True) thread = threading.Thread(target=download_in_background, daemon=True) thread.start() # –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç message = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞—á–∞—Ç–∞. ' if folder_url: message += '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–∫–∞–∑–∞–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É.' else: message += '–ò—â–µ–º –ø–∞–ø–∫—É –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.' message += ' –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã.' return JsonResponse({ 'success': True, 'message': message, 'photos_count': 0 }) except Container.DoesNotExist: return JsonResponse({'success': False, 'error': '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404) except Exception as ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "onse({ 'success': True, 'message': message, 'photos_count': 0 }) except Container.DoesNotExist: return JsonResponse({'success': False, 'error': '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404) except Exception as e: logger.error(f\"Error syncing Google Drive photos: {e}\", exc_info=True) return JsonResponse({'success': False, 'error': str(e)}, status=500) @staff_member_required @require_GET def search_counterparties(request): \"\"\" API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ (–∫–ª–∏–µ–Ω—Ç—ã, —Å–∫–ª–∞–¥—ã, –ª–∏–Ω–∏–∏, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏, –∫–æ–º–ø–∞–Ω–∏–∏) –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞ \"\"\" query = request.GET.get('q', '').strip() if len(query) < 1: return JsonResponse({'results': []}) results = [] # –ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º companies = Company.objects.filter(name__icontains=query)[:5] for obj in companies: results.append({ 'id': f'company_{obj.pk}', 'text': f'üè¢ {obj.name}', 'type': 'company', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º clients = Client.objects.filter(name__icontains=query)[:5] for obj in clients: results.append({ 'id': f'client_{obj.pk}', 'text': f'üë§ {obj.name}', 'type': 'client', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º warehouses = Warehouse.objects.filter(name__icontains=query)[:5] for obj in warehouses: results.append({", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "_{obj.pk}', 'text': f'üë§ {obj.name}', 'type': 'client', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º warehouses = Warehouse.objects.filter(name__icontains=query)[:5] for obj in warehouses: results.append({ 'id': f'warehouse_{obj.pk}', 'text': f'üè≠ {obj.name}', 'type': 'warehouse', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –ª–∏–Ω–∏—è–º lines = Line.objects.filter(name__icontains=query)[:5] for obj in lines: results.append({ 'id': f'line_{obj.pk}', 'text': f'üö¢ {obj.name}', 'type': 'line', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞–º carriers = Carrier.objects.filter(Q(name__icontains=query) | Q(contact_person__icontains=query))[:5] for obj in carriers: results.append({ 'id': f'carrier_{obj.pk}', 'text': f'üöö {obj.name}', 'type': 'carrier', 'type_id': obj.pk, }) return JsonResponse({'results': results}) @staff_member_required @require_GET def search_cars(request): \"\"\" API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN, –º–∞—Ä–∫–µ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞ \"\"\" query = request.GET.get('q', '').strip() selected = request.GET.getlist('selected', []) # –£–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID if len(query) < 2: return JsonResponse({'results': []}) # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ cars = Car.objects.filter( Q(vin__icontains=query) | Q(brand__i", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "request.GET.getlist('selected', []) # –£–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID if len(query) < 2: return JsonResponse({'results': []}) # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ cars = Car.objects.filter( Q(vin__icontains=query) | Q(brand__icontains=query) ).exclude(pk__in=selected).select_related('client')[:15] results = [] for car in cars: client_name = car.client.name if car.client else '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞' results.append({ 'id': car.pk, 'text': f'{car.brand} {car.year} ({car.vin})', 'vin': car.vin, 'brand': car.brand, 'year': car.year, 'client': client_name, }) return JsonResponse({'results': results}) @staff_member_required @require_GET def search_counterparties(request): \"\"\" API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ (–∫–ª–∏–µ–Ω—Ç—ã, —Å–∫–ª–∞–¥—ã, –ª–∏–Ω–∏–∏, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏, –∫–æ–º–ø–∞–Ω–∏–∏) –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞ \"\"\" query = request.GET.get('q', '').strip() if len(query) < 1: return JsonResponse({'results': []}) results = [] # –ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º companies = Company.objects.filter(name__icontains=query)[:5] for obj in companies: results.append({ 'id': f'company_{obj.pk}', 'text': f'üè¢ {obj.name}', 'type': 'company', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º clients = Client.objects.filter(name__icontains=query)[:5] for obj in clients: results.", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "'id': f'company_{obj.pk}', 'text': f'üè¢ {obj.name}', 'type': 'company', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º clients = Client.objects.filter(name__icontains=query)[:5] for obj in clients: results.append({ 'id': f'client_{obj.pk}', 'text': f'üë§ {obj.name}', 'type': 'client', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º warehouses = Warehouse.objects.filter(name__icontains=query)[:5] for obj in warehouses: results.append({ 'id': f'warehouse_{obj.pk}', 'text': f'üè≠ {obj.name}', 'type': 'warehouse', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –ª–∏–Ω–∏—è–º lines = Line.objects.filter(name__icontains=query)[:5] for obj in lines: results.append({ 'id': f'line_{obj.pk}', 'text': f'üö¢ {obj.name}', 'type': 'line', 'type_id': obj.pk, }) # –ü–æ–∏—Å–∫ –ø–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞–º carriers = Carrier.objects.filter(Q(name__icontains=query) | Q(contact_person__icontains=query))[:5] for obj in carriers: results.append({ 'id': f'carrier_{obj.pk}', 'text': f'üöö {obj.name}', 'type': 'carrier', 'type_id': obj.pk, }) return JsonResponse({'results': results}) @staff_member_required @require_GET def search_cars(request): \"\"\" API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN, –º–∞—Ä–∫–µ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞ \"\"\" query = request.GET.get('q', ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\views.py", "content": "s': results}) @staff_member_required @require_GET def search_cars(request): \"\"\" API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN, –º–∞—Ä–∫–µ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞ \"\"\" query = request.GET.get('q', '').strip() selected = request.GET.getlist('selected', []) # –£–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID if len(query) < 2: return JsonResponse({'results': []}) # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ cars = Car.objects.filter( Q(vin__icontains=query) | Q(brand__icontains=query) ).exclude(pk__in=selected).select_related('client')[:15] results = [] for car in cars: client_name = car.client.name if car.client else '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞' results.append({ 'id': car.pk, 'text': f'{car.brand} {car.year} ({car.vin})', 'vin': car.vin, 'brand': car.brand, 'year': car.year, 'client': client_name, }) return JsonResponse({'results': results})", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "\"\"\" –ù–æ–≤–∞—è —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å–æ–≤ ========================================================= –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã: - –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å - –ü—Ä—è–º—ã–µ —Å–≤—è–∑–∏ –≤–º–µ—Å—Ç–æ generic - –û–¥–∏–Ω –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ê–≤—Ç–æ—Ä—ã: AI Assistant –î–∞—Ç–∞: 30 —Å–µ–Ω—Ç—è–±—Ä—è 2025 \"\"\" from django.db import models from django.core.validators import MinValueValidator from django.utils import timezone from django.contrib.auth import get_user_model from decimal import Decimal import logging logger = logging.getLogger('django') User = get_user_model() # ============================================================================ # –ë–ê–ó–û–í–´–ô –ú–ò–ö–°–ò–ù –î–õ–Ø –ë–ê–õ–ê–ù–°–û–í # ============================================================================ class SimpleBalanceMixin(models.Model): \"\"\" –ü—Ä–æ—Å—Ç–æ–π –º–∏–∫—Å–∏–Ω –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤ - –û–î–ò–ù –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö! –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞ –Ω–µ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –±–∞–ª–∞–Ω—Å–∞. \"\"\" balance = models.DecimalField( max_digits=15, decimal_places=2, default=0, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥)\" ) balance_updated_at = models.DateTimeField( ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "imalField( max_digits=15, decimal_places=2, default=0, verbose_name=\"–ë–∞–ª–∞–Ω—Å\", help_text=\"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥)\" ) balance_updated_at = models.DateTimeField( auto_now=True, verbose_name=\"–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞\" ) class Meta: abstract = True def get_balance_breakdown(self): \"\"\" –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –±–∞–ª–∞–Ω—Å–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Returns: dict: {'cash': Decimal, 'card': Decimal, 'transfer': Decimal, 'total': Decimal} \"\"\" from django.db.models import Sum, Q # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π model_name = self.__class__.__name__.lower() # –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π incoming_filter = Q(**{f'to_{model_name}': self}) outgoing_filter = Q(**{f'from_{model_name}': self}) # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ from .models_billing import Transaction transactions = Transaction.objects.filter(incoming_filter | outgoing_filter) # –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã breakdown = {} for method in ['CASH', 'CARD', 'TRANSFER']: incoming = transactions.filter( incoming_filter, method=method ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00') outgoing = transactions.filter( outgoing_filter, method=method ).aggregate(total=Sum('", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": " transactions.filter( incoming_filter, method=method ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00') outgoing = transactions.filter( outgoing_filter, method=method ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00') breakdown[method.lower()] = incoming - outgoing breakdown['total'] = self.balance return breakdown def get_balance_info(self): \"\"\" –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–µ –≤ –ø–æ–Ω—è—Ç–Ω–æ–º –≤–∏–¥–µ Returns: dict: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–ª–∞–Ω—Å–µ —Å —Å—Ç–∞—Ç—É—Å–æ–º –∏ —Ü–≤–µ—Ç–æ–º \"\"\" balance = self.balance if balance > 0: status = \"–ü–ï–†–ï–ü–õ–ê–¢–ê\" color = \"#28a745\" # –∑–µ–ª–µ–Ω—ã–π description = f\"–ü–µ—Ä–µ–ø–ª–∞—Ç–∞ {balance:.2f}\" elif balance < 0: status = \"–î–û–õ–ì\" color = \"#dc3545\" # –∫—Ä–∞—Å–Ω—ã–π description = f\"–î–æ–ª–≥ {abs(balance):.2f}\" else: status = \"–ë–ê–õ–ê–ù–°\" color = \"#6c757d\" # —Å–µ—Ä—ã–π description = \"–ë–∞–ª–∞–Ω—Å –Ω—É–ª–µ–≤–æ–π\" return { 'balance': balance, 'status': status, 'color': color, 'description': description, 'breakdown': self.get_balance_breakdown() } # ============================================================================ # –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –ò–ù–í–û–ô–°–ê # ============================================================================ class NewInvoice(models.Model): \"\"\" –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–Ω–≤–æ–π—Å–∞ —Å –ø—Ä—è–º—ã–º–∏ —Å–≤—è–∑—è–º–∏ –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "= # –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –ò–ù–í–û–ô–°–ê # ============================================================================ class NewInvoice(models.Model): \"\"\" –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–Ω–≤–æ–π—Å–∞ —Å –ø—Ä—è–º—ã–º–∏ —Å–≤—è–∑—è–º–∏ –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è: - –ü—Ä—è–º—ã–µ ForeignKey –≤–º–µ—Å—Ç–æ generic —Å–≤—è–∑–µ–π - –ü–æ–Ω—è—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å—É–º–º - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π \"\"\" # –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–∞ STATUS_CHOICES = [ ('DRAFT', '–ß–µ—Ä–Ω–æ–≤–∏–∫'), ('ISSUED', '–í—ã—Å—Ç–∞–≤–ª–µ–Ω'), ('PARTIALLY_PAID', '–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω'), ('PAID', '–û–ø–ª–∞—á–µ–Ω'), ('OVERDUE', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω'), ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω'), ] # ======================================================================== # –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø # ======================================================================== number = models.CharField( max_length=50, unique=True, verbose_name=\"–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞\", help_text=\"–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)\" ) date = models.DateField( default=timezone.now, verbose_name=\"–î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è\" ) due_date = models.DateField( null=True, blank=True, verbose_name=\"–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã\", help_text=\"–î–∞—Ç–∞, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø–ª–∞—á–µ–Ω –∏–Ω–≤–æ–π—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ +14 –¥–Ω–µ–π)\" ) # ======================================================================== # –ö–¢–û –í–´–°–¢–ê–í–ò–õ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–∞—è —Å—É—â–Ω–æ—Å—Ç—å!) ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "lp_text=\"–î–∞—Ç–∞, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø–ª–∞—á–µ–Ω –∏–Ω–≤–æ–π—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ +14 –¥–Ω–µ–π)\" ) # ======================================================================== # –ö–¢–û –í–´–°–¢–ê–í–ò–õ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–∞—è —Å—É—â–Ω–æ—Å—Ç—å!) # ======================================================================== issuer_company = models.ForeignKey( 'Company', on_delete=models.PROTECT, null=True, blank=True, related_name='issued_invoices_new', verbose_name=\"–ö–æ–º–ø–∞–Ω–∏—è-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å\" ) issuer_warehouse = models.ForeignKey( 'Warehouse', on_delete=models.PROTECT, null=True, blank=True, related_name='issued_invoices_new', verbose_name=\"–°–∫–ª–∞–¥-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å\" ) issuer_line = models.ForeignKey( 'Line', on_delete=models.PROTECT, null=True, blank=True, related_name='issued_invoices_new', verbose_name=\"–õ–∏–Ω–∏—è-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å\" ) issuer_carrier = models.ForeignKey( 'Carrier', on_delete=models.PROTECT, null=True, blank=True, related_name='issued_invoices_new', verbose_name=\"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å\" ) # ======================================================================== # –ö–û–ú–£ –í–´–°–¢–ê–í–õ–ï–ù (–ø—Ä—è–º—ã–µ —Å–≤—è–∑–∏ - –¢–û–õ–¨–ö–û –û–î–ù–ê –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!) # ======================================================================== recipient_client = models.ForeignKey( 'Clien", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "======================= # –ö–û–ú–£ –í–´–°–¢–ê–í–õ–ï–ù (–ø—Ä—è–º—ã–µ —Å–≤—è–∑–∏ - –¢–û–õ–¨–ö–û –û–î–ù–ê –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!) # ======================================================================== recipient_client = models.ForeignKey( 'Client', on_delete=models.PROTECT, null=True, blank=True, related_name='received_invoices_new', verbose_name=\"–ö–ª–∏–µ–Ω—Ç-–ø–æ–ª—É—á–∞—Ç–µ–ª—å\" ) recipient_warehouse = models.ForeignKey( 'Warehouse', on_delete=models.PROTECT, null=True, blank=True, related_name='received_invoices_new', verbose_name=\"–°–∫–ª–∞–¥-–ø–æ–ª—É—á–∞—Ç–µ–ª—å\" ) recipient_line = models.ForeignKey( 'Line', on_delete=models.PROTECT, null=True, blank=True, related_name='received_invoices_new', verbose_name=\"–õ–∏–Ω–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å\" ) recipient_carrier = models.ForeignKey( 'Carrier', on_delete=models.PROTECT, null=True, blank=True, related_name='received_invoices_new', verbose_name=\"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫-–ø–æ–ª—É—á–∞—Ç–µ–ª—å\" ) recipient_company = models.ForeignKey( 'Company', on_delete=models.PROTECT, null=True, blank=True, related_name='received_invoices_new', verbose_name=\"–ö–æ–º–ø–∞–Ω–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å\" ) # ======================================================================== # –§–ò–ù–ê–ù–°–´ # ======================================================================== subtotal = models.Decima", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å\" ) # ======================================================================== # –§–ò–ù–ê–ù–°–´ # ======================================================================== subtotal = models.DecimalField( max_digits=15, decimal_places=2, default=0, validators=[MinValueValidator(0)], verbose_name=\"–ü–æ–¥—ã—Ç–æ–≥\", help_text=\"–°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–±–æ—Ä–æ–≤\" ) discount = models.DecimalField( max_digits=15, decimal_places=2, default=0, validators=[MinValueValidator(0)], verbose_name=\"–°–∫–∏–¥–∫–∞\" ) tax = models.DecimalField( max_digits=15, decimal_places=2, default=0, validators=[MinValueValidator(0)], verbose_name=\"–ù–∞–ª–æ–≥\" ) total = models.DecimalField( max_digits=15, decimal_places=2, default=0, validators=[MinValueValidator(0)], verbose_name=\"–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ\", help_text=\"–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∏–Ω–≤–æ–π—Å–∞\" ) paid_amount = models.DecimalField( max_digits=15, decimal_places=2, default=0, validators=[MinValueValidator(0)], verbose_name=\"–û–ø–ª–∞—á–µ–Ω–æ\", help_text=\"–°—É–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–∞\" ) # ======================================================================== # –°–¢–ê–¢–£–° –ò –ú–ï–¢–ê–î–ê–ù–ù–´–ï # ======================================================================== status = models.CharField( max_length", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "================================================================= # –°–¢–ê–¢–£–° –ò –ú–ï–¢–ê–î–ê–ù–ù–´–ï # ======================================================================== status = models.CharField( max_length=20, choices=STATUS_CHOICES, default='DRAFT', verbose_name=\"–°—Ç–∞—Ç—É—Å\" ) notes = models.TextField( blank=True, verbose_name=\"–ü—Ä–∏–º–µ—á–∞–Ω–∏—è\", help_text=\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω–≤–æ–π—Å–µ\" ) # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π cars = models.ManyToManyField( 'Car', blank=True, related_name='invoices_new', verbose_name=\"–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏\", help_text=\"–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥\" ) # –ê—É–¥–∏—Ç created_at = models.DateTimeField(auto_now_add=True, verbose_name=\"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è\") updated_at = models.DateTimeField(auto_now=True, verbose_name=\"–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\") created_by = models.ForeignKey( User, on_delete=models.SET_NULL, null=True, related_name='created_invoices_new', verbose_name=\"–°–æ–∑–¥–∞–ª\" ) # –°–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ _balance_updated = models.BooleanField(default=False, editable=False) class Meta: verbose_name = \"–ò–Ω–≤–æ–π—Å\" verbose_name_plural = \"–ò–Ω–≤–æ–π—Å—ã\" ordering = ['-date', '-created_at'] indexes = [ model", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": " –±–∞–ª–∞–Ω—Å–∞ _balance_updated = models.BooleanField(default=False, editable=False) class Meta: verbose_name = \"–ò–Ω–≤–æ–π—Å\" verbose_name_plural = \"–ò–Ω–≤–æ–π—Å—ã\" ordering = ['-date', '-created_at'] indexes = [ models.Index(fields=['number']), models.Index(fields=['status', 'date']), models.Index(fields=['due_date', 'status']), models.Index(fields=['recipient_client', 'status']), models.Index(fields=['recipient_warehouse', 'status']), models.Index(fields=['recipient_line', 'status']), models.Index(fields=['recipient_carrier', 'status']), models.Index(fields=['recipient_company', 'status']), models.Index(fields=['issuer_company', 'status']), models.Index(fields=['issuer_warehouse', 'status']), models.Index(fields=['issuer_line', 'status']), models.Index(fields=['issuer_carrier', 'status']), ] def __str__(self): return f\"–ò–Ω–≤–æ–π—Å {self.number} ({self.get_status_display()})\" # ======================================================================== # –°–í–û–ô–°–¢–í–ê # ======================================================================== @property def issuer(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞\"\"\" if self.issuer_company: return self.issuer_company elif self.issuer_warehouse: return self.issuer_warehouse e", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "=========================== @property def issuer(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞\"\"\" if self.issuer_company: return self.issuer_company elif self.issuer_warehouse: return self.issuer_warehouse elif self.issuer_line: return self.issuer_line elif self.issuer_carrier: return self.issuer_carrier return None @property def issuer_name(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è\"\"\" issuer = self.issuer return str(issuer) if issuer else \"–ù–µ —É–∫–∞–∑–∞–Ω\" @property def recipient(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞\"\"\" if self.recipient_client: return self.recipient_client elif self.recipient_warehouse: return self.recipient_warehouse elif self.recipient_line: return self.recipient_line elif self.recipient_carrier: return self.recipient_carrier elif self.recipient_company: return self.recipient_company return None @property def recipient_name(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è\"\"\" recipient = self.recipient return str(recipient) if recipient else \"–ù–µ —É–∫–∞–∑–∞–Ω\" @property def remaining_amount(self): \"\"\"–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ\"\"\" return max(Decimal('0.00'), self.total - self.paid_amount) @property def is_overdue(self): \"\"\"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ –∏–Ω–≤–æ–π—Å\"\"\" if self.status in ['PAID', 'CANCELLED']: return False if not self.due", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "–∫ –∫ –æ–ø–ª–∞—Ç–µ\"\"\" return max(Decimal('0.00'), self.total - self.paid_amount) @property def is_overdue(self): \"\"\"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ –∏–Ω–≤–æ–π—Å\"\"\" if self.status in ['PAID', 'CANCELLED']: return False if not self.due_date: return False return self.due_date < timezone.now().date() @property def days_until_due(self): \"\"\"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã\"\"\" if not self.due_date: return 0 delta = self.due_date - timezone.now().date() return delta.days # ======================================================================== # –ú–ï–¢–û–î–´ # ======================================================================== def calculate_totals(self): \"\"\"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–π\"\"\" items = self.items.all() self.subtotal = sum(item.total_price for item in items) self.total = self.subtotal - self.discount + self.tax return self.total def update_status(self): \"\"\"–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–ª–∞—Ç—ã\"\"\" # –ù–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ total = 0 (–∏–Ω–≤–æ–π—Å –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π) if self.total > 0 and self.paid_amount >= self.total: self.status = 'PAID' elif self.paid_amount > 0 and self.total > 0: self.status = 'PARTIALLY_PAID' elif self.is_overdue: self.status = 'OVERDUE' elif self.status == 'DRAFT': pass # –û—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º el", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "lf.status = 'PAID' elif self.paid_amount > 0 and self.total > 0: self.status = 'PARTIALLY_PAID' elif self.is_overdue: self.status = 'OVERDUE' elif self.status == 'DRAFT': pass # –û—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º elif self.status == 'PAID' and self.total == 0: # –ï—Å–ª–∏ –±—ã–ª PAID –Ω–æ —Ç–µ–ø–µ—Ä—å total=0, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ ISSUED self.status = 'ISSUED' # –ï—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å - –Ω–µ –º–µ–Ω—è–µ–º def generate_number(self): \"\"\"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞\"\"\" from django.utils.timezone import now date = now() prefix = f\"INV-{date.year}{date.month:02d}\" # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü last_invoice = NewInvoice.objects.filter( number__startswith=prefix ).order_by('-number').first() if last_invoice: # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º try: last_num = int(last_invoice.number.split('-')[-1]) next_num = last_num + 1 except (ValueError, IndexError): next_num = 1 else: next_num = 1 return f\"{prefix}-{next_num:04d}\" def regenerate_items_from_cars(self): \"\"\" –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –∏–∑ —É—Å–ª—É–≥ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π \"\"\" # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ self.items.all().delete() issuer = self.issuer if not issuer: import logging logger = logging.getLogger(__name__) logger.warning(f\"‚ö†Ô∏è –ò–Ω–≤–æ–π—Å {self.nu", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "–≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π \"\"\" # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ self.items.all().delete() issuer = self.issuer if not issuer: import logging logger = logging.getLogger(__name__) logger.warning(f\"‚ö†Ô∏è –ò–Ω–≤–æ–π—Å {self.number}: –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã\") return issuer_type = issuer.__class__.__name__ import logging logger = logging.getLogger(__name__) logger.info(f\"üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ {self.number}, –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å: {issuer} (—Ç–∏–ø: {issuer_type})\") order = 0 for car in self.cars.all(): # –í–ê–ñ–ù–û! –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π # –ù–û –ù–ï –°–û–•–†–ê–ù–Ø–ï–ú - —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Å–∏–≥–Ω–∞–ª # –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞ regenerate car.update_days_and_storage() car.calculate_total_price() # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –±—Ä–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è if issuer_type == 'Warehouse': services = car.get_warehouse_services() prefix = '–°–∫–ª–∞–¥' # –í–ê–ñ–ù–û! –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é if car.storage_cost and car.storage_cost > 0: InvoiceItem.objects.create( invoice=self, description=f\"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.)\", car=car, quantity=car.days, unit_price=car._get_storage_daily_rate() if car.warehouse e", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "> 0: InvoiceItem.objects.create( invoice=self, description=f\"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.)\", car=car, quantity=car.days, unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'), order=order ) order += 1 elif issuer_type == 'Line': services = car.get_line_services() prefix = '–õ–∏–Ω–∏—è' elif issuer_type == 'Carrier': services = car.get_carrier_services() prefix = '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫' elif issuer_type == 'Company': # –ö–æ–º–ø–∞–Ω–∏—è –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É - –≤—Å–µ —É—Å–ª—É–≥–∏ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ + –Ω–∞—Ü–µ–Ω–∫–∞ services = car.car_services.all() prefix = '–í—Å–µ —É—Å–ª—É–≥–∏' # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è status_note = \"\" if car.status == 'TRANSFERRED' and car.transfer_date: status_note = f\" [–ü–µ—Ä–µ–¥–∞–Ω {car.transfer_date}]\" else: from django.utils import timezone status_note = f\" [–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ {timezone.now().date()}]\" # –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤ if car.storage_cost and car.storage_cost > 0: InvoiceItem.objects.create( invoice=self, description=f\"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.){status_note}\", car=car, quantity=car.days, unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'), order=order ) order += 1 # –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": " ({car.days} –¥–Ω.){status_note}\", car=car, quantity=car.days, unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'), order=order ) order += 1 # –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ! # –û–Ω–∞ —Å–∫—Ä—ã—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ markup_amount –≤ CarService # –≠—Ç–æ –ø—Ä–∏–±—ã–ª—å Caromoto Lithuania, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É else: continue # –°–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —É—Å–ª—É–≥ for service in services: service_name = service.get_service_name() # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ # –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –∞ CarService –æ—Å—Ç–∞–ª—Å—è if service_name == \"–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\": logger.warning(f\"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –±–∏—Ç–∞—è —É—Å–ª—É–≥–∞: type={service.service_type}, id={service.service_id} –¥–ª—è –∞–≤—Ç–æ {car.vin}\") continue # –ó–ê–©–ò–¢–ê: –î–ª—è Company –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥—É \"–•—Ä–∞–Ω–µ–Ω–∏–µ\" - –æ–Ω–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—ã—à–µ –≤—Ä—É—á–Ω—É—é # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏–Ω–≤–æ–π—Å–µ if issuer_type == 'Company' and service_name == '–•—Ä–∞–Ω–µ–Ω–∏–µ': logger.debug(f\"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥—É '–•—Ä–∞–Ω–µ–Ω–∏–µ' –¥–ª—è {car.vin} - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é\") continue # –î–ª—è Company –∏—Å–ø–æ–ª—å–∑—É–µ–º invoice_price (–≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É) # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É if issuer_type == 'Company': # invoice_price ", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "—Ä–∞–Ω–µ–Ω–∏–µ' –¥–ª—è {car.vin} - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é\") continue # –î–ª—è Company –∏—Å–ø–æ–ª—å–∑—É–µ–º invoice_price (–≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É) # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É if issuer_type == 'Company': # invoice_price —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç markup_amount –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç quantity unit_price = (service.custom_price if service.custom_price else service.get_default_price()) + (service.markup_amount or Decimal('0')) else: unit_price = service.custom_price if service.custom_price else service.get_default_price() InvoiceItem.objects.create( invoice=self, description=f\"{prefix}: {service_name} - {car.brand} {car.vin}\", car=car, quantity=service.quantity, unit_price=unit_price, order=order ) order += 1 # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ self.calculate_totals() self.save(update_fields=['subtotal', 'total']) def save(self, *args, **kwargs): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞\"\"\" # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –¥–ª—è –Ω–æ–≤—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤ if not self.number: self.number = self.generate_number() # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω if not self.due_date: self.due_date = timezone.now().date() + timezone.timedelta(days=14) # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å self.update_status() super().save(*args, **kwargs) # ===================", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "—Ç—ã, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω if not self.due_date: self.due_date = timezone.now().date() + timezone.timedelta(days=14) # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å self.update_status() super().save(*args, **kwargs) # ============================================================================ # –ü–û–ó–ò–¶–ò–Ø –í –ò–ù–í–û–ô–°–ï # ============================================================================ class InvoiceItem(models.Model): \"\"\" –ü–æ–∑–∏—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞) –≤ –∏–Ω–≤–æ–π—Å–µ –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º –∏–ª–∏ –±—ã—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —É—Å–ª—É–≥–æ–π \"\"\" # –°–≤—è–∑—å —Å –∏–Ω–≤–æ–π—Å–æ–º invoice = models.ForeignKey( NewInvoice, on_delete=models.CASCADE, related_name='items', verbose_name=\"–ò–Ω–≤–æ–π—Å\" ) # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) car = models.ForeignKey( 'Car', on_delete=models.SET_NULL, null=True, blank=True, related_name='invoice_items_new', verbose_name=\"–ê–≤—Ç–æ–º–æ–±–∏–ª—å\" ) # –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä–∞ description = models.CharField( max_length=500, verbose_name=\"–û–ø–∏—Å–∞–Ω–∏–µ\", help_text=\"–ù–∞–ø—Ä–∏–º–µ—Ä: '–•—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ VIN12345 (10 –¥–Ω–µ–π)'\" ) # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω–∞ quantity = models.DecimalField( max_digits=10, decimal_places=2, default=1, validators=[MinValueValidator(0)], verbose_name=\"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ\" ) unit_price = models.DecimalField( max_digits=15, decimal_places=2, validators=[MinVa", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "alField( max_digits=10, decimal_places=2, default=1, validators=[MinValueValidator(0)], verbose_name=\"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ\" ) unit_price = models.DecimalField( max_digits=15, decimal_places=2, validators=[MinValueValidator(0)], verbose_name=\"–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É\" ) total_price = models.DecimalField( max_digits=15, decimal_places=2, validators=[MinValueValidator(0)], verbose_name=\"–°—É–º–º–∞\", help_text=\"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Ü–µ–Ω–∞\" ) # –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è order = models.PositiveIntegerField( default=0, verbose_name=\"–ü–æ—Ä—è–¥–æ–∫\" ) class Meta: verbose_name = \"–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞\" verbose_name_plural = \"–ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞\" ordering = ['order', 'id'] indexes = [ models.Index(fields=['invoice', 'order']), models.Index(fields=['car']), ] def __str__(self): return f\"{self.description} - {self.total_price}\" def calculate_total(self): \"\"\"–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ø–æ–∑–∏—Ü–∏–∏\"\"\" self.total_price = self.quantity * self.unit_price return self.total_price def save(self, *args, **kwargs): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã\"\"\" self.calculate_total() super().save(*args, **kwargs) # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –∏–Ω–≤–æ–π—Å–∞ if self.invoice_id: self.invoice.calculate_totals() self.invoice.save(update_fields=[", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã\"\"\" self.calculate_total() super().save(*args, **kwargs) # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –∏–Ω–≤–æ–π—Å–∞ if self.invoice_id: self.invoice.calculate_totals() self.invoice.save(update_fields=['subtotal', 'total', 'updated_at']) # ============================================================================ # –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø (–ü–õ–ê–¢–ï–ñ/–í–û–ó–í–†–ê–¢/–ü–ï–†–ï–í–û–î) # ============================================================================ class Transaction(models.Model): \"\"\" –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é –º–æ–¥–µ–ª—å Payment –∏ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π: - –ü–ª–∞—Ç–µ–∂–∏ –ø–æ –∏–Ω–≤–æ–π—Å–∞–º - –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ - –í–æ–∑–≤—Ä–∞—Ç—ã - –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏ - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ \"\"\" # –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π TYPE_CHOICES = [ ('PAYMENT', '–ü–ª–∞—Ç–µ–∂'), ('REFUND', '–í–æ–∑–≤—Ä–∞—Ç'), ('ADJUSTMENT', '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞'), ('TRANSFER', '–ü–µ—Ä–µ–≤–æ–¥'), ('BALANCE_TOPUP', '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞'), ] # –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã METHOD_CHOICES = [ ('CASH', '–ù–∞–ª–∏—á–Ω—ã–µ'), ('CARD', '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞'), ('TRANSFER', '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥'), ('BALANCE', '–°–ø–∏—Å–∞–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞'), ('OTHER', '–î—Ä—É–≥–æ–µ'), ] # –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ STATUS_CHOICES = [ ('PENDING', '–í –æ–∂–∏–¥–∞–Ω–∏–∏'), ('COMPLETED', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'), ('FAILED', '–û—à–∏–±–∫–∞'), ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω–∞'), ] # ======", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "'–°–ø–∏—Å–∞–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞'), ('OTHER', '–î—Ä—É–≥–æ–µ'), ] # –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ STATUS_CHOICES = [ ('PENDING', '–í –æ–∂–∏–¥–∞–Ω–∏–∏'), ('COMPLETED', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'), ('FAILED', '–û—à–∏–±–∫–∞'), ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω–∞'), ] # ======================================================================== # –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø # ======================================================================== number = models.CharField( max_length=50, unique=True, verbose_name=\"–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\" ) date = models.DateTimeField( default=timezone.now, verbose_name=\"–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\" ) # ======================================================================== # –¢–ò–ü –ò –°–ü–û–°–û–ë # ======================================================================== type = models.CharField( max_length=20, choices=TYPE_CHOICES, verbose_name=\"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏\" ) method = models.CharField( max_length=20, choices=METHOD_CHOICES, verbose_name=\"–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã\" ) status = models.CharField( max_length=20, choices=STATUS_CHOICES, default='COMPLETED', verbose_name=\"–°—Ç–∞—Ç—É—Å\" ) # ======================================================================== # –û–¢–ö–£–î–ê (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ! # ======================================================================== from", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "=================================================================== # –û–¢–ö–£–î–ê (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ! # ======================================================================== from_client = models.ForeignKey( 'Client', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_sent_new', verbose_name=\"–û—Ç –∫–ª–∏–µ–Ω—Ç–∞\" ) from_warehouse = models.ForeignKey( 'Warehouse', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_sent_new', verbose_name=\"–û—Ç —Å–∫–ª–∞–¥–∞\" ) from_line = models.ForeignKey( 'Line', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_sent_new', verbose_name=\"–û—Ç –ª–∏–Ω–∏–∏\" ) from_carrier = models.ForeignKey( 'Carrier', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_sent_new', verbose_name=\"–û—Ç –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞\" ) from_company = models.ForeignKey( 'Company', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_sent_new', verbose_name=\"–û—Ç –∫–æ–º–ø–∞–Ω–∏–∏\" ) # ======================================================================== # –ö–£–î–ê (–ø–æ–ª—É—á–∞—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ! # ======================================================================== to_cli", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "==================================================================== # –ö–£–î–ê (–ø–æ–ª—É—á–∞—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ! # ======================================================================== to_client = models.ForeignKey( 'Client', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_received_new', verbose_name=\"–ö–ª–∏–µ–Ω—Ç—É\" ) to_warehouse = models.ForeignKey( 'Warehouse', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_received_new', verbose_name=\"–°–∫–ª–∞–¥—É\" ) to_line = models.ForeignKey( 'Line', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_received_new', verbose_name=\"–õ–∏–Ω–∏–∏\" ) to_carrier = models.ForeignKey( 'Carrier', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_received_new', verbose_name=\"–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫—É\" ) to_company = models.ForeignKey( 'Company', on_delete=models.PROTECT, null=True, blank=True, related_name='transactions_received_new', verbose_name=\"–ö–æ–º–ø–∞–Ω–∏–∏\" ) # ======================================================================== # –°–í–Ø–ó–¨ –° –ò–ù–í–û–ô–°–û–ú # ======================================================================== invoice = models.ForeignKey( NewInvoice, on_", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "============================================================= # –°–í–Ø–ó–¨ –° –ò–ù–í–û–ô–°–û–ú # ======================================================================== invoice = models.ForeignKey( NewInvoice, on_delete=models.SET_NULL, null=True, blank=True, related_name='transactions', verbose_name=\"–ò–Ω–≤–æ–π—Å\", help_text=\"–ï—Å–ª–∏ —ç—Ç–æ –æ–ø–ª–∞—Ç–∞ –∏–Ω–≤–æ–π—Å–∞, —É–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∑–¥–µ—Å—å\" ) # ======================================================================== # –°–£–ú–ú–ê –ò –û–ü–ò–°–ê–ù–ò–ï # ======================================================================== amount = models.DecimalField( max_digits=15, decimal_places=2, validators=[MinValueValidator(0)], verbose_name=\"–°—É–º–º–∞\" ) description = models.TextField( verbose_name=\"–û–ø–∏—Å–∞–Ω–∏–µ\", help_text=\"–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\" ) # ======================================================================== # –ú–ï–¢–ê–î–ê–ù–ù–´–ï # ======================================================================== created_at = models.DateTimeField(auto_now_add=True, verbose_name=\"–°–æ–∑–¥–∞–Ω–∞\") created_by = models.ForeignKey( User, on_delete=models.SET_NULL, null=True, related_name='created_transactions_new', verbose_name=\"–°–æ–∑–¥–∞–ª\" ) class Meta: verbose_name = \"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è\" verbose_name_plural = \"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "models.ForeignKey( User, on_delete=models.SET_NULL, null=True, related_name='created_transactions_new', verbose_name=\"–°–æ–∑–¥–∞–ª\" ) class Meta: verbose_name = \"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è\" verbose_name_plural = \"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\" ordering = ['-date'] indexes = [ models.Index(fields=['number']), models.Index(fields=['date', 'type']), models.Index(fields=['invoice']), models.Index(fields=['from_client', 'date']), models.Index(fields=['to_client', 'date']), models.Index(fields=['from_warehouse', 'date']), models.Index(fields=['to_warehouse', 'date']), models.Index(fields=['from_line', 'date']), models.Index(fields=['to_line', 'date']), models.Index(fields=['from_carrier', 'date']), models.Index(fields=['to_carrier', 'date']), models.Index(fields=['from_company', 'date']), models.Index(fields=['to_company', 'date']), models.Index(fields=['status', 'date']), ] def __str__(self): return f\"{self.number}: {self.get_type_display()} {self.amount}\" # ======================================================================== # –°–í–û–ô–°–¢–í–ê # ======================================================================== @property def sender(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è\"\"\" if self.from_client: return self.from_client elif self.from", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "# –°–í–û–ô–°–¢–í–ê # ======================================================================== @property def sender(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è\"\"\" if self.from_client: return self.from_client elif self.from_warehouse: return self.from_warehouse elif self.from_line: return self.from_line elif self.from_carrier: return self.from_carrier elif self.from_company: return self.from_company return None @property def recipient(self): \"\"\"–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è\"\"\" if self.to_client: return self.to_client elif self.to_warehouse: return self.to_warehouse elif self.to_line: return self.to_line elif self.to_carrier: return self.to_carrier elif self.to_company: return self.to_company return None @property def sender_name(self): \"\"\"–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è\"\"\" sender = self.sender return str(sender) if sender else \"–ù–µ —É–∫–∞–∑–∞–Ω\" @property def recipient_name(self): \"\"\"–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è\"\"\" recipient = self.recipient return str(recipient) if recipient else \"–ù–µ —É–∫–∞–∑–∞–Ω\" # ======================================================================== # –ú–ï–¢–û–î–´ # ======================================================================== def generate_number(self): \"\"\"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\"\"\" from django.utils.timezone i", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\models_billing.py", "content": "============ # –ú–ï–¢–û–î–´ # ======================================================================== def generate_number(self): \"\"\"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\"\"\" from django.utils.timezone import now date = now() prefix = f\"TRX-{date.year}{date.month:02d}{date.day:02d}\" # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å last_transaction = Transaction.objects.filter( number__startswith=prefix ).order_by('-number').first() if last_transaction: try: last_num = int(last_transaction.number.split('-')[-1]) next_num = last_num + 1 except (ValueError, IndexError): next_num = 1 else: next_num = 1 return f\"{prefix}-{next_num:05d}\" def save(self, *args, **kwargs): \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞\"\"\" if not self.number: self.number = self.generate_number() super().save(*args, **kwargs) \"\"\"–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞\"\"\" if not self.number: self.number = self.generate_number() super().save(*args, **kwargs)", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "import logging import re from typing import List, Optional import requests from django.conf import settings from core.models import Car, Container from core.models_website import AIChat, CarPhoto, ContainerPhoto logger = logging.getLogger(__name__) class AIServiceError(Exception): pass def _get_recent_messages(session_id: Optional[str], user) -> List[dict]: if not session_id: return [] chats = AIChat.objects.filter(session_id=session_id) if user: chats = chats.filter(user=user) chats = chats.order_by(\"-created_at\")[:6] messages = [] for chat in reversed(list(chats)): messages.append({\"role\": \"user\", \"content\": chat.message}) messages.append({\"role\": \"assistant\", \"content\": chat.response}) return messages def _build_company_context() -> str: return ( \"–í—ã ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Caromoto Lithuania. \" \"–ö–æ–º–ø–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ –°–®–ê, \" \"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö, —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∏ —Å–∫–ª–∞–¥—Å–∫–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏. \" \"–û—Ç–≤–µ—á–∞–π—Ç–µ –≤–µ–∂–ª–∏–≤–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. \" \"–ù–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ü–µ–Ω—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã, –∏–Ω–≤–æ–π—Å—ã –∏–ª–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥. \" \"–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø—Ä–∞–≤—å—Ç–µ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É. \" \"–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "–µ—Å—Ç–≤—É. \" \"–ù–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ü–µ–Ω—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã, –∏–Ω–≤–æ–π—Å—ã –∏–ª–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥. \" \"–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø—Ä–∞–≤—å—Ç–µ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É. \" \"–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–≤–µ—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. \" \"–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —É—Ç–æ—á–Ω–∏—Ç–µ —É –∫–ª–∏–µ–Ω—Ç–∞ VIN –∏–ª–∏ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.\" ) def _build_client_context(client) -> str: if not client: return \"\" cars = ( Car.objects.filter(client=client) .select_related(\"container\", \"warehouse\") .order_by(\"-id\")[:5] ) containers = ( Container.objects.filter(client=client) .select_related(\"line\", \"warehouse\") .order_by(\"-id\")[:5] ) cars_info = [] for car in cars: cars_info.append( f\"VIN: {car.vin}, —Å—Ç–∞—Ç—É—Å: {car.get_status_display()}, \" f\"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: {car.container.number if car.container else '‚Äî'}\" ) containers_info = [] for container in containers: containers_info.append( f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: {container.number}, —Å—Ç–∞—Ç—É—Å: {container.get_status_display()}, \" f\"ETA: {container.eta or '‚Äî'}, –≤—ã–≥—Ä—É–∑–∫–∞: {container.unload_date or '‚Äî'}\" ) return ( f\"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ: {client.name}. \" f\"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏: {', '.join(cars_info) if cars_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}. \" f\"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: {', '.join(containers_info) if cont", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "r '‚Äî'}\" ) return ( f\"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ: {client.name}. \" f\"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏: {', '.join(cars_info) if cars_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}. \" f\"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: {', '.join(containers_info) if containers_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}.\" ) def _build_system_prompt(language_code: str) -> str: language_map = { \"ru\": \"–†—É—Å—Å–∫–∏–π\", \"en\": \"English\", \"lt\": \"Lietuvi≈≥\", } language_name = language_map.get(language_code, \"–†—É—Å—Å–∫–∏–π\") return ( \"–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. \" \"–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. \" f\"–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: {language_name}.\" ) def _find_identifiers(message: str) -> dict: vin_pattern = re.compile(r\"\\b[A-HJ-NPR-Z0-9]{17}\\b\", re.IGNORECASE) container_pattern = re.compile(r\"\\b[A-Z]{4}\\d{7}\\b\", re.IGNORECASE) vins = list({m.group(0).upper() for m in vin_pattern.finditer(message or \"\")}) containers = list({m.group(0).upper() for m in container_pattern.finditer(message or \"\")}) return {\"vins\": vins, \"containers\": containers} def _build_tracking_context(message: str, user=None, client=None) -> str: identifiers = _find_identifiers(message) vins = identifiers[\"vins\"] containers = identifiers[\"containers\"] if not vins and not containers: return \"\" is_staff = bool(user and (getattr(use", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "None) -> str: identifiers = _find_identifiers(message) vins = identifiers[\"vins\"] containers = identifiers[\"containers\"] if not vins and not containers: return \"\" is_staff = bool(user and (getattr(user, \"is_staff\", False) or getattr(user, \"is_superuser\", False))) parts = [] for vin in vins: car_qs = Car.objects.select_related(\"container\", \"warehouse\").filter(vin__iexact=vin) if client: car_qs = car_qs.filter(client=client) car = car_qs.first() if not car: parts.append(f\"–ü–æ VIN {vin} –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.\") continue unload_date = car.unload_date or (car.container.unload_date if car.container else None) transfer_date = car.transfer_date events = [] if unload_date: events.append(f\"–†–∞–∑–≥—Ä—É–∂–µ–Ω: {unload_date}\") if transfer_date: events.append(f\"–ü–µ—Ä–µ–¥–∞–Ω: {transfer_date}\") history_text = \"; \".join(events) if events else \"–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: –Ω–µ—Ç –¥–∞—Ç.\" photos_qs = CarPhoto.objects.filter(car=car) if not is_staff: photos_qs = photos_qs.filter(is_public=True) photos_count = photos_qs.count() last_photo = photos_qs.order_by(\"-uploaded_at\").first() if last_photo: photos_text = ( f\"–§–æ—Ç–æ –∞–≤—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: \" f\"{last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}\" ) else: con", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "to = photos_qs.order_by(\"-uploaded_at\").first() if last_photo: photos_text = ( f\"–§–æ—Ç–æ –∞–≤—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: \" f\"{last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}\" ) else: container_photos_text = \"\" if car.container: container_photos = ContainerPhoto.objects.filter(container=car.container) if not is_staff: container_photos = container_photos.filter(is_public=True) container_count = container_photos.count() last_container_photo = container_photos.order_by(\"-uploaded_at\").first() if container_count: if last_container_photo: container_photos_text = ( f\"–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: \" f\"{last_container_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}\" ) else: container_photos_text = f\"–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç.\" photos_text = \"–§–æ—Ç–æ –∞–≤—Ç–æ: 0 —à—Ç.\" + (f\" {container_photos_text}\" if container_photos_text else \"\") parts.append( \"–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ VIN {vin}: {status}. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: {container}. \" \"ETA: {eta}. –î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: {unload}. –°–∫–ª–∞–¥: {warehouse}. {history} {photos}\".format( vin=vin, status=car.get_status_display(), container=car.container.number if car.container else \"‚Äî\", eta=car.container.eta if car.container and car.cont", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": " –°–∫–ª–∞–¥: {warehouse}. {history} {photos}\".format( vin=vin, status=car.get_status_display(), container=car.container.number if car.container else \"‚Äî\", eta=car.container.eta if car.container and car.container.eta else \"‚Äî\", unload=unload_date or \"‚Äî\", warehouse=car.warehouse.name if car.warehouse else \"‚Äî\", history=history_text, photos=photos_text, ) ) for number in containers: container_qs = Container.objects.select_related(\"warehouse\").filter(number__iexact=number) if client: container_qs = container_qs.filter(client=client) container = container_qs.first() if not container: parts.append(f\"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {number} –Ω–µ –Ω–∞–π–¥–µ–Ω.\") continue events = [] if container.planned_unload_date: events.append(f\"–ü–ª–∞–Ω —Ä–∞–∑–≥—Ä—É–∑–∫–∏: {container.planned_unload_date}\") if container.unload_date: events.append(f\"–†–∞–∑–≥—Ä—É–∂–µ–Ω: {container.unload_date}\") if container.unloaded_status_at: events.append(f\"–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å: {container.unloaded_status_at}\") transfer_date = None if container.status == \"TRANSFERRED\": transfer_date = ( Car.objects.filter(container=container, transfer_date__isnull=False) .order_by(\"-transfer_date\") .values_list(\"transfer_date\", flat=True) .first() ) if transfer_date: events.append(f\"–ü–µ—Ä–µ–¥–∞–Ω: {t", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "e = ( Car.objects.filter(container=container, transfer_date__isnull=False) .order_by(\"-transfer_date\") .values_list(\"transfer_date\", flat=True) .first() ) if transfer_date: events.append(f\"–ü–µ—Ä–µ–¥–∞–Ω: {transfer_date}\") else: events.append(\"–ü–µ—Ä–µ–¥–∞–Ω: –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞\") history_text = \"; \".join(events) if events else \"–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: –Ω–µ—Ç –¥–∞—Ç.\" photos_qs = ContainerPhoto.objects.filter(container=container) if not is_staff: photos_qs = photos_qs.filter(is_public=True) photos_count = photos_qs.count() last_photo = photos_qs.order_by(\"-uploaded_at\").first() photos_text = ( f\"–§–æ—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: {last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}\" if last_photo else f\"–§–æ—Ç–æ: {photos_count} —à—Ç.\" ) parts.append( \"–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ {number}: {status}. ETA: {eta}. –î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: {unload}. \" \"–°–∫–ª–∞–¥: {warehouse}. {history} {photos}\".format( number=number, status=container.get_status_display(), eta=container.eta or \"‚Äî\", unload=container.unload_date or \"‚Äî\", warehouse=container.warehouse.name if container.warehouse else \"‚Äî\", history=history_text, photos=photos_text, ) ) return \" \".join(parts) def _call_ai_api(messages: List[dict]) -> str: if not settings.AI_CHAT_ENABLED: rais", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "arehouse.name if container.warehouse else \"‚Äî\", history=history_text, photos=photos_text, ) ) return \" \".join(parts) def _call_ai_api(messages: List[dict]) -> str: if not settings.AI_CHAT_ENABLED: raise AIServiceError(\"AI chat is disabled\") api_key = settings.AI_API_KEY if not api_key: raise AIServiceError(\"AI API key is missing\") base_url = settings.AI_API_BASE_URL.rstrip(\"/\") url = f\"{base_url}/chat/completions\" payload = { \"model\": settings.AI_MODEL, \"messages\": messages, \"temperature\": settings.AI_TEMPERATURE, \"max_tokens\": settings.AI_MAX_TOKENS, } try: response = requests.post( url, headers={ \"Authorization\": f\"Bearer {api_key}\", \"Content-Type\": \"application/json\", }, json=payload, timeout=settings.AI_REQUEST_TIMEOUT, ) except requests.RequestException as exc: logger.exception(\"AI API request failed\") raise AIServiceError(\"AI API request failed\") from exc if not response.ok: error_text = response.text[:1000] if response.text else \"\" logger.error(\"AI API error: %s - %s\", response.status_code, error_text) raise AIServiceError(f\"AI API returned error ({response.status_code})\") data = response.json() try: return data[\"choices\"][0][\"message\"][\"content\"].strip() except (KeyError, In", "embedding": null}, {"source_path": "C:\\Users\\art-f\\PycharmProjects\\logist2\\core\\services\\ai_chat_service.py", "content": "tatus_code, error_text) raise AIServiceError(f\"AI API returned error ({response.status_code})\") data = response.json() try: return data[\"choices\"][0][\"message\"][\"content\"].strip() except (KeyError, IndexError, TypeError) as exc: logger.error(\"AI API response parsing error: %s\", data) raise AIServiceError(\"AI API response parsing error\") from exc def generate_ai_response(message: str, user=None, client=None, session_id: Optional[str] = None, language_code: str = \"ru\") -> str: system_prompt = _build_system_prompt(language_code) company_context = _build_company_context() client_context = _build_client_context(client) tracking_context = _build_tracking_context(message, user=user, client=client) history_messages = _get_recent_messages(session_id, user) messages = [ {\"role\": \"system\", \"content\": system_prompt}, {\"role\": \"system\", \"content\": company_context}, ] if client_context: messages.append({\"role\": \"system\", \"content\": client_context}) if tracking_context: messages.append({\"role\": \"system\", \"content\": tracking_context}) messages.extend(history_messages) messages.append({\"role\": \"user\", \"content\": message}) return _call_ai_api(messages)", "embedding": null}]}
\ No newline at end of file
diff --git a/core/management/commands/rebuild_ai_index.py b/core/management/commands/rebuild_ai_index.py
index 596b549..6d59e03 100644
--- a/core/management/commands/rebuild_ai_index.py
+++ b/core/management/commands/rebuild_ai_index.py
@@ -1,21 +1,21 @@
-from django.core.management.base import BaseCommand
-
-from core.services.ai_rag import build_rag_index, get_default_rag_sources
-
-
-class Command(BaseCommand):
-    help = "Build or rebuild AI RAG index for admin assistant"
-
-    def add_arguments(self, parser):
-        parser.add_argument(
-            "--no-embeddings",
-            action="store_true",
-            help="Build index without embeddings (keyword-only fallback)",
-        )
-
-    def handle(self, *args, **options):
-        use_embeddings = not options.get("no_embeddings", False)
-        sources = get_default_rag_sources()
-        output_path = build_rag_index(sources, use_embeddings=use_embeddings)
-        mode = "embeddings" if use_embeddings else "keyword-only"
-        self.stdout.write(self.style.SUCCESS(f"AI index built ({mode}): {output_path}"))
+from django.core.management.base import BaseCommand
+
+from core.services.ai_rag import build_rag_index, get_default_rag_sources
+
+
+class Command(BaseCommand):
+    help = "Build or rebuild AI RAG index for admin assistant"
+
+    def add_arguments(self, parser):
+        parser.add_argument(
+            "--no-embeddings",
+            action="store_true",
+            help="Build index without embeddings (keyword-only fallback)",
+        )
+
+    def handle(self, *args, **options):
+        use_embeddings = not options.get("no_embeddings", False)
+        sources = get_default_rag_sources()
+        output_path = build_rag_index(sources, use_embeddings=use_embeddings)
+        mode = "embeddings" if use_embeddings else "keyword-only"
+        self.stdout.write(self.style.SUCCESS(f"AI index built ({mode}): {output_path}"))
diff --git a/core/management/commands/rebuild_ai_index_if_stale.py b/core/management/commands/rebuild_ai_index_if_stale.py
index feffe9c..5281e14 100644
--- a/core/management/commands/rebuild_ai_index_if_stale.py
+++ b/core/management/commands/rebuild_ai_index_if_stale.py
@@ -1,32 +1,32 @@
-from django.core.management.base import BaseCommand
-from django.conf import settings
-
-from core.services.ai_rag import build_rag_index, get_default_rag_sources, is_rag_index_stale
-
-
-class Command(BaseCommand):
-    help = "Rebuild AI RAG index only if it is stale"
-
-    def add_arguments(self, parser):
-        parser.add_argument(
-            "--no-embeddings",
-            action="store_true",
-            help="Build index without embeddings (keyword-only fallback)",
-        )
-
-    def handle(self, *args, **options):
-        max_age_hours = int(getattr(settings, "AI_RAG_MAX_AGE_HOURS", 24))
-        max_age_seconds = max_age_hours * 3600 if max_age_hours else None
-        sources = get_default_rag_sources()
-        stale_info = is_rag_index_stale(sources, max_age_seconds=max_age_seconds)
-        if stale_info.get("stale") != "true":
-            self.stdout.write(self.style.SUCCESS("AI index is fresh, rebuild not required."))
-            return
-
-        use_embeddings = not options.get("no_embeddings", False)
-        output_path = build_rag_index(sources, use_embeddings=use_embeddings)
-        mode = "embeddings" if use_embeddings else "keyword-only"
-        reason = stale_info.get("reason", "unknown")
-        self.stdout.write(self.style.SUCCESS(
-            f"AI index rebuilt ({mode}) due to {reason}: {output_path}"
-        ))
+from django.core.management.base import BaseCommand
+from django.conf import settings
+
+from core.services.ai_rag import build_rag_index, get_default_rag_sources, is_rag_index_stale
+
+
+class Command(BaseCommand):
+    help = "Rebuild AI RAG index only if it is stale"
+
+    def add_arguments(self, parser):
+        parser.add_argument(
+            "--no-embeddings",
+            action="store_true",
+            help="Build index without embeddings (keyword-only fallback)",
+        )
+
+    def handle(self, *args, **options):
+        max_age_hours = int(getattr(settings, "AI_RAG_MAX_AGE_HOURS", 24))
+        max_age_seconds = max_age_hours * 3600 if max_age_hours else None
+        sources = get_default_rag_sources()
+        stale_info = is_rag_index_stale(sources, max_age_seconds=max_age_seconds)
+        if stale_info.get("stale") != "true":
+            self.stdout.write(self.style.SUCCESS("AI index is fresh, rebuild not required."))
+            return
+
+        use_embeddings = not options.get("no_embeddings", False)
+        output_path = build_rag_index(sources, use_embeddings=use_embeddings)
+        mode = "embeddings" if use_embeddings else "keyword-only"
+        reason = stale_info.get("reason", "unknown")
+        self.stdout.write(self.style.SUCCESS(
+            f"AI index rebuilt ({mode}) due to {reason}: {output_path}"
+        ))
diff --git a/core/management/commands/repair_container_photos.py b/core/management/commands/repair_container_photos.py
new file mode 100644
index 0000000..691ab9e
--- /dev/null
+++ b/core/management/commands/repair_container_photos.py
@@ -0,0 +1,113 @@
+from __future__ import annotations
+
+import os
+import shutil
+from typing import Optional, Tuple
+
+from django.conf import settings
+from django.core.management.base import BaseCommand
+
+from core.models_website import ContainerPhoto
+
+
+class Command(BaseCommand):
+    help = (
+        "Repairs container photo records by moving files into MEDIA_ROOT when they "
+        "exist in the project root, otherwise deletes broken records."
+    )
+
+    def add_arguments(self, parser):
+        parser.add_argument(
+            "--dry-run",
+            action="store_true",
+            help="Show what would be changed without modifying files or DB.",
+        )
+        parser.add_argument(
+            "--limit",
+            type=int,
+            default=0,
+            help="Limit number of records to process (0 = no limit).",
+        )
+
+    def handle(self, *args, **options):
+        dry_run: bool = options["dry_run"]
+        limit: int = options["limit"]
+
+        media_root = settings.MEDIA_ROOT
+        base_dir = str(settings.BASE_DIR)
+
+        if not media_root:
+            self.stderr.write(self.style.ERROR("MEDIA_ROOT is not configured. Aborting."))
+            return
+
+        qs = ContainerPhoto.objects.select_related("container").only(
+            "id", "photo", "thumbnail", "container_id"
+        )
+        if limit > 0:
+            qs = qs[:limit]
+
+        moved = 0
+        deleted = 0
+        skipped = 0
+
+        for photo in qs:
+            action = self._process_photo(photo, media_root, base_dir, dry_run=dry_run)
+            if action == "moved":
+                moved += 1
+            elif action == "deleted":
+                deleted += 1
+            else:
+                skipped += 1
+
+        self.stdout.write(
+            self.style.SUCCESS(
+                f"Done. moved={moved}, deleted={deleted}, skipped={skipped}, dry_run={dry_run}"
+            )
+        )
+
+    def _process_photo(
+        self,
+        photo: ContainerPhoto,
+        media_root: str,
+        base_dir: str,
+        *,
+        dry_run: bool,
+    ) -> str:
+        photo_rel = photo.photo.name if photo.photo else ""
+        thumb_rel = photo.thumbnail.name if photo.thumbnail else ""
+
+        photo_media_path = os.path.join(media_root, photo_rel) if photo_rel else ""
+        thumb_media_path = os.path.join(media_root, thumb_rel) if thumb_rel else ""
+
+        photo_exists = bool(photo_rel and os.path.exists(photo_media_path))
+        thumb_exists = bool(thumb_rel and os.path.exists(thumb_media_path))
+
+        if photo_exists or (thumb_rel and thumb_exists):
+            return "skipped"
+
+        # Try to find files in project root (BASE_DIR)
+        photo_root_path = os.path.join(base_dir, photo_rel) if photo_rel else ""
+        thumb_root_path = os.path.join(base_dir, thumb_rel) if thumb_rel else ""
+
+        moved_any = False
+
+        if photo_rel and os.path.exists(photo_root_path):
+            moved_any |= self._move_file(photo_root_path, photo_media_path, dry_run)
+
+        if thumb_rel and os.path.exists(thumb_root_path):
+            moved_any |= self._move_file(thumb_root_path, thumb_media_path, dry_run)
+
+        if moved_any:
+            return "moved"
+
+        # Nothing found -> delete record
+        if not dry_run:
+            photo.delete()
+        return "deleted"
+
+    def _move_file(self, src: str, dst: str, dry_run: bool) -> bool:
+        os.makedirs(os.path.dirname(dst), exist_ok=True)
+        if dry_run:
+            return True
+        shutil.move(src, dst)
+        return True
diff --git a/core/management/commands/sync_photos_gdrive.py b/core/management/commands/sync_photos_gdrive.py
index c5d3b7d..871f073 100644
--- a/core/management/commands/sync_photos_gdrive.py
+++ b/core/management/commands/sync_photos_gdrive.py
@@ -1,199 +1,199 @@
-"""
-Django management command –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å Google Drive.
-
-–í–ê–ñ–ù–û: –°–∫–ª–∞–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 1-2 —Å—É—Ç–æ–∫ –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏!
-–ü–æ—ç—Ç–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å --no-photos –∫–∞–∂–¥—ã–µ 2-4 —á–∞—Å–∞.
-
-–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
-    # –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –†–ï–ñ–ò–ú: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä–æ, –¥–ª—è —á–∞—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
-    python manage.py sync_photos_gdrive --no-photos
-    
-    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
-    python manage.py sync_photos_gdrive --recent
-    
-    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
-    python manage.py sync_photos_gdrive --container MSCU1234567
-    
-    # –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-    python manage.py sync_photos_gdrive --all
-
-–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–æ –∫—Ä–æ–Ω—É:
-    # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ë–ï–ó —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä–æ)
-    0 */3 * * * cd /path/to/project && python manage.py sync_photos_gdrive --no-photos >> /var/log/photo_sync.log 2>&1
-    
-    # –†–∞–∑ –≤ —Å—É—Ç–∫–∏ –Ω–æ—á—å—é - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –Ω–µ–¥–∞–≤–Ω–∏—Ö
-    0 3 * * * cd /path/to/project && python manage.py sync_photos_gdrive --recent >> /var/log/photo_sync.log 2>&1
-"""
-from django.core.management.base import BaseCommand, CommandError
-from core.google_drive_sync import GoogleDriveSync
-import logging
-
-logger = logging.getLogger(__name__)
-
-
-class Command(BaseCommand):
-    help = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å Google Drive'
-    
-    def add_arguments(self, parser):
-        parser.add_argument(
-            '--unloaded-delay',
-            action='store_true',
-            help='–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (—Å–º. --delay-hours)'
-        )
-        parser.add_argument(
-            '--delay-hours',
-            type=int,
-            default=12,
-            help='–ó–∞–¥–µ—Ä–∂–∫–∞ –≤ —á–∞—Å–∞—Ö –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ UNLOADED (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 12)'
-        )
-        parser.add_argument(
-            '--no-photos',
-            action='store_true',
-            help='[BEST] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–ï–ó —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º)'
-        )
-        parser.add_argument(
-            '--all',
-            action='store_true',
-            help='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—Å–∫–∞–Ω–∏—Ä—É–µ—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Google Drive)'
-        )
-        parser.add_argument(
-            '--recent',
-            action='store_true',
-            help='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π)'
-        )
-        parser.add_argument(
-            '--days',
-            type=int,
-            default=14,
-            help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è --recent –∏ --no-photos (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 14)'
-        )
-        parser.add_argument(
-            '--container',
-            type=str,
-            help='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –Ω–æ–º–µ—Ä—É'
-        )
-        parser.add_argument(
-            '--limit',
-            type=int,
-            help='–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)'
-        )
-        parser.add_argument(
-            '--verbose',
-            action='store_true',
-            help='–í—ã–≤–æ–¥–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é'
-        )
-    
-    def handle(self, *args, **options):
-        if options['verbose']:
-            logging.getLogger('core.google_drive_sync').setLevel(logging.DEBUG)
-        
-        self.stdout.write(self.style.NOTICE('=' * 60))
-        self.stdout.write(self.style.NOTICE('[SYNC] Google Drive Photo Sync'))
-        self.stdout.write(self.style.NOTICE('=' * 60))
-        
-        if options['container']:
-            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
-            container_number = options['container']
-            self.stdout.write(f'[CONTAINER] {container_number}')
-            
-            added = GoogleDriveSync.sync_container_by_number(container_number)
-            
-            if added > 0:
-                self.stdout.write(self.style.SUCCESS(f'[OK] Added {added} photos'))
-            else:
-                self.stdout.write(self.style.WARNING(f'[WARN] No new photos found'))
-        
-        elif options['unloaded_delay']:
-            delay_hours = options['delay_hours']
-            self.stdout.write(f'[DELAY] UNLOADED containers without photos (delay {delay_hours} hours)')
-
-            stats = GoogleDriveSync.sync_unloaded_containers_after_delay(hours=delay_hours)
-
-            self.stdout.write('')
-            self.stdout.write(self.style.SUCCESS('=' * 60))
-            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
-            self.stdout.write(f'   Containers checked: {stats["containers_checked"]}')
-            self.stdout.write(f'   With new photos: {stats["containers_with_new_photos"]}')
-            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
-            if stats['errors']:
-                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
-                for error in stats['errors'][:5]:
-                    self.stdout.write(self.style.ERROR(f'      - {error}'))
-
-        elif options['no_photos']:
-            # –ë–´–°–¢–†–´–ô –†–ï–ñ–ò–ú: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ
-            days = options['days']
-            self.stdout.write(f'[SEARCH] Containers WITHOUT photos (last {days} days)')
-            self.stdout.write(self.style.WARNING('   TIP: This mode is fast - run every 2-4 hours'))
-            
-            stats = GoogleDriveSync.sync_containers_without_photos(days=days)
-            
-            self.stdout.write('')
-            self.stdout.write(self.style.SUCCESS('=' * 60))
-            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
-            self.stdout.write(f'   Containers checked: {stats["containers_checked"]}')
-            self.stdout.write(f'   With new photos: {stats["containers_with_new_photos"]}')
-            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
-            if stats['errors']:
-                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
-                for error in stats['errors'][:5]:
-                    self.stdout.write(self.style.ERROR(f'      - {error}'))
-        
-        elif options['recent']:
-            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ–¥–∞–≤–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-            days = options['days']
-            self.stdout.write(f'[RECENT] Containers for last {days} days')
-            
-            stats = GoogleDriveSync.sync_recent_containers(days=days)
-            
-            self.stdout.write('')
-            self.stdout.write(self.style.SUCCESS('=' * 60))
-            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
-            self.stdout.write(f'   Containers processed: {stats["containers_processed"]}')
-            self.stdout.write(f'   With new photos: {stats["containers_with_new_photos"]}')
-            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
-            if stats['errors']:
-                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
-                for error in stats['errors'][:5]:
-                    self.stdout.write(self.style.ERROR(f'      - {error}'))
-        
-        elif options['all']:
-            # –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
-            self.stdout.write('[FULL] Full sync of all containers')
-            
-            if options['limit']:
-                self.stdout.write(f'   (limit: {options["limit"]} containers)')
-            
-            stats = GoogleDriveSync.sync_all_containers(limit=options['limit'])
-            
-            self.stdout.write('')
-            self.stdout.write(self.style.SUCCESS('=' * 60))
-            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
-            self.stdout.write(f'   Containers processed: {stats["containers_processed"]}')
-            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
-            self.stdout.write(f'   Not found in DB: {len(stats["containers_not_found"])}')
-            
-            if stats['containers_not_found']:
-                self.stdout.write(self.style.WARNING('   Not in DB:'))
-                for name in stats['containers_not_found'][:10]:
-                    self.stdout.write(f'      - {name}')
-                if len(stats['containers_not_found']) > 10:
-                    self.stdout.write(f'      ... and {len(stats["containers_not_found"]) - 10} more')
-            
-            if stats['errors']:
-                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
-                for error in stats['errors'][:5]:
-                    self.stdout.write(self.style.ERROR(f'      - {error}'))
-        
-        else:
-            raise CommandError(
-                'Specify sync mode:\n'
-                '  --unloaded-delay [NEW] containers UNLOADED after delay\n'
-                '  --no-photos  [BEST] only containers without photos (fast)\n'
-                '  --recent     - all recent containers\n'
-                '  --all        - full sync\n'
-                '  --container NUMBER - specific container'
-            )
-        
-        self.stdout.write(self.style.SUCCESS('=' * 60))
-        self.stdout.write(self.style.SUCCESS('[DONE] Sync completed'))
+"""
+Django management command –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å Google Drive.
+
+–í–ê–ñ–ù–û: –°–∫–ª–∞–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 1-2 —Å—É—Ç–æ–∫ –ø–æ—Å–ª–µ —Ä–∞–∑–≥—Ä—É–∑–∫–∏!
+–ü–æ—ç—Ç–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å --no-photos –∫–∞–∂–¥—ã–µ 2-4 —á–∞—Å–∞.
+
+–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
+    # –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –†–ï–ñ–ò–ú: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä–æ, –¥–ª—è —á–∞—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
+    python manage.py sync_photos_gdrive --no-photos
+    
+    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
+    python manage.py sync_photos_gdrive --recent
+    
+    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
+    python manage.py sync_photos_gdrive --container MSCU1234567
+    
+    # –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+    python manage.py sync_photos_gdrive --all
+
+–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–æ –∫—Ä–æ–Ω—É:
+    # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ë–ï–ó —Ñ–æ—Ç–æ (–±—ã—Å—Ç—Ä–æ)
+    0 */3 * * * cd /path/to/project && python manage.py sync_photos_gdrive --no-photos >> /var/log/photo_sync.log 2>&1
+    
+    # –†–∞–∑ –≤ —Å—É—Ç–∫–∏ –Ω–æ—á—å—é - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –Ω–µ–¥–∞–≤–Ω–∏—Ö
+    0 3 * * * cd /path/to/project && python manage.py sync_photos_gdrive --recent >> /var/log/photo_sync.log 2>&1
+"""
+from django.core.management.base import BaseCommand, CommandError
+from core.google_drive_sync import GoogleDriveSync
+import logging
+
+logger = logging.getLogger(__name__)
+
+
+class Command(BaseCommand):
+    help = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å Google Drive'
+    
+    def add_arguments(self, parser):
+        parser.add_argument(
+            '--unloaded-delay',
+            action='store_true',
+            help='–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (—Å–º. --delay-hours)'
+        )
+        parser.add_argument(
+            '--delay-hours',
+            type=int,
+            default=12,
+            help='–ó–∞–¥–µ—Ä–∂–∫–∞ –≤ —á–∞—Å–∞—Ö –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ UNLOADED (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 12)'
+        )
+        parser.add_argument(
+            '--no-photos',
+            action='store_true',
+            help='[BEST] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–ï–ó —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º)'
+        )
+        parser.add_argument(
+            '--all',
+            action='store_true',
+            help='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—Å–∫–∞–Ω–∏—Ä—É–µ—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Google Drive)'
+        )
+        parser.add_argument(
+            '--recent',
+            action='store_true',
+            help='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π)'
+        )
+        parser.add_argument(
+            '--days',
+            type=int,
+            default=14,
+            help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è --recent –∏ --no-photos (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 14)'
+        )
+        parser.add_argument(
+            '--container',
+            type=str,
+            help='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –Ω–æ–º–µ—Ä—É'
+        )
+        parser.add_argument(
+            '--limit',
+            type=int,
+            help='–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)'
+        )
+        parser.add_argument(
+            '--verbose',
+            action='store_true',
+            help='–í—ã–≤–æ–¥–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é'
+        )
+    
+    def handle(self, *args, **options):
+        if options['verbose']:
+            logging.getLogger('core.google_drive_sync').setLevel(logging.DEBUG)
+        
+        self.stdout.write(self.style.NOTICE('=' * 60))
+        self.stdout.write(self.style.NOTICE('[SYNC] Google Drive Photo Sync'))
+        self.stdout.write(self.style.NOTICE('=' * 60))
+        
+        if options['container']:
+            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
+            container_number = options['container']
+            self.stdout.write(f'[CONTAINER] {container_number}')
+            
+            added = GoogleDriveSync.sync_container_by_number(container_number)
+            
+            if added > 0:
+                self.stdout.write(self.style.SUCCESS(f'[OK] Added {added} photos'))
+            else:
+                self.stdout.write(self.style.WARNING(f'[WARN] No new photos found'))
+        
+        elif options['unloaded_delay']:
+            delay_hours = options['delay_hours']
+            self.stdout.write(f'[DELAY] UNLOADED containers without photos (delay {delay_hours} hours)')
+
+            stats = GoogleDriveSync.sync_unloaded_containers_after_delay(hours=delay_hours)
+
+            self.stdout.write('')
+            self.stdout.write(self.style.SUCCESS('=' * 60))
+            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
+            self.stdout.write(f'   Containers checked: {stats["containers_checked"]}')
+            self.stdout.write(f'   With new photos: {stats["containers_with_new_photos"]}')
+            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
+            if stats['errors']:
+                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
+                for error in stats['errors'][:5]:
+                    self.stdout.write(self.style.ERROR(f'      - {error}'))
+
+        elif options['no_photos']:
+            # –ë–´–°–¢–†–´–ô –†–ï–ñ–ò–ú: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ —Ñ–æ—Ç–æ
+            days = options['days']
+            self.stdout.write(f'[SEARCH] Containers WITHOUT photos (last {days} days)')
+            self.stdout.write(self.style.WARNING('   TIP: This mode is fast - run every 2-4 hours'))
+            
+            stats = GoogleDriveSync.sync_containers_without_photos(days=days)
+            
+            self.stdout.write('')
+            self.stdout.write(self.style.SUCCESS('=' * 60))
+            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
+            self.stdout.write(f'   Containers checked: {stats["containers_checked"]}')
+            self.stdout.write(f'   With new photos: {stats["containers_with_new_photos"]}')
+            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
+            if stats['errors']:
+                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
+                for error in stats['errors'][:5]:
+                    self.stdout.write(self.style.ERROR(f'      - {error}'))
+        
+        elif options['recent']:
+            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ–¥–∞–≤–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+            days = options['days']
+            self.stdout.write(f'[RECENT] Containers for last {days} days')
+            
+            stats = GoogleDriveSync.sync_recent_containers(days=days)
+            
+            self.stdout.write('')
+            self.stdout.write(self.style.SUCCESS('=' * 60))
+            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
+            self.stdout.write(f'   Containers processed: {stats["containers_processed"]}')
+            self.stdout.write(f'   With new photos: {stats["containers_with_new_photos"]}')
+            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
+            if stats['errors']:
+                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
+                for error in stats['errors'][:5]:
+                    self.stdout.write(self.style.ERROR(f'      - {error}'))
+        
+        elif options['all']:
+            # –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
+            self.stdout.write('[FULL] Full sync of all containers')
+            
+            if options['limit']:
+                self.stdout.write(f'   (limit: {options["limit"]} containers)')
+            
+            stats = GoogleDriveSync.sync_all_containers(limit=options['limit'])
+            
+            self.stdout.write('')
+            self.stdout.write(self.style.SUCCESS('=' * 60))
+            self.stdout.write(self.style.SUCCESS('[RESULTS]:'))
+            self.stdout.write(f'   Containers processed: {stats["containers_processed"]}')
+            self.stdout.write(f'   Photos added: {stats["photos_added"]}')
+            self.stdout.write(f'   Not found in DB: {len(stats["containers_not_found"])}')
+            
+            if stats['containers_not_found']:
+                self.stdout.write(self.style.WARNING('   Not in DB:'))
+                for name in stats['containers_not_found'][:10]:
+                    self.stdout.write(f'      - {name}')
+                if len(stats['containers_not_found']) > 10:
+                    self.stdout.write(f'      ... and {len(stats["containers_not_found"]) - 10} more')
+            
+            if stats['errors']:
+                self.stdout.write(self.style.ERROR(f'   Errors: {len(stats["errors"])}'))
+                for error in stats['errors'][:5]:
+                    self.stdout.write(self.style.ERROR(f'      - {error}'))
+        
+        else:
+            raise CommandError(
+                'Specify sync mode:\n'
+                '  --unloaded-delay [NEW] containers UNLOADED after delay\n'
+                '  --no-photos  [BEST] only containers without photos (fast)\n'
+                '  --recent     - all recent containers\n'
+                '  --all        - full sync\n'
+                '  --container NUMBER - specific container'
+            )
+        
+        self.stdout.write(self.style.SUCCESS('=' * 60))
+        self.stdout.write(self.style.SUCCESS('[DONE] Sync completed'))
diff --git a/core/migrations/0090_update_ths_payer_labels.py b/core/migrations/0090_update_ths_payer_labels.py
index b792f3d..1f35aa2 100644
--- a/core/migrations/0090_update_ths_payer_labels.py
+++ b/core/migrations/0090_update_ths_payer_labels.py
@@ -1,18 +1,18 @@
-# Generated by Django 5.1.7 on 2026-01-13 22:54
-
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0089_expand_vehicle_types_and_ths_system'),
-    ]
-
-    operations = [
-        migrations.AlterField(
-            model_name='container',
-            name='ths_payer',
-            field=models.CharField(choices=[('LINE', '–ù–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏'), ('WAREHOUSE', '–ß–µ—Ä–µ–∑ —Å–∫–ª–∞–¥')], default='LINE', help_text='–û—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°: –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥', max_length=20, verbose_name='–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑'),
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-13 22:54
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0089_expand_vehicle_types_and_ths_system'),
+    ]
+
+    operations = [
+        migrations.AlterField(
+            model_name='container',
+            name='ths_payer',
+            field=models.CharField(choices=[('LINE', '–ù–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏'), ('WAREHOUSE', '–ß–µ—Ä–µ–∑ —Å–∫–ª–∞–¥')], default='LINE', help_text='–û—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°: –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥', max_length=20, verbose_name='–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑'),
+        ),
+    ]
diff --git a/core/migrations/0091_remove_warehouse_rate.py b/core/migrations/0091_remove_warehouse_rate.py
index 9182df9..2478cc7 100644
--- a/core/migrations/0091_remove_warehouse_rate.py
+++ b/core/migrations/0091_remove_warehouse_rate.py
@@ -1,17 +1,17 @@
-# Generated by Django 5.1.7 on 2026-01-16 00:01
-
-from django.db import migrations
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0090_update_ths_payer_labels'),
-    ]
-
-    operations = [
-        migrations.RemoveField(
-            model_name='warehouse',
-            name='rate',
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-16 00:01
+
+from django.db import migrations
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0090_update_ths_payer_labels'),
+    ]
+
+    operations = [
+        migrations.RemoveField(
+            model_name='warehouse',
+            name='rate',
+        ),
+    ]
diff --git a/core/migrations/0092_remove_current_price.py b/core/migrations/0092_remove_current_price.py
index 792eeea..ce3640c 100644
--- a/core/migrations/0092_remove_current_price.py
+++ b/core/migrations/0092_remove_current_price.py
@@ -1,22 +1,22 @@
-# Generated by Django 5.1.7 on 2026-01-16 00:44
-
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0091_remove_warehouse_rate'),
-    ]
-
-    operations = [
-        migrations.RemoveField(
-            model_name='car',
-            name='current_price',
-        ),
-        migrations.AlterField(
-            model_name='car',
-            name='total_price',
-            field=models.DecimalField(decimal_places=2, default=0.0, max_digits=10, verbose_name='–¶–µ–Ω–∞'),
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-16 00:44
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0091_remove_warehouse_rate'),
+    ]
+
+    operations = [
+        migrations.RemoveField(
+            model_name='car',
+            name='current_price',
+        ),
+        migrations.AlterField(
+            model_name='car',
+            name='total_price',
+            field=models.DecimalField(decimal_places=2, default=0.0, max_digits=10, verbose_name='–¶–µ–Ω–∞'),
+        ),
+    ]
diff --git a/core/migrations/0093_rename_ths_percent_to_coefficient.py b/core/migrations/0093_rename_ths_percent_to_coefficient.py
index 5d9877a..b63b2c6 100644
--- a/core/migrations/0093_rename_ths_percent_to_coefficient.py
+++ b/core/migrations/0093_rename_ths_percent_to_coefficient.py
@@ -1,90 +1,90 @@
-# Generated by Django 5.1.7 on 2026-01-16
-
-from decimal import Decimal
-from django.db import migrations, models
-
-
-def convert_percent_to_coefficient(apps, schema_editor):
-    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã.
-    
-    –õ–æ–≥–∏–∫–∞: –ø—Ä–æ—Ü–µ–Ω—Ç 25% (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -> –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 1.0
-    –¢–æ –µ—Å—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25
-    
-    –ü—Ä–∏–º–µ—Ä—ã:
-    - 25% -> 1.0 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
-    - 50% -> 2.0 (–¥–≤–æ–π–Ω–æ–π)
-    - 12.5% -> 0.5 (–ø–æ–ª–æ–≤–∏–Ω–∞)
-    """
-    LineTHSPercent = apps.get_model('core', 'LineTHSPercent')
-    for obj in LineTHSPercent.objects.all():
-        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25
-        obj.percent = Decimal(str(obj.percent)) / Decimal('25')
-        obj.save()
-
-
-def convert_coefficient_to_percent(apps, schema_editor):
-    """–û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏."""
-    LineTHSPercent = apps.get_model('core', 'LineTHSPercent')
-    for obj in LineTHSPercent.objects.all():
-        # –û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: –ø—Ä–æ—Ü–µ–Ω—Ç = –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç * 25
-        obj.percent = Decimal(str(obj.percent)) * Decimal('25')
-        obj.save()
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0092_remove_current_price'),
-    ]
-
-    operations = [
-        # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
-        migrations.RunPython(convert_percent_to_coefficient, convert_coefficient_to_percent),
-        
-        # 2. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ percent -> coefficient
-        migrations.RenameField(
-            model_name='linethspercent',
-            old_name='percent',
-            new_name='coefficient',
-        ),
-        
-        # 3. –ò–∑–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—è
-        migrations.AlterField(
-            model_name='linethspercent',
-            name='coefficient',
-            field=models.DecimalField(
-                decimal_places=2,
-                default=1.0,
-                help_text='–í–µ—Å —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç, 2.0 = –¥–≤–æ–π–Ω–æ–π, 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞)',
-                max_digits=5,
-                verbose_name='–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç'
-            ),
-        ),
-        
-        # 4. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
-        migrations.RenameModel(
-            old_name='LineTHSPercent',
-            new_name='LineTHSCoefficient',
-        ),
-        
-        # 5. –û–±–Ω–æ–≤–ª—è–µ–º related_name
-        migrations.AlterField(
-            model_name='linethscoefficient',
-            name='line',
-            field=models.ForeignKey(
-                on_delete=models.CASCADE,
-                related_name='ths_coefficients',
-                to='core.line',
-                verbose_name='–õ–∏–Ω–∏—è'
-            ),
-        ),
-        
-        # 6. –û–±–Ω–æ–≤–ª—è–µ–º Meta
-        migrations.AlterModelOptions(
-            name='linethscoefficient',
-            options={
-                'verbose_name': '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°',
-                'verbose_name_plural': '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°',
-            },
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-16
+
+from decimal import Decimal
+from django.db import migrations, models
+
+
+def convert_percent_to_coefficient(apps, schema_editor):
+    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã.
+    
+    –õ–æ–≥–∏–∫–∞: –ø—Ä–æ—Ü–µ–Ω—Ç 25% (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -> –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 1.0
+    –¢–æ –µ—Å—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25
+    
+    –ü—Ä–∏–º–µ—Ä—ã:
+    - 25% -> 1.0 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
+    - 50% -> 2.0 (–¥–≤–æ–π–Ω–æ–π)
+    - 12.5% -> 0.5 (–ø–æ–ª–æ–≤–∏–Ω–∞)
+    """
+    LineTHSPercent = apps.get_model('core', 'LineTHSPercent')
+    for obj in LineTHSPercent.objects.all():
+        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç = –ø—Ä–æ—Ü–µ–Ω—Ç / 25
+        obj.percent = Decimal(str(obj.percent)) / Decimal('25')
+        obj.save()
+
+
+def convert_coefficient_to_percent(apps, schema_editor):
+    """–û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏."""
+    LineTHSPercent = apps.get_model('core', 'LineTHSPercent')
+    for obj in LineTHSPercent.objects.all():
+        # –û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: –ø—Ä–æ—Ü–µ–Ω—Ç = –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç * 25
+        obj.percent = Decimal(str(obj.percent)) * Decimal('25')
+        obj.save()
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0092_remove_current_price'),
+    ]
+
+    operations = [
+        # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
+        migrations.RunPython(convert_percent_to_coefficient, convert_coefficient_to_percent),
+        
+        # 2. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ percent -> coefficient
+        migrations.RenameField(
+            model_name='linethspercent',
+            old_name='percent',
+            new_name='coefficient',
+        ),
+        
+        # 3. –ò–∑–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—è
+        migrations.AlterField(
+            model_name='linethspercent',
+            name='coefficient',
+            field=models.DecimalField(
+                decimal_places=2,
+                default=1.0,
+                help_text='–í–µ—Å —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç, 2.0 = –¥–≤–æ–π–Ω–æ–π, 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞)',
+                max_digits=5,
+                verbose_name='–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç'
+            ),
+        ),
+        
+        # 4. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
+        migrations.RenameModel(
+            old_name='LineTHSPercent',
+            new_name='LineTHSCoefficient',
+        ),
+        
+        # 5. –û–±–Ω–æ–≤–ª—è–µ–º related_name
+        migrations.AlterField(
+            model_name='linethscoefficient',
+            name='line',
+            field=models.ForeignKey(
+                on_delete=models.CASCADE,
+                related_name='ths_coefficients',
+                to='core.line',
+                verbose_name='–õ–∏–Ω–∏—è'
+            ),
+        ),
+        
+        # 6. –û–±–Ω–æ–≤–ª—è–µ–º Meta
+        migrations.AlterModelOptions(
+            name='linethscoefficient',
+            options={
+                'verbose_name': '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°',
+                'verbose_name_plural': '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°',
+            },
+        ),
+    ]
diff --git a/core/migrations/0094_add_hide_markup_in_field.py b/core/migrations/0094_add_hide_markup_in_field.py
index 7e7617d..8b686a0 100644
--- a/core/migrations/0094_add_hide_markup_in_field.py
+++ b/core/migrations/0094_add_hide_markup_in_field.py
@@ -1,24 +1,24 @@
-# Generated by Django 5.1.7 on 2026-01-17 00:59
-
-import django.db.models.deletion
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0093_rename_ths_percent_to_coefficient'),
-    ]
-
-    operations = [
-        migrations.AddField(
-            model_name='car',
-            name='hide_markup_in',
-            field=models.ForeignKey(blank=True, help_text='–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –∏–Ω–≤–æ–π—Å–µ)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cars_with_hidden_markup', to='core.carservice', verbose_name='–°–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≤ —É—Å–ª—É–≥–µ'),
-        ),
-        migrations.AlterField(
-            model_name='car',
-            name='has_title',
-            field=models.BooleanField(default=False, verbose_name='–¢'),
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-17 00:59
+
+import django.db.models.deletion
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0093_rename_ths_percent_to_coefficient'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='car',
+            name='hide_markup_in',
+            field=models.ForeignKey(blank=True, help_text='–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –∏–Ω–≤–æ–π—Å–µ)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cars_with_hidden_markup', to='core.carservice', verbose_name='–°–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≤ —É—Å–ª—É–≥–µ'),
+        ),
+        migrations.AlterField(
+            model_name='car',
+            name='has_title',
+            field=models.BooleanField(default=False, verbose_name='–¢'),
+        ),
+    ]
diff --git a/core/migrations/0095_add_markup_distribution.py b/core/migrations/0095_add_markup_distribution.py
index 760c435..dc67e38 100644
--- a/core/migrations/0095_add_markup_distribution.py
+++ b/core/migrations/0095_add_markup_distribution.py
@@ -1,18 +1,18 @@
-# Generated by Django 5.1.7 on 2026-01-17 01:01
-
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0094_add_hide_markup_in_field'),
-    ]
-
-    operations = [
-        migrations.AddField(
-            model_name='carservice',
-            name='markup_amount',
-            field=models.DecimalField(decimal_places=2, default=0, help_text='–°—É–º–º–∞ –Ω–∞—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ (—Å–∫—Ä—ã—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)', max_digits=10, verbose_name='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞'),
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-17 01:01
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0094_add_hide_markup_in_field'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='carservice',
+            name='markup_amount',
+            field=models.DecimalField(decimal_places=2, default=0, help_text='–°—É–º–º–∞ –Ω–∞—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ (—Å–∫—Ä—ã—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)', max_digits=10, verbose_name='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞'),
+        ),
+    ]
diff --git a/core/migrations/0096_add_default_markup_to_services.py b/core/migrations/0096_add_default_markup_to_services.py
index a706cd5..7141acb 100644
--- a/core/migrations/0096_add_default_markup_to_services.py
+++ b/core/migrations/0096_add_default_markup_to_services.py
@@ -1,28 +1,28 @@
-# Generated by Django 5.1.7 on 2026-01-17 01:22
-
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0095_add_markup_distribution'),
-    ]
-
-    operations = [
-        migrations.AddField(
-            model_name='carrierservice',
-            name='default_markup',
-            field=models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
-        ),
-        migrations.AddField(
-            model_name='lineservice',
-            name='default_markup',
-            field=models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
-        ),
-        migrations.AddField(
-            model_name='warehouseservice',
-            name='default_markup',
-            field=models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-17 01:22
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0095_add_markup_distribution'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='carrierservice',
+            name='default_markup',
+            field=models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
+        ),
+        migrations.AddField(
+            model_name='lineservice',
+            name='default_markup',
+            field=models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
+        ),
+        migrations.AddField(
+            model_name='warehouseservice',
+            name='default_markup',
+            field=models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'),
+        ),
+    ]
diff --git a/core/migrations/0097_add_unloaded_status_at.py b/core/migrations/0097_add_unloaded_status_at.py
index c52dc7d..1b1bafe 100644
--- a/core/migrations/0097_add_unloaded_status_at.py
+++ b/core/migrations/0097_add_unloaded_status_at.py
@@ -25,4 +25,4 @@ class Migration(migrations.Migration):
             field=models.DateTimeField(blank=True, help_text="–†—ô–†—ï–†—ñ–†“ë–†¬∞ –†—î–†—ï–†–Ö–°‚Äö–†¬µ–†‚Ññ–†–Ö–†¬µ–°–Ç –†—ó–†—ï–†¬ª–°—ì–°‚Ä°–†—ë–†¬ª –°–É–°‚Äö–†¬∞–°‚Äö–°—ì–°–É '–†¬†–†¬∞–†¬∑–†—ñ–°–Ç–°—ì–†¬∂–†¬µ–†–Ö' (–†“ë–†¬ª–°–è –†¬∑–†¬∞–†“ë–†¬µ–°–Ç–†¬∂–†—î–†—ë –°–É–†—ë–†–Ö–°‚Ä¶–°–Ç–†—ï–†–Ö–†—ë–†¬∑–†¬∞–°‚Ä†–†—ë–†—ë –°‚Äû–†—ï–°‚Äö–†—ï)", null=True, verbose_name="–†–é–°‚Äö–†¬∞–°‚Äö–°—ì–°–É '–†¬†–†¬∞–†¬∑–†—ñ–°–Ç–°—ì–†¬∂–†¬µ–†–Ö' –°–É"),
         ),
         migrations.RunPython(backfill_unloaded_status_at, migrations.RunPython.noop),
-    ]
+    ]
diff --git a/core/migrations/0098_alter_container_unloaded_status_at.py b/core/migrations/0098_alter_container_unloaded_status_at.py
index 2649a2c..d2f1777 100644
--- a/core/migrations/0098_alter_container_unloaded_status_at.py
+++ b/core/migrations/0098_alter_container_unloaded_status_at.py
@@ -1,18 +1,18 @@
-# Generated by Django 5.1.7 on 2026-01-23 20:58
-
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0097_add_unloaded_status_at'),
-    ]
-
-    operations = [
-        migrations.AlterField(
-            model_name='container',
-            name='unloaded_status_at',
-            field=models.DateTimeField(blank=True, help_text="–ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' (–¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ)", null=True, verbose_name="–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å"),
-        ),
-    ]
+# Generated by Django 5.1.7 on 2026-01-23 20:58
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0097_add_unloaded_status_at'),
+    ]
+
+    operations = [
+        migrations.AlterField(
+            model_name='container',
+            name='unloaded_status_at',
+            field=models.DateTimeField(blank=True, help_text="–ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' (–¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ)", null=True, verbose_name="–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å"),
+        ),
+    ]
diff --git a/core/migrations/0099_add_default_flags_line_carrier_services.py b/core/migrations/0099_add_default_flags_line_carrier_services.py
index 44993ff..8146ac2 100644
--- a/core/migrations/0099_add_default_flags_line_carrier_services.py
+++ b/core/migrations/0099_add_default_flags_line_carrier_services.py
@@ -1,29 +1,29 @@
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0098_alter_container_unloaded_status_at'),
-    ]
-
-    operations = [
-        migrations.AddField(
-            model_name='lineservice',
-            name='add_by_default',
-            field=models.BooleanField(
-                default=False,
-                help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∏–∏',
-                verbose_name='–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
-            ),
-        ),
-        migrations.AddField(
-            model_name='carrierservice',
-            name='add_by_default',
-            field=models.BooleanField(
-                default=False,
-                help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞',
-                verbose_name='–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
-            ),
-        ),
-    ]
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0098_alter_container_unloaded_status_at'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='lineservice',
+            name='add_by_default',
+            field=models.BooleanField(
+                default=False,
+                help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∏–∏',
+                verbose_name='–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
+            ),
+        ),
+        migrations.AddField(
+            model_name='carrierservice',
+            name='add_by_default',
+            field=models.BooleanField(
+                default=False,
+                help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞',
+                verbose_name='–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
+            ),
+        ),
+    ]
diff --git a/core/migrations/0100_add_company_service.py b/core/migrations/0100_add_company_service.py
index 1ce2f98..9e02347 100644
--- a/core/migrations/0100_add_company_service.py
+++ b/core/migrations/0100_add_company_service.py
@@ -1,29 +1,29 @@
-from django.db import migrations, models
-import django.db.models.deletion
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ('core', '0099_add_default_flags_line_carrier_services'),
-    ]
-
-    operations = [
-        migrations.CreateModel(
-            name='CompanyService',
-            fields=[
-                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
-                ('name', models.CharField(max_length=200, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏')),
-                ('description', models.TextField(blank=True, verbose_name='–û–ø–∏—Å–∞–Ω–∏–µ')),
-                ('default_price', models.DecimalField(decimal_places=2, default=0, max_digits=10, verbose_name='–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
-                ('default_markup', models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
-                ('is_active', models.BooleanField(default=True, verbose_name='–ê–∫—Ç–∏–≤–Ω–∞')),
-                ('add_by_default', models.BooleanField(default=False, help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏', verbose_name='–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
-                ('company', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='services', to='core.company', verbose_name='–ö–æ–º–ø–∞–Ω–∏—è')),
-            ],
-            options={
-                'verbose_name': '–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏',
-                'verbose_name_plural': '–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π',
-            },
-        ),
-    ]
+from django.db import migrations, models
+import django.db.models.deletion
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0099_add_default_flags_line_carrier_services'),
+    ]
+
+    operations = [
+        migrations.CreateModel(
+            name='CompanyService',
+            fields=[
+                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
+                ('name', models.CharField(max_length=200, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏')),
+                ('description', models.TextField(blank=True, verbose_name='–û–ø–∏—Å–∞–Ω–∏–µ')),
+                ('default_price', models.DecimalField(decimal_places=2, default=0, max_digits=10, verbose_name='–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
+                ('default_markup', models.DecimalField(decimal_places=2, default=0, help_text='–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ', max_digits=10, verbose_name='–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
+                ('is_active', models.BooleanField(default=True, verbose_name='–ê–∫—Ç–∏–≤–Ω–∞')),
+                ('add_by_default', models.BooleanField(default=False, help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏', verbose_name='–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é')),
+                ('company', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='services', to='core.company', verbose_name='–ö–æ–º–ø–∞–Ω–∏—è')),
+            ],
+            options={
+                'verbose_name': '–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏',
+                'verbose_name_plural': '–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π',
+            },
+        ),
+    ]
diff --git a/core/migrations/0102_add_aichat_context_snapshot.py b/core/migrations/0102_add_aichat_context_snapshot.py
index e187f31..7f889dd 100644
--- a/core/migrations/0102_add_aichat_context_snapshot.py
+++ b/core/migrations/0102_add_aichat_context_snapshot.py
@@ -1,17 +1,17 @@
-# Generated by ChatGPT
-from django.db import migrations, models
-
-
-class Migration(migrations.Migration):
-
-    dependencies = [
-        ("core", "0101_alter_carservice_service_type_and_more"),
-    ]
-
-    operations = [
-        migrations.AddField(
-            model_name="aichat",
-            name="context_snapshot",
-            field=models.JSONField(blank=True, null=True, verbose_name="–ö–æ–Ω—Ç–µ–∫—Å—Ç"),
-        ),
-    ]
+# Generated by ChatGPT
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ("core", "0101_alter_carservice_service_type_and_more"),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name="aichat",
+            name="context_snapshot",
+            field=models.JSONField(blank=True, null=True, verbose_name="–ö–æ–Ω—Ç–µ–∫—Å—Ç"),
+        ),
+    ]
diff --git a/core/migrations/0103_carrier_eori_code_autotransport_and_more.py b/core/migrations/0103_carrier_eori_code_autotransport_and_more.py
new file mode 100644
index 0000000..78d5cae
--- /dev/null
+++ b/core/migrations/0103_carrier_eori_code_autotransport_and_more.py
@@ -0,0 +1,100 @@
+# Generated by Django 5.1.7 on 2026-02-04 18:23
+
+import django.db.models.deletion
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('core', '0102_add_aichat_context_snapshot'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='carrier',
+            name='eori_code',
+            field=models.CharField(blank=True, help_text='–ö–æ–¥ EORI –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è', max_length=50, null=True, verbose_name='EORI –∫–æ–¥'),
+        ),
+        migrations.CreateModel(
+            name='AutoTransport',
+            fields=[
+                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
+                ('number', models.CharField(help_text='–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞', max_length=50, unique=True, verbose_name='–ù–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞')),
+                ('status', models.CharField(choices=[('DRAFT', '–ß–µ—Ä–Ω–æ–≤–∏–∫'), ('FORMED', '–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω'), ('LOADED', '–ó–∞–≥—Ä—É–∂–µ–Ω'), ('IN_TRANSIT', '–í –ø—É—Ç–∏'), ('DELIVERED', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'), ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω')], default='DRAFT', max_length=20, verbose_name='–°—Ç–∞—Ç—É—Å')),
+                ('eori_code', models.CharField(blank=True, help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞', max_length=50, verbose_name='EORI –∫–æ–¥')),
+                ('truck_number_manual', models.CharField(blank=True, help_text='–ï—Å–ª–∏ –∞–≤—Ç–æ–≤–æ–∑–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ', max_length=20, verbose_name='–ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞ (–≤—Ä—É—á–Ω—É—é)')),
+                ('trailer_number_manual', models.CharField(blank=True, help_text='–ï—Å–ª–∏ –∞–≤—Ç–æ–≤–æ–∑–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ', max_length=20, verbose_name='–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞ (–≤—Ä—É—á–Ω—É—é)')),
+                ('driver_name_manual', models.CharField(blank=True, help_text='–ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ', max_length=100, verbose_name='–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è (–≤—Ä—É—á–Ω—É—é)')),
+                ('driver_phone', models.CharField(blank=True, help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ –≤–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –≤–≤–æ–¥–∏—Ç—Å—è –≤—Ä—É—á–Ω—É—é', max_length=20, verbose_name='–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è')),
+                ('border_crossing', models.CharField(blank=True, help_text='–ù–∞–∑–≤–∞–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü—ã', max_length=100, verbose_name='–ì—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è')),
+                ('loading_date', models.DateField(blank=True, null=True, verbose_name='–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏')),
+                ('departure_date', models.DateField(blank=True, null=True, verbose_name='–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è')),
+                ('estimated_delivery_date', models.DateField(blank=True, null=True, verbose_name='–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏')),
+                ('actual_delivery_date', models.DateField(blank=True, null=True, verbose_name='–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏')),
+                ('notes', models.TextField(blank=True, verbose_name='–ü—Ä–∏–º–µ—á–∞–Ω–∏—è')),
+                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
+                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
+                ('created_by', models.CharField(blank=True, max_length=100, verbose_name='–°–æ–∑–¥–∞–ª')),
+                ('carrier', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='auto_transports', to='core.carrier', verbose_name='–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫')),
+                ('cars', models.ManyToManyField(blank=True, related_name='auto_transports', to='core.car', verbose_name='–ê–≤—Ç–æ–º–æ–±–∏–ª–∏')),
+            ],
+            options={
+                'verbose_name': '–ê–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É',
+                'verbose_name_plural': '–ê–≤—Ç–æ–≤–æ–∑—ã –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É',
+                'ordering': ['-created_at'],
+            },
+        ),
+        migrations.AddField(
+            model_name='newinvoice',
+            name='auto_transport',
+            field=models.ForeignKey(blank=True, help_text='–ê–≤—Ç–æ–≤–æ–∑, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω —ç—Ç–æ—Ç –∏–Ω–≤–æ–π—Å', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='invoices', to='core.autotransport', verbose_name='–ê–≤—Ç–æ–≤–æ–∑'),
+        ),
+        migrations.CreateModel(
+            name='CarrierDriver',
+            fields=[
+                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
+                ('first_name', models.CharField(max_length=50, verbose_name='–ò–º—è')),
+                ('last_name', models.CharField(max_length=50, verbose_name='–§–∞–º–∏–ª–∏—è')),
+                ('phone', models.CharField(max_length=20, verbose_name='–¢–µ–ª–µ—Ñ–æ–Ω')),
+                ('is_active', models.BooleanField(default=True, verbose_name='–ê–∫—Ç–∏–≤–µ–Ω')),
+                ('notes', models.TextField(blank=True, verbose_name='–ü—Ä–∏–º–µ—á–∞–Ω–∏—è')),
+                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
+                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')),
+                ('carrier', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='drivers', to='core.carrier', verbose_name='–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫')),
+            ],
+            options={
+                'verbose_name': '–í–æ–¥–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞',
+                'verbose_name_plural': '–í–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤',
+                'ordering': ['last_name', 'first_name'],
+            },
+        ),
+        migrations.AddField(
+            model_name='autotransport',
+            name='driver',
+            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='transports', to='core.carrierdriver', verbose_name='–í–æ–¥–∏—Ç–µ–ª—å'),
+        ),
+        migrations.CreateModel(
+            name='CarrierTruck',
+            fields=[
+                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
+                ('truck_number', models.CharField(help_text='–ù–æ–º–µ—Ä –≥–æ–ª–æ–≤—ã –∞–≤—Ç–æ–≤–æ–∑–∞', max_length=20, verbose_name='–ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞')),
+                ('trailer_number', models.CharField(blank=True, help_text='–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', max_length=20, verbose_name='–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞')),
+                ('is_active', models.BooleanField(default=True, verbose_name='–ê–∫—Ç–∏–≤–µ–Ω')),
+                ('notes', models.TextField(blank=True, verbose_name='–ü—Ä–∏–º–µ—á–∞–Ω–∏—è')),
+                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è')),
+                ('carrier', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='trucks', to='core.carrier', verbose_name='–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫')),
+            ],
+            options={
+                'verbose_name': '–ê–≤—Ç–æ–≤–æ–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞',
+                'verbose_name_plural': '–ê–≤—Ç–æ–≤–æ–∑—ã –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤',
+                'ordering': ['-created_at'],
+                'unique_together': {('carrier', 'truck_number', 'trailer_number')},
+            },
+        ),
+        migrations.AddField(
+            model_name='autotransport',
+            name='truck',
+            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='transports', to='core.carriertruck', verbose_name='–ê–≤—Ç–æ–≤–æ–∑'),
+        ),
+    ]
diff --git a/core/models.py b/core/models.py
index 1274c21..3935691 100644
--- a/core/models.py
+++ b/core/models.py
@@ -1,1341 +1,1557 @@
-from django.db import models
-from django.core.validators import MinValueValidator
-from .constants import STATUS_COLORS
-from django.utils import timezone
-from channels.layers import get_channel_layer
-from asgiref.sync import async_to_sync
-from django.db.models import Sum, Q
-from django.db import transaction
-from decimal import Decimal
-import logging
-
-from datetime import timedelta
-
-# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
-from .managers import (
-    OptimizedCarManager, OptimizedContainerManager, OptimizedClientManager, 
-    OptimizedWarehouseManager, OptimizedCompanyManager
-)
-
-
-
-logger = logging.getLogger('django')
-
-def get_current_user():
-    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
-    from django.contrib.auth.models import AnonymousUser
-    from django.contrib.auth import get_user
-    
-    try:
-        user = get_user()
-        if user.is_authenticated:
-            return user.username
-        return 'system'
-    except:
-        return 'system'
-
-# –ë–∞–∑–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
-class BaseManager(models.Manager):
-    def update_related(self, instance):
-        pass
-
-# –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –±–∞–ª–∞–Ω—Å–æ–≤
-
-
-
-# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
-class Line(models.Model):
-    name = models.CharField(max_length=100, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏")
-    
-    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
-    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
-                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
-    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
-    
-    # –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã
-    ocean_freight_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∑–∞ –∞–≤—Ç–æ)")
-    documentation_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
-    handling_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏")
-    ths_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="THS —Å–±–æ—Ä (–æ–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º)")
-    additional_fees = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã")
-
-    class Meta:
-        verbose_name = "–õ–∏–Ω–∏—è"
-        verbose_name_plural = "–õ–∏–Ω–∏–∏"
-
-    def __str__(self):
-        return self.name
-
-
-class LineTHSCoefficient(models.Model):
-    """–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–° —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–∏–Ω–∏–∏.
-    
-    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ–∂–¥—É –¢–°
-    –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö "–≤–µ—Å—É" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É).
-    
-    –ü—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR
-    3 –º–∞—à–∏–Ω—ã: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(2.0) + –º–æ—Ç–æ(0.5) = —Å—É–º–º–∞ –≤–µ—Å–æ–≤ 3.5
-    - –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/3.5) = 143 EUR
-    - –î–∂–∏–ø: 500 √ó (2.0/3.5) = 286 EUR  
-    - –ú–æ—Ç–æ: 500 √ó (0.5/3.5) = 71 EUR
-    """
-    # –¢–∏–ø—ã –¢–° –¥—É–±–ª–∏—Ä—É–µ–º –∑–¥–µ—Å—å —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
-    VEHICLE_TYPE_CHOICES = [
-        ('SEDAN', '–õ–µ–≥–∫–æ–≤–æ–π'),
-        ('CROSSOVER', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä'),
-        ('SUV', '–î–∂–∏–ø'),
-        ('PICKUP', '–ü–∏–∫–∞–ø'),
-        ('NEW_CAR', '–ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞'),
-        ('MOTO', '–ú–æ—Ç–æ—Ü–∏–∫–ª'),
-        ('BIG_MOTO', '–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª'),
-        ('ATV', '–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏'),
-        ('BOAT', '–õ–æ–¥–∫–∞'),
-        ('RV', '–ê–≤—Ç–æ–¥–æ–º (RV)'),
-        ('CONSTRUCTION', '–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞'),
-    ]
-    
-    line = models.ForeignKey(Line, on_delete=models.CASCADE, related_name='ths_coefficients', verbose_name="–õ–∏–Ω–∏—è")
-    vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, verbose_name="–¢–∏–ø –¢–°")
-    coefficient = models.DecimalField(max_digits=5, decimal_places=2, default=1.00, 
-                                      verbose_name="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç",
-                                      help_text="–í–µ—Å —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç, 2.0 = –¥–≤–æ–π–Ω–æ–π, 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞)")
-    
-    class Meta:
-        verbose_name = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°"
-        verbose_name_plural = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°"
-        unique_together = ['line', 'vehicle_type']
-    
-    def __str__(self):
-        return f"{self.line.name} - {self.get_vehicle_type_display()}: √ó{self.coefficient}"
-
-
-class Carrier(models.Model):
-    name = models.CharField(max_length=100, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞")
-    short_name = models.CharField(max_length=20, blank=True, null=True, verbose_name="–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ")
-    contact_person = models.CharField(max_length=100, blank=True, null=True, verbose_name="–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ")
-    phone = models.CharField(max_length=20, blank=True, null=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
-    email = models.EmailField(blank=True, null=True, verbose_name="Email")
-    
-    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
-    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
-                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
-    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
-    
-    # –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã
-    transport_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∑–∞ –∫–º)")
-    loading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–≥—Ä—É–∑–∫–∏")
-    unloading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–≥—Ä—É–∑–∫–∏")
-    fuel_surcharge = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–¢–æ–ø–ª–∏–≤–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞")
-    additional_fees = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
-    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
-    
-    objects = OptimizedCompanyManager()
-    
-    class Meta:
-        verbose_name = "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫"
-        verbose_name_plural = "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏"
-    
-    def __str__(self):
-        return self.name
-
-
-class Client(models.Model):
-    name = models.CharField(max_length=100, verbose_name="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞")
-    email = models.EmailField(blank=True, null=True, verbose_name="Email 1",
-                              help_text="–û—Å–Ω–æ–≤–Ω–æ–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤")
-    email2 = models.EmailField(blank=True, null=True, verbose_name="Email 2",
-                               help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
-    email3 = models.EmailField(blank=True, null=True, verbose_name="Email 3",
-                               help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
-    email4 = models.EmailField(blank=True, null=True, verbose_name="Email 4",
-                               help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
-    notification_enabled = models.BooleanField(default=True, verbose_name="–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
-                                               help_text="–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö")
-
-    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
-    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å", 
-                                   help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥")
-    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
-    
-    objects = OptimizedClientManager()
-    
-    class Meta:
-        verbose_name = "–ö–ª–∏–µ–Ω—Ç"
-        verbose_name_plural = "–ö–ª–∏–µ–Ω—Ç—ã"
-    
-    def __str__(self):
-        return self.name
-    
-    def get_notification_emails(self):
-        """
-        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö email-–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
-        –ü—É—Å—Ç—ã–µ –∏ None –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è.
-        """
-        emails = []
-        for field in [self.email, self.email2, self.email3, self.email4]:
-            if field and field.strip():
-                emails.append(field.strip())
-        return emails
-    
-    def has_notification_emails(self):
-        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
-        return len(self.get_notification_emails()) > 0
-    
-    @property
-    def balance_status(self):
-        """–°—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
-        if self.balance > 0:
-            return "–ü–ï–†–ï–ü–õ–ê–¢–ê"
-        elif self.balance < 0:
-            return "–î–û–õ–ì"
-        return "–ë–ê–õ–ê–ù–°"
-    
-    @property
-    def balance_color(self):
-        """–¶–≤–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞"""
-        if self.balance > 0:
-            return "#28a745"  # –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
-        elif self.balance < 0:
-            return "#dc3545"  # –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –¥–æ–ª–≥–∞
-        return "#6c757d"  # —Å–µ—Ä—ã–π –¥–ª—è –Ω—É–ª—è
-
-class Warehouse(models.Model):
-    name = models.CharField(max_length=100, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞")
-    address = models.CharField(max_length=300, blank=True, verbose_name="–ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞")
-    
-    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
-    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
-                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
-    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
-
-    # –¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏
-    default_unloading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É")
-    free_days = models.PositiveIntegerField(default=0, verbose_name="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
-    # –£–î–ê–õ–ï–ù–û: rate - —Å—Ç–∞–≤–∫–∞ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" (WarehouseService)
-    complex_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ö–æ–º–ø–ª–µ–∫—Å",validators=[MinValueValidator(0)])
-    delivery_to_warehouse = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞")
-    loading_on_trawl = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª")
-    documents_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–î–æ–∫—É–º–µ–Ω—Ç—ã")
-    transfer_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É")
-    transit_declaration = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.")
-    export_declaration = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.")
-    additional_expenses = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã")
-
-    objects = OptimizedWarehouseManager()
-    
-    class Meta:
-        verbose_name = "–°–∫–ª–∞–¥"
-        verbose_name_plural = "–°–∫–ª–∞–¥—ã"
-
-    def __str__(self):
-        return self.name
-
-# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
-class ContainerManager(BaseManager):
-    def update_related(self, instance):
-        cars = instance.container_cars.all()
-        if not cars:
-            return
-        ths_per_car = (instance.ths or 0) / cars.count()
-        for car in cars:
-            car.sync_with_container(instance, ths_per_car)
-            car.save()
-
-class Container(models.Model):
-    STATUS_CHOICES = [
-        ('FLOATING', '–í –ø—É—Ç–∏'),
-        ('IN_PORT', '–í –ø–æ—Ä—Ç—É'),
-        ('UNLOADED', '–†–∞–∑–≥—Ä—É–∂–µ–Ω'),
-        ('TRANSFERRED', '–ü–µ—Ä–µ–¥–∞–Ω'),
-    ]
-
-    def get_status_color(self):
-        return STATUS_COLORS.get(self.status, '#3a8c3d')  # –¢–µ–º–Ω–µ–µ –∑–µ–ª—ë–Ω–æ–≥–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
-
-    CUSTOMS_PROCEDURE_CHOICES = (
-        ('TRANSIT', '–¢—Ä–∞–Ω–∑–∏—Ç'),
-        ('IMPORT', '–ò–º–ø–æ—Ä—Ç'),
-        ('REEXPORT', '–†–µ—ç–∫—Å–ø–æ—Ä—Ç'),
-        ('EXPORT', '–≠–∫—Å–ø–æ—Ä—Ç'),
-    )
-
-    number = models.CharField(max_length=100, unique=True, verbose_name="–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞")
-    status = models.CharField(max_length=50, choices=STATUS_CHOICES, default='FLOATING', verbose_name="–°—Ç–∞—Ç—É—Å")
-    line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è")
-    eta = models.DateField(null=True, blank=True, verbose_name="ETA")
-    client = models.ForeignKey('Client', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–ª–∏–µ–Ω—Ç")
-    customs_procedure = models.CharField(max_length=20, choices=CUSTOMS_PROCEDURE_CHOICES, null=True, blank=True,
-                                         verbose_name="–¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞")
-    THS_PAYER_CHOICES = [
-        ('LINE', '–ù–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏'),
-        ('WAREHOUSE', '–ß–µ—Ä–µ–∑ —Å–∫–ª–∞–¥'),
-    ]
-    
-    ths = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–û–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º",
-                              validators=[MinValueValidator(0)])
-    ths_payer = models.CharField(max_length=20, choices=THS_PAYER_CHOICES, default='LINE',
-                                 verbose_name="–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑",
-                                 help_text="–û—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°: –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥")
-    sklad = models.DecimalField(max_digits=10, decimal_places=2, default=160, verbose_name="–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É",
-                                validators=[MinValueValidator(0)])
-    dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è",
-                               validators=[MinValueValidator(0)])
-    proft = models.DecimalField(max_digits=10, decimal_places=2, default=20, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞",
-                                validators=[MinValueValidator(0)])
-    warehouse = models.ForeignKey('Warehouse', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–°–∫–ª–∞–¥")
-    planned_unload_date = models.DateField(null=True, blank=True, verbose_name="–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å",
-                                           help_text="–£–∫–∞–∂–∏—Ç–µ –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)")
-    unload_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏")
-    unloaded_status_at = models.DateTimeField(
-        null=True,
-        blank=True,
-        verbose_name="–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å",
-        help_text="–ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' (–¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ)"
-    )
-    free_days = models.PositiveIntegerField(default=0, verbose_name="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
-    days = models.PositiveIntegerField(default=0, verbose_name="–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
-    rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name="–°—Ç–∞–≤–∫–∞",
-                               validators=[MinValueValidator(0)])
-    storage_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–°–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ")
-    notes = models.CharField(max_length=200, blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
-    
-    # Google Drive integration
-    google_drive_folder_url = models.URLField(max_length=500, blank=True, verbose_name="Google Drive –ø–∞–ø–∫–∞", 
-                                               help_text="–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Google Drive")
-
-    objects = OptimizedContainerManager()
-    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
-    legacy_objects = ContainerManager()
-
-    def update_days_and_storage(self):
-        if self.status == 'UNLOADED' and self.unload_date:
-            total_days = (timezone.now().date() - self.unload_date).days + 1
-            self.days = max(0, total_days - self.free_days)
-            self.storage_cost = self.days * (self.rate or 0)
-        else:
-            self.days = 0
-            self.storage_cost = 0
-
-    def sync_cars(self):
-        self.update_days_and_storage()
-        Container.objects.update_related(self)
-
-    def save(self, *args, **kwargs):
-        if self.status == 'UNLOADED' and (not self.warehouse or not self.unload_date):
-            raise ValueError("–î–ª—è —Å—Ç–∞—Ç—É—Å–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'")
-        super().save(*args, **kwargs)
-
-    def sync_cars_after_warehouse_change(self):
-        """
-        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥ –∫–æ –≤—Å–µ–º –∞–≤—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
-        - —Å—Ç–∞–≤–∏—Ç warehouse
-        - –∂—ë—Å—Ç–∫–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ –ø–æ–ª—è –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
-        - –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
-        - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—É–º–º—ã
-        """
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
-        if not self.pk:
-            return
-            
-        for car in self.container_cars.all():
-            car.warehouse = self.warehouse
-            car.apply_warehouse_defaults(force=True)  # –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å rate/free_days –∏ –ø—Ä–æ—á–µ–µ
-            # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
-            if self.unload_date:
-                car.unload_date = self.unload_date
-                logger.debug(f"Car {car.vin}: forced unload_date={self.unload_date} from container {self.number}")
-            car.update_days_and_storage()
-            car.calculate_total_price()
-            car.save()
-
-    def sync_cars_after_edit(self):
-        """
-        –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –º–∞—à–∏–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
-        ‚Äî –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ —É –∞–≤—Ç–æ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ,
-        ‚Äî –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ),
-        ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (rate/free_days/–∏ —Ç.–¥.) –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö/–¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö,
-        ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ü–µ–Ω—ã.
-        """
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
-        if not self.pk:
-            return
-            
-        from .models import Car  # –µ—Å–ª–∏ —Ñ–∞–π–ª –æ–±—â–∏–π, –∏–º–ø–æ—Ä—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
-        for car in self.container_cars.all():
-            changed = False
-
-            # –±–∞–∑–æ–≤—ã–µ —Å–≤—è–∑–∫–∏
-            if not car.warehouse and self.warehouse:
-                car.warehouse = self.warehouse
-                changed = True
-            if not car.client and self.client:
-                car.client = self.client
-                changed = True
-            
-            # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
-            if self.unload_date:
-                if car.unload_date != self.unload_date:
-                    car.unload_date = self.unload_date
-                    changed = True
-                    logger.info(f"Car {car.vin}: forced unload_date update to {self.unload_date} from container {self.number}")
-
-            # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ/–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
-            if car.warehouse:
-                before_rate = car.rate
-                before_free = car.free_days
-                car.apply_warehouse_defaults(override_on_defaults=True)
-                changed = changed or (car.rate != before_rate or car.free_days != before_free)
-
-            # –ø–µ—Ä–µ—Å—á—ë—Ç
-            car.update_days_and_storage()
-            car.calculate_total_price()
-
-            if changed:
-                car.save()  # —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç WS-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —É —Ç–µ–±—è —ç—Ç–æ –≤ save()
-            else:
-                # –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å—Ç–æ–∏–º–æ—Å—Ç—å/–¥–Ω–∏ –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –¥–∞—Ç—ã
-                car.save(update_fields=['storage_cost', 'days', 'total_price'])
-
-    def check_and_update_status_from_cars(self):
-        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"""
-        if not self.pk:
-            return
-            
-        cars = self.container_cars.all()
-        if not cars.exists():
-            return
-            
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω"
-        all_transferred = all(car.status == 'TRANSFERRED' for car in cars)
-        
-        if all_transferred and self.status != 'TRANSFERRED':
-            self.status = 'TRANSFERRED'
-            self.save(update_fields=['status'])
-            logger.info(f"Container {self.number} status automatically changed to TRANSFERRED")
-
-    def __str__(self):
-        return self.number
-
-    class Meta:
-        verbose_name = "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä"
-        verbose_name_plural = "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
-        indexes = [
-            models.Index(fields=['status']),
-            models.Index(fields=['client', 'status']),
-            models.Index(fields=['warehouse', 'status']),
-            models.Index(fields=['line']),
-            models.Index(fields=['eta']),
-            models.Index(fields=['unload_date']),
-        ]
-
-# –ê–≤—Ç–æ–º–æ–±–∏–ª–∏
-class CarManager(BaseManager):
-    pass
-
-
-class Car(models.Model):
-    # –¢–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
-    VEHICLE_TYPE_CHOICES = [
-        ('SEDAN', '–õ–µ–≥–∫–æ–≤–æ–π'),
-        ('CROSSOVER', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä'),
-        ('SUV', '–î–∂–∏–ø'),
-        ('PICKUP', '–ü–∏–∫–∞–ø'),
-        ('NEW_CAR', '–ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞'),
-        ('MOTO', '–ú–æ—Ç–æ—Ü–∏–∫–ª'),
-        ('BIG_MOTO', '–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª'),
-        ('ATV', '–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏'),
-        ('BOAT', '–õ–æ–¥–∫–∞'),
-        ('RV', '–ê–≤—Ç–æ–¥–æ–º (RV)'),
-        ('CONSTRUCTION', '–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞'),
-    ]
-    
-    year = models.PositiveIntegerField(verbose_name="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞")
-    brand = models.CharField(max_length=50, verbose_name="–ú–∞—Ä–∫–∞")
-    vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, default='SEDAN', verbose_name="–¢–∏–ø –¢–°")
-    vin = models.CharField(max_length=17, unique=True, verbose_name="VIN")
-    client = models.ForeignKey('Client', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–ª–∏–µ–Ω—Ç")
-    status = models.CharField(max_length=20, choices=Container.STATUS_CHOICES, verbose_name="–°—Ç–∞—Ç—É—Å")
-    warehouse = models.ForeignKey('Warehouse', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–°–∫–ª–∞–¥")
-    line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–õ–∏–Ω–∏—è")
-    carrier = models.ForeignKey('Carrier', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
-    unload_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏")
-    transfer_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏")
-    has_title = models.BooleanField(default=False, verbose_name="–¢")
-    title_notes = models.CharField(max_length=200, blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ —Ç–∞–π—Ç–ª—É")
-    total_price = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–¶–µ–Ω–∞")
-    # –£–î–ê–õ–ï–ù–û: current_price - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ total_price
-    storage_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ")
-    days = models.PositiveIntegerField(default=0, verbose_name="–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
-    container = models.ForeignKey('Container', on_delete=models.CASCADE, related_name="container_cars", null=True, blank=True, verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
-
-    # –†–∞—Å—Ö–æ–¥—ã
-    ths = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–û–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º", validators=[MinValueValidator(0)])
-    unload_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É", validators=[MinValueValidator(0)])
-    delivery_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞", validators=[MinValueValidator(0)])
-    loading_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª", validators=[MinValueValidator(0)])
-    docs_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ–∫—É–º–µ–Ω—Ç—ã", validators=[MinValueValidator(0)])
-    transfer_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É", validators=[MinValueValidator(0)])
-    transit_declaration = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.", validators=[MinValueValidator(0)])
-    export_declaration = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.", validators=[MinValueValidator(0)])
-    extra_costs = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã", validators=[MinValueValidator(0)])
-    dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è", validators=[MinValueValidator(0)])
-    proft = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal('20.00'), null=True, blank=True, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞", validators=[MinValueValidator(0)])
-    hide_markup_in = models.ForeignKey(
-        'CarService', 
-        on_delete=models.SET_NULL, 
-        null=True, 
-        blank=True, 
-        related_name='cars_with_hidden_markup',
-        verbose_name="–°–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≤ —É—Å–ª—É–≥–µ",
-        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –∏–Ω–≤–æ–π—Å–µ)"
-    )
-    free_days = models.PositiveIntegerField(default=0, verbose_name="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
-    rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name="–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏", validators=[MinValueValidator(0)])
-    complex_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ö–æ–º–ø–ª–µ–∫—Å", validators=[MinValueValidator(0)])
-    price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¶–µ–Ω–∞", validators=[MinValueValidator(0)])
-    auction_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ê—É–∫—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä", validators=[MinValueValidator(0)])
-    transport_usa = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –°–®–ê", validators=[MinValueValidator(0)])
-    ocean_freight = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–û–∫–µ–∞–Ω—Å–∫–∏–π —Ñ—Ä–∞—Ö—Ç", validators=[MinValueValidator(0)])
-    transport_kz = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ö–ó", validators=[MinValueValidator(0)])
-    broker_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å–±–æ—Ä", validators=[MinValueValidator(0)])
-    additional_expenses = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã", validators=[MinValueValidator(0)])
-
-    objects = OptimizedCarManager()
-    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
-    legacy_objects = CarManager()
-
-    def get_status_color(self):
-        return STATUS_COLORS.get(self.status, '#3a8c3d')
-
-    def apply_warehouse_defaults(self, force: bool = False):
-        """
-        –ö–æ–ø–∏—Ä—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ –≤ –∞–≤—Ç–æ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥.
-        force=True ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Å–∫–ª–∞–¥–∞.
-        force=False ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ –¥–µ—Ñ–æ–ª—Ç—É –º–æ–¥–µ–ª–∏.
-        """
-        if not self.warehouse:
-            return
-
-        from decimal import Decimal
-
-        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
-        warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True)
-        
-        # –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π —É—Å–ª—É–≥ –Ω–∞ –ø–æ–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
-        service_mapping = {
-            '–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É': 'unload_fee',
-            '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞': 'delivery_fee', 
-            '–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª': 'loading_fee',
-            '–î–æ–∫—É–º–µ–Ω—Ç—ã': 'docs_fee',
-            '–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É': 'transfer_fee',
-            '–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.': 'transit_declaration',
-            '–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.': 'export_declaration',
-            '–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã': 'extra_costs',
-            '–ö–æ–º–ø–ª–µ–∫—Å': 'complex_fee',
-            '–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏': 'rate',
-            '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏': 'free_days',
-        }
-
-        for service in warehouse_services:
-            car_field = service_mapping.get(service.name)
-            if car_field:
-                wh_val = service.default_price or 0
-                cur_val = getattr(self, car_field, None)
-
-                if force:
-                    setattr(self, car_field, wh_val)
-                else:
-                    if cur_val is None:
-                        setattr(self, car_field, wh_val)
-                    else:
-                        try:
-                            cur = Decimal(str(cur_val))
-                            if cur == 0:
-                                setattr(self, car_field, wh_val)
-                            else:
-                                model_default = self._meta.get_field(car_field).default
-                                mdl = Decimal(str(model_default or 0))
-                                if cur == mdl:
-                                    setattr(self, car_field, wh_val)
-                        except Exception:
-                            setattr(self, car_field, wh_val)
-
-
-
-    def warehouse_details(self):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ –∏–∑ —Å–∫–ª–∞–¥–∞ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥."""
-        if not self.warehouse:
-            return {"message": "–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}
-        
-        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
-        warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True)
-        
-        details = {"–ù–∞–∑–≤–∞–Ω–∏–µ": self.warehouse.name}
-        for service in warehouse_services:
-            details[service.name] = str(service.default_price)
-        
-        return details
-
-    def set_initial_warehouse_values(self):
-        """–ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ.
-        –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –º–æ–¥–µ–ª—å–Ω–æ–º—É –¥–µ—Ñ–æ–ª—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, rate=5) –∏–ª–∏ 0 ‚Äî –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞.
-        """
-        if not self.warehouse:
-            return
-
-        initializing = self._state.adding
-
-        def _override(cur_val, field_name, wh_val):
-            if cur_val is None:
-                return wh_val
-            if initializing:
-                # –ø–µ—Ä–µ—Ç–∏—Ä–∞–µ–º, –µ—Å–ª–∏ 0 –∏–ª–∏ —Ä–∞–≤–Ω–æ –º–æ–¥–µ–ª—å–Ω–æ–º—É –¥–µ—Ñ–æ–ª—Ç—É
-                try:
-                    cur = Decimal(str(cur_val))
-                    if cur == 0:
-                        return wh_val
-                    model_default = self._meta.get_field(field_name).default
-                    mdl = Decimal(str(model_default or 0))
-                    if cur == mdl:
-                        return wh_val
-                except Exception:
-                    return wh_val
-            return cur_val
-
-        # –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è (rate —É–¥–∞–ª—ë–Ω - —Å—Ç–∞–≤–∫–∞ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ")
-        self.free_days = _override(self.free_days, 'free_days', self.warehouse.free_days or 0)
-
-        # –∑–∞–æ–¥–Ω–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ —É—Å–ª—É–≥–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
-        self.unload_fee = _override(self.unload_fee, 'unload_fee', self.warehouse.default_unloading_fee or 0)
-        self.delivery_fee = _override(self.delivery_fee, 'delivery_fee', self.warehouse.delivery_to_warehouse or 0)
-        self.loading_fee = _override(self.loading_fee, 'loading_fee', self.warehouse.loading_on_trawl or 0)
-        self.docs_fee = _override(self.docs_fee, 'docs_fee', self.warehouse.documents_fee or 0)
-        self.transfer_fee = _override(self.transfer_fee, 'transfer_fee', self.warehouse.transfer_fee or 0)
-        self.transit_declaration = _override(self.transit_declaration, 'transit_declaration',
-                                             self.warehouse.transit_declaration or 0)
-        self.export_declaration = _override(self.export_declaration, 'export_declaration',
-                                            self.warehouse.export_declaration or 0)
-        self.extra_costs = _override(self.extra_costs, 'extra_costs', self.warehouse.additional_expenses or 0)
-        self.complex_fee = _override(self.complex_fee, 'complex_fee', self.warehouse.complex_fee or 0)
-
-    def calculate_total_price(self):
-        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥ CarService.
-
-        –¶–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫.
-        
-        –í–ê–ñ–ù–û: total_price –≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É (markup_amount)!
-        –≠—Ç–æ –ø–æ–ª–Ω–∞—è —Å—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –∑–∞–ø–ª–∞—Ç–∏—Ç –∫–ª–∏–µ–Ω—Ç.
-        """
-        from django.db.models import Sum
-        
-        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à related objects —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ –ë–î
-        if hasattr(self, '_prefetched_objects_cache'):
-            self._prefetched_objects_cache.pop('car_services', None)
-        
-        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –∏ —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
-        self.update_days_and_storage()
-
-        # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—ã –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –∏–∑ CarService (final_price = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏)
-        line_total = self.get_services_total_by_provider('LINE')
-        carrier_total = self.get_services_total_by_provider('CARRIER')
-        warehouse_total = self.get_warehouse_services_total()  # –í–∫–ª—é—á–∞–µ—Ç —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ"
-        company_total = self.get_services_total_by_provider('COMPANY')
-        
-        # –°—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫
-        distributed_markup = self.car_services.aggregate(total=Sum('markup_amount'))['total'] or Decimal('0')
-
-        # –û–±—â–∞—è —Å—É–º–º–∞ = —É—Å–ª—É–≥–∏ + —Å–∫—Ä—ã—Ç—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏
-        self.total_price = line_total + warehouse_total + carrier_total + company_total + distributed_markup
-
-        return self.total_price
-
-    def update_days_and_storage(self):
-        """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è.
-        
-        –¶–µ–Ω–∞ –∑–∞ –¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.
-        –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å
-        """
-        if not self.unload_date or not self.warehouse:
-            self.days = 0
-            self.storage_cost = Decimal('0.00')
-            self._update_storage_service_price()
-            return
-
-        # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∫–ª–∞–¥–∞
-        free_days = int(self.warehouse.free_days or 0)
-
-        end_date = self.transfer_date if self.status == 'TRANSFERRED' and self.transfer_date else timezone.now().date()
-        total_days = (end_date - self.unload_date).days + 1
-        self.days = max(0, total_days - free_days)
-        
-        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
-        daily_rate = self._get_storage_daily_rate()
-        self.storage_cost = Decimal(str(self.days)) * daily_rate
-        
-        # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ CarService
-        self._update_storage_service_price()
-    
-    def _get_storage_daily_rate(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞."""
-        if not self.warehouse:
-            return Decimal('0.00')
-        
-        try:
-            storage_service = WarehouseService.objects.filter(
-                warehouse=self.warehouse,
-                name='–•—Ä–∞–Ω–µ–Ω–∏–µ',
-                is_active=True
-            ).first()
-            
-            if storage_service:
-                return Decimal(str(storage_service.default_price or 0))
-        except Exception:
-            pass
-        
-        return Decimal('0.00')
-    
-    def _update_storage_service_price(self):
-        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' –≤ CarService.
-        
-        –¶–µ–Ω–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å (–∏–∑ WarehouseService)
-        
-        –í–ê–ñ–ù–û: markup_amount –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
-        –ù–∞—Ü–µ–Ω–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ (–∏–∑ default_markup)
-        –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –∞–¥–º–∏–Ω–∫–µ.
-        """
-        if not self.pk or not self.warehouse:
-            return
-        
-        try:
-            # –ù–∞—Ö–æ–¥–∏–º —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞
-            storage_service = WarehouseService.objects.filter(
-                warehouse=self.warehouse,
-                name='–•—Ä–∞–Ω–µ–Ω–∏–µ',
-                is_active=True
-            ).first()
-            
-            if storage_service:
-                days = Decimal(str(self.days))
-                # –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å
-                storage_price = days * Decimal(str(storage_service.default_price or 0))
-                
-                # –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —Ü–µ–Ω—É –≤ CarService (markup_amount –Ω–µ —Ç—Ä–æ–≥–∞–µ–º!)
-                # –ù–∞—Ü–µ–Ω–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –≤ –∞–¥–º–∏–Ω–∫–µ
-                from core.models import CarService
-                CarService.objects.filter(
-                    car=self,
-                    service_type='WAREHOUSE',
-                    service_id=storage_service.id
-                ).update(custom_price=storage_price)
-                
-                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º prefetch –∫—ç—à —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
-                if hasattr(self, '_prefetched_objects_cache'):
-                    self._prefetched_objects_cache.pop('car_services', None)
-        except Exception:
-            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
-
-    def sync_with_container(self, container, ths_per_car):
-        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º."""
-        self.status = container.status
-        self.warehouse = container.warehouse
-        self.unload_date = container.unload_date
-        self.transfer_date = timezone.now().date() if container.status == 'TRANSFERRED' else None
-        self.ths = ths_per_car
-        self.dekl = container.dekl
-        self.proft = container.proft
-        self.set_initial_warehouse_values()
-        self.update_days_and_storage()
-        self.calculate_total_price()
-
-    WAREHOUSE_FEE_FIELDS = (
-        'unload_fee',  # —Ü–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É
-        'delivery_fee',  # –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞
-        'loading_fee',  # –ø–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª
-        'docs_fee',  # –¥–æ–∫—É–º–µ–Ω—Ç—ã
-        'transfer_fee',  # –ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É
-        'transit_declaration',  # —Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.
-        'export_declaration',  # —ç–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.
-        'extra_costs',  # –¥–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã
-        'complex_fee',  # –∫–æ–º–ø–ª–µ–∫—Å
-    )
-
-    def warehouse_payment_amount(self) -> Decimal:
-        """–°–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω—ã —Å–∫–ª–∞–¥—É –∑–∞ —É—Å–ª—É–≥–∏ (–±–µ–∑ —É—á—ë—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥."""
-        return self.get_warehouse_services_total()
-
-    @property
-    def warehouse_payment(self) -> Decimal:
-        # —É–¥–æ–±–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
-        return self.warehouse_payment_amount()
-    
-    def get_line_services(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
-        if not self.line or not self.pk:
-            return self.car_services.none()
-        # –ü–æ–ª—É—á–∞–µ–º ID —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏
-        line_service_ids = LineService.objects.only('id').filter(line=self.line).values_list('id', flat=True)
-        return self.car_services.filter(service_type='LINE', service_id__in=line_service_ids)
-    
-    def get_carrier_services(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
-        if not self.carrier or not self.pk:
-            return self.car_services.none()
-        # –ü–æ–ª—É—á–∞–µ–º ID —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
-        carrier_service_ids = CarrierService.objects.only('id').filter(carrier=self.carrier).values_list('id', flat=True)
-        return self.car_services.filter(service_type='CARRIER', service_id__in=carrier_service_ids)
-    
-    def get_company_services(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
-        if not self.pk:
-            return self.car_services.none()
-        return self.car_services.filter(service_type='COMPANY')
-    
-    def get_warehouse_services(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–≤–∫–ª—é—á–∞—è —É—Å–ª—É–≥–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤)"""
-        if not self.pk:
-            return self.car_services.none()
-        # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É –∞–≤—Ç–æ–º–æ–±–∏–ª—é
-        return self.car_services.filter(service_type='WAREHOUSE')
-    
-    def get_services_total_by_provider(self, provider_type):
-        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞.
-        
-        –î–ª—è —Å–∫–ª–∞–¥–∞: —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" (CarService).
-        """
-        total = Decimal('0.00')
-        if provider_type == 'LINE' and self.line:
-            services = self.get_line_services()
-        elif provider_type == 'CARRIER' and self.carrier:
-            services = self.get_carrier_services()
-        elif provider_type == 'COMPANY':
-            services = self.get_company_services()
-        elif provider_type == 'WAREHOUSE' and self.warehouse:
-            services = self.get_warehouse_services()
-        else:
-            return total
-            
-        for service in services:
-            total += Decimal(str(service.final_price))
-        return total
-    
-    def get_warehouse_services_total(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è)"""
-        if not self.warehouse:
-            return Decimal('0.00')
-        
-        services = self.get_warehouse_services()
-        total = Decimal('0.00')
-        
-        for service in services:
-            total += Decimal(str(service.final_price))
-        
-        return total
-    
-    def calculate_storage_cost(self):
-        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ.
-        
-        –°—Ç–∞–≤–∫–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.
-        """
-        if not self.warehouse or not self.unload_date:
-            return Decimal('0.00')
-        
-        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Å–æ —Å–∫–ª–∞–¥–∞
-        daily_rate = self._get_storage_daily_rate()
-        free_days = self.warehouse.free_days or 0
-        
-        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
-        # –í–∫–ª—é—á–∞–µ–º –¥–µ–Ω—å —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∏ –¥–µ–Ω—å –∑–∞–±–æ—Ä–∞ –∞–≤—Ç–æ
-        end_date = self.transfer_date if self.status == 'TRANSFERRED' and self.transfer_date else timezone.now().date()
-        total_days = (end_date - self.unload_date).days + 1
-        
-        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ (–æ–±—â–∏–µ –¥–Ω–∏ –º–∏–Ω—É—Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
-        chargeable_days = max(0, total_days - free_days)
-        
-        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
-        storage_cost = daily_rate * chargeable_days
-        
-        return storage_cost
-
-    def get_rates_by_provider(self, provider_type):
-        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫–∏ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"""
-        rates = []
-        if provider_type == 'LINE' and self.line:
-            services = self.get_line_services()
-        elif provider_type == 'CARRIER' and self.carrier:
-            services = self.get_carrier_services()
-        elif provider_type == 'WAREHOUSE' and self.warehouse:
-            services = self.get_warehouse_services()
-        else:
-            return rates
-            
-        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º service_type, –∏–∑–º–µ–Ω–∏–º –ª–æ–≥–∏–∫—É)
-        return rates
-
-    def get_parameters_by_provider(self, provider_type):
-        """–ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"""
-        parameters = []
-        if provider_type == 'LINE' and self.line:
-            services = self.get_line_services()
-        elif provider_type == 'CARRIER' and self.carrier:
-            services = self.get_carrier_services()
-        elif provider_type == 'WAREHOUSE' and self.warehouse:
-            services = self.get_warehouse_services()
-        else:
-            return parameters
-            
-        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º service_type, –∏–∑–º–µ–Ω–∏–º –ª–æ–≥–∏–∫—É)
-        return parameters
-
-    def save(self, *args, **kwargs):
-        # –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –î–û –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–æ–≤
-        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
-        if not self.warehouse and self.container and self.container.pk and self.container.warehouse:
-            self.warehouse = self.container.warehouse
-        
-        # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
-        if self.container and self.container.pk and self.container.unload_date:
-            self.unload_date = self.container.unload_date
-
-        if self.transfer_date and self.status != 'TRANSFERRED':
-            self.status = 'TRANSFERRED'
-
-        # –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ ‚Äî —Ç—è–Ω–µ–º –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (–≤ —Ç.—á. rate/free_days) –î–û –ø–µ—Ä–≤–æ–≥–æ save()
-        if self.pk is None and self.warehouse:
-            try:
-                self.set_initial_warehouse_values()
-            except Exception as e:
-                logger.error(f"Failed to set initial warehouse values for car {self.vin}: {e}")
-
-        if self.status == 'TRANSFERRED' and not self.transfer_date:
-            from django.utils import timezone
-            self.transfer_date = timezone.now().date()
-
-        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å pk
-        super().save(*args, **kwargs)
-        
-        # –ø–µ—Ä–µ—Å—á—ë—Ç –ü–û–°–õ–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –∫–æ–≥–¥–∞ —É –æ–±—ä–µ–∫—Ç–∞ —É–∂–µ –µ—Å—Ç—å pk
-        try:
-            old_total_price = self.total_price
-            
-            self.calculate_total_price()
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—â–µ —Ä–∞–∑ —Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
-            if self.total_price != old_total_price:
-                super().save(update_fields=['total_price'])
-        except Exception as e:
-            logger.error(f"Failed to calculate total price for car {self.vin}: {e}")
-
-        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
-        if self.pk:
-            try:
-                Car.objects.update_related(self)
-            except Exception as e:
-                logger.error(f"Failed to update related objects for car {self.id}: {e}")
-            
-            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
-            if self.container and self.container.pk:
-                try:
-                    self.container.check_and_update_status_from_cars()
-                except Exception as e:
-                    logger.error(f"Failed to check container status for car {self.id}: {e}")
-
-        def _notify():
-            try:
-                channel_layer = get_channel_layer()
-                async_to_sync(channel_layer.group_send)(
-                    "updates",
-                    {
-                        "type": "data_update",
-                        "data": {
-                            "model": "Car",
-                            "id": self.id,
-                            "status": self.status,
-                            "storage_cost": str(self.storage_cost),
-                            "days": self.days,
-                            "price": str(self.total_price),
-                        },
-                    },
-                )
-            except Exception as e:
-                logger.error(f"Failed to send WebSocket notification for car {self.id}: {e}")
-        transaction.on_commit(_notify)
-
-    def __str__(self):
-        return f"{self.brand} ({self.vin})"
-
-    class Meta:
-        verbose_name = "–ê–≤—Ç–æ–º–æ–±–∏–ª—å"
-        verbose_name_plural = "–ê–≤—Ç–æ–º–æ–±–∏–ª–∏"
-        indexes = [
-            models.Index(fields=['vin']),
-            models.Index(fields=['status']),
-            models.Index(fields=['unload_date', 'transfer_date']),
-            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
-            models.Index(fields=['client', 'status']),
-            models.Index(fields=['warehouse', 'status']),
-            models.Index(fields=['line']),
-            models.Index(fields=['carrier']),
-            models.Index(fields=['container']),
-            models.Index(fields=['unload_date']),
-            models.Index(fields=['transfer_date']),
-        ]
-
-
-class Company(models.Model):
-    """–ú–æ–¥–µ–ª—å –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Caromoto Lithuania"""
-    
-    name = models.CharField(max_length=100, default="Caromoto Lithuania", verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏")
-    
-    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
-    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
-                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
-    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
-    
-    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
-    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
-    
-    objects = OptimizedCompanyManager()
-    
-    class Meta:
-        verbose_name = "–ö–æ–º–ø–∞–Ω–∏—è"
-        verbose_name_plural = "–ö–æ–º–ø–∞–Ω–∏–∏"
-    
-    def __str__(self):
-        return self.name
-
-
-class CompanyService(models.Model):
-    """–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π"""
-    company = models.ForeignKey(Company, on_delete=models.CASCADE, related_name='services', verbose_name="–ö–æ–º–ø–∞–Ω–∏—è")
-    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
-    default_markup = models.DecimalField(
-        max_digits=10,
-        decimal_places=2,
-        default=0,
-        verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ"
-    )
-    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
-    add_by_default = models.BooleanField(
-        default=False,
-        verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏"
-    )
-    
-    def __str__(self):
-        return f"{self.company.name} - {self.name}"
-    
-    class Meta:
-        verbose_name = "–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏"
-        verbose_name_plural = "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π"
-
-# –ú–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥
-
-
-
-class LineService(models.Model):
-    """–£—Å–ª—É–≥–∏ –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π"""
-    line = models.ForeignKey(Line, on_delete=models.CASCADE, related_name='services', verbose_name="–õ–∏–Ω–∏—è")
-    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
-    default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ")
-    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
-    add_by_default = models.BooleanField(
-        default=False,
-        verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∏–∏"
-    )
-    
-    def __str__(self):
-        return f"{self.line.name} - {self.name}"
-    
-    class Meta:
-        verbose_name = "–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏"
-        verbose_name_plural = "–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π"
-
-
-class CarrierService(models.Model):
-    """–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤"""
-    carrier = models.ForeignKey(Carrier, on_delete=models.CASCADE, related_name='services', verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
-    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
-    default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ")
-    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
-    add_by_default = models.BooleanField(
-        default=False,
-        verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-    )
-    
-    def __str__(self):
-        return f"{self.carrier.name} - {self.name}"
-    
-    class Meta:
-        verbose_name = "–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-        verbose_name_plural = "–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤"
-
-
-class WarehouseService(models.Model):
-    """–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤"""
-    warehouse = models.ForeignKey(Warehouse, on_delete=models.CASCADE, related_name='services', verbose_name="–°–∫–ª–∞–¥")
-    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
-    default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ")
-    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
-    add_by_default = models.BooleanField(default=False, verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
-        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ")
-    
-    def __str__(self):
-        return f"{self.warehouse.name} - {self.name}"
-    
-    class Meta:
-        verbose_name = "–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞"
-        verbose_name_plural = "–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤"
-
-
-class DeletedCarService(models.Model):
-    """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —É—Å–ª—É–≥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
-    car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='deleted_services', verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
-    service_type = models.CharField(max_length=20, choices=[
-        ('LINE', '–õ–∏–Ω–∏—è'),
-        ('CARRIER', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'),
-        ('WAREHOUSE', '–°–∫–ª–∞–¥'),
-        ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'),
-    ], verbose_name="–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
-    service_id = models.PositiveIntegerField(verbose_name="ID —É—Å–ª—É–≥–∏")
-    deleted_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è")
-    
-    class Meta:
-        unique_together = ['car', 'service_type', 'service_id']
-        verbose_name = "–£–¥–∞–ª–µ–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"
-        verbose_name_plural = "–£–¥–∞–ª–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
-
-
-class CarService(models.Model):
-    """–°–≤—è–∑—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —É—Å–ª—É–≥–∞–º–∏ –∏ –∏—Ö —Ü–µ–Ω–∞–º–∏"""
-    SERVICE_TYPES = [
-        ('LINE', '–õ–∏–Ω–∏—è'),
-        ('CARRIER', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'),
-        ('WAREHOUSE', '–°–∫–ª–∞–¥'),
-        ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'),
-    ]
-    
-    car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='car_services', verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
-    service_type = models.CharField(max_length=20, choices=SERVICE_TYPES, verbose_name="–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
-    service_id = models.PositiveIntegerField(verbose_name="ID —É—Å–ª—É–≥–∏")
-    custom_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞")
-    markup_amount = models.DecimalField(
-        max_digits=10, 
-        decimal_places=2, 
-        default=0, 
-        verbose_name="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞",
-        help_text="–°—É–º–º–∞ –Ω–∞—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ (—Å–∫—Ä—ã—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)"
-    )
-    quantity = models.PositiveIntegerField(default=1, verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ")
-    notes = models.TextField(blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
-    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
-    
-    def __str__(self):
-        return f"{self.car.vin} - {self.get_service_name()}: {self.final_price}"
-    
-    def get_service_name(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"""
-        if self.service_type == 'LINE':
-            try:
-                service = LineService.objects.get(id=self.service_id)
-                return service.name
-            except LineService.DoesNotExist:
-                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
-        elif self.service_type == 'CARRIER':
-            try:
-                service = CarrierService.objects.get(id=self.service_id)
-                return service.name
-            except CarrierService.DoesNotExist:
-                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
-        elif self.service_type == 'WAREHOUSE':
-            try:
-                service = WarehouseService.objects.get(id=self.service_id)
-                return service.name
-            except WarehouseService.DoesNotExist:
-                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
-        elif self.service_type == 'COMPANY':
-            try:
-                service = CompanyService.objects.get(id=self.service_id)
-                return service.name
-            except CompanyService.DoesNotExist:
-                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
-        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞"
-    
-    def get_default_price(self):
-        """–ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
-        if self.service_type == 'LINE':
-            try:
-                service = LineService.objects.get(id=self.service_id)
-                return service.default_price
-            except LineService.DoesNotExist:
-                return 0
-        elif self.service_type == 'CARRIER':
-            try:
-                service = CarrierService.objects.get(id=self.service_id)
-                return service.default_price
-            except CarrierService.DoesNotExist:
-                return 0
-        elif self.service_type == 'WAREHOUSE':
-            try:
-                service = WarehouseService.objects.get(id=self.service_id)
-                return service.default_price
-            except WarehouseService.DoesNotExist:
-                return 0
-        elif self.service_type == 'COMPANY':
-            try:
-                service = CompanyService.objects.get(id=self.service_id)
-                return service.default_price
-            except CompanyService.DoesNotExist:
-                return 0
-        return 0
-    
-    @property
-    def final_price(self):
-        """–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–ë–ï–ó —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ - –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞)"""
-        # –ò—Å–ø–æ–ª—å–∑—É–µ–º custom_price –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ 0), –∏–Ω–∞—á–µ default_price
-        price = self.custom_price if self.custom_price is not None else self.get_default_price()
-        return price * self.quantity
-    
-    @property
-    def invoice_price(self):
-        """–¶–µ–Ω–∞ –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ (–° —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)"""
-        # –ò—Å–ø–æ–ª—å–∑—É–µ–º custom_price –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ 0), –∏–Ω–∞—á–µ default_price
-        base_price = self.custom_price if self.custom_price is not None else self.get_default_price()
-        markup = self.markup_amount or Decimal('0')
-        return (base_price + markup) * self.quantity
-    
-    def get_total_distributed_markup(self):
-        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ"""
-        if not self.car_id:
-            return Decimal('0')
-        return CarService.objects.filter(car_id=self.car_id).aggregate(
-            total=models.Sum('markup_amount')
-        )['total'] or Decimal('0')
-    
-    class Meta:
-        verbose_name = "–£—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"
-        verbose_name_plural = "–£—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
-        unique_together = ('car', 'service_type', 'service_id')
-        indexes = [
-            models.Index(fields=['car', 'service_type']),
-            models.Index(fields=['service_type', 'service_id']),
-            models.Index(fields=['car']),
-        ]
-
-
-# –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥
-from django.db.models.signals import post_save, post_delete
-from django.dispatch import receiver
-
-
-@receiver(post_save, sender=CarService)
-def recalculate_car_price_on_service_save(sender, instance, **kwargs):
-    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏"""
-    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥
-    if getattr(instance.car, '_creating_services', False):
-        return
-    try:
-        instance.car.calculate_total_price()
-        # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
-        Car.objects.filter(id=instance.car.id).update(
-            total_price=instance.car.total_price
-        )
-    except Exception as e:
-        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}")
-
-
-@receiver(post_delete, sender=CarService)
-def recalculate_car_price_on_service_delete(sender, instance, **kwargs):
-    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏"""
-    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥
-    if getattr(instance.car, '_creating_services', False):
-        return
-    try:
-        instance.car.calculate_total_price()
-        # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
-        Car.objects.filter(id=instance.car.id).update(
-            total_price=instance.car.total_price
-        )
-    except Exception as e:
-        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}")
-
-
-@receiver(post_save, sender=Car)
-def recalculate_car_price_on_car_save(sender, instance, **kwargs):
-    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ —Ä–∞—Å—á–µ—Ç"""
-    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏
-    if getattr(instance, '_recalculating_price', False):
-        return
-    if getattr(instance, '_creating_services', False):
-        return
-    
-    try:
-        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
-        if hasattr(instance, '_state') and instance._state.adding:
-            return
-        
-        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ update_fields=['total_price'] - –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ü–µ–Ω–∞ —É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞
-        update_fields = kwargs.get('update_fields')
-        if update_fields and 'total_price' in update_fields:
-            return
-        
-        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏
-        instance._recalculating_price = True
-        
-        try:
-            instance.calculate_total_price()
-            # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
-            Car.objects.filter(id=instance.id).update(
-                total_price=instance.total_price
-            )
-        finally:
-            instance._recalculating_price = False
-            
-    except Exception as e:
-        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è: {e}")
-
-
-# ==============================================================================
-# üéâ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í –ò –ü–õ–ê–¢–ï–ñ–ï–ô
-# ==============================================================================
-# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã Django –∏—Ö –≤–∏–¥–µ–ª
-
-from .models_billing import (
-    NewInvoice,
-    InvoiceItem,
-    Transaction,
-    SimpleBalanceMixin
-)
-
-# ==============================================================================
-# üåê –ú–û–î–ï–õ–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û –°–ê–ô–¢–ê
-# ==============================================================================
-# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞
-
-from .models_website import (
-    ClientUser,
-    CarPhoto,
-    ContainerPhoto,
-    AIChat,
-    NewsPost,
-    ContactMessage,
-    TrackingRequest
+from django.db import models
+from django.core.validators import MinValueValidator
+from .constants import STATUS_COLORS
+from django.utils import timezone
+from channels.layers import get_channel_layer
+from asgiref.sync import async_to_sync
+from django.db.models import Sum, Q
+from django.db import transaction
+from decimal import Decimal
+import logging
+
+from datetime import timedelta
+
+# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
+from .managers import (
+    OptimizedCarManager, OptimizedContainerManager, OptimizedClientManager, 
+    OptimizedWarehouseManager, OptimizedCompanyManager
+)
+
+
+
+logger = logging.getLogger('django')
+
+def get_current_user():
+    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
+    from django.contrib.auth.models import AnonymousUser
+    from django.contrib.auth import get_user
+    
+    try:
+        user = get_user()
+        if user.is_authenticated:
+            return user.username
+        return 'system'
+    except:
+        return 'system'
+
+# –ë–∞–∑–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
+class BaseManager(models.Manager):
+    def update_related(self, instance):
+        pass
+
+# –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –±–∞–ª–∞–Ω—Å–æ–≤
+
+
+
+# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
+class Line(models.Model):
+    name = models.CharField(max_length=100, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏")
+    
+    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
+    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
+                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
+    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
+    
+    # –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã
+    ocean_freight_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∑–∞ –∞–≤—Ç–æ)")
+    documentation_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
+    handling_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏")
+    ths_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="THS —Å–±–æ—Ä (–æ–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º)")
+    additional_fees = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã")
+
+    class Meta:
+        verbose_name = "–õ–∏–Ω–∏—è"
+        verbose_name_plural = "–õ–∏–Ω–∏–∏"
+
+    def __str__(self):
+        return self.name
+
+
+class LineTHSCoefficient(models.Model):
+    """–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–° —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–∏–Ω–∏–∏.
+    
+    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã THS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ–∂–¥—É –¢–°
+    –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏—Ö "–≤–µ—Å—É" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É).
+    
+    –ü—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä THS = 500 EUR
+    3 –º–∞—à–∏–Ω—ã: –ª–µ–≥–∫–æ–≤–æ–π(1.0) + –¥–∂–∏–ø(2.0) + –º–æ—Ç–æ(0.5) = —Å—É–º–º–∞ –≤–µ—Å–æ–≤ 3.5
+    - –õ–µ–≥–∫–æ–≤–æ–π: 500 √ó (1.0/3.5) = 143 EUR
+    - –î–∂–∏–ø: 500 √ó (2.0/3.5) = 286 EUR  
+    - –ú–æ—Ç–æ: 500 √ó (0.5/3.5) = 71 EUR
+    """
+    # –¢–∏–ø—ã –¢–° –¥—É–±–ª–∏—Ä—É–µ–º –∑–¥–µ—Å—å —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
+    VEHICLE_TYPE_CHOICES = [
+        ('SEDAN', '–õ–µ–≥–∫–æ–≤–æ–π'),
+        ('CROSSOVER', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä'),
+        ('SUV', '–î–∂–∏–ø'),
+        ('PICKUP', '–ü–∏–∫–∞–ø'),
+        ('NEW_CAR', '–ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞'),
+        ('MOTO', '–ú–æ—Ç–æ—Ü–∏–∫–ª'),
+        ('BIG_MOTO', '–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª'),
+        ('ATV', '–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏'),
+        ('BOAT', '–õ–æ–¥–∫–∞'),
+        ('RV', '–ê–≤—Ç–æ–¥–æ–º (RV)'),
+        ('CONSTRUCTION', '–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞'),
+    ]
+    
+    line = models.ForeignKey(Line, on_delete=models.CASCADE, related_name='ths_coefficients', verbose_name="–õ–∏–Ω–∏—è")
+    vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, verbose_name="–¢–∏–ø –¢–°")
+    coefficient = models.DecimalField(max_digits=5, decimal_places=2, default=1.00, 
+                                      verbose_name="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç",
+                                      help_text="–í–µ—Å —Ç–∏–ø–∞ –¢–° –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ THS (1.0 = —Å—Ç–∞–Ω–¥–∞—Ä—Ç, 2.0 = –¥–≤–æ–π–Ω–æ–π, 0.5 = –ø–æ–ª–æ–≤–∏–Ω–∞)")
+    
+    class Meta:
+        verbose_name = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç THS –¥–ª—è —Ç–∏–ø–∞ –¢–°"
+        verbose_name_plural = "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã THS –¥–ª—è —Ç–∏–ø–æ–≤ –¢–°"
+        unique_together = ['line', 'vehicle_type']
+    
+    def __str__(self):
+        return f"{self.line.name} - {self.get_vehicle_type_display()}: √ó{self.coefficient}"
+
+
+class Carrier(models.Model):
+    name = models.CharField(max_length=100, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞")
+    short_name = models.CharField(max_length=20, blank=True, null=True, verbose_name="–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ")
+    contact_person = models.CharField(max_length=100, blank=True, null=True, verbose_name="–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ")
+    phone = models.CharField(max_length=20, blank=True, null=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
+    email = models.EmailField(blank=True, null=True, verbose_name="Email")
+    eori_code = models.CharField(max_length=50, blank=True, null=True, verbose_name="EORI –∫–æ–¥",
+                                  help_text="–ö–æ–¥ EORI –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è")
+    
+    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
+    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
+                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
+    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
+    
+    # –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã
+    transport_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–∑–∞ –∫–º)")
+    loading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–≥—Ä—É–∑–∫–∏")
+    unloading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–≥—Ä—É–∑–∫–∏")
+    fuel_surcharge = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–¢–æ–ø–ª–∏–≤–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞")
+    additional_fees = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä—ã")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    
+    objects = OptimizedCompanyManager()
+    
+    class Meta:
+        verbose_name = "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫"
+        verbose_name_plural = "–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏"
+    
+    def __str__(self):
+        return self.name
+
+
+class CarrierTruck(models.Model):
+    """–ê–≤—Ç–æ–≤–æ–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (—Ç—è–≥–∞—á + –ø—Ä–∏—Ü–µ–ø)"""
+    carrier = models.ForeignKey(Carrier, on_delete=models.CASCADE, related_name='trucks', verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
+    truck_number = models.CharField(max_length=20, verbose_name="–ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞",
+                                     help_text="–ù–æ–º–µ—Ä –≥–æ–ª–æ–≤—ã –∞–≤—Ç–æ–≤–æ–∑–∞")
+    trailer_number = models.CharField(max_length=20, blank=True, verbose_name="–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞",
+                                       help_text="–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
+    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–µ–Ω")
+    notes = models.TextField(blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    
+    class Meta:
+        verbose_name = "–ê–≤—Ç–æ–≤–æ–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+        verbose_name_plural = "–ê–≤—Ç–æ–≤–æ–∑—ã –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤"
+        unique_together = ['carrier', 'truck_number', 'trailer_number']
+        ordering = ['-created_at']
+    
+    def __str__(self):
+        if self.trailer_number:
+            return f"{self.truck_number} / {self.trailer_number}"
+        return self.truck_number
+    
+    @property
+    def full_number(self):
+        """–ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ XXXXX / XXXXX"""
+        if self.trailer_number:
+            return f"{self.truck_number} / {self.trailer_number}"
+        return self.truck_number
+
+
+class CarrierDriver(models.Model):
+    """–í–æ–¥–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+    carrier = models.ForeignKey(Carrier, on_delete=models.CASCADE, related_name='drivers', verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
+    first_name = models.CharField(max_length=50, verbose_name="–ò–º—è")
+    last_name = models.CharField(max_length=50, verbose_name="–§–∞–º–∏–ª–∏—è")
+    phone = models.CharField(max_length=20, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
+    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–µ–Ω")
+    notes = models.TextField(blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    
+    class Meta:
+        verbose_name = "–í–æ–¥–∏—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+        verbose_name_plural = "–í–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤"
+        ordering = ['last_name', 'first_name']
+    
+    def __str__(self):
+        return f"{self.first_name} {self.last_name}"
+    
+    @property
+    def full_name(self):
+        """–ü–æ–ª–Ω–æ–µ –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è"""
+        return f"{self.first_name} {self.last_name}"
+
+
+class Client(models.Model):
+    name = models.CharField(max_length=100, verbose_name="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞")
+    email = models.EmailField(blank=True, null=True, verbose_name="Email 1",
+                              help_text="–û—Å–Ω–æ–≤–Ω–æ–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–∞–∑–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤")
+    email2 = models.EmailField(blank=True, null=True, verbose_name="Email 2",
+                               help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
+    email3 = models.EmailField(blank=True, null=True, verbose_name="Email 3",
+                               help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
+    email4 = models.EmailField(blank=True, null=True, verbose_name="Email 4",
+                               help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
+    notification_enabled = models.BooleanField(default=True, verbose_name="–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
+                                               help_text="–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö")
+
+    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
+    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å", 
+                                   help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥")
+    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
+    
+    objects = OptimizedClientManager()
+    
+    class Meta:
+        verbose_name = "–ö–ª–∏–µ–Ω—Ç"
+        verbose_name_plural = "–ö–ª–∏–µ–Ω—Ç—ã"
+    
+    def __str__(self):
+        return self.name
+    
+    def get_notification_emails(self):
+        """
+        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö email-–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
+        –ü—É—Å—Ç—ã–µ –∏ None –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è.
+        """
+        emails = []
+        for field in [self.email, self.email2, self.email3, self.email4]:
+            if field and field.strip():
+                emails.append(field.strip())
+        return emails
+    
+    def has_notification_emails(self):
+        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
+        return len(self.get_notification_emails()) > 0
+    
+    @property
+    def balance_status(self):
+        """–°—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
+        if self.balance > 0:
+            return "–ü–ï–†–ï–ü–õ–ê–¢–ê"
+        elif self.balance < 0:
+            return "–î–û–õ–ì"
+        return "–ë–ê–õ–ê–ù–°"
+    
+    @property
+    def balance_color(self):
+        """–¶–≤–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞"""
+        if self.balance > 0:
+            return "#28a745"  # –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
+        elif self.balance < 0:
+            return "#dc3545"  # –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –¥–æ–ª–≥–∞
+        return "#6c757d"  # —Å–µ—Ä—ã–π –¥–ª—è –Ω—É–ª—è
+
+class Warehouse(models.Model):
+    name = models.CharField(max_length=100, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞")
+    address = models.CharField(max_length=300, blank=True, verbose_name="–ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞")
+    
+    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
+    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
+                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
+    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
+
+    # –¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏
+    default_unloading_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É")
+    free_days = models.PositiveIntegerField(default=0, verbose_name="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
+    # –£–î–ê–õ–ï–ù–û: rate - —Å—Ç–∞–≤–∫–∞ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" (WarehouseService)
+    complex_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ö–æ–º–ø–ª–µ–∫—Å",validators=[MinValueValidator(0)])
+    delivery_to_warehouse = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞")
+    loading_on_trawl = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª")
+    documents_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–î–æ–∫—É–º–µ–Ω—Ç—ã")
+    transfer_fee = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É")
+    transit_declaration = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.")
+    export_declaration = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.")
+    additional_expenses = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã")
+
+    objects = OptimizedWarehouseManager()
+    
+    class Meta:
+        verbose_name = "–°–∫–ª–∞–¥"
+        verbose_name_plural = "–°–∫–ª–∞–¥—ã"
+
+    def __str__(self):
+        return self.name
+
+# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
+class ContainerManager(BaseManager):
+    def update_related(self, instance):
+        cars = instance.container_cars.all()
+        if not cars:
+            return
+        ths_per_car = (instance.ths or 0) / cars.count()
+        for car in cars:
+            car.sync_with_container(instance, ths_per_car)
+            car.save()
+
+class Container(models.Model):
+    STATUS_CHOICES = [
+        ('FLOATING', '–í –ø—É—Ç–∏'),
+        ('IN_PORT', '–í –ø–æ—Ä—Ç—É'),
+        ('UNLOADED', '–†–∞–∑–≥—Ä—É–∂–µ–Ω'),
+        ('TRANSFERRED', '–ü–µ—Ä–µ–¥–∞–Ω'),
+    ]
+
+    def get_status_color(self):
+        return STATUS_COLORS.get(self.status, '#3a8c3d')  # –¢–µ–º–Ω–µ–µ –∑–µ–ª—ë–Ω–æ–≥–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
+
+    CUSTOMS_PROCEDURE_CHOICES = (
+        ('TRANSIT', '–¢—Ä–∞–Ω–∑–∏—Ç'),
+        ('IMPORT', '–ò–º–ø–æ—Ä—Ç'),
+        ('REEXPORT', '–†–µ—ç–∫—Å–ø–æ—Ä—Ç'),
+        ('EXPORT', '–≠–∫—Å–ø–æ—Ä—Ç'),
+    )
+
+    number = models.CharField(max_length=100, unique=True, verbose_name="–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞")
+    status = models.CharField(max_length=50, choices=STATUS_CHOICES, default='FLOATING', verbose_name="–°—Ç–∞—Ç—É—Å")
+    line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ú–æ—Ä—Å–∫–∞—è –ª–∏–Ω–∏—è")
+    eta = models.DateField(null=True, blank=True, verbose_name="ETA")
+    client = models.ForeignKey('Client', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–ª–∏–µ–Ω—Ç")
+    customs_procedure = models.CharField(max_length=20, choices=CUSTOMS_PROCEDURE_CHOICES, null=True, blank=True,
+                                         verbose_name="–¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞")
+    THS_PAYER_CHOICES = [
+        ('LINE', '–ù–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏'),
+        ('WAREHOUSE', '–ß–µ—Ä–µ–∑ —Å–∫–ª–∞–¥'),
+    ]
+    
+    ths = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–û–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º",
+                              validators=[MinValueValidator(0)])
+    ths_payer = models.CharField(max_length=20, choices=THS_PAYER_CHOICES, default='LINE',
+                                 verbose_name="–û–ø–ª–∞—Ç–∞ THS —á–µ—Ä–µ–∑",
+                                 help_text="–û—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ THS –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¢–°: –Ω–∞–ø—Ä—è–º—É—é –ª–∏–Ω–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥")
+    sklad = models.DecimalField(max_digits=10, decimal_places=2, default=160, verbose_name="–û–ø–ª–∞—Ç–∞ —Å–∫–ª–∞–¥—É",
+                                validators=[MinValueValidator(0)])
+    dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è",
+                               validators=[MinValueValidator(0)])
+    proft = models.DecimalField(max_digits=10, decimal_places=2, default=20, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞",
+                                validators=[MinValueValidator(0)])
+    warehouse = models.ForeignKey('Warehouse', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–°–∫–ª–∞–¥")
+    planned_unload_date = models.DateField(null=True, blank=True, verbose_name="–ë—É–¥–µ–º —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å",
+                                           help_text="–£–∫–∞–∂–∏—Ç–µ –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Ä–∞–∑–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)")
+    unload_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏")
+    unloaded_status_at = models.DateTimeField(
+        null=True,
+        blank=True,
+        verbose_name="–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å",
+        help_text="–ö–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏–ª —Å—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' (–¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ)"
+    )
+    free_days = models.PositiveIntegerField(default=0, verbose_name="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
+    days = models.PositiveIntegerField(default=0, verbose_name="–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
+    rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name="–°—Ç–∞–≤–∫–∞",
+                               validators=[MinValueValidator(0)])
+    storage_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–°–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ")
+    notes = models.CharField(max_length=200, blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
+    
+    # Google Drive integration
+    google_drive_folder_url = models.URLField(max_length=500, blank=True, verbose_name="Google Drive –ø–∞–ø–∫–∞", 
+                                               help_text="–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Google Drive")
+
+    objects = OptimizedContainerManager()
+    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
+    legacy_objects = ContainerManager()
+
+    def update_days_and_storage(self):
+        if self.status == 'UNLOADED' and self.unload_date:
+            total_days = (timezone.now().date() - self.unload_date).days + 1
+            self.days = max(0, total_days - self.free_days)
+            self.storage_cost = self.days * (self.rate or 0)
+        else:
+            self.days = 0
+            self.storage_cost = 0
+
+    def sync_cars(self):
+        self.update_days_and_storage()
+        Container.objects.update_related(self)
+
+    def save(self, *args, **kwargs):
+        if self.status == 'UNLOADED' and (not self.warehouse or not self.unload_date):
+            raise ValueError("–î–ª—è —Å—Ç–∞—Ç—É—Å–∞ '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –ø–æ–ª—è '–°–∫–ª–∞–¥' –∏ '–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏'")
+        super().save(*args, **kwargs)
+
+    def sync_cars_after_warehouse_change(self):
+        """
+        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥ –∫–æ –≤—Å–µ–º –∞–≤—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
+        - —Å—Ç–∞–≤–∏—Ç warehouse
+        - –∂—ë—Å—Ç–∫–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ –ø–æ–ª—è –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
+        - –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
+        - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—É–º–º—ã
+        """
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
+        if not self.pk:
+            return
+            
+        for car in self.container_cars.all():
+            car.warehouse = self.warehouse
+            car.apply_warehouse_defaults(force=True)  # –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å rate/free_days –∏ –ø—Ä–æ—á–µ–µ
+            # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
+            if self.unload_date:
+                car.unload_date = self.unload_date
+                logger.debug(f"Car {car.vin}: forced unload_date={self.unload_date} from container {self.number}")
+            car.update_days_and_storage()
+            car.calculate_total_price()
+            car.save()
+
+    def sync_cars_after_edit(self):
+        """
+        –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –º–∞—à–∏–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
+        ‚Äî –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫–ª–∞–¥/–∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ —É –∞–≤—Ç–æ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ,
+        ‚Äî –¥–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ),
+        ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (rate/free_days/–∏ —Ç.–¥.) –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö/–¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö,
+        ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ü–µ–Ω—ã.
+        """
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
+        if not self.pk:
+            return
+            
+        from .models import Car  # –µ—Å–ª–∏ —Ñ–∞–π–ª –æ–±—â–∏–π, –∏–º–ø–æ—Ä—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
+        for car in self.container_cars.all():
+            changed = False
+
+            # –±–∞–∑–æ–≤—ã–µ —Å–≤—è–∑–∫–∏
+            if not car.warehouse and self.warehouse:
+                car.warehouse = self.warehouse
+                changed = True
+            if not car.client and self.client:
+                car.client = self.client
+                changed = True
+            
+            # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
+            if self.unload_date:
+                if car.unload_date != self.unload_date:
+                    car.unload_date = self.unload_date
+                    changed = True
+                    logger.info(f"Car {car.vin}: forced unload_date update to {self.unload_date} from container {self.number}")
+
+            # –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ/–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
+            if car.warehouse:
+                before_rate = car.rate
+                before_free = car.free_days
+                car.apply_warehouse_defaults(override_on_defaults=True)
+                changed = changed or (car.rate != before_rate or car.free_days != before_free)
+
+            # –ø–µ—Ä–µ—Å—á—ë—Ç
+            car.update_days_and_storage()
+            car.calculate_total_price()
+
+            if changed:
+                car.save()  # —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç WS-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —É —Ç–µ–±—è —ç—Ç–æ –≤ save()
+            else:
+                # –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å—Ç–æ–∏–º–æ—Å—Ç—å/–¥–Ω–∏ –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –¥–∞—Ç—ã
+                car.save(update_fields=['storage_cost', 'days', 'total_price'])
+
+    def check_and_update_status_from_cars(self):
+        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"""
+        if not self.pk:
+            return
+            
+        cars = self.container_cars.all()
+        if not cars.exists():
+            return
+            
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω"
+        all_transferred = all(car.status == 'TRANSFERRED' for car in cars)
+        
+        if all_transferred and self.status != 'TRANSFERRED':
+            self.status = 'TRANSFERRED'
+            self.save(update_fields=['status'])
+            logger.info(f"Container {self.number} status automatically changed to TRANSFERRED")
+
+    def __str__(self):
+        return self.number
+
+    class Meta:
+        verbose_name = "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä"
+        verbose_name_plural = "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
+        indexes = [
+            models.Index(fields=['status']),
+            models.Index(fields=['client', 'status']),
+            models.Index(fields=['warehouse', 'status']),
+            models.Index(fields=['line']),
+            models.Index(fields=['eta']),
+            models.Index(fields=['unload_date']),
+        ]
+
+# –ê–≤—Ç–æ–º–æ–±–∏–ª–∏
+class CarManager(BaseManager):
+    pass
+
+
+class Car(models.Model):
+    # –¢–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
+    VEHICLE_TYPE_CHOICES = [
+        ('SEDAN', '–õ–µ–≥–∫–æ–≤–æ–π'),
+        ('CROSSOVER', '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä'),
+        ('SUV', '–î–∂–∏–ø'),
+        ('PICKUP', '–ü–∏–∫–∞–ø'),
+        ('NEW_CAR', '–ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞'),
+        ('MOTO', '–ú–æ—Ç–æ—Ü–∏–∫–ª'),
+        ('BIG_MOTO', '–ë–æ–ª—å—à–æ–π –º–æ—Ç–æ—Ü–∏–∫–ª'),
+        ('ATV', '–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª/–ë–∞–≥–≥–∏'),
+        ('BOAT', '–õ–æ–¥–∫–∞'),
+        ('RV', '–ê–≤—Ç–æ–¥–æ–º (RV)'),
+        ('CONSTRUCTION', '–°—Ç—Ä. —Ç–µ—Ö–Ω–∏–∫–∞'),
+    ]
+    
+    year = models.PositiveIntegerField(verbose_name="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞")
+    brand = models.CharField(max_length=50, verbose_name="–ú–∞—Ä–∫–∞")
+    vehicle_type = models.CharField(max_length=20, choices=VEHICLE_TYPE_CHOICES, default='SEDAN', verbose_name="–¢–∏–ø –¢–°")
+    vin = models.CharField(max_length=17, unique=True, verbose_name="VIN")
+    client = models.ForeignKey('Client', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–ª–∏–µ–Ω—Ç")
+    status = models.CharField(max_length=20, choices=Container.STATUS_CHOICES, verbose_name="–°—Ç–∞—Ç—É—Å")
+    warehouse = models.ForeignKey('Warehouse', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–°–∫–ª–∞–¥")
+    line = models.ForeignKey('Line', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–õ–∏–Ω–∏—è")
+    carrier = models.ForeignKey('Carrier', on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
+    unload_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏")
+    transfer_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏")
+    has_title = models.BooleanField(default=False, verbose_name="–¢")
+    title_notes = models.CharField(max_length=200, blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ —Ç–∞–π—Ç–ª—É")
+    total_price = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–¶–µ–Ω–∞")
+    # –£–î–ê–õ–ï–ù–û: current_price - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ total_price
+    storage_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="–°–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ")
+    days = models.PositiveIntegerField(default=0, verbose_name="–ü–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
+    container = models.ForeignKey('Container', on_delete=models.CASCADE, related_name="container_cars", null=True, blank=True, verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
+
+    # –†–∞—Å—Ö–æ–¥—ã
+    ths = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–û–ø–ª–∞—Ç–∞ –ª–∏–Ω–∏—è–º", validators=[MinValueValidator(0)])
+    unload_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É", validators=[MinValueValidator(0)])
+    delivery_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞", validators=[MinValueValidator(0)])
+    loading_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª", validators=[MinValueValidator(0)])
+    docs_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ–∫—É–º–µ–Ω—Ç—ã", validators=[MinValueValidator(0)])
+    transfer_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É", validators=[MinValueValidator(0)])
+    transit_declaration = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.", validators=[MinValueValidator(0)])
+    export_declaration = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.", validators=[MinValueValidator(0)])
+    extra_costs = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã", validators=[MinValueValidator(0)])
+    dekl = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è", validators=[MinValueValidator(0)])
+    proft = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal('20.00'), null=True, blank=True, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞", validators=[MinValueValidator(0)])
+    hide_markup_in = models.ForeignKey(
+        'CarService', 
+        on_delete=models.SET_NULL, 
+        null=True, 
+        blank=True, 
+        related_name='cars_with_hidden_markup',
+        verbose_name="–°–∫—Ä—ã—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≤ —É—Å–ª—É–≥–µ",
+        help_text="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –∏–Ω–≤–æ–π—Å–µ)"
+    )
+    free_days = models.PositiveIntegerField(default=0, verbose_name="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏")
+    rate = models.DecimalField(max_digits=10, decimal_places=2, default=5, verbose_name="–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏", validators=[MinValueValidator(0)])
+    complex_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ö–æ–º–ø–ª–µ–∫—Å", validators=[MinValueValidator(0)])
+    price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¶–µ–Ω–∞", validators=[MinValueValidator(0)])
+    auction_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ê—É–∫—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä", validators=[MinValueValidator(0)])
+    transport_usa = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –°–®–ê", validators=[MinValueValidator(0)])
+    ocean_freight = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–û–∫–µ–∞–Ω—Å–∫–∏–π —Ñ—Ä–∞—Ö—Ç", validators=[MinValueValidator(0)])
+    transport_kz = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ö–ó", validators=[MinValueValidator(0)])
+    broker_fee = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å–±–æ—Ä", validators=[MinValueValidator(0)])
+    additional_expenses = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã", validators=[MinValueValidator(0)])
+
+    objects = OptimizedCarManager()
+    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
+    legacy_objects = CarManager()
+
+    def get_status_color(self):
+        return STATUS_COLORS.get(self.status, '#3a8c3d')
+
+    def apply_warehouse_defaults(self, force: bool = False):
+        """
+        –ö–æ–ø–∏—Ä—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ –≤ –∞–≤—Ç–æ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥.
+        force=True ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Å–∫–ª–∞–¥–∞.
+        force=False ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ –¥–µ—Ñ–æ–ª—Ç—É –º–æ–¥–µ–ª–∏.
+        """
+        if not self.warehouse:
+            return
+
+        from decimal import Decimal
+
+        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
+        warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True)
+        
+        # –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π —É—Å–ª—É–≥ –Ω–∞ –ø–æ–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
+        service_mapping = {
+            '–¶–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É': 'unload_fee',
+            '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞': 'delivery_fee', 
+            '–ü–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª': 'loading_fee',
+            '–î–æ–∫—É–º–µ–Ω—Ç—ã': 'docs_fee',
+            '–ü–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É': 'transfer_fee',
+            '–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.': 'transit_declaration',
+            '–≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.': 'export_declaration',
+            '–î–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã': 'extra_costs',
+            '–ö–æ–º–ø–ª–µ–∫—Å': 'complex_fee',
+            '–°—Ç–∞–≤–∫–∞ –∑–∞ —Å—É—Ç–∫–∏': 'rate',
+            '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏': 'free_days',
+        }
+
+        for service in warehouse_services:
+            car_field = service_mapping.get(service.name)
+            if car_field:
+                wh_val = service.default_price or 0
+                cur_val = getattr(self, car_field, None)
+
+                if force:
+                    setattr(self, car_field, wh_val)
+                else:
+                    if cur_val is None:
+                        setattr(self, car_field, wh_val)
+                    else:
+                        try:
+                            cur = Decimal(str(cur_val))
+                            if cur == 0:
+                                setattr(self, car_field, wh_val)
+                            else:
+                                model_default = self._meta.get_field(car_field).default
+                                mdl = Decimal(str(model_default or 0))
+                                if cur == mdl:
+                                    setattr(self, car_field, wh_val)
+                        except Exception:
+                            setattr(self, car_field, wh_val)
+
+
+
+    def warehouse_details(self):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ –∏–∑ —Å–∫–ª–∞–¥–∞ –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥."""
+        if not self.warehouse:
+            return {"message": "–°–∫–ª–∞–¥ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}
+        
+        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞
+        warehouse_services = WarehouseService.objects.filter(warehouse=self.warehouse, is_active=True)
+        
+        details = {"–ù–∞–∑–≤–∞–Ω–∏–µ": self.warehouse.name}
+        for service in warehouse_services:
+            details[service.name] = str(service.default_price)
+        
+        return details
+
+    def set_initial_warehouse_values(self):
+        """–ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç—ã —Å–æ —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ.
+        –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –º–æ–¥–µ–ª—å–Ω–æ–º—É –¥–µ—Ñ–æ–ª—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, rate=5) –∏–ª–∏ 0 ‚Äî –±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞.
+        """
+        if not self.warehouse:
+            return
+
+        initializing = self._state.adding
+
+        def _override(cur_val, field_name, wh_val):
+            if cur_val is None:
+                return wh_val
+            if initializing:
+                # –ø–µ—Ä–µ—Ç–∏—Ä–∞–µ–º, –µ—Å–ª–∏ 0 –∏–ª–∏ —Ä–∞–≤–Ω–æ –º–æ–¥–µ–ª—å–Ω–æ–º—É –¥–µ—Ñ–æ–ª—Ç—É
+                try:
+                    cur = Decimal(str(cur_val))
+                    if cur == 0:
+                        return wh_val
+                    model_default = self._meta.get_field(field_name).default
+                    mdl = Decimal(str(model_default or 0))
+                    if cur == mdl:
+                        return wh_val
+                except Exception:
+                    return wh_val
+            return cur_val
+
+        # –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è (rate —É–¥–∞–ª—ë–Ω - —Å—Ç–∞–≤–∫–∞ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ")
+        self.free_days = _override(self.free_days, 'free_days', self.warehouse.free_days or 0)
+
+        # –∑–∞–æ–¥–Ω–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ —É—Å–ª—É–≥–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
+        self.unload_fee = _override(self.unload_fee, 'unload_fee', self.warehouse.default_unloading_fee or 0)
+        self.delivery_fee = _override(self.delivery_fee, 'delivery_fee', self.warehouse.delivery_to_warehouse or 0)
+        self.loading_fee = _override(self.loading_fee, 'loading_fee', self.warehouse.loading_on_trawl or 0)
+        self.docs_fee = _override(self.docs_fee, 'docs_fee', self.warehouse.documents_fee or 0)
+        self.transfer_fee = _override(self.transfer_fee, 'transfer_fee', self.warehouse.transfer_fee or 0)
+        self.transit_declaration = _override(self.transit_declaration, 'transit_declaration',
+                                             self.warehouse.transit_declaration or 0)
+        self.export_declaration = _override(self.export_declaration, 'export_declaration',
+                                            self.warehouse.export_declaration or 0)
+        self.extra_costs = _override(self.extra_costs, 'extra_costs', self.warehouse.additional_expenses or 0)
+        self.complex_fee = _override(self.complex_fee, 'complex_fee', self.warehouse.complex_fee or 0)
+
+    def calculate_total_price(self):
+        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥ CarService.
+
+        –¶–µ–Ω–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö —É—Å–ª—É–≥ + —Å—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫.
+        
+        –í–ê–ñ–ù–û: total_price –≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É (markup_amount)!
+        –≠—Ç–æ –ø–æ–ª–Ω–∞—è —Å—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –∑–∞–ø–ª–∞—Ç–∏—Ç –∫–ª–∏–µ–Ω—Ç.
+        """
+        from django.db.models import Sum
+        
+        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à related objects —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ –ë–î
+        if hasattr(self, '_prefetched_objects_cache'):
+            self._prefetched_objects_cache.pop('car_services', None)
+        
+        # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –∏ —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
+        self.update_days_and_storage()
+
+        # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—ã –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –∏–∑ CarService (final_price = –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ë–ï–ó –Ω–∞—Ü–µ–Ω–∫–∏)
+        line_total = self.get_services_total_by_provider('LINE')
+        carrier_total = self.get_services_total_by_provider('CARRIER')
+        warehouse_total = self.get_warehouse_services_total()  # –í–∫–ª—é—á–∞–µ—Ç —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ"
+        company_total = self.get_services_total_by_provider('COMPANY')
+        
+        # –°—É–º–º–∞ –≤—Å–µ—Ö —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫
+        distributed_markup = self.car_services.aggregate(total=Sum('markup_amount'))['total'] or Decimal('0')
+
+        # –û–±—â–∞—è —Å—É–º–º–∞ = —É—Å–ª—É–≥–∏ + —Å–∫—Ä—ã—Ç—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏
+        self.total_price = line_total + warehouse_total + carrier_total + company_total + distributed_markup
+
+        return self.total_price
+
+    def update_days_and_storage(self):
+        """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è.
+        
+        –¶–µ–Ω–∞ –∑–∞ –¥–µ–Ω—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.
+        –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å
+        """
+        if not self.unload_date or not self.warehouse:
+            self.days = 0
+            self.storage_cost = Decimal('0.00')
+            self._update_storage_service_price()
+            return
+
+        # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∫–ª–∞–¥–∞
+        free_days = int(self.warehouse.free_days or 0)
+
+        end_date = self.transfer_date if self.status == 'TRANSFERRED' and self.transfer_date else timezone.now().date()
+        total_days = (end_date - self.unload_date).days + 1
+        self.days = max(0, total_days - free_days)
+        
+        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ"
+        daily_rate = self._get_storage_daily_rate()
+        self.storage_cost = Decimal(str(self.days)) * daily_rate
+        
+        # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ CarService
+        self._update_storage_service_price()
+    
+    def _get_storage_daily_rate(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å –∏–∑ —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' —Å–∫–ª–∞–¥–∞."""
+        if not self.warehouse:
+            return Decimal('0.00')
+        
+        try:
+            storage_service = WarehouseService.objects.filter(
+                warehouse=self.warehouse,
+                name='–•—Ä–∞–Ω–µ–Ω–∏–µ',
+                is_active=True
+            ).first()
+            
+            if storage_service:
+                return Decimal(str(storage_service.default_price or 0))
+        except Exception:
+            pass
+        
+        return Decimal('0.00')
+    
+    def _update_storage_service_price(self):
+        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' –≤ CarService.
+        
+        –¶–µ–Ω–∞ = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞_–∑–∞_–¥–µ–Ω—å (–∏–∑ WarehouseService)
+        
+        –í–ê–ñ–ù–û: markup_amount –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
+        –ù–∞—Ü–µ–Ω–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ (–∏–∑ default_markup)
+        –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –∞–¥–º–∏–Ω–∫–µ.
+        """
+        if not self.pk or not self.warehouse:
+            return
+        
+        try:
+            # –ù–∞—Ö–æ–¥–∏–º —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞
+            storage_service = WarehouseService.objects.filter(
+                warehouse=self.warehouse,
+                name='–•—Ä–∞–Ω–µ–Ω–∏–µ',
+                is_active=True
+            ).first()
+            
+            if storage_service:
+                days = Decimal(str(self.days))
+                # –°—Ç–æ–∏–º–æ—Å—Ç—å = –ø–ª–∞—Ç–Ω—ã–µ_–¥–Ω–∏ √ó —Ü–µ–Ω–∞_–∑–∞_–¥–µ–Ω—å
+                storage_price = days * Decimal(str(storage_service.default_price or 0))
+                
+                # –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —Ü–µ–Ω—É –≤ CarService (markup_amount –Ω–µ —Ç—Ä–æ–≥–∞–µ–º!)
+                # –ù–∞—Ü–µ–Ω–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –≤ –∞–¥–º–∏–Ω–∫–µ
+                from core.models import CarService
+                CarService.objects.filter(
+                    car=self,
+                    service_type='WAREHOUSE',
+                    service_id=storage_service.id
+                ).update(custom_price=storage_price)
+                
+                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º prefetch –∫—ç—à —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
+                if hasattr(self, '_prefetched_objects_cache'):
+                    self._prefetched_objects_cache.pop('car_services', None)
+        except Exception:
+            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
+
+    def sync_with_container(self, container, ths_per_car):
+        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º."""
+        self.status = container.status
+        self.warehouse = container.warehouse
+        self.unload_date = container.unload_date
+        self.transfer_date = timezone.now().date() if container.status == 'TRANSFERRED' else None
+        self.ths = ths_per_car
+        self.dekl = container.dekl
+        self.proft = container.proft
+        self.set_initial_warehouse_values()
+        self.update_days_and_storage()
+        self.calculate_total_price()
+
+    WAREHOUSE_FEE_FIELDS = (
+        'unload_fee',  # —Ü–µ–Ω–∞ –∑–∞ —Ä–∞–∑–≥—Ä—É–∑–∫—É
+        'delivery_fee',  # –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞
+        'loading_fee',  # –ø–æ–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç—Ä–∞–ª
+        'docs_fee',  # –¥–æ–∫—É–º–µ–Ω—Ç—ã
+        'transfer_fee',  # –ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É
+        'transit_declaration',  # —Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–µ–∫–ª.
+        'export_declaration',  # —ç–∫—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–µ–∫–ª.
+        'extra_costs',  # –¥–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã
+        'complex_fee',  # –∫–æ–º–ø–ª–µ–∫—Å
+    )
+
+    def warehouse_payment_amount(self) -> Decimal:
+        """–°–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω—ã —Å–∫–ª–∞–¥—É –∑–∞ —É—Å–ª—É–≥–∏ (–±–µ–∑ —É—á—ë—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É—Å–ª—É–≥."""
+        return self.get_warehouse_services_total()
+
+    @property
+    def warehouse_payment(self) -> Decimal:
+        # —É–¥–æ–±–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
+        return self.warehouse_payment_amount()
+    
+    def get_line_services(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –ª–∏–Ω–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
+        if not self.line or not self.pk:
+            return self.car_services.none()
+        # –ü–æ–ª—É—á–∞–µ–º ID —É—Å–ª—É–≥ –ª–∏–Ω–∏–∏
+        line_service_ids = LineService.objects.only('id').filter(line=self.line).values_list('id', flat=True)
+        return self.car_services.filter(service_type='LINE', service_id__in=line_service_ids)
+    
+    def get_carrier_services(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
+        if not self.carrier or not self.pk:
+            return self.car_services.none()
+        # –ü–æ–ª—É—á–∞–µ–º ID —É—Å–ª—É–≥ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞
+        carrier_service_ids = CarrierService.objects.only('id').filter(carrier=self.carrier).values_list('id', flat=True)
+        return self.car_services.filter(service_type='CARRIER', service_id__in=carrier_service_ids)
+    
+    def get_company_services(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
+        if not self.pk:
+            return self.car_services.none()
+        return self.car_services.filter(service_type='COMPANY')
+    
+    def get_warehouse_services(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–≤–∫–ª—é—á–∞—è —É—Å–ª—É–≥–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤)"""
+        if not self.pk:
+            return self.car_services.none()
+        # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É –∞–≤—Ç–æ–º–æ–±–∏–ª—é
+        return self.car_services.filter(service_type='WAREHOUSE')
+    
+    def get_services_total_by_provider(self, provider_type):
+        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞.
+        
+        –î–ª—è —Å–∫–ª–∞–¥–∞: —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" (CarService).
+        """
+        total = Decimal('0.00')
+        if provider_type == 'LINE' and self.line:
+            services = self.get_line_services()
+        elif provider_type == 'CARRIER' and self.carrier:
+            services = self.get_carrier_services()
+        elif provider_type == 'COMPANY':
+            services = self.get_company_services()
+        elif provider_type == 'WAREHOUSE' and self.warehouse:
+            services = self.get_warehouse_services()
+        else:
+            return total
+            
+        for service in services:
+            total += Decimal(str(service.final_price))
+        return total
+    
+    def get_warehouse_services_total(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞ (–±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è)"""
+        if not self.warehouse:
+            return Decimal('0.00')
+        
+        services = self.get_warehouse_services()
+        total = Decimal('0.00')
+        
+        for service in services:
+            total += Decimal(str(service.final_price))
+        
+        return total
+    
+    def calculate_storage_cost(self):
+        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ.
+        
+        –°—Ç–∞–≤–∫–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ —Å–∫–ª–∞–¥–∞.
+        """
+        if not self.warehouse or not self.unload_date:
+            return Decimal('0.00')
+        
+        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –∏–∑ —É—Å–ª—É–≥–∏ "–•—Ä–∞–Ω–µ–Ω–∏–µ" –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ —Å–æ —Å–∫–ª–∞–¥–∞
+        daily_rate = self._get_storage_daily_rate()
+        free_days = self.warehouse.free_days or 0
+        
+        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
+        # –í–∫–ª—é—á–∞–µ–º –¥–µ–Ω—å —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∏ –¥–µ–Ω—å –∑–∞–±–æ—Ä–∞ –∞–≤—Ç–æ
+        end_date = self.transfer_date if self.status == 'TRANSFERRED' and self.transfer_date else timezone.now().date()
+        total_days = (end_date - self.unload_date).days + 1
+        
+        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ (–æ–±—â–∏–µ –¥–Ω–∏ –º–∏–Ω—É—Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
+        chargeable_days = max(0, total_days - free_days)
+        
+        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
+        storage_cost = daily_rate * chargeable_days
+        
+        return storage_cost
+
+    def get_rates_by_provider(self, provider_type):
+        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫–∏ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"""
+        rates = []
+        if provider_type == 'LINE' and self.line:
+            services = self.get_line_services()
+        elif provider_type == 'CARRIER' and self.carrier:
+            services = self.get_carrier_services()
+        elif provider_type == 'WAREHOUSE' and self.warehouse:
+            services = self.get_warehouse_services()
+        else:
+            return rates
+            
+        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º service_type, –∏–∑–º–µ–Ω–∏–º –ª–æ–≥–∏–∫—É)
+        return rates
+
+    def get_parameters_by_provider(self, provider_type):
+        """–ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —Ç–∏–ø—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"""
+        parameters = []
+        if provider_type == 'LINE' and self.line:
+            services = self.get_line_services()
+        elif provider_type == 'CARRIER' and self.carrier:
+            services = self.get_carrier_services()
+        elif provider_type == 'WAREHOUSE' and self.warehouse:
+            services = self.get_warehouse_services()
+        else:
+            return parameters
+            
+        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–º service_type, –∏–∑–º–µ–Ω–∏–º –ª–æ–≥–∏–∫—É)
+        return parameters
+
+    def save(self, *args, **kwargs):
+        # –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –î–û –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–æ–≤
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
+        if not self.warehouse and self.container and self.container.pk and self.container.warehouse:
+            self.warehouse = self.container.warehouse
+        
+        # –î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –í–°–ï–ì–î–ê –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
+        if self.container and self.container.pk and self.container.unload_date:
+            self.unload_date = self.container.unload_date
+
+        if self.transfer_date and self.status != 'TRANSFERRED':
+            self.status = 'TRANSFERRED'
+
+        # –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ ‚Äî —Ç—è–Ω–µ–º –¥–µ—Ñ–æ–ª—Ç—ã —Å–∫–ª–∞–¥–∞ (–≤ —Ç.—á. rate/free_days) –î–û –ø–µ—Ä–≤–æ–≥–æ save()
+        if self.pk is None and self.warehouse:
+            try:
+                self.set_initial_warehouse_values()
+            except Exception as e:
+                logger.error(f"Failed to set initial warehouse values for car {self.vin}: {e}")
+
+        if self.status == 'TRANSFERRED' and not self.transfer_date:
+            from django.utils import timezone
+            self.transfer_date = timezone.now().date()
+
+        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å pk
+        super().save(*args, **kwargs)
+        
+        # –ø–µ—Ä–µ—Å—á—ë—Ç –ü–û–°–õ–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –∫–æ–≥–¥–∞ —É –æ–±—ä–µ–∫—Ç–∞ —É–∂–µ –µ—Å—Ç—å pk
+        try:
+            old_total_price = self.total_price
+            
+            self.calculate_total_price()
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—â–µ —Ä–∞–∑ —Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
+            if self.total_price != old_total_price:
+                super().save(update_fields=['total_price'])
+        except Exception as e:
+            logger.error(f"Failed to calculate total price for car {self.vin}: {e}")
+
+        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
+        if self.pk:
+            try:
+                Car.objects.update_related(self)
+            except Exception as e:
+                logger.error(f"Failed to update related objects for car {self.id}: {e}")
+            
+            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
+            if self.container and self.container.pk:
+                try:
+                    self.container.check_and_update_status_from_cars()
+                except Exception as e:
+                    logger.error(f"Failed to check container status for car {self.id}: {e}")
+
+        def _notify():
+            try:
+                channel_layer = get_channel_layer()
+                async_to_sync(channel_layer.group_send)(
+                    "updates",
+                    {
+                        "type": "data_update",
+                        "data": {
+                            "model": "Car",
+                            "id": self.id,
+                            "status": self.status,
+                            "storage_cost": str(self.storage_cost),
+                            "days": self.days,
+                            "price": str(self.total_price),
+                        },
+                    },
+                )
+            except Exception as e:
+                logger.error(f"Failed to send WebSocket notification for car {self.id}: {e}")
+        transaction.on_commit(_notify)
+
+    def __str__(self):
+        return f"{self.brand} ({self.vin})"
+
+    class Meta:
+        verbose_name = "–ê–≤—Ç–æ–º–æ–±–∏–ª—å"
+        verbose_name_plural = "–ê–≤—Ç–æ–º–æ–±–∏–ª–∏"
+        indexes = [
+            models.Index(fields=['vin']),
+            models.Index(fields=['status']),
+            models.Index(fields=['unload_date', 'transfer_date']),
+            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
+            models.Index(fields=['client', 'status']),
+            models.Index(fields=['warehouse', 'status']),
+            models.Index(fields=['line']),
+            models.Index(fields=['carrier']),
+            models.Index(fields=['container']),
+            models.Index(fields=['unload_date']),
+            models.Index(fields=['transfer_date']),
+        ]
+
+
+class Company(models.Model):
+    """–ú–æ–¥–µ–ª—å –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Caromoto Lithuania"""
+    
+    name = models.CharField(max_length=100, default="Caromoto Lithuania", verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏")
+    
+    # –ï–¥–∏–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
+    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0.00, verbose_name="–ë–∞–ª–∞–Ω—Å",
+                                  help_text="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–º –¥–æ–ª–∂–Ω—ã, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º—ã –¥–æ–ª–∂–Ω—ã")
+    balance_updated_at = models.DateTimeField(auto_now=True, verbose_name="–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω")
+    
+    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    
+    objects = OptimizedCompanyManager()
+    
+    class Meta:
+        verbose_name = "–ö–æ–º–ø–∞–Ω–∏—è"
+        verbose_name_plural = "–ö–æ–º–ø–∞–Ω–∏–∏"
+    
+    def __str__(self):
+        return self.name
+
+
+class CompanyService(models.Model):
+    """–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π"""
+    company = models.ForeignKey(Company, on_delete=models.CASCADE, related_name='services', verbose_name="–ö–æ–º–ø–∞–Ω–∏—è")
+    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
+    default_markup = models.DecimalField(
+        max_digits=10,
+        decimal_places=2,
+        default=0,
+        verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ"
+    )
+    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
+    add_by_default = models.BooleanField(
+        default=False,
+        verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏"
+    )
+    
+    def __str__(self):
+        return f"{self.company.name} - {self.name}"
+    
+    class Meta:
+        verbose_name = "–£—Å–ª—É–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏"
+        verbose_name_plural = "–£—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π"
+
+# –ú–æ–¥–µ–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É—Å–ª—É–≥
+
+
+
+class LineService(models.Model):
+    """–£—Å–ª—É–≥–∏ –º–æ—Ä—Å–∫–∏—Ö –ª–∏–Ω–∏–π"""
+    line = models.ForeignKey(Line, on_delete=models.CASCADE, related_name='services', verbose_name="–õ–∏–Ω–∏—è")
+    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
+    default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ")
+    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
+    add_by_default = models.BooleanField(
+        default=False,
+        verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∏–∏"
+    )
+    
+    def __str__(self):
+        return f"{self.line.name} - {self.name}"
+    
+    class Meta:
+        verbose_name = "–£—Å–ª—É–≥–∞ –ª–∏–Ω–∏–∏"
+        verbose_name_plural = "–£—Å–ª—É–≥–∏ –ª–∏–Ω–∏–π"
+
+
+class CarrierService(models.Model):
+    """–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤"""
+    carrier = models.ForeignKey(Carrier, on_delete=models.CASCADE, related_name='services', verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
+    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
+    default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ")
+    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
+    add_by_default = models.BooleanField(
+        default=False,
+        verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+    )
+    
+    def __str__(self):
+        return f"{self.carrier.name} - {self.name}"
+    
+    class Meta:
+        verbose_name = "–£—Å–ª—É–≥–∞ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+        verbose_name_plural = "–£—Å–ª—É–≥–∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–æ–≤"
+
+
+class WarehouseService(models.Model):
+    """–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤"""
+    warehouse = models.ForeignKey(Warehouse, on_delete=models.CASCADE, related_name='services', verbose_name="–°–∫–ª–∞–¥")
+    name = models.CharField(max_length=200, verbose_name="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    default_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–¶–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
+    default_markup = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å–ª—É–≥–∏ –¥–ª—è –∞–≤—Ç–æ")
+    is_active = models.BooleanField(default=True, verbose_name="–ê–∫—Ç–∏–≤–Ω–∞")
+    add_by_default = models.BooleanField(default=False, verbose_name="–î–æ–±–∞–≤–ª—è—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
+        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ")
+    
+    def __str__(self):
+        return f"{self.warehouse.name} - {self.name}"
+    
+    class Meta:
+        verbose_name = "–£—Å–ª—É–≥–∞ —Å–∫–ª–∞–¥–∞"
+        verbose_name_plural = "–£—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–æ–≤"
+
+
+class DeletedCarService(models.Model):
+    """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —É—Å–ª—É–≥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
+    car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='deleted_services', verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
+    service_type = models.CharField(max_length=20, choices=[
+        ('LINE', '–õ–∏–Ω–∏—è'),
+        ('CARRIER', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'),
+        ('WAREHOUSE', '–°–∫–ª–∞–¥'),
+        ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'),
+    ], verbose_name="–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
+    service_id = models.PositiveIntegerField(verbose_name="ID —É—Å–ª—É–≥–∏")
+    deleted_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è")
+    
+    class Meta:
+        unique_together = ['car', 'service_type', 'service_id']
+        verbose_name = "–£–¥–∞–ª–µ–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"
+        verbose_name_plural = "–£–¥–∞–ª–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
+
+
+class CarService(models.Model):
+    """–°–≤—è–∑—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —É—Å–ª—É–≥–∞–º–∏ –∏ –∏—Ö —Ü–µ–Ω–∞–º–∏"""
+    SERVICE_TYPES = [
+        ('LINE', '–õ–∏–Ω–∏—è'),
+        ('CARRIER', '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'),
+        ('WAREHOUSE', '–°–∫–ª–∞–¥'),
+        ('COMPANY', '–ö–æ–º–ø–∞–Ω–∏—è'),
+    ]
+    
+    car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='car_services', verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
+    service_type = models.CharField(max_length=20, choices=SERVICE_TYPES, verbose_name="–¢–∏–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
+    service_id = models.PositiveIntegerField(verbose_name="ID —É—Å–ª—É–≥–∏")
+    custom_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞")
+    markup_amount = models.DecimalField(
+        max_digits=10, 
+        decimal_places=2, 
+        default=0, 
+        verbose_name="–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞",
+        help_text="–°—É–º–º–∞ –Ω–∞—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ü–µ–Ω–µ —É—Å–ª—É–≥–∏ –≤ –∏–Ω–≤–æ–π—Å–µ (—Å–∫—Ä—ã—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)"
+    )
+    quantity = models.PositiveIntegerField(default=1, verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ")
+    notes = models.TextField(blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    
+    def __str__(self):
+        return f"{self.car.vin} - {self.get_service_name()}: {self.final_price}"
+    
+    def get_service_name(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"""
+        if self.service_type == 'LINE':
+            try:
+                service = LineService.objects.get(id=self.service_id)
+                return service.name
+            except LineService.DoesNotExist:
+                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
+        elif self.service_type == 'CARRIER':
+            try:
+                service = CarrierService.objects.get(id=self.service_id)
+                return service.name
+            except CarrierService.DoesNotExist:
+                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
+        elif self.service_type == 'WAREHOUSE':
+            try:
+                service = WarehouseService.objects.get(id=self.service_id)
+                return service.name
+            except WarehouseService.DoesNotExist:
+                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
+        elif self.service_type == 'COMPANY':
+            try:
+                service = CompanyService.objects.get(id=self.service_id)
+                return service.name
+            except CompanyService.DoesNotExist:
+                return "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
+        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞"
+    
+    def get_default_price(self):
+        """–ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
+        if self.service_type == 'LINE':
+            try:
+                service = LineService.objects.get(id=self.service_id)
+                return service.default_price
+            except LineService.DoesNotExist:
+                return 0
+        elif self.service_type == 'CARRIER':
+            try:
+                service = CarrierService.objects.get(id=self.service_id)
+                return service.default_price
+            except CarrierService.DoesNotExist:
+                return 0
+        elif self.service_type == 'WAREHOUSE':
+            try:
+                service = WarehouseService.objects.get(id=self.service_id)
+                return service.default_price
+            except WarehouseService.DoesNotExist:
+                return 0
+        elif self.service_type == 'COMPANY':
+            try:
+                service = CompanyService.objects.get(id=self.service_id)
+                return service.default_price
+            except CompanyService.DoesNotExist:
+                return 0
+        return 0
+    
+    @property
+    def final_price(self):
+        """–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–ë–ï–ó —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ - –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞)"""
+        # –ò—Å–ø–æ–ª—å–∑—É–µ–º custom_price –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ 0), –∏–Ω–∞—á–µ default_price
+        price = self.custom_price if self.custom_price is not None else self.get_default_price()
+        return price * self.quantity
+    
+    @property
+    def invoice_price(self):
+        """–¶–µ–Ω–∞ –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ (–° —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–π –Ω–∞—Ü–µ–Ω–∫–∏)"""
+        # –ò—Å–ø–æ–ª—å–∑—É–µ–º custom_price –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ 0), –∏–Ω–∞—á–µ default_price
+        base_price = self.custom_price if self.custom_price is not None else self.get_default_price()
+        markup = self.markup_amount or Decimal('0')
+        return (base_price + markup) * self.quantity
+    
+    def get_total_distributed_markup(self):
+        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ"""
+        if not self.car_id:
+            return Decimal('0')
+        return CarService.objects.filter(car_id=self.car_id).aggregate(
+            total=models.Sum('markup_amount')
+        )['total'] or Decimal('0')
+    
+    class Meta:
+        verbose_name = "–£—Å–ª—É–≥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"
+        verbose_name_plural = "–£—Å–ª—É–≥–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
+        unique_together = ('car', 'service_type', 'service_id')
+        indexes = [
+            models.Index(fields=['car', 'service_type']),
+            models.Index(fields=['service_type', 'service_id']),
+            models.Index(fields=['car']),
+        ]
+
+
+# –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥
+from django.db.models.signals import post_save, post_delete
+from django.dispatch import receiver
+
+
+@receiver(post_save, sender=CarService)
+def recalculate_car_price_on_service_save(sender, instance, **kwargs):
+    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏"""
+    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥
+    if getattr(instance.car, '_creating_services', False):
+        return
+    try:
+        instance.car.calculate_total_price()
+        # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
+        Car.objects.filter(id=instance.car.id).update(
+            total_price=instance.car.total_price
+        )
+    except Exception as e:
+        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}")
+
+
+@receiver(post_delete, sender=CarService)
+def recalculate_car_price_on_service_delete(sender, instance, **kwargs):
+    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏"""
+    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ª—É–≥
+    if getattr(instance.car, '_creating_services', False):
+        return
+    try:
+        instance.car.calculate_total_price()
+        # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
+        Car.objects.filter(id=instance.car.id).update(
+            total_price=instance.car.total_price
+        )
+    except Exception as e:
+        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏: {e}")
+
+
+@receiver(post_save, sender=Car)
+def recalculate_car_price_on_car_save(sender, instance, **kwargs):
+    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ —Ä–∞—Å—á–µ—Ç"""
+    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏
+    if getattr(instance, '_recalculating_price', False):
+        return
+    if getattr(instance, '_creating_services', False):
+        return
+    
+    try:
+        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
+        if hasattr(instance, '_state') and instance._state.adding:
+            return
+        
+        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ update_fields=['total_price'] - –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ü–µ–Ω–∞ —É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞
+        update_fields = kwargs.get('update_fields')
+        if update_fields and 'total_price' in update_fields:
+            return
+        
+        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏
+        instance._recalculating_price = True
+        
+        try:
+            instance.calculate_total_price()
+            # –ò—Å–ø–æ–ª—å–∑—É–µ–º update() –≤–º–µ—Å—Ç–æ save() —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
+            Car.objects.filter(id=instance.id).update(
+                total_price=instance.total_price
+            )
+        finally:
+            instance._recalculating_price = False
+            
+    except Exception as e:
+        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è: {e}")
+
+
+class AutoTransport(models.Model):
+    """–ê–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–π—Å–∞"""
+    STATUS_CHOICES = [
+        ('DRAFT', '–ß–µ—Ä–Ω–æ–≤–∏–∫'),
+        ('FORMED', '–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω'),
+        ('LOADED', '–ó–∞–≥—Ä—É–∂–µ–Ω'),
+        ('IN_TRANSIT', '–í –ø—É—Ç–∏'),
+        ('DELIVERED', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'),
+        ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω'),
+    ]
+    
+    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
+    number = models.CharField(max_length=50, unique=True, verbose_name="–ù–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞",
+                               help_text="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞")
+    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='DRAFT', verbose_name="–°—Ç–∞—Ç—É—Å")
+    
+    # –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
+    carrier = models.ForeignKey(Carrier, on_delete=models.PROTECT, related_name='auto_transports', 
+                                 verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫")
+    eori_code = models.CharField(max_length=50, blank=True, verbose_name="EORI –∫–æ–¥",
+                                  help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞")
+    
+    # –ê–≤—Ç–æ–≤–æ–∑ (—Ç—è–≥–∞—á + –ø—Ä–∏—Ü–µ–ø)
+    truck = models.ForeignKey(CarrierTruck, on_delete=models.SET_NULL, null=True, blank=True,
+                               related_name='transports', verbose_name="–ê–≤—Ç–æ–≤–æ–∑")
+    truck_number_manual = models.CharField(max_length=20, blank=True, verbose_name="–ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞ (–≤—Ä—É—á–Ω—É—é)",
+                                            help_text="–ï—Å–ª–∏ –∞–≤—Ç–æ–≤–æ–∑–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ")
+    trailer_number_manual = models.CharField(max_length=20, blank=True, verbose_name="–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞ (–≤—Ä—É—á–Ω—É—é)",
+                                              help_text="–ï—Å–ª–∏ –∞–≤—Ç–æ–≤–æ–∑–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ")
+    
+    # –í–æ–¥–∏—Ç–µ–ª—å
+    driver = models.ForeignKey(CarrierDriver, on_delete=models.SET_NULL, null=True, blank=True,
+                                related_name='transports', verbose_name="–í–æ–¥–∏—Ç–µ–ª—å")
+    driver_name_manual = models.CharField(max_length=100, blank=True, verbose_name="–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è (–≤—Ä—É—á–Ω—É—é)",
+                                           help_text="–ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ")
+    driver_phone = models.CharField(max_length=20, blank=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è",
+                                     help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ –≤–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –≤–≤–æ–¥–∏—Ç—Å—è –≤—Ä—É—á–Ω—É—é")
+    
+    # –ì—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
+    border_crossing = models.CharField(max_length=100, blank=True, verbose_name="–ì—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è",
+                                        help_text="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü—ã")
+    
+    # –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –∞–≤—Ç–æ–≤–æ–∑–µ
+    cars = models.ManyToManyField('Car', related_name='auto_transports', blank=True, 
+                                   verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª–∏")
+    
+    # –î–∞—Ç—ã
+    loading_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
+    departure_date = models.DateField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
+    estimated_delivery_date = models.DateField(null=True, blank=True, verbose_name="–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏")
+    actual_delivery_date = models.DateField(null=True, blank=True, verbose_name="–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏")
+    
+    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
+    notes = models.TextField(blank=True, verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è")
+    
+    # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    created_by = models.CharField(max_length=100, blank=True, verbose_name="–°–æ–∑–¥–∞–ª")
+    
+    class Meta:
+        verbose_name = "–ê–≤—Ç–æ–≤–æ–∑ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É"
+        verbose_name_plural = "–ê–≤—Ç–æ–≤–æ–∑—ã –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É"
+        ordering = ['-created_at']
+    
+    def __str__(self):
+        return f"–ê–≤—Ç–æ–≤–æ–∑ {self.number} - {self.carrier.name}"
+    
+    def save(self, *args, **kwargs):
+        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º EORI –∫–æ–¥ –∏–∑ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
+        if not self.eori_code and self.carrier:
+            self.eori_code = self.carrier.eori_code or ''
+        
+        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
+        if not self.number:
+            from django.utils import timezone
+            date_str = timezone.now().strftime('%Y%m%d')
+            count = AutoTransport.objects.filter(number__startswith=f'AT-{date_str}').count()
+            self.number = f'AT-{date_str}-{count + 1:03d}'
+        
+        # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –≤–æ–¥–∏—Ç–µ–ª—å
+        if self.driver and not self.driver_phone:
+            self.driver_phone = self.driver.phone
+        
+        super().save(*args, **kwargs)
+    
+    @property
+    def truck_full_number(self):
+        """–ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞"""
+        if self.truck:
+            return self.truck.full_number
+        elif self.truck_number_manual:
+            if self.trailer_number_manual:
+                return f"{self.truck_number_manual} / {self.trailer_number_manual}"
+            return self.truck_number_manual
+        return "–ù–µ —É–∫–∞–∑–∞–Ω"
+    
+    @property
+    def driver_full_name(self):
+        """–ü–æ–ª–Ω–æ–µ –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è"""
+        if self.driver:
+            return self.driver.full_name
+        return self.driver_name_manual or "–ù–µ —É–∫–∞–∑–∞–Ω"
+    
+    @property
+    def cars_count(self):
+        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∞–≤—Ç–æ–≤–æ–∑–µ"""
+        return self.cars.count()
+    
+    def get_clients(self):
+        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∞–≤—Ç–æ–≤–æ–∑–µ"""
+        return Client.objects.filter(car__in=self.cars.all()).distinct()
+    
+    def generate_invoices(self):
+        """–°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤"""
+        from .models_billing import NewInvoice
+        from django.utils import timezone
+        
+        clients = self.get_clients()
+        created_invoices = []
+        
+        for client in clients:
+            # –ü–æ–ª—É—á–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∞–≤—Ç–æ–≤–æ–∑–µ
+            client_cars = self.cars.filter(client=client)
+            
+            if not client_cars.exists():
+                continue
+            
+            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∏–Ω–≤–æ–π—Å –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞
+            existing_invoice = NewInvoice.objects.filter(
+                auto_transport=self,
+                recipient_client=client
+            ).first()
+            
+            if existing_invoice:
+                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–≤–æ–π—Å
+                existing_invoice.cars.set(client_cars)
+                existing_invoice.regenerate_items_from_cars()
+                created_invoices.append(existing_invoice)
+            else:
+                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–≤–æ–π—Å
+                from .models import Company
+                company = Company.objects.filter(name='Caromoto Lithuania').first()
+                
+                if company:
+                    invoice = NewInvoice.objects.create(
+                        issuer_company=company,
+                        recipient_client=client,
+                        auto_transport=self,
+                        status='DRAFT',
+                        date=timezone.now().date()
+                    )
+                    invoice.cars.set(client_cars)
+                    invoice.regenerate_items_from_cars()
+                    created_invoices.append(invoice)
+        
+        return created_invoices
+
+
+# ==============================================================================
+# üéâ –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–í–û–ô–°–û–í –ò –ü–õ–ê–¢–ï–ñ–ï–ô
+# ==============================================================================
+# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã Django –∏—Ö –≤–∏–¥–µ–ª
+
+from .models_billing import (
+    NewInvoice,
+    InvoiceItem,
+    Transaction,
+    SimpleBalanceMixin
+)
+
+# ==============================================================================
+# üåê –ú–û–î–ï–õ–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û –°–ê–ô–¢–ê
+# ==============================================================================
+# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞
+
+from .models_website import (
+    ClientUser,
+    CarPhoto,
+    ContainerPhoto,
+    AIChat,
+    NewsPost,
+    ContactMessage,
+    TrackingRequest
 )
\ No newline at end of file
diff --git a/core/models_billing.py b/core/models_billing.py
index 5355ab4..6cdd67e 100644
--- a/core/models_billing.py
+++ b/core/models_billing.py
@@ -1,1043 +1,1054 @@
-"""
-–ù–æ–≤–∞—è —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å–æ–≤
-=========================================================
-
-–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
-- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å
-- –ü—Ä—è–º—ã–µ —Å–≤—è–∑–∏ –≤–º–µ—Å—Ç–æ generic
-- –û–¥–∏–Ω –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
-- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
-
-–ê–≤—Ç–æ—Ä—ã: AI Assistant
-–î–∞—Ç–∞: 30 —Å–µ–Ω—Ç—è–±—Ä—è 2025
-"""
-
-from django.db import models
-from django.core.validators import MinValueValidator
-from django.utils import timezone
-from django.contrib.auth import get_user_model
-from decimal import Decimal
-import logging
-
-logger = logging.getLogger('django')
-User = get_user_model()
-
-
-# ============================================================================
-# –ë–ê–ó–û–í–´–ô –ú–ò–ö–°–ò–ù –î–õ–Ø –ë–ê–õ–ê–ù–°–û–í
-# ============================================================================
-
-class SimpleBalanceMixin(models.Model):
-    """
-    –ü—Ä–æ—Å—Ç–æ–π –º–∏–∫—Å–∏–Ω –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤ - –û–î–ò–ù –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö!
-    
-    –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π,
-    –∞ –Ω–µ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –±–∞–ª–∞–Ω—Å–∞.
-    """
-    
-    balance = models.DecimalField(
-        max_digits=15, 
-        decimal_places=2, 
-        default=0,
-        verbose_name="–ë–∞–ª–∞–Ω—Å",
-        help_text="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥)"
-    )
-    
-    balance_updated_at = models.DateTimeField(
-        auto_now=True,
-        verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞"
-    )
-    
-    class Meta:
-        abstract = True
-    
-    def get_balance_breakdown(self):
-        """
-        –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –±–∞–ª–∞–Ω—Å–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
-        
-        Returns:
-            dict: {'cash': Decimal, 'card': Decimal, 'transfer': Decimal, 'total': Decimal}
-        """
-        from django.db.models import Sum, Q
-        
-        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
-        model_name = self.__class__.__name__.lower()
-        
-        # –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
-        incoming_filter = Q(**{f'to_{model_name}': self})
-        outgoing_filter = Q(**{f'from_{model_name}': self})
-        
-        # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
-        from .models_billing import Transaction
-        transactions = Transaction.objects.filter(incoming_filter | outgoing_filter)
-        
-        # –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã
-        breakdown = {}
-        for method in ['CASH', 'CARD', 'TRANSFER']:
-            incoming = transactions.filter(
-                incoming_filter, 
-                method=method
-            ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00')
-            
-            outgoing = transactions.filter(
-                outgoing_filter, 
-                method=method
-            ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00')
-            
-            breakdown[method.lower()] = incoming - outgoing
-        
-        breakdown['total'] = self.balance
-        return breakdown
-    
-    def get_balance_info(self):
-        """
-        –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–µ –≤ –ø–æ–Ω—è—Ç–Ω–æ–º –≤–∏–¥–µ
-        
-        Returns:
-            dict: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–ª–∞–Ω—Å–µ —Å —Å—Ç–∞—Ç—É—Å–æ–º –∏ —Ü–≤–µ—Ç–æ–º
-        """
-        balance = self.balance
-        
-        if balance > 0:
-            status = "–ü–ï–†–ï–ü–õ–ê–¢–ê"
-            color = "#28a745"  # –∑–µ–ª–µ–Ω—ã–π
-            description = f"–ü–µ—Ä–µ–ø–ª–∞—Ç–∞ {balance:.2f}"
-        elif balance < 0:
-            status = "–î–û–õ–ì"
-            color = "#dc3545"  # –∫—Ä–∞—Å–Ω—ã–π
-            description = f"–î–æ–ª–≥ {abs(balance):.2f}"
-        else:
-            status = "–ë–ê–õ–ê–ù–°"
-            color = "#6c757d"  # —Å–µ—Ä—ã–π
-            description = "–ë–∞–ª–∞–Ω—Å –Ω—É–ª–µ–≤–æ–π"
-        
-        return {
-            'balance': balance,
-            'status': status,
-            'color': color,
-            'description': description,
-            'breakdown': self.get_balance_breakdown()
-        }
-
-
-# ============================================================================
-# –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –ò–ù–í–û–ô–°–ê
-# ============================================================================
-
-class NewInvoice(models.Model):
-    """
-    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–Ω–≤–æ–π—Å–∞ —Å –ø—Ä—è–º—ã–º–∏ —Å–≤—è–∑—è–º–∏
-    
-    –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
-    - –ü—Ä—è–º—ã–µ ForeignKey –≤–º–µ—Å—Ç–æ generic —Å–≤—è–∑–µ–π
-    - –ü–æ–Ω—è—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
-    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å—É–º–º
-    - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
-    """
-    
-    # –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–∞
-    STATUS_CHOICES = [
-        ('DRAFT', '–ß–µ—Ä–Ω–æ–≤–∏–∫'),
-        ('ISSUED', '–í—ã—Å—Ç–∞–≤–ª–µ–Ω'),
-        ('PARTIALLY_PAID', '–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω'),
-        ('PAID', '–û–ø–ª–∞—á–µ–Ω'),
-        ('OVERDUE', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω'),
-        ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω'),
-    ]
-    
-    # ========================================================================
-    # –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
-    # ========================================================================
-    
-    number = models.CharField(
-        max_length=50,
-        unique=True,
-        verbose_name="–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞",
-        help_text="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
-    )
-    
-    date = models.DateField(
-        default=timezone.now,
-        verbose_name="–î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è"
-    )
-    
-    due_date = models.DateField(
-        null=True,
-        blank=True,
-        verbose_name="–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã",
-        help_text="–î–∞—Ç–∞, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø–ª–∞—á–µ–Ω –∏–Ω–≤–æ–π—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ +14 –¥–Ω–µ–π)"
-    )
-    
-    # ========================================================================
-    # –ö–¢–û –í–´–°–¢–ê–í–ò–õ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–∞—è —Å—É—â–Ω–æ—Å—Ç—å!)
-    # ========================================================================
-    
-    issuer_company = models.ForeignKey(
-        'Company',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='issued_invoices_new',
-        verbose_name="–ö–æ–º–ø–∞–Ω–∏—è-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
-    )
-    
-    issuer_warehouse = models.ForeignKey(
-        'Warehouse',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='issued_invoices_new',
-        verbose_name="–°–∫–ª–∞–¥-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
-    )
-    
-    issuer_line = models.ForeignKey(
-        'Line',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='issued_invoices_new',
-        verbose_name="–õ–∏–Ω–∏—è-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
-    )
-    
-    issuer_carrier = models.ForeignKey(
-        'Carrier',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='issued_invoices_new',
-        verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
-    )
-    
-    # ========================================================================
-    # –ö–û–ú–£ –í–´–°–¢–ê–í–õ–ï–ù (–ø—Ä—è–º—ã–µ —Å–≤—è–∑–∏ - –¢–û–õ–¨–ö–û –û–î–ù–ê –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!)
-    # ========================================================================
-    
-    recipient_client = models.ForeignKey(
-        'Client',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='received_invoices_new',
-        verbose_name="–ö–ª–∏–µ–Ω—Ç-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
-    )
-    
-    recipient_warehouse = models.ForeignKey(
-        'Warehouse',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='received_invoices_new',
-        verbose_name="–°–∫–ª–∞–¥-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
-    )
-    
-    recipient_line = models.ForeignKey(
-        'Line',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='received_invoices_new',
-        verbose_name="–õ–∏–Ω–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
-    )
-    
-    recipient_carrier = models.ForeignKey(
-        'Carrier',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='received_invoices_new',
-        verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
-    )
-    
-    recipient_company = models.ForeignKey(
-        'Company',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='received_invoices_new',
-        verbose_name="–ö–æ–º–ø–∞–Ω–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
-    )
-    
-    # ========================================================================
-    # –§–ò–ù–ê–ù–°–´
-    # ========================================================================
-    
-    subtotal = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        default=0,
-        validators=[MinValueValidator(0)],
-        verbose_name="–ü–æ–¥—ã—Ç–æ–≥",
-        help_text="–°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–±–æ—Ä–æ–≤"
-    )
-    
-    discount = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        default=0,
-        validators=[MinValueValidator(0)],
-        verbose_name="–°–∫–∏–¥–∫–∞"
-    )
-    
-    tax = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        default=0,
-        validators=[MinValueValidator(0)],
-        verbose_name="–ù–∞–ª–æ–≥"
-    )
-    
-    total = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        default=0,
-        validators=[MinValueValidator(0)],
-        verbose_name="–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ",
-        help_text="–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∏–Ω–≤–æ–π—Å–∞"
-    )
-    
-    paid_amount = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        default=0,
-        validators=[MinValueValidator(0)],
-        verbose_name="–û–ø–ª–∞—á–µ–Ω–æ",
-        help_text="–°—É–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–∞"
-    )
-    
-    # ========================================================================
-    # –°–¢–ê–¢–£–° –ò –ú–ï–¢–ê–î–ê–ù–ù–´–ï
-    # ========================================================================
-    
-    status = models.CharField(
-        max_length=20,
-        choices=STATUS_CHOICES,
-        default='DRAFT',
-        verbose_name="–°—Ç–∞—Ç—É—Å"
-    )
-    
-    notes = models.TextField(
-        blank=True,
-        verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è",
-        help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω–≤–æ–π—Å–µ"
-    )
-    
-    # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
-    cars = models.ManyToManyField(
-        'Car',
-        blank=True,
-        related_name='invoices_new',
-        verbose_name="–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏",
-        help_text="–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥"
-    )
-    
-    # –ê—É–¥–∏—Ç
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
-    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
-    created_by = models.ForeignKey(
-        User,
-        on_delete=models.SET_NULL,
-        null=True,
-        related_name='created_invoices_new',
-        verbose_name="–°–æ–∑–¥–∞–ª"
-    )
-    
-    # –°–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
-    _balance_updated = models.BooleanField(default=False, editable=False)
-    
-    class Meta:
-        verbose_name = "–ò–Ω–≤–æ–π—Å"
-        verbose_name_plural = "–ò–Ω–≤–æ–π—Å—ã"
-        ordering = ['-date', '-created_at']
-        indexes = [
-            models.Index(fields=['number']),
-            models.Index(fields=['status', 'date']),
-            models.Index(fields=['due_date', 'status']),
-            models.Index(fields=['recipient_client', 'status']),
-            models.Index(fields=['recipient_warehouse', 'status']),
-            models.Index(fields=['recipient_line', 'status']),
-            models.Index(fields=['recipient_carrier', 'status']),
-            models.Index(fields=['recipient_company', 'status']),
-            models.Index(fields=['issuer_company', 'status']),
-            models.Index(fields=['issuer_warehouse', 'status']),
-            models.Index(fields=['issuer_line', 'status']),
-            models.Index(fields=['issuer_carrier', 'status']),
-        ]
-    
-    def __str__(self):
-        return f"–ò–Ω–≤–æ–π—Å {self.number} ({self.get_status_display()})"
-    
-    # ========================================================================
-    # –°–í–û–ô–°–¢–í–ê
-    # ========================================================================
-    
-    @property
-    def issuer(self):
-        """–ü–æ–ª—É—á–∏—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞"""
-        if self.issuer_company:
-            return self.issuer_company
-        elif self.issuer_warehouse:
-            return self.issuer_warehouse
-        elif self.issuer_line:
-            return self.issuer_line
-        elif self.issuer_carrier:
-            return self.issuer_carrier
-        return None
-    
-    @property
-    def issuer_name(self):
-        """–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è"""
-        issuer = self.issuer
-        return str(issuer) if issuer else "–ù–µ —É–∫–∞–∑–∞–Ω"
-    
-    @property
-    def recipient(self):
-        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞"""
-        if self.recipient_client:
-            return self.recipient_client
-        elif self.recipient_warehouse:
-            return self.recipient_warehouse
-        elif self.recipient_line:
-            return self.recipient_line
-        elif self.recipient_carrier:
-            return self.recipient_carrier
-        elif self.recipient_company:
-            return self.recipient_company
-        return None
-    
-    @property
-    def recipient_name(self):
-        """–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è"""
-        recipient = self.recipient
-        return str(recipient) if recipient else "–ù–µ —É–∫–∞–∑–∞–Ω"
-    
-    @property
-    def remaining_amount(self):
-        """–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ"""
-        return max(Decimal('0.00'), self.total - self.paid_amount)
-    
-    @property
-    def is_overdue(self):
-        """–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ –∏–Ω–≤–æ–π—Å"""
-        if self.status in ['PAID', 'CANCELLED']:
-            return False
-        if not self.due_date:
-            return False
-        return self.due_date < timezone.now().date()
-    
-    @property
-    def days_until_due(self):
-        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã"""
-        if not self.due_date:
-            return 0
-        delta = self.due_date - timezone.now().date()
-        return delta.days
-    
-    # ========================================================================
-    # –ú–ï–¢–û–î–´
-    # ========================================================================
-    
-    def calculate_totals(self):
-        """–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–π"""
-        items = self.items.all()
-        self.subtotal = sum(item.total_price for item in items)
-        self.total = self.subtotal - self.discount + self.tax
-        return self.total
-    
-    def update_status(self):
-        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–ª–∞—Ç—ã"""
-        # –ù–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ total = 0 (–∏–Ω–≤–æ–π—Å –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π)
-        if self.total > 0 and self.paid_amount >= self.total:
-            self.status = 'PAID'
-        elif self.paid_amount > 0 and self.total > 0:
-            self.status = 'PARTIALLY_PAID'
-        elif self.is_overdue:
-            self.status = 'OVERDUE'
-        elif self.status == 'DRAFT':
-            pass  # –û—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º
-        elif self.status == 'PAID' and self.total == 0:
-            # –ï—Å–ª–∏ –±—ã–ª PAID –Ω–æ —Ç–µ–ø–µ—Ä—å total=0, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ ISSUED
-            self.status = 'ISSUED'
-        # –ï—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å - –Ω–µ –º–µ–Ω—è–µ–º
-    
-    def generate_number(self):
-        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞"""
-        from django.utils.timezone import now
-        date = now()
-        prefix = f"INV-{date.year}{date.month:02d}"
-        
-        # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
-        last_invoice = NewInvoice.objects.filter(
-            number__startswith=prefix
-        ).order_by('-number').first()
-        
-        if last_invoice:
-            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
-            try:
-                last_num = int(last_invoice.number.split('-')[-1])
-                next_num = last_num + 1
-            except (ValueError, IndexError):
-                next_num = 1
-        else:
-            next_num = 1
-        
-        return f"{prefix}-{next_num:04d}"
-    
-    def regenerate_items_from_cars(self):
-        """
-        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –∏–∑ —É—Å–ª—É–≥ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
-        """
-        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏
-        self.items.all().delete()
-        
-        issuer = self.issuer
-        if not issuer:
-            import logging
-            logger = logging.getLogger(__name__)
-            logger.warning(f"‚ö†Ô∏è –ò–Ω–≤–æ–π—Å {self.number}: –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã")
-            return
-        
-        issuer_type = issuer.__class__.__name__
-        
-        import logging
-        logger = logging.getLogger(__name__)
-        logger.info(f"üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ {self.number}, –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å: {issuer} (—Ç–∏–ø: {issuer_type})")
-        
-        order = 0
-        for car in self.cars.all():
-            # –í–ê–ñ–ù–û! –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π
-            # –ù–û –ù–ï –°–û–•–†–ê–ù–Ø–ï–ú - —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Å–∏–≥–Ω–∞–ª
-            # –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞ regenerate
-            car.update_days_and_storage()
-            car.calculate_total_price()
-            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –±—Ä–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è
-            if issuer_type == 'Warehouse':
-                services = car.get_warehouse_services()
-                prefix = '–°–∫–ª–∞–¥'
-                
-                # –í–ê–ñ–ù–û! –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
-                if car.storage_cost and car.storage_cost > 0:
-                    InvoiceItem.objects.create(
-                        invoice=self,
-                        description=f"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.)",
-                        car=car,
-                        quantity=car.days,
-                        unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'),
-                        order=order
-                    )
-                    order += 1
-                    
-            elif issuer_type == 'Line':
-                services = car.get_line_services()
-                prefix = '–õ–∏–Ω–∏—è'
-            elif issuer_type == 'Carrier':
-                services = car.get_carrier_services()
-                prefix = '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'
-            elif issuer_type == 'Company':
-                # –ö–æ–º–ø–∞–Ω–∏—è –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É - –≤—Å–µ —É—Å–ª—É–≥–∏ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ + –Ω–∞—Ü–µ–Ω–∫–∞
-                services = car.car_services.all()
-                prefix = '–í—Å–µ —É—Å–ª—É–≥–∏'
-                
-                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
-                status_note = ""
-                if car.status == 'TRANSFERRED' and car.transfer_date:
-                    status_note = f" [–ü–µ—Ä–µ–¥–∞–Ω {car.transfer_date}]"
-                else:
-                    from django.utils import timezone
-                    status_note = f" [–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ {timezone.now().date()}]"
-                
-                # –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤
-                if car.storage_cost and car.storage_cost > 0:
-                    InvoiceItem.objects.create(
-                        invoice=self,
-                        description=f"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.){status_note}",
-                        car=car,
-                        quantity=car.days,
-                        unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'),
-                        order=order
-                    )
-                    order += 1
-                
-                # –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ!
-                # –û–Ω–∞ —Å–∫—Ä—ã—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ markup_amount –≤ CarService
-                # –≠—Ç–æ –ø—Ä–∏–±—ã–ª—å Caromoto Lithuania, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É
-            else:
-                continue
-            
-            # –°–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —É—Å–ª—É–≥
-            for service in services:
-                service_name = service.get_service_name()
-                
-                # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
-                # –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –∞ CarService –æ—Å—Ç–∞–ª—Å—è
-                if service_name == "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞":
-                    logger.warning(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –±–∏—Ç–∞—è —É—Å–ª—É–≥–∞: type={service.service_type}, id={service.service_id} –¥–ª—è –∞–≤—Ç–æ {car.vin}")
-                    continue
-                
-                # –ó–ê–©–ò–¢–ê: –î–ª—è Company –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" - –æ–Ω–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—ã—à–µ –≤—Ä—É—á–Ω—É—é
-                # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏–Ω–≤–æ–π—Å–µ
-                if issuer_type == 'Company' and service_name == '–•—Ä–∞–Ω–µ–Ω–∏–µ':
-                    logger.debug(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥—É '–•—Ä–∞–Ω–µ–Ω–∏–µ' –¥–ª—è {car.vin} - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é")
-                    continue
-                
-                # –î–ª—è Company –∏—Å–ø–æ–ª—å–∑—É–µ–º invoice_price (–≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É)
-                # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É
-                if issuer_type == 'Company':
-                    # invoice_price —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç markup_amount –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç quantity
-                    unit_price = (service.custom_price if service.custom_price else service.get_default_price()) + (service.markup_amount or Decimal('0'))
-                else:
-                    unit_price = service.custom_price if service.custom_price else service.get_default_price()
-                
-                InvoiceItem.objects.create(
-                    invoice=self,
-                    description=f"{prefix}: {service_name} - {car.brand} {car.vin}",
-                    car=car,
-                    quantity=service.quantity,
-                    unit_price=unit_price,
-                    order=order
-                )
-                order += 1
-        
-        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
-        self.calculate_totals()
-        self.save(update_fields=['subtotal', 'total'])
-    
-    def save(self, *args, **kwargs):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"""
-        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –¥–ª—è –Ω–æ–≤—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤
-        if not self.number:
-            self.number = self.generate_number()
-        
-        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
-        if not self.due_date:
-            self.due_date = timezone.now().date() + timezone.timedelta(days=14)
-        
-        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
-        self.update_status()
-        
-        super().save(*args, **kwargs)
-
-
-# ============================================================================
-# –ü–û–ó–ò–¶–ò–Ø –í –ò–ù–í–û–ô–°–ï
-# ============================================================================
-
-class InvoiceItem(models.Model):
-    """
-    –ü–æ–∑–∏—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞) –≤ –∏–Ω–≤–æ–π—Å–µ
-    
-    –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º –∏–ª–∏ –±—ã—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —É—Å–ª—É–≥–æ–π
-    """
-    
-    # –°–≤—è–∑—å —Å –∏–Ω–≤–æ–π—Å–æ–º
-    invoice = models.ForeignKey(
-        NewInvoice,
-        on_delete=models.CASCADE,
-        related_name='items',
-        verbose_name="–ò–Ω–≤–æ–π—Å"
-    )
-    
-    # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-    car = models.ForeignKey(
-        'Car',
-        on_delete=models.SET_NULL,
-        null=True,
-        blank=True,
-        related_name='invoice_items_new',
-        verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å"
-    )
-    
-    # –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä–∞
-    description = models.CharField(
-        max_length=500,
-        verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ",
-        help_text="–ù–∞–ø—Ä–∏–º–µ—Ä: '–•—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ VIN12345 (10 –¥–Ω–µ–π)'"
-    )
-    
-    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω–∞
-    quantity = models.DecimalField(
-        max_digits=10,
-        decimal_places=2,
-        default=1,
-        validators=[MinValueValidator(0)],
-        verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
-    )
-    
-    unit_price = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        validators=[MinValueValidator(0)],
-        verbose_name="–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É"
-    )
-    
-    total_price = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        validators=[MinValueValidator(0)],
-        verbose_name="–°—É–º–º–∞",
-        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Ü–µ–Ω–∞"
-    )
-    
-    # –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
-    order = models.PositiveIntegerField(
-        default=0,
-        verbose_name="–ü–æ—Ä—è–¥–æ–∫"
-    )
-    
-    class Meta:
-        verbose_name = "–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞"
-        verbose_name_plural = "–ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞"
-        ordering = ['order', 'id']
-        indexes = [
-            models.Index(fields=['invoice', 'order']),
-            models.Index(fields=['car']),
-        ]
-    
-    def __str__(self):
-        return f"{self.description} - {self.total_price}"
-    
-    def calculate_total(self):
-        """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ø–æ–∑–∏—Ü–∏–∏"""
-        self.total_price = self.quantity * self.unit_price
-        return self.total_price
-    
-    def save(self, *args, **kwargs):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã"""
-        self.calculate_total()
-        super().save(*args, **kwargs)
-        
-        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –∏–Ω–≤–æ–π—Å–∞
-        if self.invoice_id:
-            self.invoice.calculate_totals()
-            self.invoice.save(update_fields=['subtotal', 'total', 'updated_at'])
-
-
-# ============================================================================
-# –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø (–ü–õ–ê–¢–ï–ñ/–í–û–ó–í–†–ê–¢/–ü–ï–†–ï–í–û–î)
-# ============================================================================
-
-class Transaction(models.Model):
-    """
-    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
-    
-    –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é –º–æ–¥–µ–ª—å Payment –∏ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π:
-    - –ü–ª–∞—Ç–µ–∂–∏ –ø–æ –∏–Ω–≤–æ–π—Å–∞–º
-    - –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
-    - –í–æ–∑–≤—Ä–∞—Ç—ã
-    - –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏
-    - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
-    """
-    
-    # –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
-    TYPE_CHOICES = [
-        ('PAYMENT', '–ü–ª–∞—Ç–µ–∂'),
-        ('REFUND', '–í–æ–∑–≤—Ä–∞—Ç'),
-        ('ADJUSTMENT', '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞'),
-        ('TRANSFER', '–ü–µ—Ä–µ–≤–æ–¥'),
-        ('BALANCE_TOPUP', '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞'),
-    ]
-    
-    # –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
-    METHOD_CHOICES = [
-        ('CASH', '–ù–∞–ª–∏—á–Ω—ã–µ'),
-        ('CARD', '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞'),
-        ('TRANSFER', '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥'),
-        ('BALANCE', '–°–ø–∏—Å–∞–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞'),
-        ('OTHER', '–î—Ä—É–≥–æ–µ'),
-    ]
-    
-    # –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
-    STATUS_CHOICES = [
-        ('PENDING', '–í –æ–∂–∏–¥–∞–Ω–∏–∏'),
-        ('COMPLETED', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'),
-        ('FAILED', '–û—à–∏–±–∫–∞'),
-        ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω–∞'),
-    ]
-    
-    # ========================================================================
-    # –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
-    # ========================================================================
-    
-    number = models.CharField(
-        max_length=50,
-        unique=True,
-        verbose_name="–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
-    )
-    
-    date = models.DateTimeField(
-        default=timezone.now,
-        verbose_name="–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è"
-    )
-    
-    # ========================================================================
-    # –¢–ò–ü –ò –°–ü–û–°–û–ë
-    # ========================================================================
-    
-    type = models.CharField(
-        max_length=20,
-        choices=TYPE_CHOICES,
-        verbose_name="–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏"
-    )
-    
-    method = models.CharField(
-        max_length=20,
-        choices=METHOD_CHOICES,
-        verbose_name="–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã"
-    )
-    
-    status = models.CharField(
-        max_length=20,
-        choices=STATUS_CHOICES,
-        default='COMPLETED',
-        verbose_name="–°—Ç–∞—Ç—É—Å"
-    )
-    
-    # ========================================================================
-    # –û–¢–ö–£–î–ê (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!
-    # ========================================================================
-    
-    from_client = models.ForeignKey(
-        'Client',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_sent_new',
-        verbose_name="–û—Ç –∫–ª–∏–µ–Ω—Ç–∞"
-    )
-    
-    from_warehouse = models.ForeignKey(
-        'Warehouse',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_sent_new',
-        verbose_name="–û—Ç —Å–∫–ª–∞–¥–∞"
-    )
-    
-    from_line = models.ForeignKey(
-        'Line',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_sent_new',
-        verbose_name="–û—Ç –ª–∏–Ω–∏–∏"
-    )
-    
-    from_carrier = models.ForeignKey(
-        'Carrier',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_sent_new',
-        verbose_name="–û—Ç –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
-    )
-    
-    from_company = models.ForeignKey(
-        'Company',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_sent_new',
-        verbose_name="–û—Ç –∫–æ–º–ø–∞–Ω–∏–∏"
-    )
-    
-    # ========================================================================
-    # –ö–£–î–ê (–ø–æ–ª—É—á–∞—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!
-    # ========================================================================
-    
-    to_client = models.ForeignKey(
-        'Client',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_received_new',
-        verbose_name="–ö–ª–∏–µ–Ω—Ç—É"
-    )
-    
-    to_warehouse = models.ForeignKey(
-        'Warehouse',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_received_new',
-        verbose_name="–°–∫–ª–∞–¥—É"
-    )
-    
-    to_line = models.ForeignKey(
-        'Line',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_received_new',
-        verbose_name="–õ–∏–Ω–∏–∏"
-    )
-    
-    to_carrier = models.ForeignKey(
-        'Carrier',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_received_new',
-        verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫—É"
-    )
-    
-    to_company = models.ForeignKey(
-        'Company',
-        on_delete=models.PROTECT,
-        null=True,
-        blank=True,
-        related_name='transactions_received_new',
-        verbose_name="–ö–æ–º–ø–∞–Ω–∏–∏"
-    )
-    
-    # ========================================================================
-    # –°–í–Ø–ó–¨ –° –ò–ù–í–û–ô–°–û–ú
-    # ========================================================================
-    
-    invoice = models.ForeignKey(
-        NewInvoice,
-        on_delete=models.SET_NULL,
-        null=True,
-        blank=True,
-        related_name='transactions',
-        verbose_name="–ò–Ω–≤–æ–π—Å",
-        help_text="–ï—Å–ª–∏ —ç—Ç–æ –æ–ø–ª–∞—Ç–∞ –∏–Ω–≤–æ–π—Å–∞, —É–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∑–¥–µ—Å—å"
-    )
-    
-    # ========================================================================
-    # –°–£–ú–ú–ê –ò –û–ü–ò–°–ê–ù–ò–ï
-    # ========================================================================
-    
-    amount = models.DecimalField(
-        max_digits=15,
-        decimal_places=2,
-        validators=[MinValueValidator(0)],
-        verbose_name="–°—É–º–º–∞"
-    )
-    
-    description = models.TextField(
-        verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ",
-        help_text="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"
-    )
-    
-    # ========================================================================
-    # –ú–ï–¢–ê–î–ê–ù–ù–´–ï
-    # ========================================================================
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–°–æ–∑–¥–∞–Ω–∞")
-    created_by = models.ForeignKey(
-        User,
-        on_delete=models.SET_NULL,
-        null=True,
-        related_name='created_transactions_new',
-        verbose_name="–°–æ–∑–¥–∞–ª"
-    )
-    
-    class Meta:
-        verbose_name = "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è"
-        verbose_name_plural = "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
-        ordering = ['-date']
-        indexes = [
-            models.Index(fields=['number']),
-            models.Index(fields=['date', 'type']),
-            models.Index(fields=['invoice']),
-            models.Index(fields=['from_client', 'date']),
-            models.Index(fields=['to_client', 'date']),
-            models.Index(fields=['from_warehouse', 'date']),
-            models.Index(fields=['to_warehouse', 'date']),
-            models.Index(fields=['from_line', 'date']),
-            models.Index(fields=['to_line', 'date']),
-            models.Index(fields=['from_carrier', 'date']),
-            models.Index(fields=['to_carrier', 'date']),
-            models.Index(fields=['from_company', 'date']),
-            models.Index(fields=['to_company', 'date']),
-            models.Index(fields=['status', 'date']),
-        ]
-    
-    def __str__(self):
-        return f"{self.number}: {self.get_type_display()} {self.amount}"
-    
-    # ========================================================================
-    # –°–í–û–ô–°–¢–í–ê
-    # ========================================================================
-    
-    @property
-    def sender(self):
-        """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
-        if self.from_client:
-            return self.from_client
-        elif self.from_warehouse:
-            return self.from_warehouse
-        elif self.from_line:
-            return self.from_line
-        elif self.from_carrier:
-            return self.from_carrier
-        elif self.from_company:
-            return self.from_company
-        return None
-    
-    @property
-    def recipient(self):
-        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è"""
-        if self.to_client:
-            return self.to_client
-        elif self.to_warehouse:
-            return self.to_warehouse
-        elif self.to_line:
-            return self.to_line
-        elif self.to_carrier:
-            return self.to_carrier
-        elif self.to_company:
-            return self.to_company
-        return None
-    
-    @property
-    def sender_name(self):
-        """–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
-        sender = self.sender
-        return str(sender) if sender else "–ù–µ —É–∫–∞–∑–∞–Ω"
-    
-    @property
-    def recipient_name(self):
-        """–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è"""
-        recipient = self.recipient
-        return str(recipient) if recipient else "–ù–µ —É–∫–∞–∑–∞–Ω"
-    
-    # ========================================================================
-    # –ú–ï–¢–û–î–´
-    # ========================================================================
-    
-    def generate_number(self):
-        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"""
-        from django.utils.timezone import now
-        date = now()
-        prefix = f"TRX-{date.year}{date.month:02d}{date.day:02d}"
-        
-        # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
-        last_transaction = Transaction.objects.filter(
-            number__startswith=prefix
-        ).order_by('-number').first()
-        
-        if last_transaction:
-            try:
-                last_num = int(last_transaction.number.split('-')[-1])
-                next_num = last_num + 1
-            except (ValueError, IndexError):
-                next_num = 1
-        else:
-            next_num = 1
-        
-        return f"{prefix}-{next_num:05d}"
-    
-    def save(self, *args, **kwargs):
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞"""
-        if not self.number:
-            self.number = self.generate_number()
-        
-        super().save(*args, **kwargs)
-
-        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞"""
-        if not self.number:
-            self.number = self.generate_number()
-        
-        super().save(*args, **kwargs)
+"""
+–ù–æ–≤–∞—è —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–æ–π—Å–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –±–∞–ª–∞–Ω—Å–æ–≤
+=========================================================
+
+–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
+- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å
+- –ü—Ä—è–º—ã–µ —Å–≤—è–∑–∏ –≤–º–µ—Å—Ç–æ generic
+- –û–¥–∏–Ω –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö
+- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
+- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
+
+–ê–≤—Ç–æ—Ä—ã: AI Assistant
+–î–∞—Ç–∞: 30 —Å–µ–Ω—Ç—è–±—Ä—è 2025
+"""
+
+from django.db import models
+from django.core.validators import MinValueValidator
+from django.utils import timezone
+from django.contrib.auth import get_user_model
+from decimal import Decimal
+import logging
+
+logger = logging.getLogger('django')
+User = get_user_model()
+
+
+# ============================================================================
+# –ë–ê–ó–û–í–´–ô –ú–ò–ö–°–ò–ù –î–õ–Ø –ë–ê–õ–ê–ù–°–û–í
+# ============================================================================
+
+class SimpleBalanceMixin(models.Model):
+    """
+    –ü—Ä–æ—Å—Ç–æ–π –º–∏–∫—Å–∏–Ω –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤ - –û–î–ò–ù –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö!
+    
+    –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π,
+    –∞ –Ω–µ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –±–∞–ª–∞–Ω—Å–∞.
+    """
+    
+    balance = models.DecimalField(
+        max_digits=15, 
+        decimal_places=2, 
+        default=0,
+        verbose_name="–ë–∞–ª–∞–Ω—Å",
+        help_text="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–ø–ª–∞—Ç–∞, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–æ–ª–≥)"
+    )
+    
+    balance_updated_at = models.DateTimeField(
+        auto_now=True,
+        verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞"
+    )
+    
+    class Meta:
+        abstract = True
+    
+    def get_balance_breakdown(self):
+        """
+        –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –±–∞–ª–∞–Ω—Å–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
+        
+        Returns:
+            dict: {'cash': Decimal, 'card': Decimal, 'transfer': Decimal, 'total': Decimal}
+        """
+        from django.db.models import Sum, Q
+        
+        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
+        model_name = self.__class__.__name__.lower()
+        
+        # –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
+        incoming_filter = Q(**{f'to_{model_name}': self})
+        outgoing_filter = Q(**{f'from_{model_name}': self})
+        
+        # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
+        from .models_billing import Transaction
+        transactions = Transaction.objects.filter(incoming_filter | outgoing_filter)
+        
+        # –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã
+        breakdown = {}
+        for method in ['CASH', 'CARD', 'TRANSFER']:
+            incoming = transactions.filter(
+                incoming_filter, 
+                method=method
+            ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00')
+            
+            outgoing = transactions.filter(
+                outgoing_filter, 
+                method=method
+            ).aggregate(total=Sum('amount'))['total'] or Decimal('0.00')
+            
+            breakdown[method.lower()] = incoming - outgoing
+        
+        breakdown['total'] = self.balance
+        return breakdown
+    
+    def get_balance_info(self):
+        """
+        –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–µ –≤ –ø–æ–Ω—è—Ç–Ω–æ–º –≤–∏–¥–µ
+        
+        Returns:
+            dict: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–ª–∞–Ω—Å–µ —Å —Å—Ç–∞—Ç—É—Å–æ–º –∏ —Ü–≤–µ—Ç–æ–º
+        """
+        balance = self.balance
+        
+        if balance > 0:
+            status = "–ü–ï–†–ï–ü–õ–ê–¢–ê"
+            color = "#28a745"  # –∑–µ–ª–µ–Ω—ã–π
+            description = f"–ü–µ—Ä–µ–ø–ª–∞—Ç–∞ {balance:.2f}"
+        elif balance < 0:
+            status = "–î–û–õ–ì"
+            color = "#dc3545"  # –∫—Ä–∞—Å–Ω—ã–π
+            description = f"–î–æ–ª–≥ {abs(balance):.2f}"
+        else:
+            status = "–ë–ê–õ–ê–ù–°"
+            color = "#6c757d"  # —Å–µ—Ä—ã–π
+            description = "–ë–∞–ª–∞–Ω—Å –Ω—É–ª–µ–≤–æ–π"
+        
+        return {
+            'balance': balance,
+            'status': status,
+            'color': color,
+            'description': description,
+            'breakdown': self.get_balance_breakdown()
+        }
+
+
+# ============================================================================
+# –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –ò–ù–í–û–ô–°–ê
+# ============================================================================
+
+class NewInvoice(models.Model):
+    """
+    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–Ω–≤–æ–π—Å–∞ —Å –ø—Ä—è–º—ã–º–∏ —Å–≤—è–∑—è–º–∏
+    
+    –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
+    - –ü—Ä—è–º—ã–µ ForeignKey –≤–º–µ—Å—Ç–æ generic —Å–≤—è–∑–µ–π
+    - –ü–æ–Ω—è—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
+    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å—É–º–º
+    - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
+    """
+    
+    # –°—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–∞
+    STATUS_CHOICES = [
+        ('DRAFT', '–ß–µ—Ä–Ω–æ–≤–∏–∫'),
+        ('ISSUED', '–í—ã—Å—Ç–∞–≤–ª–µ–Ω'),
+        ('PARTIALLY_PAID', '–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω'),
+        ('PAID', '–û–ø–ª–∞—á–µ–Ω'),
+        ('OVERDUE', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω'),
+        ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω'),
+    ]
+    
+    # ========================================================================
+    # –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
+    # ========================================================================
+    
+    number = models.CharField(
+        max_length=50,
+        unique=True,
+        verbose_name="–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞",
+        help_text="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
+    )
+    
+    date = models.DateField(
+        default=timezone.now,
+        verbose_name="–î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è"
+    )
+    
+    due_date = models.DateField(
+        null=True,
+        blank=True,
+        verbose_name="–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã",
+        help_text="–î–∞—Ç–∞, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø–ª–∞—á–µ–Ω –∏–Ω–≤–æ–π—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ +14 –¥–Ω–µ–π)"
+    )
+    
+    # ========================================================================
+    # –ö–¢–û –í–´–°–¢–ê–í–ò–õ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–∞—è —Å—É—â–Ω–æ—Å—Ç—å!)
+    # ========================================================================
+    
+    issuer_company = models.ForeignKey(
+        'Company',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='issued_invoices_new',
+        verbose_name="–ö–æ–º–ø–∞–Ω–∏—è-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
+    )
+    
+    issuer_warehouse = models.ForeignKey(
+        'Warehouse',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='issued_invoices_new',
+        verbose_name="–°–∫–ª–∞–¥-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
+    )
+    
+    issuer_line = models.ForeignKey(
+        'Line',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='issued_invoices_new',
+        verbose_name="–õ–∏–Ω–∏—è-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
+    )
+    
+    issuer_carrier = models.ForeignKey(
+        'Carrier',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='issued_invoices_new',
+        verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫-–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å"
+    )
+    
+    # ========================================================================
+    # –ö–û–ú–£ –í–´–°–¢–ê–í–õ–ï–ù (–ø—Ä—è–º—ã–µ —Å–≤—è–∑–∏ - –¢–û–õ–¨–ö–û –û–î–ù–ê –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!)
+    # ========================================================================
+    
+    recipient_client = models.ForeignKey(
+        'Client',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='received_invoices_new',
+        verbose_name="–ö–ª–∏–µ–Ω—Ç-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
+    )
+    
+    recipient_warehouse = models.ForeignKey(
+        'Warehouse',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='received_invoices_new',
+        verbose_name="–°–∫–ª–∞–¥-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
+    )
+    
+    recipient_line = models.ForeignKey(
+        'Line',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='received_invoices_new',
+        verbose_name="–õ–∏–Ω–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
+    )
+    
+    recipient_carrier = models.ForeignKey(
+        'Carrier',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='received_invoices_new',
+        verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
+    )
+    
+    recipient_company = models.ForeignKey(
+        'Company',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='received_invoices_new',
+        verbose_name="–ö–æ–º–ø–∞–Ω–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
+    )
+    
+    # ========================================================================
+    # –§–ò–ù–ê–ù–°–´
+    # ========================================================================
+    
+    subtotal = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        default=0,
+        validators=[MinValueValidator(0)],
+        verbose_name="–ü–æ–¥—ã—Ç–æ–≥",
+        help_text="–°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–±–æ—Ä–æ–≤"
+    )
+    
+    discount = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        default=0,
+        validators=[MinValueValidator(0)],
+        verbose_name="–°–∫–∏–¥–∫–∞"
+    )
+    
+    tax = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        default=0,
+        validators=[MinValueValidator(0)],
+        verbose_name="–ù–∞–ª–æ–≥"
+    )
+    
+    total = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        default=0,
+        validators=[MinValueValidator(0)],
+        verbose_name="–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ",
+        help_text="–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∏–Ω–≤–æ–π—Å–∞"
+    )
+    
+    paid_amount = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        default=0,
+        validators=[MinValueValidator(0)],
+        verbose_name="–û–ø–ª–∞—á–µ–Ω–æ",
+        help_text="–°—É–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–∞"
+    )
+    
+    # ========================================================================
+    # –°–¢–ê–¢–£–° –ò –ú–ï–¢–ê–î–ê–ù–ù–´–ï
+    # ========================================================================
+    
+    status = models.CharField(
+        max_length=20,
+        choices=STATUS_CHOICES,
+        default='DRAFT',
+        verbose_name="–°—Ç–∞—Ç—É—Å"
+    )
+    
+    notes = models.TextField(
+        blank=True,
+        verbose_name="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è",
+        help_text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω–≤–æ–π—Å–µ"
+    )
+    
+    # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
+    cars = models.ManyToManyField(
+        'Car',
+        blank=True,
+        related_name='invoices_new',
+        verbose_name="–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏",
+        help_text="–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥"
+    )
+    
+    # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–≤–æ–∑–æ–º (–µ—Å–ª–∏ –∏–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–∞)
+    auto_transport = models.ForeignKey(
+        'AutoTransport',
+        on_delete=models.SET_NULL,
+        null=True,
+        blank=True,
+        related_name='invoices',
+        verbose_name="–ê–≤—Ç–æ–≤–æ–∑",
+        help_text="–ê–≤—Ç–æ–≤–æ–∑, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω —ç—Ç–æ—Ç –∏–Ω–≤–æ–π—Å"
+    )
+    
+    # –ê—É–¥–∏—Ç
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    created_by = models.ForeignKey(
+        User,
+        on_delete=models.SET_NULL,
+        null=True,
+        related_name='created_invoices_new',
+        verbose_name="–°–æ–∑–¥–∞–ª"
+    )
+    
+    # –°–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
+    _balance_updated = models.BooleanField(default=False, editable=False)
+    
+    class Meta:
+        verbose_name = "–ò–Ω–≤–æ–π—Å"
+        verbose_name_plural = "–ò–Ω–≤–æ–π—Å—ã"
+        ordering = ['-date', '-created_at']
+        indexes = [
+            models.Index(fields=['number']),
+            models.Index(fields=['status', 'date']),
+            models.Index(fields=['due_date', 'status']),
+            models.Index(fields=['recipient_client', 'status']),
+            models.Index(fields=['recipient_warehouse', 'status']),
+            models.Index(fields=['recipient_line', 'status']),
+            models.Index(fields=['recipient_carrier', 'status']),
+            models.Index(fields=['recipient_company', 'status']),
+            models.Index(fields=['issuer_company', 'status']),
+            models.Index(fields=['issuer_warehouse', 'status']),
+            models.Index(fields=['issuer_line', 'status']),
+            models.Index(fields=['issuer_carrier', 'status']),
+        ]
+    
+    def __str__(self):
+        return f"–ò–Ω–≤–æ–π—Å {self.number} ({self.get_status_display()})"
+    
+    # ========================================================================
+    # –°–í–û–ô–°–¢–í–ê
+    # ========================================================================
+    
+    @property
+    def issuer(self):
+        """–ü–æ–ª—É—á–∏—Ç—å –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞"""
+        if self.issuer_company:
+            return self.issuer_company
+        elif self.issuer_warehouse:
+            return self.issuer_warehouse
+        elif self.issuer_line:
+            return self.issuer_line
+        elif self.issuer_carrier:
+            return self.issuer_carrier
+        return None
+    
+    @property
+    def issuer_name(self):
+        """–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è"""
+        issuer = self.issuer
+        return str(issuer) if issuer else "–ù–µ —É–∫–∞–∑–∞–Ω"
+    
+    @property
+    def recipient(self):
+        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–Ω–≤–æ–π—Å–∞"""
+        if self.recipient_client:
+            return self.recipient_client
+        elif self.recipient_warehouse:
+            return self.recipient_warehouse
+        elif self.recipient_line:
+            return self.recipient_line
+        elif self.recipient_carrier:
+            return self.recipient_carrier
+        elif self.recipient_company:
+            return self.recipient_company
+        return None
+    
+    @property
+    def recipient_name(self):
+        """–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è"""
+        recipient = self.recipient
+        return str(recipient) if recipient else "–ù–µ —É–∫–∞–∑–∞–Ω"
+    
+    @property
+    def remaining_amount(self):
+        """–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ"""
+        return max(Decimal('0.00'), self.total - self.paid_amount)
+    
+    @property
+    def is_overdue(self):
+        """–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ –∏–Ω–≤–æ–π—Å"""
+        if self.status in ['PAID', 'CANCELLED']:
+            return False
+        if not self.due_date:
+            return False
+        return self.due_date < timezone.now().date()
+    
+    @property
+    def days_until_due(self):
+        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã"""
+        if not self.due_date:
+            return 0
+        delta = self.due_date - timezone.now().date()
+        return delta.days
+    
+    # ========================================================================
+    # –ú–ï–¢–û–î–´
+    # ========================================================================
+    
+    def calculate_totals(self):
+        """–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–π"""
+        items = self.items.all()
+        self.subtotal = sum(item.total_price for item in items)
+        self.total = self.subtotal - self.discount + self.tax
+        return self.total
+    
+    def update_status(self):
+        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–ª–∞—Ç—ã"""
+        # –ù–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ total = 0 (–∏–Ω–≤–æ–π—Å –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π)
+        if self.total > 0 and self.paid_amount >= self.total:
+            self.status = 'PAID'
+        elif self.paid_amount > 0 and self.total > 0:
+            self.status = 'PARTIALLY_PAID'
+        elif self.is_overdue:
+            self.status = 'OVERDUE'
+        elif self.status == 'DRAFT':
+            pass  # –û—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º
+        elif self.status == 'PAID' and self.total == 0:
+            # –ï—Å–ª–∏ –±—ã–ª PAID –Ω–æ —Ç–µ–ø–µ—Ä—å total=0, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ ISSUED
+            self.status = 'ISSUED'
+        # –ï—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å - –Ω–µ –º–µ–Ω—è–µ–º
+    
+    def generate_number(self):
+        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞"""
+        from django.utils.timezone import now
+        date = now()
+        prefix = f"INV-{date.year}{date.month:02d}"
+        
+        # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
+        last_invoice = NewInvoice.objects.filter(
+            number__startswith=prefix
+        ).order_by('-number').first()
+        
+        if last_invoice:
+            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
+            try:
+                last_num = int(last_invoice.number.split('-')[-1])
+                next_num = last_num + 1
+            except (ValueError, IndexError):
+                next_num = 1
+        else:
+            next_num = 1
+        
+        return f"{prefix}-{next_num:04d}"
+    
+    def regenerate_items_from_cars(self):
+        """
+        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ –∏–∑ —É—Å–ª—É–≥ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
+        """
+        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏
+        self.items.all().delete()
+        
+        issuer = self.issuer
+        if not issuer:
+            import logging
+            logger = logging.getLogger(__name__)
+            logger.warning(f"‚ö†Ô∏è –ò–Ω–≤–æ–π—Å {self.number}: –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã")
+            return
+        
+        issuer_type = issuer.__class__.__name__
+        
+        import logging
+        logger = logging.getLogger(__name__)
+        logger.info(f"üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∏–Ω–≤–æ–π—Å–∞ {self.number}, –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å: {issuer} (—Ç–∏–ø: {issuer_type})")
+        
+        order = 0
+        for car in self.cars.all():
+            # –í–ê–ñ–ù–û! –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∑–∏—Ü–∏–π
+            # –ù–û –ù–ï –°–û–•–†–ê–ù–Ø–ï–ú - —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Å–∏–≥–Ω–∞–ª
+            # –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞ regenerate
+            car.update_days_and_storage()
+            car.calculate_total_price()
+            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –±—Ä–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è
+            if issuer_type == 'Warehouse':
+                services = car.get_warehouse_services()
+                prefix = '–°–∫–ª–∞–¥'
+                
+                # –í–ê–ñ–ù–û! –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
+                if car.storage_cost and car.storage_cost > 0:
+                    InvoiceItem.objects.create(
+                        invoice=self,
+                        description=f"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.)",
+                        car=car,
+                        quantity=car.days,
+                        unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'),
+                        order=order
+                    )
+                    order += 1
+                    
+            elif issuer_type == 'Line':
+                services = car.get_line_services()
+                prefix = '–õ–∏–Ω–∏—è'
+            elif issuer_type == 'Carrier':
+                services = car.get_carrier_services()
+                prefix = '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫'
+            elif issuer_type == 'Company':
+                # –ö–æ–º–ø–∞–Ω–∏—è –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É - –≤—Å–µ —É—Å–ª—É–≥–∏ + —Ö—Ä–∞–Ω–µ–Ω–∏–µ + –Ω–∞—Ü–µ–Ω–∫–∞
+                services = car.car_services.all()
+                prefix = '–í—Å–µ —É—Å–ª—É–≥–∏'
+                
+                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
+                status_note = ""
+                if car.status == 'TRANSFERRED' and car.transfer_date:
+                    status_note = f" [–ü–µ—Ä–µ–¥–∞–Ω {car.transfer_date}]"
+                else:
+                    from django.utils import timezone
+                    status_note = f" [–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ {timezone.now().date()}]"
+                
+                # –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤
+                if car.storage_cost and car.storage_cost > 0:
+                    InvoiceItem.objects.create(
+                        invoice=self,
+                        description=f"–•—Ä–∞–Ω–µ–Ω–∏–µ - {car.brand} {car.vin} ({car.days} –¥–Ω.){status_note}",
+                        car=car,
+                        quantity=car.days,
+                        unit_price=car._get_storage_daily_rate() if car.warehouse else Decimal('0'),
+                        order=order
+                    )
+                    order += 1
+                
+                # –ù–∞—Ü–µ–Ω–∫–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ –∏–Ω–≤–æ–π—Å–µ!
+                # –û–Ω–∞ —Å–∫—Ä—ã—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ü–µ–Ω–∞–º —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ markup_amount –≤ CarService
+                # –≠—Ç–æ –ø—Ä–∏–±—ã–ª—å Caromoto Lithuania, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –≤–∏–¥–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É
+            else:
+                continue
+            
+            # –°–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —É—Å–ª—É–≥
+            for service in services:
+                service_name = service.get_service_name()
+                
+                # –ó–ê–©–ò–¢–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
+                # –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –∞ CarService –æ—Å—Ç–∞–ª—Å—è
+                if service_name == "–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞":
+                    logger.warning(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –±–∏—Ç–∞—è —É—Å–ª—É–≥–∞: type={service.service_type}, id={service.service_id} –¥–ª—è –∞–≤—Ç–æ {car.vin}")
+                    continue
+                
+                # –ó–ê–©–ò–¢–ê: –î–ª—è Company –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥—É "–•—Ä–∞–Ω–µ–Ω–∏–µ" - –æ–Ω–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—ã—à–µ –≤—Ä—É—á–Ω—É—é
+                # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏–Ω–≤–æ–π—Å–µ
+                if issuer_type == 'Company' and service_name == '–•—Ä–∞–Ω–µ–Ω–∏–µ':
+                    logger.debug(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å–ª—É–≥—É '–•—Ä–∞–Ω–µ–Ω–∏–µ' –¥–ª—è {car.vin} - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é")
+                    continue
+                
+                # –î–ª—è Company –∏—Å–ø–æ–ª—å–∑—É–µ–º invoice_price (–≤–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—É—é –Ω–∞—Ü–µ–Ω–∫—É)
+                # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É
+                if issuer_type == 'Company':
+                    # invoice_price —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç markup_amount –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç quantity
+                    unit_price = (service.custom_price if service.custom_price else service.get_default_price()) + (service.markup_amount or Decimal('0'))
+                else:
+                    unit_price = service.custom_price if service.custom_price else service.get_default_price()
+                
+                InvoiceItem.objects.create(
+                    invoice=self,
+                    description=f"{prefix}: {service_name} - {car.brand} {car.vin}",
+                    car=car,
+                    quantity=service.quantity,
+                    unit_price=unit_price,
+                    order=order
+                )
+                order += 1
+        
+        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
+        self.calculate_totals()
+        self.save(update_fields=['subtotal', 'total'])
+    
+    def save(self, *args, **kwargs):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"""
+        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –¥–ª—è –Ω–æ–≤—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤
+        if not self.number:
+            self.number = self.generate_number()
+        
+        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
+        if not self.due_date:
+            self.due_date = timezone.now().date() + timezone.timedelta(days=14)
+        
+        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
+        self.update_status()
+        
+        super().save(*args, **kwargs)
+
+
+# ============================================================================
+# –ü–û–ó–ò–¶–ò–Ø –í –ò–ù–í–û–ô–°–ï
+# ============================================================================
+
+class InvoiceItem(models.Model):
+    """
+    –ü–æ–∑–∏—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞) –≤ –∏–Ω–≤–æ–π—Å–µ
+    
+    –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º –∏–ª–∏ –±—ã—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —É—Å–ª—É–≥–æ–π
+    """
+    
+    # –°–≤—è–∑—å —Å –∏–Ω–≤–æ–π—Å–æ–º
+    invoice = models.ForeignKey(
+        NewInvoice,
+        on_delete=models.CASCADE,
+        related_name='items',
+        verbose_name="–ò–Ω–≤–æ–π—Å"
+    )
+    
+    # –°–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
+    car = models.ForeignKey(
+        'Car',
+        on_delete=models.SET_NULL,
+        null=True,
+        blank=True,
+        related_name='invoice_items_new',
+        verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å"
+    )
+    
+    # –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä–∞
+    description = models.CharField(
+        max_length=500,
+        verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ",
+        help_text="–ù–∞–ø—Ä–∏–º–µ—Ä: '–•—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ VIN12345 (10 –¥–Ω–µ–π)'"
+    )
+    
+    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω–∞
+    quantity = models.DecimalField(
+        max_digits=10,
+        decimal_places=2,
+        default=1,
+        validators=[MinValueValidator(0)],
+        verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
+    )
+    
+    unit_price = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        validators=[MinValueValidator(0)],
+        verbose_name="–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É"
+    )
+    
+    total_price = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        validators=[MinValueValidator(0)],
+        verbose_name="–°—É–º–º–∞",
+        help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Ü–µ–Ω–∞"
+    )
+    
+    # –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
+    order = models.PositiveIntegerField(
+        default=0,
+        verbose_name="–ü–æ—Ä—è–¥–æ–∫"
+    )
+    
+    class Meta:
+        verbose_name = "–ü–æ–∑–∏—Ü–∏—è –∏–Ω–≤–æ–π—Å–∞"
+        verbose_name_plural = "–ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞"
+        ordering = ['order', 'id']
+        indexes = [
+            models.Index(fields=['invoice', 'order']),
+            models.Index(fields=['car']),
+        ]
+    
+    def __str__(self):
+        return f"{self.description} - {self.total_price}"
+    
+    def calculate_total(self):
+        """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ø–æ–∑–∏—Ü–∏–∏"""
+        self.total_price = self.quantity * self.unit_price
+        return self.total_price
+    
+    def save(self, *args, **kwargs):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã"""
+        self.calculate_total()
+        super().save(*args, **kwargs)
+        
+        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –∏–Ω–≤–æ–π—Å–∞
+        if self.invoice_id:
+            self.invoice.calculate_totals()
+            self.invoice.save(update_fields=['subtotal', 'total', 'updated_at'])
+
+
+# ============================================================================
+# –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø (–ü–õ–ê–¢–ï–ñ/–í–û–ó–í–†–ê–¢/–ü–ï–†–ï–í–û–î)
+# ============================================================================
+
+class Transaction(models.Model):
+    """
+    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
+    
+    –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é –º–æ–¥–µ–ª—å Payment –∏ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π:
+    - –ü–ª–∞—Ç–µ–∂–∏ –ø–æ –∏–Ω–≤–æ–π—Å–∞–º
+    - –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
+    - –í–æ–∑–≤—Ä–∞—Ç—ã
+    - –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏
+    - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
+    """
+    
+    # –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
+    TYPE_CHOICES = [
+        ('PAYMENT', '–ü–ª–∞—Ç–µ–∂'),
+        ('REFUND', '–í–æ–∑–≤—Ä–∞—Ç'),
+        ('ADJUSTMENT', '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞'),
+        ('TRANSFER', '–ü–µ—Ä–µ–≤–æ–¥'),
+        ('BALANCE_TOPUP', '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞'),
+    ]
+    
+    # –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
+    METHOD_CHOICES = [
+        ('CASH', '–ù–∞–ª–∏—á–Ω—ã–µ'),
+        ('CARD', '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞'),
+        ('TRANSFER', '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥'),
+        ('BALANCE', '–°–ø–∏—Å–∞–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞'),
+        ('OTHER', '–î—Ä—É–≥–æ–µ'),
+    ]
+    
+    # –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
+    STATUS_CHOICES = [
+        ('PENDING', '–í –æ–∂–∏–¥–∞–Ω–∏–∏'),
+        ('COMPLETED', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'),
+        ('FAILED', '–û—à–∏–±–∫–∞'),
+        ('CANCELLED', '–û—Ç–º–µ–Ω–µ–Ω–∞'),
+    ]
+    
+    # ========================================================================
+    # –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
+    # ========================================================================
+    
+    number = models.CharField(
+        max_length=50,
+        unique=True,
+        verbose_name="–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
+    )
+    
+    date = models.DateTimeField(
+        default=timezone.now,
+        verbose_name="–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è"
+    )
+    
+    # ========================================================================
+    # –¢–ò–ü –ò –°–ü–û–°–û–ë
+    # ========================================================================
+    
+    type = models.CharField(
+        max_length=20,
+        choices=TYPE_CHOICES,
+        verbose_name="–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏"
+    )
+    
+    method = models.CharField(
+        max_length=20,
+        choices=METHOD_CHOICES,
+        verbose_name="–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã"
+    )
+    
+    status = models.CharField(
+        max_length=20,
+        choices=STATUS_CHOICES,
+        default='COMPLETED',
+        verbose_name="–°—Ç–∞—Ç—É—Å"
+    )
+    
+    # ========================================================================
+    # –û–¢–ö–£–î–ê (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!
+    # ========================================================================
+    
+    from_client = models.ForeignKey(
+        'Client',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_sent_new',
+        verbose_name="–û—Ç –∫–ª–∏–µ–Ω—Ç–∞"
+    )
+    
+    from_warehouse = models.ForeignKey(
+        'Warehouse',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_sent_new',
+        verbose_name="–û—Ç —Å–∫–ª–∞–¥–∞"
+    )
+    
+    from_line = models.ForeignKey(
+        'Line',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_sent_new',
+        verbose_name="–û—Ç –ª–∏–Ω–∏–∏"
+    )
+    
+    from_carrier = models.ForeignKey(
+        'Carrier',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_sent_new',
+        verbose_name="–û—Ç –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"
+    )
+    
+    from_company = models.ForeignKey(
+        'Company',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_sent_new',
+        verbose_name="–û—Ç –∫–æ–º–ø–∞–Ω–∏–∏"
+    )
+    
+    # ========================================================================
+    # –ö–£–î–ê (–ø–æ–ª—É—á–∞—Ç–µ–ª—å) - –¢–û–õ–¨–ö–û –û–î–ù–û –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!
+    # ========================================================================
+    
+    to_client = models.ForeignKey(
+        'Client',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_received_new',
+        verbose_name="–ö–ª–∏–µ–Ω—Ç—É"
+    )
+    
+    to_warehouse = models.ForeignKey(
+        'Warehouse',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_received_new',
+        verbose_name="–°–∫–ª–∞–¥—É"
+    )
+    
+    to_line = models.ForeignKey(
+        'Line',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_received_new',
+        verbose_name="–õ–∏–Ω–∏–∏"
+    )
+    
+    to_carrier = models.ForeignKey(
+        'Carrier',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_received_new',
+        verbose_name="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫—É"
+    )
+    
+    to_company = models.ForeignKey(
+        'Company',
+        on_delete=models.PROTECT,
+        null=True,
+        blank=True,
+        related_name='transactions_received_new',
+        verbose_name="–ö–æ–º–ø–∞–Ω–∏–∏"
+    )
+    
+    # ========================================================================
+    # –°–í–Ø–ó–¨ –° –ò–ù–í–û–ô–°–û–ú
+    # ========================================================================
+    
+    invoice = models.ForeignKey(
+        NewInvoice,
+        on_delete=models.SET_NULL,
+        null=True,
+        blank=True,
+        related_name='transactions',
+        verbose_name="–ò–Ω–≤–æ–π—Å",
+        help_text="–ï—Å–ª–∏ —ç—Ç–æ –æ–ø–ª–∞—Ç–∞ –∏–Ω–≤–æ–π—Å–∞, —É–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∑–¥–µ—Å—å"
+    )
+    
+    # ========================================================================
+    # –°–£–ú–ú–ê –ò –û–ü–ò–°–ê–ù–ò–ï
+    # ========================================================================
+    
+    amount = models.DecimalField(
+        max_digits=15,
+        decimal_places=2,
+        validators=[MinValueValidator(0)],
+        verbose_name="–°—É–º–º–∞"
+    )
+    
+    description = models.TextField(
+        verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ",
+        help_text="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"
+    )
+    
+    # ========================================================================
+    # –ú–ï–¢–ê–î–ê–ù–ù–´–ï
+    # ========================================================================
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–°–æ–∑–¥–∞–Ω–∞")
+    created_by = models.ForeignKey(
+        User,
+        on_delete=models.SET_NULL,
+        null=True,
+        related_name='created_transactions_new',
+        verbose_name="–°–æ–∑–¥–∞–ª"
+    )
+    
+    class Meta:
+        verbose_name = "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è"
+        verbose_name_plural = "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
+        ordering = ['-date']
+        indexes = [
+            models.Index(fields=['number']),
+            models.Index(fields=['date', 'type']),
+            models.Index(fields=['invoice']),
+            models.Index(fields=['from_client', 'date']),
+            models.Index(fields=['to_client', 'date']),
+            models.Index(fields=['from_warehouse', 'date']),
+            models.Index(fields=['to_warehouse', 'date']),
+            models.Index(fields=['from_line', 'date']),
+            models.Index(fields=['to_line', 'date']),
+            models.Index(fields=['from_carrier', 'date']),
+            models.Index(fields=['to_carrier', 'date']),
+            models.Index(fields=['from_company', 'date']),
+            models.Index(fields=['to_company', 'date']),
+            models.Index(fields=['status', 'date']),
+        ]
+    
+    def __str__(self):
+        return f"{self.number}: {self.get_type_display()} {self.amount}"
+    
+    # ========================================================================
+    # –°–í–û–ô–°–¢–í–ê
+    # ========================================================================
+    
+    @property
+    def sender(self):
+        """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
+        if self.from_client:
+            return self.from_client
+        elif self.from_warehouse:
+            return self.from_warehouse
+        elif self.from_line:
+            return self.from_line
+        elif self.from_carrier:
+            return self.from_carrier
+        elif self.from_company:
+            return self.from_company
+        return None
+    
+    @property
+    def recipient(self):
+        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è"""
+        if self.to_client:
+            return self.to_client
+        elif self.to_warehouse:
+            return self.to_warehouse
+        elif self.to_line:
+            return self.to_line
+        elif self.to_carrier:
+            return self.to_carrier
+        elif self.to_company:
+            return self.to_company
+        return None
+    
+    @property
+    def sender_name(self):
+        """–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
+        sender = self.sender
+        return str(sender) if sender else "–ù–µ —É–∫–∞–∑–∞–Ω"
+    
+    @property
+    def recipient_name(self):
+        """–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è"""
+        recipient = self.recipient
+        return str(recipient) if recipient else "–ù–µ —É–∫–∞–∑–∞–Ω"
+    
+    # ========================================================================
+    # –ú–ï–¢–û–î–´
+    # ========================================================================
+    
+    def generate_number(self):
+        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"""
+        from django.utils.timezone import now
+        date = now()
+        prefix = f"TRX-{date.year}{date.month:02d}{date.day:02d}"
+        
+        # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
+        last_transaction = Transaction.objects.filter(
+            number__startswith=prefix
+        ).order_by('-number').first()
+        
+        if last_transaction:
+            try:
+                last_num = int(last_transaction.number.split('-')[-1])
+                next_num = last_num + 1
+            except (ValueError, IndexError):
+                next_num = 1
+        else:
+            next_num = 1
+        
+        return f"{prefix}-{next_num:05d}"
+    
+    def save(self, *args, **kwargs):
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞"""
+        if not self.number:
+            self.number = self.generate_number()
+        
+        super().save(*args, **kwargs)
+
+        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º save –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞"""
+        if not self.number:
+            self.number = self.generate_number()
+        
+        super().save(*args, **kwargs)
diff --git a/core/models_website.py b/core/models_website.py
index 17bb33c..8c077ab 100644
--- a/core/models_website.py
+++ b/core/models_website.py
@@ -1,416 +1,416 @@
-"""
-–ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ Caromoto Lithuania
-"""
-from django.db import models
-from django.contrib.auth.models import User
-from django.utils import timezone
-from .models import Car, Client, Container
-import os
-import zipfile
-from django.core.files.base import ContentFile
-from PIL import Image
-import io
-
-
-class ClientUser(models.Model):
-    """
-    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏–∑ CRM
-    """
-    user = models.OneToOneField(User, on_delete=models.CASCADE, verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
-    client = models.ForeignKey(Client, on_delete=models.CASCADE, related_name='portal_users', verbose_name="–ö–ª–∏–µ–Ω—Ç")
-    phone = models.CharField(max_length=20, blank=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
-    is_verified = models.BooleanField(default=False, verbose_name="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω")
-    language = models.CharField(max_length=10, default='ru', choices=[
-        ('ru', '–†—É—Å—Å–∫–∏–π'),
-        ('en', 'English'),
-        ('lt', 'Lietuvi≈≥'),
-    ], verbose_name="–Ø–∑—ã–∫")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
-    last_login = models.DateTimeField(null=True, blank=True, verbose_name="–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥")
-    
-    def __str__(self):
-        return f"{self.user.username} ({self.client.name})"
-    
-    class Meta:
-        verbose_name = "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
-        verbose_name_plural = "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
-
-
-class CarPhoto(models.Model):
-    """
-    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
-    """
-    PHOTO_TYPES = [
-        ('LOADING', '–ü–æ–≥—Ä—É–∑–∫–∞'),
-        ('UNLOADING', '–†–∞–∑–≥—Ä—É–∑–∫–∞'),
-        ('DAMAGE', '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è'),
-        ('GENERAL', '–û–±—â–µ–µ'),
-        ('DOCUMENTS', '–î–æ–∫—É–º–µ–Ω—Ç—ã'),
-    ]
-    
-    car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='photos', verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
-    photo = models.ImageField(upload_to='car_photos/%Y/%m/%d/', verbose_name="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è")
-    photo_type = models.CharField(max_length=20, choices=PHOTO_TYPES, default='GENERAL', verbose_name="–¢–∏–ø —Ñ–æ—Ç–æ")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    
-    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ó–∞–≥—Ä—É–∑–∏–ª")
-    uploaded_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
-    
-    is_public = models.BooleanField(default=True, verbose_name="–î–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É")
-    
-    def __str__(self):
-        return f"{self.car.vin} - {self.get_photo_type_display()}"
-    
-    @property
-    def filename(self):
-        return os.path.basename(self.photo.name)
-    
-    class Meta:
-        verbose_name = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è"
-        verbose_name_plural = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
-        ordering = ['-uploaded_at']
-
-
-class ContainerPhoto(models.Model):
-    """
-    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
-    """
-    PHOTO_TYPES = [
-        ('LOADING', '–ü–æ–≥—Ä—É–∑–∫–∞'),
-        ('UNLOADING', '–†–∞–∑–≥—Ä—É–∑–∫–∞'),
-        ('SEAL', '–ü–ª–æ–º–±–∞'),
-        ('GENERAL', '–û–±—â–µ–µ'),
-    ]
-    
-    container = models.ForeignKey(Container, on_delete=models.CASCADE, related_name='photos', verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
-    photo = models.ImageField(upload_to='container_photos/%Y/%m/%d/', verbose_name="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è")
-    thumbnail = models.ImageField(upload_to='container_photos/thumbnails/%Y/%m/%d/', blank=True, null=True, verbose_name="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞")
-    photo_type = models.CharField(max_length=20, choices=PHOTO_TYPES, default='GENERAL', verbose_name="–¢–∏–ø —Ñ–æ—Ç–æ")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    
-    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ó–∞–≥—Ä—É–∑–∏–ª")
-    uploaded_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
-    
-    is_public = models.BooleanField(default=True, verbose_name="–î–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É")
-    
-    def __str__(self):
-        return f"{self.container.number} - {self.get_photo_type_display()}"
-    
-    @property
-    def filename(self):
-        return os.path.basename(self.photo.name)
-    
-    def create_thumbnail(self):
-        """–°–æ–∑–¥–∞–µ—Ç –º–∏–Ω–∏–∞—Ç—é—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏"""
-        import logging
-        logger = logging.getLogger(__name__)
-        
-        if not self.photo:
-            logger.warning(f"ContainerPhoto {self.id}: –Ω–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã")
-            return False
-        
-        try:
-            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
-            if not os.path.exists(self.photo.path):
-                logger.error(f"ContainerPhoto {self.id}: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {self.photo.path}")
-                return False
-            
-            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
-            img = Image.open(self.photo)
-            
-            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
-            if img.mode not in ('RGB', 'RGBA'):
-                img = img.convert('RGB')
-            
-            # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É (–º–∞–∫—Å–∏–º—É–º 400x400px)
-            img.thumbnail((400, 400), Image.Resampling.LANCZOS)
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—É—Ñ–µ—Ä
-            thumb_io = io.BytesIO()
-            img.save(thumb_io, format='JPEG', quality=85, optimize=True)
-            thumb_io.seek(0)
-            
-            # –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã
-            thumb_name = f"thumb_{os.path.basename(self.photo.name)}"
-            
-            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É
-            self.thumbnail.save(thumb_name, ContentFile(thumb_io.read()), save=False)
-            logger.info(f"ContainerPhoto {self.id}: –º–∏–Ω–∏–∞—Ç—é—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞: {thumb_name}")
-            return True
-        except Exception as e:
-            logger.error(f"ContainerPhoto {self.id}: –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã: {e}", exc_info=True)
-            return False
-    
-    def save(self, *args, **kwargs):
-        import logging
-        logger = logging.getLogger(__name__)
-        
-        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–æ–≤—ã–π –ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç
-        is_new = self.pk is None
-        
-        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –ø–µ—Ä–≤—ã–π —Ä–∞–∑
-        super().save(*args, **kwargs)
-        
-        # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç –∏ –µ—Å—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
-        if self.photo and not self.thumbnail:
-            logger.info(f"ContainerPhoto {self.id}: –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã (is_new={is_new})")
-            if self.create_thumbnail():
-                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ thumbnail, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏
-                super().save(update_fields=['thumbnail'])
-            else:
-                logger.warning(f"ContainerPhoto {self.id}: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É")
-    
-    class Meta:
-        verbose_name = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
-        verbose_name_plural = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
-        ordering = ['photo']  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
-
-
-class ContainerPhotoArchive(models.Model):
-    """
-    –ê—Ä—Ö–∏–≤—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
-    """
-    container = models.ForeignKey(Container, on_delete=models.CASCADE, related_name='photo_archives', verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
-    archive_file = models.FileField(upload_to='container_archives/%Y/%m/%d/', verbose_name="–ê—Ä—Ö–∏–≤–Ω—ã–π —Ñ–∞–π–ª")
-    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
-    
-    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ó–∞–≥—Ä—É–∑–∏–ª")
-    uploaded_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
-    
-    is_processed = models.BooleanField(default=False, verbose_name="–û–±—Ä–∞–±–æ—Ç–∞–Ω")
-    photos_count = models.PositiveIntegerField(default=0, verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π")
-    
-    def __str__(self):
-        return f"–ê—Ä—Ö–∏–≤ {self.container.number} - {self.uploaded_at.strftime('%Y-%m-%d')}"
-    
-    def extract_photos(self):
-        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞ –∏ —Å–æ–∑–¥–∞–µ—Ç ContainerPhoto –æ–±—ä–µ–∫—Ç—ã"""
-        import logging
-        logger = logging.getLogger(__name__)
-        
-        if not self.archive_file:
-            logger.warning(f"ContainerPhotoArchive {self.id}: –Ω–µ—Ç –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞")
-            return []
-        
-        photos = []
-        errors = []
-        
-        try:
-            logger.info(f"ContainerPhotoArchive {self.id}: –Ω–∞—á–∞–ª–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ {self.archive_file.path}")
-            
-            with zipfile.ZipFile(self.archive_file.path, 'r') as zip_file:
-                # –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
-                image_files = [f for f in zip_file.filelist 
-                              if f.filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp'))
-                              and not f.filename.startswith('__MACOSX')  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã Mac
-                              and not os.path.basename(f.filename).startswith('.')]  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
-                
-                logger.info(f"ContainerPhotoArchive {self.id}: –Ω–∞–π–¥–µ–Ω–æ {len(image_files)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
-                
-                for file_info in image_files:
-                    try:
-                        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª
-                        file_data = zip_file.read(file_info.filename)
-                        
-                        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ –ø—É—Ç–∏
-                        filename = os.path.basename(file_info.filename)
-                        
-                        # –°–æ–∑–¥–∞–µ–º ContainerPhoto –æ–±—ä–µ–∫—Ç –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ
-                        photo = ContainerPhoto(
-                            container=self.container,
-                            description=f"–ò–∑ –∞—Ä—Ö–∏–≤–∞: {filename}",
-                            uploaded_by=self.uploaded_by
-                        )
-                        
-                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (save=False —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å model.save() –¥–≤–∞–∂–¥—ã)
-                        photo.photo.save(
-                            filename,
-                            ContentFile(file_data),
-                            save=False
-                        )
-                        
-                        # –¢–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å - —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
-                        photo.save()
-                        
-                        photos.append(photo)
-                        logger.debug(f"ContainerPhoto: —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ {filename}")
-                        
-                    except Exception as e:
-                        error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {file_info.filename}: {e}"
-                        logger.error(error_msg, exc_info=True)
-                        errors.append(error_msg)
-                        continue
-                        
-        except Exception as e:
-            error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∞—Ä—Ö–∏–≤–∞: {e}"
-            logger.error(error_msg, exc_info=True)
-            errors.append(error_msg)
-            
-        self.is_processed = True
-        self.photos_count = len(photos)
-        self.save()
-        
-        logger.info(f"ContainerPhotoArchive {self.id}: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£—Å–ø–µ—à–Ω–æ: {len(photos)}, –æ—à–∏–±–æ–∫: {len(errors)}")
-        
-        if errors:
-            logger.warning(f"ContainerPhotoArchive {self.id}: –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:\n" + "\n".join(errors))
-        
-        return photos
-    
-    class Meta:
-        verbose_name = "–ê—Ä—Ö–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
-        verbose_name_plural = "–ê—Ä—Ö–∏–≤—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
-        ordering = ['-uploaded_at']
-
-
-class AIChat(models.Model):
-    """
-    –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–æ–º
-    """
-    session_id = models.CharField(max_length=100, verbose_name="ID —Å–µ—Å—Å–∏–∏")
-    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True, verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
-    client = models.ForeignKey(Client, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–ª–∏–µ–Ω—Ç")
-    
-    message = models.TextField(verbose_name="–°–æ–æ–±—â–µ–Ω–∏–µ")
-    response = models.TextField(verbose_name="–û—Ç–≤–µ—Ç")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞")
-    
-    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
-    processing_time = models.FloatField(null=True, blank=True, verbose_name="–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å–µ–∫)")
-    was_helpful = models.BooleanField(null=True, blank=True, verbose_name="–ë—ã–ª –ª–∏ –ø–æ–ª–µ–∑–µ–Ω –æ—Ç–≤–µ—Ç")
-    context_snapshot = models.JSONField(null=True, blank=True, verbose_name="–ö–æ–Ω—Ç–µ–∫—Å—Ç")
-    
-    class Meta:
-        verbose_name = "–ß–∞—Ç —Å –ò–ò"
-        verbose_name_plural = "–ß–∞—Ç—ã —Å –ò–ò"
-        ordering = ['-created_at']
-    
-    def __str__(self):
-        user_str = self.user.username if self.user else "–ê–Ω–æ–Ω–∏–º–Ω—ã–π"
-        return f"{user_str} - {self.created_at.strftime('%Y-%m-%d %H:%M')}"
-
-
-class NewsPost(models.Model):
-    """
-    –ù–æ–≤–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏
-    """
-    title = models.CharField(max_length=200, verbose_name="–ó–∞–≥–æ–ª–æ–≤–æ–∫")
-    slug = models.SlugField(unique=True, verbose_name="URL")
-    content = models.TextField(verbose_name="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ")
-    excerpt = models.TextField(blank=True, verbose_name="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ")
-    
-    image = models.ImageField(upload_to='news/%Y/%m/%d/', blank=True, null=True, verbose_name="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
-    
-    author = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, verbose_name="–ê–≤—Ç–æ—Ä")
-    
-    published = models.BooleanField(default=False, verbose_name="–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ")
-    published_at = models.DateTimeField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
-    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
-    
-    views = models.PositiveIntegerField(default=0, verbose_name="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã")
-    
-    class Meta:
-        verbose_name = "–ù–æ–≤–æ—Å—Ç—å"
-        verbose_name_plural = "–ù–æ–≤–æ—Å—Ç–∏"
-        ordering = ['-published_at', '-created_at']
-    
-    def __str__(self):
-        return self.title
-    
-    def save(self, *args, **kwargs):
-        if self.published and not self.published_at:
-            self.published_at = timezone.now()
-        super().save(*args, **kwargs)
-
-
-class ContactMessage(models.Model):
-    """
-    –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
-    """
-    name = models.CharField(max_length=100, verbose_name="–ò–º—è")
-    email = models.EmailField(verbose_name="Email")
-    phone = models.CharField(max_length=20, blank=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
-    subject = models.CharField(max_length=200, verbose_name="–¢–µ–º–∞")
-    message = models.TextField(verbose_name="–°–æ–æ–±—â–µ–Ω–∏–µ")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞")
-    is_read = models.BooleanField(default=False, verbose_name="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ")
-    replied = models.BooleanField(default=False, verbose_name="–û—Ç–≤–µ—Ç–∏–ª–∏")
-    
-    class Meta:
-        verbose_name = "–°–æ–æ–±—â–µ–Ω–∏–µ"
-        verbose_name_plural = "–°–æ–æ–±—â–µ–Ω–∏—è"
-        ordering = ['-created_at']
-    
-    def __str__(self):
-        return f"{self.name} - {self.subject}"
-
-
-class TrackingRequest(models.Model):
-    """
-    –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞
-    """
-    tracking_number = models.CharField(max_length=100, verbose_name="–ù–æ–º–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (VIN/–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä)")
-    email = models.EmailField(blank=True, verbose_name="Email")
-    
-    car = models.ForeignKey(Car, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
-    container = models.ForeignKey(Container, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
-    
-    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞")
-    ip_address = models.GenericIPAddressField(null=True, blank=True, verbose_name="IP –∞–¥—Ä–µ—Å")
-    
-    class Meta:
-        verbose_name = "–ó–∞–ø—Ä–æ—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"
-        verbose_name_plural = "–ó–∞–ø—Ä–æ—Å—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"
-        ordering = ['-created_at']
-    
-    def __str__(self):
-        return f"{self.tracking_number} - {self.created_at.strftime('%Y-%m-%d')}"
-
-
-class NotificationLog(models.Model):
-    """
-    –õ–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º
-    """
-    NOTIFICATION_TYPES = [
-        ('PLANNED', '–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞'),
-        ('UNLOADED', '–†–∞–∑–≥—Ä—É–∑–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'),
-    ]
-    
-    container = models.ForeignKey(Container, on_delete=models.CASCADE, related_name='notifications', 
-                                  verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
-    client = models.ForeignKey(Client, on_delete=models.CASCADE, related_name='notifications',
-                               verbose_name="–ö–ª–∏–µ–Ω—Ç")
-    notification_type = models.CharField(max_length=20, choices=NOTIFICATION_TYPES, 
-                                         verbose_name="–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
-    
-    email_to = models.EmailField(verbose_name="Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è")
-    subject = models.CharField(max_length=255, verbose_name="–¢–µ–º–∞ –ø–∏—Å—å–º–∞")
-    
-    cars_info = models.TextField(blank=True, verbose_name="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ",
-                                 help_text="JSON —Å–æ —Å–ø–∏—Å–∫–æ–º VIN –∏ –º–∞—Ä–æ–∫ –∞–≤—Ç–æ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏")
-    
-    sent_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏")
-    success = models.BooleanField(default=True, verbose_name="–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
-    error_message = models.TextField(blank=True, verbose_name="–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ")
-    
-    created_by = models.ForeignKey('auth.User', on_delete=models.SET_NULL, null=True, blank=True,
-                                   verbose_name="–û—Ç–ø—Ä–∞–≤–∏–ª", help_text="–ö—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫—É")
-    
-    class Meta:
-        verbose_name = "–õ–æ–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
-        verbose_name_plural = "–õ–æ–≥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
-        ordering = ['-sent_at']
-        indexes = [
-            models.Index(fields=['container', 'notification_type']),
-            models.Index(fields=['client', 'sent_at']),
-        ]
-    
-    def __str__(self):
-        status = "‚úì" if self.success else "‚úó"
-        return f"{status} {self.get_notification_type_display()} - {self.container.number} ‚Üí {self.email_to}"
-
+"""
+–ú–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ Caromoto Lithuania
+"""
+from django.db import models
+from django.contrib.auth.models import User
+from django.utils import timezone
+from .models import Car, Client, Container
+import os
+import zipfile
+from django.core.files.base import ContentFile
+from PIL import Image
+import io
+
+
+class ClientUser(models.Model):
+    """
+    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏–∑ CRM
+    """
+    user = models.OneToOneField(User, on_delete=models.CASCADE, verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
+    client = models.ForeignKey(Client, on_delete=models.CASCADE, related_name='portal_users', verbose_name="–ö–ª–∏–µ–Ω—Ç")
+    phone = models.CharField(max_length=20, blank=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
+    is_verified = models.BooleanField(default=False, verbose_name="–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω")
+    language = models.CharField(max_length=10, default='ru', choices=[
+        ('ru', '–†—É—Å—Å–∫–∏–π'),
+        ('en', 'English'),
+        ('lt', 'Lietuvi≈≥'),
+    ], verbose_name="–Ø–∑—ã–∫")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
+    last_login = models.DateTimeField(null=True, blank=True, verbose_name="–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥")
+    
+    def __str__(self):
+        return f"{self.user.username} ({self.client.name})"
+    
+    class Meta:
+        verbose_name = "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
+        verbose_name_plural = "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
+
+
+class CarPhoto(models.Model):
+    """
+    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
+    """
+    PHOTO_TYPES = [
+        ('LOADING', '–ü–æ–≥—Ä—É–∑–∫–∞'),
+        ('UNLOADING', '–†–∞–∑–≥—Ä—É–∑–∫–∞'),
+        ('DAMAGE', '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è'),
+        ('GENERAL', '–û–±—â–µ–µ'),
+        ('DOCUMENTS', '–î–æ–∫—É–º–µ–Ω—Ç—ã'),
+    ]
+    
+    car = models.ForeignKey(Car, on_delete=models.CASCADE, related_name='photos', verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
+    photo = models.ImageField(upload_to='car_photos/%Y/%m/%d/', verbose_name="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è")
+    photo_type = models.CharField(max_length=20, choices=PHOTO_TYPES, default='GENERAL', verbose_name="–¢–∏–ø —Ñ–æ—Ç–æ")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    
+    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ó–∞–≥—Ä—É–∑–∏–ª")
+    uploaded_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
+    
+    is_public = models.BooleanField(default=True, verbose_name="–î–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É")
+    
+    def __str__(self):
+        return f"{self.car.vin} - {self.get_photo_type_display()}"
+    
+    @property
+    def filename(self):
+        return os.path.basename(self.photo.name)
+    
+    class Meta:
+        verbose_name = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è"
+        verbose_name_plural = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
+        ordering = ['-uploaded_at']
+
+
+class ContainerPhoto(models.Model):
+    """
+    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
+    """
+    PHOTO_TYPES = [
+        ('LOADING', '–ü–æ–≥—Ä—É–∑–∫–∞'),
+        ('UNLOADING', '–†–∞–∑–≥—Ä—É–∑–∫–∞'),
+        ('SEAL', '–ü–ª–æ–º–±–∞'),
+        ('GENERAL', '–û–±—â–µ–µ'),
+    ]
+    
+    container = models.ForeignKey(Container, on_delete=models.CASCADE, related_name='photos', verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
+    photo = models.ImageField(upload_to='container_photos/%Y/%m/%d/', verbose_name="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è")
+    thumbnail = models.ImageField(upload_to='container_photos/thumbnails/%Y/%m/%d/', blank=True, null=True, verbose_name="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞")
+    photo_type = models.CharField(max_length=20, choices=PHOTO_TYPES, default='GENERAL', verbose_name="–¢–∏–ø —Ñ–æ—Ç–æ")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    
+    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ó–∞–≥—Ä—É–∑–∏–ª")
+    uploaded_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
+    
+    is_public = models.BooleanField(default=True, verbose_name="–î–æ—Å—Ç—É–ø–Ω–æ –∫–ª–∏–µ–Ω—Ç—É")
+    
+    def __str__(self):
+        return f"{self.container.number} - {self.get_photo_type_display()}"
+    
+    @property
+    def filename(self):
+        return os.path.basename(self.photo.name)
+    
+    def create_thumbnail(self):
+        """–°–æ–∑–¥–∞–µ—Ç –º–∏–Ω–∏–∞—Ç—é—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏"""
+        import logging
+        logger = logging.getLogger(__name__)
+        
+        if not self.photo:
+            logger.warning(f"ContainerPhoto {self.id}: –Ω–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã")
+            return False
+        
+        try:
+            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
+            if not os.path.exists(self.photo.path):
+                logger.error(f"ContainerPhoto {self.id}: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {self.photo.path}")
+                return False
+            
+            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
+            img = Image.open(self.photo)
+            
+            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
+            if img.mode not in ('RGB', 'RGBA'):
+                img = img.convert('RGB')
+            
+            # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É (–º–∞–∫—Å–∏–º—É–º 400x400px)
+            img.thumbnail((400, 400), Image.Resampling.LANCZOS)
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—É—Ñ–µ—Ä
+            thumb_io = io.BytesIO()
+            img.save(thumb_io, format='JPEG', quality=85, optimize=True)
+            thumb_io.seek(0)
+            
+            # –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã
+            thumb_name = f"thumb_{os.path.basename(self.photo.name)}"
+            
+            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É
+            self.thumbnail.save(thumb_name, ContentFile(thumb_io.read()), save=False)
+            logger.info(f"ContainerPhoto {self.id}: –º–∏–Ω–∏–∞—Ç—é—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞: {thumb_name}")
+            return True
+        except Exception as e:
+            logger.error(f"ContainerPhoto {self.id}: –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã: {e}", exc_info=True)
+            return False
+    
+    def save(self, *args, **kwargs):
+        import logging
+        logger = logging.getLogger(__name__)
+        
+        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–æ–≤—ã–π –ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç
+        is_new = self.pk is None
+        
+        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –ø–µ—Ä–≤—ã–π —Ä–∞–∑
+        super().save(*args, **kwargs)
+        
+        # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç –∏ –µ—Å—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
+        if self.photo and not self.thumbnail:
+            logger.info(f"ContainerPhoto {self.id}: –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã (is_new={is_new})")
+            if self.create_thumbnail():
+                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ thumbnail, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏
+                super().save(update_fields=['thumbnail'])
+            else:
+                logger.warning(f"ContainerPhoto {self.id}: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É")
+    
+    class Meta:
+        verbose_name = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
+        verbose_name_plural = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
+        ordering = ['photo']  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
+
+
+class ContainerPhotoArchive(models.Model):
+    """
+    –ê—Ä—Ö–∏–≤—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
+    """
+    container = models.ForeignKey(Container, on_delete=models.CASCADE, related_name='photo_archives', verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
+    archive_file = models.FileField(upload_to='container_archives/%Y/%m/%d/', verbose_name="–ê—Ä—Ö–∏–≤–Ω—ã–π —Ñ–∞–π–ª")
+    description = models.TextField(blank=True, verbose_name="–û–ø–∏—Å–∞–Ω–∏–µ")
+    
+    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ó–∞–≥—Ä—É–∑–∏–ª")
+    uploaded_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
+    
+    is_processed = models.BooleanField(default=False, verbose_name="–û–±—Ä–∞–±–æ—Ç–∞–Ω")
+    photos_count = models.PositiveIntegerField(default=0, verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π")
+    
+    def __str__(self):
+        return f"–ê—Ä—Ö–∏–≤ {self.container.number} - {self.uploaded_at.strftime('%Y-%m-%d')}"
+    
+    def extract_photos(self):
+        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞ –∏ —Å–æ–∑–¥–∞–µ—Ç ContainerPhoto –æ–±—ä–µ–∫—Ç—ã"""
+        import logging
+        logger = logging.getLogger(__name__)
+        
+        if not self.archive_file:
+            logger.warning(f"ContainerPhotoArchive {self.id}: –Ω–µ—Ç –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞")
+            return []
+        
+        photos = []
+        errors = []
+        
+        try:
+            logger.info(f"ContainerPhotoArchive {self.id}: –Ω–∞—á–∞–ª–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ {self.archive_file.path}")
+            
+            with zipfile.ZipFile(self.archive_file.path, 'r') as zip_file:
+                # –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
+                image_files = [f for f in zip_file.filelist 
+                              if f.filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp'))
+                              and not f.filename.startswith('__MACOSX')  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã Mac
+                              and not os.path.basename(f.filename).startswith('.')]  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
+                
+                logger.info(f"ContainerPhotoArchive {self.id}: –Ω–∞–π–¥–µ–Ω–æ {len(image_files)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
+                
+                for file_info in image_files:
+                    try:
+                        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª
+                        file_data = zip_file.read(file_info.filename)
+                        
+                        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ –ø—É—Ç–∏
+                        filename = os.path.basename(file_info.filename)
+                        
+                        # –°–æ–∑–¥–∞–µ–º ContainerPhoto –æ–±—ä–µ–∫—Ç –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ
+                        photo = ContainerPhoto(
+                            container=self.container,
+                            description=f"–ò–∑ –∞—Ä—Ö–∏–≤–∞: {filename}",
+                            uploaded_by=self.uploaded_by
+                        )
+                        
+                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (save=False —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å model.save() –¥–≤–∞–∂–¥—ã)
+                        photo.photo.save(
+                            filename,
+                            ContentFile(file_data),
+                            save=False
+                        )
+                        
+                        # –¢–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å - —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
+                        photo.save()
+                        
+                        photos.append(photo)
+                        logger.debug(f"ContainerPhoto: —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ {filename}")
+                        
+                    except Exception as e:
+                        error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {file_info.filename}: {e}"
+                        logger.error(error_msg, exc_info=True)
+                        errors.append(error_msg)
+                        continue
+                        
+        except Exception as e:
+            error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∞—Ä—Ö–∏–≤–∞: {e}"
+            logger.error(error_msg, exc_info=True)
+            errors.append(error_msg)
+            
+        self.is_processed = True
+        self.photos_count = len(photos)
+        self.save()
+        
+        logger.info(f"ContainerPhotoArchive {self.id}: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£—Å–ø–µ—à–Ω–æ: {len(photos)}, –æ—à–∏–±–æ–∫: {len(errors)}")
+        
+        if errors:
+            logger.warning(f"ContainerPhotoArchive {self.id}: –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:\n" + "\n".join(errors))
+        
+        return photos
+    
+    class Meta:
+        verbose_name = "–ê—Ä—Ö–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
+        verbose_name_plural = "–ê—Ä—Ö–∏–≤—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
+        ordering = ['-uploaded_at']
+
+
+class AIChat(models.Model):
+    """
+    –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–æ–º
+    """
+    session_id = models.CharField(max_length=100, verbose_name="ID —Å–µ—Å—Å–∏–∏")
+    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True, verbose_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
+    client = models.ForeignKey(Client, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–ª–∏–µ–Ω—Ç")
+    
+    message = models.TextField(verbose_name="–°–æ–æ–±—â–µ–Ω–∏–µ")
+    response = models.TextField(verbose_name="–û—Ç–≤–µ—Ç")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞")
+    
+    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
+    processing_time = models.FloatField(null=True, blank=True, verbose_name="–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å–µ–∫)")
+    was_helpful = models.BooleanField(null=True, blank=True, verbose_name="–ë—ã–ª –ª–∏ –ø–æ–ª–µ–∑–µ–Ω –æ—Ç–≤–µ—Ç")
+    context_snapshot = models.JSONField(null=True, blank=True, verbose_name="–ö–æ–Ω—Ç–µ–∫—Å—Ç")
+    
+    class Meta:
+        verbose_name = "–ß–∞—Ç —Å –ò–ò"
+        verbose_name_plural = "–ß–∞—Ç—ã —Å –ò–ò"
+        ordering = ['-created_at']
+    
+    def __str__(self):
+        user_str = self.user.username if self.user else "–ê–Ω–æ–Ω–∏–º–Ω—ã–π"
+        return f"{user_str} - {self.created_at.strftime('%Y-%m-%d %H:%M')}"
+
+
+class NewsPost(models.Model):
+    """
+    –ù–æ–≤–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏
+    """
+    title = models.CharField(max_length=200, verbose_name="–ó–∞–≥–æ–ª–æ–≤–æ–∫")
+    slug = models.SlugField(unique=True, verbose_name="URL")
+    content = models.TextField(verbose_name="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ")
+    excerpt = models.TextField(blank=True, verbose_name="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ")
+    
+    image = models.ImageField(upload_to='news/%Y/%m/%d/', blank=True, null=True, verbose_name="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
+    
+    author = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, verbose_name="–ê–≤—Ç–æ—Ä")
+    
+    published = models.BooleanField(default=False, verbose_name="–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ")
+    published_at = models.DateTimeField(null=True, blank=True, verbose_name="–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
+    updated_at = models.DateTimeField(auto_now=True, verbose_name="–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
+    
+    views = models.PositiveIntegerField(default=0, verbose_name="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã")
+    
+    class Meta:
+        verbose_name = "–ù–æ–≤–æ—Å—Ç—å"
+        verbose_name_plural = "–ù–æ–≤–æ—Å—Ç–∏"
+        ordering = ['-published_at', '-created_at']
+    
+    def __str__(self):
+        return self.title
+    
+    def save(self, *args, **kwargs):
+        if self.published and not self.published_at:
+            self.published_at = timezone.now()
+        super().save(*args, **kwargs)
+
+
+class ContactMessage(models.Model):
+    """
+    –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
+    """
+    name = models.CharField(max_length=100, verbose_name="–ò–º—è")
+    email = models.EmailField(verbose_name="Email")
+    phone = models.CharField(max_length=20, blank=True, verbose_name="–¢–µ–ª–µ—Ñ–æ–Ω")
+    subject = models.CharField(max_length=200, verbose_name="–¢–µ–º–∞")
+    message = models.TextField(verbose_name="–°–æ–æ–±—â–µ–Ω–∏–µ")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞")
+    is_read = models.BooleanField(default=False, verbose_name="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ")
+    replied = models.BooleanField(default=False, verbose_name="–û—Ç–≤–µ—Ç–∏–ª–∏")
+    
+    class Meta:
+        verbose_name = "–°–æ–æ–±—â–µ–Ω–∏–µ"
+        verbose_name_plural = "–°–æ–æ–±—â–µ–Ω–∏—è"
+        ordering = ['-created_at']
+    
+    def __str__(self):
+        return f"{self.name} - {self.subject}"
+
+
+class TrackingRequest(models.Model):
+    """
+    –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞
+    """
+    tracking_number = models.CharField(max_length=100, verbose_name="–ù–æ–º–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (VIN/–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä)")
+    email = models.EmailField(blank=True, verbose_name="Email")
+    
+    car = models.ForeignKey(Car, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ê–≤—Ç–æ–º–æ–±–∏–ª—å")
+    container = models.ForeignKey(Container, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
+    
+    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞")
+    ip_address = models.GenericIPAddressField(null=True, blank=True, verbose_name="IP –∞–¥—Ä–µ—Å")
+    
+    class Meta:
+        verbose_name = "–ó–∞–ø—Ä–æ—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"
+        verbose_name_plural = "–ó–∞–ø—Ä–æ—Å—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"
+        ordering = ['-created_at']
+    
+    def __str__(self):
+        return f"{self.tracking_number} - {self.created_at.strftime('%Y-%m-%d')}"
+
+
+class NotificationLog(models.Model):
+    """
+    –õ–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º
+    """
+    NOTIFICATION_TYPES = [
+        ('PLANNED', '–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞'),
+        ('UNLOADED', '–†–∞–∑–≥—Ä—É–∑–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'),
+    ]
+    
+    container = models.ForeignKey(Container, on_delete=models.CASCADE, related_name='notifications', 
+                                  verbose_name="–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä")
+    client = models.ForeignKey(Client, on_delete=models.CASCADE, related_name='notifications',
+                               verbose_name="–ö–ª–∏–µ–Ω—Ç")
+    notification_type = models.CharField(max_length=20, choices=NOTIFICATION_TYPES, 
+                                         verbose_name="–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
+    
+    email_to = models.EmailField(verbose_name="Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è")
+    subject = models.CharField(max_length=255, verbose_name="–¢–µ–º–∞ –ø–∏—Å—å–º–∞")
+    
+    cars_info = models.TextField(blank=True, verbose_name="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ",
+                                 help_text="JSON —Å–æ —Å–ø–∏—Å–∫–æ–º VIN –∏ –º–∞—Ä–æ–∫ –∞–≤—Ç–æ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏")
+    
+    sent_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏")
+    success = models.BooleanField(default=True, verbose_name="–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
+    error_message = models.TextField(blank=True, verbose_name="–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ")
+    
+    created_by = models.ForeignKey('auth.User', on_delete=models.SET_NULL, null=True, blank=True,
+                                   verbose_name="–û—Ç–ø—Ä–∞–≤–∏–ª", help_text="–ö—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫—É")
+    
+    class Meta:
+        verbose_name = "–õ–æ–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
+        verbose_name_plural = "–õ–æ–≥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
+        ordering = ['-sent_at']
+        indexes = [
+            models.Index(fields=['container', 'notification_type']),
+            models.Index(fields=['client', 'sent_at']),
+        ]
+    
+    def __str__(self):
+        status = "‚úì" if self.success else "‚úó"
+        return f"{status} {self.get_notification_type_display()} - {self.container.number} ‚Üí {self.email_to}"
+
diff --git a/core/services/admin_ai_agent.py b/core/services/admin_ai_agent.py
index 3d4edbc..18f78aa 100644
--- a/core/services/admin_ai_agent.py
+++ b/core/services/admin_ai_agent.py
@@ -1,372 +1,372 @@
-import logging
-import re
-from decimal import Decimal
-from typing import Dict, Optional
-
-from django.conf import settings
-
-from core.models import Car, Carrier, Company, Container, Line, Warehouse, WarehouseService, CarService
-from core.models_billing import NewInvoice
-from core.models_website import ContainerPhoto, CarPhoto
-from core.services.ai_chat_service import _call_ai_api, AIServiceError
-from core.services.ai_rag import build_rag_snippets
-
-logger = logging.getLogger(__name__)
-
-
-def _extract_identifiers(message: str) -> Dict[str, list]:
-    vin_pattern = re.compile(r"\b[A-HJ-NPR-Z0-9]{17}\b", re.IGNORECASE)
-    container_pattern = re.compile(r"\b[A-Z]{4}\d{7}\b", re.IGNORECASE)
-    invoice_pattern = re.compile(r"\bINV-\d{6}-\d{4}\b", re.IGNORECASE)
-
-    vins = list({m.group(0).upper() for m in vin_pattern.finditer(message or "")})
-    containers = list({m.group(0).upper() for m in container_pattern.finditer(message or "")})
-    invoices = list({m.group(0).upper() for m in invoice_pattern.finditer(message or "")})
-    return {"vins": vins, "containers": containers, "invoices": invoices}
-
-
-def _summarize_container(container: Container) -> str:
-    car_count = container.container_cars.count()
-    return (
-        f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: —Å—Ç–∞—Ç—É—Å {container.get_status_display()}, "
-        f"–ª–∏–Ω–∏—è {container.line.name if container.line else '‚Äî'}, "
-        f"—Å–∫–ª–∞–¥ {container.warehouse.name if container.warehouse else '‚Äî'}, "
-        f"THS {container.ths or '‚Äî'} ({container.ths_payer}), "
-        f"ETA {container.eta or '‚Äî'}, –≤—ã–≥—Ä—É–∑–∫–∞ {container.unload_date or '‚Äî'}, "
-        f"–¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ: {car_count}."
-    )
-
-
-def _summarize_car(car: Car) -> str:
-    return (
-        f"–ê–≤—Ç–æ VIN {car.vin}: —Å—Ç–∞—Ç—É—Å {car.get_status_display()}, "
-        f"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä {car.container.number if car.container else '‚Äî'}, "
-        f"—Å–∫–ª–∞–¥ {car.warehouse.name if car.warehouse else '‚Äî'}, "
-        f"–ª–∏–Ω–∏—è {car.line.name if car.line else '‚Äî'}, "
-        f"–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫ {car.carrier.name if car.carrier else '‚Äî'}, "
-        f"–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ {car.days or 0}, —Ö—Ä–∞–Ω–µ–Ω–∏–µ {car.storage_cost or 0}, "
-        f"–∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ {car.total_price or 0}."
-    )
-
-
-def _summarize_invoice(invoice: NewInvoice) -> str:
-    issuer = (
-        invoice.issuer_company
-        or invoice.issuer_warehouse
-        or invoice.issuer_line
-        or invoice.issuer_carrier
-    )
-    recipient = (
-        invoice.recipient_client
-        or invoice.recipient_company
-        or invoice.recipient_warehouse
-        or invoice.recipient_line
-        or invoice.recipient_carrier
-    )
-    return (
-        f"–ò–Ω–≤–æ–π—Å {invoice.number}: —Å—Ç–∞—Ç—É—Å {invoice.get_status_display()}, "
-        f"–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å {issuer or '‚Äî'}, –ø–æ–ª—É—á–∞—Ç–µ–ª—å {recipient or '‚Äî'}, "
-        f"–∏—Ç–æ–≥–æ {invoice.total or 0}, –æ–ø–ª–∞—á–µ–Ω–æ {invoice.paid_amount or 0}."
-    )
-
-
-def _summarize_photos_for_car(car: Car) -> str:
-    car_photos = CarPhoto.objects.filter(car=car)
-    container_photos = ContainerPhoto.objects.filter(container=car.container) if car.container else None
-    container_count = container_photos.count() if container_photos is not None else 0
-    return (
-        f"–§–æ—Ç–æ –∞–≤—Ç–æ: {car_photos.count()} —à—Ç., "
-        f"—Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç."
-    )
-
-def _format_money(value: Optional[Decimal]) -> str:
-    try:
-        return f"{Decimal(value or 0):.2f}"
-    except Exception:
-        return "0.00"
-
-
-def _build_price_context(car: Car) -> str:
-    services = CarService.objects.filter(car=car)
-    services_total = Decimal("0")
-    markup_total = Decimal("0")
-    for service in services:
-        services_total += service.final_price or Decimal("0")
-        markup_total += (service.markup_amount or Decimal("0")) * (service.quantity or 1)
-
-    total_price = car.total_price or (services_total + markup_total)
-    storage_cost = car.storage_cost or Decimal("0")
-
-    return (
-        f"–¶–µ–Ω–∞ –∞–≤—Ç–æ (–∏—Ç–æ–≥–æ): {_format_money(total_price)} EUR. "
-        f"–£—Å–ª—É–≥–∏: {_format_money(services_total)} EUR. "
-        f"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞: {_format_money(markup_total)} EUR. "
-        f"–•—Ä–∞–Ω–µ–Ω–∏–µ: {_format_money(storage_cost)} EUR."
-    )
-
-
-def _summarize_current_object(page_context: Dict) -> str:
-    if not page_context:
-        return ""
-    model_name = (page_context.get("model_name") or "").lower()
-    object_id = page_context.get("object_id")
-    if not model_name or not object_id or not str(object_id).isdigit():
-        return ""
-
-    model_map = {
-        "container": Container,
-        "car": Car,
-        "newinvoice": NewInvoice,
-        "line": Line,
-        "warehouse": Warehouse,
-        "carrier": Carrier,
-        "company": Company,
-    }
-    model = model_map.get(model_name)
-    if not model:
-        return ""
-
-    obj = model.objects.filter(pk=object_id).first()
-    if not obj:
-        return ""
-
-    if model is Container:
-        return _summarize_container(obj)
-    if model is Car:
-        return _summarize_car(obj)
-    if model is NewInvoice:
-        return _summarize_invoice(obj)
-    if model in (Line, Warehouse, Carrier, Company):
-        return f"{model.__name__}: {getattr(obj, 'name', str(obj))}."
-    return ""
-
-
-def _build_db_context(message: str, page_context: Dict) -> str:
-    parts = []
-    current_summary = _summarize_current_object(page_context)
-    if current_summary:
-        parts.append(f"–û—Ç–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {current_summary}")
-
-    identifiers = _extract_identifiers(message)
-
-    for vin in identifiers["vins"]:
-        car = Car.objects.select_related("container", "warehouse", "line", "carrier").filter(vin__iexact=vin).first()
-        if car:
-            parts.append(_summarize_car(car))
-            parts.append(_summarize_photos_for_car(car))
-            if _wants_price(message):
-                parts.append(_build_price_context(car))
-        else:
-            parts.append(f"VIN {vin}: –∞–≤—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
-
-    for number in identifiers["containers"]:
-        container = Container.objects.select_related("line", "warehouse").filter(number__iexact=number).first()
-        if container:
-            parts.append(_summarize_container(container))
-        else:
-            parts.append(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {number} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
-
-    for inv_number in identifiers["invoices"]:
-        invoice = NewInvoice.objects.filter(number__iexact=inv_number).first()
-        if invoice:
-            parts.append(_summarize_invoice(invoice))
-        else:
-            parts.append(f"–ò–Ω–≤–æ–π—Å {inv_number} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
-
-    return " ".join(parts)
-
-
-def _build_ui_guidance(message: str, page_context: Dict) -> str:
-    message_lower = (message or "").lower()
-    model_name = (page_context.get("model_name") or "").lower() if page_context else ""
-
-    if "–ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å ths" in message_lower or "–ø–µ—Ä–µ—Å—á–µ—Ç ths" in message_lower:
-        if model_name == "line":
-            return (
-                "–ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ THS –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏: "
-                "–æ—Ç–∫—Ä–æ–π—Ç–µ –ª–∏–Ω–∏—é, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –Ω–∞–∂–º–∏—Ç–µ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\"."
-            )
-        return (
-            "THS –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å line/ths/ths_payer/warehouse. "
-            "–î–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø–æ –ª–∏–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏."
-        )
-
-    if "—Ö—Ä–∞–Ω–µ–Ω–∏–µ" in message_lower and "—Ü–µ–Ω–∞" in message_lower:
-        return (
-            "–¶–µ–Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞ –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\". "
-            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–Ω–∏, –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∏ —Å—Ç–∞–≤–∫—É —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞."
-        )
-
-    if "–∏–Ω–≤–æ–π—Å" in message_lower and "–Ω–µ –æ–±–Ω–æ–≤" in message_lower:
-        return (
-            "–ò–Ω–≤–æ–π—Å—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å–∏–≥–Ω–∞–ª–∞–º–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥/–¥–Ω–µ–π/—Å—Ç–∞—Ç—É—Å–∞ –¢–°. "
-            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ —Å–∏–≥–Ω–∞–ª–æ–≤."
-        )
-
-    return ""
-
-def _wants_price(message: str) -> bool:
-    message_lower = (message or "").lower()
-    keywords = ["—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "–∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞", "–∏—Ç–æ–≥–æ", "total price"]
-    return any(keyword in message_lower for keyword in keywords)
-
-
-def _wants_diagnostics(message: str) -> bool:
-    message_lower = (message or "").lower()
-    triggers = [
-        "–¥–∏–∞–≥–Ω–æ—Å—Ç", "debug", "–æ—à–∏–±–∫–∞", "–ø–æ—á–µ–º—É", "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç", "–Ω–µ –æ–±–Ω–æ–≤",
-        "–Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è", "–Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è", "–Ω–µ —Å–æ–∑–¥–∞–µ—Ç", "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å",
-    ]
-    return any(trigger in message_lower for trigger in triggers)
-
-
-def _diagnose_car(car: Car) -> list:
-    issues = []
-    if car.status == "UNLOADED" and not car.unload_date:
-        issues.append("–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –±–µ–∑ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏.")
-    if car.status == "TRANSFERRED" and not car.transfer_date:
-        issues.append("–°—Ç–∞—Ç—É—Å '–ü–µ—Ä–µ–¥–∞–Ω' –±–µ–∑ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏.")
-    if car.container and car.container.unload_date and not car.unload_date:
-        issues.append("–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å—Ç—å, –∞ —É –∞–≤—Ç–æ –Ω–µ—Ç (–æ–∂–∏–¥–∞–ª–æ—Å—å –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ).")
-    if car.container and car.container.line and car.line and car.container.line_id != car.line_id:
-        issues.append("–õ–∏–Ω–∏—è –∞–≤—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ª–∏–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.")
-    if car.container and car.container.warehouse and car.warehouse and car.container.warehouse_id != car.warehouse_id:
-        issues.append("–°–∫–ª–∞–¥ –∞–≤—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–∫–ª–∞–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.")
-    if car.days and car.days > 0:
-        if not car.warehouse:
-            issues.append("–ï—Å—Ç—å –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏, –Ω–æ —Å–∫–ª–∞–¥ –Ω–µ —É–∫–∞–∑–∞–Ω.")
-        else:
-            storage_service = WarehouseService.objects.filter(
-                warehouse=car.warehouse, name__iexact="–•—Ä–∞–Ω–µ–Ω–∏–µ"
-            ).first()
-            if not storage_service:
-                issues.append("–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' (–Ω—É–∂–Ω–∞ —Å—Ç–∞–≤–∫–∞ –ø–æ –¥–Ω—è–º).")
-            else:
-                has_storage_service = CarService.objects.filter(
-                    car=car, service_type="WAREHOUSE", service_id=storage_service.id
-                ).exists()
-                if not has_storage_service:
-                    issues.append("–£ –∞–≤—Ç–æ –Ω–µ—Ç —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' (CarService).")
-            if not car.storage_cost or car.storage_cost == 0:
-                issues.append("–°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è = 0 –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π.")
-    return issues
-
-
-def _diagnose_container(container: Container) -> list:
-    issues = []
-    if container.status == "UNLOADED":
-        if not container.unload_date:
-            issues.append("–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –±–µ–∑ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏.")
-        if not container.warehouse:
-            issues.append("–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –±–µ–∑ —Å–∫–ª–∞–¥–∞.")
-    if container.ths and not container.line:
-        issues.append("THS —É–∫–∞–∑–∞–Ω–æ, –Ω–æ –ª–∏–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.")
-    if container.ths_payer == "WAREHOUSE" and not container.warehouse:
-        issues.append("THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥, –Ω–æ —Å–∫–ª–∞–¥ –Ω–µ —É–∫–∞–∑–∞–Ω.")
-    if container.container_cars.count() == 0:
-        issues.append("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–µ–∑ –¢–°.")
-    return issues
-
-
-def _diagnose_invoice(invoice: NewInvoice) -> list:
-    issues = []
-    if invoice.cars.count() == 0:
-        issues.append("–ò–Ω–≤–æ–π—Å –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¢–°.")
-    if invoice.total is None:
-        issues.append("–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞.")
-    if invoice.status in {"ISSUED", "PARTIALLY_PAID", "PAID"} and invoice.total in (0, None):
-        issues.append("–ò–Ω–≤–æ–π—Å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω, –Ω–æ —Å—É–º–º–∞ 0/–ø—É—Å—Ç–∞—è.")
-    return issues
-
-
-def _run_diagnostics(page_context: Dict) -> str:
-    if not page_context:
-        return ""
-    model_name = (page_context.get("model_name") or "").lower()
-    object_id = page_context.get("object_id")
-    if not object_id or not str(object_id).isdigit():
-        return "–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—ä–µ–∫—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É."
-
-    diagnostics = []
-
-    if model_name == "car":
-        car = Car.objects.select_related("container", "warehouse", "line", "carrier").filter(pk=object_id).first()
-        if car:
-            diagnostics.extend(_diagnose_car(car))
-    elif model_name == "container":
-        container = Container.objects.select_related("line", "warehouse").filter(pk=object_id).first()
-        if container:
-            diagnostics.extend(_diagnose_container(container))
-    elif model_name == "newinvoice":
-        invoice = NewInvoice.objects.filter(pk=object_id).first()
-        if invoice:
-            diagnostics.extend(_diagnose_invoice(invoice))
-    else:
-        return "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –¢–° –∏ –∏–Ω–≤–æ–π—Å–æ–≤."
-
-    if not diagnostics:
-        return "–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
-    return "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: " + " ".join(diagnostics)
-
-
-def generate_admin_ai_response(
-    message: str,
-    user,
-    page_context: Optional[Dict] = None,
-    session_id: Optional[str] = None,
-    language_code: str = "ru",
-) -> Dict[str, Optional[str]]:
-    page_context = page_context or {}
-    db_context = _build_db_context(message, page_context)
-    rag_context = build_rag_snippets(message, top_k=getattr(settings, "AI_RAG_TOP_K", 4))
-    ui_guidance = _build_ui_guidance(message, page_context)
-    diagnostics = _run_diagnostics(page_context) if _wants_diagnostics(message) else ""
-    price_context = ""
-    if _wants_price(message):
-        model_name = (page_context.get("model_name") or "").lower()
-        object_id = page_context.get("object_id")
-        if model_name == "car" and object_id and str(object_id).isdigit():
-            car = Car.objects.filter(pk=object_id).first()
-            if car:
-                price_context = _build_price_context(car)
-
-    system_prompt = (
-        "–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ Logist2. "
-        "–¢—ã –∑–Ω–∞–µ—à—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ –∞–¥–º–∏–Ω–∫–∏. "
-        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —É—Ç–æ—á–Ω–∏. "
-        "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –∞–¥–º–∏–Ω–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã. "
-        "–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ ‚Äî –¥–∞–π —Ç–æ—á–Ω—ã–µ —à–∞–≥–∏."
-    )
-
-    language_map = {"ru": "–†—É—Å—Å–∫–∏–π", "en": "English", "lt": "Lietuvi≈≥"}
-    language_name = language_map.get(language_code, "–†—É—Å—Å–∫–∏–π")
-
-    messages = [
-        {"role": "system", "content": system_prompt},
-        {"role": "system", "content": f"–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: {language_name}."},
-    ]
-    if page_context:
-        messages.append({"role": "system", "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {page_context}"})
-    if db_context:
-        messages.append({"role": "system", "content": f"–î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î: {db_context}"})
-    if ui_guidance:
-        messages.append({"role": "system", "content": f"–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π: {ui_guidance}"})
-    if diagnostics:
-        messages.append({"role": "system", "content": f"–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: {diagnostics}"})
-    if price_context:
-        messages.append({"role": "system", "content": f"–¶–µ–Ω–∞ –ø–æ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –∞–≤—Ç–æ: {price_context}"})
-    if rag_context:
-        messages.append({"role": "system", "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞:\n{rag_context}"})
-    messages.append({"role": "user", "content": message})
-
-    try:
-        response_text = _call_ai_api(messages)
-        return {"response": response_text, "used_fallback": False, "fallback_reason": None}
-    except AIServiceError as exc:
-        logger.warning("Admin AI failed: %s", exc)
-        fallback = ui_guidance or "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –£—Ç–æ—á–Ω–∏—Ç–µ VIN, –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
-        return {"response": fallback, "used_fallback": True, "fallback_reason": str(exc)}
-    except Exception as exc:
-        logger.warning("Admin AI failed: %s", exc)
-        fallback = ui_guidance or "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –£—Ç–æ—á–Ω–∏—Ç–µ VIN, –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
-        return {"response": fallback, "used_fallback": True, "fallback_reason": "unknown_error"}
+import logging
+import re
+from decimal import Decimal
+from typing import Dict, Optional
+
+from django.conf import settings
+
+from core.models import Car, Carrier, Company, Container, Line, Warehouse, WarehouseService, CarService
+from core.models_billing import NewInvoice
+from core.models_website import ContainerPhoto, CarPhoto
+from core.services.ai_chat_service import _call_ai_api, AIServiceError
+from core.services.ai_rag import build_rag_snippets
+
+logger = logging.getLogger(__name__)
+
+
+def _extract_identifiers(message: str) -> Dict[str, list]:
+    vin_pattern = re.compile(r"\b[A-HJ-NPR-Z0-9]{17}\b", re.IGNORECASE)
+    container_pattern = re.compile(r"\b[A-Z]{4}\d{7}\b", re.IGNORECASE)
+    invoice_pattern = re.compile(r"\bINV-\d{6}-\d{4}\b", re.IGNORECASE)
+
+    vins = list({m.group(0).upper() for m in vin_pattern.finditer(message or "")})
+    containers = list({m.group(0).upper() for m in container_pattern.finditer(message or "")})
+    invoices = list({m.group(0).upper() for m in invoice_pattern.finditer(message or "")})
+    return {"vins": vins, "containers": containers, "invoices": invoices}
+
+
+def _summarize_container(container: Container) -> str:
+    car_count = container.container_cars.count()
+    return (
+        f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {container.number}: —Å—Ç–∞—Ç—É—Å {container.get_status_display()}, "
+        f"–ª–∏–Ω–∏—è {container.line.name if container.line else '‚Äî'}, "
+        f"—Å–∫–ª–∞–¥ {container.warehouse.name if container.warehouse else '‚Äî'}, "
+        f"THS {container.ths or '‚Äî'} ({container.ths_payer}), "
+        f"ETA {container.eta or '‚Äî'}, –≤—ã–≥—Ä—É–∑–∫–∞ {container.unload_date or '‚Äî'}, "
+        f"–¢–° –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ: {car_count}."
+    )
+
+
+def _summarize_car(car: Car) -> str:
+    return (
+        f"–ê–≤—Ç–æ VIN {car.vin}: —Å—Ç–∞—Ç—É—Å {car.get_status_display()}, "
+        f"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä {car.container.number if car.container else '‚Äî'}, "
+        f"—Å–∫–ª–∞–¥ {car.warehouse.name if car.warehouse else '‚Äî'}, "
+        f"–ª–∏–Ω–∏—è {car.line.name if car.line else '‚Äî'}, "
+        f"–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫ {car.carrier.name if car.carrier else '‚Äî'}, "
+        f"–ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ {car.days or 0}, —Ö—Ä–∞–Ω–µ–Ω–∏–µ {car.storage_cost or 0}, "
+        f"–∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ {car.total_price or 0}."
+    )
+
+
+def _summarize_invoice(invoice: NewInvoice) -> str:
+    issuer = (
+        invoice.issuer_company
+        or invoice.issuer_warehouse
+        or invoice.issuer_line
+        or invoice.issuer_carrier
+    )
+    recipient = (
+        invoice.recipient_client
+        or invoice.recipient_company
+        or invoice.recipient_warehouse
+        or invoice.recipient_line
+        or invoice.recipient_carrier
+    )
+    return (
+        f"–ò–Ω–≤–æ–π—Å {invoice.number}: —Å—Ç–∞—Ç—É—Å {invoice.get_status_display()}, "
+        f"–≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å {issuer or '‚Äî'}, –ø–æ–ª—É—á–∞—Ç–µ–ª—å {recipient or '‚Äî'}, "
+        f"–∏—Ç–æ–≥–æ {invoice.total or 0}, –æ–ø–ª–∞—á–µ–Ω–æ {invoice.paid_amount or 0}."
+    )
+
+
+def _summarize_photos_for_car(car: Car) -> str:
+    car_photos = CarPhoto.objects.filter(car=car)
+    container_photos = ContainerPhoto.objects.filter(container=car.container) if car.container else None
+    container_count = container_photos.count() if container_photos is not None else 0
+    return (
+        f"–§–æ—Ç–æ –∞–≤—Ç–æ: {car_photos.count()} —à—Ç., "
+        f"—Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç."
+    )
+
+def _format_money(value: Optional[Decimal]) -> str:
+    try:
+        return f"{Decimal(value or 0):.2f}"
+    except Exception:
+        return "0.00"
+
+
+def _build_price_context(car: Car) -> str:
+    services = CarService.objects.filter(car=car)
+    services_total = Decimal("0")
+    markup_total = Decimal("0")
+    for service in services:
+        services_total += service.final_price or Decimal("0")
+        markup_total += (service.markup_amount or Decimal("0")) * (service.quantity or 1)
+
+    total_price = car.total_price or (services_total + markup_total)
+    storage_cost = car.storage_cost or Decimal("0")
+
+    return (
+        f"–¶–µ–Ω–∞ –∞–≤—Ç–æ (–∏—Ç–æ–≥–æ): {_format_money(total_price)} EUR. "
+        f"–£—Å–ª—É–≥–∏: {_format_money(services_total)} EUR. "
+        f"–°–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞: {_format_money(markup_total)} EUR. "
+        f"–•—Ä–∞–Ω–µ–Ω–∏–µ: {_format_money(storage_cost)} EUR."
+    )
+
+
+def _summarize_current_object(page_context: Dict) -> str:
+    if not page_context:
+        return ""
+    model_name = (page_context.get("model_name") or "").lower()
+    object_id = page_context.get("object_id")
+    if not model_name or not object_id or not str(object_id).isdigit():
+        return ""
+
+    model_map = {
+        "container": Container,
+        "car": Car,
+        "newinvoice": NewInvoice,
+        "line": Line,
+        "warehouse": Warehouse,
+        "carrier": Carrier,
+        "company": Company,
+    }
+    model = model_map.get(model_name)
+    if not model:
+        return ""
+
+    obj = model.objects.filter(pk=object_id).first()
+    if not obj:
+        return ""
+
+    if model is Container:
+        return _summarize_container(obj)
+    if model is Car:
+        return _summarize_car(obj)
+    if model is NewInvoice:
+        return _summarize_invoice(obj)
+    if model in (Line, Warehouse, Carrier, Company):
+        return f"{model.__name__}: {getattr(obj, 'name', str(obj))}."
+    return ""
+
+
+def _build_db_context(message: str, page_context: Dict) -> str:
+    parts = []
+    current_summary = _summarize_current_object(page_context)
+    if current_summary:
+        parts.append(f"–û—Ç–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {current_summary}")
+
+    identifiers = _extract_identifiers(message)
+
+    for vin in identifiers["vins"]:
+        car = Car.objects.select_related("container", "warehouse", "line", "carrier").filter(vin__iexact=vin).first()
+        if car:
+            parts.append(_summarize_car(car))
+            parts.append(_summarize_photos_for_car(car))
+            if _wants_price(message):
+                parts.append(_build_price_context(car))
+        else:
+            parts.append(f"VIN {vin}: –∞–≤—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
+
+    for number in identifiers["containers"]:
+        container = Container.objects.select_related("line", "warehouse").filter(number__iexact=number).first()
+        if container:
+            parts.append(_summarize_container(container))
+        else:
+            parts.append(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {number} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
+
+    for inv_number in identifiers["invoices"]:
+        invoice = NewInvoice.objects.filter(number__iexact=inv_number).first()
+        if invoice:
+            parts.append(_summarize_invoice(invoice))
+        else:
+            parts.append(f"–ò–Ω–≤–æ–π—Å {inv_number} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
+
+    return " ".join(parts)
+
+
+def _build_ui_guidance(message: str, page_context: Dict) -> str:
+    message_lower = (message or "").lower()
+    model_name = (page_context.get("model_name") or "").lower() if page_context else ""
+
+    if "–ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å ths" in message_lower or "–ø–µ—Ä–µ—Å—á–µ—Ç ths" in message_lower:
+        if model_name == "line":
+            return (
+                "–ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ THS –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏: "
+                "–æ—Ç–∫—Ä–æ–π—Ç–µ –ª–∏–Ω–∏—é, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –Ω–∞–∂–º–∏—Ç–µ \"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å THS\"."
+            )
+        return (
+            "THS –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å line/ths/ths_payer/warehouse. "
+            "–î–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø–æ –ª–∏–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–Ω–∏–∏."
+        )
+
+    if "—Ö—Ä–∞–Ω–µ–Ω–∏–µ" in message_lower and "—Ü–µ–Ω–∞" in message_lower:
+        return (
+            "–¶–µ–Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞ –∏–∑ —É—Å–ª—É–≥–∏ \"–•—Ä–∞–Ω–µ–Ω–∏–µ\". "
+            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–Ω–∏, –¥–∞—Ç—É —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∏ —Å—Ç–∞–≤–∫—É —É—Å–ª—É–≥–∏ —Å–∫–ª–∞–¥–∞."
+        )
+
+    if "–∏–Ω–≤–æ–π—Å" in message_lower and "–Ω–µ –æ–±–Ω–æ–≤" in message_lower:
+        return (
+            "–ò–Ω–≤–æ–π—Å—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å–∏–≥–Ω–∞–ª–∞–º–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥/–¥–Ω–µ–π/—Å—Ç–∞—Ç—É—Å–∞ –¢–°. "
+            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ —Å–∏–≥–Ω–∞–ª–æ–≤."
+        )
+
+    return ""
+
+def _wants_price(message: str) -> bool:
+    message_lower = (message or "").lower()
+    keywords = ["—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "–∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞", "–∏—Ç–æ–≥–æ", "total price"]
+    return any(keyword in message_lower for keyword in keywords)
+
+
+def _wants_diagnostics(message: str) -> bool:
+    message_lower = (message or "").lower()
+    triggers = [
+        "–¥–∏–∞–≥–Ω–æ—Å—Ç", "debug", "–æ—à–∏–±–∫–∞", "–ø–æ—á–µ–º—É", "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç", "–Ω–µ –æ–±–Ω–æ–≤",
+        "–Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è", "–Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è", "–Ω–µ —Å–æ–∑–¥–∞–µ—Ç", "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å",
+    ]
+    return any(trigger in message_lower for trigger in triggers)
+
+
+def _diagnose_car(car: Car) -> list:
+    issues = []
+    if car.status == "UNLOADED" and not car.unload_date:
+        issues.append("–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –±–µ–∑ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏.")
+    if car.status == "TRANSFERRED" and not car.transfer_date:
+        issues.append("–°—Ç–∞—Ç—É—Å '–ü–µ—Ä–µ–¥–∞–Ω' –±–µ–∑ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥–∞—á–∏.")
+    if car.container and car.container.unload_date and not car.unload_date:
+        issues.append("–î–∞—Ç–∞ —Ä–∞–∑–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å—Ç—å, –∞ —É –∞–≤—Ç–æ –Ω–µ—Ç (–æ–∂–∏–¥–∞–ª–æ—Å—å –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ).")
+    if car.container and car.container.line and car.line and car.container.line_id != car.line_id:
+        issues.append("–õ–∏–Ω–∏—è –∞–≤—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ª–∏–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.")
+    if car.container and car.container.warehouse and car.warehouse and car.container.warehouse_id != car.warehouse_id:
+        issues.append("–°–∫–ª–∞–¥ –∞–≤—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–∫–ª–∞–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.")
+    if car.days and car.days > 0:
+        if not car.warehouse:
+            issues.append("–ï—Å—Ç—å –ø–ª–∞—Ç–Ω—ã–µ –¥–Ω–∏, –Ω–æ —Å–∫–ª–∞–¥ –Ω–µ —É–∫–∞–∑–∞–Ω.")
+        else:
+            storage_service = WarehouseService.objects.filter(
+                warehouse=car.warehouse, name__iexact="–•—Ä–∞–Ω–µ–Ω–∏–µ"
+            ).first()
+            if not storage_service:
+                issues.append("–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' (–Ω—É–∂–Ω–∞ —Å—Ç–∞–≤–∫–∞ –ø–æ –¥–Ω—è–º).")
+            else:
+                has_storage_service = CarService.objects.filter(
+                    car=car, service_type="WAREHOUSE", service_id=storage_service.id
+                ).exists()
+                if not has_storage_service:
+                    issues.append("–£ –∞–≤—Ç–æ –Ω–µ—Ç —É—Å–ª—É–≥–∏ '–•—Ä–∞–Ω–µ–Ω–∏–µ' (CarService).")
+            if not car.storage_cost or car.storage_cost == 0:
+                issues.append("–°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è = 0 –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–ª–∞—Ç–Ω—ã—Ö –¥–Ω–µ–π.")
+    return issues
+
+
+def _diagnose_container(container: Container) -> list:
+    issues = []
+    if container.status == "UNLOADED":
+        if not container.unload_date:
+            issues.append("–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –±–µ–∑ –¥–∞—Ç—ã —Ä–∞–∑–≥—Ä—É–∑–∫–∏.")
+        if not container.warehouse:
+            issues.append("–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' –±–µ–∑ —Å–∫–ª–∞–¥–∞.")
+    if container.ths and not container.line:
+        issues.append("THS —É–∫–∞–∑–∞–Ω–æ, –Ω–æ –ª–∏–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.")
+    if container.ths_payer == "WAREHOUSE" and not container.warehouse:
+        issues.append("THS —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥, –Ω–æ —Å–∫–ª–∞–¥ –Ω–µ —É–∫–∞–∑–∞–Ω.")
+    if container.container_cars.count() == 0:
+        issues.append("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–µ–∑ –¢–°.")
+    return issues
+
+
+def _diagnose_invoice(invoice: NewInvoice) -> list:
+    issues = []
+    if invoice.cars.count() == 0:
+        issues.append("–ò–Ω–≤–æ–π—Å –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¢–°.")
+    if invoice.total is None:
+        issues.append("–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞.")
+    if invoice.status in {"ISSUED", "PARTIALLY_PAID", "PAID"} and invoice.total in (0, None):
+        issues.append("–ò–Ω–≤–æ–π—Å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω, –Ω–æ —Å—É–º–º–∞ 0/–ø—É—Å—Ç–∞—è.")
+    return issues
+
+
+def _run_diagnostics(page_context: Dict) -> str:
+    if not page_context:
+        return ""
+    model_name = (page_context.get("model_name") or "").lower()
+    object_id = page_context.get("object_id")
+    if not object_id or not str(object_id).isdigit():
+        return "–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—ä–µ–∫—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É."
+
+    diagnostics = []
+
+    if model_name == "car":
+        car = Car.objects.select_related("container", "warehouse", "line", "carrier").filter(pk=object_id).first()
+        if car:
+            diagnostics.extend(_diagnose_car(car))
+    elif model_name == "container":
+        container = Container.objects.select_related("line", "warehouse").filter(pk=object_id).first()
+        if container:
+            diagnostics.extend(_diagnose_container(container))
+    elif model_name == "newinvoice":
+        invoice = NewInvoice.objects.filter(pk=object_id).first()
+        if invoice:
+            diagnostics.extend(_diagnose_invoice(invoice))
+    else:
+        return "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –¢–° –∏ –∏–Ω–≤–æ–π—Å–æ–≤."
+
+    if not diagnostics:
+        return "–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
+    return "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: " + " ".join(diagnostics)
+
+
+def generate_admin_ai_response(
+    message: str,
+    user,
+    page_context: Optional[Dict] = None,
+    session_id: Optional[str] = None,
+    language_code: str = "ru",
+) -> Dict[str, Optional[str]]:
+    page_context = page_context or {}
+    db_context = _build_db_context(message, page_context)
+    rag_context = build_rag_snippets(message, top_k=getattr(settings, "AI_RAG_TOP_K", 4))
+    ui_guidance = _build_ui_guidance(message, page_context)
+    diagnostics = _run_diagnostics(page_context) if _wants_diagnostics(message) else ""
+    price_context = ""
+    if _wants_price(message):
+        model_name = (page_context.get("model_name") or "").lower()
+        object_id = page_context.get("object_id")
+        if model_name == "car" and object_id and str(object_id).isdigit():
+            car = Car.objects.filter(pk=object_id).first()
+            if car:
+                price_context = _build_price_context(car)
+
+    system_prompt = (
+        "–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ Logist2. "
+        "–¢—ã –∑–Ω–∞–µ—à—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ –∞–¥–º–∏–Ω–∫–∏. "
+        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —É—Ç–æ—á–Ω–∏. "
+        "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –∞–¥–º–∏–Ω–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã. "
+        "–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ ‚Äî –¥–∞–π —Ç–æ—á–Ω—ã–µ —à–∞–≥–∏."
+    )
+
+    language_map = {"ru": "–†—É—Å—Å–∫–∏–π", "en": "English", "lt": "Lietuvi≈≥"}
+    language_name = language_map.get(language_code, "–†—É—Å—Å–∫–∏–π")
+
+    messages = [
+        {"role": "system", "content": system_prompt},
+        {"role": "system", "content": f"–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: {language_name}."},
+    ]
+    if page_context:
+        messages.append({"role": "system", "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {page_context}"})
+    if db_context:
+        messages.append({"role": "system", "content": f"–î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î: {db_context}"})
+    if ui_guidance:
+        messages.append({"role": "system", "content": f"–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π: {ui_guidance}"})
+    if diagnostics:
+        messages.append({"role": "system", "content": f"–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: {diagnostics}"})
+    if price_context:
+        messages.append({"role": "system", "content": f"–¶–µ–Ω–∞ –ø–æ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –∞–≤—Ç–æ: {price_context}"})
+    if rag_context:
+        messages.append({"role": "system", "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞:\n{rag_context}"})
+    messages.append({"role": "user", "content": message})
+
+    try:
+        response_text = _call_ai_api(messages)
+        return {"response": response_text, "used_fallback": False, "fallback_reason": None}
+    except AIServiceError as exc:
+        logger.warning("Admin AI failed: %s", exc)
+        fallback = ui_guidance or "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –£—Ç–æ—á–Ω–∏—Ç–µ VIN, –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
+        return {"response": fallback, "used_fallback": True, "fallback_reason": str(exc)}
+    except Exception as exc:
+        logger.warning("Admin AI failed: %s", exc)
+        fallback = ui_guidance or "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –£—Ç–æ—á–Ω–∏—Ç–µ VIN, –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
+        return {"response": fallback, "used_fallback": True, "fallback_reason": "unknown_error"}
diff --git a/core/services/ai_chat_service.py b/core/services/ai_chat_service.py
index 696cafe..6557530 100644
--- a/core/services/ai_chat_service.py
+++ b/core/services/ai_chat_service.py
@@ -1,302 +1,302 @@
-import logging
-import re
-from typing import List, Optional
-
-import requests
-from django.conf import settings
-
-from core.models import Car, Container
-from core.models_website import AIChat, CarPhoto, ContainerPhoto
-
-logger = logging.getLogger(__name__)
-
-
-class AIServiceError(Exception):
-    pass
-
-
-def _get_recent_messages(session_id: Optional[str], user) -> List[dict]:
-    if not session_id:
-        return []
-
-    chats = AIChat.objects.filter(session_id=session_id)
-    if user:
-        chats = chats.filter(user=user)
-
-    chats = chats.order_by("-created_at")[:6]
-    messages = []
-    for chat in reversed(list(chats)):
-        messages.append({"role": "user", "content": chat.message})
-        messages.append({"role": "assistant", "content": chat.response})
-    return messages
-
-
-def _build_company_context() -> str:
-    return (
-        "–í—ã ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Caromoto Lithuania. "
-        "–ö–æ–º–ø–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ –°–®–ê, "
-        "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö, —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∏ —Å–∫–ª–∞–¥—Å–∫–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏. "
-        "–û—Ç–≤–µ—á–∞–π—Ç–µ –≤–µ–∂–ª–∏–≤–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. "
-        "–ù–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ü–µ–Ω—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã, –∏–Ω–≤–æ–π—Å—ã –∏–ª–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥. "
-        "–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø—Ä–∞–≤—å—Ç–µ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É. "
-        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–≤–µ—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. "
-        "–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —É—Ç–æ—á–Ω–∏—Ç–µ —É –∫–ª–∏–µ–Ω—Ç–∞ VIN –∏–ª–∏ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞."
-    )
-
-
-def _build_client_context(client) -> str:
-    if not client:
-        return ""
-
-    cars = (
-        Car.objects.filter(client=client)
-        .select_related("container", "warehouse")
-        .order_by("-id")[:5]
-    )
-    containers = (
-        Container.objects.filter(client=client)
-        .select_related("line", "warehouse")
-        .order_by("-id")[:5]
-    )
-
-    cars_info = []
-    for car in cars:
-        cars_info.append(
-            f"VIN: {car.vin}, —Å—Ç–∞—Ç—É—Å: {car.get_status_display()}, "
-            f"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: {car.container.number if car.container else '‚Äî'}"
-        )
-
-    containers_info = []
-    for container in containers:
-        containers_info.append(
-            f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: {container.number}, —Å—Ç–∞—Ç—É—Å: {container.get_status_display()}, "
-            f"ETA: {container.eta or '‚Äî'}, –≤—ã–≥—Ä—É–∑–∫–∞: {container.unload_date or '‚Äî'}"
-        )
-
-    return (
-        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ: {client.name}. "
-        f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏: {', '.join(cars_info) if cars_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}. "
-        f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: {', '.join(containers_info) if containers_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}."
-    )
-
-
-def _build_system_prompt(language_code: str) -> str:
-    language_map = {
-        "ru": "–†—É—Å—Å–∫–∏–π",
-        "en": "English",
-        "lt": "Lietuvi≈≥",
-    }
-    language_name = language_map.get(language_code, "–†—É—Å—Å–∫–∏–π")
-    return (
-        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. "
-        "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. "
-        f"–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: {language_name}."
-    )
-
-
-def _find_identifiers(message: str) -> dict:
-    vin_pattern = re.compile(r"\b[A-HJ-NPR-Z0-9]{17}\b", re.IGNORECASE)
-    container_pattern = re.compile(r"\b[A-Z]{4}\d{7}\b", re.IGNORECASE)
-
-    vins = list({m.group(0).upper() for m in vin_pattern.finditer(message or "")})
-    containers = list({m.group(0).upper() for m in container_pattern.finditer(message or "")})
-    return {"vins": vins, "containers": containers}
-
-
-def _build_tracking_context(message: str, user=None, client=None) -> str:
-    identifiers = _find_identifiers(message)
-    vins = identifiers["vins"]
-    containers = identifiers["containers"]
-    if not vins and not containers:
-        return ""
-
-    is_staff = bool(user and (getattr(user, "is_staff", False) or getattr(user, "is_superuser", False)))
-
-    parts = []
-
-    for vin in vins:
-        car_qs = Car.objects.select_related("container", "warehouse").filter(vin__iexact=vin)
-        if client:
-            car_qs = car_qs.filter(client=client)
-        car = car_qs.first()
-
-        if not car:
-            parts.append(f"–ü–æ VIN {vin} –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
-            continue
-
-        unload_date = car.unload_date or (car.container.unload_date if car.container else None)
-        transfer_date = car.transfer_date
-        events = []
-        if unload_date:
-            events.append(f"–†–∞–∑–≥—Ä—É–∂–µ–Ω: {unload_date}")
-        if transfer_date:
-            events.append(f"–ü–µ—Ä–µ–¥–∞–Ω: {transfer_date}")
-        history_text = "; ".join(events) if events else "–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: –Ω–µ—Ç –¥–∞—Ç."
-
-        photos_qs = CarPhoto.objects.filter(car=car)
-        if not is_staff:
-            photos_qs = photos_qs.filter(is_public=True)
-        photos_count = photos_qs.count()
-        last_photo = photos_qs.order_by("-uploaded_at").first()
-        if last_photo:
-            photos_text = (
-                f"–§–æ—Ç–æ –∞–≤—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: "
-                f"{last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}"
-            )
-        else:
-            container_photos_text = ""
-            if car.container:
-                container_photos = ContainerPhoto.objects.filter(container=car.container)
-                if not is_staff:
-                    container_photos = container_photos.filter(is_public=True)
-                container_count = container_photos.count()
-                last_container_photo = container_photos.order_by("-uploaded_at").first()
-                if container_count:
-                    if last_container_photo:
-                        container_photos_text = (
-                            f"–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: "
-                            f"{last_container_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}"
-                        )
-                    else:
-                        container_photos_text = f"–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç."
-            photos_text = "–§–æ—Ç–æ –∞–≤—Ç–æ: 0 —à—Ç." + (f" {container_photos_text}" if container_photos_text else "")
-
-        parts.append(
-            "–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ VIN {vin}: {status}. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: {container}. "
-            "ETA: {eta}. –î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: {unload}. –°–∫–ª–∞–¥: {warehouse}. {history} {photos}".format(
-                vin=vin,
-                status=car.get_status_display(),
-                container=car.container.number if car.container else "‚Äî",
-                eta=car.container.eta if car.container and car.container.eta else "‚Äî",
-                unload=unload_date or "‚Äî",
-                warehouse=car.warehouse.name if car.warehouse else "‚Äî",
-                history=history_text,
-                photos=photos_text,
-            )
-        )
-
-    for number in containers:
-        container_qs = Container.objects.select_related("warehouse").filter(number__iexact=number)
-        if client:
-            container_qs = container_qs.filter(client=client)
-        container = container_qs.first()
-
-        if not container:
-            parts.append(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {number} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
-            continue
-
-        events = []
-        if container.planned_unload_date:
-            events.append(f"–ü–ª–∞–Ω —Ä–∞–∑–≥—Ä—É–∑–∫–∏: {container.planned_unload_date}")
-        if container.unload_date:
-            events.append(f"–†–∞–∑–≥—Ä—É–∂–µ–Ω: {container.unload_date}")
-        if container.unloaded_status_at:
-            events.append(f"–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å: {container.unloaded_status_at}")
-        transfer_date = None
-        if container.status == "TRANSFERRED":
-            transfer_date = (
-                Car.objects.filter(container=container, transfer_date__isnull=False)
-                .order_by("-transfer_date")
-                .values_list("transfer_date", flat=True)
-                .first()
-            )
-            if transfer_date:
-                events.append(f"–ü–µ—Ä–µ–¥–∞–Ω: {transfer_date}")
-            else:
-                events.append("–ü–µ—Ä–µ–¥–∞–Ω: –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞")
-        history_text = "; ".join(events) if events else "–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: –Ω–µ—Ç –¥–∞—Ç."
-
-        photos_qs = ContainerPhoto.objects.filter(container=container)
-        if not is_staff:
-            photos_qs = photos_qs.filter(is_public=True)
-        photos_count = photos_qs.count()
-        last_photo = photos_qs.order_by("-uploaded_at").first()
-        photos_text = (
-            f"–§–æ—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: {last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}"
-            if last_photo else f"–§–æ—Ç–æ: {photos_count} —à—Ç."
-        )
-
-        parts.append(
-            "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ {number}: {status}. ETA: {eta}. –î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: {unload}. "
-            "–°–∫–ª–∞–¥: {warehouse}. {history} {photos}".format(
-                number=number,
-                status=container.get_status_display(),
-                eta=container.eta or "‚Äî",
-                unload=container.unload_date or "‚Äî",
-                warehouse=container.warehouse.name if container.warehouse else "‚Äî",
-                history=history_text,
-                photos=photos_text,
-            )
-        )
-
-    return " ".join(parts)
-
-
-def _call_ai_api(messages: List[dict]) -> str:
-    if not settings.AI_CHAT_ENABLED:
-        raise AIServiceError("AI chat is disabled")
-
-    api_key = settings.AI_API_KEY
-    if not api_key:
-        raise AIServiceError("AI API key is missing")
-
-    base_url = settings.AI_API_BASE_URL.rstrip("/")
-    url = f"{base_url}/chat/completions"
-
-    payload = {
-        "model": settings.AI_MODEL,
-        "messages": messages,
-        "temperature": settings.AI_TEMPERATURE,
-        "max_tokens": settings.AI_MAX_TOKENS,
-    }
-
-    try:
-        session = requests.Session()
-        session.trust_env = False
-        response = session.post(
-            url,
-            headers={
-                "Authorization": f"Bearer {api_key}",
-                "Content-Type": "application/json",
-            },
-            json=payload,
-            timeout=settings.AI_REQUEST_TIMEOUT,
-        )
-    except requests.RequestException as exc:
-        logger.exception("AI API request failed")
-        raise AIServiceError(f"AI API request failed: {exc.__class__.__name__}: {exc}") from exc
-
-    if not response.ok:
-        error_text = response.text[:500] if response.text else ""
-        logger.error("AI API error: %s - %s", response.status_code, error_text)
-        raise AIServiceError(f"AI API returned error ({response.status_code}): {error_text}")
-
-    data = response.json()
-    try:
-        return data["choices"][0]["message"]["content"].strip()
-    except (KeyError, IndexError, TypeError) as exc:
-        logger.error("AI API response parsing error: %s", data)
-        raise AIServiceError("AI API response parsing error") from exc
-
-
-def generate_ai_response(message: str, user=None, client=None, session_id: Optional[str] = None,
-                         language_code: str = "ru") -> str:
-    system_prompt = _build_system_prompt(language_code)
-    company_context = _build_company_context()
-    client_context = _build_client_context(client)
-    tracking_context = _build_tracking_context(message, user=user, client=client)
-    history_messages = _get_recent_messages(session_id, user)
-
-    messages = [
-        {"role": "system", "content": system_prompt},
-        {"role": "system", "content": company_context},
-    ]
-    if client_context:
-        messages.append({"role": "system", "content": client_context})
-    if tracking_context:
-        messages.append({"role": "system", "content": tracking_context})
-
-    messages.extend(history_messages)
-    messages.append({"role": "user", "content": message})
-
-    return _call_ai_api(messages)
+import logging
+import re
+from typing import List, Optional
+
+import requests
+from django.conf import settings
+
+from core.models import Car, Container
+from core.models_website import AIChat, CarPhoto, ContainerPhoto
+
+logger = logging.getLogger(__name__)
+
+
+class AIServiceError(Exception):
+    pass
+
+
+def _get_recent_messages(session_id: Optional[str], user) -> List[dict]:
+    if not session_id:
+        return []
+
+    chats = AIChat.objects.filter(session_id=session_id)
+    if user:
+        chats = chats.filter(user=user)
+
+    chats = chats.order_by("-created_at")[:6]
+    messages = []
+    for chat in reversed(list(chats)):
+        messages.append({"role": "user", "content": chat.message})
+        messages.append({"role": "assistant", "content": chat.response})
+    return messages
+
+
+def _build_company_context() -> str:
+    return (
+        "–í—ã ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Caromoto Lithuania. "
+        "–ö–æ–º–ø–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ –°–®–ê, "
+        "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö, —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∏ —Å–∫–ª–∞–¥—Å–∫–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏. "
+        "–û—Ç–≤–µ—á–∞–π—Ç–µ –≤–µ–∂–ª–∏–≤–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. "
+        "–ù–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ü–µ–Ω—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å—ã, –∏–Ω–≤–æ–π—Å—ã –∏–ª–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥. "
+        "–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø—Ä–∞–≤—å—Ç–µ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É. "
+        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–≤–µ—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. "
+        "–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —É—Ç–æ—á–Ω–∏—Ç–µ —É –∫–ª–∏–µ–Ω—Ç–∞ VIN –∏–ª–∏ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞."
+    )
+
+
+def _build_client_context(client) -> str:
+    if not client:
+        return ""
+
+    cars = (
+        Car.objects.filter(client=client)
+        .select_related("container", "warehouse")
+        .order_by("-id")[:5]
+    )
+    containers = (
+        Container.objects.filter(client=client)
+        .select_related("line", "warehouse")
+        .order_by("-id")[:5]
+    )
+
+    cars_info = []
+    for car in cars:
+        cars_info.append(
+            f"VIN: {car.vin}, —Å—Ç–∞—Ç—É—Å: {car.get_status_display()}, "
+            f"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: {car.container.number if car.container else '‚Äî'}"
+        )
+
+    containers_info = []
+    for container in containers:
+        containers_info.append(
+            f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: {container.number}, —Å—Ç–∞—Ç—É—Å: {container.get_status_display()}, "
+            f"ETA: {container.eta or '‚Äî'}, –≤—ã–≥—Ä—É–∑–∫–∞: {container.unload_date or '‚Äî'}"
+        )
+
+    return (
+        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ: {client.name}. "
+        f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏: {', '.join(cars_info) if cars_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}. "
+        f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: {', '.join(containers_info) if containers_info else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}."
+    )
+
+
+def _build_system_prompt(language_code: str) -> str:
+    language_map = {
+        "ru": "–†—É—Å—Å–∫–∏–π",
+        "en": "English",
+        "lt": "Lietuvi≈≥",
+    }
+    language_name = language_map.get(language_code, "–†—É—Å—Å–∫–∏–π")
+    return (
+        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. "
+        "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. "
+        f"–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: {language_name}."
+    )
+
+
+def _find_identifiers(message: str) -> dict:
+    vin_pattern = re.compile(r"\b[A-HJ-NPR-Z0-9]{17}\b", re.IGNORECASE)
+    container_pattern = re.compile(r"\b[A-Z]{4}\d{7}\b", re.IGNORECASE)
+
+    vins = list({m.group(0).upper() for m in vin_pattern.finditer(message or "")})
+    containers = list({m.group(0).upper() for m in container_pattern.finditer(message or "")})
+    return {"vins": vins, "containers": containers}
+
+
+def _build_tracking_context(message: str, user=None, client=None) -> str:
+    identifiers = _find_identifiers(message)
+    vins = identifiers["vins"]
+    containers = identifiers["containers"]
+    if not vins and not containers:
+        return ""
+
+    is_staff = bool(user and (getattr(user, "is_staff", False) or getattr(user, "is_superuser", False)))
+
+    parts = []
+
+    for vin in vins:
+        car_qs = Car.objects.select_related("container", "warehouse").filter(vin__iexact=vin)
+        if client:
+            car_qs = car_qs.filter(client=client)
+        car = car_qs.first()
+
+        if not car:
+            parts.append(f"–ü–æ VIN {vin} –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
+            continue
+
+        unload_date = car.unload_date or (car.container.unload_date if car.container else None)
+        transfer_date = car.transfer_date
+        events = []
+        if unload_date:
+            events.append(f"–†–∞–∑–≥—Ä—É–∂–µ–Ω: {unload_date}")
+        if transfer_date:
+            events.append(f"–ü–µ—Ä–µ–¥–∞–Ω: {transfer_date}")
+        history_text = "; ".join(events) if events else "–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: –Ω–µ—Ç –¥–∞—Ç."
+
+        photos_qs = CarPhoto.objects.filter(car=car)
+        if not is_staff:
+            photos_qs = photos_qs.filter(is_public=True)
+        photos_count = photos_qs.count()
+        last_photo = photos_qs.order_by("-uploaded_at").first()
+        if last_photo:
+            photos_text = (
+                f"–§–æ—Ç–æ –∞–≤—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: "
+                f"{last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}"
+            )
+        else:
+            container_photos_text = ""
+            if car.container:
+                container_photos = ContainerPhoto.objects.filter(container=car.container)
+                if not is_staff:
+                    container_photos = container_photos.filter(is_public=True)
+                container_count = container_photos.count()
+                last_container_photo = container_photos.order_by("-uploaded_at").first()
+                if container_count:
+                    if last_container_photo:
+                        container_photos_text = (
+                            f"–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: "
+                            f"{last_container_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}"
+                        )
+                    else:
+                        container_photos_text = f"–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {container_count} —à—Ç."
+            photos_text = "–§–æ—Ç–æ –∞–≤—Ç–æ: 0 —à—Ç." + (f" {container_photos_text}" if container_photos_text else "")
+
+        parts.append(
+            "–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ VIN {vin}: {status}. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: {container}. "
+            "ETA: {eta}. –î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: {unload}. –°–∫–ª–∞–¥: {warehouse}. {history} {photos}".format(
+                vin=vin,
+                status=car.get_status_display(),
+                container=car.container.number if car.container else "‚Äî",
+                eta=car.container.eta if car.container and car.container.eta else "‚Äî",
+                unload=unload_date or "‚Äî",
+                warehouse=car.warehouse.name if car.warehouse else "‚Äî",
+                history=history_text,
+                photos=photos_text,
+            )
+        )
+
+    for number in containers:
+        container_qs = Container.objects.select_related("warehouse").filter(number__iexact=number)
+        if client:
+            container_qs = container_qs.filter(client=client)
+        container = container_qs.first()
+
+        if not container:
+            parts.append(f"–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {number} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
+            continue
+
+        events = []
+        if container.planned_unload_date:
+            events.append(f"–ü–ª–∞–Ω —Ä–∞–∑–≥—Ä—É–∑–∫–∏: {container.planned_unload_date}")
+        if container.unload_date:
+            events.append(f"–†–∞–∑–≥—Ä—É–∂–µ–Ω: {container.unload_date}")
+        if container.unloaded_status_at:
+            events.append(f"–°—Ç–∞—Ç—É—Å '–†–∞–∑–≥—Ä—É–∂–µ–Ω' —Å: {container.unloaded_status_at}")
+        transfer_date = None
+        if container.status == "TRANSFERRED":
+            transfer_date = (
+                Car.objects.filter(container=container, transfer_date__isnull=False)
+                .order_by("-transfer_date")
+                .values_list("transfer_date", flat=True)
+                .first()
+            )
+            if transfer_date:
+                events.append(f"–ü–µ—Ä–µ–¥–∞–Ω: {transfer_date}")
+            else:
+                events.append("–ü–µ—Ä–µ–¥–∞–Ω: –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞")
+        history_text = "; ".join(events) if events else "–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: –Ω–µ—Ç –¥–∞—Ç."
+
+        photos_qs = ContainerPhoto.objects.filter(container=container)
+        if not is_staff:
+            photos_qs = photos_qs.filter(is_public=True)
+        photos_count = photos_qs.count()
+        last_photo = photos_qs.order_by("-uploaded_at").first()
+        photos_text = (
+            f"–§–æ—Ç–æ: {photos_count} —à—Ç., –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: {last_photo.uploaded_at.strftime('%Y-%m-%d %H:%M')}"
+            if last_photo else f"–§–æ—Ç–æ: {photos_count} —à—Ç."
+        )
+
+        parts.append(
+            "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ {number}: {status}. ETA: {eta}. –î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: {unload}. "
+            "–°–∫–ª–∞–¥: {warehouse}. {history} {photos}".format(
+                number=number,
+                status=container.get_status_display(),
+                eta=container.eta or "‚Äî",
+                unload=container.unload_date or "‚Äî",
+                warehouse=container.warehouse.name if container.warehouse else "‚Äî",
+                history=history_text,
+                photos=photos_text,
+            )
+        )
+
+    return " ".join(parts)
+
+
+def _call_ai_api(messages: List[dict]) -> str:
+    if not settings.AI_CHAT_ENABLED:
+        raise AIServiceError("AI chat is disabled")
+
+    api_key = settings.AI_API_KEY
+    if not api_key:
+        raise AIServiceError("AI API key is missing")
+
+    base_url = settings.AI_API_BASE_URL.rstrip("/")
+    url = f"{base_url}/chat/completions"
+
+    payload = {
+        "model": settings.AI_MODEL,
+        "messages": messages,
+        "temperature": settings.AI_TEMPERATURE,
+        "max_tokens": settings.AI_MAX_TOKENS,
+    }
+
+    try:
+        session = requests.Session()
+        session.trust_env = False
+        response = session.post(
+            url,
+            headers={
+                "Authorization": f"Bearer {api_key}",
+                "Content-Type": "application/json",
+            },
+            json=payload,
+            timeout=settings.AI_REQUEST_TIMEOUT,
+        )
+    except requests.RequestException as exc:
+        logger.exception("AI API request failed")
+        raise AIServiceError(f"AI API request failed: {exc.__class__.__name__}: {exc}") from exc
+
+    if not response.ok:
+        error_text = response.text[:500] if response.text else ""
+        logger.error("AI API error: %s - %s", response.status_code, error_text)
+        raise AIServiceError(f"AI API returned error ({response.status_code}): {error_text}")
+
+    data = response.json()
+    try:
+        return data["choices"][0]["message"]["content"].strip()
+    except (KeyError, IndexError, TypeError) as exc:
+        logger.error("AI API response parsing error: %s", data)
+        raise AIServiceError("AI API response parsing error") from exc
+
+
+def generate_ai_response(message: str, user=None, client=None, session_id: Optional[str] = None,
+                         language_code: str = "ru") -> str:
+    system_prompt = _build_system_prompt(language_code)
+    company_context = _build_company_context()
+    client_context = _build_client_context(client)
+    tracking_context = _build_tracking_context(message, user=user, client=client)
+    history_messages = _get_recent_messages(session_id, user)
+
+    messages = [
+        {"role": "system", "content": system_prompt},
+        {"role": "system", "content": company_context},
+    ]
+    if client_context:
+        messages.append({"role": "system", "content": client_context})
+    if tracking_context:
+        messages.append({"role": "system", "content": tracking_context})
+
+    messages.extend(history_messages)
+    messages.append({"role": "user", "content": message})
+
+    return _call_ai_api(messages)
diff --git a/core/services/ai_rag.py b/core/services/ai_rag.py
index 3d347f5..b666fc5 100644
--- a/core/services/ai_rag.py
+++ b/core/services/ai_rag.py
@@ -1,225 +1,225 @@
-import json
-import logging
-import os
-import re
-import time
-from typing import Dict, List, Optional
-
-import requests
-from django.conf import settings
-
-logger = logging.getLogger(__name__)
-
-
-def _get_index_path() -> str:
-    return getattr(
-        settings,
-        "AI_RAG_INDEX_PATH",
-        os.path.join(settings.BASE_DIR, "core", "ai_rag_index.json"),
-    )
-
-
-def _normalize_text(text: str) -> str:
-    return re.sub(r"\s+", " ", text or "").strip()
-
-
-def _split_into_chunks(text: str, chunk_size: int = 1200, overlap: int = 200) -> List[str]:
-    text = text or ""
-    if len(text) <= chunk_size:
-        return [text]
-    chunks = []
-    start = 0
-    while start < len(text):
-        end = min(start + chunk_size, len(text))
-        chunk = text[start:end]
-        chunks.append(chunk)
-        if end >= len(text):
-            break
-        start = max(end - overlap, 0)
-    return chunks
-
-
-def _call_embeddings_api(text: str) -> Optional[List[float]]:
-    api_key = settings.AI_API_KEY
-    if not api_key:
-        return None
-    model = getattr(settings, "AI_EMBEDDINGS_MODEL", "")
-    if not model:
-        return None
-
-    base_url = settings.AI_API_BASE_URL.rstrip("/")
-    url = f"{base_url}/embeddings"
-    payload = {"model": model, "input": text[:4000]}
-    try:
-        session = requests.Session()
-        session.trust_env = False
-        response = session.post(
-            url,
-            headers={
-                "Authorization": f"Bearer {api_key}",
-                "Content-Type": "application/json",
-            },
-            json=payload,
-            timeout=settings.AI_REQUEST_TIMEOUT,
-        )
-    except requests.RequestException:
-        logger.exception("Embeddings request failed")
-        return None
-
-    if not response.ok:
-        logger.warning("Embeddings error: %s - %s", response.status_code, response.text[:200])
-        return None
-
-    data = response.json()
-    try:
-        return data["data"][0]["embedding"]
-    except (KeyError, IndexError, TypeError):
-        logger.warning("Embeddings response parse failed: %s", data)
-        return None
-
-
-def build_rag_index(
-    source_paths: List[str],
-    output_path: Optional[str] = None,
-    use_embeddings: bool = True,
-) -> str:
-    output_path = output_path or _get_index_path()
-    chunks = []
-    model_name = getattr(settings, "AI_EMBEDDINGS_MODEL", "") if use_embeddings else ""
-
-    for path in source_paths:
-        if not os.path.exists(path) or not os.path.isfile(path):
-            continue
-        try:
-            with open(path, "r", encoding="utf-8", errors="ignore") as file_obj:
-                raw = file_obj.read()
-        except OSError:
-            logger.exception("Failed to read %s", path)
-            continue
-
-        normalized = _normalize_text(raw)
-        for chunk in _split_into_chunks(normalized):
-            embedding = _call_embeddings_api(chunk) if use_embeddings else None
-            chunks.append(
-                {
-                    "source_path": path,
-                    "content": chunk,
-                    "embedding": embedding,
-                }
-            )
-
-    index = {
-        "version": 1,
-        "model": model_name,
-        "created_at": int(time.time()),
-        "chunks": chunks,
-    }
-
-    os.makedirs(os.path.dirname(output_path), exist_ok=True)
-    with open(output_path, "w", encoding="utf-8") as file_obj:
-        json.dump(index, file_obj, ensure_ascii=False)
-
-    return output_path
-
-
-def _cosine_similarity(a: List[float], b: List[float]) -> float:
-    if not a or not b or len(a) != len(b):
-        return 0.0
-    dot = sum(x * y for x, y in zip(a, b))
-    norm_a = sum(x * x for x in a) ** 0.5
-    norm_b = sum(y * y for y in b) ** 0.5
-    if norm_a == 0 or norm_b == 0:
-        return 0.0
-    return dot / (norm_a * norm_b)
-
-
-def _keyword_score(query: str, text: str) -> float:
-    terms = [t for t in re.split(r"[^\w]+", query.lower()) if len(t) > 2]
-    if not terms:
-        return 0.0
-    text_lower = text.lower()
-    return sum(1 for term in terms if term in text_lower) / len(terms)
-
-
-def query_rag_context(query: str, top_k: int = 4) -> List[Dict]:
-    index_path = _get_index_path()
-    if not os.path.exists(index_path):
-        return []
-    try:
-        with open(index_path, "r", encoding="utf-8") as file_obj:
-            index = json.load(file_obj)
-    except OSError:
-        logger.exception("Failed to read RAG index")
-        return []
-
-    chunks = index.get("chunks", [])
-    if not chunks:
-        return []
-
-    query_embedding = _call_embeddings_api(query) if index.get("model") else None
-    scored = []
-    for chunk in chunks:
-        content = chunk.get("content", "")
-        embedding = chunk.get("embedding")
-        if query_embedding and embedding:
-            score = _cosine_similarity(query_embedding, embedding)
-        else:
-            score = _keyword_score(query, content)
-        if score > 0:
-            scored.append({**chunk, "score": score})
-
-    scored.sort(key=lambda item: item.get("score", 0), reverse=True)
-    return scored[:top_k]
-
-
-def build_rag_snippets(query: str, top_k: int = 4) -> str:
-    results = query_rag_context(query, top_k=top_k)
-    if not results:
-        return ""
-    parts = []
-    for item in results:
-        path = item.get("source_path", "unknown")
-        content = item.get("content", "")
-        parts.append(f"–ò—Å—Ç–æ—á–Ω–∏–∫: {path}\n–§—Ä–∞–≥–º–µ–Ω—Ç: {content}")
-    return "\n\n".join(parts)
-
-
-def get_default_rag_sources() -> List[str]:
-    base_dir = settings.BASE_DIR
-    return [
-        os.path.join(base_dir, "LOGIST2_PROGRESS_REPORT.md"),
-        os.path.join(base_dir, "AI_PROJECT_CONTEXT.md"),
-        os.path.join(base_dir, "PROMT_LOGIST2.md"),
-        os.path.join(base_dir, "core", "models.py"),
-        os.path.join(base_dir, "core", "admin.py"),
-        os.path.join(base_dir, "core", "signals.py"),
-        os.path.join(base_dir, "core", "views.py"),
-        os.path.join(base_dir, "core", "models_billing.py"),
-        os.path.join(base_dir, "core", "services", "ai_chat_service.py"),
-    ]
-
-
-def _get_mtime(path: str) -> Optional[float]:
-    try:
-        return os.path.getmtime(path)
-    except OSError:
-        return None
-
-
-def is_rag_index_stale(source_paths: List[str], max_age_seconds: Optional[int] = None) -> Dict[str, str]:
-    index_path = _get_index_path()
-    index_mtime = _get_mtime(index_path)
-    if not index_mtime:
-        return {"stale": "true", "reason": "index_missing"}
-
-    for path in source_paths:
-        source_mtime = _get_mtime(path)
-        if source_mtime and source_mtime > index_mtime:
-            return {"stale": "true", "reason": f"source_updated:{path}"}
-
-    if max_age_seconds:
-        age = time.time() - index_mtime
-        if age > max_age_seconds:
-            return {"stale": "true", "reason": f"older_than:{max_age_seconds}s"}
-
-    return {"stale": "false", "reason": "fresh"}
+import json
+import logging
+import os
+import re
+import time
+from typing import Dict, List, Optional
+
+import requests
+from django.conf import settings
+
+logger = logging.getLogger(__name__)
+
+
+def _get_index_path() -> str:
+    return getattr(
+        settings,
+        "AI_RAG_INDEX_PATH",
+        os.path.join(settings.BASE_DIR, "core", "ai_rag_index.json"),
+    )
+
+
+def _normalize_text(text: str) -> str:
+    return re.sub(r"\s+", " ", text or "").strip()
+
+
+def _split_into_chunks(text: str, chunk_size: int = 1200, overlap: int = 200) -> List[str]:
+    text = text or ""
+    if len(text) <= chunk_size:
+        return [text]
+    chunks = []
+    start = 0
+    while start < len(text):
+        end = min(start + chunk_size, len(text))
+        chunk = text[start:end]
+        chunks.append(chunk)
+        if end >= len(text):
+            break
+        start = max(end - overlap, 0)
+    return chunks
+
+
+def _call_embeddings_api(text: str) -> Optional[List[float]]:
+    api_key = settings.AI_API_KEY
+    if not api_key:
+        return None
+    model = getattr(settings, "AI_EMBEDDINGS_MODEL", "")
+    if not model:
+        return None
+
+    base_url = settings.AI_API_BASE_URL.rstrip("/")
+    url = f"{base_url}/embeddings"
+    payload = {"model": model, "input": text[:4000]}
+    try:
+        session = requests.Session()
+        session.trust_env = False
+        response = session.post(
+            url,
+            headers={
+                "Authorization": f"Bearer {api_key}",
+                "Content-Type": "application/json",
+            },
+            json=payload,
+            timeout=settings.AI_REQUEST_TIMEOUT,
+        )
+    except requests.RequestException:
+        logger.exception("Embeddings request failed")
+        return None
+
+    if not response.ok:
+        logger.warning("Embeddings error: %s - %s", response.status_code, response.text[:200])
+        return None
+
+    data = response.json()
+    try:
+        return data["data"][0]["embedding"]
+    except (KeyError, IndexError, TypeError):
+        logger.warning("Embeddings response parse failed: %s", data)
+        return None
+
+
+def build_rag_index(
+    source_paths: List[str],
+    output_path: Optional[str] = None,
+    use_embeddings: bool = True,
+) -> str:
+    output_path = output_path or _get_index_path()
+    chunks = []
+    model_name = getattr(settings, "AI_EMBEDDINGS_MODEL", "") if use_embeddings else ""
+
+    for path in source_paths:
+        if not os.path.exists(path) or not os.path.isfile(path):
+            continue
+        try:
+            with open(path, "r", encoding="utf-8", errors="ignore") as file_obj:
+                raw = file_obj.read()
+        except OSError:
+            logger.exception("Failed to read %s", path)
+            continue
+
+        normalized = _normalize_text(raw)
+        for chunk in _split_into_chunks(normalized):
+            embedding = _call_embeddings_api(chunk) if use_embeddings else None
+            chunks.append(
+                {
+                    "source_path": path,
+                    "content": chunk,
+                    "embedding": embedding,
+                }
+            )
+
+    index = {
+        "version": 1,
+        "model": model_name,
+        "created_at": int(time.time()),
+        "chunks": chunks,
+    }
+
+    os.makedirs(os.path.dirname(output_path), exist_ok=True)
+    with open(output_path, "w", encoding="utf-8") as file_obj:
+        json.dump(index, file_obj, ensure_ascii=False)
+
+    return output_path
+
+
+def _cosine_similarity(a: List[float], b: List[float]) -> float:
+    if not a or not b or len(a) != len(b):
+        return 0.0
+    dot = sum(x * y for x, y in zip(a, b))
+    norm_a = sum(x * x for x in a) ** 0.5
+    norm_b = sum(y * y for y in b) ** 0.5
+    if norm_a == 0 or norm_b == 0:
+        return 0.0
+    return dot / (norm_a * norm_b)
+
+
+def _keyword_score(query: str, text: str) -> float:
+    terms = [t for t in re.split(r"[^\w]+", query.lower()) if len(t) > 2]
+    if not terms:
+        return 0.0
+    text_lower = text.lower()
+    return sum(1 for term in terms if term in text_lower) / len(terms)
+
+
+def query_rag_context(query: str, top_k: int = 4) -> List[Dict]:
+    index_path = _get_index_path()
+    if not os.path.exists(index_path):
+        return []
+    try:
+        with open(index_path, "r", encoding="utf-8") as file_obj:
+            index = json.load(file_obj)
+    except OSError:
+        logger.exception("Failed to read RAG index")
+        return []
+
+    chunks = index.get("chunks", [])
+    if not chunks:
+        return []
+
+    query_embedding = _call_embeddings_api(query) if index.get("model") else None
+    scored = []
+    for chunk in chunks:
+        content = chunk.get("content", "")
+        embedding = chunk.get("embedding")
+        if query_embedding and embedding:
+            score = _cosine_similarity(query_embedding, embedding)
+        else:
+            score = _keyword_score(query, content)
+        if score > 0:
+            scored.append({**chunk, "score": score})
+
+    scored.sort(key=lambda item: item.get("score", 0), reverse=True)
+    return scored[:top_k]
+
+
+def build_rag_snippets(query: str, top_k: int = 4) -> str:
+    results = query_rag_context(query, top_k=top_k)
+    if not results:
+        return ""
+    parts = []
+    for item in results:
+        path = item.get("source_path", "unknown")
+        content = item.get("content", "")
+        parts.append(f"–ò—Å—Ç–æ—á–Ω–∏–∫: {path}\n–§—Ä–∞–≥–º–µ–Ω—Ç: {content}")
+    return "\n\n".join(parts)
+
+
+def get_default_rag_sources() -> List[str]:
+    base_dir = settings.BASE_DIR
+    return [
+        os.path.join(base_dir, "LOGIST2_PROGRESS_REPORT.md"),
+        os.path.join(base_dir, "AI_PROJECT_CONTEXT.md"),
+        os.path.join(base_dir, "PROMT_LOGIST2.md"),
+        os.path.join(base_dir, "core", "models.py"),
+        os.path.join(base_dir, "core", "admin.py"),
+        os.path.join(base_dir, "core", "signals.py"),
+        os.path.join(base_dir, "core", "views.py"),
+        os.path.join(base_dir, "core", "models_billing.py"),
+        os.path.join(base_dir, "core", "services", "ai_chat_service.py"),
+    ]
+
+
+def _get_mtime(path: str) -> Optional[float]:
+    try:
+        return os.path.getmtime(path)
+    except OSError:
+        return None
+
+
+def is_rag_index_stale(source_paths: List[str], max_age_seconds: Optional[int] = None) -> Dict[str, str]:
+    index_path = _get_index_path()
+    index_mtime = _get_mtime(index_path)
+    if not index_mtime:
+        return {"stale": "true", "reason": "index_missing"}
+
+    for path in source_paths:
+        source_mtime = _get_mtime(path)
+        if source_mtime and source_mtime > index_mtime:
+            return {"stale": "true", "reason": f"source_updated:{path}"}
+
+    if max_age_seconds:
+        age = time.time() - index_mtime
+        if age > max_age_seconds:
+            return {"stale": "true", "reason": f"older_than:{max_age_seconds}s"}
+
+    return {"stale": "false", "reason": "fresh"}
diff --git a/core/signals.py b/core/signals.py
index 5426151..09b6132 100644
--- a/core/signals.py
+++ b/core/signals.py
@@ -1,4 +1,4 @@
-from django.db.models.signals import post_save, post_delete, pre_delete, pre_save
+from django.db.models.signals import post_save, post_delete, pre_delete, pre_save, m2m_changed
 from django.dispatch import receiver
 from .models import Car, Container, WarehouseService, LineService, CarrierService, Company, CompanyService, CarService, DeletedCarService, LineTHSCoefficient
 from .models_billing import NewInvoice
@@ -968,4 +968,65 @@ def auto_sync_photos_on_container_change(sender, instance, created, **kwargs):
         logger.info(
             f"üì∏ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä {instance.number}: —Å—Ç–∞—Ç—É—Å UNLOADED. "
             "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ –∫—Ä–æ–Ω—É (—á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –∏ –¥–∞–ª–µ–µ –∫–∞–∂–¥—ã–π —á–∞—Å)."
-        )
\ No newline at end of file
+        )
+
+
+# ==============================================================================
+# üöõ –°–ò–ì–ù–ê–õ–´ –î–õ–Ø –ê–í–¢–û–í–û–ó–û–í
+# ==============================================================================
+
+@receiver(post_save, sender='core.AutoTransport')
+def autotransport_post_save(sender, instance, created, **kwargs):
+    """
+    –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–≤—Ç–æ–≤–æ–∑–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º FORMED —Å–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å—ã
+    """
+    if instance.status == 'FORMED':
+        try:
+            # –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
+            invoices = instance.generate_invoices()
+            if invoices:
+                logger.info(f"üöõ –ê–≤—Ç–æ–≤–æ–∑ {instance.number}: —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–Ω–≤–æ–π—Å–æ–≤: {len(invoices)}")
+        except Exception as e:
+            logger.error(f"üöõ –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–∞ {instance.number}: {e}")
+
+
+# –°–∏–≥–Ω–∞–ª –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∞–≤—Ç–æ–≤–æ–∑–µ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π
+def autotransport_cars_changed_handler(sender, instance, action, **kwargs):
+    """
+    –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∞–≤—Ç–æ–≤–æ–∑–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å—ã
+    """
+    if action in ['post_add', 'post_remove', 'post_clear']:
+        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ–≤–æ–∑ —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω
+        if instance.status == 'FORMED':
+            try:
+                invoices = instance.generate_invoices()
+                if invoices:
+                    logger.info(f"üöõ –ê–≤—Ç–æ–≤–æ–∑ {instance.number}: –∏–Ω–≤–æ–π—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ")
+            except Exception as e:
+                logger.error(f"üöõ –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–∞ {instance.number}: {e}")
+
+
+# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π
+def connect_autotransport_signals():
+    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤"""
+    try:
+        from .models import AutoTransport
+        m2m_changed.connect(autotransport_cars_changed_handler, sender=AutoTransport.cars.through)
+        logger.info("üöõ –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã")
+    except Exception as e:
+        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤: {e}")
+
+
+# –í—ã–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
+from django.apps import apps
+if apps.ready:
+    connect_autotransport_signals()
+else:
+    # –ï—Å–ª–∏ –º–æ–¥–µ–ª–∏ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤—ã, –ø–æ–¥–∫–ª—é—á–∏–º –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
+    from django.db.models.signals import post_migrate
+    
+    def setup_autotransport_signals(sender, **kwargs):
+        if sender.name == 'core':
+            connect_autotransport_signals()
+    
+    post_migrate.connect(setup_autotransport_signals)
\ No newline at end of file
diff --git a/core/static/admin/css/ai-chat.css b/core/static/admin/css/ai-chat.css
index b518105..854efb5 100644
--- a/core/static/admin/css/ai-chat.css
+++ b/core/static/admin/css/ai-chat.css
@@ -1,178 +1,178 @@
-#ai-chat-widget {
-    position: fixed;
-    bottom: 20px;
-    right: 20px;
-    z-index: 1000;
-    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
-}
-
-.ai-chat-button {
-    width: 56px;
-    height: 56px;
-    border-radius: 50%;
-    background: #111;
-    color: #fff;
-    border: none;
-    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
-    cursor: pointer;
-    display: flex;
-    align-items: center;
-    justify-content: center;
-    font-weight: 700;
-    letter-spacing: 0.5px;
-    transition: transform 0.2s ease, box-shadow 0.2s ease;
-}
-
-.ai-chat-button:hover {
-    transform: scale(1.06);
-    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
-}
-
-.ai-chat-window {
-    position: fixed;
-    bottom: 90px;
-    right: 20px;
-    width: 360px;
-    height: 560px;
-    background: #fff;
-    border-radius: 12px;
-    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
-    display: flex;
-    flex-direction: column;
-    overflow: hidden;
-}
-
-.ai-chat-header {
-    background: #111;
-    color: #fff;
-    padding: 12px 14px;
-    display: flex;
-    justify-content: space-between;
-    align-items: center;
-}
-
-.ai-chat-context {
-    font-size: 11px;
-    opacity: 0.75;
-    margin-top: 4px;
-}
-
-.ai-chat-header h6 {
-    margin: 0;
-    font-size: 14px;
-    display: flex;
-    flex-direction: column;
-    gap: 2px;
-}
-
-.ai-chat-header .btn-close {
-    width: 20px;
-    height: 20px;
-    border: none;
-    background: transparent;
-    color: #fff;
-    font-size: 18px;
-    cursor: pointer;
-    line-height: 1;
-}
-
-.ai-chat-header .btn-close::before {
-    content: "√ó";
-}
-
-.ai-chat-messages {
-    flex: 1;
-    overflow-y: auto;
-    padding: 12px;
-    background: #f6f7f9;
-}
-
-.ai-chat-quick-actions {
-    display: flex;
-    flex-wrap: wrap;
-    gap: 6px;
-    padding: 8px 10px 0;
-    background: #fff;
-    border-top: 1px solid #e2e5ea;
-}
-
-.ai-chat-quick-action {
-    border: 1px solid #d7dce3;
-    background: #f7f8fa;
-    color: #111;
-    border-radius: 6px;
-    padding: 4px 8px;
-    font-size: 12px;
-    cursor: pointer;
-}
-
-.ai-chat-quick-action:hover {
-    background: #eef1f5;
-}
-
-.ai-message,
-.user-message {
-    margin-bottom: 10px;
-    display: flex;
-}
-
-.ai-message {
-    justify-content: flex-start;
-}
-
-.user-message {
-    justify-content: flex-end;
-}
-
-.message-content {
-    max-width: 80%;
-    padding: 8px 12px;
-    border-radius: 10px;
-    white-space: pre-wrap;
-    word-break: break-word;
-    font-size: 13px;
-}
-
-.ai-message .message-content {
-    background: #fff;
-    border: 1px solid #e2e5ea;
-}
-
-.user-message .message-content {
-    background: #111;
-    color: #fff;
-}
-
-.ai-chat-input {
-    display: flex;
-    gap: 8px;
-    padding: 10px;
-    border-top: 1px solid #e2e5ea;
-    background: #fff;
-}
-
-.ai-chat-input input {
-    flex: 1;
-    border: 1px solid #cbd3dc;
-    border-radius: 6px;
-    padding: 8px 10px;
-    font-size: 13px;
-}
-
-.ai-chat-input input:focus {
-    outline: none;
-    border-color: #111;
-}
-
-.ai-chat-input button {
-    border: none;
-    border-radius: 6px;
-    padding: 0 12px;
-    background: #111;
-    color: #fff;
-    cursor: pointer;
-}
-
-.ai-chat-input button:hover {
-    background: #2d2d2d;
-}
+#ai-chat-widget {
+    position: fixed;
+    bottom: 20px;
+    right: 20px;
+    z-index: 1000;
+    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
+}
+
+.ai-chat-button {
+    width: 56px;
+    height: 56px;
+    border-radius: 50%;
+    background: #111;
+    color: #fff;
+    border: none;
+    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
+    cursor: pointer;
+    display: flex;
+    align-items: center;
+    justify-content: center;
+    font-weight: 700;
+    letter-spacing: 0.5px;
+    transition: transform 0.2s ease, box-shadow 0.2s ease;
+}
+
+.ai-chat-button:hover {
+    transform: scale(1.06);
+    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
+}
+
+.ai-chat-window {
+    position: fixed;
+    bottom: 90px;
+    right: 20px;
+    width: 360px;
+    height: 560px;
+    background: #fff;
+    border-radius: 12px;
+    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
+    display: flex;
+    flex-direction: column;
+    overflow: hidden;
+}
+
+.ai-chat-header {
+    background: #111;
+    color: #fff;
+    padding: 12px 14px;
+    display: flex;
+    justify-content: space-between;
+    align-items: center;
+}
+
+.ai-chat-context {
+    font-size: 11px;
+    opacity: 0.75;
+    margin-top: 4px;
+}
+
+.ai-chat-header h6 {
+    margin: 0;
+    font-size: 14px;
+    display: flex;
+    flex-direction: column;
+    gap: 2px;
+}
+
+.ai-chat-header .btn-close {
+    width: 20px;
+    height: 20px;
+    border: none;
+    background: transparent;
+    color: #fff;
+    font-size: 18px;
+    cursor: pointer;
+    line-height: 1;
+}
+
+.ai-chat-header .btn-close::before {
+    content: "√ó";
+}
+
+.ai-chat-messages {
+    flex: 1;
+    overflow-y: auto;
+    padding: 12px;
+    background: #f6f7f9;
+}
+
+.ai-chat-quick-actions {
+    display: flex;
+    flex-wrap: wrap;
+    gap: 6px;
+    padding: 8px 10px 0;
+    background: #fff;
+    border-top: 1px solid #e2e5ea;
+}
+
+.ai-chat-quick-action {
+    border: 1px solid #d7dce3;
+    background: #f7f8fa;
+    color: #111;
+    border-radius: 6px;
+    padding: 4px 8px;
+    font-size: 12px;
+    cursor: pointer;
+}
+
+.ai-chat-quick-action:hover {
+    background: #eef1f5;
+}
+
+.ai-message,
+.user-message {
+    margin-bottom: 10px;
+    display: flex;
+}
+
+.ai-message {
+    justify-content: flex-start;
+}
+
+.user-message {
+    justify-content: flex-end;
+}
+
+.message-content {
+    max-width: 80%;
+    padding: 8px 12px;
+    border-radius: 10px;
+    white-space: pre-wrap;
+    word-break: break-word;
+    font-size: 13px;
+}
+
+.ai-message .message-content {
+    background: #fff;
+    border: 1px solid #e2e5ea;
+}
+
+.user-message .message-content {
+    background: #111;
+    color: #fff;
+}
+
+.ai-chat-input {
+    display: flex;
+    gap: 8px;
+    padding: 10px;
+    border-top: 1px solid #e2e5ea;
+    background: #fff;
+}
+
+.ai-chat-input input {
+    flex: 1;
+    border: 1px solid #cbd3dc;
+    border-radius: 6px;
+    padding: 8px 10px;
+    font-size: 13px;
+}
+
+.ai-chat-input input:focus {
+    outline: none;
+    border-color: #111;
+}
+
+.ai-chat-input button {
+    border: none;
+    border-radius: 6px;
+    padding: 0 12px;
+    background: #111;
+    color: #fff;
+    cursor: pointer;
+}
+
+.ai-chat-input button:hover {
+    background: #2d2d2d;
+}
diff --git a/core/static/css/autotransport.css b/core/static/css/autotransport.css
new file mode 100644
index 0000000..ba4edf4
--- /dev/null
+++ b/core/static/css/autotransport.css
@@ -0,0 +1,555 @@
+/* ============================================
+   üöõ –ê–í–¢–û–í–û–ó–´ - –ö–ê–°–¢–û–ú–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–°
+   ============================================ */
+
+:root {
+    --primary: #667eea;
+    --primary-dark: #5a67d8;
+    --success: #28a745;
+    --danger: #dc3545;
+    --warning: #ffc107;
+    --info: #17a2b8;
+    --gray-100: #f8f9fa;
+    --gray-200: #e9ecef;
+    --gray-300: #dee2e6;
+    --gray-600: #6c757d;
+    --gray-800: #343a40;
+    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
+    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
+}
+
+body { 
+    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); 
+    min-height: 100vh; 
+}
+
+.breadcrumbs { display: none; }
+#content { padding: 30px; max-width: 1400px; margin: 0 auto; }
+
+/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
+.autotransport-page-header {
+    display: flex;
+    justify-content: space-between;
+    align-items: center;
+    margin-bottom: 30px;
+}
+
+.autotransport-page-header h1 {
+    font-size: 28px;
+    font-weight: 700;
+    color: var(--gray-800);
+    margin: 0;
+}
+
+.back-link {
+    display: inline-flex;
+    align-items: center;
+    gap: 8px;
+    color: var(--gray-600);
+    text-decoration: none;
+    font-size: 14px;
+    padding: 8px 16px;
+    background: white;
+    border-radius: 8px;
+    box-shadow: var(--shadow);
+}
+
+.back-link:hover { color: var(--primary); }
+
+/* –°–µ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
+.autotransport-grid {
+    display: grid;
+    grid-template-columns: 1fr 350px;
+    gap: 30px;
+}
+
+/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
+.card {
+    background: white;
+    border-radius: 16px;
+    box-shadow: var(--shadow);
+    overflow: hidden;
+    margin-bottom: 25px;
+}
+
+.card-header {
+    padding: 20px 25px;
+    border-bottom: 1px solid var(--gray-200);
+    display: flex;
+    align-items: center;
+    gap: 12px;
+}
+
+.card-header h2 {
+    font-size: 18px;
+    font-weight: 600;
+    color: var(--gray-800);
+    margin: 0;
+}
+
+.card-header .icon { font-size: 24px; }
+.card-body { padding: 25px; }
+
+/* –°—Ç–∞—Ç—É—Å—ã */
+.status-badge {
+    display: inline-flex;
+    padding: 6px 14px;
+    border-radius: 20px;
+    font-size: 13px;
+    font-weight: 600;
+    margin-left: auto;
+}
+
+.status-draft { background: var(--gray-200); color: var(--gray-600); }
+.status-loading { background: #fff3cd; color: #856404; }
+.status-formed { background: #d4edda; color: #155724; }
+.status-in_transit { background: #cce5ff; color: #004085; }
+.status-delivered { background: #28a745; color: white; }
+.status-cancelled { background: #f8d7da; color: #721c24; }
+
+.cars-count-badge {
+    display: inline-flex;
+    padding: 6px 14px;
+    border-radius: 20px;
+    font-size: 13px;
+    font-weight: 600;
+    margin-left: auto;
+    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
+    color: white;
+}
+
+/* –ù–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞ */
+.autotransport-number-display {
+    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
+    color: white;
+    padding: 25px;
+    text-align: center;
+    margin: -25px -25px 25px -25px;
+}
+
+.autotransport-number-display .label {
+    font-size: 12px;
+    text-transform: uppercase;
+    letter-spacing: 1px;
+    opacity: 0.8;
+    margin-bottom: 8px;
+}
+
+.autotransport-number-display .number {
+    font-size: 28px;
+    font-weight: 700;
+    letter-spacing: 2px;
+}
+
+/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ */
+.info-grid { display: grid; gap: 12px; margin-bottom: 20px; }
+
+.info-item {
+    background: var(--gray-100);
+    padding: 15px;
+    border-radius: 10px;
+    text-align: center;
+}
+
+.info-item .label {
+    font-size: 11px;
+    text-transform: uppercase;
+    color: var(--gray-600);
+    margin-bottom: 5px;
+}
+
+.info-item .value {
+    font-size: 24px;
+    font-weight: 700;
+    color: var(--gray-800);
+}
+
+.info-row {
+    display: grid;
+    grid-template-columns: 1fr 1fr;
+    gap: 12px;
+}
+
+/* –°—Å—ã–ª–∫–∏ –Ω–∞ –∏–Ω–≤–æ–π—Å—ã */
+.invoice-link-item {
+    display: flex;
+    align-items: center;
+    gap: 10px;
+    padding: 12px 15px;
+    background: var(--gray-100);
+    border-radius: 8px;
+    margin-bottom: 10px;
+}
+
+.invoice-link-item:last-child { margin-bottom: 0; }
+
+.invoice-number {
+    font-weight: 600;
+    color: var(--gray-800);
+    font-size: 14px;
+}
+
+.invoice-client {
+    font-size: 12px;
+    color: var(--gray-600);
+}
+
+.invoice-amount {
+    margin-left: auto;
+    font-weight: 700;
+    color: var(--primary);
+}
+
+.invoice-link-btn {
+    display: inline-flex;
+    align-items: center;
+    justify-content: center;
+    width: 30px;
+    height: 30px;
+    background: var(--primary);
+    color: white;
+    border-radius: 6px;
+    text-decoration: none;
+    font-size: 16px;
+}
+
+.invoice-link-btn:hover {
+    background: var(--primary-dark);
+    color: white;
+}
+
+/* –§–æ—Ä–º—ã */
+.form-group { margin-bottom: 20px; }
+.form-group:last-child { margin-bottom: 0; }
+
+.form-group label {
+    display: block;
+    font-size: 12px;
+    font-weight: 600;
+    color: var(--gray-600);
+    margin-bottom: 8px;
+    text-transform: uppercase;
+}
+
+.form-group input,
+.form-group select,
+.form-group textarea {
+    width: 100%;
+    padding: 12px 16px;
+    border: 2px solid var(--gray-200);
+    border-radius: 10px;
+    font-size: 15px;
+    box-sizing: border-box;
+}
+
+.form-group input,
+.form-group select {
+    height: 48px;
+}
+
+.form-group select {
+    appearance: none;
+    background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 16px center;
+    padding-right: 40px;
+}
+
+.form-group input:focus,
+.form-group select:focus,
+.form-group textarea:focus {
+    outline: none;
+    border-color: var(--primary);
+    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
+}
+
+.form-group textarea { min-height: 100px; height: auto; }
+
+.form-row {
+    display: grid;
+    grid-template-columns: 1fr 1fr;
+    gap: 15px;
+}
+
+.form-row-2 {
+    display: grid;
+    grid-template-columns: 1fr 1fr;
+    gap: 15px;
+}
+
+.form-hint {
+    font-size: 11px;
+    color: #999;
+    margin-top: 5px;
+}
+
+.cars-hint {
+    display: flex;
+    align-items: center;
+    gap: 10px;
+    padding: 12px 15px;
+    background: #fff3cd;
+    border-radius: 8px;
+    font-size: 13px;
+    color: #856404;
+    margin-bottom: 15px;
+}
+
+/* –ö–Ω–æ–ø–∫–∏ */
+.btn {
+    display: inline-flex;
+    align-items: center;
+    justify-content: center;
+    gap: 8px;
+    padding: 12px 20px;
+    border-radius: 10px;
+    font-size: 14px;
+    font-weight: 600;
+    text-decoration: none;
+    cursor: pointer;
+    border: none;
+    width: 100%;
+    box-sizing: border-box;
+    transition: all 0.2s;
+}
+
+.btn-primary {
+    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
+    color: white;
+    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.35);
+}
+
+.btn-primary:hover {
+    transform: translateY(-2px);
+    box-shadow: 0 6px 20px rgba(255, 107, 53, 0.45);
+    color: white;
+}
+
+.btn-success {
+    background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
+    color: white;
+}
+
+.btn-success:hover { color: white; }
+
+.btn-outline {
+    background: white;
+    color: var(--gray-600);
+    border: 2px solid var(--gray-300);
+}
+
+.btn-outline:hover {
+    border-color: var(--primary);
+    color: var(--primary);
+}
+
+.btn-danger { background: var(--danger); color: white; }
+.btn-sm { padding: 10px 16px; font-size: 13px; }
+
+.actions-buttons {
+    display: flex;
+    flex-direction: column;
+    gap: 10px;
+}
+
+.actions-divider {
+    height: 1px;
+    background: var(--gray-200);
+    margin: 10px 0;
+}
+
+/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π Django */
+.form-group .vForeignKeyRawIdAdminField,
+.form-group .vTextField,
+.form-group .vDateField {
+    width: 100% !important;
+    padding: 12px 16px !important;
+    border: 2px solid var(--gray-200) !important;
+    border-radius: 10px !important;
+    font-size: 15px !important;
+    height: 48px !important;
+    box-sizing: border-box !important;
+}
+
+.form-group textarea {
+    min-height: 100px !important;
+}
+
+.form-group .vManyToManyRawIdAdminField {
+    width: 100% !important;
+    min-height: 80px !important;
+    padding: 12px 16px !important;
+    border: 2px solid var(--gray-200) !important;
+    border-radius: 10px !important;
+    font-size: 15px !important;
+    box-sizing: border-box !important;
+}
+
+/* Select2 —Å—Ç–∏–ª–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ */
+.select2-container { width: 100% !important; }
+
+.select2-container--default .select2-selection--multiple {
+    border: 2px solid var(--gray-200) !important;
+    border-radius: 10px !important;
+    padding: 10px 12px !important;
+    min-height: 120px !important;
+    max-height: 400px !important;
+    overflow-y: auto !important;
+}
+
+.select2-container--default .select2-selection--multiple .select2-selection__choice {
+    border: none !important;
+    border-radius: 8px !important;
+    color: white !important;
+    padding: 6px 12px 6px 8px !important;
+    margin: 4px !important;
+    font-size: 13px !important;
+    font-weight: 500 !important;
+    max-width: calc(100% - 16px) !important;
+    white-space: nowrap !important;
+    overflow: hidden !important;
+    text-overflow: ellipsis !important;
+    line-height: 1.4 !important;
+    display: inline-flex !important;
+    align-items: center !important;
+    gap: 0 !important;
+}
+
+.select2-container--default .select2-selection--multiple .select2-selection__choice span {
+    overflow: hidden !important;
+    text-overflow: ellipsis !important;
+}
+
+/* –¶–≤–µ—Ç–∞ —Ç–µ–≥–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è */
+.select2-selection__choice[data-status="FLOATING"] {
+    background: linear-gradient(135deg, #2772a8 0%, #1e5a8a 100%) !important;
+}
+.select2-selection__choice[data-status="IN_PORT"] {
+    background: linear-gradient(135deg, #8B0000 0%, #6B0000 100%) !important;
+}
+.select2-selection__choice[data-status="UNLOADED"] {
+    background: linear-gradient(135deg, #239f58 0%, #1a7a43 100%) !important;
+}
+.select2-selection__choice[data-status="TRANSFERRED"] {
+    background: linear-gradient(135deg, #78458c 0%, #5a3369 100%) !important;
+}
+/* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω */
+.select2-selection__choice:not([data-status]) {
+    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%) !important;
+}
+
+/* –¶–≤–µ—Ç–∞ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ */
+.select2-results__option[data-status="FLOATING"] { border-left: 4px solid #2772a8; }
+.select2-results__option[data-status="IN_PORT"] { border-left: 4px solid #8B0000; }
+.select2-results__option[data-status="UNLOADED"] { border-left: 4px solid #239f58; }
+.select2-results__option[data-status="TRANSFERRED"] { border-left: 4px solid #78458c; }
+
+.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
+    color: rgba(255,255,255,0.9) !important;
+    font-size: 16px !important;
+    font-weight: bold !important;
+    margin-right: 8px !important;
+    border: none !important;
+    background: rgba(0,0,0,0.15) !important;
+    border-radius: 50% !important;
+    width: 20px !important;
+    height: 20px !important;
+    display: inline-flex !important;
+    align-items: center !important;
+    justify-content: center !important;
+    cursor: pointer !important;
+}
+
+.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
+    color: #ff6b6b !important;
+    background: transparent !important;
+}
+
+.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:focus {
+    outline: none !important;
+    border: none !important;
+    box-shadow: none !important;
+}
+
+/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ–∏—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ multiple select */
+.select2-container--default .select2-selection--multiple .select2-search--inline .select2-search__field {
+    margin-top: 8px !important;
+    font-size: 14px !important;
+}
+
+.select2-dropdown {
+    border: 2px solid var(--gray-200) !important;
+    border-radius: 10px !important;
+    box-shadow: var(--shadow-lg) !important;
+}
+
+.select2-results__option--highlighted { 
+    background-color: var(--primary) !important; 
+}
+
+.select2-container--default .select2-selection--single {
+    height: 48px !important;
+    border: 2px solid var(--gray-200) !important;
+    border-radius: 10px !important;
+    padding: 8px 16px !important;
+}
+
+.select2-container--default .select2-selection--single .select2-selection__rendered {
+    line-height: 30px !important;
+    padding-left: 0 !important;
+}
+
+.select2-container--default .select2-selection--single .select2-selection__arrow {
+    height: 46px !important;
+}
+
+/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
+@media (max-width: 1200px) {
+    .autotransport-grid { grid-template-columns: 1fr; }
+}
+
+@media (max-width: 768px) {
+    .form-row, .form-row-2 { grid-template-columns: 1fr; }
+}
+
+/* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã Django */
+.form-row.field-carrier .help,
+.form-row.field-truck .help,
+.form-row.field-driver .help,
+.form-row.field-cars .help {
+    display: none;
+}
+
+/* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –≥—Ä–∞–Ω–∏—Ü */
+.border-suggestions {
+    position: absolute;
+    z-index: 1000;
+    background: white;
+    border: 2px solid var(--gray-200);
+    border-radius: 10px;
+    box-shadow: var(--shadow-lg);
+    max-height: 250px;
+    overflow-y: auto;
+    margin-top: 5px;
+    width: calc(100% - 4px);
+}
+
+.border-suggestion-item {
+    padding: 12px 16px;
+    cursor: pointer;
+    border-bottom: 1px solid var(--gray-100);
+    font-size: 14px;
+    color: var(--gray-800);
+}
+
+.border-suggestion-item:last-child {
+    border-bottom: none;
+}
+
+.border-suggestion-item:hover {
+    background: var(--primary);
+    color: white;
+}
+
+/* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
+.form-group {
+    position: relative;
+}
diff --git a/core/static/js/autotransport.js b/core/static/js/autotransport.js
new file mode 100644
index 0000000..fbcf9d9
--- /dev/null
+++ b/core/static/js/autotransport.js
@@ -0,0 +1,434 @@
+/* ============================================
+   üöõ –ê–í–¢–û–í–û–ó–´ - –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò
+   ============================================ */
+
+(function($) {
+    'use strict';
+    
+    $(document).ready(function() {
+        console.log('üöõ AutoTransport JS –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
+        console.log('jQuery –≤–µ—Ä—Å–∏—è:', $.fn.jquery);
+        console.log('Select2 –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof $.fn.select2);
+
+        // ============================================
+        // 1. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï EORI –ö–û–î–ê –ò–ó –ü–ï–†–ï–í–û–ó–ß–ò–ö–ê
+        // ============================================
+        const carrierSelect = $('#id_carrier');
+        const eoriInput = $('#id_eori_code');
+
+        if (carrierSelect.length && eoriInput.length) {
+            carrierSelect.on('change', function() {
+                const carrierId = $(this).val();
+                if (!carrierId) {
+                    eoriInput.val('');
+                    return;
+                }
+
+                $.ajax({
+                    url: '/core/api/carrier/' + carrierId + '/info/',
+                    method: 'GET',
+                    success: function(data) {
+                        if (data.eori_code) {
+                            eoriInput.val(data.eori_code);
+                        }
+                        
+                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π
+                        updateTrucksList(data.trucks);
+                        updateDriversList(data.drivers);
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞:', error);
+                    }
+                });
+            });
+        }
+
+        // ============================================
+        // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ê–í–¢–û–í–û–ó–û–í
+        // ============================================
+        function updateTrucksList(trucks) {
+            const truckSelect = $('#id_truck');
+            if (!truckSelect.length) return;
+
+            const currentValue = truckSelect.val();
+            truckSelect.empty();
+            truckSelect.append('<option value="">---------</option>');
+
+            trucks.forEach(function(truck) {
+                const option = $('<option></option>')
+                    .val(truck.id)
+                    .text(truck.full_number);
+                truckSelect.append(option);
+            });
+
+            if (currentValue) {
+                truckSelect.val(currentValue);
+            }
+        }
+
+        // ============================================
+        // 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –í–û–î–ò–¢–ï–õ–ï–ô
+        // ============================================
+        function updateDriversList(drivers) {
+            const driverSelect = $('#id_driver');
+            if (!driverSelect.length) return;
+
+            const currentValue = driverSelect.val();
+            driverSelect.empty();
+            driverSelect.append('<option value="">---------</option>');
+
+            drivers.forEach(function(driver) {
+                const option = $('<option></option>')
+                    .val(driver.id)
+                    .text(driver.full_name);
+                driverSelect.append(option);
+            });
+
+            if (currentValue) {
+                driverSelect.val(currentValue);
+            }
+        }
+
+        // ============================================
+        // 4. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ï–õ–ï–§–û–ù–ê –í–û–î–ò–¢–ï–õ–Ø
+        // ============================================
+        const driverSelect = $('#id_driver');
+        const driverPhoneInput = $('#id_driver_phone');
+
+        if (driverSelect.length && driverPhoneInput.length) {
+            driverSelect.on('change', function() {
+                const driverId = $(this).val();
+                if (!driverId) {
+                    return;
+                }
+
+                $.ajax({
+                    url: '/core/api/driver/' + driverId + '/phone/',
+                    method: 'GET',
+                    success: function(data) {
+                        if (data.phone) {
+                            driverPhoneInput.val(data.phone);
+                        }
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è:', error);
+                    }
+                });
+            });
+
+            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ
+            let phoneUpdateTimeout;
+            driverPhoneInput.on('input', function() {
+                clearTimeout(phoneUpdateTimeout);
+                const newPhone = $(this).val();
+                const driverId = driverSelect.val();
+
+                if (!driverId || !newPhone) return;
+
+                phoneUpdateTimeout = setTimeout(function() {
+                    $.ajax({
+                        url: '/core/api/driver/update-phone/',
+                        method: 'POST',
+                        headers: {
+                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
+                        },
+                        data: {
+                            driver_id: driverId,
+                            phone: newPhone
+                        },
+                        success: function(data) {
+                            console.log('‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω:', data.phone);
+                        },
+                        error: function(xhr, status, error) {
+                            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:', error);
+                        }
+                    });
+                }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
+            });
+        }
+
+        // ============================================
+        // 5. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ì–†–ê–ù–ò–¶–´ –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø
+        // ============================================
+        const borderInput = $('#id_border_crossing');
+        
+        if (borderInput.length) {
+            let borderTimeout;
+            let bordersCache = null;
+
+            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–Ω–∏—Ü –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
+            borderInput.on('focus', function() {
+                if (bordersCache !== null) {
+                    showBorderSuggestions(bordersCache);
+                    return;
+                }
+
+                $.ajax({
+                    url: '/core/api/border-crossings/',
+                    method: 'GET',
+                    success: function(data) {
+                        bordersCache = data.borders;
+                        showBorderSuggestions(bordersCache);
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞–Ω–∏—Ü:', error);
+                    }
+                });
+            });
+
+            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
+            borderInput.on('input', function() {
+                clearTimeout(borderTimeout);
+                const query = $(this).val().toLowerCase();
+
+                if (!bordersCache) return;
+
+                borderTimeout = setTimeout(function() {
+                    const filtered = bordersCache.filter(function(border) {
+                        return border.toLowerCase().includes(query);
+                    });
+                    showBorderSuggestions(filtered);
+                }, 300);
+            });
+
+            function showBorderSuggestions(borders) {
+                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–∏—Å–æ–∫
+                $('.border-suggestions').remove();
+
+                if (!borders || borders.length === 0) return;
+
+                const suggestions = $('<div class="border-suggestions"></div>');
+                borders.forEach(function(border) {
+                    const item = $('<div class="border-suggestion-item"></div>')
+                        .text(border)
+                        .on('click', function() {
+                            borderInput.val(border);
+                            suggestions.remove();
+                        });
+                    suggestions.append(item);
+                });
+
+                borderInput.after(suggestions);
+            }
+
+            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
+            $(document).on('click', function(e) {
+                if (!$(e.target).closest('.form-group').length) {
+                    $('.border-suggestions').remove();
+                }
+            });
+        }
+
+        // ============================================
+        // 6. –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –ê–í–¢–û–í–û–ó–ê/–í–û–î–ò–¢–ï–õ–Ø
+        // ============================================
+        
+        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ —Ä—É—á–Ω–æ–µ –ø–æ–ª–µ
+        const truckManualInput = $('#id_truck_number_manual');
+        const trailerManualInput = $('#id_trailer_number_manual');
+        
+        if (truckManualInput.length && carrierSelect.length) {
+            function createNewTruck() {
+                const carrierId = carrierSelect.val();
+                const truckNumber = truckManualInput.val();
+                const trailerNumber = trailerManualInput.val();
+
+                if (!carrierId || !truckNumber) return;
+
+                $.ajax({
+                    url: '/core/api/carrier/create-truck/',
+                    method: 'POST',
+                    headers: {
+                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
+                    },
+                    data: {
+                        carrier_id: carrierId,
+                        truck_number: truckNumber,
+                        trailer_number: trailerNumber
+                    },
+                    success: function(data) {
+                        console.log('‚úÖ –ù–æ–≤—ã–π –∞–≤—Ç–æ–≤–æ–∑ –¥–æ–±–∞–≤–ª–µ–Ω:', data.truck);
+                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
+                        const truckSelect = $('#id_truck');
+                        const option = $('<option></option>')
+                            .val(data.truck.id)
+                            .text(data.truck.full_number)
+                            .prop('selected', true);
+                        truckSelect.append(option);
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–≤–æ–∑–∞:', error);
+                    }
+                });
+            }
+
+            truckManualInput.on('blur', createNewTruck);
+            trailerManualInput.on('blur', createNewTruck);
+        }
+
+        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ —Ä—É—á–Ω–æ–µ –ø–æ–ª–µ
+        const driverManualInput = $('#id_driver_name_manual');
+        
+        if (driverManualInput.length && carrierSelect.length) {
+            driverManualInput.on('blur', function() {
+                const carrierId = carrierSelect.val();
+                const fullName = $(this).val().trim();
+
+                if (!carrierId || !fullName) return;
+
+                // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é
+                const nameParts = fullName.split(' ');
+                const firstName = nameParts[0] || '';
+                const lastName = nameParts.slice(1).join(' ') || '';
+
+                if (!firstName || !lastName) {
+                    console.warn('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è (–ò–º—è –§–∞–º–∏–ª–∏—è)');
+                    return;
+                }
+
+                const phone = driverPhoneInput.val() || '';
+
+                $.ajax({
+                    url: '/core/api/carrier/create-driver/',
+                    method: 'POST',
+                    headers: {
+                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
+                    },
+                    data: {
+                        carrier_id: carrierId,
+                        first_name: firstName,
+                        last_name: lastName,
+                        phone: phone
+                    },
+                    success: function(data) {
+                        console.log('‚úÖ –ù–æ–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω:', data.driver);
+                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
+                        const driverSelect = $('#id_driver');
+                        const option = $('<option></option>')
+                            .val(data.driver.id)
+                            .text(data.driver.full_name)
+                            .prop('selected', true);
+                        driverSelect.append(option);
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è:', error);
+                    }
+                });
+            });
+        }
+
+        // ============================================
+        // 7. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SELECT2 –î–õ–Ø –ê–í–¢–û–ú–û–ë–ò–õ–ï–ô –° AJAX
+        // ============================================
+        const carsSelect = $('#cars_select');
+        
+        if (carsSelect.length && typeof $.fn.select2 === 'function') {
+            // –ü–æ–ª—É—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID
+            function getSelectedIds() {
+                var selected = [];
+                carsSelect.find('option:selected').each(function() {
+                    selected.push($(this).val());
+                });
+                return selected;
+            }
+
+            carsSelect.select2({
+                placeholder: '–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ –º–∞—Ä–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞...',
+                allowClear: true,
+                width: '100%',
+                minimumInputLength: 2,
+                ajax: {
+                    url: '/core/api/search-cars/',
+                    dataType: 'json',
+                    delay: 250,
+                    data: function(params) {
+                        return {
+                            q: params.term,
+                            selected: getSelectedIds()
+                        };
+                    },
+                    processResults: function(data) {
+                        return {
+                            results: data.results.map(function(car) {
+                                return {
+                                    id: car.id,
+                                    text: car.text,
+                                    vin: car.vin,
+                                    status: car.status || 'UNKNOWN'
+                                };
+                            })
+                        };
+                    },
+                    cache: true
+                },
+                templateResult: function(state) {
+                    if (!state.id) return state.text;
+                    var statusLabels = {
+                        'FLOATING': 'üö¢ –í –ø—É—Ç–∏',
+                        'IN_PORT': '‚öì –í –ø–æ—Ä—Ç—É',
+                        'UNLOADED': '‚úÖ –†–∞–∑–≥—Ä—É–∂–µ–Ω',
+                        'TRANSFERRED': 'üì¶ –ü–µ—Ä–µ–¥–∞–Ω'
+                    };
+                    var statusLabel = statusLabels[state.status] || '';
+                    return $('<span>' + state.text + (statusLabel ? ' <small style="opacity:0.7;">' + statusLabel + '</small>' : '') + '</span>');
+                },
+                templateSelection: function(state) {
+                    if (!state.id) return state.text;
+                    return $('<span data-status="' + (state.status || 'UNKNOWN') + '">' + state.text + '</span>');
+                }
+            });
+
+            // –î–æ–±–∞–≤–ª—è–µ–º data-status –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ç–µ–≥–∞–º
+            carsSelect.on('select2:select', function(e) {
+                var status = e.params.data.status || 'UNKNOWN';
+                setTimeout(function() {
+                    $('.select2-selection__choice').each(function() {
+                        var $choice = $(this);
+                        var $span = $choice.find('span[data-status]');
+                        if ($span.length) {
+                            $choice.attr('data-status', $span.data('status'));
+                        }
+                    });
+                }, 10);
+            });
+
+            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
+            setTimeout(function() {
+                $('.select2-selection__choice').each(function() {
+                    var $choice = $(this);
+                    var $span = $choice.find('span[data-status]');
+                    if ($span.length) {
+                        $choice.attr('data-status', $span.data('status'));
+                    }
+                });
+            }, 100);
+        }
+
+        // ============================================
+        // 8. –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –ü–†–ò –§–û–†–ú–ò–†–û–í–ê–ù–ò–ò
+        // ============================================
+        $('form').on('submit', function(e) {
+            const status = $('#id_status').val();
+            const carsCount = $('#id_cars option:selected').length;
+
+            if (status === 'FORMED' && carsCount === 0) {
+                if (!confirm('‚ö†Ô∏è –ê–≤—Ç–æ–≤–æ–∑ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –ò–Ω–≤–æ–π—Å—ã –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
+                    e.preventDefault();
+                    return false;
+                }
+            }
+
+            if (status === 'FORMED' && carsCount > 0) {
+                const message = '‚úÖ –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –∏–Ω–≤–æ–π—Å—ã –¥–ª—è ' + 
+                                carsCount + ' –∞–≤—Ç–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?';
+                if (!confirm(message)) {
+                    e.preventDefault();
+                    return false;
+                }
+            }
+        });
+
+        console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ AutoTransport –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
+    });
+
+})(window.django && window.django.jQuery ? window.django.jQuery : window.jQuery);
diff --git a/core/urls.py b/core/urls.py
index 01c7a29..00d56af 100644
--- a/core/urls.py
+++ b/core/urls.py
@@ -1,5 +1,6 @@
 from django.urls import path
 from . import views
+from . import views_autotransport
 
 app_name = 'core'
 
@@ -12,5 +13,12 @@ urlpatterns = [
     # API –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ –∏–Ω–≤–æ–π—Å–∞—Ö
     path('api/search-counterparties/', views.search_counterparties, name='search_counterparties'),
     path('api/search-cars/', views.search_cars, name='search_cars'),
+    # API –¥–ª—è –∞–≤—Ç–æ–≤–æ–∑–æ–≤
+    path('api/carrier/<int:carrier_id>/info/', views_autotransport.get_carrier_info, name='get_carrier_info'),
+    path('api/driver/<int:driver_id>/phone/', views_autotransport.get_driver_phone, name='get_driver_phone'),
+    path('api/driver/update-phone/', views_autotransport.update_driver_phone, name='update_driver_phone'),
+    path('api/border-crossings/', views_autotransport.get_border_crossings, name='get_border_crossings'),
+    path('api/carrier/create-truck/', views_autotransport.create_carrier_truck, name='create_carrier_truck'),
+    path('api/carrier/create-driver/', views_autotransport.create_carrier_driver, name='create_carrier_driver'),
 ]
 
diff --git a/core/views.py b/core/views.py
index fbff6bc..05eae4a 100644
--- a/core/views.py
+++ b/core/views.py
@@ -1188,7 +1188,7 @@ def search_counterparties(request):
 def search_cars(request):
     """
     API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN, –º–∞—Ä–∫–µ
-    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞
+    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –∏–Ω–≤–æ–π—Å–∞ –∏ –∞–≤—Ç–æ–≤–æ–∑–∞
     """
     query = request.GET.get('q', '').strip()
     selected = request.GET.getlist('selected', [])  # –£–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID
@@ -1206,11 +1206,12 @@ def search_cars(request):
         client_name = car.client.name if car.client else '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞'
         results.append({
             'id': car.pk,
-            'text': f'{car.brand} {car.year} ({car.vin})',
+            'text': f'{car.brand} {car.year} ({car.vin}) - {client_name}',
             'vin': car.vin,
             'brand': car.brand,
             'year': car.year,
             'client': client_name,
+            'status': car.status,  # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö —Ç–µ–≥–æ–≤
         })
     
     return JsonResponse({'results': results})
@@ -1293,13 +1294,14 @@ def search_cars(request):
     query = request.GET.get('q', '').strip()
     selected = request.GET.getlist('selected', [])  # –£–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID
     
-    if len(query) < 2:
-        return JsonResponse({'results': []})
-    
-    # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
-    cars = Car.objects.filter(
-        Q(vin__icontains=query) | Q(brand__icontains=query)
-    ).exclude(pk__in=selected).select_related('client')[:15]
+    # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 15 –∞–≤—Ç–æ
+    if not query:
+        cars = Car.objects.exclude(pk__in=selected).select_related('client')[:15]
+    else:
+        # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
+        cars = Car.objects.filter(
+            Q(vin__icontains=query) | Q(brand__icontains=query)
+        ).exclude(pk__in=selected).select_related('client')[:15]
     
     results = []
     for car in cars:
@@ -1311,6 +1313,8 @@ def search_cars(request):
             'brand': car.brand,
             'year': car.year,
             'client': client_name,
+            'client_name': client_name,
+            'status': car.status,
         })
     
-    return JsonResponse({'results': results})
\ No newline at end of file
+    return JsonResponse({'results': results})# API endpoints for AutoTransport
diff --git a/core/views_autotransport.py b/core/views_autotransport.py
new file mode 100644
index 0000000..2744770
--- /dev/null
+++ b/core/views_autotransport.py
@@ -0,0 +1,191 @@
+"""
+API endpoints –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
+"""
+
+from django.http import JsonResponse
+from django.contrib.admin.views.decorators import staff_member_required
+from django.views.decorators.http import require_GET, require_POST
+import json
+
+from .models import Carrier, CarrierTruck, CarrierDriver, AutoTransport
+
+
+@staff_member_required
+@require_GET
+def get_carrier_info(request, carrier_id):
+    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–µ (EORI –∫–æ–¥, –∞–≤—Ç–æ–≤–æ–∑—ã, –≤–æ–¥–∏—Ç–µ–ª–∏)"""
+    try:
+        carrier = Carrier.objects.get(pk=carrier_id)
+        
+        # –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–≤–æ–∑–æ–≤
+        trucks = []
+        for truck in carrier.trucks.filter(is_active=True):
+            trucks.append({
+                'id': truck.pk,
+                'text': truck.full_number,
+                'truck_number': truck.truck_number,
+                'trailer_number': truck.trailer_number,
+            })
+        
+        # –°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π
+        drivers = []
+        for driver in carrier.drivers.filter(is_active=True):
+            drivers.append({
+                'id': driver.pk,
+                'text': driver.full_name,
+                'first_name': driver.first_name,
+                'last_name': driver.last_name,
+                'phone': driver.phone,
+            })
+        
+        return JsonResponse({
+            'success': True,
+            'eori_code': carrier.eori_code or '',
+            'trucks': trucks,
+            'drivers': drivers,
+        })
+    except Carrier.DoesNotExist:
+        return JsonResponse({'success': False, 'error': '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
+    except Exception as e:
+        return JsonResponse({'success': False, 'error': str(e)}, status=500)
+
+
+@staff_member_required
+@require_GET
+def get_driver_phone(request, driver_id):
+    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è"""
+    try:
+        driver = CarrierDriver.objects.get(pk=driver_id)
+        return JsonResponse({
+            'success': True,
+            'phone': driver.phone,
+            'full_name': driver.full_name,
+        })
+    except CarrierDriver.DoesNotExist:
+        return JsonResponse({'success': False, 'error': '–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
+    except Exception as e:
+        return JsonResponse({'success': False, 'error': str(e)}, status=500)
+
+
+@staff_member_required
+@require_POST
+def update_driver_phone(request):
+    """API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è"""
+    try:
+        data = json.loads(request.body)
+        driver_id = data.get('driver_id')
+        new_phone = data.get('phone', '').strip()
+        
+        if not driver_id or not new_phone:
+            return JsonResponse({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω ID –≤–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω'}, status=400)
+        
+        driver = CarrierDriver.objects.get(pk=driver_id)
+        driver.phone = new_phone
+        driver.save()
+        
+        return JsonResponse({
+            'success': True,
+            'message': f'–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è {driver.full_name} –æ–±–Ω–æ–≤–ª–µ–Ω'
+        })
+    except CarrierDriver.DoesNotExist:
+        return JsonResponse({'success': False, 'error': '–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
+    except Exception as e:
+        return JsonResponse({'success': False, 'error': str(e)}, status=500)
+
+
+@staff_member_required
+@require_GET
+def get_border_crossings(request):
+    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≥—Ä–∞–Ω–∏—Ü –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–≤—Ç–æ–≤–æ–∑–æ–≤"""
+    try:
+        borders = AutoTransport.objects.exclude(
+            border_crossing=''
+        ).values_list('border_crossing', flat=True).distinct().order_by('border_crossing')
+        
+        results = [{'id': border, 'text': border} for border in borders]
+        
+        return JsonResponse({'success': True, 'results': results})
+    except Exception as e:
+        return JsonResponse({'success': False, 'error': str(e)}, status=500)
+
+
+@staff_member_required
+@require_POST
+def create_carrier_truck(request):
+    """API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞ —É –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+    try:
+        data = json.loads(request.body)
+        carrier_id = data.get('carrier_id')
+        truck_number = data.get('truck_number', '').strip()
+        trailer_number = data.get('trailer_number', '').strip()
+        
+        if not carrier_id or not truck_number:
+            return JsonResponse({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫ –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç—è–≥–∞—á–∞'}, status=400)
+        
+        carrier = Carrier.objects.get(pk=carrier_id)
+        
+        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∑–∞
+        existing = CarrierTruck.objects.filter(
+            carrier=carrier,
+            truck_number=truck_number,
+            trailer_number=trailer_number
+        ).first()
+        
+        if existing:
+            return JsonResponse({
+                'success': True,
+                'truck': {'id': existing.pk, 'text': existing.full_number},
+                'message': '–¢–∞–∫–æ–π –∞–≤—Ç–æ–≤–æ–∑ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
+            })
+        
+        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞–≤—Ç–æ–≤–æ–∑
+        truck = CarrierTruck.objects.create(
+            carrier=carrier,
+            truck_number=truck_number,
+            trailer_number=trailer_number
+        )
+        
+        return JsonResponse({
+            'success': True,
+            'truck': {'id': truck.pk, 'text': truck.full_number},
+            'message': f'–°–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–≤–æ–∑ {truck.full_number}'
+        })
+    except Carrier.DoesNotExist:
+        return JsonResponse({'success': False, 'error': '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
+    except Exception as e:
+        return JsonResponse({'success': False, 'error': str(e)}, status=500)
+
+
+@staff_member_required
+@require_POST
+def create_carrier_driver(request):
+    """API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è —É –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞"""
+    try:
+        data = json.loads(request.body)
+        carrier_id = data.get('carrier_id')
+        first_name = data.get('first_name', '').strip()
+        last_name = data.get('last_name', '').strip()
+        phone = data.get('phone', '').strip()
+        
+        if not carrier_id or not first_name or not last_name:
+            return JsonResponse({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫, –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—è'}, status=400)
+        
+        carrier = Carrier.objects.get(pk=carrier_id)
+        
+        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
+        driver = CarrierDriver.objects.create(
+            carrier=carrier,
+            first_name=first_name,
+            last_name=last_name,
+            phone=phone
+        )
+        
+        return JsonResponse({
+            'success': True,
+            'driver': {'id': driver.pk, 'text': driver.full_name, 'phone': driver.phone},
+            'message': f'–°–æ–∑–¥–∞–Ω –≤–æ–¥–∏—Ç–µ–ª—å {driver.full_name}'
+        })
+    except Carrier.DoesNotExist:
+        return JsonResponse({'success': False, 'error': '–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'}, status=404)
+    except Exception as e:
+        return JsonResponse({'success': False, 'error': str(e)}, status=500)
diff --git a/logist2/settings.py b/logist2/settings.py
index e564847..3c9502b 100644
--- a/logist2/settings.py
+++ b/logist2/settings.py
@@ -1,236 +1,236 @@
-from dotenv import load_dotenv
-import os
-from pathlib import Path
-
-# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
-load_dotenv()
-
-# Build paths inside the project like this: BASE_DIR / 'subdir'.
-BASE_DIR = Path(__file__).resolve().parent.parent
-
-# SECURITY WARNING: keep the secret key used in production secret!
-SECRET_KEY = os.getenv('SECRET_KEY', 'changeme-in-env')
-
-# SECURITY WARNING: don't run with debug turned on in production!
-DEBUG = str(os.getenv('DEBUG', 'False')).lower() == 'true'
-
-# ALLOWED_HOSTS –∏–∑ .env, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏
-ALLOWED_HOSTS = [h.strip() for h in os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',') if h.strip()]
-
-# CSRF trusted origins –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω
-CSRF_TRUSTED_ORIGINS = [h.strip() for h in os.getenv('CSRF_TRUSTED_ORIGINS', 'http://localhost:8000').split(',') if h.strip()]
-
-# Application definition
-INSTALLED_APPS = [
-    'whitenoise.runserver_nostatic',
-    'django.contrib.admin',
-    'django.contrib.auth',
-    'django.contrib.contenttypes',
-    'django.contrib.sessions',
-    'django.contrib.messages',
-    'django.contrib.staticfiles',
-    'channels',
-    'rest_framework',
-    'core.apps.CoreConfig',
-]
-
-MIDDLEWARE = [
-    'django.middleware.security.SecurityMiddleware',
-    'whitenoise.middleware.WhiteNoiseMiddleware',
-    'logist2.settings_security.SecurityHeadersMiddleware',
-    'django.contrib.sessions.middleware.SessionMiddleware',
-    'django.middleware.locale.LocaleMiddleware',
-    'django.middleware.common.CommonMiddleware',
-    'django.middleware.csrf.CsrfViewMiddleware',
-    'django.contrib.auth.middleware.AuthenticationMiddleware',
-    'django.contrib.messages.middleware.MessageMiddleware',
-    'django.middleware.clickjacking.XFrameOptionsMiddleware',
-]
-
-ROOT_URLCONF = 'logist2.urls'
-
-TEMPLATES = [
-    {
-        'BACKEND': 'django.template.backends.django.DjangoTemplates',
-        'DIRS': [BASE_DIR / 'templates', BASE_DIR / 'core/templates'],
-        'APP_DIRS': True,
-        'OPTIONS': {
-            'context_processors': [
-                'django.template.context_processors.debug',
-                'django.template.context_processors.request',
-                'django.contrib.auth.context_processors.auth',
-                'django.contrib.messages.context_processors.messages',
-                'django.template.context_processors.i18n',
-            ],
-        },
-    },
-]
-
-WSGI_APPLICATION = 'logist2.wsgi.application'
-# ASGI_APPLICATION = 'logist2.asgi.application'  # –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è in-memory channels
-
-# Database with connection pooling for better performance
-DATABASES = {
-    'default': {
-        'ENGINE': 'django.db.backends.postgresql',
-        'NAME': os.getenv('DB_NAME'),
-        'USER': os.getenv('DB_USER'),
-        'PASSWORD': os.getenv('DB_PASSWORD'),
-        'HOST': os.getenv('DB_HOST'),
-        'PORT': os.getenv('DB_PORT'),
-        # Connection pooling - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
-        'CONN_MAX_AGE': 600,  # 10 –º–∏–Ω—É—Ç
-        'OPTIONS': {
-            'connect_timeout': 10,
-        }
-    }
-}
-
-# Channels
-CHANNEL_LAYERS = {
-    'default': {
-        'BACKEND': 'channels.layers.InMemoryChannelLayer',
-    },
-}
-
-# Password validation
-AUTH_PASSWORD_VALIDATORS = [
-    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
-    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
-    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
-    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
-]
-
-# Internationalization
-LANGUAGE_CODE = 'ru'
-TIME_ZONE = 'UTC'
-USE_I18N = True
-USE_L10N = True
-USE_TZ = True
-
-LANGUAGES = [
-    ('lt', 'Lietuvi≈≥'),
-    ('en', 'English'),
-    ('ru', '–†—É—Å—Å–∫–∏–π'),
-]
-
-LOCALE_PATHS = [
-    BASE_DIR / 'locale',
-]
-
-# Static files (CSS, JavaScript, Images)
-STATIC_URL = '/static/'
-STATICFILES_DIRS = [
-    BASE_DIR / "core" / "static",
-]
-STATIC_ROOT = BASE_DIR / "staticfiles"
-STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
-
-# Media files (Uploaded content)
-MEDIA_URL = '/media/'
-MEDIA_ROOT = BASE_DIR / 'media'
-
-# DRF
-REST_FRAMEWORK = {
-    'DEFAULT_PERMISSION_CLASSES': [
-        'rest_framework.permissions.IsAdminUser',
-    ],
-}
-
-# Session settings
-SESSION_COOKIE_HTTPONLY = False
-SESSION_COOKIE_SAMESITE = 'Lax'
-SESSION_COOKIE_SECURE = not DEBUG
-SESSION_COOKIE_AGE = 1209600
-SESSION_COOKIE_DOMAIN = None
-SESSION_ENGINE = 'django.contrib.sessions.backends.db'
-SESSION_SAVE_EVERY_REQUEST = True
-
-# Logging
-LOGGING = {
-    'version': 1,
-    'disable_existing_loggers': False,
-    'handlers': {
-        'console': {
-            'level': 'DEBUG',
-            'class': 'logging.StreamHandler',
-        },
-    },
-    'loggers': {
-        'django': {
-            'handlers': ['console'],
-            'level': 'DEBUG',
-            'propagate': True,
-        },
-    },
-}
-
-# WhiteNoise MIME types
-WHITENOISE_MIMETYPES = {
-    '.js': 'application/javascript',
-    '.woff': 'font/woff',
-    '.woff2': 'font/woff2',
-}
-
-# Security settings for production
-SECURE_SSL_REDIRECT = not DEBUG
-CSRF_COOKIE_SECURE = not DEBUG
-
-# Additional security headers
-SECURE_HSTS_SECONDS = 31536000 if not DEBUG else 0
-SECURE_HSTS_INCLUDE_SUBDOMAINS = not DEBUG
-SECURE_HSTS_PRELOAD = not DEBUG
-SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
-
-# CSRF trusted origins derived from ALLOWED_HOSTS
-def _build_csrf_trusted(origins):
-    result = []
-    for host in origins:
-        if host and host != 'localhost' and host != '127.0.0.1':
-            result.append(f"https://{host}")
-            result.append(f"http://{host}")
-    # localhost/http for dev
-    result.append('http://localhost')
-    result.append('http://127.0.0.1')
-    result.append('https://localhost')
-    result.append('https://127.0.0.1')
-    return result
-
-CSRF_TRUSTED_ORIGINS = _build_csrf_trusted(ALLOWED_HOSTS)
-
-# Static files (CSS, JavaScript, Images)
-STATIC_URL = '/static/'
-STATIC_ROOT = BASE_DIR / 'staticfiles'
-STATICFILES_DIRS = [
-    BASE_DIR / 'static',
-]
-
-# Media files (Uploaded content)
-MEDIA_URL = '/media/'
-MEDIA_ROOT = BASE_DIR / 'media'
-
-# Email settings for notifications
-# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º console backend (–ø–∏—Å—å–º–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª)
-# –ù–∞ production —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ EMAIL_BACKEND –≤ .env
-EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.console.EmailBackend')
-EMAIL_HOST = os.getenv('EMAIL_HOST', 'smtp.gmail.com')
-EMAIL_PORT = int(os.getenv('EMAIL_PORT', 587))
-EMAIL_USE_TLS = str(os.getenv('EMAIL_USE_TLS', 'True')).lower() == 'true'
-EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
-EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')
-DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'Caromoto Lithuania <noreply@caromoto-lt.com>')
-
-# AI Chat settings
-AI_CHAT_ENABLED = os.getenv('AI_CHAT_ENABLED', 'False').lower() == 'true'
-AI_API_KEY = os.getenv('AI_API_KEY', os.getenv('OPENAI_API_KEY', ''))
-AI_API_BASE_URL = os.getenv('AI_API_BASE_URL', 'https://api.openai.com/v1')
-AI_MODEL = os.getenv('AI_MODEL', 'gpt-4o-mini')
-AI_MAX_TOKENS = int(os.getenv('AI_MAX_TOKENS', '400'))
-AI_TEMPERATURE = float(os.getenv('AI_TEMPERATURE', '0.2'))
-AI_REQUEST_TIMEOUT = int(os.getenv('AI_REQUEST_TIMEOUT', '40'))
-
-# Company info for email templates
-COMPANY_NAME = 'Caromoto Lithuania'
-COMPANY_PHONE = '+370 XXX XXXXX'
-COMPANY_EMAIL = 'info@caromoto-lt.com'
+from dotenv import load_dotenv
+import os
+from pathlib import Path
+
+# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
+load_dotenv()
+
+# Build paths inside the project like this: BASE_DIR / 'subdir'.
+BASE_DIR = Path(__file__).resolve().parent.parent
+
+# SECURITY WARNING: keep the secret key used in production secret!
+SECRET_KEY = os.getenv('SECRET_KEY', 'changeme-in-env')
+
+# SECURITY WARNING: don't run with debug turned on in production!
+DEBUG = str(os.getenv('DEBUG', 'False')).lower() == 'true'
+
+# ALLOWED_HOSTS –∏–∑ .env, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏
+ALLOWED_HOSTS = [h.strip() for h in os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',') if h.strip()]
+
+# CSRF trusted origins –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω
+CSRF_TRUSTED_ORIGINS = [h.strip() for h in os.getenv('CSRF_TRUSTED_ORIGINS', 'http://localhost:8000').split(',') if h.strip()]
+
+# Application definition
+INSTALLED_APPS = [
+    'whitenoise.runserver_nostatic',
+    'django.contrib.admin',
+    'django.contrib.auth',
+    'django.contrib.contenttypes',
+    'django.contrib.sessions',
+    'django.contrib.messages',
+    'django.contrib.staticfiles',
+    'channels',
+    'rest_framework',
+    'core.apps.CoreConfig',
+]
+
+MIDDLEWARE = [
+    'django.middleware.security.SecurityMiddleware',
+    'whitenoise.middleware.WhiteNoiseMiddleware',
+    'logist2.settings_security.SecurityHeadersMiddleware',
+    'django.contrib.sessions.middleware.SessionMiddleware',
+    'django.middleware.locale.LocaleMiddleware',
+    'django.middleware.common.CommonMiddleware',
+    'django.middleware.csrf.CsrfViewMiddleware',
+    'django.contrib.auth.middleware.AuthenticationMiddleware',
+    'django.contrib.messages.middleware.MessageMiddleware',
+    'django.middleware.clickjacking.XFrameOptionsMiddleware',
+]
+
+ROOT_URLCONF = 'logist2.urls'
+
+TEMPLATES = [
+    {
+        'BACKEND': 'django.template.backends.django.DjangoTemplates',
+        'DIRS': [BASE_DIR / 'templates', BASE_DIR / 'core/templates'],
+        'APP_DIRS': True,
+        'OPTIONS': {
+            'context_processors': [
+                'django.template.context_processors.debug',
+                'django.template.context_processors.request',
+                'django.contrib.auth.context_processors.auth',
+                'django.contrib.messages.context_processors.messages',
+                'django.template.context_processors.i18n',
+            ],
+        },
+    },
+]
+
+WSGI_APPLICATION = 'logist2.wsgi.application'
+# ASGI_APPLICATION = 'logist2.asgi.application'  # –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è in-memory channels
+
+# Database with connection pooling for better performance
+DATABASES = {
+    'default': {
+        'ENGINE': 'django.db.backends.postgresql',
+        'NAME': os.getenv('DB_NAME'),
+        'USER': os.getenv('DB_USER'),
+        'PASSWORD': os.getenv('DB_PASSWORD'),
+        'HOST': os.getenv('DB_HOST'),
+        'PORT': os.getenv('DB_PORT'),
+        # Connection pooling - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
+        'CONN_MAX_AGE': 600,  # 10 –º–∏–Ω—É—Ç
+        'OPTIONS': {
+            'connect_timeout': 10,
+        }
+    }
+}
+
+# Channels
+CHANNEL_LAYERS = {
+    'default': {
+        'BACKEND': 'channels.layers.InMemoryChannelLayer',
+    },
+}
+
+# Password validation
+AUTH_PASSWORD_VALIDATORS = [
+    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
+    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
+    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
+    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
+]
+
+# Internationalization
+LANGUAGE_CODE = 'ru'
+TIME_ZONE = 'UTC'
+USE_I18N = True
+USE_L10N = True
+USE_TZ = True
+
+LANGUAGES = [
+    ('lt', 'Lietuvi≈≥'),
+    ('en', 'English'),
+    ('ru', '–†—É—Å—Å–∫–∏–π'),
+]
+
+LOCALE_PATHS = [
+    BASE_DIR / 'locale',
+]
+
+# Static files (CSS, JavaScript, Images)
+STATIC_URL = '/static/'
+STATICFILES_DIRS = [
+    BASE_DIR / "core" / "static",
+]
+STATIC_ROOT = BASE_DIR / "staticfiles"
+STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
+
+# Media files (Uploaded content)
+MEDIA_URL = '/media/'
+MEDIA_ROOT = BASE_DIR / 'media'
+
+# DRF
+REST_FRAMEWORK = {
+    'DEFAULT_PERMISSION_CLASSES': [
+        'rest_framework.permissions.IsAdminUser',
+    ],
+}
+
+# Session settings
+SESSION_COOKIE_HTTPONLY = False
+SESSION_COOKIE_SAMESITE = 'Lax'
+SESSION_COOKIE_SECURE = not DEBUG
+SESSION_COOKIE_AGE = 1209600
+SESSION_COOKIE_DOMAIN = None
+SESSION_ENGINE = 'django.contrib.sessions.backends.db'
+SESSION_SAVE_EVERY_REQUEST = True
+
+# Logging
+LOGGING = {
+    'version': 1,
+    'disable_existing_loggers': False,
+    'handlers': {
+        'console': {
+            'level': 'DEBUG',
+            'class': 'logging.StreamHandler',
+        },
+    },
+    'loggers': {
+        'django': {
+            'handlers': ['console'],
+            'level': 'DEBUG',
+            'propagate': True,
+        },
+    },
+}
+
+# WhiteNoise MIME types
+WHITENOISE_MIMETYPES = {
+    '.js': 'application/javascript',
+    '.woff': 'font/woff',
+    '.woff2': 'font/woff2',
+}
+
+# Security settings for production
+SECURE_SSL_REDIRECT = not DEBUG
+CSRF_COOKIE_SECURE = not DEBUG
+
+# Additional security headers
+SECURE_HSTS_SECONDS = 31536000 if not DEBUG else 0
+SECURE_HSTS_INCLUDE_SUBDOMAINS = not DEBUG
+SECURE_HSTS_PRELOAD = not DEBUG
+SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
+
+# CSRF trusted origins derived from ALLOWED_HOSTS
+def _build_csrf_trusted(origins):
+    result = []
+    for host in origins:
+        if host and host != 'localhost' and host != '127.0.0.1':
+            result.append(f"https://{host}")
+            result.append(f"http://{host}")
+    # localhost/http for dev
+    result.append('http://localhost')
+    result.append('http://127.0.0.1')
+    result.append('https://localhost')
+    result.append('https://127.0.0.1')
+    return result
+
+CSRF_TRUSTED_ORIGINS = _build_csrf_trusted(ALLOWED_HOSTS)
+
+# Static files (CSS, JavaScript, Images)
+STATIC_URL = '/static/'
+STATIC_ROOT = BASE_DIR / 'staticfiles'
+STATICFILES_DIRS = [
+    BASE_DIR / 'static',
+]
+
+# Media files (Uploaded content)
+MEDIA_URL = '/media/'
+MEDIA_ROOT = BASE_DIR / 'media'
+
+# Email settings for notifications
+# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º console backend (–ø–∏—Å—å–º–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª)
+# –ù–∞ production —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ EMAIL_BACKEND –≤ .env
+EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.console.EmailBackend')
+EMAIL_HOST = os.getenv('EMAIL_HOST', 'smtp.gmail.com')
+EMAIL_PORT = int(os.getenv('EMAIL_PORT', 587))
+EMAIL_USE_TLS = str(os.getenv('EMAIL_USE_TLS', 'True')).lower() == 'true'
+EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
+EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')
+DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'Caromoto Lithuania <noreply@caromoto-lt.com>')
+
+# AI Chat settings
+AI_CHAT_ENABLED = os.getenv('AI_CHAT_ENABLED', 'False').lower() == 'true'
+AI_API_KEY = os.getenv('AI_API_KEY', os.getenv('OPENAI_API_KEY', ''))
+AI_API_BASE_URL = os.getenv('AI_API_BASE_URL', 'https://api.openai.com/v1')
+AI_MODEL = os.getenv('AI_MODEL', 'gpt-4o-mini')
+AI_MAX_TOKENS = int(os.getenv('AI_MAX_TOKENS', '400'))
+AI_TEMPERATURE = float(os.getenv('AI_TEMPERATURE', '0.2'))
+AI_REQUEST_TIMEOUT = int(os.getenv('AI_REQUEST_TIMEOUT', '40'))
+
+# Company info for email templates
+COMPANY_NAME = 'Caromoto Lithuania'
+COMPANY_PHONE = '+370 XXX XXXXX'
+COMPANY_EMAIL = 'info@caromoto-lt.com'
 COMPANY_WEBSITE = 'https://caromoto-lt.com'
\ No newline at end of file
diff --git a/logist2/settings_base.py b/logist2/settings_base.py
index 618887f..2c595b6 100644
--- a/logist2/settings_base.py
+++ b/logist2/settings_base.py
@@ -1,188 +1,188 @@
-from dotenv import load_dotenv
-import os
-from pathlib import Path
-
-load_dotenv()
-
-BASE_DIR = Path(__file__).resolve().parent.parent
-
-SECRET_KEY = os.getenv('SECRET_KEY', 'changeme-in-env')
-DEBUG = str(os.getenv('DEBUG', 'False')).lower() == 'true'
-ALLOWED_HOSTS = [h.strip() for h in os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',') if h.strip()]
-
-INSTALLED_APPS = [
-    'daphne',
-    'whitenoise.runserver_nostatic',
-    'django.contrib.admin',
-    'django.contrib.auth',
-    'django.contrib.contenttypes',
-    'django.contrib.sessions',
-    'django.contrib.messages',
-    'django.contrib.staticfiles',
-    'channels',
-    'rest_framework',
-    'core.apps.CoreConfig',
-]
-
-MIDDLEWARE = [
-    'django.middleware.security.SecurityMiddleware',
-    'whitenoise.middleware.WhiteNoiseMiddleware',
-    'logist2.settings_security.SecurityHeadersMiddleware',
-    'django.contrib.sessions.middleware.SessionMiddleware',
-    'django.middleware.locale.LocaleMiddleware',
-    'core.middleware_admin_language.AdminRussianLanguageMiddleware',  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä—É—Å—Å–∫–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
-    'django.middleware.common.CommonMiddleware',
-    'django.middleware.csrf.CsrfViewMiddleware',
-    'django.contrib.auth.middleware.AuthenticationMiddleware',
-    'django.contrib.messages.middleware.MessageMiddleware',
-    'django.middleware.clickjacking.XFrameOptionsMiddleware',
-]
-
-ROOT_URLCONF = 'logist2.urls'
-
-TEMPLATES = [
-    {
-        'BACKEND': 'django.template.backends.django.DjangoTemplates',
-        'DIRS': [BASE_DIR / 'templates', BASE_DIR / 'core' / 'templates'],
-        'APP_DIRS': True,
-        'OPTIONS': {
-            'context_processors': [
-                'django.template.context_processors.debug',
-                'django.template.context_processors.request',
-                'django.contrib.auth.context_processors.auth',
-                'django.contrib.messages.context_processors.messages',
-                'django.template.context_processors.i18n',
-            ],
-        },
-    },
-]
-
-WSGI_APPLICATION = 'logist2.wsgi.application'
-ASGI_APPLICATION = 'logist2.asgi.application'
-
-DATABASES = {
-    'default': {
-        'ENGINE': 'django.db.backends.postgresql',
-        'NAME': os.getenv('DB_NAME'),
-        'USER': os.getenv('DB_USER'),
-        'PASSWORD': os.getenv('DB_PASSWORD'),
-        'HOST': os.getenv('DB_HOST'),
-        'PORT': os.getenv('DB_PORT'),
-    }
-}
-
-CHANNEL_LAYERS = {
-    'default': {
-        'BACKEND': 'channels_redis.core.RedisChannelLayer',
-        'CONFIG': {
-            "hosts": [(os.getenv('REDIS_HOST', '127.0.0.1'), int(os.getenv('REDIS_PORT', '6379')))],
-        },
-    },
-}
-
-AUTH_PASSWORD_VALIDATORS = [
-    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
-    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
-    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
-    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
-]
-
-# Internationalization
-LANGUAGE_CODE = 'ru'
-TIME_ZONE = 'UTC'
-USE_I18N = True
-USE_L10N = True
-USE_TZ = True
-
-LANGUAGES = [
-    ('lt', 'Lietuvi≈≥'),
-    ('en', 'English'),
-    ('ru', '–†—É—Å—Å–∫–∏–π'),
-]
-
-LOCALE_PATHS = [
-    BASE_DIR / 'locale',
-]
-
-STATIC_URL = '/static/'
-STATICFILES_DIRS = [BASE_DIR / 'core' / 'static']
-STATIC_ROOT = BASE_DIR / 'staticfiles'
-STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
-
-REST_FRAMEWORK = {
-    'DEFAULT_PERMISSION_CLASSES': ['rest_framework.permissions.IsAdminUser'],
-}
-
-SESSION_COOKIE_HTTPONLY = False
-SESSION_COOKIE_SAMESITE = 'Lax'
-SESSION_COOKIE_SECURE = not DEBUG
-SESSION_COOKIE_AGE = 1209600
-SESSION_COOKIE_DOMAIN = None
-SESSION_ENGINE = 'django.contrib.sessions.backends.db'
-SESSION_SAVE_EVERY_REQUEST = True
-
-LOGGING = {
-    'version': 1,
-    'disable_existing_loggers': False,
-    'handlers': {
-        'console': {'level': 'DEBUG', 'class': 'logging.StreamHandler'},
-    },
-    'loggers': {
-        'django': {'handlers': ['console'], 'level': 'DEBUG', 'propagate': True},
-    },
-}
-
-WHITENOISE_MIMETYPES = {
-    '.js': 'application/javascript',
-    '.woff': 'font/woff',
-    '.woff2': 'font/woff2',
-}
-
-SECURE_SSL_REDIRECT = not DEBUG
-CSRF_COOKIE_SECURE = not DEBUG
-
-SECURE_HSTS_SECONDS = 31536000 if not DEBUG else 0
-SECURE_HSTS_INCLUDE_SUBDOMAINS = not DEBUG
-SECURE_HSTS_PRELOAD = not DEBUG
-SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
-
-# Email settings for notifications
-EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.smtp.EmailBackend')
-EMAIL_HOST = os.getenv('EMAIL_HOST', 'localhost')
-EMAIL_PORT = int(os.getenv('EMAIL_PORT', '25'))
-EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'False').lower() == 'true'
-EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
-EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')
-DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'noreply@caromoto-lt.com')
-
-# AI Chat settings
-AI_CHAT_ENABLED = os.getenv('AI_CHAT_ENABLED', 'False').lower() == 'true'
-AI_API_KEY = os.getenv('AI_API_KEY', os.getenv('OPENAI_API_KEY', ''))
-AI_API_BASE_URL = os.getenv('AI_API_BASE_URL', 'https://api.openai.com/v1')
-AI_MODEL = os.getenv('AI_MODEL', 'gpt-4o-mini')
-AI_MAX_TOKENS = int(os.getenv('AI_MAX_TOKENS', '400'))
-AI_TEMPERATURE = float(os.getenv('AI_TEMPERATURE', '0.2'))
-AI_REQUEST_TIMEOUT = int(os.getenv('AI_REQUEST_TIMEOUT', '40'))
-AI_EMBEDDINGS_MODEL = os.getenv('AI_EMBEDDINGS_MODEL', 'text-embedding-3-small')
-AI_RAG_INDEX_PATH = os.getenv('AI_RAG_INDEX_PATH', os.path.join(BASE_DIR, 'core', 'ai_rag_index.json'))
-AI_RAG_TOP_K = int(os.getenv('AI_RAG_TOP_K', '4'))
-AI_RAG_MAX_AGE_HOURS = int(os.getenv('AI_RAG_MAX_AGE_HOURS', '24'))
-
-# Company info for email templates
-COMPANY_NAME = 'Caromoto Lithuania'
-COMPANY_PHONE = '+37068830450'
-COMPANY_EMAIL = 'lithuania@caromoto.com'
-COMPANY_WEBSITE = 'https://caromoto-lt.com'
-
-def _build_csrf_trusted(origins):
-    result = []
-    for host in origins:
-        if host and host not in ('localhost', '127.0.0.1'):
-            result.append(f'https://{host}')
-            result.append(f'http://{host}')
-    result += ['http://localhost', 'http://127.0.0.1', 'https://localhost', 'https://127.0.0.1']
-    return result
-
-CSRF_TRUSTED_ORIGINS = _build_csrf_trusted(ALLOWED_HOSTS)
-
-
+from dotenv import load_dotenv
+import os
+from pathlib import Path
+
+load_dotenv()
+
+BASE_DIR = Path(__file__).resolve().parent.parent
+
+SECRET_KEY = os.getenv('SECRET_KEY', 'changeme-in-env')
+DEBUG = str(os.getenv('DEBUG', 'False')).lower() == 'true'
+ALLOWED_HOSTS = [h.strip() for h in os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',') if h.strip()]
+
+INSTALLED_APPS = [
+    'daphne',
+    'whitenoise.runserver_nostatic',
+    'django.contrib.admin',
+    'django.contrib.auth',
+    'django.contrib.contenttypes',
+    'django.contrib.sessions',
+    'django.contrib.messages',
+    'django.contrib.staticfiles',
+    'channels',
+    'rest_framework',
+    'core.apps.CoreConfig',
+]
+
+MIDDLEWARE = [
+    'django.middleware.security.SecurityMiddleware',
+    'whitenoise.middleware.WhiteNoiseMiddleware',
+    'logist2.settings_security.SecurityHeadersMiddleware',
+    'django.contrib.sessions.middleware.SessionMiddleware',
+    'django.middleware.locale.LocaleMiddleware',
+    'core.middleware_admin_language.AdminRussianLanguageMiddleware',  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä—É—Å—Å–∫–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
+    'django.middleware.common.CommonMiddleware',
+    'django.middleware.csrf.CsrfViewMiddleware',
+    'django.contrib.auth.middleware.AuthenticationMiddleware',
+    'django.contrib.messages.middleware.MessageMiddleware',
+    'django.middleware.clickjacking.XFrameOptionsMiddleware',
+]
+
+ROOT_URLCONF = 'logist2.urls'
+
+TEMPLATES = [
+    {
+        'BACKEND': 'django.template.backends.django.DjangoTemplates',
+        'DIRS': [BASE_DIR / 'templates', BASE_DIR / 'core' / 'templates'],
+        'APP_DIRS': True,
+        'OPTIONS': {
+            'context_processors': [
+                'django.template.context_processors.debug',
+                'django.template.context_processors.request',
+                'django.contrib.auth.context_processors.auth',
+                'django.contrib.messages.context_processors.messages',
+                'django.template.context_processors.i18n',
+            ],
+        },
+    },
+]
+
+WSGI_APPLICATION = 'logist2.wsgi.application'
+ASGI_APPLICATION = 'logist2.asgi.application'
+
+DATABASES = {
+    'default': {
+        'ENGINE': 'django.db.backends.postgresql',
+        'NAME': os.getenv('DB_NAME'),
+        'USER': os.getenv('DB_USER'),
+        'PASSWORD': os.getenv('DB_PASSWORD'),
+        'HOST': os.getenv('DB_HOST'),
+        'PORT': os.getenv('DB_PORT'),
+    }
+}
+
+CHANNEL_LAYERS = {
+    'default': {
+        'BACKEND': 'channels_redis.core.RedisChannelLayer',
+        'CONFIG': {
+            "hosts": [(os.getenv('REDIS_HOST', '127.0.0.1'), int(os.getenv('REDIS_PORT', '6379')))],
+        },
+    },
+}
+
+AUTH_PASSWORD_VALIDATORS = [
+    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
+    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
+    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
+    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
+]
+
+# Internationalization
+LANGUAGE_CODE = 'ru'
+TIME_ZONE = 'UTC'
+USE_I18N = True
+USE_L10N = True
+USE_TZ = True
+
+LANGUAGES = [
+    ('lt', 'Lietuvi≈≥'),
+    ('en', 'English'),
+    ('ru', '–†—É—Å—Å–∫–∏–π'),
+]
+
+LOCALE_PATHS = [
+    BASE_DIR / 'locale',
+]
+
+STATIC_URL = '/static/'
+STATICFILES_DIRS = [BASE_DIR / 'core' / 'static']
+STATIC_ROOT = BASE_DIR / 'staticfiles'
+STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
+
+REST_FRAMEWORK = {
+    'DEFAULT_PERMISSION_CLASSES': ['rest_framework.permissions.IsAdminUser'],
+}
+
+SESSION_COOKIE_HTTPONLY = False
+SESSION_COOKIE_SAMESITE = 'Lax'
+SESSION_COOKIE_SECURE = not DEBUG
+SESSION_COOKIE_AGE = 1209600
+SESSION_COOKIE_DOMAIN = None
+SESSION_ENGINE = 'django.contrib.sessions.backends.db'
+SESSION_SAVE_EVERY_REQUEST = True
+
+LOGGING = {
+    'version': 1,
+    'disable_existing_loggers': False,
+    'handlers': {
+        'console': {'level': 'DEBUG', 'class': 'logging.StreamHandler'},
+    },
+    'loggers': {
+        'django': {'handlers': ['console'], 'level': 'DEBUG', 'propagate': True},
+    },
+}
+
+WHITENOISE_MIMETYPES = {
+    '.js': 'application/javascript',
+    '.woff': 'font/woff',
+    '.woff2': 'font/woff2',
+}
+
+SECURE_SSL_REDIRECT = not DEBUG
+CSRF_COOKIE_SECURE = not DEBUG
+
+SECURE_HSTS_SECONDS = 31536000 if not DEBUG else 0
+SECURE_HSTS_INCLUDE_SUBDOMAINS = not DEBUG
+SECURE_HSTS_PRELOAD = not DEBUG
+SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
+
+# Email settings for notifications
+EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.smtp.EmailBackend')
+EMAIL_HOST = os.getenv('EMAIL_HOST', 'localhost')
+EMAIL_PORT = int(os.getenv('EMAIL_PORT', '25'))
+EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'False').lower() == 'true'
+EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', '')
+EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', '')
+DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'noreply@caromoto-lt.com')
+
+# AI Chat settings
+AI_CHAT_ENABLED = os.getenv('AI_CHAT_ENABLED', 'False').lower() == 'true'
+AI_API_KEY = os.getenv('AI_API_KEY', os.getenv('OPENAI_API_KEY', ''))
+AI_API_BASE_URL = os.getenv('AI_API_BASE_URL', 'https://api.openai.com/v1')
+AI_MODEL = os.getenv('AI_MODEL', 'gpt-4o-mini')
+AI_MAX_TOKENS = int(os.getenv('AI_MAX_TOKENS', '400'))
+AI_TEMPERATURE = float(os.getenv('AI_TEMPERATURE', '0.2'))
+AI_REQUEST_TIMEOUT = int(os.getenv('AI_REQUEST_TIMEOUT', '40'))
+AI_EMBEDDINGS_MODEL = os.getenv('AI_EMBEDDINGS_MODEL', 'text-embedding-3-small')
+AI_RAG_INDEX_PATH = os.getenv('AI_RAG_INDEX_PATH', os.path.join(BASE_DIR, 'core', 'ai_rag_index.json'))
+AI_RAG_TOP_K = int(os.getenv('AI_RAG_TOP_K', '4'))
+AI_RAG_MAX_AGE_HOURS = int(os.getenv('AI_RAG_MAX_AGE_HOURS', '24'))
+
+# Company info for email templates
+COMPANY_NAME = 'Caromoto Lithuania'
+COMPANY_PHONE = '+37068830450'
+COMPANY_EMAIL = 'lithuania@caromoto.com'
+COMPANY_WEBSITE = 'https://caromoto-lt.com'
+
+def _build_csrf_trusted(origins):
+    result = []
+    for host in origins:
+        if host and host not in ('localhost', '127.0.0.1'):
+            result.append(f'https://{host}')
+            result.append(f'http://{host}')
+    result += ['http://localhost', 'http://127.0.0.1', 'https://localhost', 'https://127.0.0.1']
+    return result
+
+CSRF_TRUSTED_ORIGINS = _build_csrf_trusted(ALLOWED_HOSTS)
+
+
diff --git a/templates/admin/client_autocomplete_filter.html b/templates/admin/client_autocomplete_filter.html
index 1632e92..125f5fc 100644
--- a/templates/admin/client_autocomplete_filter.html
+++ b/templates/admin/client_autocomplete_filter.html
@@ -1,217 +1,217 @@
-{% load i18n %}
-
-<h3>{% blocktranslate with filter_title=title %}By {{ filter_title }}{% endblocktranslate %}</h3>
-
-{% for choice in choices %}
-<ul>
-<li style="padding: 0; list-style: none;">
-    <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
-    <input type="text" 
-           id="client-search-input" 
-           placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞..."
-           autocomplete="off"
-           class="client-search-field">
-    
-    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
-    <div id="client-search-results" class="client-search-results"></div>
-    
-    {% if choice.current_value %}
-    <div class="client-selected">
-        <span>‚úì {{ choice.current_text }}</span>
-        <a href="{{ choice.query_string }}" title="–°–±—Ä–æ—Å–∏—Ç—å">‚úï</a>
-    </div>
-    {% endif %}
-</li>
-</ul>
-
-<script type="text/javascript">
-(function() {
-    var clientsData = {{ choice.clients_json|safe }};
-    var paramName = '{{ choice.parameter_name }}';
-    
-    function initSearch() {
-        var input = document.getElementById('client-search-input');
-        var results = document.getElementById('client-search-results');
-        if (!input || !results) return;
-        
-        var selectedIndex = -1;
-        var filteredClients = [];
-        
-        function showResults(clients) {
-            filteredClients = clients;
-            selectedIndex = -1;
-            
-            if (clients.length === 0) {
-                results.innerHTML = '<div class="no-results">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
-                results.style.display = 'block';
-                return;
-            }
-            
-            var html = '';
-            clients.forEach(function(client, index) {
-                html += '<div class="client-option" data-id="' + client.id + '" data-index="' + index + '">' +
-                        client.text + '</div>';
-            });
-            results.innerHTML = html;
-            results.style.display = 'block';
-            
-            var options = results.querySelectorAll('.client-option');
-            options.forEach(function(opt) {
-                opt.addEventListener('click', function() {
-                    selectClient(this.dataset.id);
-                });
-                opt.addEventListener('mouseenter', function() {
-                    highlightOption(parseInt(this.dataset.index));
-                });
-            });
-        }
-        
-        function highlightOption(index) {
-            var options = results.querySelectorAll('.client-option');
-            options.forEach(function(opt, i) {
-                opt.style.backgroundColor = (i === index) ? 'var(--selected-row)' : '';
-            });
-            selectedIndex = index;
-        }
-        
-        function selectClient(clientId) {
-            var url = new URL(window.location.href);
-            url.searchParams.set(paramName, clientId);
-            window.location.href = url.toString();
-        }
-        
-        input.addEventListener('input', function() {
-            var query = this.value.toLowerCase().trim();
-            
-            if (query.length < 1) {
-                results.style.display = 'none';
-                return;
-            }
-            
-            var filtered = clientsData.filter(function(client) {
-                return client.text.toLowerCase().indexOf(query) !== -1;
-            });
-            
-            showResults(filtered.slice(0, 15));
-        });
-        
-        input.addEventListener('keydown', function(e) {
-            if (results.style.display === 'none') return;
-            
-            if (e.key === 'ArrowDown') {
-                e.preventDefault();
-                if (selectedIndex < filteredClients.length - 1) {
-                    highlightOption(selectedIndex + 1);
-                }
-            } else if (e.key === 'ArrowUp') {
-                e.preventDefault();
-                if (selectedIndex > 0) {
-                    highlightOption(selectedIndex - 1);
-                }
-            } else if (e.key === 'Enter') {
-                e.preventDefault();
-                if (selectedIndex >= 0 && filteredClients[selectedIndex]) {
-                    selectClient(filteredClients[selectedIndex].id);
-                }
-            } else if (e.key === 'Escape') {
-                results.style.display = 'none';
-            }
-        });
-        
-        document.addEventListener('click', function(e) {
-            if (!input.contains(e.target) && !results.contains(e.target)) {
-                results.style.display = 'none';
-            }
-        });
-        
-        input.addEventListener('focus', function() {
-            if (this.value.length >= 1) {
-                var query = this.value.toLowerCase().trim();
-                var filtered = clientsData.filter(function(client) {
-                    return client.text.toLowerCase().indexOf(query) !== -1;
-                });
-                showResults(filtered.slice(0, 15));
-            }
-        });
-    }
-    
-    if (document.readyState === 'loading') {
-        document.addEventListener('DOMContentLoaded', initSearch);
-    } else {
-        setTimeout(initSearch, 50);
-    }
-})();
-</script>
-
-<style>
-.client-search-field {
-    width: 100%;
-    padding: 6px 8px;
-    border: 1px solid var(--hairline-color, #ccc);
-    border-radius: 4px;
-    font-size: 12px;
-    box-sizing: border-box;
-    background: var(--body-bg, #fff);
-    color: var(--body-fg, #333);
-}
-.client-search-field:focus {
-    border-color: var(--primary, #417690);
-    outline: none;
-}
-.client-search-field::placeholder {
-    color: var(--body-quiet-color, #999);
-}
-.client-search-results {
-    display: none;
-    position: absolute;
-    z-index: 1000;
-    background: var(--body-bg, #fff);
-    border: 1px solid var(--hairline-color, #ccc);
-    border-top: none;
-    border-radius: 0 0 4px 4px;
-    max-height: 200px;
-    overflow-y: auto;
-    width: calc(100% - 30px);
-    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
-}
-.client-search-results .client-option {
-    padding: 6px 10px;
-    cursor: pointer;
-    font-size: 12px;
-    border-bottom: 1px solid var(--hairline-color, #eee);
-    color: var(--body-fg, #333);
-}
-.client-search-results .client-option:hover {
-    background: var(--selected-row, #e8f4f8);
-}
-.client-search-results .client-option:last-child {
-    border-bottom: none;
-}
-.client-search-results .no-results {
-    padding: 8px 10px;
-    color: var(--body-quiet-color, #999);
-    font-size: 11px;
-}
-.client-selected {
-    margin-top: 6px;
-    padding: 5px 8px;
-    background: var(--selected-row, #e8f4f8);
-    border-radius: 4px;
-    display: flex;
-    justify-content: space-between;
-    align-items: center;
-    font-size: 11px;
-}
-.client-selected span {
-    color: var(--body-fg, #333);
-}
-.client-selected a {
-    color: var(--delete-button-bg, #ba2121);
-    text-decoration: none;
-    font-weight: bold;
-}
-.client-selected a:hover {
-    color: var(--delete-button-hover-bg, #a41515);
-}
-</style>
-{% endfor %}
+{% load i18n %}
+
+<h3>{% blocktranslate with filter_title=title %}By {{ filter_title }}{% endblocktranslate %}</h3>
+
+{% for choice in choices %}
+<ul>
+<li style="padding: 0; list-style: none;">
+    <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
+    <input type="text" 
+           id="client-search-input" 
+           placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞..."
+           autocomplete="off"
+           class="client-search-field">
+    
+    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
+    <div id="client-search-results" class="client-search-results"></div>
+    
+    {% if choice.current_value %}
+    <div class="client-selected">
+        <span>‚úì {{ choice.current_text }}</span>
+        <a href="{{ choice.query_string }}" title="–°–±—Ä–æ—Å–∏—Ç—å">‚úï</a>
+    </div>
+    {% endif %}
+</li>
+</ul>
+
+<script type="text/javascript">
+(function() {
+    var clientsData = {{ choice.clients_json|safe }};
+    var paramName = '{{ choice.parameter_name }}';
+    
+    function initSearch() {
+        var input = document.getElementById('client-search-input');
+        var results = document.getElementById('client-search-results');
+        if (!input || !results) return;
+        
+        var selectedIndex = -1;
+        var filteredClients = [];
+        
+        function showResults(clients) {
+            filteredClients = clients;
+            selectedIndex = -1;
+            
+            if (clients.length === 0) {
+                results.innerHTML = '<div class="no-results">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
+                results.style.display = 'block';
+                return;
+            }
+            
+            var html = '';
+            clients.forEach(function(client, index) {
+                html += '<div class="client-option" data-id="' + client.id + '" data-index="' + index + '">' +
+                        client.text + '</div>';
+            });
+            results.innerHTML = html;
+            results.style.display = 'block';
+            
+            var options = results.querySelectorAll('.client-option');
+            options.forEach(function(opt) {
+                opt.addEventListener('click', function() {
+                    selectClient(this.dataset.id);
+                });
+                opt.addEventListener('mouseenter', function() {
+                    highlightOption(parseInt(this.dataset.index));
+                });
+            });
+        }
+        
+        function highlightOption(index) {
+            var options = results.querySelectorAll('.client-option');
+            options.forEach(function(opt, i) {
+                opt.style.backgroundColor = (i === index) ? 'var(--selected-row)' : '';
+            });
+            selectedIndex = index;
+        }
+        
+        function selectClient(clientId) {
+            var url = new URL(window.location.href);
+            url.searchParams.set(paramName, clientId);
+            window.location.href = url.toString();
+        }
+        
+        input.addEventListener('input', function() {
+            var query = this.value.toLowerCase().trim();
+            
+            if (query.length < 1) {
+                results.style.display = 'none';
+                return;
+            }
+            
+            var filtered = clientsData.filter(function(client) {
+                return client.text.toLowerCase().indexOf(query) !== -1;
+            });
+            
+            showResults(filtered.slice(0, 15));
+        });
+        
+        input.addEventListener('keydown', function(e) {
+            if (results.style.display === 'none') return;
+            
+            if (e.key === 'ArrowDown') {
+                e.preventDefault();
+                if (selectedIndex < filteredClients.length - 1) {
+                    highlightOption(selectedIndex + 1);
+                }
+            } else if (e.key === 'ArrowUp') {
+                e.preventDefault();
+                if (selectedIndex > 0) {
+                    highlightOption(selectedIndex - 1);
+                }
+            } else if (e.key === 'Enter') {
+                e.preventDefault();
+                if (selectedIndex >= 0 && filteredClients[selectedIndex]) {
+                    selectClient(filteredClients[selectedIndex].id);
+                }
+            } else if (e.key === 'Escape') {
+                results.style.display = 'none';
+            }
+        });
+        
+        document.addEventListener('click', function(e) {
+            if (!input.contains(e.target) && !results.contains(e.target)) {
+                results.style.display = 'none';
+            }
+        });
+        
+        input.addEventListener('focus', function() {
+            if (this.value.length >= 1) {
+                var query = this.value.toLowerCase().trim();
+                var filtered = clientsData.filter(function(client) {
+                    return client.text.toLowerCase().indexOf(query) !== -1;
+                });
+                showResults(filtered.slice(0, 15));
+            }
+        });
+    }
+    
+    if (document.readyState === 'loading') {
+        document.addEventListener('DOMContentLoaded', initSearch);
+    } else {
+        setTimeout(initSearch, 50);
+    }
+})();
+</script>
+
+<style>
+.client-search-field {
+    width: 100%;
+    padding: 6px 8px;
+    border: 1px solid var(--hairline-color, #ccc);
+    border-radius: 4px;
+    font-size: 12px;
+    box-sizing: border-box;
+    background: var(--body-bg, #fff);
+    color: var(--body-fg, #333);
+}
+.client-search-field:focus {
+    border-color: var(--primary, #417690);
+    outline: none;
+}
+.client-search-field::placeholder {
+    color: var(--body-quiet-color, #999);
+}
+.client-search-results {
+    display: none;
+    position: absolute;
+    z-index: 1000;
+    background: var(--body-bg, #fff);
+    border: 1px solid var(--hairline-color, #ccc);
+    border-top: none;
+    border-radius: 0 0 4px 4px;
+    max-height: 200px;
+    overflow-y: auto;
+    width: calc(100% - 30px);
+    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
+}
+.client-search-results .client-option {
+    padding: 6px 10px;
+    cursor: pointer;
+    font-size: 12px;
+    border-bottom: 1px solid var(--hairline-color, #eee);
+    color: var(--body-fg, #333);
+}
+.client-search-results .client-option:hover {
+    background: var(--selected-row, #e8f4f8);
+}
+.client-search-results .client-option:last-child {
+    border-bottom: none;
+}
+.client-search-results .no-results {
+    padding: 8px 10px;
+    color: var(--body-quiet-color, #999);
+    font-size: 11px;
+}
+.client-selected {
+    margin-top: 6px;
+    padding: 5px 8px;
+    background: var(--selected-row, #e8f4f8);
+    border-radius: 4px;
+    display: flex;
+    justify-content: space-between;
+    align-items: center;
+    font-size: 11px;
+}
+.client-selected span {
+    color: var(--body-fg, #333);
+}
+.client-selected a {
+    color: var(--delete-button-bg, #ba2121);
+    text-decoration: none;
+    font-weight: bold;
+}
+.client-selected a:hover {
+    color: var(--delete-button-hover-bg, #a41515);
+}
+</style>
+{% endfor %}
diff --git a/templates/admin/client_change.html b/templates/admin/client_change.html
index 265d839..f12d426 100644
--- a/templates/admin/client_change.html
+++ b/templates/admin/client_change.html
@@ -1,197 +1,197 @@
-{% extends "admin/change_form.html" %}
-{% load static i18n admin_urls admin_extras %}
-
-{% block extrastyle %}
-    {{ block.super }}
-    <script src="{% static 'js/htmx.min.js' %}"></script>
-    <style>
-        .balance-details {
-            margin-top: 20px;
-            padding: 15px;
-            border: 1px solid #e0e0e0;
-            border-radius: 5px;
-            background-color: #fafafa;
-        }
-        .balance-details h3 {
-            margin-top: 0;
-        }
-        .balance-details table {
-            width: 100%;
-            border-collapse: collapse;
-        }
-        .balance-details th, .balance-details td {
-            border: 1px solid #ddd;
-            padding: 8px;
-            text-align: left;
-        }
-        .balance-details th {
-            background-color: #f2f2f2;
-        }
-        .error-message {
-            color: #dc3545;
-            font-size: 14px;
-            margin-top: 10px;
-        }
-        /* –£–±–∏—Ä–∞–µ–º —Ä–æ–∑–æ–≤—É—é –ª–∏–Ω–∏—é –Ω–∞–¥ —Ä–∞–∑–¥–µ–ª–∞–º–∏ */
-        .module h2, .module h3 {
-            border-bottom: none !important;
-        }
-        .balance-summary {
-            background: #e7f3ff;
-            padding: 15px;
-            border-radius: 8px;
-            border: 1px solid #b3d9ff;
-            margin-bottom: 20px;
-        }
-        .balance-summary h4 {
-            margin-top: 0;
-            color: #0056b3;
-        }
-        .balance-grid {
-            display: grid;
-            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
-            gap: 15px;
-            margin-top: 15px;
-        }
-        .balance-item {
-            background: white;
-            padding: 15px;
-            border-radius: 6px;
-            border: 1px solid #dee2e6;
-            text-align: center;
-        }
-        .balance-item .amount {
-            font-size: 24px;
-            font-weight: bold;
-            margin: 10px 0;
-        }
-        .balance-item .label {
-            color: #6c757d;
-            font-size: 12px;
-            text-transform: uppercase;
-            letter-spacing: 0.5px;
-        }
-        .positive { color: #28a745; }
-        .negative { color: #dc3545; }
-        .neutral { color: #6c757d; }
-    </style>
-{% endblock %}
-
-{% block content %}
-    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º -->
-    {% if original %}
-    <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, {% if original.balance > 0 %}#11998e, #38ef7d{% elif original.balance < 0 %}#eb3349, #f45c43{% else %}#667eea, #764ba2{% endif %}); border-radius: 12px; color: white;">
-        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
-            <div>
-                <div style="font-size: 2em; font-weight: bold;">
-                    {% if original.balance >= 0 %}+{% endif %}{{ original.balance }} ‚Ç¨
-                </div>
-                <div style="opacity: 0.9; margin-top: 5px;">
-                    {% if original.balance < 0 %}üìâ –î–æ–ª–≥{% elif original.balance > 0 %}üí∞ –ù–∞ –±–∞–ª–∞–Ω—Å–µ{% else %}‚öñÔ∏è –ù—É–ª–µ–≤–æ–π –±–∞–ª–∞–Ω—Å{% endif %}
-                </div>
-            </div>
-            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
-                <a href="{% url 'admin:client_topup' original.pk %}" 
-                   style="background: white; color: #333; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold;">
-                    üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å
-                </a>
-                <a href="{% url 'admin:client_cars_in_warehouse' original.pk %}" 
-                   style="background: white; color: #333; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold;">
-                    üöó –ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
-                </a>
-                <a href="{% url 'admin:client_reset_balance' original.pk %}" 
-                   style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; border: 2px solid white;"
-                   onclick="return confirm('–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {{ original.name }}?');">
-                    üîÑ –û–±–Ω—É–ª–∏—Ç—å
-                </a>
-                <a href="{% url 'admin:client_recalc_balance' original.pk %}" 
-                   style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; border: 2px solid white;">
-                    üìä –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
-                </a>
-            </div>
-        </div>
-    </div>
-    {% endif %}
-    
-    {{ block.super }}
-    
-    <!-- –°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É —É–∂–µ –µ—Å—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ –≤—ã—à–µ -->
-
-
-
-    <!-- –î–µ—Ç–∞–ª–∏ –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
-    {% if balance_details_error %}
-        <div class="error-message">{{ balance_details_error }}</div>
-    {% elif balance_details %}
-        <div class="balance-details">
-            <h3>–î–µ—Ç–∞–ª–∏ –±–∞–ª–∞–Ω—Å–∞</h3>
-            <p>–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å:
-                {% if balance_is_debt %}-{{ balance_total_debt }}{% elif balance_is_overpayment %}{{ balance_abs_overpayment }}{% else %}0.00{% endif %}
-            </p>
-            <p>–ù–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å: {{ balance_details.cash_balance }}</p>
-            <p>–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å: {{ balance_details.card_balance }}</p>
-            <h4>–ò–Ω–≤–æ–π—Å—ã</h4>
-            <table>
-                <tr>
-                    <th>–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞</th>
-                    <th>–î–∞—Ç–∞</th>
-                    <th>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</th>
-                    <th>–°—É–º–º–∞</th>
-                    <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
-                    <th>–ë–∞–ª–∞–Ω—Å</th>
-                    <th>–°—Ç–∞—Ç—É—Å</th>
-                </tr>
-                {% for invoice in balance_details.invoices %}
-                    <tr>
-                        <td>{{ invoice.invoice_number }}</td>
-                        <td>{{ invoice.issue_date }}</td>
-                        <td>{% if invoice.due_date %}{{ invoice.due_date }}{% else %}-{% endif %}</td>
-                        <td>{{ invoice.total_amount }}</td>
-                        <td>{{ invoice.total_paid }}</td>
-                        <td>{{ invoice.balance }}</td>
-                        <td>
-                            {{ invoice.status }}
-                            {% if invoice.is_overdue %}
-                                (–ü—Ä–æ—Å—Ä–æ—á–µ–Ω)
-                            {% endif %}
-                        </td>
-                    </tr>
-                {% empty %}
-                    <tr>
-                        <td colspan="7">–ù–µ—Ç –∏–Ω–≤–æ–π—Å–æ–≤</td>
-                    </tr>
-                {% endfor %}
-            </table>
-            <h4>–ü–ª–∞—Ç–µ–∂–∏</h4>
-            <table>
-                <tr>
-                    <th>ID –ø–ª–∞—Ç–µ–∂–∞</th>
-                    <th>–°—É–º–º–∞</th>
-                    <th>–¢–∏–ø</th>
-                    <th>–° –±–∞–ª–∞–Ω—Å–∞</th>
-                    <th>–° –Ω–∞–ª–∏—á–Ω–æ–≥–æ</th>
-                    <th>–ò–Ω–≤–æ–π—Å</th>
-                    <th>–î–∞—Ç–∞</th>
-                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
-                </tr>
-                {% for payment in balance_details.payments %}
-                    <tr>
-                        <td>{{ payment.payment_id }}</td>
-                        <td>{{ payment.amount }}</td>
-                        <td>{{ payment.payment_type }}</td>
-                        <td>{{ payment.from_balance|yesno:"–î–∞,–ù–µ—Ç" }}</td>
-                        <td>{{ payment.from_cash_balance|yesno:"–î–∞,–ù–µ—Ç" }}</td>
-                        <td>{{ payment.invoice_number }}</td>
-                        <td>{{ payment.date }}</td>
-                        <td>{{ payment.description|default:"-" }}</td>
-                    </tr>
-                {% empty %}
-                    <tr>
-                        <td colspan="8">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td>
-                    </tr>
-                {% endfor %}
-            </table>
-        </div>
-    {% endif %}
-{% endblock %}
-
+{% extends "admin/change_form.html" %}
+{% load static i18n admin_urls admin_extras %}
+
+{% block extrastyle %}
+    {{ block.super }}
+    <script src="{% static 'js/htmx.min.js' %}"></script>
+    <style>
+        .balance-details {
+            margin-top: 20px;
+            padding: 15px;
+            border: 1px solid #e0e0e0;
+            border-radius: 5px;
+            background-color: #fafafa;
+        }
+        .balance-details h3 {
+            margin-top: 0;
+        }
+        .balance-details table {
+            width: 100%;
+            border-collapse: collapse;
+        }
+        .balance-details th, .balance-details td {
+            border: 1px solid #ddd;
+            padding: 8px;
+            text-align: left;
+        }
+        .balance-details th {
+            background-color: #f2f2f2;
+        }
+        .error-message {
+            color: #dc3545;
+            font-size: 14px;
+            margin-top: 10px;
+        }
+        /* –£–±–∏—Ä–∞–µ–º —Ä–æ–∑–æ–≤—É—é –ª–∏–Ω–∏—é –Ω–∞–¥ —Ä–∞–∑–¥–µ–ª–∞–º–∏ */
+        .module h2, .module h3 {
+            border-bottom: none !important;
+        }
+        .balance-summary {
+            background: #e7f3ff;
+            padding: 15px;
+            border-radius: 8px;
+            border: 1px solid #b3d9ff;
+            margin-bottom: 20px;
+        }
+        .balance-summary h4 {
+            margin-top: 0;
+            color: #0056b3;
+        }
+        .balance-grid {
+            display: grid;
+            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
+            gap: 15px;
+            margin-top: 15px;
+        }
+        .balance-item {
+            background: white;
+            padding: 15px;
+            border-radius: 6px;
+            border: 1px solid #dee2e6;
+            text-align: center;
+        }
+        .balance-item .amount {
+            font-size: 24px;
+            font-weight: bold;
+            margin: 10px 0;
+        }
+        .balance-item .label {
+            color: #6c757d;
+            font-size: 12px;
+            text-transform: uppercase;
+            letter-spacing: 0.5px;
+        }
+        .positive { color: #28a745; }
+        .negative { color: #dc3545; }
+        .neutral { color: #6c757d; }
+    </style>
+{% endblock %}
+
+{% block content %}
+    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º -->
+    {% if original %}
+    <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, {% if original.balance > 0 %}#11998e, #38ef7d{% elif original.balance < 0 %}#eb3349, #f45c43{% else %}#667eea, #764ba2{% endif %}); border-radius: 12px; color: white;">
+        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
+            <div>
+                <div style="font-size: 2em; font-weight: bold;">
+                    {% if original.balance >= 0 %}+{% endif %}{{ original.balance }} ‚Ç¨
+                </div>
+                <div style="opacity: 0.9; margin-top: 5px;">
+                    {% if original.balance < 0 %}üìâ –î–æ–ª–≥{% elif original.balance > 0 %}üí∞ –ù–∞ –±–∞–ª–∞–Ω—Å–µ{% else %}‚öñÔ∏è –ù—É–ª–µ–≤–æ–π –±–∞–ª–∞–Ω—Å{% endif %}
+                </div>
+            </div>
+            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
+                <a href="{% url 'admin:client_topup' original.pk %}" 
+                   style="background: white; color: #333; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold;">
+                    üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å
+                </a>
+                <a href="{% url 'admin:client_cars_in_warehouse' original.pk %}" 
+                   style="background: white; color: #333; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold;">
+                    üöó –ê–≤—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
+                </a>
+                <a href="{% url 'admin:client_reset_balance' original.pk %}" 
+                   style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; border: 2px solid white;"
+                   onclick="return confirm('–û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞ {{ original.name }}?');">
+                    üîÑ –û–±–Ω—É–ª–∏—Ç—å
+                </a>
+                <a href="{% url 'admin:client_recalc_balance' original.pk %}" 
+                   style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; border: 2px solid white;">
+                    üìä –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
+                </a>
+            </div>
+        </div>
+    </div>
+    {% endif %}
+    
+    {{ block.super }}
+    
+    <!-- –°–≤–æ–¥–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É —É–∂–µ –µ—Å—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ –≤—ã—à–µ -->
+
+
+
+    <!-- –î–µ—Ç–∞–ª–∏ –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
+    {% if balance_details_error %}
+        <div class="error-message">{{ balance_details_error }}</div>
+    {% elif balance_details %}
+        <div class="balance-details">
+            <h3>–î–µ—Ç–∞–ª–∏ –±–∞–ª–∞–Ω—Å–∞</h3>
+            <p>–ò–Ω–≤–æ–π—Å-–±–∞–ª–∞–Ω—Å:
+                {% if balance_is_debt %}-{{ balance_total_debt }}{% elif balance_is_overpayment %}{{ balance_abs_overpayment }}{% else %}0.00{% endif %}
+            </p>
+            <p>–ù–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å: {{ balance_details.cash_balance }}</p>
+            <p>–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å: {{ balance_details.card_balance }}</p>
+            <h4>–ò–Ω–≤–æ–π—Å—ã</h4>
+            <table>
+                <tr>
+                    <th>–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞</th>
+                    <th>–î–∞—Ç–∞</th>
+                    <th>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</th>
+                    <th>–°—É–º–º–∞</th>
+                    <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
+                    <th>–ë–∞–ª–∞–Ω—Å</th>
+                    <th>–°—Ç–∞—Ç—É—Å</th>
+                </tr>
+                {% for invoice in balance_details.invoices %}
+                    <tr>
+                        <td>{{ invoice.invoice_number }}</td>
+                        <td>{{ invoice.issue_date }}</td>
+                        <td>{% if invoice.due_date %}{{ invoice.due_date }}{% else %}-{% endif %}</td>
+                        <td>{{ invoice.total_amount }}</td>
+                        <td>{{ invoice.total_paid }}</td>
+                        <td>{{ invoice.balance }}</td>
+                        <td>
+                            {{ invoice.status }}
+                            {% if invoice.is_overdue %}
+                                (–ü—Ä–æ—Å—Ä–æ—á–µ–Ω)
+                            {% endif %}
+                        </td>
+                    </tr>
+                {% empty %}
+                    <tr>
+                        <td colspan="7">–ù–µ—Ç –∏–Ω–≤–æ–π—Å–æ–≤</td>
+                    </tr>
+                {% endfor %}
+            </table>
+            <h4>–ü–ª–∞—Ç–µ–∂–∏</h4>
+            <table>
+                <tr>
+                    <th>ID –ø–ª–∞—Ç–µ–∂–∞</th>
+                    <th>–°—É–º–º–∞</th>
+                    <th>–¢–∏–ø</th>
+                    <th>–° –±–∞–ª–∞–Ω—Å–∞</th>
+                    <th>–° –Ω–∞–ª–∏—á–Ω–æ–≥–æ</th>
+                    <th>–ò–Ω–≤–æ–π—Å</th>
+                    <th>–î–∞—Ç–∞</th>
+                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
+                </tr>
+                {% for payment in balance_details.payments %}
+                    <tr>
+                        <td>{{ payment.payment_id }}</td>
+                        <td>{{ payment.amount }}</td>
+                        <td>{{ payment.payment_type }}</td>
+                        <td>{{ payment.from_balance|yesno:"–î–∞,–ù–µ—Ç" }}</td>
+                        <td>{{ payment.from_cash_balance|yesno:"–î–∞,–ù–µ—Ç" }}</td>
+                        <td>{{ payment.invoice_number }}</td>
+                        <td>{{ payment.date }}</td>
+                        <td>{{ payment.description|default:"-" }}</td>
+                    </tr>
+                {% empty %}
+                    <tr>
+                        <td colspan="8">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td>
+                    </tr>
+                {% endfor %}
+            </table>
+        </div>
+    {% endif %}
+{% endblock %}
+
diff --git a/templates/admin/core/autotransport/change_form.html b/templates/admin/core/autotransport/change_form.html
new file mode 100644
index 0000000..0b77459
--- /dev/null
+++ b/templates/admin/core/autotransport/change_form.html
@@ -0,0 +1,454 @@
+{% extends "admin/change_form.html" %}
+{% load i18n admin_urls static %}
+
+{% block extrahead %}
+{{ block.super }}
+<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
+<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
+<link href="{% static 'css/autotransport.css' %}?v=4" rel="stylesheet">
+{% endblock %}
+
+{% block content %}
+<div class="autotransport-page-header">
+    <h1>
+        {% if add %}üöõ –ù–æ–≤—ã–π –∞–≤—Ç–æ–≤–æ–∑{% else %}üöõ –ê–≤—Ç–æ–≤–æ–∑ {{ original.number }}{% endif %}
+    </h1>
+    <a href="{% url 'admin:core_autotransport_changelist' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
+</div>
+
+<form method="post" id="{{ opts.model_name }}_form" enctype="multipart/form-data" novalidate>
+{% csrf_token %}
+{% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
+{% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
+
+<div class="autotransport-grid">
+    <div class="main-content">
+        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–µ -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üöö</span>
+                <h2>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</h2>
+                {% if original %}
+                <span class="status-badge status-{{ original.status|lower }}">{{ original.get_status_display }}</span>
+                {% endif %}
+            </div>
+            <div class="card-body">
+                <div class="form-row-2">
+                    <div class="form-group">
+                        <label>–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫ *</label>
+                        {{ adminform.form.carrier }}
+                    </div>
+                    <div class="form-group">
+                        <label>EORI –∫–æ–¥</label>
+                        {{ adminform.form.eori_code }}
+                        <div class="form-hint">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞</div>
+                    </div>
+                </div>
+            </div>
+        </div>
+
+        <!-- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –≤–æ–¥–∏—Ç–µ–ª—å -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üöõ</span>
+                <h2>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –≤–æ–¥–∏—Ç–µ–ª—å</h2>
+            </div>
+            <div class="card-body">
+                <div class="form-row-2" style="margin-bottom: 20px;">
+                    <div class="form-group">
+                        <label>–ê–≤—Ç–æ–≤–æ–∑</label>
+                        {{ adminform.form.truck }}
+                        <div class="form-hint">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</div>
+                    </div>
+                    <div class="form-group">
+                        <label>–í–æ–¥–∏—Ç–µ–ª—å</label>
+                        {{ adminform.form.driver }}
+                        <div class="form-hint">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</div>
+                    </div>
+                </div>
+
+                <div class="form-row-2" style="margin-bottom: 20px;">
+                    <div class="form-group">
+                        <label>–ù–æ–º–µ—Ä —Ç—è–≥–∞—á–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</label>
+                        {{ adminform.form.truck_number_manual }}
+                    </div>
+                    <div class="form-group">
+                        <label>–ù–æ–º–µ—Ä –ø—Ä–∏—Ü–µ–ø–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</label>
+                        {{ adminform.form.trailer_number_manual }}
+                    </div>
+                </div>
+
+                <div class="form-row-2">
+                    <div class="form-group">
+                        <label>–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</label>
+                        {{ adminform.form.driver_name_manual }}
+                    </div>
+                    <div class="form-group">
+                        <label>–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è</label>
+                        {{ adminform.form.driver_phone }}
+                        <div class="form-hint">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é</div>
+                    </div>
+                </div>
+            </div>
+        </div>
+
+        <!-- –ú–∞—Ä—à—Ä—É—Ç -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üõ£Ô∏è</span>
+                <h2>–ú–∞—Ä—à—Ä—É—Ç</h2>
+            </div>
+            <div class="card-body">
+                <div class="form-group">
+                    <label>–ì—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</label>
+                    {{ adminform.form.border_crossing }}
+                    <div class="form-hint">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å - —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∂–µ—Ç —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã</div>
+                </div>
+            </div>
+        </div>
+
+        <!-- –î–∞—Ç—ã -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üìÖ</span>
+                <h2>–î–∞—Ç—ã</h2>
+            </div>
+            <div class="card-body">
+                <div class="form-row">
+                    <div class="form-group">
+                        <label>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</label>
+                        {{ adminform.form.loading_date }}
+                    </div>
+                    <div class="form-group">
+                        <label>–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
+                        {{ adminform.form.departure_date }}
+                    </div>
+                </div>
+                <div class="form-row-2">
+                    <div class="form-group">
+                        <label>–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</label>
+                        {{ adminform.form.estimated_delivery_date }}
+                    </div>
+                    <div class="form-group">
+                        <label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</label>
+                        {{ adminform.form.actual_delivery_date }}
+                    </div>
+                </div>
+            </div>
+        </div>
+
+        <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üöó</span>
+                <h2>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –∞–≤—Ç–æ–≤–æ–∑–µ</h2>
+                {% if original %}
+                <span class="cars-count-badge">{{ original.cars_count }} –∞–≤—Ç–æ</span>
+                {% endif %}
+            </div>
+            <div class="card-body">
+                <div class="cars-hint">
+                    üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å VIN –∏–ª–∏ –º–∞—Ä–∫—É - –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã!
+                </div>
+                <select name="cars" id="cars_select" multiple="multiple" style="width: 100%;">
+                    {% for car in cars %}
+                    <option value="{{ car.pk }}" data-status="{{ car.status }}" {% if original and car.pk in selected_car_ids %}selected{% endif %}>{{ car.brand }} {{ car.year }} ({{ car.vin }}) {% if car.client %}- {{ car.client.name }}{% endif %}</option>
+                    {% endfor %}
+                </select>
+            </div>
+        </div>
+
+        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üìù</span>
+                <h2>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</h2>
+            </div>
+            <div class="card-body">
+                <div class="form-group">
+                    {{ adminform.form.notes }}
+                </div>
+            </div>
+        </div>
+    </div>
+
+    <div class="sidebar">
+        {% if original %}
+        <div class="card">
+            <div class="card-body">
+                <div class="autotransport-number-display">
+                    <div class="label">–ù–æ–º–µ—Ä –∞–≤—Ç–æ–≤–æ–∑–∞</div>
+                    <div class="number">{{ original.number }}</div>
+                </div>
+                
+                <div class="info-grid">
+                    <div class="info-item">
+                        <div class="label">–ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π</div>
+                        <div class="value">{{ original.cars_count }}</div>
+                    </div>
+                    <div class="info-row">
+                        <div class="info-item">
+                            <div class="label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
+                            <div class="value">{{ original.get_clients|length }}</div>
+                        </div>
+                        <div class="info-item">
+                            <div class="label">–ò–Ω–≤–æ–π—Å–æ–≤</div>
+                            <div class="value">{{ original.invoices.count }}</div>
+                        </div>
+                    </div>
+                </div>
+            </div>
+        </div>
+
+        {% if original.invoices.exists %}
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üìÑ</span>
+                <h2>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã</h2>
+            </div>
+            <div class="card-body">
+                {% for invoice in original.invoices.all %}
+                <div class="invoice-link-item">
+                    <div>
+                        <div class="invoice-number">{{ invoice.number }}</div>
+                        <div class="invoice-client">{{ invoice.recipient_client.name }}</div>
+                    </div>
+                    <div class="invoice-amount">{{ invoice.total|floatformat:2 }} ‚Ç¨</div>
+                    <a href="{% url 'admin:core_newinvoice_change' invoice.pk %}" class="invoice-link-btn">‚Üí</a>
+                </div>
+                {% endfor %}
+            </div>
+        </div>
+        {% endif %}
+        {% else %}
+        <div class="card">
+            <div class="card-body">
+                <div class="autotransport-number-display">
+                    <div class="label">–ù–æ–≤—ã–π –∞–≤—Ç–æ–≤–æ–∑</div>
+                    <div class="number" style="font-size:18px;">–ù–æ–º–µ—Ä –ø—Ä–∏—Å–≤–æ–∏—Ç—Å—è<br>–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
+                </div>
+                <p style="text-align:center;color:var(--gray-600);font-size:14px;margin:0;">–ü–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∏–Ω–≤–æ–π—Å—ã</p>
+            </div>
+        </div>
+        {% endif %}
+
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">‚öôÔ∏è</span>
+                <h2>–°—Ç–∞—Ç—É—Å</h2>
+            </div>
+            <div class="card-body">
+                <div class="form-group">
+                    {{ adminform.form.status }}
+                </div>
+            </div>
+        </div>
+
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">‚ö°</span>
+                <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
+            </div>
+            <div class="card-body">
+                <div class="actions-buttons">
+                    <button type="submit" name="_save" value="1" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
+                    {% if original %}
+                    <button type="submit" name="_continue" value="1" class="btn btn-outline">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
+                    {% else %}
+                    <button type="submit" name="_addanother" value="1" class="btn btn-outline">‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë</button>
+                    {% endif %}
+                    <a href="{% url 'admin:core_autotransport_changelist' %}" class="btn btn-outline">‚úï –û—Ç–º–µ–Ω–∞</a>
+                    {% if original %}
+                    <div class="actions-divider"></div>
+                    <a href="{% url 'admin:core_autotransport_delete' original.pk %}" class="btn btn-danger btn-sm">üóë –£–¥–∞–ª–∏—Ç—å</a>
+                    {% endif %}
+                </div>
+            </div>
+        </div>
+    </div>
+</div>
+
+</form>
+
+<script>
+// –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: Select2 CDN —Ç—Ä–µ–±—É–µ—Ç window.jQuery
+// Django admin –∏—Å–ø–æ–ª—å–∑—É–µ—Ç django.jQuery - —Å–æ–∑–¥–∞–µ–º –º–æ—Å—Ç
+window.jQuery = window.django && window.django.jQuery ? window.django.jQuery : window.jQuery;
+window.$ = window.jQuery;
+console.log('‚úÖ jQuery –º–æ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤–µ—Ä—Å–∏—è:', window.jQuery ? window.jQuery.fn.jquery : '–ù–ï–¢');
+</script>
+<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
+<script>
+// –ò—Å–ø–æ–ª—å–∑—É–µ–º django.jQuery –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π jQuery
+(function($) {
+    if (!$) {
+        console.error('jQuery not found!');
+        return;
+    }
+    
+    $(document).ready(function() {
+        console.log('üöõ AutoTransport JS –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
+
+        // ============================================
+        // 1. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï EORI –ö–û–î–ê –ò–ó –ü–ï–†–ï–í–û–ó–ß–ò–ö–ê
+        // ============================================
+        const carrierSelect = $('#id_carrier');
+        const eoriInput = $('#id_eori_code');
+
+        if (carrierSelect.length && eoriInput.length) {
+            carrierSelect.on('change', function() {
+                const carrierId = $(this).val();
+                if (!carrierId) {
+                    eoriInput.val('');
+                    return;
+                }
+
+                $.ajax({
+                    url: '/core/api/carrier/' + carrierId + '/info/',
+                    method: 'GET',
+                    success: function(data) {
+                        if (data.eori_code) {
+                            eoriInput.val(data.eori_code);
+                        }
+                        
+                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–≤–æ–∑–æ–≤ –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π
+                        updateTrucksList(data.trucks);
+                        updateDriversList(data.drivers);
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞:', error);
+                    }
+                });
+            });
+        }
+
+        // ============================================
+        // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ê–í–¢–û–í–û–ó–û–í
+        // ============================================
+        function updateTrucksList(trucks) {
+            const truckSelect = $('#id_truck');
+            if (!truckSelect.length) return;
+
+            const currentValue = truckSelect.val();
+            truckSelect.empty();
+            truckSelect.append('<option value="">---------</option>');
+
+            trucks.forEach(function(truck) {
+                const option = $('<option></option>')
+                    .val(truck.id)
+                    .text(truck.text);
+                truckSelect.append(option);
+            });
+
+            if (currentValue) {
+                truckSelect.val(currentValue);
+            }
+        }
+
+        // ============================================
+        // 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –í–û–î–ò–¢–ï–õ–ï–ô
+        // ============================================
+        function updateDriversList(drivers) {
+            const driverSelect = $('#id_driver');
+            if (!driverSelect.length) return;
+
+            const currentValue = driverSelect.val();
+            driverSelect.empty();
+            driverSelect.append('<option value="">---------</option>');
+
+            drivers.forEach(function(driver) {
+                const option = $('<option></option>')
+                    .val(driver.id)
+                    .text(driver.text);
+                driverSelect.append(option);
+            });
+
+            if (currentValue) {
+                driverSelect.val(currentValue);
+            }
+        }
+
+        // ============================================
+        // 4. –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ï–õ–ï–§–û–ù–ê –í–û–î–ò–¢–ï–õ–Ø
+        // ============================================
+        const driverSelect = $('#id_driver');
+        const driverPhoneInput = $('#id_driver_phone');
+
+        if (driverSelect.length && driverPhoneInput.length) {
+            driverSelect.on('change', function() {
+                const driverId = $(this).val();
+                if (!driverId) {
+                    return;
+                }
+
+                $.ajax({
+                    url: '/core/api/driver/' + driverId + '/phone/',
+                    method: 'GET',
+                    success: function(data) {
+                        if (data.phone) {
+                            driverPhoneInput.val(data.phone);
+                        }
+                    },
+                    error: function(xhr, status, error) {
+                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è:', error);
+                    }
+                });
+            });
+        }
+
+        // ============================================
+        // 5. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SELECT2 –î–õ–Ø –ê–í–¢–û–ú–û–ë–ò–õ–ï–ô (–ë–ï–ó AJAX, –ö–ê–ö –í –ò–ù–í–û–ô–°–ê–•)
+        // ============================================
+        $('#cars_select').select2({
+            placeholder: '–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ –º–∞—Ä–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞...',
+            allowClear: true,
+            templateResult: function(state) {
+                if (!state.id) return state.text;
+                var status = $(state.element).data('status');
+                var statusLabels = {
+                    'FLOATING': 'üö¢ –í –ø—É—Ç–∏',
+                    'IN_PORT': '‚öì –í –ø–æ—Ä—Ç—É',
+                    'UNLOADED': '‚úÖ –†–∞–∑–≥—Ä—É–∂–µ–Ω',
+                    'TRANSFERRED': 'üì¶ –ü–µ—Ä–µ–¥–∞–Ω'
+                };
+                var statusLabel = statusLabels[status] || '';
+                return $('<span>' + state.text + (statusLabel ? ' <small style="opacity:0.7;">' + statusLabel + '</small>' : '') + '</span>');
+            },
+            templateSelection: function(state) {
+                if (!state.id) return state.text;
+                var status = $(state.element).data('status');
+                return $('<span data-status="' + status + '">' + state.text + '</span>');
+            }
+        });
+        
+        // –î–æ–±–∞–≤–ª—è–µ–º data-status –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ç–µ–≥–∞–º
+        $('#cars_select').on('select2:select', function(e) {
+            var status = $(e.params.data.element).data('status');
+            setTimeout(function() {
+                $('.select2-selection__choice').each(function() {
+                    var $choice = $(this);
+                    var $span = $choice.find('span[data-status]');
+                    if ($span.length) {
+                        $choice.attr('data-status', $span.data('status'));
+                    }
+                });
+            }, 10);
+        });
+        
+        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
+        setTimeout(function() {
+            $('.select2-selection__choice').each(function() {
+                var $choice = $(this);
+                var $span = $choice.find('span[data-status]');
+                if ($span.length) {
+                    $choice.attr('data-status', $span.data('status'));
+                }
+            });
+        }, 100);
+
+        console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ AutoTransport –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
+    });
+
+})(django.jQuery || jQuery || $);
+</script>
+{% endblock %}
diff --git a/templates/admin/core/autotransport/change_form_backup.html b/templates/admin/core/autotransport/change_form_backup.html
new file mode 100644
index 0000000..b8bd8ae
--- /dev/null
+++ b/templates/admin/core/autotransport/change_form_backup.html
@@ -0,0 +1,873 @@
+{% extends "admin/change_form.html" %}
+{% load i18n admin_urls static %}
+
+{% block extrahead %}
+{{ block.super }}
+<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
+<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
+<style>
+    :root {
+        --primary: #667eea;
+        --primary-dark: #5a67d8;
+        --success: #28a745;
+        --danger: #dc3545;
+        --warning: #ffc107;
+        --info: #17a2b8;
+        --gray-100: #f8f9fa;
+        --gray-200: #e9ecef;
+        --gray-300: #dee2e6;
+        --gray-600: #6c757d;
+        --gray-800: #343a40;
+        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
+        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
+    }
+    
+    body { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); min-height: 100vh; }
+    .breadcrumbs { display: none; }
+    #content { padding: 30px; max-width: 1400px; margin: 0 auto; }
+    
+    .invoice-page-header {
+        display: flex;
+        justify-content: space-between;
+        align-items: center;
+        margin-bottom: 30px;
+    }
+    
+    .invoice-page-header h1 {
+        font-size: 28px;
+        font-weight: 700;
+        color: var(--gray-800);
+        margin: 0;
+    }
+    
+    .back-link {
+        display: inline-flex;
+        align-items: center;
+        gap: 8px;
+        color: var(--gray-600);
+        text-decoration: none;
+        font-size: 14px;
+        padding: 8px 16px;
+        background: white;
+        border-radius: 8px;
+        box-shadow: var(--shadow);
+    }
+    
+    .back-link:hover { color: var(--primary); }
+    
+    .invoice-grid {
+        display: grid;
+        grid-template-columns: 1fr 350px;
+        gap: 30px;
+    }
+    
+    .card {
+        background: white;
+        border-radius: 16px;
+        box-shadow: var(--shadow);
+        overflow: hidden;
+        margin-bottom: 25px;
+    }
+    
+    .card-header {
+        padding: 20px 25px;
+        border-bottom: 1px solid var(--gray-200);
+        display: flex;
+        align-items: center;
+        gap: 12px;
+    }
+    
+    .card-header h2 {
+        font-size: 18px;
+        font-weight: 600;
+        color: var(--gray-800);
+        margin: 0;
+    }
+    
+    .card-header .icon { font-size: 24px; }
+    .card-body { padding: 25px; }
+    
+    .status-badge {
+        display: inline-flex;
+        padding: 6px 14px;
+        border-radius: 20px;
+        font-size: 13px;
+        font-weight: 600;
+        margin-left: auto;
+    }
+    
+    .status-draft { background: var(--gray-200); color: var(--gray-600); }
+    .status-issued { background: #cce5ff; color: #004085; }
+    .status-partially_paid { background: #fff3cd; color: #856404; }
+    .status-paid { background: #d4edda; color: #155724; }
+    .status-overdue { background: #f8d7da; color: #721c24; }
+    
+    .invoice-number-display {
+        background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
+        color: white;
+        padding: 25px;
+        text-align: center;
+        margin: -25px -25px 25px -25px;
+    }
+    
+    .invoice-number-display .label {
+        font-size: 12px;
+        text-transform: uppercase;
+        letter-spacing: 1px;
+        opacity: 0.8;
+        margin-bottom: 8px;
+    }
+    
+    .invoice-number-display .number {
+        font-size: 28px;
+        font-weight: 700;
+        letter-spacing: 2px;
+    }
+    
+    .financial-grid { display: grid; gap: 12px; margin-bottom: 20px; }
+    
+    .financial-item {
+        background: var(--gray-100);
+        padding: 15px;
+        border-radius: 10px;
+        text-align: center;
+    }
+    
+    .financial-item.highlight {
+        background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
+        color: white;
+    }
+    
+    .financial-item .label {
+        font-size: 11px;
+        text-transform: uppercase;
+        color: var(--gray-600);
+        margin-bottom: 5px;
+    }
+    
+    .financial-item.highlight .label { color: rgba(255,255,255,0.8); }
+    
+    .financial-item .value {
+        font-size: 24px;
+        font-weight: 700;
+        color: var(--gray-800);
+    }
+    
+    .financial-item.highlight .value { color: white; }
+    .financial-item.success .value { color: var(--success); }
+    .financial-item.danger .value { color: var(--danger); }
+    
+    .financial-row {
+        display: grid;
+        grid-template-columns: 1fr 1fr;
+        gap: 12px;
+    }
+    
+    .form-group { margin-bottom: 20px; }
+    .form-group:last-child { margin-bottom: 0; }
+    
+    .form-group label {
+        display: block;
+        font-size: 12px;
+        font-weight: 600;
+        color: var(--gray-600);
+        margin-bottom: 8px;
+        text-transform: uppercase;
+    }
+    
+    .form-group input,
+    .form-group select,
+    .form-group textarea {
+        width: 100%;
+        padding: 12px 16px;
+        border: 2px solid var(--gray-200);
+        border-radius: 10px;
+        font-size: 15px;
+        box-sizing: border-box;
+        height: 48px;
+    }
+    
+    .form-group select {
+        appearance: none;
+        background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 16px center;
+        padding-right: 40px;
+    }
+    
+    .form-group input:focus,
+    .form-group select:focus,
+    .form-group textarea:focus {
+        outline: none;
+        border-color: var(--primary);
+        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
+    }
+    
+    .form-group textarea { min-height: 100px; height: auto; }
+    
+    .form-row {
+        display: grid;
+        grid-template-columns: 1fr 1fr 1fr;
+        gap: 15px;
+    }
+    
+    .form-row-2 {
+        display: grid;
+        grid-template-columns: 1fr 1fr;
+        gap: 15px;
+    }
+    
+    .form-hint {
+        font-size: 11px;
+        color: #999;
+        margin-top: 5px;
+    }
+    
+    .cars-hint {
+        display: flex;
+        align-items: center;
+        gap: 10px;
+        padding: 12px 15px;
+        background: #e7f3ff;
+        border-radius: 8px;
+        font-size: 13px;
+        color: #004085;
+        margin-bottom: 15px;
+    }
+    
+    .cars-selector { background: var(--gray-100); border-radius: 12px; padding: 20px; }
+    
+    .cars-list {
+        display: flex;
+        flex-wrap: wrap;
+        gap: 8px;
+        min-height: 50px;
+        padding: 10px;
+        background: white;
+        border-radius: 8px;
+        border: 2px solid var(--gray-200);
+    }
+    
+    .car-tag {
+        display: inline-flex;
+        align-items: center;
+        gap: 8px;
+        padding: 8px 12px;
+        background: var(--primary);
+        color: white;
+        border-radius: 6px;
+        font-size: 13px;
+        font-weight: 500;
+    }
+    
+    .car-tag .remove {
+        cursor: pointer;
+        opacity: 0.8;
+    }
+    
+    .car-tag .remove:hover { opacity: 1; }
+    
+    .items-table {
+        width: 100%;
+        border-collapse: separate;
+        border-spacing: 0;
+    }
+    
+    .items-table th {
+        background: var(--gray-100);
+        padding: 12px 15px;
+        text-align: left;
+        font-size: 12px;
+        font-weight: 600;
+        text-transform: uppercase;
+        color: var(--gray-600);
+    }
+    
+    .items-table th:first-child { border-radius: 10px 0 0 10px; }
+    .items-table th:last-child { border-radius: 0 10px 10px 0; text-align: right; }
+    
+    .items-table td {
+        padding: 14px 15px;
+        border-bottom: 1px solid var(--gray-200);
+    }
+    
+    .items-table td:last-child { text-align: right; font-weight: 600; }
+    .items-table tr:last-child td { border-bottom: none; }
+    
+    .items-table input {
+        padding: 8px 12px;
+        border: 2px solid var(--gray-200);
+        border-radius: 6px;
+        font-size: 14px;
+    }
+    
+    .items-table input[type="number"] { width: 80px; text-align: right; }
+    .items-table input[type="text"] { width: 100%; }
+    
+    .add-item-btn {
+        display: inline-flex;
+        align-items: center;
+        gap: 8px;
+        padding: 10px 20px;
+        background: var(--gray-100);
+        color: var(--primary);
+        border: none;
+        border-radius: 8px;
+        font-weight: 500;
+        cursor: pointer;
+        margin-top: 15px;
+    }
+    
+    .add-item-btn:hover { background: var(--primary); color: white; }
+    
+    .btn {
+        display: inline-flex;
+        align-items: center;
+        justify-content: center;
+        gap: 8px;
+        padding: 12px 20px;
+        border-radius: 10px;
+        font-size: 14px;
+        font-weight: 600;
+        text-decoration: none;
+        cursor: pointer;
+        border: none;
+        width: 100%;
+        box-sizing: border-box;
+    }
+    
+    .btn-primary {
+        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
+        color: white;
+        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
+    }
+    
+    .btn-primary:hover {
+        transform: translateY(-2px);
+        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.45);
+        color: white;
+    }
+    
+    .btn-success {
+        background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
+        color: white;
+    }
+    
+    .btn-success:hover { color: white; }
+    
+    .btn-outline {
+        background: white;
+        color: var(--gray-600);
+        border: 2px solid var(--gray-300);
+    }
+    
+    .btn-outline:hover {
+        border-color: var(--primary);
+        color: var(--primary);
+    }
+    
+    .btn-danger { background: var(--danger); color: white; }
+    .btn-sm { padding: 10px 16px; font-size: 13px; }
+    
+    .actions-buttons {
+        display: flex;
+        flex-direction: column;
+        gap: 10px;
+    }
+    
+    .actions-divider {
+        height: 1px;
+        background: var(--gray-200);
+        margin: 10px 0;
+    }
+    
+    .empty-state {
+        text-align: center;
+        padding: 40px 20px;
+        color: var(--gray-600);
+    }
+    
+    .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
+    
+    .select2-container { width: 100% !important; }
+    
+    .select2-container--default .select2-selection--single {
+        height: 48px !important;
+        border: 2px solid var(--gray-200) !important;
+        border-radius: 10px !important;
+        padding: 8px 16px !important;
+    }
+    
+    .select2-container--default .select2-selection--single .select2-selection__rendered {
+        line-height: 30px !important;
+        padding-left: 0 !important;
+    }
+    
+    .select2-container--default .select2-selection--single .select2-selection__arrow {
+        height: 46px !important;
+    }
+    
+    .select2-container--default .select2-selection--multiple {
+        border: 2px solid var(--gray-200) !important;
+        border-radius: 10px !important;
+        padding: 10px 12px !important;
+        min-height: 80px !important;
+        max-height: 300px !important;
+        overflow-y: auto !important;
+    }
+    
+    .select2-container--default .select2-selection--multiple .select2-selection__choice {
+        border: none !important;
+        border-radius: 8px !important;
+        color: white !important;
+        padding: 6px 12px 6px 8px !important;
+        margin: 4px !important;
+        font-size: 13px !important;
+        font-weight: 500 !important;
+        max-width: calc(100% - 16px) !important;
+        white-space: nowrap !important;
+        overflow: hidden !important;
+        text-overflow: ellipsis !important;
+        line-height: 1.4 !important;
+        display: inline-flex !important;
+        align-items: center !important;
+        gap: 0 !important;
+    }
+    
+    .select2-container--default .select2-selection--multiple .select2-selection__choice span {
+        overflow: hidden !important;
+        text-overflow: ellipsis !important;
+    }
+    
+    /* –¶–≤–µ—Ç–∞ —Ç–µ–≥–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è */
+    .select2-selection__choice[data-status="FLOATING"] {
+        background: linear-gradient(135deg, #2772a8 0%, #1e5a8a 100%) !important;
+    }
+    .select2-selection__choice[data-status="IN_PORT"] {
+        background: linear-gradient(135deg, #8B0000 0%, #6B0000 100%) !important;
+    }
+    .select2-selection__choice[data-status="UNLOADED"] {
+        background: linear-gradient(135deg, #239f58 0%, #1a7a43 100%) !important;
+    }
+    .select2-selection__choice[data-status="TRANSFERRED"] {
+        background: linear-gradient(135deg, #78458c 0%, #5a3369 100%) !important;
+    }
+    /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω */
+    .select2-selection__choice:not([data-status]) {
+        background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%) !important;
+    }
+    
+    /* –¶–≤–µ—Ç–∞ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ */
+    .select2-results__option[data-status="FLOATING"] { border-left: 4px solid #2772a8; }
+    .select2-results__option[data-status="IN_PORT"] { border-left: 4px solid #8B0000; }
+    .select2-results__option[data-status="UNLOADED"] { border-left: 4px solid #239f58; }
+    .select2-results__option[data-status="TRANSFERRED"] { border-left: 4px solid #78458c; }
+    
+    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
+        color: rgba(255,255,255,0.9) !important;
+        font-size: 16px !important;
+        font-weight: bold !important;
+        border: none !important;
+        background: rgba(0,0,0,0.15) !important;
+        border-radius: 50% !important;
+        outline: none !important;
+        box-shadow: none !important;
+        width: 20px !important;
+        height: 20px !important;
+        display: inline-flex !important;
+        align-items: center !important;
+        justify-content: center !important;
+        cursor: pointer !important;
+        flex-shrink: 0 !important;
+        margin-right: 8px !important;
+        position: relative !important;
+        top: 0 !important;
+    }
+    
+    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
+        color: #ff6b6b !important;
+        background: transparent !important;
+        border: none !important;
+    }
+    
+    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:focus {
+        outline: none !important;
+        border: none !important;
+        box-shadow: none !important;
+    }
+    
+    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ–∏—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ multiple select */
+    .select2-container--default .select2-selection--multiple .select2-search--inline .select2-search__field {
+        margin-top: 8px !important;
+        font-size: 14px !important;
+    }
+    
+    .select2-dropdown {
+        border: 2px solid var(--gray-200) !important;
+        border-radius: 10px !important;
+        box-shadow: var(--shadow-lg) !important;
+    }
+    
+    .select2-results__option--highlighted { background-color: var(--primary) !important; }
+    
+    @media (max-width: 1200px) {
+        .invoice-grid { grid-template-columns: 1fr; }
+    }
+    
+    @media (max-width: 768px) {
+        .form-row, .form-row-2 { grid-template-columns: 1fr; }
+    }
+</style>
+{% endblock %}
+
+{% block content %}
+<div class="invoice-page-header">
+    <h1>
+        {% if add %}üìù –ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å{% else %}üìÑ –ò–Ω–≤–æ–π—Å {{ original.number }}{% endif %}
+    </h1>
+    <a href="{% url 'admin:core_newinvoice_changelist' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
+</div>
+
+<form method="post" id="{{ opts.model_name }}_form" enctype="multipart/form-data" novalidate>
+{% csrf_token %}
+{% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
+{% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
+
+<div class="invoice-grid">
+    <div class="main-content">
+        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üìã</span>
+                <h2>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
+                {% if original %}
+                <span class="status-badge status-{{ original.status|lower }}">{{ original.get_status_display }}</span>
+                {% endif %}
+            </div>
+            <div class="card-body">
+                <div class="form-row" style="margin-bottom: 20px;">
+                    <div class="form-group">
+                        <label>–î–∞—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è</label>
+                        <input type="date" name="date" value="{% if original %}{{ original.date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" required>
+                    </div>
+                    <div class="form-group">
+                        <label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label>
+                        <input type="date" name="due_date" value="{% if original %}{{ original.due_date|date:'Y-m-d' }}{% endif %}">
+                    </div>
+                    <div class="form-group">
+                        <label>–°—Ç–∞—Ç—É—Å</label>
+                        <select name="status">
+                            <option value="DRAFT" {% if original.status == 'DRAFT' %}selected{% endif %}>–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
+                            <option value="ISSUED" {% if original.status == 'ISSUED' or not original %}selected{% endif %}>–í—ã—Å—Ç–∞–≤–ª–µ–Ω</option>
+                            <option value="PARTIALLY_PAID" {% if original.status == 'PARTIALLY_PAID' %}selected{% endif %}>–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω</option>
+                            <option value="PAID" {% if original.status == 'PAID' %}selected{% endif %}>–û–ø–ª–∞—á–µ–Ω</option>
+                            <option value="OVERDUE" {% if original.status == 'OVERDUE' %}selected{% endif %}>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</option>
+                            <option value="CANCELLED" {% if original.status == 'CANCELLED' %}selected{% endif %}>–û—Ç–º–µ–Ω—ë–Ω</option>
+                        </select>
+                    </div>
+                </div>
+                
+                <div class="form-row-2">
+                    <div class="form-group">
+                        <label>üè¢ –í—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—å</label>
+                        <select name="issuer" id="issuer_select">
+                            {% if original.issuer_company %}
+                            <option value="company_{{ original.issuer_company.pk }}" selected>üè¢ {{ original.issuer_company.name }}</option>
+                            {% elif original.issuer_warehouse %}
+                            <option value="warehouse_{{ original.issuer_warehouse.pk }}" selected>üè≠ {{ original.issuer_warehouse.name }}</option>
+                            {% elif original.issuer_line %}
+                            <option value="line_{{ original.issuer_line.pk }}" selected>üö¢ {{ original.issuer_line.name }}</option>
+                            {% elif original.issuer_carrier %}
+                            <option value="carrier_{{ original.issuer_carrier.pk }}" selected>üöö {{ original.issuer_carrier.name }}</option>
+                            {% elif default_company_id %}
+                            <option value="company_{{ default_company_id }}" selected>üè¢ Caromoto Lithuania</option>
+                            {% endif %}
+                        </select>
+                        <div class="form-hint">–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º, —Å–∫–ª–∞–¥–∞–º, –ª–∏–Ω–∏—è–º, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞–º</div>
+                    </div>
+                    <div class="form-group">
+                        <label>üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
+                        <select name="recipient" id="recipient_select">
+                            {% if original.recipient_client %}
+                            <option value="client_{{ original.recipient_client.pk }}" selected>üë§ {{ original.recipient_client.name }}</option>
+                            {% elif original.recipient_company %}
+                            <option value="company_{{ original.recipient_company.pk }}" selected>üè¢ {{ original.recipient_company.name }}</option>
+                            {% elif original.recipient_warehouse %}
+                            <option value="warehouse_{{ original.recipient_warehouse.pk }}" selected>üè≠ {{ original.recipient_warehouse.name }}</option>
+                            {% elif original.recipient_line %}
+                            <option value="line_{{ original.recipient_line.pk }}" selected>üö¢ {{ original.recipient_line.name }}</option>
+                            {% elif original.recipient_carrier %}
+                            <option value="carrier_{{ original.recipient_carrier.pk }}" selected>üöö {{ original.recipient_carrier.name }}</option>
+                            {% endif %}
+                        </select>
+                        <div class="form-hint">–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º, –∫–æ–º–ø–∞–Ω–∏—è–º, —Å–∫–ª–∞–¥–∞–º, –ª–∏–Ω–∏—è–º, –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞–º</div>
+                    </div>
+                </div>
+            </div>
+        </div>
+        
+        <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üöó</span>
+                <h2>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</h2>
+            </div>
+            <div class="card-body">
+                <div class="cars-hint">
+                    üí° –í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ ‚Äî –ø–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏—Ö —É—Å–ª—É–≥!
+                </div>
+                <select name="cars" id="cars_select" multiple="multiple" style="width: 100%;">
+                    {% for car in cars %}
+                    <option value="{{ car.pk }}" data-status="{{ car.status }}" {% if original and car.pk in selected_car_ids %}selected{% endif %}>{{ car.brand }} {{ car.year }} ({{ car.vin }}) {% if car.client %}- {{ car.client.name }}{% endif %}</option>
+                    {% endfor %}
+                </select>
+            </div>
+        </div>
+        
+        <!-- –ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞ -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üì¶</span>
+                <h2>–ü–æ–∑–∏—Ü–∏–∏ –∏–Ω–≤–æ–π—Å–∞</h2>
+            </div>
+            <div class="card-body">
+                {% if original and original.items.exists %}
+                <table class="items-table">
+                    <thead>
+                        <tr>
+                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
+                            <th>–ö–æ–ª-–≤–æ</th>
+                            <th>–¶–µ–Ω–∞</th>
+                            <th>–°—É–º–º–∞</th>
+                        </tr>
+                    </thead>
+                    <tbody id="items-tbody">
+                        {% for item in original.items.all %}
+                        <tr>
+                            <td>{{ item.description }}{% if item.car %}<br><small style="color:#999;">üöó {{ item.car.vin }}</small>{% endif %}</td>
+                            <td>{{ item.quantity }}</td>
+                            <td>{{ item.unit_price|floatformat:2 }} ‚Ç¨</td>
+                            <td>{{ item.total_price|floatformat:2 }} ‚Ç¨</td>
+                        </tr>
+                        {% endfor %}
+                    </tbody>
+                </table>
+                {% else %}
+                <div class="empty-state">
+                    <div class="icon">üìã</div>
+                    <p>–ü–æ–∑–∏—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏</p>
+                </div>
+                {% endif %}
+            </div>
+        </div>
+        
+        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üìù</span>
+                <h2>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</h2>
+            </div>
+            <div class="card-body">
+                <div class="form-group">
+                    <textarea name="notes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">{% if original %}{{ original.notes }}{% endif %}</textarea>
+                </div>
+            </div>
+        </div>
+    </div>
+    
+    <div class="sidebar">
+        {% if original %}
+        <div class="card">
+            <div class="card-body">
+                <div class="invoice-number-display">
+                    <div class="label">–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞</div>
+                    <div class="number">{{ original.number }}</div>
+                </div>
+                
+                <div class="financial-grid">
+                    <div class="financial-item highlight">
+                        <div class="label">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</div>
+                        <div class="value">{{ original.total|floatformat:2 }} ‚Ç¨</div>
+                    </div>
+                    <div class="financial-row">
+                        <div class="financial-item success">
+                            <div class="label">–û–ø–ª–∞—á–µ–Ω–æ</div>
+                            <div class="value">{{ original.paid_amount|floatformat:2 }} ‚Ç¨</div>
+                        </div>
+                        <div class="financial-item {% if original.remaining_amount > 0 %}danger{% else %}success{% endif %}">
+                            <div class="label">–û—Å—Ç–∞—Ç–æ–∫</div>
+                            <div class="value">{{ original.remaining_amount|floatformat:2 }} ‚Ç¨</div>
+                        </div>
+                    </div>
+                </div>
+                
+                {% if original.status in 'ISSUED,PARTIALLY_PAID,OVERDUE' %}
+                <a href="{% url 'admin:pay_invoice' original.pk %}" class="btn btn-success">üí≥ –ü—Ä–æ–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É</a>
+                {% endif %}
+            </div>
+        </div>
+        
+        {% if original.transactions.exists %}
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">üí≥</span>
+                <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h2>
+            </div>
+            <div class="card-body">
+                {% for trx in original.transactions.all %}
+                <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--gray-100);">
+                    <div>
+                        <div style="font-size:12px;color:var(--gray-600);">{{ trx.date|date:"d.m.Y H:i" }}</div>
+                        <div style="font-weight:500;">{{ trx.get_method_display }}</div>
+                    </div>
+                    <div style="font-size:16px;font-weight:700;color:var(--success);">+{{ trx.amount|floatformat:2 }} ‚Ç¨</div>
+                </div>
+                {% endfor %}
+            </div>
+        </div>
+        {% endif %}
+        {% else %}
+        <div class="card">
+            <div class="card-body">
+                <div class="invoice-number-display">
+                    <div class="label">–ù–æ–≤—ã–π –∏–Ω–≤–æ–π—Å</div>
+                    <div class="number" style="font-size:18px;">–ù–æ–º–µ—Ä –ø—Ä–∏—Å–≤–æ–∏—Ç—Å—è<br>–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
+                </div>
+                <p style="text-align:center;color:var(--gray-600);font-size:14px;margin:0;">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É</p>
+            </div>
+        </div>
+        {% endif %}
+        
+        <div class="card">
+            <div class="card-header">
+                <span class="icon">‚ö°</span>
+                <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
+            </div>
+            <div class="card-body">
+                <div class="actions-buttons">
+                    <button type="submit" name="_save" value="1" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
+                    {% if original %}
+                    <button type="submit" name="_continue" value="1" class="btn btn-outline">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
+                    {% else %}
+                    <button type="submit" name="_addanother" value="1" class="btn btn-outline">‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë</button>
+                    {% endif %}
+                    <a href="{% url 'admin:core_newinvoice_changelist' %}" class="btn btn-outline">‚úï –û—Ç–º–µ–Ω–∞</a>
+                    {% if original %}
+                    <div class="actions-divider"></div>
+                    <a href="{% url 'admin:core_newinvoice_delete' original.pk %}" class="btn btn-danger btn-sm">üóë –£–¥–∞–ª–∏—Ç—å</a>
+                    {% endif %}
+                </div>
+            </div>
+        </div>
+    </div>
+</div>
+
+<!-- Hidden fields for financial data -->
+<input type="hidden" name="subtotal" value="{% if original %}{{ original.subtotal }}{% else %}0{% endif %}">
+<input type="hidden" name="discount" value="{% if original %}{{ original.discount }}{% else %}0{% endif %}">
+<input type="hidden" name="tax" value="{% if original %}{{ original.tax }}{% else %}0{% endif %}">
+<input type="hidden" name="total" value="{% if original %}{{ original.total }}{% else %}0{% endif %}">
+<input type="hidden" name="paid_amount" value="{% if original %}{{ original.paid_amount }}{% else %}0{% endif %}">
+
+<!-- Entity references are now handled via issuer/recipient fields with type prefixes -->
+
+</form>
+
+<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
+<script>
+// –ò—Å–ø–æ–ª—å–∑—É–µ–º django.jQuery –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π jQuery
+(function($) {
+    if (!$) {
+        console.error('jQuery not found!');
+        return;
+    }
+    
+    $(document).ready(function() {
+    // AJAX –ø–æ–∏—Å–∫ –¥–ª—è –≤—ã—Å—Ç–∞–≤–∏—Ç–µ–ª—è
+    $('#issuer_select').select2({
+        placeholder: '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ...',
+        allowClear: true,
+        minimumInputLength: 1,
+        ajax: {
+            url: '/core/api/search-counterparties/',
+            dataType: 'json',
+            delay: 250,
+            data: function(params) {
+                return { q: params.term };
+            },
+            processResults: function(data) {
+                return { results: data.results };
+            },
+            cache: true
+        }
+    });
+    
+    // AJAX –ø–æ–∏—Å–∫ –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
+    $('#recipient_select').select2({
+        placeholder: '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ...',
+        allowClear: true,
+        minimumInputLength: 1,
+        ajax: {
+            url: '/core/api/search-counterparties/',
+            dataType: 'json',
+            delay: 250,
+            data: function(params) {
+                return { q: params.term };
+            },
+            processResults: function(data) {
+                return { results: data.results };
+            },
+            cache: true
+        }
+    });
+    
+    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å —Ü–≤–µ—Ç–∞–º–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
+    $('#cars_select').select2({
+        placeholder: '–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ –º–∞—Ä–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞...',
+        allowClear: true,
+        templateResult: function(state) {
+            if (!state.id) return state.text;
+            var status = $(state.element).data('status');
+            var statusLabels = {
+                'FLOATING': 'üö¢ –í –ø—É—Ç–∏',
+                'IN_PORT': '‚öì –í –ø–æ—Ä—Ç—É',
+                'UNLOADED': '‚úÖ –†–∞–∑–≥—Ä—É–∂–µ–Ω',
+                'TRANSFERRED': 'üì¶ –ü–µ—Ä–µ–¥–∞–Ω'
+            };
+            var statusLabel = statusLabels[status] || '';
+            return $('<span>' + state.text + (statusLabel ? ' <small style="opacity:0.7;">' + statusLabel + '</small>' : '') + '</span>');
+        },
+        templateSelection: function(state) {
+            if (!state.id) return state.text;
+            var status = $(state.element).data('status');
+            return $('<span data-status="' + status + '">' + state.text + '</span>');
+        }
+    });
+    
+    // –î–æ–±–∞–≤–ª—è–µ–º data-status –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ç–µ–≥–∞–º
+    $('#cars_select').on('select2:select', function(e) {
+        var status = $(e.params.data.element).data('status');
+        setTimeout(function() {
+            $('.select2-selection__choice').each(function() {
+                var $choice = $(this);
+                var $span = $choice.find('span[data-status]');
+                if ($span.length) {
+                    $choice.attr('data-status', $span.data('status'));
+                }
+            });
+        }, 10);
+    });
+    
+    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
+    setTimeout(function() {
+        $('.select2-selection__choice').each(function() {
+            var $choice = $(this);
+            var $span = $choice.find('span[data-status]');
+            if ($span.length) {
+                $choice.attr('data-status', $span.data('status'));
+            }
+        });
+    }, 100);
+    
+    });
+})(django.jQuery || jQuery || $);
+</script>
+{% endblock %}
diff --git a/templates/admin/core/car/change_list.html b/templates/admin/core/car/change_list.html
index e550269..6eb5175 100644
--- a/templates/admin/core/car/change_list.html
+++ b/templates/admin/core/car/change_list.html
@@ -1,18 +1,18 @@
-{% extends "admin/change_list.html" %}
-{% load i18n admin_urls static admin_list %}
-
-{% block result_list %}
-  {{ block.super }}
-  
-  {% if total_markup_sum is not None %}
-  <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px solid #28a745; border-radius: 8px;">
-    <h3 style="margin: 0; color: #28a745; font-size: 18px;">
-      <strong>–û–±—â–∞—è —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¢–°):</strong>
-      <span style="color: #007bff; font-size: 22px; margin-left: 15px;">{{ total_markup_sum|floatformat:2 }} EUR</span>
-    </h3>
-    <p style="margin: 5px 0 0 0; font-size: 13px; color: #6c757d;">
-      –°—É–º–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –¥–ª—è {{ cl.result_count }} –¢–°, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤.
-    </p>
-  </div>
-  {% endif %}
-{% endblock %}
+{% extends "admin/change_list.html" %}
+{% load i18n admin_urls static admin_list %}
+
+{% block result_list %}
+  {{ block.super }}
+  
+  {% if total_markup_sum is not None %}
+  <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px solid #28a745; border-radius: 8px;">
+    <h3 style="margin: 0; color: #28a745; font-size: 18px;">
+      <strong>–û–±—â–∞—è —Å–∫—Ä—ã—Ç–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¢–°):</strong>
+      <span style="color: #007bff; font-size: 22px; margin-left: 15px;">{{ total_markup_sum|floatformat:2 }} EUR</span>
+    </h3>
+    <p style="margin: 5px 0 0 0; font-size: 13px; color: #6c757d;">
+      –°—É–º–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –¥–ª—è {{ cl.result_count }} –¢–°, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤.
+    </p>
+  </div>
+  {% endif %}
+{% endblock %}
diff --git a/templates/admin/core/container/photos_gallery.html b/templates/admin/core/container/photos_gallery.html
index 9dbc5eb..b6ba3d0 100644
--- a/templates/admin/core/container/photos_gallery.html
+++ b/templates/admin/core/container/photos_gallery.html
@@ -1,455 +1,455 @@
-{% load static %}
-{# –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ —Ç–∏–ø–∞–º –∏ lazy loading #}
-
-<style>
-/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–∞–ª–µ—Ä–µ–∏ */
-#container-photos-gallery {
-    margin: 20px 0;
-    padding: 0;
-    background: #fff;
-    border-radius: 8px;
-    border: 1px solid #ccc;
-    clear: both !important;
-    width: 100% !important;
-    max-width: none !important;
-    box-sizing: border-box;
-}
-
-#container-photos-gallery h2 {
-    margin: 0;
-    padding: 10px 15px;
-    background: linear-gradient(to bottom, #f8f8f8, #eee);
-    border-bottom: 1px solid #ccc;
-    font-size: 13px;
-    font-weight: bold;
-    color: #333;
-    cursor: pointer;
-    user-select: none;
-}
-
-#container-photos-gallery h2:hover {
-    background: linear-gradient(to bottom, #fff, #f5f5f5);
-}
-
-.photos-gallery-content {
-    padding: 15px;
-}
-
-.photos-tabs {
-    display: flex;
-    gap: 10px;
-    margin-bottom: 15px;
-    flex-wrap: wrap;
-}
-
-.photos-tab {
-    padding: 8px 16px;
-    background: #f5f5f5;
-    border: 1px solid #ddd;
-    border-radius: 6px;
-    cursor: pointer;
-    font-size: 13px;
-    font-weight: 500;
-    transition: all 0.2s ease;
-    display: flex;
-    align-items: center;
-    gap: 6px;
-}
-
-.photos-tab:hover {
-    background: #e8f4fc;
-    border-color: #79aec8;
-}
-
-.photos-tab.active {
-    background: #417690;
-    border-color: #417690;
-    color: white;
-}
-
-.photos-tab .count {
-    background: rgba(0,0,0,0.1);
-    padding: 2px 6px;
-    border-radius: 8px;
-    font-size: 11px;
-}
-
-.photos-tab.active .count {
-    background: rgba(255,255,255,0.3);
-}
-
-.photos-section {
-    display: none;
-}
-
-.photos-section.active {
-    display: block;
-}
-
-.photos-grid {
-    display: grid;
-    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
-    gap: 10px;
-}
-
-.photo-item {
-    position: relative;
-    aspect-ratio: 1;
-    border-radius: 6px;
-    overflow: hidden;
-    background: #f0f0f0;
-    cursor: pointer;
-    transition: transform 0.2s ease, box-shadow 0.2s ease;
-    border: 1px solid #ddd;
-}
-
-.photo-item:hover {
-    transform: scale(1.02);
-    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
-    border-color: #79aec8;
-}
-
-.photo-item img {
-    width: 100%;
-    height: 100%;
-    object-fit: cover;
-}
-
-.photo-item img.loading {
-    opacity: 0.5;
-}
-
-/* Lightbox */
-.lightbox {
-    display: none;
-    position: fixed;
-    top: 0;
-    left: 0;
-    width: 100%;
-    height: 100%;
-    background: rgba(0,0,0,0.9);
-    z-index: 10000;
-    justify-content: center;
-    align-items: center;
-}
-
-.lightbox.active {
-    display: flex;
-}
-
-.lightbox img {
-    max-width: 90%;
-    max-height: 90%;
-    object-fit: contain;
-    border-radius: 4px;
-}
-
-.lightbox-close {
-    position: absolute;
-    top: 15px;
-    right: 25px;
-    color: white;
-    font-size: 35px;
-    cursor: pointer;
-    opacity: 0.8;
-    transition: opacity 0.2s;
-}
-
-.lightbox-close:hover {
-    opacity: 1;
-}
-
-.lightbox-nav {
-    position: absolute;
-    top: 50%;
-    transform: translateY(-50%);
-    color: white;
-    font-size: 40px;
-    cursor: pointer;
-    opacity: 0.8;
-    padding: 15px;
-    user-select: none;
-}
-
-.lightbox-nav:hover {
-    opacity: 1;
-}
-
-.lightbox-nav.prev { left: 10px; }
-.lightbox-nav.next { right: 10px; }
-
-.lightbox-counter {
-    position: absolute;
-    bottom: 15px;
-    left: 50%;
-    transform: translateX(-50%);
-    color: white;
-    font-size: 13px;
-    background: rgba(0,0,0,0.5);
-    padding: 5px 12px;
-    border-radius: 12px;
-}
-
-.no-photos {
-    text-align: center;
-    padding: 30px;
-    color: #999;
-    font-size: 13px;
-}
-
-.no-photos-icon {
-    font-size: 40px;
-    margin-bottom: 8px;
-    opacity: 0.5;
-}
-</style>
-
-<fieldset id="container-photos-gallery" class="module aligned collapse">
-    <h2 onclick="togglePhotosGallery()" style="cursor: pointer;">
-        üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 
-        <span id="photos-count-badge" style="background: #417690; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">{{ photos_count|default:0 }}</span>
-        <span id="photos-toggle-icon" style="float: right; margin-right: 10px;">‚ñ∂</span>
-    </h2>
-    
-    <div class="photos-gallery-content" id="photosGalleryContent" style="display: none;">
-        <div id="photosLoading" style="text-align: center; padding: 20px; color: #666;">
-            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...
-        </div>
-        <div class="photos-tabs" id="photosTabs" style="display: none;">
-            <!-- Tabs -->
-        </div>
-        <div id="photosContent">
-            <!-- Photo sections -->
-        </div>
-    </div>
-</fieldset>
-
-<!-- Lightbox -->
-<div class="lightbox" id="lightbox">
-    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
-    <span class="lightbox-nav prev" onclick="navigateLightbox(-1)">&#10094;</span>
-    <img id="lightboxImage" src="" alt="Photo">
-    <span class="lightbox-nav next" onclick="navigateLightbox(1)">&#10095;</span>
-    <div class="lightbox-counter" id="lightboxCounter"></div>
-</div>
-
-<script>
-(function() {
-    // ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–∞
-    const containerId = {{ container_id|default:"null" }};
-    
-    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –ø–æ—Å–ª–µ inlines
-    const gallery = document.getElementById('container-photos-gallery');
-    const lightbox = document.getElementById('lightbox');
-    
-    if (gallery) {
-        const inlineGroups = document.querySelectorAll('.inline-group');
-        const lastInline = inlineGroups[inlineGroups.length - 1];
-        const submitRow = document.querySelector('.submit-row');
-        
-        if (lastInline && lastInline.parentNode) {
-            lastInline.parentNode.insertBefore(gallery, lastInline.nextSibling);
-        } else if (submitRow && submitRow.parentNode) {
-            submitRow.parentNode.insertBefore(gallery, submitRow);
-        }
-        
-        if (lightbox) {
-            document.body.appendChild(lightbox);
-        }
-    }
-    
-    let photosLoaded = false;
-    let photosData = [];
-    let types = null;
-    let observer = null;
-    
-    // Toggle gallery - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
-    window.togglePhotosGallery = function() {
-        const content = document.getElementById('photosGalleryContent');
-        const icon = document.getElementById('photos-toggle-icon');
-        const loading = document.getElementById('photosLoading');
-        
-        if (content.style.display === 'none') {
-            content.style.display = 'block';
-            icon.textContent = '‚ñº';
-            
-            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
-            if (!photosLoaded && containerId) {
-                loading.style.display = 'block';
-                loading.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...';
-                
-                fetch(`/core/container/${containerId}/photos-json/`)
-                    .then(response => response.json())
-                    .then(data => {
-                        loading.style.display = 'none';
-                        if (data.success) {
-                            photosData = data.photos;
-                            renderPhotos();
-                        } else {
-                            document.getElementById('photosContent').innerHTML = `
-                                <div class="no-photos">
-                                    <div class="no-photos-icon">‚ö†Ô∏è</div>
-                                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</p>
-                                </div>
-                            `;
-                        }
-                    })
-                    .catch(error => {
-                        loading.style.display = 'none';
-                        document.getElementById('photosContent').innerHTML = `
-                            <div class="no-photos">
-                                <div class="no-photos-icon">‚ö†Ô∏è</div>
-                                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
-                            </div>
-                        `;
-                    });
-                
-                photosLoaded = true;
-            }
-        } else {
-            content.style.display = 'none';
-            icon.textContent = '‚ñ∂';
-        }
-    };
-    
-    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ AJAX
-    function renderPhotos() {
-        types = {
-            'IN_CONTAINER': { label: '–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ', icon: 'üì¶', photos: [] },
-            'UNLOADING': { label: '–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ', icon: 'üöó', photos: [] },
-            'GENERAL': { label: '–ü—Ä–æ—á–∏–µ', icon: 'üì∑', photos: [] }
-        };
-        
-        // Distribute photos by type
-        photosData.forEach(photo => {
-            const type = types[photo.type] || types['GENERAL'];
-            type.photos.push(photo);
-        });
-        
-        const activeTypes = Object.entries(types).filter(([key, data]) => data.photos.length > 0);
-        
-        const tabsContainer = document.getElementById('photosTabs');
-        const contentContainer = document.getElementById('photosContent');
-        
-        // Clear previous content
-        tabsContainer.innerHTML = '';
-        contentContainer.innerHTML = '';
-        
-        if (activeTypes.length === 0) {
-            contentContainer.innerHTML = `
-                <div class="no-photos">
-                    <div class="no-photos-icon">üì∑</div>
-                    <p>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
-                </div>
-            `;
-            return;
-        }
-        
-        // Show tabs
-        tabsContainer.style.display = 'flex';
-        
-        // Create tabs and photo sections
-        activeTypes.forEach(([typeKey, typeData], index) => {
-            const tab = document.createElement('div');
-            tab.className = 'photos-tab' + (index === 0 ? ' active' : '');
-            tab.dataset.type = typeKey;
-            tab.innerHTML = `${typeData.icon} ${typeData.label} <span class="count">${typeData.photos.length}</span>`;
-            tab.onclick = () => switchTab(typeKey);
-            tabsContainer.appendChild(tab);
-            
-            const section = document.createElement('div');
-            section.className = 'photos-section' + (index === 0 ? ' active' : '');
-            section.id = 'section-' + typeKey;
-            
-            const grid = document.createElement('div');
-            grid.className = 'photos-grid';
-            
-            typeData.photos.forEach((photo, photoIndex) => {
-                const item = document.createElement('div');
-                item.className = 'photo-item';
-                item.onclick = () => openLightbox(typeKey, photoIndex);
-                
-                const img = document.createElement('img');
-                img.className = 'loading';
-                img.alt = 'Photo';
-                img.dataset.src = photo.thumbnail || photo.url;
-                img.dataset.fullSrc = photo.url;
-                // Placeholder
-                img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23e8e8e8" width="100" height="100"/%3E%3C/svg%3E';
-                
-                item.appendChild(img);
-                grid.appendChild(item);
-            });
-            
-            section.appendChild(grid);
-            contentContainer.appendChild(section);
-        });
-        
-        // Lazy loading —Å Intersection Observer
-        observer = new IntersectionObserver((entries) => {
-            entries.forEach(entry => {
-                if (entry.isIntersecting) {
-                    const img = entry.target;
-                    img.src = img.dataset.src;
-                    img.onload = () => img.classList.remove('loading');
-                    observer.unobserve(img);
-                }
-            });
-        }, { rootMargin: '50px' });
-        
-        document.querySelectorAll('.photo-item img').forEach(img => observer.observe(img));
-    }
-    
-    // Tab switching
-    window.switchTab = function(typeKey) {
-        document.querySelectorAll('.photos-tab').forEach(t => t.classList.remove('active'));
-        document.querySelectorAll('.photos-section').forEach(s => s.classList.remove('active'));
-        document.querySelector(`.photos-tab[data-type="${typeKey}"]`).classList.add('active');
-        document.getElementById('section-' + typeKey).classList.add('active');
-    };
-    
-    // Lightbox
-    let currentType = null;
-    let currentIndex = 0;
-    
-    window.openLightbox = function(typeKey, index) {
-        currentType = typeKey;
-        currentIndex = index;
-        updateLightbox();
-        document.getElementById('lightbox').classList.add('active');
-        document.body.style.overflow = 'hidden';
-    };
-    
-    window.closeLightbox = function() {
-        document.getElementById('lightbox').classList.remove('active');
-        document.body.style.overflow = '';
-    };
-    
-    window.navigateLightbox = function(direction) {
-        if (!types || !types[currentType]) return;
-        const photos = types[currentType].photos;
-        currentIndex = (currentIndex + direction + photos.length) % photos.length;
-        updateLightbox();
-    };
-    
-    function updateLightbox() {
-        if (!types || !types[currentType]) return;
-        const photos = types[currentType].photos;
-        const photo = photos[currentIndex];
-        document.getElementById('lightboxImage').src = photo.url;
-        document.getElementById('lightboxCounter').textContent = `${currentIndex + 1} / ${photos.length}`;
-    }
-    
-    // Keyboard navigation
-    document.addEventListener('keydown', (e) => {
-        if (!document.getElementById('lightbox').classList.contains('active')) return;
-        if (e.key === 'Escape') closeLightbox();
-        if (e.key === 'ArrowLeft') navigateLightbox(-1);
-        if (e.key === 'ArrowRight') navigateLightbox(1);
-    });
-    
-    document.getElementById('lightbox').addEventListener('click', (e) => {
-        if (e.target.id === 'lightbox') closeLightbox();
-    });
-})();
-</script>
+{% load static %}
+{# –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ —Ç–∏–ø–∞–º –∏ lazy loading #}
+
+<style>
+/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–∞–ª–µ—Ä–µ–∏ */
+#container-photos-gallery {
+    margin: 20px 0;
+    padding: 0;
+    background: #fff;
+    border-radius: 8px;
+    border: 1px solid #ccc;
+    clear: both !important;
+    width: 100% !important;
+    max-width: none !important;
+    box-sizing: border-box;
+}
+
+#container-photos-gallery h2 {
+    margin: 0;
+    padding: 10px 15px;
+    background: linear-gradient(to bottom, #f8f8f8, #eee);
+    border-bottom: 1px solid #ccc;
+    font-size: 13px;
+    font-weight: bold;
+    color: #333;
+    cursor: pointer;
+    user-select: none;
+}
+
+#container-photos-gallery h2:hover {
+    background: linear-gradient(to bottom, #fff, #f5f5f5);
+}
+
+.photos-gallery-content {
+    padding: 15px;
+}
+
+.photos-tabs {
+    display: flex;
+    gap: 10px;
+    margin-bottom: 15px;
+    flex-wrap: wrap;
+}
+
+.photos-tab {
+    padding: 8px 16px;
+    background: #f5f5f5;
+    border: 1px solid #ddd;
+    border-radius: 6px;
+    cursor: pointer;
+    font-size: 13px;
+    font-weight: 500;
+    transition: all 0.2s ease;
+    display: flex;
+    align-items: center;
+    gap: 6px;
+}
+
+.photos-tab:hover {
+    background: #e8f4fc;
+    border-color: #79aec8;
+}
+
+.photos-tab.active {
+    background: #417690;
+    border-color: #417690;
+    color: white;
+}
+
+.photos-tab .count {
+    background: rgba(0,0,0,0.1);
+    padding: 2px 6px;
+    border-radius: 8px;
+    font-size: 11px;
+}
+
+.photos-tab.active .count {
+    background: rgba(255,255,255,0.3);
+}
+
+.photos-section {
+    display: none;
+}
+
+.photos-section.active {
+    display: block;
+}
+
+.photos-grid {
+    display: grid;
+    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
+    gap: 10px;
+}
+
+.photo-item {
+    position: relative;
+    aspect-ratio: 1;
+    border-radius: 6px;
+    overflow: hidden;
+    background: #f0f0f0;
+    cursor: pointer;
+    transition: transform 0.2s ease, box-shadow 0.2s ease;
+    border: 1px solid #ddd;
+}
+
+.photo-item:hover {
+    transform: scale(1.02);
+    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
+    border-color: #79aec8;
+}
+
+.photo-item img {
+    width: 100%;
+    height: 100%;
+    object-fit: cover;
+}
+
+.photo-item img.loading {
+    opacity: 0.5;
+}
+
+/* Lightbox */
+.lightbox {
+    display: none;
+    position: fixed;
+    top: 0;
+    left: 0;
+    width: 100%;
+    height: 100%;
+    background: rgba(0,0,0,0.9);
+    z-index: 10000;
+    justify-content: center;
+    align-items: center;
+}
+
+.lightbox.active {
+    display: flex;
+}
+
+.lightbox img {
+    max-width: 90%;
+    max-height: 90%;
+    object-fit: contain;
+    border-radius: 4px;
+}
+
+.lightbox-close {
+    position: absolute;
+    top: 15px;
+    right: 25px;
+    color: white;
+    font-size: 35px;
+    cursor: pointer;
+    opacity: 0.8;
+    transition: opacity 0.2s;
+}
+
+.lightbox-close:hover {
+    opacity: 1;
+}
+
+.lightbox-nav {
+    position: absolute;
+    top: 50%;
+    transform: translateY(-50%);
+    color: white;
+    font-size: 40px;
+    cursor: pointer;
+    opacity: 0.8;
+    padding: 15px;
+    user-select: none;
+}
+
+.lightbox-nav:hover {
+    opacity: 1;
+}
+
+.lightbox-nav.prev { left: 10px; }
+.lightbox-nav.next { right: 10px; }
+
+.lightbox-counter {
+    position: absolute;
+    bottom: 15px;
+    left: 50%;
+    transform: translateX(-50%);
+    color: white;
+    font-size: 13px;
+    background: rgba(0,0,0,0.5);
+    padding: 5px 12px;
+    border-radius: 12px;
+}
+
+.no-photos {
+    text-align: center;
+    padding: 30px;
+    color: #999;
+    font-size: 13px;
+}
+
+.no-photos-icon {
+    font-size: 40px;
+    margin-bottom: 8px;
+    opacity: 0.5;
+}
+</style>
+
+<fieldset id="container-photos-gallery" class="module aligned collapse">
+    <h2 onclick="togglePhotosGallery()" style="cursor: pointer;">
+        üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 
+        <span id="photos-count-badge" style="background: #417690; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">{{ photos_count|default:0 }}</span>
+        <span id="photos-toggle-icon" style="float: right; margin-right: 10px;">‚ñ∂</span>
+    </h2>
+    
+    <div class="photos-gallery-content" id="photosGalleryContent" style="display: none;">
+        <div id="photosLoading" style="text-align: center; padding: 20px; color: #666;">
+            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...
+        </div>
+        <div class="photos-tabs" id="photosTabs" style="display: none;">
+            <!-- Tabs -->
+        </div>
+        <div id="photosContent">
+            <!-- Photo sections -->
+        </div>
+    </div>
+</fieldset>
+
+<!-- Lightbox -->
+<div class="lightbox" id="lightbox">
+    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
+    <span class="lightbox-nav prev" onclick="navigateLightbox(-1)">&#10094;</span>
+    <img id="lightboxImage" src="" alt="Photo">
+    <span class="lightbox-nav next" onclick="navigateLightbox(1)">&#10095;</span>
+    <div class="lightbox-counter" id="lightboxCounter"></div>
+</div>
+
+<script>
+(function() {
+    // ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–∞
+    const containerId = {{ container_id|default:"null" }};
+    
+    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –ø–æ—Å–ª–µ inlines
+    const gallery = document.getElementById('container-photos-gallery');
+    const lightbox = document.getElementById('lightbox');
+    
+    if (gallery) {
+        const inlineGroups = document.querySelectorAll('.inline-group');
+        const lastInline = inlineGroups[inlineGroups.length - 1];
+        const submitRow = document.querySelector('.submit-row');
+        
+        if (lastInline && lastInline.parentNode) {
+            lastInline.parentNode.insertBefore(gallery, lastInline.nextSibling);
+        } else if (submitRow && submitRow.parentNode) {
+            submitRow.parentNode.insertBefore(gallery, submitRow);
+        }
+        
+        if (lightbox) {
+            document.body.appendChild(lightbox);
+        }
+    }
+    
+    let photosLoaded = false;
+    let photosData = [];
+    let types = null;
+    let observer = null;
+    
+    // Toggle gallery - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
+    window.togglePhotosGallery = function() {
+        const content = document.getElementById('photosGalleryContent');
+        const icon = document.getElementById('photos-toggle-icon');
+        const loading = document.getElementById('photosLoading');
+        
+        if (content.style.display === 'none') {
+            content.style.display = 'block';
+            icon.textContent = '‚ñº';
+            
+            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ AJAX —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
+            if (!photosLoaded && containerId) {
+                loading.style.display = 'block';
+                loading.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...';
+                
+                fetch(`/core/container/${containerId}/photos-json/`)
+                    .then(response => response.json())
+                    .then(data => {
+                        loading.style.display = 'none';
+                        if (data.success) {
+                            photosData = data.photos;
+                            renderPhotos();
+                        } else {
+                            document.getElementById('photosContent').innerHTML = `
+                                <div class="no-photos">
+                                    <div class="no-photos-icon">‚ö†Ô∏è</div>
+                                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</p>
+                                </div>
+                            `;
+                        }
+                    })
+                    .catch(error => {
+                        loading.style.display = 'none';
+                        document.getElementById('photosContent').innerHTML = `
+                            <div class="no-photos">
+                                <div class="no-photos-icon">‚ö†Ô∏è</div>
+                                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
+                            </div>
+                        `;
+                    });
+                
+                photosLoaded = true;
+            }
+        } else {
+            content.style.display = 'none';
+            icon.textContent = '‚ñ∂';
+        }
+    };
+    
+    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ AJAX
+    function renderPhotos() {
+        types = {
+            'IN_CONTAINER': { label: '–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ', icon: 'üì¶', photos: [] },
+            'UNLOADING': { label: '–í—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ', icon: 'üöó', photos: [] },
+            'GENERAL': { label: '–ü—Ä–æ—á–∏–µ', icon: 'üì∑', photos: [] }
+        };
+        
+        // Distribute photos by type
+        photosData.forEach(photo => {
+            const type = types[photo.type] || types['GENERAL'];
+            type.photos.push(photo);
+        });
+        
+        const activeTypes = Object.entries(types).filter(([key, data]) => data.photos.length > 0);
+        
+        const tabsContainer = document.getElementById('photosTabs');
+        const contentContainer = document.getElementById('photosContent');
+        
+        // Clear previous content
+        tabsContainer.innerHTML = '';
+        contentContainer.innerHTML = '';
+        
+        if (activeTypes.length === 0) {
+            contentContainer.innerHTML = `
+                <div class="no-photos">
+                    <div class="no-photos-icon">üì∑</div>
+                    <p>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
+                </div>
+            `;
+            return;
+        }
+        
+        // Show tabs
+        tabsContainer.style.display = 'flex';
+        
+        // Create tabs and photo sections
+        activeTypes.forEach(([typeKey, typeData], index) => {
+            const tab = document.createElement('div');
+            tab.className = 'photos-tab' + (index === 0 ? ' active' : '');
+            tab.dataset.type = typeKey;
+            tab.innerHTML = `${typeData.icon} ${typeData.label} <span class="count">${typeData.photos.length}</span>`;
+            tab.onclick = () => switchTab(typeKey);
+            tabsContainer.appendChild(tab);
+            
+            const section = document.createElement('div');
+            section.className = 'photos-section' + (index === 0 ? ' active' : '');
+            section.id = 'section-' + typeKey;
+            
+            const grid = document.createElement('div');
+            grid.className = 'photos-grid';
+            
+            typeData.photos.forEach((photo, photoIndex) => {
+                const item = document.createElement('div');
+                item.className = 'photo-item';
+                item.onclick = () => openLightbox(typeKey, photoIndex);
+                
+                const img = document.createElement('img');
+                img.className = 'loading';
+                img.alt = 'Photo';
+                img.dataset.src = photo.thumbnail || photo.url;
+                img.dataset.fullSrc = photo.url;
+                // Placeholder
+                img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23e8e8e8" width="100" height="100"/%3E%3C/svg%3E';
+                
+                item.appendChild(img);
+                grid.appendChild(item);
+            });
+            
+            section.appendChild(grid);
+            contentContainer.appendChild(section);
+        });
+        
+        // Lazy loading —Å Intersection Observer
+        observer = new IntersectionObserver((entries) => {
+            entries.forEach(entry => {
+                if (entry.isIntersecting) {
+                    const img = entry.target;
+                    img.src = img.dataset.src;
+                    img.onload = () => img.classList.remove('loading');
+                    observer.unobserve(img);
+                }
+            });
+        }, { rootMargin: '50px' });
+        
+        document.querySelectorAll('.photo-item img').forEach(img => observer.observe(img));
+    }
+    
+    // Tab switching
+    window.switchTab = function(typeKey) {
+        document.querySelectorAll('.photos-tab').forEach(t => t.classList.remove('active'));
+        document.querySelectorAll('.photos-section').forEach(s => s.classList.remove('active'));
+        document.querySelector(`.photos-tab[data-type="${typeKey}"]`).classList.add('active');
+        document.getElementById('section-' + typeKey).classList.add('active');
+    };
+    
+    // Lightbox
+    let currentType = null;
+    let currentIndex = 0;
+    
+    window.openLightbox = function(typeKey, index) {
+        currentType = typeKey;
+        currentIndex = index;
+        updateLightbox();
+        document.getElementById('lightbox').classList.add('active');
+        document.body.style.overflow = 'hidden';
+    };
+    
+    window.closeLightbox = function() {
+        document.getElementById('lightbox').classList.remove('active');
+        document.body.style.overflow = '';
+    };
+    
+    window.navigateLightbox = function(direction) {
+        if (!types || !types[currentType]) return;
+        const photos = types[currentType].photos;
+        currentIndex = (currentIndex + direction + photos.length) % photos.length;
+        updateLightbox();
+    };
+    
+    function updateLightbox() {
+        if (!types || !types[currentType]) return;
+        const photos = types[currentType].photos;
+        const photo = photos[currentIndex];
+        document.getElementById('lightboxImage').src = photo.url;
+        document.getElementById('lightboxCounter').textContent = `${currentIndex + 1} / ${photos.length}`;
+    }
+    
+    // Keyboard navigation
+    document.addEventListener('keydown', (e) => {
+        if (!document.getElementById('lightbox').classList.contains('active')) return;
+        if (e.key === 'Escape') closeLightbox();
+        if (e.key === 'ArrowLeft') navigateLightbox(-1);
+        if (e.key === 'ArrowRight') navigateLightbox(1);
+    });
+    
+    document.getElementById('lightbox').addEventListener('click', (e) => {
+        if (e.target.id === 'lightbox') closeLightbox();
+    });
+})();
+</script>
diff --git a/templates/admin/multi_status_filter.html b/templates/admin/multi_status_filter.html
index 6ccca67..b23baa7 100644
--- a/templates/admin/multi_status_filter.html
+++ b/templates/admin/multi_status_filter.html
@@ -1,52 +1,52 @@
-{% load i18n %}
-<h3>{% blocktrans with filter_title=title %} By {{ filter_title }} {% endblocktrans %}</h3>
-<ul>
-    {% for choice in choices %}
-        <li>
-            <label>
-                <input type="checkbox" 
-                       name="{{ spec.parameter_name }}" 
-                       value="{{ choice.value }}"
-                       {% if choice.selected %}checked{% endif %}
-                       id="status_{{ choice.value }}">
-                {{ choice.display }}
-            </label>
-        </li>
-    {% endfor %}
-</ul>
-<div style="margin-top: 10px; padding-left: 15px;">
-    <button type="button" onclick="applyFilter()" style="background: #417690; color: white; border: none; padding: 8px 17px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
-        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
-    </button>
-    <button type="button" onclick="clearFilter()" style="background: #ba2121; color: white; border: none; padding: 8px 17px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 14px; font-weight: 500;">
-        –°–±—Ä–æ—Å–∏—Ç—å
-    </button>
-</div>
-
-<script>
-function applyFilter() {
-    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã
-    const checkboxes = document.querySelectorAll('input[name="{{ spec.parameter_name }}"]:checked');
-    const values = Array.from(checkboxes).map(cb => cb.value);
-    
-    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π URL —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
-    const url = new URL(window.location);
-    url.searchParams.delete('{{ spec.parameter_name }}');
-    
-    values.forEach(value => {
-        url.searchParams.append('{{ spec.parameter_name }}', value);
-    });
-    
-    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—ã–π URL
-    window.location.href = url.toString();
-}
-
-function clearFilter() {
-    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π URL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞
-    const url = new URL(window.location);
-    url.searchParams.delete('{{ spec.parameter_name }}');
-    
-    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—ã–π URL
-    window.location.href = url.toString();
-}
-</script>
+{% load i18n %}
+<h3>{% blocktrans with filter_title=title %} By {{ filter_title }} {% endblocktrans %}</h3>
+<ul>
+    {% for choice in choices %}
+        <li>
+            <label>
+                <input type="checkbox" 
+                       name="{{ spec.parameter_name }}" 
+                       value="{{ choice.value }}"
+                       {% if choice.selected %}checked{% endif %}
+                       id="status_{{ choice.value }}">
+                {{ choice.display }}
+            </label>
+        </li>
+    {% endfor %}
+</ul>
+<div style="margin-top: 10px; padding-left: 15px;">
+    <button type="button" onclick="applyFilter()" style="background: #417690; color: white; border: none; padding: 8px 17px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
+        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
+    </button>
+    <button type="button" onclick="clearFilter()" style="background: #ba2121; color: white; border: none; padding: 8px 17px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 14px; font-weight: 500;">
+        –°–±—Ä–æ—Å–∏—Ç—å
+    </button>
+</div>
+
+<script>
+function applyFilter() {
+    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã
+    const checkboxes = document.querySelectorAll('input[name="{{ spec.parameter_name }}"]:checked');
+    const values = Array.from(checkboxes).map(cb => cb.value);
+    
+    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π URL —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
+    const url = new URL(window.location);
+    url.searchParams.delete('{{ spec.parameter_name }}');
+    
+    values.forEach(value => {
+        url.searchParams.append('{{ spec.parameter_name }}', value);
+    });
+    
+    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—ã–π URL
+    window.location.href = url.toString();
+}
+
+function clearFilter() {
+    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π URL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞
+    const url = new URL(window.location);
+    url.searchParams.delete('{{ spec.parameter_name }}');
+    
+    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—ã–π URL
+    window.location.href = url.toString();
+}
+</script>
